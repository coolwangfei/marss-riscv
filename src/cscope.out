cscope 15 $HOME/github/marss-riscv/src -q 0000005666 0001000107
	@aes.c

30 
	~<°rög.h
>

31 
	~<öây≥s.h
>

32 
	~"´s.h
"

34 #i‚de‡
NDEBUG


35 
	#NDEBUG


	)

38 
	~<as£π.h
>

40 
uöt32_t
 
	tu32
;

41 
uöt16_t
 
	tu16
;

42 
uöt8_t
 
	tu8
;

44 
	#MAXKC
 (256/32)

	)

45 
	#MAXKB
 (256/8)

	)

46 
	#MAXNR
 14

	)

49 #unde‡
FULL_UNROLL


50 
	#GETU32
(
±
Ë(((
u32
)’t)[0] << 24Ë^ ((u32)’t)[1] << 16Ë^ ((u32)’t)[2] << 8Ë^ ((u32)’t)[3]))

	)

51 
	#PUTU32
(
˘
, 
°
Ë{ (˘)[0] = (
u8
)((°Ë>> 24); (˘)[1] = (u8)((°Ë>> 16); (˘)[2] = (u8)((°Ë>> 8); (˘)[3] = (u8)(°); }

	)

67 c⁄° 
u32
 
	gTe0
[256] = {

133 c⁄° 
u32
 
	gTe1
[256] = {

199 c⁄° 
u32
 
	gTe2
[256] = {

265 c⁄° 
u32
 
	gTe3
[256] = {

332 c⁄° 
u32
 
	gTe4
[256] = {

398 c⁄° 
u32
 
	gTd0
[256] = {

464 c⁄° 
u32
 
	gTd1
[256] = {

530 c⁄° 
u32
 
	gTd2
[256] = {

597 c⁄° 
u32
 
	gTd3
[256] = {

663 c⁄° 
u32
 
	gTd4
[256] = {

729 c⁄° 
u32
 
	grc⁄
[] = {

738 
	$AES_£t_í¸y±_key
(c⁄° *
u£rKey
, c⁄° 
bôs
,

739 
AES_KEY
 *
key
) {

741 
u32
 *
rk
;

742 
i
 = 0;

743 
u32
 
ãmp
;

745 i‡(!
u£rKey
 || !
key
)

747 i‡(
bôs
 != 128 && bits != 192 && bits != 256)

750 
rk
 = 
key
->
rd_key
;

752 i‡(
bôs
==128)

753 
key
->
rounds
 = 10;

754 i‡(
bôs
==192)

755 
key
->
rounds
 = 12;

757 
key
->
rounds
 = 14;

759 
rk
[0] = 
	`GETU32
(
u£rKey
 );

760 
rk
[1] = 
	`GETU32
(
u£rKey
 + 4);

761 
rk
[2] = 
	`GETU32
(
u£rKey
 + 8);

762 
rk
[3] = 
	`GETU32
(
u£rKey
 + 12);

763 i‡(
bôs
 == 128) {

765 
ãmp
 = 
rk
[3];

766 
rk
[4] =Ñk[0] ^

767 (
Te4
[(
ãmp
 >> 16) & 0xff] & 0xff000000) ^

768 (
Te4
[(
ãmp
 >> 8) & 0xff] & 0x00ff0000) ^

769 (
Te4
[(
ãmp
 ) & 0xff] & 0x0000ff00) ^

770 (
Te4
[(
ãmp
 >> 24) ] & 0x000000ff) ^

771 
rc⁄
[
i
];

772 
rk
[5] =Ñk[1] ^Ñk[4];

773 
rk
[6] =Ñk[2] ^Ñk[5];

774 
rk
[7] =Ñk[3] ^Ñk[6];

775 i‡(++
i
 == 10) {

778 
rk
 += 4;

781 
rk
[4] = 
	`GETU32
(
u£rKey
 + 16);

782 
rk
[5] = 
	`GETU32
(
u£rKey
 + 20);

783 i‡(
bôs
 == 192) {

785 
ãmp
 = 
rk
[ 5];

786 
rk
[ 6] =Ñk[ 0] ^

787 (
Te4
[(
ãmp
 >> 16) & 0xff] & 0xff000000) ^

788 (
Te4
[(
ãmp
 >> 8) & 0xff] & 0x00ff0000) ^

789 (
Te4
[(
ãmp
 ) & 0xff] & 0x0000ff00) ^

790 (
Te4
[(
ãmp
 >> 24) ] & 0x000000ff) ^

791 
rc⁄
[
i
];

792 
rk
[ 7] =Ñk[ 1] ^Ñk[ 6];

793 
rk
[ 8] =Ñk[ 2] ^Ñk[ 7];

794 
rk
[ 9] =Ñk[ 3] ^Ñk[ 8];

795 i‡(++
i
 == 8) {

798 
rk
[10] =Ñk[ 4] ^Ñk[ 9];

799 
rk
[11] =Ñk[ 5] ^Ñk[10];

800 
rk
 += 6;

803 
rk
[6] = 
	`GETU32
(
u£rKey
 + 24);

804 
rk
[7] = 
	`GETU32
(
u£rKey
 + 28);

805 i‡(
bôs
 == 256) {

807 
ãmp
 = 
rk
[ 7];

808 
rk
[ 8] =Ñk[ 0] ^

809 (
Te4
[(
ãmp
 >> 16) & 0xff] & 0xff000000) ^

810 (
Te4
[(
ãmp
 >> 8) & 0xff] & 0x00ff0000) ^

811 (
Te4
[(
ãmp
 ) & 0xff] & 0x0000ff00) ^

812 (
Te4
[(
ãmp
 >> 24) ] & 0x000000ff) ^

813 
rc⁄
[
i
];

814 
rk
[ 9] =Ñk[ 1] ^Ñk[ 8];

815 
rk
[10] =Ñk[ 2] ^Ñk[ 9];

816 
rk
[11] =Ñk[ 3] ^Ñk[10];

817 i‡(++
i
 == 7) {

820 
ãmp
 = 
rk
[11];

821 
rk
[12] =Ñk[ 4] ^

822 (
Te4
[(
ãmp
 >> 24) ] & 0xff000000) ^

823 (
Te4
[(
ãmp
 >> 16) & 0xff] & 0x00ff0000) ^

824 (
Te4
[(
ãmp
 >> 8) & 0xff] & 0x0000ff00) ^

825 (
Te4
[(
ãmp
 ) & 0xff] & 0x000000ff);

826 
rk
[13] =Ñk[ 5] ^Ñk[12];

827 
rk
[14] =Ñk[ 6] ^Ñk[13];

828 
rk
[15] =Ñk[ 7] ^Ñk[14];

830 
rk
 += 8;

834 
	}
}

839 
	$AES_£t_de¸y±_key
(c⁄° *
u£rKey
, c⁄° 
bôs
,

840 
AES_KEY
 *
key
) {

842 
u32
 *
rk
;

843 
i
, 
j
, 
°©us
;

844 
u32
 
ãmp
;

847 
°©us
 = 
	`AES_£t_í¸y±_key
(
u£rKey
, 
bôs
, 
key
);

848 i‡(
°©us
 < 0)

849  
°©us
;

851 
rk
 = 
key
->
rd_key
;

854 
i
 = 0, 
j
 = 4*(
key
->
rounds
); i < j; i += 4, j -= 4) {

855 
ãmp
 = 
rk
[
i
 ];Ñk[ò] =Ñk[
j
 ];Ñk[j ] =Åemp;

856 
ãmp
 = 
rk
[
i
 + 1];Ñk[ò+ 1] =Ñk[
j
 + 1];Ñk[j + 1] =Åemp;

857 
ãmp
 = 
rk
[
i
 + 2];Ñk[ò+ 2] =Ñk[
j
 + 2];Ñk[j + 2] =Åemp;

858 
ãmp
 = 
rk
[
i
 + 3];Ñk[ò+ 3] =Ñk[
j
 + 3];Ñk[j + 3] =Åemp;

861 
i
 = 1; i < (
key
->
rounds
); i++) {

862 
rk
 += 4;

863 
rk
[0] =

864 
Td0
[
Te4
[(
rk
[0] >> 24) ] & 0xff] ^

865 
Td1
[
Te4
[(
rk
[0] >> 16) & 0xff] & 0xff] ^

866 
Td2
[
Te4
[(
rk
[0] >> 8) & 0xff] & 0xff] ^

867 
Td3
[
Te4
[(
rk
[0] ) & 0xff] & 0xff];

868 
rk
[1] =

869 
Td0
[
Te4
[(
rk
[1] >> 24) ] & 0xff] ^

870 
Td1
[
Te4
[(
rk
[1] >> 16) & 0xff] & 0xff] ^

871 
Td2
[
Te4
[(
rk
[1] >> 8) & 0xff] & 0xff] ^

872 
Td3
[
Te4
[(
rk
[1] ) & 0xff] & 0xff];

873 
rk
[2] =

874 
Td0
[
Te4
[(
rk
[2] >> 24) ] & 0xff] ^

875 
Td1
[
Te4
[(
rk
[2] >> 16) & 0xff] & 0xff] ^

876 
Td2
[
Te4
[(
rk
[2] >> 8) & 0xff] & 0xff] ^

877 
Td3
[
Te4
[(
rk
[2] ) & 0xff] & 0xff];

878 
rk
[3] =

879 
Td0
[
Te4
[(
rk
[3] >> 24) ] & 0xff] ^

880 
Td1
[
Te4
[(
rk
[3] >> 16) & 0xff] & 0xff] ^

881 
Td2
[
Te4
[(
rk
[3] >> 8) & 0xff] & 0xff] ^

882 
Td3
[
Te4
[(
rk
[3] ) & 0xff] & 0xff];

885 
	}
}

887 #i‚de‡
AES_ASM


892 
	$AES_í¸y±
(c⁄° *
ö
, *
out
,

893 c⁄° 
AES_KEY
 *
key
) {

895 c⁄° 
u32
 *
rk
;

896 
u32
 
s0
, 
s1
, 
s2
, 
s3
, 
t0
, 
t1
, 
t2
, 
t3
;

897 #i‚de‡
FULL_UNROLL


898 
r
;

901 
	`as£π
(
ö
 && 
out
 && 
key
);

902 
rk
 = 
key
->
rd_key
;

908 
s0
 = 
	`GETU32
(
ö
 ) ^ 
rk
[0];

909 
s1
 = 
	`GETU32
(
ö
 + 4Ë^ 
rk
[1];

910 
s2
 = 
	`GETU32
(
ö
 + 8Ë^ 
rk
[2];

911 
s3
 = 
	`GETU32
(
ö
 + 12Ë^ 
rk
[3];

912 #ifde‡
FULL_UNROLL


914 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[ 4];

915 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[ 5];

916 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[ 6];

917 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[ 7];

919 
s0
 = 
Te0
[
t0
 >> 24] ^ 
Te1
[(
t1
 >> 16Ë& 0xff] ^ 
Te2
[(
t2
 >> 8Ë& 0xff] ^ 
Te3
[
t3
 & 0xff] ^ 
rk
[ 8];

920 
s1
 = 
Te0
[
t1
 >> 24] ^ 
Te1
[(
t2
 >> 16Ë& 0xff] ^ 
Te2
[(
t3
 >> 8Ë& 0xff] ^ 
Te3
[
t0
 & 0xff] ^ 
rk
[ 9];

921 
s2
 = 
Te0
[
t2
 >> 24] ^ 
Te1
[(
t3
 >> 16Ë& 0xff] ^ 
Te2
[(
t0
 >> 8Ë& 0xff] ^ 
Te3
[
t1
 & 0xff] ^ 
rk
[10];

922 
s3
 = 
Te0
[
t3
 >> 24] ^ 
Te1
[(
t0
 >> 16Ë& 0xff] ^ 
Te2
[(
t1
 >> 8Ë& 0xff] ^ 
Te3
[
t2
 & 0xff] ^ 
rk
[11];

924 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[12];

925 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[13];

926 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[14];

927 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[15];

929 
s0
 = 
Te0
[
t0
 >> 24] ^ 
Te1
[(
t1
 >> 16Ë& 0xff] ^ 
Te2
[(
t2
 >> 8Ë& 0xff] ^ 
Te3
[
t3
 & 0xff] ^ 
rk
[16];

930 
s1
 = 
Te0
[
t1
 >> 24] ^ 
Te1
[(
t2
 >> 16Ë& 0xff] ^ 
Te2
[(
t3
 >> 8Ë& 0xff] ^ 
Te3
[
t0
 & 0xff] ^ 
rk
[17];

931 
s2
 = 
Te0
[
t2
 >> 24] ^ 
Te1
[(
t3
 >> 16Ë& 0xff] ^ 
Te2
[(
t0
 >> 8Ë& 0xff] ^ 
Te3
[
t1
 & 0xff] ^ 
rk
[18];

932 
s3
 = 
Te0
[
t3
 >> 24] ^ 
Te1
[(
t0
 >> 16Ë& 0xff] ^ 
Te2
[(
t1
 >> 8Ë& 0xff] ^ 
Te3
[
t2
 & 0xff] ^ 
rk
[19];

934 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[20];

935 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[21];

936 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[22];

937 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[23];

939 
s0
 = 
Te0
[
t0
 >> 24] ^ 
Te1
[(
t1
 >> 16Ë& 0xff] ^ 
Te2
[(
t2
 >> 8Ë& 0xff] ^ 
Te3
[
t3
 & 0xff] ^ 
rk
[24];

940 
s1
 = 
Te0
[
t1
 >> 24] ^ 
Te1
[(
t2
 >> 16Ë& 0xff] ^ 
Te2
[(
t3
 >> 8Ë& 0xff] ^ 
Te3
[
t0
 & 0xff] ^ 
rk
[25];

941 
s2
 = 
Te0
[
t2
 >> 24] ^ 
Te1
[(
t3
 >> 16Ë& 0xff] ^ 
Te2
[(
t0
 >> 8Ë& 0xff] ^ 
Te3
[
t1
 & 0xff] ^ 
rk
[26];

942 
s3
 = 
Te0
[
t3
 >> 24] ^ 
Te1
[(
t0
 >> 16Ë& 0xff] ^ 
Te2
[(
t1
 >> 8Ë& 0xff] ^ 
Te3
[
t2
 & 0xff] ^ 
rk
[27];

944 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[28];

945 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[29];

946 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[30];

947 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[31];

949 
s0
 = 
Te0
[
t0
 >> 24] ^ 
Te1
[(
t1
 >> 16Ë& 0xff] ^ 
Te2
[(
t2
 >> 8Ë& 0xff] ^ 
Te3
[
t3
 & 0xff] ^ 
rk
[32];

950 
s1
 = 
Te0
[
t1
 >> 24] ^ 
Te1
[(
t2
 >> 16Ë& 0xff] ^ 
Te2
[(
t3
 >> 8Ë& 0xff] ^ 
Te3
[
t0
 & 0xff] ^ 
rk
[33];

951 
s2
 = 
Te0
[
t2
 >> 24] ^ 
Te1
[(
t3
 >> 16Ë& 0xff] ^ 
Te2
[(
t0
 >> 8Ë& 0xff] ^ 
Te3
[
t1
 & 0xff] ^ 
rk
[34];

952 
s3
 = 
Te0
[
t3
 >> 24] ^ 
Te1
[(
t0
 >> 16Ë& 0xff] ^ 
Te2
[(
t1
 >> 8Ë& 0xff] ^ 
Te3
[
t2
 & 0xff] ^ 
rk
[35];

954 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[36];

955 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[37];

956 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[38];

957 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[39];

958 i‡(
key
->
rounds
 > 10) {

960 
s0
 = 
Te0
[
t0
 >> 24] ^ 
Te1
[(
t1
 >> 16Ë& 0xff] ^ 
Te2
[(
t2
 >> 8Ë& 0xff] ^ 
Te3
[
t3
 & 0xff] ^ 
rk
[40];

961 
s1
 = 
Te0
[
t1
 >> 24] ^ 
Te1
[(
t2
 >> 16Ë& 0xff] ^ 
Te2
[(
t3
 >> 8Ë& 0xff] ^ 
Te3
[
t0
 & 0xff] ^ 
rk
[41];

962 
s2
 = 
Te0
[
t2
 >> 24] ^ 
Te1
[(
t3
 >> 16Ë& 0xff] ^ 
Te2
[(
t0
 >> 8Ë& 0xff] ^ 
Te3
[
t1
 & 0xff] ^ 
rk
[42];

963 
s3
 = 
Te0
[
t3
 >> 24] ^ 
Te1
[(
t0
 >> 16Ë& 0xff] ^ 
Te2
[(
t1
 >> 8Ë& 0xff] ^ 
Te3
[
t2
 & 0xff] ^ 
rk
[43];

965 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[44];

966 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[45];

967 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[46];

968 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[47];

969 i‡(
key
->
rounds
 > 12) {

971 
s0
 = 
Te0
[
t0
 >> 24] ^ 
Te1
[(
t1
 >> 16Ë& 0xff] ^ 
Te2
[(
t2
 >> 8Ë& 0xff] ^ 
Te3
[
t3
 & 0xff] ^ 
rk
[48];

972 
s1
 = 
Te0
[
t1
 >> 24] ^ 
Te1
[(
t2
 >> 16Ë& 0xff] ^ 
Te2
[(
t3
 >> 8Ë& 0xff] ^ 
Te3
[
t0
 & 0xff] ^ 
rk
[49];

973 
s2
 = 
Te0
[
t2
 >> 24] ^ 
Te1
[(
t3
 >> 16Ë& 0xff] ^ 
Te2
[(
t0
 >> 8Ë& 0xff] ^ 
Te3
[
t1
 & 0xff] ^ 
rk
[50];

974 
s3
 = 
Te0
[
t3
 >> 24] ^ 
Te1
[(
t0
 >> 16Ë& 0xff] ^ 
Te2
[(
t1
 >> 8Ë& 0xff] ^ 
Te3
[
t2
 & 0xff] ^ 
rk
[51];

976 
t0
 = 
Te0
[
s0
 >> 24] ^ 
Te1
[(
s1
 >> 16Ë& 0xff] ^ 
Te2
[(
s2
 >> 8Ë& 0xff] ^ 
Te3
[
s3
 & 0xff] ^ 
rk
[52];

977 
t1
 = 
Te0
[
s1
 >> 24] ^ 
Te1
[(
s2
 >> 16Ë& 0xff] ^ 
Te2
[(
s3
 >> 8Ë& 0xff] ^ 
Te3
[
s0
 & 0xff] ^ 
rk
[53];

978 
t2
 = 
Te0
[
s2
 >> 24] ^ 
Te1
[(
s3
 >> 16Ë& 0xff] ^ 
Te2
[(
s0
 >> 8Ë& 0xff] ^ 
Te3
[
s1
 & 0xff] ^ 
rk
[54];

979 
t3
 = 
Te0
[
s3
 >> 24] ^ 
Te1
[(
s0
 >> 16Ë& 0xff] ^ 
Te2
[(
s1
 >> 8Ë& 0xff] ^ 
Te3
[
s2
 & 0xff] ^ 
rk
[55];

982 
rk
 +
key
->
rounds
 << 2;

987 
r
 = 
key
->
rounds
 >> 1;

989 
t0
 =

990 
Te0
[(
s0
 >> 24) ] ^

991 
Te1
[(
s1
 >> 16) & 0xff] ^

992 
Te2
[(
s2
 >> 8) & 0xff] ^

993 
Te3
[(
s3
 ) & 0xff] ^

994 
rk
[4];

995 
t1
 =

996 
Te0
[(
s1
 >> 24) ] ^

997 
Te1
[(
s2
 >> 16) & 0xff] ^

998 
Te2
[(
s3
 >> 8) & 0xff] ^

999 
Te3
[(
s0
 ) & 0xff] ^

1000 
rk
[5];

1001 
t2
 =

1002 
Te0
[(
s2
 >> 24) ] ^

1003 
Te1
[(
s3
 >> 16) & 0xff] ^

1004 
Te2
[(
s0
 >> 8) & 0xff] ^

1005 
Te3
[(
s1
 ) & 0xff] ^

1006 
rk
[6];

1007 
t3
 =

1008 
Te0
[(
s3
 >> 24) ] ^

1009 
Te1
[(
s0
 >> 16) & 0xff] ^

1010 
Te2
[(
s1
 >> 8) & 0xff] ^

1011 
Te3
[(
s2
 ) & 0xff] ^

1012 
rk
[7];

1014 
rk
 += 8;

1015 i‡(--
r
 == 0) {

1019 
s0
 =

1020 
Te0
[(
t0
 >> 24) ] ^

1021 
Te1
[(
t1
 >> 16) & 0xff] ^

1022 
Te2
[(
t2
 >> 8) & 0xff] ^

1023 
Te3
[(
t3
 ) & 0xff] ^

1024 
rk
[0];

1025 
s1
 =

1026 
Te0
[(
t1
 >> 24) ] ^

1027 
Te1
[(
t2
 >> 16) & 0xff] ^

1028 
Te2
[(
t3
 >> 8) & 0xff] ^

1029 
Te3
[(
t0
 ) & 0xff] ^

1030 
rk
[1];

1031 
s2
 =

1032 
Te0
[(
t2
 >> 24) ] ^

1033 
Te1
[(
t3
 >> 16) & 0xff] ^

1034 
Te2
[(
t0
 >> 8) & 0xff] ^

1035 
Te3
[(
t1
 ) & 0xff] ^

1036 
rk
[2];

1037 
s3
 =

1038 
Te0
[(
t3
 >> 24) ] ^

1039 
Te1
[(
t0
 >> 16) & 0xff] ^

1040 
Te2
[(
t1
 >> 8) & 0xff] ^

1041 
Te3
[(
t2
 ) & 0xff] ^

1042 
rk
[3];

1049 
s0
 =

1050 (
Te4
[(
t0
 >> 24) ] & 0xff000000) ^

1051 (
Te4
[(
t1
 >> 16) & 0xff] & 0x00ff0000) ^

1052 (
Te4
[(
t2
 >> 8) & 0xff] & 0x0000ff00) ^

1053 (
Te4
[(
t3
 ) & 0xff] & 0x000000ff) ^

1054 
rk
[0];

1055 
	`PUTU32
(
out
 , 
s0
);

1056 
s1
 =

1057 (
Te4
[(
t1
 >> 24) ] & 0xff000000) ^

1058 (
Te4
[(
t2
 >> 16) & 0xff] & 0x00ff0000) ^

1059 (
Te4
[(
t3
 >> 8) & 0xff] & 0x0000ff00) ^

1060 (
Te4
[(
t0
 ) & 0xff] & 0x000000ff) ^

1061 
rk
[1];

1062 
	`PUTU32
(
out
 + 4, 
s1
);

1063 
s2
 =

1064 (
Te4
[(
t2
 >> 24) ] & 0xff000000) ^

1065 (
Te4
[(
t3
 >> 16) & 0xff] & 0x00ff0000) ^

1066 (
Te4
[(
t0
 >> 8) & 0xff] & 0x0000ff00) ^

1067 (
Te4
[(
t1
 ) & 0xff] & 0x000000ff) ^

1068 
rk
[2];

1069 
	`PUTU32
(
out
 + 8, 
s2
);

1070 
s3
 =

1071 (
Te4
[(
t3
 >> 24) ] & 0xff000000) ^

1072 (
Te4
[(
t0
 >> 16) & 0xff] & 0x00ff0000) ^

1073 (
Te4
[(
t1
 >> 8) & 0xff] & 0x0000ff00) ^

1074 (
Te4
[(
t2
 ) & 0xff] & 0x000000ff) ^

1075 
rk
[3];

1076 
	`PUTU32
(
out
 + 12, 
s3
);

1077 
	}
}

1083 
	$AES_de¸y±
(c⁄° *
ö
, *
out
,

1084 c⁄° 
AES_KEY
 *
key
) {

1086 c⁄° 
u32
 *
rk
;

1087 
u32
 
s0
, 
s1
, 
s2
, 
s3
, 
t0
, 
t1
, 
t2
, 
t3
;

1088 #i‚de‡
FULL_UNROLL


1089 
r
;

1092 
	`as£π
(
ö
 && 
out
 && 
key
);

1093 
rk
 = 
key
->
rd_key
;

1099 
s0
 = 
	`GETU32
(
ö
 ) ^ 
rk
[0];

1100 
s1
 = 
	`GETU32
(
ö
 + 4Ë^ 
rk
[1];

1101 
s2
 = 
	`GETU32
(
ö
 + 8Ë^ 
rk
[2];

1102 
s3
 = 
	`GETU32
(
ö
 + 12Ë^ 
rk
[3];

1103 #ifde‡
FULL_UNROLL


1105 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[ 4];

1106 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[ 5];

1107 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[ 6];

1108 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[ 7];

1110 
s0
 = 
Td0
[
t0
 >> 24] ^ 
Td1
[(
t3
 >> 16Ë& 0xff] ^ 
Td2
[(
t2
 >> 8Ë& 0xff] ^ 
Td3
[
t1
 & 0xff] ^ 
rk
[ 8];

1111 
s1
 = 
Td0
[
t1
 >> 24] ^ 
Td1
[(
t0
 >> 16Ë& 0xff] ^ 
Td2
[(
t3
 >> 8Ë& 0xff] ^ 
Td3
[
t2
 & 0xff] ^ 
rk
[ 9];

1112 
s2
 = 
Td0
[
t2
 >> 24] ^ 
Td1
[(
t1
 >> 16Ë& 0xff] ^ 
Td2
[(
t0
 >> 8Ë& 0xff] ^ 
Td3
[
t3
 & 0xff] ^ 
rk
[10];

1113 
s3
 = 
Td0
[
t3
 >> 24] ^ 
Td1
[(
t2
 >> 16Ë& 0xff] ^ 
Td2
[(
t1
 >> 8Ë& 0xff] ^ 
Td3
[
t0
 & 0xff] ^ 
rk
[11];

1115 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[12];

1116 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[13];

1117 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[14];

1118 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[15];

1120 
s0
 = 
Td0
[
t0
 >> 24] ^ 
Td1
[(
t3
 >> 16Ë& 0xff] ^ 
Td2
[(
t2
 >> 8Ë& 0xff] ^ 
Td3
[
t1
 & 0xff] ^ 
rk
[16];

1121 
s1
 = 
Td0
[
t1
 >> 24] ^ 
Td1
[(
t0
 >> 16Ë& 0xff] ^ 
Td2
[(
t3
 >> 8Ë& 0xff] ^ 
Td3
[
t2
 & 0xff] ^ 
rk
[17];

1122 
s2
 = 
Td0
[
t2
 >> 24] ^ 
Td1
[(
t1
 >> 16Ë& 0xff] ^ 
Td2
[(
t0
 >> 8Ë& 0xff] ^ 
Td3
[
t3
 & 0xff] ^ 
rk
[18];

1123 
s3
 = 
Td0
[
t3
 >> 24] ^ 
Td1
[(
t2
 >> 16Ë& 0xff] ^ 
Td2
[(
t1
 >> 8Ë& 0xff] ^ 
Td3
[
t0
 & 0xff] ^ 
rk
[19];

1125 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[20];

1126 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[21];

1127 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[22];

1128 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[23];

1130 
s0
 = 
Td0
[
t0
 >> 24] ^ 
Td1
[(
t3
 >> 16Ë& 0xff] ^ 
Td2
[(
t2
 >> 8Ë& 0xff] ^ 
Td3
[
t1
 & 0xff] ^ 
rk
[24];

1131 
s1
 = 
Td0
[
t1
 >> 24] ^ 
Td1
[(
t0
 >> 16Ë& 0xff] ^ 
Td2
[(
t3
 >> 8Ë& 0xff] ^ 
Td3
[
t2
 & 0xff] ^ 
rk
[25];

1132 
s2
 = 
Td0
[
t2
 >> 24] ^ 
Td1
[(
t1
 >> 16Ë& 0xff] ^ 
Td2
[(
t0
 >> 8Ë& 0xff] ^ 
Td3
[
t3
 & 0xff] ^ 
rk
[26];

1133 
s3
 = 
Td0
[
t3
 >> 24] ^ 
Td1
[(
t2
 >> 16Ë& 0xff] ^ 
Td2
[(
t1
 >> 8Ë& 0xff] ^ 
Td3
[
t0
 & 0xff] ^ 
rk
[27];

1135 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[28];

1136 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[29];

1137 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[30];

1138 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[31];

1140 
s0
 = 
Td0
[
t0
 >> 24] ^ 
Td1
[(
t3
 >> 16Ë& 0xff] ^ 
Td2
[(
t2
 >> 8Ë& 0xff] ^ 
Td3
[
t1
 & 0xff] ^ 
rk
[32];

1141 
s1
 = 
Td0
[
t1
 >> 24] ^ 
Td1
[(
t0
 >> 16Ë& 0xff] ^ 
Td2
[(
t3
 >> 8Ë& 0xff] ^ 
Td3
[
t2
 & 0xff] ^ 
rk
[33];

1142 
s2
 = 
Td0
[
t2
 >> 24] ^ 
Td1
[(
t1
 >> 16Ë& 0xff] ^ 
Td2
[(
t0
 >> 8Ë& 0xff] ^ 
Td3
[
t3
 & 0xff] ^ 
rk
[34];

1143 
s3
 = 
Td0
[
t3
 >> 24] ^ 
Td1
[(
t2
 >> 16Ë& 0xff] ^ 
Td2
[(
t1
 >> 8Ë& 0xff] ^ 
Td3
[
t0
 & 0xff] ^ 
rk
[35];

1145 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[36];

1146 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[37];

1147 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[38];

1148 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[39];

1149 i‡(
key
->
rounds
 > 10) {

1151 
s0
 = 
Td0
[
t0
 >> 24] ^ 
Td1
[(
t3
 >> 16Ë& 0xff] ^ 
Td2
[(
t2
 >> 8Ë& 0xff] ^ 
Td3
[
t1
 & 0xff] ^ 
rk
[40];

1152 
s1
 = 
Td0
[
t1
 >> 24] ^ 
Td1
[(
t0
 >> 16Ë& 0xff] ^ 
Td2
[(
t3
 >> 8Ë& 0xff] ^ 
Td3
[
t2
 & 0xff] ^ 
rk
[41];

1153 
s2
 = 
Td0
[
t2
 >> 24] ^ 
Td1
[(
t1
 >> 16Ë& 0xff] ^ 
Td2
[(
t0
 >> 8Ë& 0xff] ^ 
Td3
[
t3
 & 0xff] ^ 
rk
[42];

1154 
s3
 = 
Td0
[
t3
 >> 24] ^ 
Td1
[(
t2
 >> 16Ë& 0xff] ^ 
Td2
[(
t1
 >> 8Ë& 0xff] ^ 
Td3
[
t0
 & 0xff] ^ 
rk
[43];

1156 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[44];

1157 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[45];

1158 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[46];

1159 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[47];

1160 i‡(
key
->
rounds
 > 12) {

1162 
s0
 = 
Td0
[
t0
 >> 24] ^ 
Td1
[(
t3
 >> 16Ë& 0xff] ^ 
Td2
[(
t2
 >> 8Ë& 0xff] ^ 
Td3
[
t1
 & 0xff] ^ 
rk
[48];

1163 
s1
 = 
Td0
[
t1
 >> 24] ^ 
Td1
[(
t0
 >> 16Ë& 0xff] ^ 
Td2
[(
t3
 >> 8Ë& 0xff] ^ 
Td3
[
t2
 & 0xff] ^ 
rk
[49];

1164 
s2
 = 
Td0
[
t2
 >> 24] ^ 
Td1
[(
t1
 >> 16Ë& 0xff] ^ 
Td2
[(
t0
 >> 8Ë& 0xff] ^ 
Td3
[
t3
 & 0xff] ^ 
rk
[50];

1165 
s3
 = 
Td0
[
t3
 >> 24] ^ 
Td1
[(
t2
 >> 16Ë& 0xff] ^ 
Td2
[(
t1
 >> 8Ë& 0xff] ^ 
Td3
[
t0
 & 0xff] ^ 
rk
[51];

1167 
t0
 = 
Td0
[
s0
 >> 24] ^ 
Td1
[(
s3
 >> 16Ë& 0xff] ^ 
Td2
[(
s2
 >> 8Ë& 0xff] ^ 
Td3
[
s1
 & 0xff] ^ 
rk
[52];

1168 
t1
 = 
Td0
[
s1
 >> 24] ^ 
Td1
[(
s0
 >> 16Ë& 0xff] ^ 
Td2
[(
s3
 >> 8Ë& 0xff] ^ 
Td3
[
s2
 & 0xff] ^ 
rk
[53];

1169 
t2
 = 
Td0
[
s2
 >> 24] ^ 
Td1
[(
s1
 >> 16Ë& 0xff] ^ 
Td2
[(
s0
 >> 8Ë& 0xff] ^ 
Td3
[
s3
 & 0xff] ^ 
rk
[54];

1170 
t3
 = 
Td0
[
s3
 >> 24] ^ 
Td1
[(
s2
 >> 16Ë& 0xff] ^ 
Td2
[(
s1
 >> 8Ë& 0xff] ^ 
Td3
[
s0
 & 0xff] ^ 
rk
[55];

1173 
rk
 +
key
->
rounds
 << 2;

1178 
r
 = 
key
->
rounds
 >> 1;

1180 
t0
 =

1181 
Td0
[(
s0
 >> 24) ] ^

1182 
Td1
[(
s3
 >> 16) & 0xff] ^

1183 
Td2
[(
s2
 >> 8) & 0xff] ^

1184 
Td3
[(
s1
 ) & 0xff] ^

1185 
rk
[4];

1186 
t1
 =

1187 
Td0
[(
s1
 >> 24) ] ^

1188 
Td1
[(
s0
 >> 16) & 0xff] ^

1189 
Td2
[(
s3
 >> 8) & 0xff] ^

1190 
Td3
[(
s2
 ) & 0xff] ^

1191 
rk
[5];

1192 
t2
 =

1193 
Td0
[(
s2
 >> 24) ] ^

1194 
Td1
[(
s1
 >> 16) & 0xff] ^

1195 
Td2
[(
s0
 >> 8) & 0xff] ^

1196 
Td3
[(
s3
 ) & 0xff] ^

1197 
rk
[6];

1198 
t3
 =

1199 
Td0
[(
s3
 >> 24) ] ^

1200 
Td1
[(
s2
 >> 16) & 0xff] ^

1201 
Td2
[(
s1
 >> 8) & 0xff] ^

1202 
Td3
[(
s0
 ) & 0xff] ^

1203 
rk
[7];

1205 
rk
 += 8;

1206 i‡(--
r
 == 0) {

1210 
s0
 =

1211 
Td0
[(
t0
 >> 24) ] ^

1212 
Td1
[(
t3
 >> 16) & 0xff] ^

1213 
Td2
[(
t2
 >> 8) & 0xff] ^

1214 
Td3
[(
t1
 ) & 0xff] ^

1215 
rk
[0];

1216 
s1
 =

1217 
Td0
[(
t1
 >> 24) ] ^

1218 
Td1
[(
t0
 >> 16) & 0xff] ^

1219 
Td2
[(
t3
 >> 8) & 0xff] ^

1220 
Td3
[(
t2
 ) & 0xff] ^

1221 
rk
[1];

1222 
s2
 =

1223 
Td0
[(
t2
 >> 24) ] ^

1224 
Td1
[(
t1
 >> 16) & 0xff] ^

1225 
Td2
[(
t0
 >> 8) & 0xff] ^

1226 
Td3
[(
t3
 ) & 0xff] ^

1227 
rk
[2];

1228 
s3
 =

1229 
Td0
[(
t3
 >> 24) ] ^

1230 
Td1
[(
t2
 >> 16) & 0xff] ^

1231 
Td2
[(
t1
 >> 8) & 0xff] ^

1232 
Td3
[(
t0
 ) & 0xff] ^

1233 
rk
[3];

1240 
s0
 =

1241 (
Td4
[(
t0
 >> 24) ] & 0xff000000) ^

1242 (
Td4
[(
t3
 >> 16) & 0xff] & 0x00ff0000) ^

1243 (
Td4
[(
t2
 >> 8) & 0xff] & 0x0000ff00) ^

1244 (
Td4
[(
t1
 ) & 0xff] & 0x000000ff) ^

1245 
rk
[0];

1246 
	`PUTU32
(
out
 , 
s0
);

1247 
s1
 =

1248 (
Td4
[(
t1
 >> 24) ] & 0xff000000) ^

1249 (
Td4
[(
t0
 >> 16) & 0xff] & 0x00ff0000) ^

1250 (
Td4
[(
t3
 >> 8) & 0xff] & 0x0000ff00) ^

1251 (
Td4
[(
t2
 ) & 0xff] & 0x000000ff) ^

1252 
rk
[1];

1253 
	`PUTU32
(
out
 + 4, 
s1
);

1254 
s2
 =

1255 (
Td4
[(
t2
 >> 24) ] & 0xff000000) ^

1256 (
Td4
[(
t1
 >> 16) & 0xff] & 0x00ff0000) ^

1257 (
Td4
[(
t0
 >> 8) & 0xff] & 0x0000ff00) ^

1258 (
Td4
[(
t3
 ) & 0xff] & 0x000000ff) ^

1259 
rk
[2];

1260 
	`PUTU32
(
out
 + 8, 
s2
);

1261 
s3
 =

1262 (
Td4
[(
t3
 >> 24) ] & 0xff000000) ^

1263 (
Td4
[(
t2
 >> 16) & 0xff] & 0x00ff0000) ^

1264 (
Td4
[(
t1
 >> 8) & 0xff] & 0x0000ff00) ^

1265 (
Td4
[(
t0
 ) & 0xff] & 0x000000ff) ^

1266 
rk
[3];

1267 
	`PUTU32
(
out
 + 12, 
s3
);

1268 
	}
}

1272 
	$AES_cbc_í¸y±
(c⁄° *
ö
, *
out
,

1273 c⁄° 
Àngth
, c⁄° 
AES_KEY
 *
key
,

1274 *
ivec
, c⁄° 
íc
)

1277 
n
;

1278 
Àn
 = 
Àngth
;

1279 
tmp
[
AES_BLOCK_SIZE
];

1281 
	`as£π
(
ö
 && 
out
 && 
key
 && 
ivec
);

1283 i‡(
íc
) {

1284 
Àn
 >
AES_BLOCK_SIZE
) {

1285 
n
=0;Ç < 
AES_BLOCK_SIZE
; ++n)

1286 
tmp
[
n
] = 
ö
[n] ^ 
ivec
[n];

1287 
	`AES_í¸y±
(
tmp
, 
out
, 
key
);

1288 
	`mem˝y
(
ivec
, 
out
, 
AES_BLOCK_SIZE
);

1289 
Àn
 -
AES_BLOCK_SIZE
;

1290 
ö
 +
AES_BLOCK_SIZE
;

1291 
out
 +
AES_BLOCK_SIZE
;

1293 i‡(
Àn
) {

1294 
n
=0;Ç < 
Àn
; ++n)

1295 
tmp
[
n
] = 
ö
[n] ^ 
ivec
[n];

1296 
n
=
Àn
;Ç < 
AES_BLOCK_SIZE
; ++n)

1297 
tmp
[
n
] = 
ivec
[n];

1298 
	`AES_í¸y±
(
tmp
,Åmp, 
key
);

1299 
	`mem˝y
(
out
, 
tmp
, 
AES_BLOCK_SIZE
);

1300 
	`mem˝y
(
ivec
, 
tmp
, 
AES_BLOCK_SIZE
);

1303 
Àn
 >
AES_BLOCK_SIZE
) {

1304 
	`mem˝y
(
tmp
, 
ö
, 
AES_BLOCK_SIZE
);

1305 
	`AES_de¸y±
(
ö
, 
out
, 
key
);

1306 
n
=0;Ç < 
AES_BLOCK_SIZE
; ++n)

1307 
out
[
n
] ^
ivec
[n];

1308 
	`mem˝y
(
ivec
, 
tmp
, 
AES_BLOCK_SIZE
);

1309 
Àn
 -
AES_BLOCK_SIZE
;

1310 
ö
 +
AES_BLOCK_SIZE
;

1311 
out
 +
AES_BLOCK_SIZE
;

1313 i‡(
Àn
) {

1314 
	`mem˝y
(
tmp
, 
ö
, 
AES_BLOCK_SIZE
);

1315 
	`AES_de¸y±
(
tmp
,Åmp, 
key
);

1316 
n
=0;Ç < 
Àn
; ++n)

1317 
out
[
n
] = 
tmp
[n] ^ 
ivec
[n];

1318 
	`mem˝y
(
ivec
, 
tmp
, 
AES_BLOCK_SIZE
);

1321 
	}
}

	@aes.h

24 #i‚de‡
AES_H


25 
	#AES_H


	)

27 
	#AES_MAXNR
 14

	)

28 
	#AES_BLOCK_SIZE
 16

	)

30 
	s´s_key_°
 {

31 
uöt32_t
 
	mrd_key
[4 *(
AES_MAXNR
 + 1)];

32 
	mrounds
;

34 
´s_key_°
 
	tAES_KEY
;

36 
AES_£t_í¸y±_key
(c⁄° *
u£rKey
, c⁄° 
bôs
,

37 
AES_KEY
 *
key
);

38 
AES_£t_de¸y±_key
(c⁄° *
u£rKey
, c⁄° 
bôs
,

39 
AES_KEY
 *
key
);

41 
AES_í¸y±
(c⁄° *
ö
, *
out
,

42 c⁄° 
AES_KEY
 *
key
);

43 
AES_de¸y±
(c⁄° *
ö
, *
out
,

44 c⁄° 
AES_KEY
 *
key
);

45 
AES_cbc_í¸y±
(c⁄° *
ö
, *
out
,

46 c⁄° 
Àngth
, c⁄° 
AES_KEY
 *
key
,

47 *
ivec
, c⁄° 
íc
);

	@block_net.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

30 
	~<f˙é.h
>

31 
	~<î∫o.h
>

32 
	~<uni°d.h
>

33 
	~<time.h
>

35 
	~"cutûs.h
"

36 
	~"vútio.h
"

37 
	~"fs_wgë.h
"

38 
	~"li°.h
"

39 
	~"fbuf.h
"

40 
	~"machöe.h
"

43 
	mCBLOCK_LOADING
,

44 
	mCBLOCK_LOADED
,

45 } 
	tCachedBlockSèãEnum
;

47 
	sCachedBlock
 {

48 
li°_hód
 
	mlök
;

49 
BlockDevi˚HTTP
 *
	mbf
;

50 
	mblock_num
;

51 
CachedBlockSèãEnum
 
	m°©e
;

52 
FûeBuf„r
 
	mfbuf
;

53 } 
	tCachedBlock
;

55 
	#BLK_FMT
 "%sblk%09u.bö"

	)

56 
	#GROUP_FMT
 "%sgΩ%09u.bö"

	)

57 
	#PREFETCH_GROUP_LEN_MAX
 32

	)

60 
BlockDevi˚HTTP
 *
	mbf
;

61 
	mgroup_num
;

62 
	mn_block_num
;

63 
CachedBlock
 *
	mèb_block
[
PREFETCH_GROUP_LEN_MAX
];

64 } 
	tPª„tchGroupReque°
;

68 
	sClu°î
 {

69 
FûeBuf„r
 
	mfbuf
;

70 } 
	tClu°î
;

72 
	sBlockDevi˚HTTP
 {

73 
BlockDevi˚
 *
	mbs
;

74 
	mmax_ˇche_size_kb
;

75 
	muæ
[1024];

76 
	m¥e„tch_cou¡
;

77 (*
	m°¨t_cb
)(*
	m›aque
);

78 *
	m°¨t_›aque
;

80 
öt64_t
 
	mnb_£˘‹s
;

81 
	mblock_size
;

82 
	mnb_blocks
;

83 
li°_hód
 
	mˇched_blocks
;

84 
	mn_ˇched_blocks
;

85 
	mn_ˇched_blocks_max
;

88 
	m£˘‹s_≥r_˛u°î
;

89 
Clu°î
 **
	m˛u°îs
;

90 
	mn_˛u°îs
;

91 
	mn_Æloˇãd_˛u°îs
;

94 
öt64_t
 
	mn_ªad_£˘‹s
;

95 
öt64_t
 
	mn_ªad_blocks
;

96 
öt64_t
 
	mn_wrôe_£˘‹s
;

99 
BOOL
 
	mis_wrôe
;

100 
uöt64_t
 
	m£˘‹_num
;

101 
	mcur_block_num
;

102 
	m£˘‹_ödex
, 
	m£˘‹_cou¡
;

103 
BlockDevi˚Com∂ëi⁄Func
 *
	mcb
;

104 *
	m›aque
;

105 
uöt8_t
 *
	mio_buf
;

108 
	m¥e„tch_group_Àn
;

109 } 
	tBlockDevi˚HTTP
;

111 
bf_upd©e_block
(
CachedBlock
 *
b
, c⁄° 
uöt8_t
 *
d©a
);

112 
bf_ªad_⁄lﬂd
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
);

113 
bf_öô_⁄lﬂd
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
);

114 
bf_¥e„tch_group_⁄lﬂd
(*
›aque
, 
îr
, *
d©a
,

115 
size_t
 
size
);

117 
CachedBlock
 *
	$bf_föd_block
(
BlockDevi˚HTTP
 *
bf
, 
block_num
)

119 
CachedBlock
 *
b
;

120 
li°_hód
 *
ñ
;

122 
	`li°_f‹_óch
(
ñ
, &
bf
->
ˇched_blocks
) {

123 
b
 = 
	`li°_íåy
(
ñ
, 
CachedBlock
, 
lök
);

124 i‡(
b
->
block_num
 == block_num) {

126 i‡(
bf
->
ˇched_blocks
.
√xt
 !
ñ
) {

127 
	`li°_dñ
(&
b
->
lök
);

128 
	`li°_add
(&
b
->
lök
, &
bf
->
ˇched_blocks
);

130  
b
;

133  
NULL
;

134 
	}
}

136 
	$bf_‰ì_block
(
BlockDevi˚HTTP
 *
bf
, 
CachedBlock
 *
b
)

138 
bf
->
n_ˇched_blocks
--;

139 
	`fûe_buf„r_ª£t
(&
b
->
fbuf
);

140 
	`li°_dñ
(&
b
->
lök
);

141 
	`‰ì
(
b
);

142 
	}
}

144 
CachedBlock
 *
	$bf_add_block
(
BlockDevi˚HTTP
 *
bf
, 
block_num
)

146 
CachedBlock
 *
b
;

147 i‡(
bf
->
n_ˇched_blocks
 >bf->
n_ˇched_blocks_max
) {

148 
li°_hód
 *
ñ
, *
ñ1
;

150 
	`li°_f‹_óch_¥ev_ß„
(
ñ
, 
ñ1
, &
bf
->
ˇched_blocks
) {

151 
b
 = 
	`li°_íåy
(
ñ
, 
CachedBlock
, 
lök
);

152 i‡(
b
->
°©e
 =
CBLOCK_LOADED
) {

153 
	`bf_‰ì_block
(
bf
, 
b
);

154 i‡(
bf
->
n_ˇched_blocks
 < bf->
n_ˇched_blocks_max
)

159 
b
 = 
	`mÆlocz
((
CachedBlock
));

160 
b
->
bf
 = bf;

161 
b
->
block_num
 = block_num;

162 
b
->
°©e
 = 
CBLOCK_LOADING
;

163 
	`fûe_buf„r_öô
(&
b
->
fbuf
);

164 
	`fûe_buf„r_ªsize
(&
b
->
fbuf
, 
bf
->
block_size
 * 512);

165 
	`li°_add
(&
b
->
lök
, &
bf
->
ˇched_blocks
);

166 
bf
->
n_ˇched_blocks
++;

167  
b
;

168 
	}
}

170 
öt64_t
 
	$bf_gë_£˘‹_cou¡
(
BlockDevi˚
 *
bs
)

172 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

173  
bf
->
nb_£˘‹s
;

174 
	}
}

176 
	$bf_°¨t_lﬂd_block
(
BlockDevi˚
 *
bs
, 
block_num
)

178 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

179 
fûíame
[1024];

180 
CachedBlock
 *
b
;

181 
b
 = 
	`bf_add_block
(
bf
, 
block_num
);

182 
bf
->
n_ªad_blocks
++;

185 
	`¥ötf
("%u,\n", 
block_num
);

188 
	`¥ötf
("load_blk=%d cached=%dÑead=%d KB (%d KB) write=%d KB (%d KB)\n",

189 
block_num
, 
bf
->
n_ˇched_blocks
,

190 ()(
bf
->
n_ªad_£˘‹s
 / 2),

191 ()(
bf
->
n_ªad_blocks
 * bf->
block_size
 / 2),

192 ()(
bf
->
n_wrôe_£˘‹s
 / 2),

193 ()(
bf
->
n_Æloˇãd_˛u°îs
 * bf->
£˘‹s_≥r_˛u°î
 / 2));

195 
	`¢¥ötf
(
fûíame
, (fûíame), 
BLK_FMT
, 
bf
->
uæ
, 
block_num
);

197 
	`fs_wgë
(
fûíame
, 
NULL
, NULL, 
b
, 
bf_ªad_⁄lﬂd
, 
TRUE
);

198 
	}
}

200 
	$bf_°¨t_lﬂd_¥e„tch_group
(
BlockDevi˚
 *
bs
, 
group_num
,

201 c⁄° *
èb_block_num
,

202 
n_block_num
)

204 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

205 
CachedBlock
 *
b
;

206 
Pª„tchGroupReque°
 *
ªq
;

207 
fûíame
[1024];

208 
BOOL
 
ªq_Êag
;

209 
i
;

211 
ªq_Êag
 = 
FALSE
;

212 
ªq
 = 
	`mÆloc
((*req));

213 
ªq
->
bf
 = bf;

214 
ªq
->
group_num
 = group_num;

215 
ªq
->
n_block_num
 =Ç_block_num;

216 
i
 = 0; i < 
n_block_num
; i++) {

217 
b
 = 
	`bf_föd_block
(
bf
, 
èb_block_num
[
i
]);

218 i‡(!
b
) {

219 
b
 = 
	`bf_add_block
(
bf
, 
èb_block_num
[
i
]);

220 
ªq_Êag
 = 
TRUE
;

224 
b
 = 
NULL
;

226 
ªq
->
èb_block
[
i
] = 
b
;

229 i‡(
ªq_Êag
) {

230 
	`¢¥ötf
(
fûíame
, (fûíame), 
GROUP_FMT
, 
bf
->
uæ
, 
group_num
);

232 
	`fs_wgë
(
fûíame
, 
NULL
, NULL, 
ªq
, 
bf_¥e„tch_group_⁄lﬂd
, 
TRUE
);

235 
	`‰ì
(
ªq
);

237 
	}
}

239 
	$bf_¥e„tch_group_⁄lﬂd
(*
›aque
, 
îr
, *
d©a
,

240 
size_t
 
size
)

242 
Pª„tchGroupReque°
 *
ªq
 = 
›aque
;

243 
BlockDevi˚HTTP
 *
bf
 = 
ªq
->bf;

244 
CachedBlock
 *
b
;

245 
block_byãs
, 
i
;

247 i‡(
îr
 < 0) {

248 
	`Ârötf
(
°dîr
, "CouldÇŸÜﬂd grou∞%u\n", 
ªq
->
group_num
);

249 
	`exô
(1);

251 
block_byãs
 = 
bf
->
block_size
 * 512;

252 
	`as£π
(
size
 =
block_byãs
 * 
ªq
->
n_block_num
);

253 
i
 = 0; i < 
ªq
->
n_block_num
; i++) {

254 
b
 = 
ªq
->
èb_block
[
i
];

255 i‡(
b
) {

256 
	`bf_upd©e_block
(
b
, (c⁄° 
uöt8_t
 *)
d©a
 + 
block_byãs
 * 
i
);

259 
	`‰ì
(
ªq
);

260 
	}
}

262 
	$bf_rw_async1
(
BlockDevi˚
 *
bs
, 
BOOL
 
is_sync
)

264 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

265 
off£t
, 
block_num
, 
n
, 
˛u°î_num
;

266 
CachedBlock
 *
b
;

267 
Clu°î
 *
c
;

270 
n
 = 
bf
->
£˘‹_cou¡
 - bf->
£˘‹_ödex
;

271 i‡(
n
 == 0)

273 
˛u°î_num
 = 
bf
->
£˘‹_num
 / bf->
£˘‹s_≥r_˛u°î
;

274 
c
 = 
bf
->
˛u°îs
[
˛u°î_num
];

275 i‡(
c
) {

276 
off£t
 = 
bf
->
£˘‹_num
 % bf->
£˘‹s_≥r_˛u°î
;

277 
n
 = 
	`mö_öt
“, 
bf
->
£˘‹s_≥r_˛u°î
 - 
off£t
);

278 i‡(
bf
->
is_wrôe
) {

279 
	`fûe_buf„r_wrôe
(&
c
->
fbuf
, 
off£t
 * 512,

280 
bf
->
io_buf
 + bf->
£˘‹_ödex
 * 512, 
n
 * 512);

282 
	`fûe_buf„r_ªad
(&
c
->
fbuf
, 
off£t
 * 512,

283 
bf
->
io_buf
 + bf->
£˘‹_ödex
 * 512, 
n
 * 512);

285 
bf
->
£˘‹_ödex
 +
n
;

286 
bf
->
£˘‹_num
 +
n
;

288 
block_num
 = 
bf
->
£˘‹_num
 / bf->
block_size
;

289 
off£t
 = 
bf
->
£˘‹_num
 % bf->
block_size
;

290 
n
 = 
	`mö_öt
“, 
bf
->
block_size
 - 
off£t
);

291 
bf
->
cur_block_num
 = 
block_num
;

293 
b
 = 
	`bf_föd_block
(
bf
, 
block_num
);

294 i‡(
b
) {

295 i‡(
b
->
°©e
 =
CBLOCK_LOADING
) {

299 i‡(
bf
->
is_wrôe
) {

300 
˛u°î_size
, 
˛u°î_off£t
;

301 
uöt8_t
 *
buf
;

303 
c
 = 
	`mÆlocz
((
Clu°î
));

304 
˛u°î_size
 = 
bf
->
£˘‹s_≥r_˛u°î
 * 512;

305 
buf
 = 
	`mÆloc
(
˛u°î_size
);

306 
	`fûe_buf„r_öô
(&
c
->
fbuf
);

307 
	`fûe_buf„r_ªsize
(&
c
->
fbuf
, 
˛u°î_size
);

308 
bf
->
˛u°îs
[
˛u°î_num
] = 
c
;

310 
˛u°î_off£t
 = (
˛u°î_num
 * 
bf
->
£˘‹s_≥r_˛u°î
) &

311 (
bf
->
block_size
 - 1);

312 
	`fûe_buf„r_ªad
(&
b
->
fbuf
, 
˛u°î_off£t
 * 512,

313 
buf
, 
˛u°î_size
);

314 
	`fûe_buf„r_wrôe
(&
c
->
fbuf
, 0, 
buf
, 
˛u°î_size
);

315 
	`‰ì
(
buf
);

316 
bf
->
n_Æloˇãd_˛u°îs
++;

319 
	`fûe_buf„r_ªad
(&
b
->
fbuf
, 
off£t
 * 512,

320 
bf
->
io_buf
 + bf->
£˘‹_ödex
 * 512, 
n
 * 512);

322 
bf
->
£˘‹_ödex
 +
n
;

323 
bf
->
£˘‹_num
 +
n
;

326 
	`bf_°¨t_lﬂd_block
(
bs
, 
block_num
);

329 
bf
->
cur_block_num
 = -1;

333 i‡(!
is_sync
) {

336 
bf
->
	`cb
(bf->
›aque
, 0);

339 
	}
}

341 
	$bf_upd©e_block
(
CachedBlock
 *
b
, c⁄° 
uöt8_t
 *
d©a
)

343 
BlockDevi˚HTTP
 *
bf
 = 
b
->bf;

344 
BlockDevi˚
 *
bs
 = 
bf
->bs;

346 
	`as£π
(
b
->
°©e
 =
CBLOCK_LOADING
);

347 
	`fûe_buf„r_wrôe
(&
b
->
fbuf
, 0, 
d©a
, 
bf
->
block_size
 * 512);

348 
b
->
°©e
 = 
CBLOCK_LOADED
;

351 i‡(
b
->
block_num
 =
bf
->
cur_block_num
) {

352 
	`bf_rw_async1
(
bs
, 
FALSE
);

354 
	}
}

356 
	$bf_ªad_⁄lﬂd
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
)

358 
CachedBlock
 *
b
 = 
›aque
;

359 
BlockDevi˚HTTP
 *
bf
 = 
b
->bf;

361 i‡(
îr
 < 0) {

362 
	`Ârötf
(
°dîr
, "CouldÇŸÜﬂd block %u\n", 
b
->
block_num
);

363 
	`exô
(1);

366 
	`as£π
(
size
 =
bf
->
block_size
 * 512);

367 
	`bf_upd©e_block
(
b
, 
d©a
);

368 
	}
}

370 
	$bf_ªad_async
(
BlockDevi˚
 *
bs
,

371 
uöt64_t
 
£˘‹_num
, 
uöt8_t
 *
buf
, 
n
,

372 
BlockDevi˚Com∂ëi⁄Func
 *
cb
, *
›aque
)

374 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

376 
bf
->
is_wrôe
 = 
FALSE
;

377 
bf
->
£˘‹_num
 = sector_num;

378 
bf
->
io_buf
 = 
buf
;

379 
bf
->
£˘‹_cou¡
 = 
n
;

380 
bf
->
£˘‹_ödex
 = 0;

381 
bf
->
cb
 = cb;

382 
bf
->
›aque
 = opaque;

383 
bf
->
n_ªad_£˘‹s
 +
n
;

384  
	`bf_rw_async1
(
bs
, 
TRUE
);

385 
	}
}

387 
	$bf_wrôe_async
(
BlockDevi˚
 *
bs
,

388 
uöt64_t
 
£˘‹_num
, c⁄° 
uöt8_t
 *
buf
, 
n
,

389 
BlockDevi˚Com∂ëi⁄Func
 *
cb
, *
›aque
)

391 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

393 
bf
->
is_wrôe
 = 
TRUE
;

394 
bf
->
£˘‹_num
 = sector_num;

395 
bf
->
io_buf
 = (
uöt8_t
 *)
buf
;

396 
bf
->
£˘‹_cou¡
 = 
n
;

397 
bf
->
£˘‹_ödex
 = 0;

398 
bf
->
cb
 = cb;

399 
bf
->
›aque
 = opaque;

400 
bf
->
n_wrôe_£˘‹s
 +
n
;

401  
	`bf_rw_async1
(
bs
, 
TRUE
);

402 
	}
}

404 
BlockDevi˚
 *
	$block_devi˚_öô_hâp
(c⁄° *
uæ
,

405 
max_ˇche_size_kb
,

406 (*
°¨t_cb
)(*
›aque
),

407 *
°¨t_›aque
)

409 
BlockDevi˚
 *
bs
;

410 
BlockDevi˚HTTP
 *
bf
;

411 *
p
;

413 
bs
 = 
	`mÆlocz
((*bs));

414 
bf
 = 
	`mÆlocz
((*bf));

415 
	`°r˝y
(
bf
->
uæ
, url);

417 
p
 = 
	`°ºchr
(
bf
->
uæ
, '/');

418 i‡(!
p
)

419 
p
 = 
bf
->
uæ
;

421 
p
++;

422 *
p
 = '\0';

424 
	`öô_li°_hód
(&
bf
->
ˇched_blocks
);

425 
bf
->
max_ˇche_size_kb
 = max_cache_size_kb;

426 
bf
->
°¨t_cb
 = start_cb;

427 
bf
->
°¨t_›aque
 = start_opaque;

428 
bf
->
bs
 = bs;

430 
bs
->
›aque
 = 
bf
;

431 
bs
->
gë_£˘‹_cou¡
 = 
bf_gë_£˘‹_cou¡
;

432 
bs
->
ªad_async
 = 
bf_ªad_async
;

433 
bs
->
wrôe_async
 = 
bf_wrôe_async
;

435 
	`fs_wgë
(
uæ
, 
NULL
, NULL, 
bs
, 
bf_öô_⁄lﬂd
, 
TRUE
);

436  
bs
;

437 
	}
}

439 
	$bf_öô_⁄lﬂd
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
)

441 
BlockDevi˚
 *
bs
 = 
›aque
;

442 
BlockDevi˚HTTP
 *
bf
 = 
bs
->
›aque
;

443 
block_size_kb
, 
block_num
;

444 
JSONVÆue
 
cfg
, 
¨øy
;

446 i‡(
îr
 < 0) {

447 
	`Ârötf
(
°dîr
, "CouldÇŸÜﬂd block devi˚ fûê”º=%d)\n", -
îr
);

448 
	`exô
(1);

452 
cfg
 = 
	`js⁄_∑r£_vÆue_Àn
(
d©a
, 
size
);

453 i‡(
	`js⁄_is_îr‹
(
cfg
)) {

454 
	`vm_îr‹
("îr‹: %s\n", 
	`js⁄_gë_îr‹
(
cfg
));

455 
c⁄fig_îr‹
:

456 
	`js⁄_‰ì
(
cfg
);

457 
	`exô
(1);

460 i‡(
	`vm_gë_öt
(
cfg
, "block_size", &
block_size_kb
) < 0)

461 
c⁄fig_îr‹
;

462 
bf
->
block_size
 = 
block_size_kb
 * 2;

463 i‡(
bf
->
block_size
 <= 0 ||

464 (
bf
->
block_size
 & (bf->block_size - 1)) != 0) {

465 
	`vm_îr‹
("invalid block_size\n");

466 
c⁄fig_îr‹
;

468 i‡(
	`vm_gë_öt
(
cfg
, "n_block", &
bf
->
nb_blocks
) < 0)

469 
c⁄fig_îr‹
;

470 i‡(
bf
->
nb_blocks
 <= 0) {

471 
	`vm_îr‹
("invalidÇ_block\n");

472 
c⁄fig_îr‹
;

475 
bf
->
nb_£˘‹s
 = bf->
block_size
 * (
uöt64_t
)bf->
nb_blocks
;

476 
bf
->
n_ˇched_blocks
 = 0;

477 
bf
->
n_ˇched_blocks_max
 = 
	`max_öt
(1, bf->
max_ˇche_size_kb
 / 
block_size_kb
);

478 
bf
->
cur_block_num
 = -1;

480 
bf
->
£˘‹s_≥r_˛u°î
 = 8;

481 
bf
->
n_˛u°îs
 = (bf->
nb_£˘‹s
 + bf->
£˘‹s_≥r_˛u°î
 - 1) / bf->sectors_per_cluster;

482 
bf
->
˛u°îs
 = 
	`mÆlocz
((bf->˛u°îs[0]Ë* bf->
n_˛u°îs
);

484 i‡(
	`vm_gë_öt_›t
(
cfg
, "prefetch_group_len",

485 &
bf
->
¥e„tch_group_Àn
, 1) < 0)

486 
c⁄fig_îr‹
;

487 i‡(
bf
->
¥e„tch_group_Àn
 > 
PREFETCH_GROUP_LEN_MAX
) {

488 
	`vm_îr‹
("prefetch_group_len isÅooÜarge");

489 
c⁄fig_îr‹
;

492 
¨øy
 = 
	`js⁄_obje˘_gë
(
cfg
, "prefetch");

493 i‡(!
	`js⁄_is_undeföed
(
¨øy
)) {

494 
idx
, 
¥e„tch_Àn
, 
l
, 
i
;

495 
JSONVÆue
 
ñ
;

496 
èb_block_num
[
PREFETCH_GROUP_LEN_MAX
];

498 i‡(
¨øy
.
ty≥
 !
JSON_ARRAY
) {

499 
	`vm_îr‹
("expectingánárray\n");

500 
c⁄fig_îr‹
;

502 
¥e„tch_Àn
 = 
¨øy
.
u
.¨øy->
Àn
;

503 
idx
 = 0;

504 
idx
 < 
¥e„tch_Àn
) {

505 
l
 = 
	`mö_öt
(
¥e„tch_Àn
 - 
idx
, 
bf
->
¥e„tch_group_Àn
);

506 
i
 = 0; i < 
l
; i++) {

507 
ñ
 = 
	`js⁄_¨øy_gë
(
¨øy
, 
idx
 + 
i
);

508 i‡(
ñ
.
ty≥
 !
JSON_INT
) {

509 
	`vm_îr‹
("expectingán integer\n");

510 
c⁄fig_îr‹
;

512 
èb_block_num
[
i
] = 
ñ
.
u
.
öt32
;

514 i‡(
l
 == 1) {

515 
block_num
 = 
èb_block_num
[0];

516 i‡(!
	`bf_föd_block
(
bf
, 
block_num
)) {

517 
	`bf_°¨t_lﬂd_block
(
bs
, 
block_num
);

520 
	`bf_°¨t_lﬂd_¥e„tch_group
(
bs
, 
idx
 / 
bf
->
¥e„tch_group_Àn
,

521 
èb_block_num
, 
l
);

523 
idx
 +
l
;

526 
	`js⁄_‰ì
(
cfg
);

528 i‡(
bf
->
°¨t_cb
) {

529 
bf
->
	`°¨t_cb
(bf->
°¨t_›aque
);

531 
	}
}

	@build_filelist.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

30 
	~<sys/°©fs.h
>

31 
	~<sys/°©.h
>

32 
	~<uni°d.h
>

33 
	~<f˙é.h
>

34 
	~<dúít.h
>

35 
	~<î∫o.h
>

36 
	~<sys/sysma¸os.h
>

38 
	~"cutûs.h
"

39 
	~"fs_utûs.h
"

41 
	$¥öt_°r
(
FILE
 *
f
, c⁄° *
°r
)

43 c⁄° *
s
;

44 
c
;

45 
s
 = 
°r
;

46 *
s
 != '\0') {

47 i‡(*
s
 <= ' ' || *s > '~')

48 
u£_quŸe
;

49 
s
++;

51 
	`Âuts
(
°r
, 
f
);

53 
u£_quŸe
:

54 
s
 = 
°r
;

55 
	`Âutc
('"', 
f
);

56 *
s
 != '\0') {

57 
c
 = *(
uöt8_t
 *)
s
;

58 i‡(
c
 < ' ' || c == 127) {

59 
	`Ârötf
(
f
, "\\x%02x", 
c
);

60 } i‡(
c
 == '\\' || c == '\"') {

61 
	`Ârötf
(
f
, "\\%c", 
c
);

63 
	`Âutc
(
c
, 
f
);

65 
s
++;

67 
	`Âutc
('"', 
f
);

68 
	}
}

70 
	#COPY_BUF_LEN
 (1024 * 1024)

	)

72 
	$c›y_fûe
(c⁄° *
§c_fûíame
, c⁄° *
d°_fûíame
)

74 
uöt8_t
 *
buf
;

75 
FILE
 *
fi
, *
fo
;

76 
Àn
;

78 
buf
 = 
	`mÆloc
(
COPY_BUF_LEN
);

79 
fi
 = 
	`f›í
(
§c_fûíame
, "rb");

80 i‡(!
fi
) {

81 
	`≥º‹
(
§c_fûíame
);

82 
	`exô
(1);

84 
fo
 = 
	`f›í
(
d°_fûíame
, "wb");

85 i‡(!
fo
) {

86 
	`≥º‹
(
d°_fûíame
);

87 
	`exô
(1);

90 
Àn
 = 
	`‰ód
(
buf
, 1, 
COPY_BUF_LEN
, 
fi
);

91 i‡(
Àn
 == 0)

93 
	`fwrôe
(
buf
, 1, 
Àn
, 
fo
);

95 
	`f˛o£
(
fo
);

96 
	`f˛o£
(
fi
);

97 
	}
}

100 *
	mfûes_∑th
;

101 
uöt64_t
 
	m√xt_öode_num
;

102 
uöt64_t
 
	mfs_size
;

103 
uöt64_t
 
	mfs_max_size
;

104 
FILE
 *
	mf
;

105 } 
	tSˇnSèã
;

107 
	$add_fûe_size
(
SˇnSèã
 *
s
, 
uöt64_t
 
size
)

109 
s
->
fs_size
 +
	`block_Æign
(
size
, 
FS_BLOCK_SIZE
);

110 i‡(
s
->
fs_size
 > s->
fs_max_size
) {

111 
	`Ârötf
(
°dîr
, "Fûesy°em QuŸ®ex˚eded (%" 
PRId64
 " byãs)\n", 
s
->
fs_max_size
);

112 
	`exô
(1);

114 
	}
}

116 
	$sˇn_dú
(
SˇnSèã
 *
s
, c⁄° *
∑th
)

118 
FILE
 *
f
 = 
s
->f;

119 
DIR
 *
dúp
;

120 
dúít
 *
de
;

121 c⁄° *
«me
;

122 
°©
 
°
;

123 *
∑th1
;

124 
uöt32_t
 
mode
, 
v
;

126 
dúp
 = 
	`›ídú
(
∑th
);

127 i‡(!
dúp
) {

128 
	`≥º‹
(
∑th
);

129 
	`exô
(1);

132 
de
 = 
	`ªaddú
(
dúp
);

133 i‡(!
de
)

135 
«me
 = 
de
->
d_«me
;

136 i‡(!
	`°rcmp
(
«me
, ".") || !strcmp(name, ".."))

138 
∑th1
 = 
	`compo£_∑th
(
∑th
, 
«me
);

139 i‡(
	`l°©
(
∑th1
, &
°
) < 0) {

140 
	`≥º‹
(
∑th1
);

141 
	`exô
(1);

144 
mode
 = 
°
.
°_mode
 & 0xffff;

145 
	`Ârötf
(
f
, "%06o %u %u",

146 
mode
,

147 ()
°
.
°_uid
,

148 ()
°
.
°_gid
);

149 i‡(
	`S_ISCHR
(
mode
Ë|| 
	`S_ISBLK
(mode)) {

150 
	`Ârötf
(
f
, " %u %u",

151 ()
	`maj‹
(
°
.
°_rdev
),

152 ()
	`mö‹
(
°
.
°_rdev
));

154 i‡(
	`S_ISREG
(
mode
)) {

155 
	`Ârötf
(
f
, " %" 
PRIu64
, 
°
.
°_size
);

158 
	`Ârötf
(
f
, " %u", ()
°
.
°_mtim
.
tv_£c
);

159 
v
 = 
°
.
°_mtim
.
tv_n£c
;

160 i‡(
v
 != 0) {

161 
	`Ârötf
(
f
, ".");

162 
v
 != 0) {

163 
	`Ârötf
(
f
, "%u", 
v
 / 100000000);

164 
v
 = (v % 100000000) * 10;

168 
	`Ârötf
(
f
, " ");

169 
	`¥öt_°r
(
f
, 
«me
);

170 i‡(
	`S_ISLNK
(
mode
)) {

171 
buf
[1024];

172 
Àn
;

173 
Àn
 = 
	`ªadlök
(
∑th1
, 
buf
, (buf) - 1);

174 i‡(
Àn
 < 0) {

175 
	`≥º‹
("readlink");

176 
	`exô
(1);

178 
buf
[
Àn
] = '\0';

179 
	`Ârötf
(
f
, " ");

180 
	`¥öt_°r
(
f
, 
buf
);

181 } i‡(
	`S_ISREG
(
mode
Ë&& 
°
.
°_size
 > 0) {

182 
buf1
[
FILEID_SIZE_MAX
], *
‚ame
;

183 
FSFûeID
 
fûe_id
;

184 
fûe_id
 = 
s
->
√xt_öode_num
++;

185 
	`Ârötf
(
f
, " %" 
PRIx64
, 
fûe_id
);

186 
	`fûe_id_to_fûíame
(
buf1
, 
fûe_id
);

187 
‚ame
 = 
	`compo£_∑th
(
s
->
fûes_∑th
, 
buf1
);

188 
	`c›y_fûe
(
∑th1
, 
‚ame
);

189 
	`add_fûe_size
(
s
, 
°
.
°_size
);

192 
	`Ârötf
(
f
, "\n");

193 i‡(
	`S_ISDIR
(
mode
)) {

194 
	`sˇn_dú
(
s
, 
∑th1
);

196 
	`‰ì
(
∑th1
);

199 
	`˛o£dú
(
dúp
);

200 
	`Ârötf
(
f
, ".\n");

201 
	}
}

203 
	$hñp
()

205 
	`¥ötf
("usage: build_filelist [options] source_path dest_path\n"

209 
	`exô
(1);

210 
	}
}

212 
	#LOCK_FILENAME
 "lock"

	)

214 
	$maö
(
¨gc
, **
¨gv
)

216 c⁄° *
d°_∑th
, *
§c_∑th
;

217 
SˇnSèã
 
s_s
, *
s
 = &s_s;

218 
FILE
 *
f
;

219 *
fûíame
;

220 
FSFûeID
 
roŸ_id
;

221 
‚ame
[
FILEID_SIZE_MAX
];

222 
°©
 
°
;

223 
uöt64_t
 
fú°_öode
, 
fs_max_size
;

224 
c
;

226 
fú°_öode
 = 1;

227 
fs_max_size
 = (
uöt64_t
)1 << 30;

229 
c
 = 
	`gë›t
(
¨gc
, 
¨gv
, "hi:m:");

230 i‡(
c
 == -1)

232 
c
) {

234 
	`hñp
();

236 
fú°_öode
 = 
	`°πoul
(
›èrg
, 
NULL
, 0);

239 
fs_max_size
 = (
uöt64_t
)
	`°πoul
(
›èrg
, 
NULL
, 0) << 20;

242 
	`exô
(1);

246 i‡(
›töd
 + 1 >
¨gc
)

247 
	`hñp
();

248 
§c_∑th
 = 
¨gv
[
›töd
];

249 
d°_∑th
 = 
¨gv
[
›töd
 + 1];

251 
	`mkdú
(
d°_∑th
, 0755);

253 
s
->
fûes_∑th
 = 
	`compo£_∑th
(
d°_∑th
, 
ROOT_FILENAME
);

254 
s
->
√xt_öode_num
 = 
fú°_öode
;

255 
s
->
fs_size
 = 0;

256 
s
->
fs_max_size
 = fs_max_size;

258 
	`mkdú
(
s
->
fûes_∑th
, 0755);

260 
roŸ_id
 = 
s
->
√xt_öode_num
++;

261 
	`fûe_id_to_fûíame
(
‚ame
, 
roŸ_id
);

262 
fûíame
 = 
	`compo£_∑th
(
s
->
fûes_∑th
, 
‚ame
);

263 
f
 = 
	`f›í
(
fûíame
, "wb");

264 i‡(!
f
) {

265 
	`≥º‹
(
fûíame
);

266 
	`exô
(1);

268 
	`Ârötf
(
f
, "Version: 1\n");

269 
	`Ârötf
(
f
, "Revision: 1\n");

270 
	`Ârötf
(
f
, "\n");

271 
s
->
f
 = f;

272 
	`sˇn_dú
(
s
, 
§c_∑th
);

273 
	`f˛o£
(
f
);

276 i‡(
	`°©
(
fûíame
, &
°
) < 0) {

277 
	`≥º‹
(
fûíame
);

278 
	`exô
(1);

280 
	`add_fûe_size
(
s
, 
°
.
°_size
);

282 
	`‰ì
(
fûíame
);

284 
fûíame
 = 
	`compo£_∑th
(
d°_∑th
, 
HEAD_FILENAME
);

285 
f
 = 
	`f›í
(
fûíame
, "wb");

286 i‡(!
f
) {

287 
	`≥º‹
(
fûíame
);

288 
	`exô
(1);

290 
	`Ârötf
(
f
, "Version: 1\n");

291 
	`Ârötf
(
f
, "Revision: 1\n");

292 
	`Ârötf
(
f
, "NextFûeID: %" 
PRIx64
 "\n", 
s
->
√xt_öode_num
);

293 
	`Ârötf
(
f
, "FSFûeCou¡: %" 
PRIu64
 "\n", 
s
->
√xt_öode_num
 - 1);

294 
	`Ârötf
(
f
, "FSSize: %" 
PRIu64
 "\n", 
s
->
fs_size
);

295 
	`Ârötf
(
f
, "FSMaxSize: %" 
PRIu64
 "\n", 
s
->
fs_max_size
);

296 
	`Ârötf
(
f
, "Key:\n");

297 
	`Ârötf
(
f
, "RoŸID: %" 
PRIx64
 "\n", 
roŸ_id
);

298 
	`f˛o£
(
f
);

299 
	`‰ì
(
fûíame
);

301 
fûíame
 = 
	`compo£_∑th
(
d°_∑th
, 
LOCK_FILENAME
);

302 
f
 = 
	`f›í
(
fûíame
, "wb");

303 i‡(!
f
) {

304 
	`≥º‹
(
fûíame
);

305 
	`exô
(1);

307 
	`f˛o£
(
f
);

308 
	`‰ì
(
fûíame
);

311 
	}
}

	@cutils.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

30 
	~<sys/time.h
>

31 
	~<˘y≥.h
>

33 
	~"cutûs.h
"

35 *
	$mÆlocz
(
size_t
 
size
)

37 *
±r
;

38 
±r
 = 
	`mÆloc
(
size
);

39 i‡(!
±r
)

40  
NULL
;

41 
	`mem£t
(
±r
, 0, 
size
);

42  
±r
;

43 
	}
}

45 
	$p°r˝y
(*
buf
, 
buf_size
, c⁄° *
°r
)

47 
c
;

48 *
q
 = 
buf
;

50 i‡(
buf_size
 <= 0)

54 
c
 = *
°r
++;

55 i‡(
c
 =0 || 
q
 >
buf
 + 
buf_size
 - 1)

57 *
q
++ = 
c
;

59 *
q
 = '\0';

60 
	}
}

62 *
	$p°rˇt
(*
buf
, 
buf_size
, c⁄° *
s
)

64 
Àn
;

65 
Àn
 = 
	`°æí
(
buf
);

66 i‡(
Àn
 < 
buf_size
)

67 
	`p°r˝y
(
buf
 + 
Àn
, 
buf_size
 -Üí, 
s
);

68  
buf
;

69 
	}
}

71 
	$°r°¨t
(c⁄° *
°r
, c⁄° *
vÆ
, c⁄° **
±r
)

73 c⁄° *
p
, *
q
;

74 
p
 = 
°r
;

75 
q
 = 
vÆ
;

76 *
q
 != '\0') {

77 i‡(*
p
 !*
q
)

79 
p
++;

80 
q
++;

82 i‡(
±r
)

83 *
±r
 = 
p
;

85 
	}
}

87 
	$dbuf_öô
(
DynBuf
 *
s
)

89 
	`mem£t
(
s
, 0, (*s));

90 
	}
}

92 
	$dbuf_wrôe
(
DynBuf
 *
s
, 
size_t
 
off£t
, c⁄° 
uöt8_t
 *
d©a
, size_à
Àn
)

94 
size_t
 
íd
, 
√w_size
;

95 
√w_size
 = 
íd
 = 
off£t
 + 
Àn
;

96 i‡(
√w_size
 > 
s
->
Æloˇãd_size
) {

97 
√w_size
 = 
	`max_öt
“ew_size, 
s
->
Æloˇãd_size
 * 3 / 2);

98 
s
->
buf
 = 
	`ªÆloc
(s->buf, 
√w_size
);

99 
s
->
Æloˇãd_size
 = 
√w_size
;

101 
	`mem˝y
(
s
->
buf
 + 
off£t
, 
d©a
, 
Àn
);

102 i‡(
íd
 > 
s
->
size
)

103 
s
->
size
 = 
íd
;

104 
	}
}

106 
	$dbuf_putc
(
DynBuf
 *
s
, 
uöt8_t
 
c
)

108 
	`dbuf_wrôe
(
s
, s->
size
, &
c
, 1);

109 
	}
}

111 
	$dbuf_put°r
(
DynBuf
 *
s
, c⁄° *
°r
)

113 
	`dbuf_wrôe
(
s
, s->
size
, (c⁄° 
uöt8_t
 *)
°r
, 
	`°æí
(str));

114 
	}
}

116 
	$dbuf_‰ì
(
DynBuf
 *
s
)

118 
	`‰ì
(
s
->
buf
);

119 
	`mem£t
(
s
, 0, (*s));

120 
	}
}

	@cutils.h

24 #i‚de‡
CUTILS_H


25 
	#CUTILS_H


	)

27 
	~<öây≥s.h
>

29 
	#likñy
(
x
Ë
	`__buûtö_ex≥˘
(!!(x), 1)

	)

30 
	#u∆ikñy
(
x
Ë
	`__buûtö_ex≥˘
(!!(x), 0)

	)

31 
	#f‹˚_ölöe
 
ölöe
 
	`__©åibuã__
((
Æways_ölöe
))

	)

32 
	#no_ölöe
 
	`__©åibuã__
((
noölöe
))

	)

33 
	#__maybe_unu£d
 
	`__©åibuã__
((
unu£d
))

	)

35 
	#xglue
(
x
, 
y
Ëx ## 
	)
y

36 
	#glue
(
x
, 
y
Ë
	`xglue
(x, y)

	)

37 
	#°rögify
(
s
Ë
	`to°rög
(s)

	)

38 
	#to°rög
(
s
Ë#s

	)

40 #i‚de‡
off£tof


41 
	#off£tof
(
ty≥
, 
fõld
Ë((
size_t
Ë&(—y≥ *)0)->fõld)

	)

43 
	#cou¡of
(
x
Ë((xË/ (x[0]))

	)

45 
	#DLL_PUBLIC
 
	`__©åibuã__
 ((
	`visibûôy
 ("deÁu…")))

	)

47 #i‚de‡
_BOOL_deföed


48 
	#_BOOL_deföed


	)

49 #unde‡
FALSE


50 #unde‡
TRUE


52 
	tBOOL
;

54 
	mFALSE
 = 0,

55 
	mTRUE
 = 1,

60 #i‡
deföed
(
__SIZEOF_INT128__
)

61 
	#HAVE_INT128


	)

64 #ifde‡
HAVE_INT128


65 
__öt128
 
	töt128_t
;

66 
	t__öt128
 
	tuöt128_t
;

69 
ölöe
 
	$max_öt
(
a
, 
b
)

71 i‡(
a
 > 
b
)

72  
a
;

74  
b
;

75 
	}
}

77 
ölöe
 
	$mö_öt
(
a
, 
b
)

79 i‡(
a
 < 
b
)

80  
a
;

82  
b
;

83 
	}
}

85 *
mÆlocz
(
size_t
 
size
);

87 #i‡
deföed
(
_WIN32
)

88 
ölöe
 
uöt32_t
 
	$bsw≠_32
(
uöt32_t
 
v
)

90  ((
v
 & 0xff000000) >> 24) | ((v & 0x00ff0000) >> 8) |

91 ((
v
 & 0x0000ff00) << 8) | ((v & 0x000000ff) << 24);

92 
	}
}

94 
	~<byãsw≠.h
>

97 
ölöe
 
uöt16_t
 
	$gë_À16
(c⁄° 
uöt8_t
 *
±r
)

99  
±r
[0] | (ptr[1] << 8);

100 
	}
}

102 
ölöe
 
uöt32_t
 
	$gë_À32
(c⁄° 
uöt8_t
 *
±r
)

104  
±r
[0] | (ptr[1] << 8) | (ptr[2] << 16) | (ptr[3] << 24);

105 
	}
}

107 
ölöe
 
uöt64_t
 
	$gë_À64
(c⁄° 
uöt8_t
 *
±r
)

109  
	`gë_À32
(
±r
Ë| ((
uöt64_t
)get_le32(ptr + 4) << 32);

110 
	}
}

112 
ölöe
 
	$put_À16
(
uöt8_t
 *
±r
, 
uöt16_t
 
v
)

114 
±r
[0] = 
v
;

115 
±r
[1] = 
v
 >> 8;

116 
	}
}

118 
ölöe
 
	$put_À32
(
uöt8_t
 *
±r
, 
uöt32_t
 
v
)

120 
±r
[0] = 
v
;

121 
±r
[1] = 
v
 >> 8;

122 
±r
[2] = 
v
 >> 16;

123 
±r
[3] = 
v
 >> 24;

124 
	}
}

126 
ölöe
 
	$put_À64
(
uöt8_t
 *
±r
, 
uöt64_t
 
v
)

128 
	`put_À32
(
±r
, 
v
);

129 
	`put_À32
(
±r
 + 4, 
v
 >> 32);

130 
	}
}

132 
ölöe
 
uöt32_t
 
	$gë_be32
(c⁄° 
uöt8_t
 *
d
)

134  (
d
[0] << 24) | (d[1] << 16) | (d[2] << 8) | d[3];

135 
	}
}

137 
ölöe
 
	$put_be32
(
uöt8_t
 *
d
, 
uöt32_t
 
v
)

139 
d
[0] = 
v
 >> 24;

140 
d
[1] = 
v
 >> 16;

141 
d
[2] = 
v
 >> 8;

142 
d
[3] = 
v
 >> 0;

143 
	}
}

145 
ölöe
 
	$put_be64
(
uöt8_t
 *
d
, 
uöt64_t
 
v
)

147 
	`put_be32
(
d
, 
v
 >> 32);

148 
	`put_be32
(
d
 + 4, 
v
);

149 
	}
}

151 #ifde‡
WORDS_BIGENDIAN


152 
ölöe
 
uöt32_t
 
	$˝u_to_be32
(
uöt32_t
 
v
)

154  
v
;

155 
	}
}

157 
ölöe
 
uöt32_t
 
	$˝u_to_be32
(
uöt32_t
 
v
)

159  
	`bsw≠_32
(
v
);

160 
	}
}

164 
ölöe
 
	$˘z32
(
uöt32_t
 
a
)

166 
i
;

167 i‡(
a
 == 0)

169 
i
 = 0; i < 32; i++) {

170 i‡((
a
 >> 
i
) & 1)

171  
i
;

174 
	}
}

177 *
mÆlocz
(
size_t
 
size
);

178 
p°r˝y
(*
buf
, 
buf_size
, c⁄° *
°r
);

179 *
p°rˇt
(*
buf
, 
buf_size
, c⁄° *
s
);

180 
°r°¨t
(c⁄° *
°r
, c⁄° *
vÆ
, c⁄° **
±r
);

183 
uöt8_t
 *
	mbuf
;

184 
size_t
 
	msize
;

185 
size_t
 
	mÆloˇãd_size
;

186 } 
	tDynBuf
;

188 
dbuf_öô
(
DynBuf
 *
s
);

189 
dbuf_wrôe
(
DynBuf
 *
s
, 
size_t
 
off£t
, c⁄° 
uöt8_t
 *
d©a
, size_à
Àn
);

190 
dbuf_putc
(
DynBuf
 *
s
, 
uöt8_t
 
c
);

191 
dbuf_put°r
(
DynBuf
 *
s
, c⁄° *
°r
);

192 
dbuf_‰ì
(
DynBuf
 *
s
);

	@fbuf.h

1 #i‚de‡
FBUF_H


2 
	#FBUF_H


	)

5 #i‡
deföed
(
EMSCRIPTEN
)

6 
	mh™dÀ
;

8 
uöt8_t
 *
	md©a
;

10 
size_t
 
	mÆloˇãd_size
;

11 } 
	tFûeBuf„r
;

13 
fûe_buf„r_öô
(
FûeBuf„r
 *
bs
);

14 
fûe_buf„r_ª£t
(
FûeBuf„r
 *
bs
);

15 
fûe_buf„r_ªsize
(
FûeBuf„r
 *
bs
, 
size_t
 
√w_size
);

16 
fûe_buf„r_wrôe
(
FûeBuf„r
 *
bs
, 
size_t
 
off£t
, c⁄° 
uöt8_t
 *
buf
,

17 
size_t
 
size
);

18 
fûe_buf„r_£t
(
FûeBuf„r
 *
bs
, 
size_t
 
off£t
, 
vÆ
, size_à
size
);

19 
fûe_buf„r_ªad
(
FûeBuf„r
 *
bs
, 
size_t
 
off£t
, 
uöt8_t
 *
buf
,

20 
size_t
 
size
);

	@fs.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

31 
	~"cutûs.h
"

32 
	~"fs.h
"

34 
FSFûe
 *
	$fs_dup
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
)

36 
FSQID
 
qid
;

37 
fs
->
	`fs_wÆk
(fs, &
f
, &
qid
, f, 0, 
NULL
);

38  
f
;

39 
	}
}

41 
FSFûe
 *
	$fs_wÆk_∑th1
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
∑th
,

42 **
≤ame
)

44 c⁄° *
p
;

45 *
«me
;

46 
FSFûe
 *
f1
;

47 
FSQID
 
qid
;

48 
Àn
, 
ªt
;

49 
BOOL
 
is_œ°
, 
is_fú°
;

51 i‡(
∑th
[0] == '/')

52 
∑th
++;

54 
is_fú°
 = 
TRUE
;

56 
p
 = 
	`°rchr
(
∑th
, '/');

57 i‡(!
p
) {

58 
«me
 = (*)
∑th
;

59 i‡(
≤ame
) {

60 *
≤ame
 = 
«me
;

61 i‡(
is_fú°
) {

62 
ªt
 = 
fs
->
	`fs_wÆk
(fs, &
f
, &
qid
, f, 0, 
NULL
);

63 i‡(
ªt
 < 0)

64 
f
 = 
NULL
;

66  
f
;

68 
is_œ°
 = 
TRUE
;

70 
Àn
 = 
p
 - 
∑th
;

71 
«me
 = 
	`mÆloc
(
Àn
 + 1);

72 
	`mem˝y
(
«me
, 
∑th
, 
Àn
);

73 
«me
[
Àn
] = '\0';

74 
is_œ°
 = 
FALSE
;

76 
ªt
 = 
fs
->
	`fs_wÆk
(fs, &
f1
, &
qid
, 
f
, 1, &
«me
);

77 i‡(!
is_œ°
)

78 
	`‰ì
(
«me
);

79 i‡(!
is_fú°
)

80 
fs
->
	`fs_dñëe
(fs, 
f
);

81 
f
 = 
f1
;

82 
is_fú°
 = 
FALSE
;

83 i‡(
ªt
 <= 0) {

84 
fs
->
	`fs_dñëe
(fs, 
f
);

85 
f
 = 
NULL
;

87 } i‡(
is_œ°
) {

90 
∑th
 = 
p
 + 1;

92  
f
;

93 
	}
}

95 
FSFûe
 *
	$fs_wÆk_∑th
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
∑th
)

97  
	`fs_wÆk_∑th1
(
fs
, 
f
, 
∑th
, 
NULL
);

98 
	}
}

100 
	$fs_íd
(
FSDevi˚
 *
fs
)

102 
fs
->
	`fs_íd
(fs);

103 
	`‰ì
(
fs
);

104 
	}
}

	@fs.h

26 
	#P9_QTDIR
 0x80

	)

27 
	#P9_QTAPPEND
 0x40

	)

28 
	#P9_QTEXCL
 0x20

	)

29 
	#P9_QTMOUNT
 0x10

	)

30 
	#P9_QTAUTH
 0x08

	)

31 
	#P9_QTTMP
 0x04

	)

32 
	#P9_QTSYMLINK
 0x02

	)

33 
	#P9_QTLINK
 0x01

	)

34 
	#P9_QTFILE
 0x00

	)

37 
	#P9_S_IRWXUGO
 0x01FF

	)

38 
	#P9_S_ISVTX
 0x0200

	)

39 
	#P9_S_ISGID
 0x0400

	)

40 
	#P9_S_ISUID
 0x0800

	)

42 
	#P9_S_IFMT
 0xF000

	)

43 
	#P9_S_IFIFO
 0x1000

	)

44 
	#P9_S_IFCHR
 0x2000

	)

45 
	#P9_S_IFDIR
 0x4000

	)

46 
	#P9_S_IFBLK
 0x6000

	)

47 
	#P9_S_IFREG
 0x8000

	)

48 
	#P9_S_IFLNK
 0xA000

	)

49 
	#P9_S_IFSOCK
 0xC000

	)

52 
	#P9_O_RDONLY
 0x00000000

	)

53 
	#P9_O_WRONLY
 0x00000001

	)

54 
	#P9_O_RDWR
 0x00000002

	)

55 
	#P9_O_NOACCESS
 0x00000003

	)

56 
	#P9_O_CREAT
 0x00000040

	)

57 
	#P9_O_EXCL
 0x00000080

	)

58 
	#P9_O_NOCTTY
 0x00000100

	)

59 
	#P9_O_TRUNC
 0x00000200

	)

60 
	#P9_O_APPEND
 0x00000400

	)

61 
	#P9_O_NONBLOCK
 0x00000800

	)

62 
	#P9_O_DSYNC
 0x00001000

	)

63 
	#P9_O_FASYNC
 0x00002000

	)

64 
	#P9_O_DIRECT
 0x00004000

	)

65 
	#P9_O_LARGEFILE
 0x00008000

	)

66 
	#P9_O_DIRECTORY
 0x00010000

	)

67 
	#P9_O_NOFOLLOW
 0x00020000

	)

68 
	#P9_O_NOATIME
 0x00040000

	)

69 
	#P9_O_CLOEXEC
 0x00080000

	)

70 
	#P9_O_SYNC
 0x00100000

	)

73 
	#P9_SETATTR_MODE
 0x00000001

	)

74 
	#P9_SETATTR_UID
 0x00000002

	)

75 
	#P9_SETATTR_GID
 0x00000004

	)

76 
	#P9_SETATTR_SIZE
 0x00000008

	)

77 
	#P9_SETATTR_ATIME
 0x00000010

	)

78 
	#P9_SETATTR_MTIME
 0x00000020

	)

79 
	#P9_SETATTR_CTIME
 0x00000040

	)

80 
	#P9_SETATTR_ATIME_SET
 0x00000080

	)

81 
	#P9_SETATTR_MTIME_SET
 0x00000100

	)

83 
	#P9_EPERM
 1

	)

84 
	#P9_ENOENT
 2

	)

85 
	#P9_EIO
 5

	)

86 
	#P9_EEXIST
 17

	)

87 
	#P9_ENOTDIR
 20

	)

88 
	#P9_EINVAL
 22

	)

89 
	#P9_ENOSPC
 28

	)

90 
	#P9_ENOTEMPTY
 39

	)

91 
	#P9_EPROTO
 71

	)

92 
	#P9_ENOTSUP
 524

	)

94 
FSDevi˚
 
	tFSDevi˚
;

95 
FSFûe
 
	tFSFûe
;

98 
uöt32_t
 
	mf_bsize
;

99 
uöt64_t
 
	mf_blocks
;

100 
uöt64_t
 
	mf_b‰ì
;

101 
uöt64_t
 
	mf_bavaû
;

102 
uöt64_t
 
	mf_fûes
;

103 
uöt64_t
 
	mf_f‰ì
;

104 } 
	tFSSètFS
;

107 
uöt8_t
 
	mty≥
;

108 
uöt32_t
 
	mvîsi⁄
;

109 
uöt64_t
 
	m∑th
;

110 } 
	tFSQID
;

113 
FSQID
 
	mqid
;

114 
uöt32_t
 
	m°_mode
;

115 
uöt32_t
 
	m°_uid
;

116 
uöt32_t
 
	m°_gid
;

117 
uöt64_t
 
	m°_∆ök
;

118 
uöt64_t
 
	m°_rdev
;

119 
uöt64_t
 
	m°_size
;

120 
uöt64_t
 
	m°_blksize
;

121 
uöt64_t
 
	m°_blocks
;

122 
uöt64_t
 
	m°_©ime_£c
;

123 
uöt32_t
 
	m°_©ime_n£c
;

124 
uöt64_t
 
	m°_mtime_£c
;

125 
uöt32_t
 
	m°_mtime_n£c
;

126 
uöt64_t
 
	m°_˘ime_£c
;

127 
uöt32_t
 
	m°_˘ime_n£c
;

128 } 
	tFSSèt
;

130 
	#P9_LOCK_TYPE_RDLCK
 0

	)

131 
	#P9_LOCK_TYPE_WRLCK
 1

	)

132 
	#P9_LOCK_TYPE_UNLCK
 2

	)

134 
	#P9_LOCK_FLAGS_BLOCK
 1

	)

135 
	#P9_LOCK_FLAGS_RECLAIM
 2

	)

137 
	#P9_LOCK_SUCCESS
 0

	)

138 
	#P9_LOCK_BLOCKED
 1

	)

139 
	#P9_LOCK_ERROR
 2

	)

140 
	#P9_LOCK_GRACE
 3

	)

142 
	#FSCMD_NAME
 ".fscmd"

	)

145 
uöt8_t
 
	mty≥
;

146 
uöt32_t
 
	mÊags
;

147 
uöt64_t
 
	m°¨t
;

148 
uöt64_t
 
	mÀngth
;

149 
uöt32_t
 
	m¥oc_id
;

150 *
	m˛õ¡_id
;

151 } 
	tFSLock
;

153 
	tFSO≥nCom∂ëi⁄Func
(
	tFSDevi˚
 *
	tfs
, 
	tFSQID
 *
	tqid
, 
	tîr
,

154 *
	t›aque
);

156 
	sFSDevi˚
 {

157 (*
	mfs_íd
)(
FSDevi˚
 *
	ms
);

158 (*
	mfs_dñëe
)(
FSDevi˚
 *
	ms
, 
FSFûe
 *
	mf
);

159 (*
	mfs_°©fs
)(
FSDevi˚
 *
	mfs
, 
FSSètFS
 *
	m°
);

160 (*
	mfs_©èch
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 **
	mpf
, 
FSQID
 *
	mqid
, 
uöt32_t
 
	muid
,

161 c⁄° *
	mu«me
, c⁄° *
	m™ame
);

162 (*
	mfs_wÆk
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 **
	mpf
, 
FSQID
 *
	mqids
,

163 
FSFûe
 *
	mf
, 
	mn
, **
	m«mes
);

164 (*
	mfs_mkdú
)(
FSDevi˚
 *
	mfs
, 
FSQID
 *
	mqid
, 
FSFûe
 *
	mf
,

165 c⁄° *
	m«me
, 
uöt32_t
 
	mmode
, uöt32_à
	mgid
);

166 (*
	mfs_›í
)(
FSDevi˚
 *
	mfs
, 
FSQID
 *
	mqid
, 
FSFûe
 *
	mf
, 
uöt32_t
 
	mÊags
,

167 
FSO≥nCom∂ëi⁄Func
 *
	mcb
, *
	m›aque
);

168 (*
	mfs_¸óã
)(
FSDevi˚
 *
	mfs
, 
FSQID
 *
	mqid
, 
FSFûe
 *
	mf
, c⁄° *
	m«me
,

169 
uöt32_t
 
	mÊags
, uöt32_à
	mmode
, uöt32_à
	mgid
);

170 (*
	mfs_°©
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, 
FSSèt
 *
	m°
);

171 (*
	mfs_£èâr
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, 
uöt32_t
 
	mmask
,

172 
uöt32_t
 
	mmode
, uöt32_à
	muid
, uöt32_à
	mgid
,

173 
uöt64_t
 
	msize
, uöt64_à
	m©ime_£c
, uöt64_à
	m©ime_n£c
,

174 
uöt64_t
 
	mmtime_£c
, uöt64_à
	mmtime_n£c
);

175 (*
	mfs_˛o£
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
);

176 (*
	mfs_ªaddú
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, 
uöt64_t
 
	moff£t
,

177 
uöt8_t
 *
	mbuf
, 
	mcou¡
);

178 (*
	mfs_ªad
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, 
uöt64_t
 
	moff£t
,

179 
uöt8_t
 *
	mbuf
, 
	mcou¡
);

180 (*
	mfs_wrôe
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, 
uöt64_t
 
	moff£t
,

181 c⁄° 
uöt8_t
 *
	mbuf
, 
	mcou¡
);

182 (*
	mfs_lök
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mdf
, FSFûê*
	mf
, c⁄° *
	m«me
);

183 (*
	mfs_symlök
)(
FSDevi˚
 *
	mfs
, 
FSQID
 *
	mqid
,

184 
FSFûe
 *
	mf
, c⁄° *
	m«me
, c⁄° *
	msymgt
, 
uöt32_t
 
	mgid
);

185 (*
	mfs_mknod
)(
FSDevi˚
 *
	mfs
, 
FSQID
 *
	mqid
,

186 
FSFûe
 *
	mf
, c⁄° *
	m«me
, 
uöt32_t
 
	mmode
, uöt32_à
	mmaj‹
,

187 
uöt32_t
 
	mmö‹
, uöt32_à
	mgid
);

188 (*
	mfs_ªadlök
)(
FSDevi˚
 *
	mfs
, *
	mbuf
, 
	mbuf_size
, 
FSFûe
 *
	mf
);

189 (*
	mfs_ª«mót
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, c⁄° *
	m«me
,

190 
FSFûe
 *
	m√w_f
, c⁄° *
	m√w_«me
);

191 (*
	mfs_u∆ök©
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, c⁄° *
	m«me
);

192 (*
	mfs_lock
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, c⁄° 
FSLock
 *
	mlock
);

193 (*
	mfs_gëlock
)(
FSDevi˚
 *
	mfs
, 
FSFûe
 *
	mf
, 
FSLock
 *
	mlock
);

196 
FSDevi˚
 *
fs_disk_öô
(c⁄° *
roŸ_∑th
);

197 
FSDevi˚
 *
fs_mem_öô
();

198 
FSDevi˚
 *
fs_√t_öô
(c⁄° *
uæ
, (*
°¨t
)(*
›aque
), *opaque);

199 
	`fs_√t_£t_pwd
(
FSDevi˚
 *
fs
, c⁄° *
pwd
);

200 #ifde‡
EMSCRIPTEN


201 
	`fs_imp‹t_fûe
(c⁄° *
fûíame
, 
uöt8_t
 *
buf
, 
buf_Àn
);

203 
	`fs_exp‹t_fûe
(c⁄° *
fûíame
,

204 c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
);

205 
	`fs_íd
(
FSDevi˚
 *
fs
);

206 
	`fs_dump_ˇche_lﬂd
(
FSDevi˚
 *
fs1
, c⁄° *
fûíame
);

208 
FSFûe
 *
	`fs_dup
(
FSDevi˚
 *
fs
, FSFûê*
f
);

209 
FSFûe
 *
	`fs_wÆk_∑th1
(
FSDevi˚
 *
fs
, FSFûê*
f
, c⁄° *
∑th
,

210 **
≤ame
);

211 
FSFûe
 *
	`fs_wÆk_∑th
(
FSDevi˚
 *
fs
, FSFûê*
f
, c⁄° *
∑th
);

	@fs_disk.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

30 
	~<sys/°©fs.h
>

31 
	~<sys/°©.h
>

32 
	~<sys/sysma¸os.h
>

33 
	~<uni°d.h
>

34 
	~<f˙é.h
>

35 
	~<dúít.h
>

36 
	~<î∫o.h
>

38 
	~"cutûs.h
"

39 
	~"li°.h
"

40 
	~"fs.h
"

43 
FSDevi˚
 
	mcomm⁄
;

44 *
	mroŸ_∑th
;

45 } 
	tFSDevi˚Disk
;

47 
fs_˛o£
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
);

49 
	sFSFûe
 {

50 
uöt32_t
 
	muid
;

51 *
	m∑th
;

52 
BOOL
 
	mis_›íed
;

53 
BOOL
 
	mis_dú
;

55 
	mfd
;

56 
DIR
 *
	mdúp
;

57 } 
	mu
;

60 
	$fs_dñëe
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
)

62 i‡(
f
->
is_›íed
)

63 
	`fs_˛o£
(
fs
, 
f
);

64 
	`‰ì
(
f
->
∑th
);

65 
	`‰ì
(
f
);

66 
	}
}

69 
FSFûe
 *
	$fid_¸óã
(
FSDevi˚
 *
s1
, *
∑th
, 
uöt32_t
 
uid
)

71 
FSFûe
 *
f
;

72 
f
 = 
	`mÆlocz
((*f));

73 
f
->
∑th
 =Öath;

74 
f
->
uid
 = uid;

75  
f
;

76 
	}
}

79 
	gî∫o_èbÀ
[][2] = {

80 { 
P9_EPERM
, 
EPERM
 },

81 { 
P9_ENOENT
, 
ENOENT
 },

82 { 
P9_EIO
, 
EIO
 },

83 { 
P9_EEXIST
, 
EEXIST
 },

84 { 
P9_EINVAL
, 
EINVAL
 },

85 { 
P9_ENOSPC
, 
ENOSPC
 },

86 { 
P9_ENOTEMPTY
, 
ENOTEMPTY
 },

87 { 
P9_EPROTO
, 
EPROTO
 },

88 { 
P9_ENOTSUP
, 
ENOTSUP
 },

91 
	$î∫o_to_p9
(
îr
)

93 
i
;

94 i‡(
îr
 == 0)

96 
i
 = 0; i < 
	`cou¡of
(
î∫o_èbÀ
); i++) {

97 i‡(
îr
 =
î∫o_èbÀ
[
i
][1])

98  
î∫o_èbÀ
[
i
][0];

100  
P9_EINVAL
;

101 
	}
}

103 
	g›í_Êags
[][2] = {

104 { 
P9_O_CREAT
, 
O_CREAT
 },

105 { 
P9_O_EXCL
, 
O_EXCL
 },

107 { 
P9_O_TRUNC
, 
O_TRUNC
 },

108 { 
P9_O_APPEND
, 
O_APPEND
 },

109 { 
P9_O_NONBLOCK
, 
O_NONBLOCK
 },

110 { 
P9_O_DSYNC
, 
O_DSYNC
 },

115 { 
P9_O_NOFOLLOW
, 
O_NOFOLLOW
 },

118 { 
P9_O_SYNC
, 
O_SYNC
 },

121 
	$p9_Êags_to_ho°
(
Êags
)

123 
ªt
, 
i
;

125 
ªt
 = (
Êags
 & 
P9_O_NOACCESS
);

126 
i
 = 0; i < 
	`cou¡of
(
›í_Êags
); i++) {

127 i‡(
Êags
 & 
›í_Êags
[
i
][0])

128 
ªt
 |
›í_Êags
[
i
][1];

130  
ªt
;

131 
	}
}

133 
	$°©_to_qid
(
FSQID
 *
qid
, c⁄° 
°©
 *
°
)

135 i‡(
	`S_ISDIR
(
°
->
°_mode
))

136 
qid
->
ty≥
 = 
P9_QTDIR
;

137 i‡(
	`S_ISLNK
(
°
->
°_mode
))

138 
qid
->
ty≥
 = 
P9_QTSYMLINK
;

140 
qid
->
ty≥
 = 
P9_QTFILE
;

141 
qid
->
vîsi⁄
 = 0;

142 
qid
->
∑th
 = 
°
->
°_öo
;

143 
	}
}

145 
	$fs_°©fs
(
FSDevi˚
 *
fs1
, 
FSSètFS
 *
°
)

147 
FSDevi˚Disk
 *
fs
 = (FSDevi˚Disk *)
fs1
;

148 
°©fs
 
°1
;

149 
	`°©fs
(
fs
->
roŸ_∑th
, &
°1
);

150 
°
->
f_bsize
 = 
°1
.f_bsize;

151 
°
->
f_blocks
 = 
°1
.f_blocks;

152 
°
->
f_b‰ì
 = 
°1
.f_bfree;

153 
°
->
f_bavaû
 = 
°1
.f_bavail;

154 
°
->
f_fûes
 = 
°1
.f_files;

155 
°
->
f_f‰ì
 = 
°1
.f_ffree;

156 
	}
}

158 *
	$compo£_∑th
(c⁄° *
∑th
, c⁄° *
«me
)

160 
∑th_Àn
, 
«me_Àn
;

161 *
d
;

163 
∑th_Àn
 = 
	`°æí
(
∑th
);

164 
«me_Àn
 = 
	`°æí
(
«me
);

165 
d
 = 
	`mÆloc
(
∑th_Àn
 + 1 + 
«me_Àn
 + 1);

166 
	`mem˝y
(
d
, 
∑th
, 
∑th_Àn
);

167 
d
[
∑th_Àn
] = '/';

168 
	`mem˝y
(
d
 + 
∑th_Àn
 + 1, 
«me
, 
«me_Àn
 + 1);

169  
d
;

170 
	}
}

172 
	$fs_©èch
(
FSDevi˚
 *
fs1
, 
FSFûe
 **
pf
,

173 
FSQID
 *
qid
, 
uöt32_t
 
uid
,

174 c⁄° *
u«me
, c⁄° *
™ame
)

176 
FSDevi˚Disk
 *
fs
 = (FSDevi˚Disk *)
fs1
;

177 
°©
 
°
;

178 
FSFûe
 *
f
;

180 i‡(
	`l°©
(
fs
->
roŸ_∑th
, &
°
) != 0) {

181 *
pf
 = 
NULL
;

182  -
	`î∫o_to_p9
(
î∫o
);

184 
f
 = 
	`fid_¸óã
(
fs1
, 
	`°rdup
(
fs
->
roŸ_∑th
), 
uid
);

185 
	`°©_to_qid
(
qid
, &
°
);

186 *
pf
 = 
f
;

188 
	}
}

190 
	$fs_wÆk
(
FSDevi˚
 *
fs
, 
FSFûe
 **
pf
, 
FSQID
 *
qids
,

191 
FSFûe
 *
f
, 
n
, **
«mes
)

193 *
∑th
, *
∑th1
;

194 
°©
 
°
;

195 
i
;

197 
∑th
 = 
	`°rdup
(
f
->path);

198 
i
 = 0; i < 
n
; i++) {

199 
∑th1
 = 
	`compo£_∑th
(
∑th
, 
«mes
[
i
]);

200 i‡(
	`l°©
(
∑th1
, &
°
) != 0) {

201 
	`‰ì
(
∑th1
);

204 
	`‰ì
(
∑th
);

205 
∑th
 = 
∑th1
;

206 
	`°©_to_qid
(&
qids
[
i
], &
°
);

208 *
pf
 = 
	`fid_¸óã
(
fs
, 
∑th
, 
f
->
uid
);

209  
i
;

210 
	}
}

213 
	$fs_mkdú
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
FSFûe
 *
f
,

214 c⁄° *
«me
, 
uöt32_t
 
mode
, uöt32_à
gid
)

216 *
∑th
;

217 
°©
 
°
;

219 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
«me
);

220 i‡(
	`mkdú
(
∑th
, 
mode
) < 0) {

221 
	`‰ì
(
∑th
);

222  -
	`î∫o_to_p9
(
î∫o
);

224 i‡(
	`l°©
(
∑th
, &
°
) != 0) {

225 
	`‰ì
(
∑th
);

226  -
	`î∫o_to_p9
(
î∫o
);

228 
	`‰ì
(
∑th
);

229 
	`°©_to_qid
(
qid
, &
°
);

231 
	}
}

233 
	$fs_›í
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
FSFûe
 *
f
, 
uöt32_t
 
Êags
,

234 
FSO≥nCom∂ëi⁄Func
 *
cb
, *
›aque
)

236 
°©
 
°
;

237 
	`fs_˛o£
(
fs
, 
f
);

239 i‡(
	`°©
(
f
->
∑th
, &
°
) != 0)

240  -
	`î∫o_to_p9
(
î∫o
);

241 
	`°©_to_qid
(
qid
, &
°
);

243 i‡(
Êags
 & 
P9_O_DIRECTORY
) {

244 
DIR
 *
dúp
;

245 
dúp
 = 
	`›ídú
(
f
->
∑th
);

246 i‡(!
dúp
)

247  -
	`î∫o_to_p9
(
î∫o
);

248 
f
->
is_›íed
 = 
TRUE
;

249 
f
->
is_dú
 = 
TRUE
;

250 
f
->
u
.
dúp
 = dirp;

252 
fd
;

253 
fd
 = 
	`›í
(
f
->
∑th
, 
	`p9_Êags_to_ho°
(
Êags
Ë& ~
O_CREAT
);

254 i‡(
fd
 < 0)

255  -
	`î∫o_to_p9
(
î∫o
);

256 
f
->
is_›íed
 = 
TRUE
;

257 
f
->
is_dú
 = 
FALSE
;

258 
f
->
u
.
fd
 = fd;

261 
	}
}

263 
	$fs_¸óã
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
FSFûe
 *
f
, c⁄° *
«me
,

264 
uöt32_t
 
Êags
, uöt32_à
mode
, uöt32_à
gid
)

266 
°©
 
°
;

267 *
∑th
;

268 
ªt
, 
fd
;

270 
	`fs_˛o£
(
fs
, 
f
);

272 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
«me
);

273 
fd
 = 
	`›í
(
∑th
, 
	`p9_Êags_to_ho°
(
Êags
Ë| 
O_CREAT
, 
mode
);

274 i‡(
fd
 < 0) {

275 
	`‰ì
(
∑th
);

276  -
	`î∫o_to_p9
(
î∫o
);

278 
ªt
 = 
	`l°©
(
∑th
, &
°
);

279 i‡(
ªt
 != 0) {

280 
	`‰ì
(
∑th
);

281 
	`˛o£
(
fd
);

282  -
	`î∫o_to_p9
(
î∫o
);

284 
	`‰ì
(
f
->
∑th
);

285 
f
->
∑th
 =Öath;

286 
f
->
is_›íed
 = 
TRUE
;

287 
f
->
is_dú
 = 
FALSE
;

288 
f
->
u
.
fd
 = fd;

289 
	`°©_to_qid
(
qid
, &
°
);

291 
	}
}

293 
	$fs_ªaddú
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

294 
uöt8_t
 *
buf
, 
cou¡
)

296 
dúít
 *
de
;

297 
Àn
, 
pos
, 
«me_Àn
, 
ty≥
, 
d_ty≥
;

299 i‡(!
f
->
is_›íed
 || !f->
is_dú
)

300  -
P9_EPROTO
;

301 i‡(
off£t
 == 0)

302 
	`ªwöddú
(
f
->
u
.
dúp
);

304 
	`£ekdú
(
f
->
u
.
dúp
, 
off£t
);

305 
pos
 = 0;

307 
de
 = 
	`ªaddú
(
f
->
u
.
dúp
);

308 i‡(
de
 =
NULL
)

310 
«me_Àn
 = 
	`°æí
(
de
->
d_«me
);

311 
Àn
 = 13 + 8 + 1 + 2 + 
«me_Àn
;

312 i‡((
pos
 + 
Àn
Ë> 
cou¡
)

314 
off£t
 = 
	`ãŒdú
(
f
->
u
.
dúp
);

315 
d_ty≥
 = 
de
->d_type;

316 i‡(
d_ty≥
 =
DT_UNKNOWN
) {

317 *
∑th
;

318 
°©
 
°
;

319 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
de
->
d_«me
);

320 i‡(
	`l°©
(
∑th
, &
°
) == 0) {

321 
d_ty≥
 = 
°
.
°_mode
 >> 12;

323 
d_ty≥
 = 
DT_REG
;

325 
	`‰ì
(
∑th
);

327 i‡(
d_ty≥
 =
DT_DIR
)

328 
ty≥
 = 
P9_QTDIR
;

329 i‡(
d_ty≥
 =
DT_LNK
)

330 
ty≥
 = 
P9_QTSYMLINK
;

332 
ty≥
 = 
P9_QTFILE
;

333 
buf
[
pos
++] = 
ty≥
;

334 
	`put_À32
(
buf
 + 
pos
, 0);

335 
pos
 += 4;

336 
	`put_À64
(
buf
 + 
pos
, 
de
->
d_öo
);

337 
pos
 += 8;

338 
	`put_À64
(
buf
 + 
pos
, 
off£t
);

339 
pos
 += 8;

340 
buf
[
pos
++] = 
d_ty≥
;

341 
	`put_À16
(
buf
 + 
pos
, 
«me_Àn
);

342 
pos
 += 2;

343 
	`mem˝y
(
buf
 + 
pos
, 
de
->
d_«me
, 
«me_Àn
);

344 
pos
 +
«me_Àn
;

346  
pos
;

347 
	}
}

349 
	$fs_ªad
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

350 
uöt8_t
 *
buf
, 
cou¡
)

352 
ªt
;

354 i‡(!
f
->
is_›íed
 || f->
is_dú
)

355  -
P9_EPROTO
;

356 
ªt
 = 
	`¥ód
(
f
->
u
.
fd
, 
buf
, 
cou¡
, 
off£t
);

357 i‡(
ªt
 < 0)

358  -
	`î∫o_to_p9
(
î∫o
);

360  
ªt
;

361 
	}
}

363 
	$fs_wrôe
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

364 c⁄° 
uöt8_t
 *
buf
, 
cou¡
)

366 
ªt
;

368 i‡(!
f
->
is_›íed
 || f->
is_dú
)

369  -
P9_EPROTO
;

370 
ªt
 = 
	`pwrôe
(
f
->
u
.
fd
, 
buf
, 
cou¡
, 
off£t
);

371 i‡(
ªt
 < 0)

372  -
	`î∫o_to_p9
(
î∫o
);

374  
ªt
;

375 
	}
}

377 
	$fs_˛o£
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
)

379 i‡(!
f
->
is_›íed
)

381 i‡(
f
->
is_dú
)

382 
	`˛o£dú
(
f
->
u
.
dúp
);

384 
	`˛o£
(
f
->
u
.
fd
);

385 
f
->
is_›íed
 = 
FALSE
;

386 
	}
}

388 
	$fs_°©
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
FSSèt
 *
°
)

390 
°©
 
°1
;

392 i‡(
	`l°©
(
f
->
∑th
, &
°1
) != 0)

393  -
P9_ENOENT
;

394 
	`°©_to_qid
(&
°
->
qid
, &
°1
);

395 
°
->
°_mode
 = 
°1
.st_mode;

396 
°
->
°_uid
 = 
°1
.st_uid;

397 
°
->
°_gid
 = 
°1
.st_gid;

398 
°
->
°_∆ök
 = 
°1
.st_nlink;

399 
°
->
°_rdev
 = 
°1
.st_rdev;

400 
°
->
°_size
 = 
°1
.st_size;

401 
°
->
°_blksize
 = 
°1
.st_blksize;

402 
°
->
°_blocks
 = 
°1
.st_blocks;

403 
°
->
°_©ime_£c
 = 
°1
.
°_©im
.
tv_£c
;

404 
°
->
°_©ime_n£c
 = 
°1
.
°_©im
.
tv_n£c
;

405 
°
->
°_mtime_£c
 = 
°1
.
°_mtim
.
tv_£c
;

406 
°
->
°_mtime_n£c
 = 
°1
.
°_mtim
.
tv_n£c
;

407 
°
->
°_˘ime_£c
 = 
°1
.
°_˘im
.
tv_£c
;

408 
°
->
°_˘ime_n£c
 = 
°1
.
°_˘im
.
tv_n£c
;

410 
	}
}

412 
	$fs_£èâr
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt32_t
 
mask
,

413 
uöt32_t
 
mode
, uöt32_à
uid
, uöt32_à
gid
,

414 
uöt64_t
 
size
, uöt64_à
©ime_£c
, uöt64_à
©ime_n£c
,

415 
uöt64_t
 
mtime_£c
, uöt64_à
mtime_n£c
)

417 
BOOL
 
˘ime_upd©ed
 = 
FALSE
;

419 i‡(
mask
 & (
P9_SETATTR_UID
 | 
P9_SETATTR_GID
)) {

420 i‡(
	`lchown
(
f
->
∑th
, (
mask
 & 
P9_SETATTR_UID
Ë? 
uid
 : -1,

421 (
mask
 & 
P9_SETATTR_GID
Ë? 
gid
 : -1) < 0)

422  -
	`î∫o_to_p9
(
î∫o
);

423 
˘ime_upd©ed
 = 
TRUE
;

426 i‡(
mask
 & 
P9_SETATTR_MODE
) {

427 i‡(
	`chmod
(
f
->
∑th
, 
mode
) < 0)

428  -
	`î∫o_to_p9
(
î∫o
);

429 
˘ime_upd©ed
 = 
TRUE
;

431 i‡(
mask
 & 
P9_SETATTR_SIZE
) {

432 i‡(
	`åunˇã
(
f
->
∑th
, 
size
) < 0)

433  -
	`î∫o_to_p9
(
î∫o
);

434 
˘ime_upd©ed
 = 
TRUE
;

436 i‡(
mask
 & (
P9_SETATTR_ATIME
 | 
P9_SETATTR_MTIME
)) {

437 
time•ec
 
ts
[2];

438 i‡(
mask
 & 
P9_SETATTR_ATIME
) {

439 i‡(
mask
 & 
P9_SETATTR_ATIME_SET
) {

440 
ts
[0].
tv_£c
 = 
©ime_£c
;

441 
ts
[0].
tv_n£c
 = 
©ime_n£c
;

443 
ts
[0].
tv_£c
 = 0;

444 
ts
[0].
tv_n£c
 = 
UTIME_NOW
;

447 
ts
[0].
tv_£c
 = 0;

448 
ts
[0].
tv_n£c
 = 
UTIME_OMIT
;

450 i‡(
mask
 & 
P9_SETATTR_MTIME
) {

451 i‡(
mask
 & 
P9_SETATTR_MTIME_SET
) {

452 
ts
[1].
tv_£c
 = 
mtime_£c
;

453 
ts
[1].
tv_n£c
 = 
mtime_n£c
;

455 
ts
[1].
tv_£c
 = 0;

456 
ts
[1].
tv_n£c
 = 
UTIME_NOW
;

459 
ts
[1].
tv_£c
 = 0;

460 
ts
[1].
tv_n£c
 = 
UTIME_OMIT
;

462 i‡(
	`utimíßt
(
AT_FDCWD
, 
f
->
∑th
, 
ts
, 
AT_SYMLINK_NOFOLLOW
) < 0)

463  -
	`î∫o_to_p9
(
î∫o
);

464 
˘ime_upd©ed
 = 
TRUE
;

466 i‡((
mask
 & 
P9_SETATTR_CTIME
Ë&& !
˘ime_upd©ed
) {

467 i‡(
	`lchown
(
f
->
∑th
, -1, -1) < 0)

468  -
	`î∫o_to_p9
(
î∫o
);

471 
	}
}

473 
	$fs_lök
(
FSDevi˚
 *
fs
, 
FSFûe
 *
df
, FSFûê*
f
, c⁄° *
«me
)

475 *
∑th
;

477 
∑th
 = 
	`compo£_∑th
(
df
->∑th, 
«me
);

478 i‡(
	`lök
(
f
->
∑th
,Öath) < 0) {

479 
	`‰ì
(
∑th
);

480  -
	`î∫o_to_p9
(
î∫o
);

482 
	`‰ì
(
∑th
);

484 
	}
}

486 
	$fs_symlök
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
,

487 
FSFûe
 *
f
, c⁄° *
«me
, c⁄° *
symgt
, 
uöt32_t
 
gid
)

489 *
∑th
;

490 
°©
 
°
;

492 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
«me
);

493 i‡(
	`symlök
(
symgt
, 
∑th
) < 0) {

494 
	`‰ì
(
∑th
);

495  -
	`î∫o_to_p9
(
î∫o
);

497 i‡(
	`l°©
(
∑th
, &
°
) != 0) {

498 
	`‰ì
(
∑th
);

499  -
	`î∫o_to_p9
(
î∫o
);

501 
	`‰ì
(
∑th
);

502 
	`°©_to_qid
(
qid
, &
°
);

504 
	}
}

506 
	$fs_mknod
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
,

507 
FSFûe
 *
f
, c⁄° *
«me
, 
uöt32_t
 
mode
, uöt32_à
maj‹
,

508 
uöt32_t
 
mö‹
, uöt32_à
gid
)

510 *
∑th
;

511 
°©
 
°
;

513 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
«me
);

514 i‡(
	`mknod
(
∑th
, 
mode
, 
	`makedev
(
maj‹
, 
mö‹
)) < 0) {

515 
	`‰ì
(
∑th
);

516  -
	`î∫o_to_p9
(
î∫o
);

518 i‡(
	`l°©
(
∑th
, &
°
) != 0) {

519 
	`‰ì
(
∑th
);

520  -
	`î∫o_to_p9
(
î∫o
);

522 
	`‰ì
(
∑th
);

523 
	`°©_to_qid
(
qid
, &
°
);

525 
	}
}

527 
	$fs_ªadlök
(
FSDevi˚
 *
fs
, *
buf
, 
buf_size
, 
FSFûe
 *
f
)

529 
ªt
;

530 
ªt
 = 
	`ªadlök
(
f
->
∑th
, 
buf
, 
buf_size
 - 1);

531 i‡(
ªt
 < 0)

532  -
	`î∫o_to_p9
(
î∫o
);

533 
buf
[
ªt
] = '\0';

535 
	}
}

537 
	$fs_ª«mót
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
«me
,

538 
FSFûe
 *
√w_f
, c⁄° *
√w_«me
)

540 *
∑th
, *
√w_∑th
;

541 
ªt
;

543 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
«me
);

544 
√w_∑th
 = 
	`compo£_∑th
(
√w_f
->
∑th
, 
√w_«me
);

545 
ªt
 = 
	`ª«me
(
∑th
, 
√w_∑th
);

546 
	`‰ì
(
∑th
);

547 
	`‰ì
(
√w_∑th
);

548 i‡(
ªt
 < 0)

549  -
	`î∫o_to_p9
(
î∫o
);

551 
	}
}

553 
	$fs_u∆ök©
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
«me
)

555 *
∑th
;

556 
ªt
;

558 
∑th
 = 
	`compo£_∑th
(
f
->∑th, 
«me
);

559 
ªt
 = 
	`ªmove
(
∑th
);

560 
	`‰ì
(
∑th
);

561 i‡(
ªt
 < 0)

562  -
	`î∫o_to_p9
(
î∫o
);

565 
	}
}

567 
	$fs_lock
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° 
FSLock
 *
lock
)

569 
ªt
;

570 
Êock
 
Ê
;

573 i‡(!
f
->
is_›íed
 || f->
is_dú
)

574  -
P9_EPROTO
;

576 
Ê
.
l_ty≥
 = 
lock
->
ty≥
;

577 
Ê
.
l_whí˚
 = 
SEEK_SET
;

578 
Ê
.
l_°¨t
 = 
lock
->
°¨t
;

579 
Ê
.
l_Àn
 = 
lock
->
Àngth
;

581 
ªt
 = 
	`f˙é
(
f
->
u
.
fd
, 
F_SETLK
, &
Ê
);

582 i‡(
ªt
 == 0) {

583 
ªt
 = 
P9_LOCK_SUCCESS
;

584 } i‡(
î∫o
 =
EAGAIN
 ||Éºnÿ=
EACCES
) {

585 
ªt
 = 
P9_LOCK_BLOCKED
;

587 
ªt
 = -
	`î∫o_to_p9
(
î∫o
);

589  
ªt
;

590 
	}
}

592 
	$fs_gëlock
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
FSLock
 *
lock
)

594 
ªt
;

595 
Êock
 
Ê
;

598 i‡(!
f
->
is_›íed
 || f->
is_dú
)

599  -
P9_EPROTO
;

601 
Ê
.
l_ty≥
 = 
lock
->
ty≥
;

602 
Ê
.
l_whí˚
 = 
SEEK_SET
;

603 
Ê
.
l_°¨t
 = 
lock
->
°¨t
;

604 
Ê
.
l_Àn
 = 
lock
->
Àngth
;

606 
ªt
 = 
	`f˙é
(
f
->
u
.
fd
, 
F_GETLK
, &
Ê
);

607 i‡(
ªt
 < 0) {

608 
ªt
 = -
	`î∫o_to_p9
(
î∫o
);

610 
lock
->
ty≥
 = 
Ê
.
l_ty≥
;

611 
lock
->
°¨t
 = 
Ê
.
l_°¨t
;

612 
lock
->
Àngth
 = 
Ê
.
l_Àn
;

614  
ªt
;

615 
	}
}

617 
	$fs_disk_íd
(
FSDevi˚
 *
fs1
)

619 
FSDevi˚Disk
 *
fs
 = (FSDevi˚Disk *)
fs1
;

620 
	`‰ì
(
fs
->
roŸ_∑th
);

621 
	}
}

623 
FSDevi˚
 *
	$fs_disk_öô
(c⁄° *
roŸ_∑th
)

625 
FSDevi˚Disk
 *
fs
;

626 
°©
 
°
;

628 
	`l°©
(
roŸ_∑th
, &
°
);

629 i‡(!
	`S_ISDIR
(
°
.
°_mode
))

630  
NULL
;

632 
fs
 = 
	`mÆlocz
((*fs));

634 
fs
->
comm⁄
.
fs_íd
 = 
fs_disk_íd
;

635 
fs
->
comm⁄
.
fs_dñëe
 = fs_delete;

636 
fs
->
comm⁄
.
fs_°©fs
 = fs_statfs;

637 
fs
->
comm⁄
.
fs_©èch
 = fs_attach;

638 
fs
->
comm⁄
.
fs_wÆk
 = fs_walk;

639 
fs
->
comm⁄
.
fs_mkdú
 = fs_mkdir;

640 
fs
->
comm⁄
.
fs_›í
 = fs_open;

641 
fs
->
comm⁄
.
fs_¸óã
 = fs_create;

642 
fs
->
comm⁄
.
fs_°©
 = fs_stat;

643 
fs
->
comm⁄
.
fs_£èâr
 = fs_setattr;

644 
fs
->
comm⁄
.
fs_˛o£
 = fs_close;

645 
fs
->
comm⁄
.
fs_ªaddú
 = fs_readdir;

646 
fs
->
comm⁄
.
fs_ªad
 = fs_read;

647 
fs
->
comm⁄
.
fs_wrôe
 = fs_write;

648 
fs
->
comm⁄
.
fs_lök
 = fs_link;

649 
fs
->
comm⁄
.
fs_symlök
 = fs_symlink;

650 
fs
->
comm⁄
.
fs_mknod
 = fs_mknod;

651 
fs
->
comm⁄
.
fs_ªadlök
 = fs_readlink;

652 
fs
->
comm⁄
.
fs_ª«mót
 = fs_renameat;

653 
fs
->
comm⁄
.
fs_u∆ök©
 = fs_unlinkat;

654 
fs
->
comm⁄
.
fs_lock
 = fs_lock;

655 
fs
->
comm⁄
.
fs_gëlock
 = fs_getlock;

657 
fs
->
roŸ_∑th
 = 
	`°rdup
(root_path);

658  (
FSDevi˚
 *)
fs
;

659 
	}
}

	@fs_net.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

30 
	~<sys/time.h
>

31 
	~<˘y≥.h
>

33 
	~"cutûs.h
"

34 
	~"li°.h
"

35 
	~"fs.h
"

36 
	~"fs_utûs.h
"

37 
	~"fs_wgë.h
"

38 
	~"fbuf.h
"

40 #i‡
deföed
(
EMSCRIPTEN
)

41 
	~<ems¸ùãn.h
>

53 #i‡!
deföed
(
EMSCRIPTEN
)

54 
	#DUMP_CACHE_LOAD


	)

57 #i‡
deföed
(
EMSCRIPTEN
)

58 
	#DEFAULT_INODE_CACHE_SIZE
 (64 * 1024 * 1024)

	)

60 
	#DEFAULT_INODE_CACHE_SIZE
 (256 * 1024 * 1024)

	)

64 
	mFT_FIFO
 = 1,

65 
	mFT_CHR
 = 2,

66 
	mFT_DIR
 = 4,

67 
	mFT_BLK
 = 6,

68 
	mFT_REG
 = 8,

69 
	mFT_LNK
 = 10,

70 
	mFT_SOCK
 = 12,

71 } 
	tFSINodeTy≥Enum
;

74 
	mREG_STATE_LOCAL
,

75 
	mREG_STATE_UNLOADED
,

76 
	mREG_STATE_LOADING
,

77 
	mREG_STATE_LOADED
,

78 } 
	tFSINodeRegSèãEnum
;

80 
	sFSBa£URL
 {

81 
li°_hód
 
	mlök
;

82 
	mªf_cou¡
;

83 *
	mba£_uæ_id
;

84 *
	muæ
;

85 *
	mu£r
;

86 *
	m∑ssw‹d
;

87 
BOOL
 
	mí¸y±ed
;

88 
AES_KEY
 
	m´s_°©e
;

89 } 
	tFSBa£URL
;

91 
	sFSINode
 {

92 
li°_hód
 
	mlök
;

93 
uöt64_t
 
	möode_num
;

94 
öt32_t
 
	mªfcou¡
;

95 
öt32_t
 
	m›í_cou¡
;

96 
FSINodeTy≥Enum
 
	mty≥
;

97 
uöt32_t
 
	mmode
;

98 
uöt32_t
 
	muid
;

99 
uöt32_t
 
	mgid
;

100 
uöt32_t
 
	mmtime_£c
;

101 
uöt32_t
 
	m˘ime_£c
;

102 
uöt32_t
 
	mmtime_n£c
;

103 
uöt32_t
 
	m˘ime_n£c
;

106 
FSINodeRegSèãEnum
 
	m°©e
;

107 
size_t
 
	msize
;

108 
FûeBuf„r
 
	mfbuf
;

109 
FSBa£URL
 *
	mba£_uæ
;

110 
FSFûeID
 
	mfûe_id
;

111 
li°_hód
 
	mlök
;

112 
FSO≥nInfo
 *
	m›í_öfo
;

113 
BOOL
 
	mis_fscmd
;

114 #ifde‡
DUMP_CACHE_LOAD


115 *
	mfûíame
;

117 } 
	mªg
;

119 
li°_hód
 
	mde_li°
;

120 
	msize
;

121 } 
	mdú
;

123 
uöt32_t
 
	mmaj‹
;

124 
uöt32_t
 
	mmö‹
;

125 } 
	mdev
;

127 *
	m«me
;

128 } 
	msymlök
;

129 } 
	mu
;

130 } 
	tFSINode
;

133 
li°_hód
 
	mlök
;

134 
FSINode
 *
	möode
;

135 
uöt8_t
 
	mm¨k
;

136 
	m«me
[0];

137 } 
	tFSDúE¡ry
;

140 
	mFS_CMD_XHR
,

141 
	mFS_CMD_PBKDF2
,

142 } 
	tFSCMDReque°Enum
;

144 
	#FS_CMD_REPLY_LEN_MAX
 64

	)

147 
FSCMDReque°Enum
 
	mty≥
;

148 
CmdXHRSèã
 *
	mxhr_°©e
;

149 
	mª∂y_Àn
;

150 
uöt8_t
 
	mª∂y_buf
[
FS_CMD_REPLY_LEN_MAX
];

151 } 
	tFSCMDReque°
;

153 
	sFSFûe
 {

154 
uöt32_t
 
	muid
;

155 
FSINode
 *
	möode
;

156 
BOOL
 
	mis_›íed
;

157 
uöt32_t
 
	m›í_Êags
;

158 
FSCMDReque°
 *
	mªq
;

162 
li°_hód
 
	mlök
;

163 
BOOL
 
	mis_¨chive
;

164 c⁄° *
	m«me
;

165 } 
	tPªlﬂdFûe
;

168 
li°_hód
 
	mlök
;

169 
FSFûeID
 
	mfûe_id
;

170 
li°_hód
 
	mfûe_li°
;

171 } 
	tPªlﬂdE¡ry
;

174 
li°_hód
 
	mlök
;

175 
FSFûeID
 
	mfûe_id
;

176 
uöt64_t
 
	msize
;

177 c⁄° *
	m«me
;

178 } 
	tPªlﬂdArchiveFûe
;

181 
li°_hód
 
	mlök
;

182 c⁄° *
	m«me
;

183 
li°_hód
 
	mfûe_li°
;

184 } 
	tPªlﬂdArchive
;

186 
	sFSDevi˚Mem
 {

187 
FSDevi˚
 
	mcomm⁄
;

189 
li°_hód
 
	möode_li°
;

190 
öt64_t
 
	möode_cou¡
;

191 
uöt64_t
 
	möode_limô
;

192 
öt64_t
 
	mfs_blocks
;

193 
uöt64_t
 
	mfs_max_blocks
;

194 
uöt64_t
 
	möode_num_Æloc
;

195 
	mblock_size_log2
;

196 
uöt32_t
 
	mblock_size
;

197 
FSINode
 *
	mroŸ_öode
;

198 
li°_hód
 
	möode_ˇche_li°
;

199 
öt64_t
 
	möode_ˇche_size
;

200 
öt64_t
 
	möode_ˇche_size_limô
;

201 
li°_hód
 
	m¥ñﬂd_li°
;

202 
li°_hód
 
	m¥ñﬂd_¨chive_li°
;

204 
li°_hód
 
	mba£_uæ_li°
;

205 *
	mimp‹t_dú
;

206 #ifde‡
DUMP_CACHE_LOAD


207 
BOOL
 
	mdump_ˇche_lﬂd
;

208 
BOOL
 
	mdump_°¨ãd
;

209 *
	mdump_¥ñﬂd_dú
;

210 
FILE
 *
	mdump_¥ñﬂd_fûe
;

211 
FILE
 *
	mdump_¥ñﬂd_¨chive_fûe
;

213 *
	mdump_¨chive_«me
;

214 
uöt64_t
 
	mdump_¨chive_size
;

215 
FILE
 *
	mdump_¨chive_fûe
;

217 
	mdump_¨chive_num
;

218 
li°_hód
 
	mdump_¥ñﬂd_li°
;

219 
li°_hód
 
	mdump_ex˛ude_li°
;

221 } 
	tFSDevi˚Mem
;

224 
	mFS_OPEN_WGET_REG
,

225 
	mFS_OPEN_WGET_ARCHIVE
,

226 
	mFS_OPEN_WGET_ARCHIVE_FILE
,

227 } 
	tFSO≥nWgëEnum
;

229 
	sFSO≥nInfo
 {

230 
FSDevi˚
 *
	mfs
;

231 
FSO≥nWgëEnum
 
	m›í_ty≥
;

234 
XHRSèã
 *
	mxhr
;

235 
FSINode
 *
	mn
;

236 
De¸y±FûeSèã
 *
	mdec_°©e
;

237 
size_t
 
	mcur_pos
;

239 
li°_hód
 
	m¨chive_lök
;

240 
uöt64_t
 
	m¨chive_off£t
;

241 
li°_hód
 
	m¨chive_fûe_li°
;

244 
FSFûe
 *
	mf
;

245 
FSO≥nCom∂ëi⁄Func
 *
	mcb
;

246 *
	m›aque
;

247 } 
	tFSO≥nInfo
;

249 
fs_˛o£
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
);

250 
öode_de¸ef
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
);

251 
fs_cmd_wrôe
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

252 c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
);

253 
fs_cmd_ªad
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

254 
uöt8_t
 *
buf
, 
buf_Àn
);

255 
fs_åunˇã
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
, 
uöt64_t
 
size
);

256 
fs_›í_íd
(
FSO≥nInfo
 *
oi
);

257 
fs_ba£_uæ_de¸ef
(
FSDevi˚
 *
fs
, 
FSBa£URL
 *
bu
);

258 
FSBa£URL
 *
fs_√t_£t_ba£_uæ
(
FSDevi˚
 *
fs1
,

259 c⁄° *
ba£_uæ_id
,

260 c⁄° *
uæ
,

261 c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

262 
AES_KEY
 *
´s_°©e
);

263 
fs_cmd_˛o£
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
);

264 
fs_îr‹_¨chive
(
FSO≥nInfo
 *
oi
);

265 #ifde‡
DUMP_CACHE_LOAD


266 
dump_lﬂded_fûe
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
);

269 #i‡!
deföed
(
EMSCRIPTEN
)

271 
	$fûe_buf„r_öô
(
FûeBuf„r
 *
bs
)

273 
bs
->
d©a
 = 
NULL
;

274 
bs
->
Æloˇãd_size
 = 0;

275 
	}
}

277 
	$fûe_buf„r_ª£t
(
FûeBuf„r
 *
bs
)

279 
	`‰ì
(
bs
->
d©a
);

280 
	`fûe_buf„r_öô
(
bs
);

281 
	}
}

283 
	$fûe_buf„r_ªsize
(
FûeBuf„r
 *
bs
, 
size_t
 
√w_size
)

285 
uöt8_t
 *
√w_d©a
;

286 
√w_d©a
 = 
	`ªÆloc
(
bs
->
d©a
, 
√w_size
);

287 i‡(!
√w_d©a
 && 
√w_size
 != 0)

289 
bs
->
d©a
 = 
√w_d©a
;

290 
bs
->
Æloˇãd_size
 = 
√w_size
;

292 
	}
}

294 
	$fûe_buf„r_wrôe
(
FûeBuf„r
 *
bs
, 
size_t
 
off£t
, c⁄° 
uöt8_t
 *
buf
,

295 
size_t
 
size
)

297 
	`mem˝y
(
bs
->
d©a
 + 
off£t
, 
buf
, 
size
);

298 
	}
}

300 
	$fûe_buf„r_£t
(
FûeBuf„r
 *
bs
, 
size_t
 
off£t
, 
vÆ
, size_à
size
)

302 
	`mem£t
(
bs
->
d©a
 + 
off£t
, 
vÆ
, 
size
);

303 
	}
}

305 
	$fûe_buf„r_ªad
(
FûeBuf„r
 *
bs
, 
size_t
 
off£t
, 
uöt8_t
 *
buf
,

306 
size_t
 
size
)

308 
	`mem˝y
(
buf
, 
bs
->
d©a
 + 
off£t
, 
size
);

309 
	}
}

312 
öt64_t
 
	$to_blocks
(
FSDevi˚Mem
 *
fs
, 
uöt64_t
 
size
)

314  (
size
 + 
fs
->
block_size
 - 1Ë>> fs->
block_size_log2
;

315 
	}
}

317 
FSINode
 *
	$öode_ö¸ef
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
)

319 
n
->
ªfcou¡
++;

320  
n
;

321 
	}
}

323 
FSINode
 *
	$öode_öc_›í
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
)

325 
n
->
›í_cou¡
++;

326  
n
;

327 
	}
}

329 
	$öode_‰ì
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
)

331 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

334 
	`as£π
(
n
->
ªfcou¡
 == 0);

335 
	`as£π
(
n
->
›í_cou¡
 == 0);

336 
n
->
ty≥
) {

337 
FT_REG
:

338 
fs
->
fs_blocks
 -
	`to_blocks
(fs, 
n
->
u
.
ªg
.
size
);

339 
	`as£π
(
fs
->
fs_blocks
 >= 0);

340 
	`fûe_buf„r_ª£t
(&
n
->
u
.
ªg
.
fbuf
);

341 #ifde‡
DUMP_CACHE_LOAD


342 
	`‰ì
(
n
->
u
.
ªg
.
fûíame
);

344 
n
->
u
.
ªg
.
°©e
) {

345 
REG_STATE_LOADED
:

346 
	`li°_dñ
(&
n
->
u
.
ªg
.
lök
);

347 
fs
->
öode_ˇche_size
 -
n
->
u
.
ªg
.
size
;

348 
	`as£π
(
fs
->
öode_ˇche_size
 >= 0);

349 
	`fs_ba£_uæ_de¸ef
(
fs1
, 
n
->
u
.
ªg
.
ba£_uæ
);

351 
REG_STATE_LOADING
:

353 
FSO≥nInfo
 *
oi
 = 
n
->
u
.
ªg
.
›í_öfo
;

354 i‡(
oi
->
xhr
)

355 
	`fs_wgë_‰ì
(
oi
->
xhr
);

356 i‡(
oi
->
›í_ty≥
 =
FS_OPEN_WGET_ARCHIVE
) {

357 
	`fs_îr‹_¨chive
(
oi
);

359 
	`fs_›í_íd
(
oi
);

360 
	`fs_ba£_uæ_de¸ef
(
fs1
, 
n
->
u
.
ªg
.
ba£_uæ
);

363 
REG_STATE_UNLOADED
:

364 
	`fs_ba£_uæ_de¸ef
(
fs1
, 
n
->
u
.
ªg
.
ba£_uæ
);

366 
REG_STATE_LOCAL
:

369 
	`ab‹t
();

372 
FT_LNK
:

373 
	`‰ì
(
n
->
u
.
symlök
.
«me
);

375 
FT_DIR
:

376 
	`as£π
(
	`li°_em±y
(&
n
->
u
.
dú
.
de_li°
));

381 
	`li°_dñ
(&
n
->
lök
);

382 
	`‰ì
(
n
);

383 
fs
->
öode_cou¡
--;

384 
	`as£π
(
fs
->
öode_cou¡
 >= 0);

385 
	}
}

387 
	$öode_de¸ef
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
)

389 
	`as£π
(
n
->
ªfcou¡
 >= 1);

390 i‡(--
n
->
ªfcou¡
 <0 &&Ç->
›í_cou¡
 <= 0) {

391 
	`öode_‰ì
(
fs1
, 
n
);

393 
	}
}

395 
	$öode_dec_›í
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
)

397 
	`as£π
(
n
->
›í_cou¡
 >= 1);

398 i‡(--
n
->
›í_cou¡
 <0 &&Ç->
ªfcou¡
 <= 0) {

399 
	`öode_‰ì
(
fs1
, 
n
);

401 
	}
}

403 
	$öode_upd©e_mtime
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
)

405 
timevÆ
 
tv
;

406 
	`gëtimeofday
(&
tv
, 
NULL
);

407 
n
->
mtime_£c
 = 
tv
.
tv_£c
;

408 
n
->
mtime_n£c
 = 
tv
.
tv_u£c
 * 1000;

409 
	}
}

411 
FSINode
 *
	$öode_√w
(
FSDevi˚
 *
fs1
, 
FSINodeTy≥Enum
 
ty≥
,

412 
uöt32_t
 
mode
, uöt32_à
uid
, uöt32_à
gid
)

414 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

415 
FSINode
 *
n
;

417 
n
 = 
	`mÆlocz
((*n));

418 
n
->
ªfcou¡
 = 1;

419 
n
->
›í_cou¡
 = 0;

420 
n
->
öode_num
 = 
fs
->
öode_num_Æloc
;

421 
fs
->
öode_num_Æloc
++;

422 
n
->
ty≥
 =Åype;

423 
n
->
mode
 = mode & 0xfff;

424 
n
->
uid
 = uid;

425 
n
->
gid
 = gid;

427 
ty≥
) {

428 
FT_REG
:

429 
	`fûe_buf„r_öô
(&
n
->
u
.
ªg
.
fbuf
);

431 
FT_DIR
:

432 
	`öô_li°_hód
(&
n
->
u
.
dú
.
de_li°
);

438 
	`li°_add
(&
n
->
lök
, &
fs
->
öode_li°
);

439 
fs
->
öode_cou¡
++;

441 
	`öode_upd©e_mtime
(
fs1
, 
n
);

442 
n
->
˘ime_£c
 =Ç->
mtime_£c
;

443 
n
->
˘ime_n£c
 =Ç->
mtime_n£c
;

445  
n
;

446 
	}
}

450 
FSDúE¡ry
 *
	$öode_dú_add
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
, c⁄° *
«me
,

451 
FSINode
 *
n1
)

453 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

454 
FSDúE¡ry
 *
de
;

455 
«me_Àn
, 
dúít_size
, 
√w_size
;

456 
	`as£π
(
n
->
ty≥
 =
FT_DIR
);

458 
«me_Àn
 = 
	`°æí
(
«me
);

459 
de
 = 
	`mÆlocz
((*deË+ 
«me_Àn
 + 1);

460 
de
->
öode
 = 
n1
;

461 
	`mem˝y
(
de
->
«me
,Çame, 
«me_Àn
 + 1);

462 
dúít_size
 = (*
de
Ë+ 
«me_Àn
 + 1;

463 
√w_size
 = 
n
->
u
.
dú
.
size
 + 
dúít_size
;

464 
fs
->
fs_blocks
 +
	`to_blocks
(fs, 
√w_size
Ë-Åo_blocks(fs, 
n
->
u
.
dú
.
size
);

465 
n
->
u
.
dú
.
size
 = 
√w_size
;

466 
	`li°_add_èû
(&
de
->
lök
, &
n
->
u
.
dú
.
de_li°
);

467  
de
;

468 
	}
}

470 
FSDúE¡ry
 *
	$öode_£¨ch
(
FSINode
 *
n
, c⁄° *
«me
)

472 
li°_hód
 *
ñ
;

473 
FSDúE¡ry
 *
de
;

475 i‡(
n
->
ty≥
 !
FT_DIR
)

476  
NULL
;

478 
	`li°_f‹_óch
(
ñ
, &
n
->
u
.
dú
.
de_li°
) {

479 
de
 = 
	`li°_íåy
(
ñ
, 
FSDúE¡ry
, 
lök
);

480 i‡(!
	`°rcmp
(
de
->
«me
,Çame))

481  
de
;

483  
NULL
;

484 
	}
}

486 
FSINode
 *
	$öode_£¨ch_∑th1
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
, c⁄° *
∑th
)

488 
«me
[1024];

489 c⁄° *
p
, *
p1
;

490 
Àn
;

491 
FSDúE¡ry
 *
de
;

493 
p
 = 
∑th
;

494 i‡(*
p
 == '/')

495 
p
++;

496 i‡(*
p
 == '\0')

497  
n
;

499 
p1
 = 
	`°rchr
(
p
, '/');

500 i‡(!
p1
) {

501 
Àn
 = 
	`°æí
(
p
);

503 
Àn
 = 
p1
 - 
p
;

504 
p1
++;

506 i‡(
Àn
 > (
«me
) - 1)

507  
NULL
;

508 
	`mem˝y
(
«me
, 
p
, 
Àn
);

509 
«me
[
Àn
] = '\0';

510 i‡(
n
->
ty≥
 !
FT_DIR
)

511  
NULL
;

512 
de
 = 
	`öode_£¨ch
(
n
, 
«me
);

513 i‡(!
de
)

514  
NULL
;

515 
n
 = 
de
->
öode
;

516 
p
 = 
p1
;

517 i‡(!
p
)

520  
n
;

521 
	}
}

523 
FSINode
 *
	$öode_£¨ch_∑th
(
FSDevi˚
 *
fs1
, c⁄° *
∑th
)

525 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

526 i‡(!
fs1
)

527  
NULL
;

528  
	`öode_£¨ch_∑th1
(
fs1
, 
fs
->
roŸ_öode
, 
∑th
);

529 
	}
}

531 
BOOL
 
	$is_em±y_dú
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
)

533 
li°_hód
 *
ñ
;

534 
FSDúE¡ry
 *
de
;

536 
	`li°_f‹_óch
(
ñ
, &
n
->
u
.
dú
.
de_li°
) {

537 
de
 = 
	`li°_íåy
(
ñ
, 
FSDúE¡ry
, 
lök
);

538 i‡(
	`°rcmp
(
de
->
«me
, ".") != 0 &&

539 
	`°rcmp
(
de
->
«me
, "..") != 0)

540  
FALSE
;

542  
TRUE
;

543 
	}
}

545 
	$öode_dúít_dñëe_no_de¸ef
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
, 
FSDúE¡ry
 *
de
)

547 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

548 
dúít_size
, 
√w_size
;

549 
dúít_size
 = (*
de
Ë+ 
	`°æí
(de->
«me
) + 1;

551 
√w_size
 = 
n
->
u
.
dú
.
size
 - 
dúít_size
;

552 
fs
->
fs_blocks
 +
	`to_blocks
(fs, 
√w_size
Ë-Åo_blocks(fs, 
n
->
u
.
dú
.
size
);

553 
n
->
u
.
dú
.
size
 = 
√w_size
;

554 
	`as£π
(
n
->
u
.
dú
.
size
 >= 0);

555 
	`as£π
(
fs
->
fs_blocks
 >= 0);

556 
	`li°_dñ
(&
de
->
lök
);

557 
	`‰ì
(
de
);

558 
	}
}

560 
	$öode_dúít_dñëe
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
, 
FSDúE¡ry
 *
de
)

562 
FSINode
 *
n1
;

563 
n1
 = 
de
->
öode
;

564 
	`öode_dúít_dñëe_no_de¸ef
(
fs
, 
n
, 
de
);

565 
	`öode_de¸ef
(
fs
, 
n1
);

566 
	}
}

568 
	$Êush_dú
(
FSDevi˚
 *
fs
, 
FSINode
 *
n
)

570 
li°_hód
 *
ñ
, *
ñ1
;

571 
FSDúE¡ry
 *
de
;

572 
	`li°_f‹_óch_ß„
(
ñ
, 
ñ1
, &
n
->
u
.
dú
.
de_li°
) {

573 
de
 = 
	`li°_íåy
(
ñ
, 
FSDúE¡ry
, 
lök
);

574 
	`öode_dúít_dñëe
(
fs
, 
n
, 
de
);

576 
	`as£π
(
n
->
u
.
dú
.
size
 == 0);

577 
	}
}

579 
	$fs_dñëe
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
)

581 
	`fs_˛o£
(
fs
, 
f
);

582 
	`öode_dec_›í
(
fs
, 
f
->
öode
);

583 
	`‰ì
(
f
);

584 
	}
}

586 
FSFûe
 *
	$fid_¸óã
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
, 
uöt32_t
 
uid
)

588 
FSFûe
 *
f
;

590 
f
 = 
	`mÆlocz
((*f));

591 
f
->
öode
 = 
	`öode_öc_›í
(
fs1
, 
n
);

592 
f
->
uid
 = uid;

593  
f
;

594 
	}
}

596 
	$öode_to_qid
(
FSQID
 *
qid
, 
FSINode
 *
n
)

598 i‡(
n
->
ty≥
 =
FT_DIR
)

599 
qid
->
ty≥
 = 
P9_QTDIR
;

600 i‡(
n
->
ty≥
 =
FT_LNK
)

601 
qid
->
ty≥
 = 
P9_QTSYMLINK
;

603 
qid
->
ty≥
 = 
P9_QTFILE
;

604 
qid
->
vîsi⁄
 = 0;

605 
qid
->
∑th
 = 
n
->
öode_num
;

606 
	}
}

608 
	$fs_°©fs
(
FSDevi˚
 *
fs1
, 
FSSètFS
 *
°
)

610 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

611 
°
->
f_bsize
 = 1024;

612 
°
->
f_blocks
 = 
fs
->
fs_max_blocks
 <<

613 (
fs
->
block_size_log2
 - 10);

614 
°
->
f_b‰ì
 = (
fs
->
fs_max_blocks
 - fs->
fs_blocks
) <<

615 (
fs
->
block_size_log2
 - 10);

616 
°
->
f_bavaû
 = st->
f_b‰ì
;

617 
°
->
f_fûes
 = 
fs
->
öode_limô
;

618 
°
->
f_f‰ì
 = 
fs
->
öode_limô
 - fs->
öode_cou¡
;

619 
	}
}

621 
	$fs_©èch
(
FSDevi˚
 *
fs1
, 
FSFûe
 **
pf
, 
FSQID
 *
qid
, 
uöt32_t
 
uid
,

622 c⁄° *
u«me
, c⁄° *
™ame
)

624 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

626 *
pf
 = 
	`fid_¸óã
(
fs1
, 
fs
->
roŸ_öode
, 
uid
);

627 
	`öode_to_qid
(
qid
, 
fs
->
roŸ_öode
);

629 
	}
}

631 
	$fs_wÆk
(
FSDevi˚
 *
fs
, 
FSFûe
 **
pf
, 
FSQID
 *
qids
,

632 
FSFûe
 *
f
, 
cou¡
, **
«mes
)

634 
i
;

635 
FSINode
 *
n
;

636 
FSDúE¡ry
 *
de
;

638 
n
 = 
f
->
öode
;

639 
i
 = 0; i < 
cou¡
; i++) {

640 
de
 = 
	`öode_£¨ch
(
n
, 
«mes
[
i
]);

641 i‡(!
de
)

643 
n
 = 
de
->
öode
;

644 
	`öode_to_qid
(&
qids
[
i
], 
n
);

646 *
pf
 = 
	`fid_¸óã
(
fs
, 
n
, 
f
->
uid
);

647  
i
;

648 
	}
}

650 
	$fs_mkdú
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
FSFûe
 *
f
,

651 c⁄° *
«me
, 
uöt32_t
 
mode
, uöt32_à
gid
)

653 
FSINode
 *
n
, *
n1
;

655 
n
 = 
f
->
öode
;

656 i‡(
n
->
ty≥
 !
FT_DIR
)

657  -
P9_ENOTDIR
;

658 i‡(
	`öode_£¨ch
(
n
, 
«me
))

659  -
P9_EEXIST
;

660 
n1
 = 
	`öode_√w
(
fs
, 
FT_DIR
, 
mode
, 
f
->
uid
, 
gid
);

661 
	`öode_dú_add
(
fs
, 
n1
, ".", 
	`öode_ö¸ef
(fs,Ç1));

662 
	`öode_dú_add
(
fs
, 
n1
, "..", 
	`öode_ö¸ef
(fs, 
n
));

663 
	`öode_dú_add
(
fs
, 
n
, 
«me
, 
n1
);

664 
	`öode_to_qid
(
qid
, 
n1
);

666 
	}
}

670 
	$fs_åim_ˇche
(
FSDevi˚
 *
fs1
, 
öt64_t
 
added_size
)

672 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

673 
li°_hód
 *
ñ
, *
ñ1
;

674 
FSINode
 *
n
;

676 i‡((
fs
->
öode_ˇche_size
 + 
added_size
Ë<fs->
öode_ˇche_size_limô
)

678 
	`li°_f‹_óch_¥ev_ß„
(
ñ
, 
ñ1
, &
fs
->
öode_ˇche_li°
) {

679 
n
 = 
	`li°_íåy
(
ñ
, 
FSINode
, 
u
.
ªg
.
lök
);

680 
	`as£π
(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_LOADED
);

683 i‡(
n
->
›í_cou¡
 != 0)

685 #ifde‡
DEBUG_CACHE


686 
	`¥ötf
("fs_trim_cache:Ñemove '%s' size=%ld\n",

687 
n
->
u
.
ªg
.
fûíame
, (Í->u.ªg.
size
);

689 
	`fûe_buf„r_ª£t
(&
n
->
u
.
ªg
.
fbuf
);

690 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_UNLOADED
;

691 
	`li°_dñ
(&
n
->
u
.
ªg
.
lök
);

692 
fs
->
öode_ˇche_size
 -
n
->
u
.
ªg
.
size
;

693 
	`as£π
(
fs
->
öode_ˇche_size
 >= 0);

694 i‡((
fs
->
öode_ˇche_size
 + 
added_size
Ë<fs->
öode_ˇche_size_limô
)

697 
	}
}

699 
	$fs_›í_íd
(
FSO≥nInfo
 *
oi
)

701 i‡(
oi
->
›í_ty≥
 =
FS_OPEN_WGET_ARCHIVE_FILE
) {

702 
	`li°_dñ
(&
oi
->
¨chive_lök
);

704 i‡(
oi
->
dec_°©e
)

705 
	`de¸y±_fûe_íd
(
oi
->
dec_°©e
);

706 
	`‰ì
(
oi
);

707 
	}
}

709 
	$fs_›í_wrôe_cb
(*
›aque
, c⁄° 
uöt8_t
 *
d©a
, 
size_t
 
size
)

711 
FSO≥nInfo
 *
oi
 = 
›aque
;

712 
size_t
 
Àn
;

713 
FSINode
 *
n
 = 
oi
->n;

716 
Àn
 = 
n
->
u
.
ªg
.
size
 - 
oi
->
cur_pos
;

717 i‡(
size
 < 
Àn
)

718 
Àn
 = 
size
;

719 
	`fûe_buf„r_wrôe
(&
n
->
u
.
ªg
.
fbuf
, 
oi
->
cur_pos
, 
d©a
, 
Àn
);

720 
oi
->
cur_pos
 +
Àn
;

722 
	}
}

724 
	$fs_wgë_£t_lﬂded
(
FSINode
 *
n
)

726 
FSO≥nInfo
 *
oi
;

727 
FSDevi˚Mem
 *
fs
;

728 
FSFûe
 *
f
;

729 
FSQID
 
qid
;

731 
	`as£π
(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_LOADING
);

732 
oi
 = 
n
->
u
.
ªg
.
›í_öfo
;

733 
fs
 = (
FSDevi˚Mem
 *)
oi
->fs;

734 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_LOADED
;

735 
	`li°_add
(&
n
->
u
.
ªg
.
lök
, &
fs
->
öode_ˇche_li°
);

736 
fs
->
öode_ˇche_size
 +
n
->
u
.
ªg
.
size
;

738 i‡(
oi
->
cb
) {

739 
f
 = 
oi
->f;

740 
f
->
is_›íed
 = 
TRUE
;

741 
	`öode_to_qid
(&
qid
, 
n
);

742 
oi
->
	`cb
(oi->
fs
, &
qid
, 0, oi->
›aque
);

744 
	`fs_›í_íd
(
oi
);

745 
	}
}

747 
	$fs_wgë_£t_îr‹
(
FSINode
 *
n
)

749 
FSO≥nInfo
 *
oi
;

750 
	`as£π
(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_LOADING
);

751 
oi
 = 
n
->
u
.
ªg
.
›í_öfo
;

752 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_UNLOADED
;

753 
	`fûe_buf„r_ª£t
(&
n
->
u
.
ªg
.
fbuf
);

754 i‡(
oi
->
cb
) {

755 
oi
->
	`cb
(oi->
fs
, 
NULL
, -
P9_EIO
, oi->
›aque
);

757 
	`fs_›í_íd
(
oi
);

758 
	}
}

760 
	$fs_ªad_¨chive
(
FSO≥nInfo
 *
oi
)

762 
FSINode
 *
n
 = 
oi
->n;

763 
uöt64_t
 
pos
, 
pos1
, 
l
;

764 
uöt8_t
 
buf
[1024];

765 
FSINode
 *
n1
;

766 
FSO≥nInfo
 *
oi1
;

767 
li°_hód
 *
ñ
, *
ñ1
;

769 
	`li°_f‹_óch_ß„
(
ñ
, 
ñ1
, &
oi
->
¨chive_fûe_li°
) {

770 
oi1
 = 
	`li°_íåy
(
ñ
, 
FSO≥nInfo
, 
¨chive_lök
);

771 
n1
 = 
oi1
->
n
;

773 
pos
 = 
oi1
->
¨chive_off£t
;

774 
pos1
 = 0;

775 
pos1
 < 
n1
->
u
.
ªg
.
size
) {

776 
l
 = 
n1
->
u
.
ªg
.
size
 - 
pos1
;

777 i‡(
l
 > (
buf
))

778 
l
 = (
buf
);

779 
	`fûe_buf„r_ªad
(&
n
->
u
.
ªg
.
fbuf
, 
pos
, 
buf
, 
l
);

780 
	`fûe_buf„r_wrôe
(&
n1
->
u
.
ªg
.
fbuf
, 
pos1
, 
buf
, 
l
);

781 
pos
 +
l
;

782 
pos1
 +
l
;

784 
	`fs_wgë_£t_lﬂded
(
n1
);

786 
	}
}

788 
	$fs_îr‹_¨chive
(
FSO≥nInfo
 *
oi
)

790 
FSO≥nInfo
 *
oi1
;

791 
li°_hód
 *
ñ
, *
ñ1
;

793 
	`li°_f‹_óch_ß„
(
ñ
, 
ñ1
, &
oi
->
¨chive_fûe_li°
) {

794 
oi1
 = 
	`li°_íåy
(
ñ
, 
FSO≥nInfo
, 
¨chive_lök
);

795 
	`fs_wgë_£t_îr‹
(
oi1
->
n
);

797 
	}
}

799 
	$fs_›í_cb
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
)

801 
FSO≥nInfo
 *
oi
 = 
›aque
;

802 
FSINode
 *
n
 = 
oi
->n;

805 i‡(
îr
 < 0) {

806 
îr‹
:

807 i‡(
oi
->
›í_ty≥
 =
FS_OPEN_WGET_ARCHIVE
)

808 
	`fs_îr‹_¨chive
(
oi
);

809 
	`fs_wgë_£t_îr‹
(
n
);

811 i‡(
oi
->
dec_°©e
) {

812 i‡(
	`de¸y±_fûe
(
oi
->
dec_°©e
, 
d©a
, 
size
) < 0)

813 
îr‹
;

814 i‡(
îr
 == 0) {

815 i‡(
	`de¸y±_fûe_Êush
(
oi
->
dec_°©e
) < 0)

816 
îr‹
;

819 
	`fs_›í_wrôe_cb
(
oi
, 
d©a
, 
size
);

822 i‡(
îr
 == 0) {

824 i‡(
oi
->
cur_pos
 !
n
->
u
.
ªg
.
size
)

825 
îr‹
;

826 #ifde‡
DUMP_CACHE_LOAD


827 
	`dump_lﬂded_fûe
(
oi
->
fs
, 
n
);

829 i‡(
oi
->
›í_ty≥
 =
FS_OPEN_WGET_ARCHIVE
)

830 
	`fs_ªad_¨chive
(
oi
);

831 
	`fs_wgë_£t_lﬂded
(
n
);

834 
	}
}

837 
	$fs_›í_wgë
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
, 
FSO≥nWgëEnum
 
›í_ty≥
)

839 *
uæ
;

840 
FSO≥nInfo
 *
oi
;

841 
‚ame
[
FILEID_SIZE_MAX
];

842 
FSBa£URL
 *
bu
;

844 
	`as£π
(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_UNLOADED
);

846 
	`fs_åim_ˇche
(
fs1
, 
n
->
u
.
ªg
.
size
);

848 i‡(
	`fûe_buf„r_ªsize
(&
n
->
u
.
ªg
.
fbuf
,Ç->u.ªg.
size
) < 0)

849  -
P9_EIO
;

850 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_LOADING
;

851 
oi
 = 
	`mÆlocz
((*oi));

852 
oi
->
cur_pos
 = 0;

853 
oi
->
fs
 = 
fs1
;

854 
oi
->
n
 =Ç;

855 
oi
->
›í_ty≥
 = open_type;

856 i‡(
›í_ty≥
 !
FS_OPEN_WGET_ARCHIVE_FILE
) {

857 i‡(
›í_ty≥
 =
FS_OPEN_WGET_ARCHIVE
)

858 
	`öô_li°_hód
(&
oi
->
¨chive_fûe_li°
);

859 
	`fûe_id_to_fûíame
(
‚ame
, 
n
->
u
.
ªg
.
fûe_id
);

860 
bu
 = 
n
->
u
.
ªg
.
ba£_uæ
;

861 
uæ
 = 
	`compo£_∑th
(
bu
->uæ, 
‚ame
);

862 i‡(
bu
->
í¸y±ed
) {

863 
oi
->
dec_°©e
 = 
	`de¸y±_fûe_öô
(&
bu
->
´s_°©e
, 
fs_›í_wrôe_cb
, oi);

865 
oi
->
xhr
 = 
	`fs_wgë
(
uæ
, 
bu
->
u£r
, bu->
∑ssw‹d
, oi, 
fs_›í_cb
, 
FALSE
);

867 
n
->
u
.
ªg
.
›í_öfo
 = 
oi
;

869 
	}
}

872 
	$fs_¥ñﬂd_fûe
(
FSDevi˚
 *
fs1
, c⁄° *
fûíame
)

874 
FSINode
 *
n
;

876 
n
 = 
	`öode_£¨ch_∑th
(
fs1
, 
fûíame
);

877 i‡(
n
 &&Ç->
ty≥
 =
FT_REG
 &&Ç->
u
.
ªg
.
°©e
 =
REG_STATE_UNLOADED
) {

878 #i‡
	`deföed
(
DEBUG_CACHE
)

879 
	`¥ötf
("¥ñﬂd: %s\n", 
fûíame
);

881 
	`fs_›í_wgë
(
fs1
, 
n
, 
FS_OPEN_WGET_REG
);

883 
	}
}

885 
PªlﬂdArchive
 *
	$föd_¥ñﬂd_¨chive
(
FSDevi˚Mem
 *
fs
,

886 c⁄° *
fûíame
)

888 
PªlﬂdArchive
 *
∑
;

889 
li°_hód
 *
ñ
;

890 
	`li°_f‹_óch
(
ñ
, &
fs
->
¥ñﬂd_¨chive_li°
) {

891 
∑
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdArchive
, 
lök
);

892 i‡(!
	`°rcmp
(
∑
->
«me
, 
fûíame
))

893  
∑
;

895  
NULL
;

896 
	}
}

898 
	$fs_¥ñﬂd_¨chive
(
FSDevi˚
 *
fs1
, c⁄° *
fûíame
)

900 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

901 
PªlﬂdArchive
 *
∑
;

902 
PªlﬂdArchiveFûe
 *
∑f
;

903 
li°_hód
 *
ñ
;

904 
FSINode
 *
n
, *
n1
;

905 
uöt64_t
 
off£t
;

906 
BOOL
 
has_u∆ﬂded
;

908 
∑
 = 
	`föd_¥ñﬂd_¨chive
(
fs
, 
fûíame
);

909 i‡(!
∑
)

911 #i‡
	`deföed
(
DEBUG_CACHE
)

912 
	`¥ötf
("¥ñﬂdárchive: %s\n", 
fûíame
);

914 
n
 = 
	`öode_£¨ch_∑th
(
fs1
, 
fûíame
);

915 i‡(
n
 &&Ç->
ty≥
 =
FT_REG
 &&Ç->
u
.
ªg
.
°©e
 =
REG_STATE_UNLOADED
) {

917 
off£t
 = 0;

918 
has_u∆ﬂded
 = 
FALSE
;

919 
	`li°_f‹_óch
(
ñ
, &
∑
->
fûe_li°
) {

920 
∑f
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdArchiveFûe
, 
lök
);

921 
n1
 = 
	`öode_£¨ch_∑th
(
fs1
, 
∑f
->
«me
);

922 i‡(
n1
 &&Ç1->
ty≥
 =
FT_REG
 &&

923 
n1
->
u
.
ªg
.
°©e
 =
REG_STATE_UNLOADED
) {

924 
has_u∆ﬂded
 = 
TRUE
;

926 
off£t
 +
∑f
->
size
;

928 i‡(!
has_u∆ﬂded
) {

929 #i‡
	`deföed
(
DEBUG_CACHE
)

930 
	`¥ötf
("archive filesálreadyÜoaded\n");

935 i‡(
off£t
 !
n
->
u
.
ªg
.
size
) {

936 #i‡
	`deföed
(
DEBUG_CACHE
)

937 
	`¥ötf
(" inc⁄si°íà¨chivêsize: %" 
PRId64
 " %" PRId64 "\n",

938 
off£t
, 
n
->
u
.
ªg
.
size
);

940 
lﬂd_ÁŒback
;

944 
	`fs_›í_wgë
(
fs1
, 
n
, 
FS_OPEN_WGET_ARCHIVE
);

948 
off£t
 = 0;

949 
	`li°_f‹_óch
(
ñ
, &
∑
->
fûe_li°
) {

950 
∑f
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdArchiveFûe
, 
lök
);

951 
n1
 = 
	`öode_£¨ch_∑th
(
fs1
, 
∑f
->
«me
);

952 i‡(
n1
 &&Ç1->
ty≥
 =
FT_REG
 &&

953 
n1
->
u
.
ªg
.
°©e
 =
REG_STATE_UNLOADED
) {

954 i‡(
n1
->
u
.
ªg
.
size
 =
∑f
->size &&

955 
n1
->
u
.
ªg
.
fûe_id
 =
∑f
->file_id) {

956 
	`fs_›í_wgë
(
fs1
, 
n1
, 
FS_OPEN_WGET_ARCHIVE_FILE
);

957 
	`li°_add_èû
(&
n1
->
u
.
ªg
.
›í_öfo
->
¨chive_lök
,

958 &
n
->
u
.
ªg
.
›í_öfo
->
¨chive_fûe_li°
);

959 
n1
->
u
.
ªg
.
›í_öfo
->
¨chive_off£t
 = 
off£t
;

961 #i‡
	`deföed
(
DEBUG_CACHE
)

962 
	`¥ötf
(" inc⁄si°íà¨chivêfûe: %s\n", 
∑f
->
«me
);

965 
	`fs_¥ñﬂd_fûe
(
fs1
, 
∑f
->
«me
);

968 
off£t
 +
∑f
->
size
;

971 
lﬂd_ÁŒback
:

975 
	`li°_f‹_óch
(
ñ
, &
∑
->
fûe_li°
) {

976 
∑f
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdArchiveFûe
, 
lök
);

977 
	`fs_¥ñﬂd_fûe
(
fs1
, 
∑f
->
«me
);

980 
	}
}

982 
	$fs_¥ñﬂd_fûes
(
FSDevi˚
 *
fs1
, 
FSFûeID
 
fûe_id
)

984 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

985 
li°_hód
 *
ñ
;

986 
PªlﬂdE¡ry
 *
≥
;

987 
PªlﬂdFûe
 *
pf
;

989 
	`li°_f‹_óch
(
ñ
, &
fs
->
¥ñﬂd_li°
) {

990 
≥
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdE¡ry
, 
lök
);

991 i‡(
≥
->
fûe_id
 == file_id)

992 
found
;

995 
found
:

996 
	`li°_f‹_óch
(
ñ
, &
≥
->
fûe_li°
) {

997 
pf
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdFûe
, 
lök
);

998 i‡(
pf
->
is_¨chive
)

999 
	`fs_¥ñﬂd_¨chive
(
fs1
, 
pf
->
«me
);

1001 
	`fs_¥ñﬂd_fûe
(
fs1
, 
pf
->
«me
);

1003 
	}
}

1008 
	$fs_›í
(
FSDevi˚
 *
fs1
, 
FSQID
 *
qid
, 
FSFûe
 *
f
, 
uöt32_t
 
Êags
,

1009 
FSO≥nCom∂ëi⁄Func
 *
cb
, *
›aque
)

1011 
FSINode
 *
n
 = 
f
->
öode
;

1012 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1013 
ªt
;

1015 
	`fs_˛o£
(
fs1
, 
f
);

1017 i‡(
Êags
 & 
P9_O_DIRECTORY
) {

1018 i‡(
n
->
ty≥
 !
FT_DIR
)

1019  -
P9_ENOTDIR
;

1021 i‡(
n
->
ty≥
 !
FT_REG
 &&Ç->ty≥ !
FT_DIR
)

1022  -
P9_EINVAL
;

1024 
f
->
›í_Êags
 = 
Êags
;

1025 i‡(
n
->
ty≥
 =
FT_REG
) {

1026 i‡((
Êags
 & 
P9_O_TRUNC
Ë&& (Êag†& 
P9_O_NOACCESS
Ë!
P9_O_RDONLY
) {

1027 
	`fs_åunˇã
(
fs1
, 
n
, 0);

1030 
n
->
u
.
ªg
.
°©e
) {

1031 
REG_STATE_UNLOADED
:

1033 
FSO≥nInfo
 *
oi
;

1035 
	`fs_¥ñﬂd_fûes
(
fs1
, 
n
->
u
.
ªg
.
fûe_id
);

1037 i‡(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_LOADING
)

1038 
h™dÀ_lﬂdög
;

1039 
ªt
 = 
	`fs_›í_wgë
(
fs1
, 
n
, 
FS_OPEN_WGET_REG
);

1040 i‡(
ªt
)

1041  
ªt
;

1042 
oi
 = 
n
->
u
.
ªg
.
›í_öfo
;

1043 
oi
->
f
 = f;

1044 
oi
->
cb
 = cb;

1045 
oi
->
›aque
 = opaque;

1049 
REG_STATE_LOADING
:

1050 
h™dÀ_lﬂdög
:

1052 
FSO≥nInfo
 *
oi
;

1054 
oi
 = 
n
->
u
.
ªg
.
›í_öfo
;

1055 i‡(
oi
->
cb
)

1056  -
P9_EIO
;

1057 
oi
 = 
n
->
u
.
ªg
.
›í_öfo
;

1058 
oi
->
f
 = f;

1059 
oi
->
cb
 = cb;

1060 
oi
->
›aque
 = opaque;

1064 
REG_STATE_LOCAL
:

1065 
do_›í
;

1066 
REG_STATE_LOADED
:

1068 
	`li°_dñ
(&
n
->
u
.
ªg
.
lök
);

1069 
	`li°_add
(&
n
->
u
.
ªg
.
lök
, &
fs
->
öode_ˇche_li°
);

1070 
do_›í
;

1072 
	`ab‹t
();

1075 
do_›í
:

1076 
f
->
is_›íed
 = 
TRUE
;

1077 
	`öode_to_qid
(
qid
, 
n
);

1080 
	}
}

1082 
	$fs_¸óã
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
FSFûe
 *
f
, c⁄° *
«me
,

1083 
uöt32_t
 
Êags
, uöt32_à
mode
, uöt32_à
gid
)

1085 
FSINode
 *
n1
, *
n
 = 
f
->
öode
;

1087 i‡(
n
->
ty≥
 !
FT_DIR
)

1088  -
P9_ENOTDIR
;

1089 i‡(
	`öode_£¨ch
(
n
, 
«me
)) {

1091  -
P9_EEXIST
;

1093 
	`fs_˛o£
(
fs
, 
f
);

1095 
n1
 = 
	`öode_√w
(
fs
, 
FT_REG
, 
mode
, 
f
->
uid
, 
gid
);

1096 
	`öode_dú_add
(
fs
, 
n
, 
«me
, 
n1
);

1098 
	`öode_dec_›í
(
fs
, 
f
->
öode
);

1099 
f
->
öode
 = 
	`öode_öc_›í
(
fs
, 
n1
);

1100 
f
->
is_›íed
 = 
TRUE
;

1101 
f
->
›í_Êags
 = 
Êags
;

1102 
	`öode_to_qid
(
qid
, 
n1
);

1105 
	}
}

1107 
	$fs_ªaddú
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t1
,

1108 
uöt8_t
 *
buf
, 
cou¡
)

1110 
FSINode
 *
n1
, *
n
 = 
f
->
öode
;

1111 
Àn
, 
pos
, 
«me_Àn
, 
ty≥
;

1112 
li°_hód
 *
ñ
;

1113 
FSDúE¡ry
 *
de
;

1114 
uöt64_t
 
off£t
;

1116 i‡(!
f
->
is_›íed
 || 
n
->
ty≥
 !
FT_DIR
)

1117  -
P9_EPROTO
;

1119 
ñ
 = 
n
->
u
.
dú
.
de_li°
.
√xt
;

1120 
off£t
 = 0;

1121 
off£t
 < 
off£t1
) {

1122 i‡(
ñ
 =&
n
->
u
.
dú
.
de_li°
)

1124 
off£t
++;

1125 
ñ
 =Él->
√xt
;

1128 
pos
 = 0;

1130 i‡(
ñ
 =&
n
->
u
.
dú
.
de_li°
)

1132 
de
 = 
	`li°_íåy
(
ñ
, 
FSDúE¡ry
, 
lök
);

1133 
«me_Àn
 = 
	`°æí
(
de
->
«me
);

1134 
Àn
 = 13 + 8 + 1 + 2 + 
«me_Àn
;

1135 i‡((
pos
 + 
Àn
Ë> 
cou¡
)

1137 
off£t
++;

1138 
n1
 = 
de
->
öode
;

1139 i‡(
n1
->
ty≥
 =
FT_DIR
)

1140 
ty≥
 = 
P9_QTDIR
;

1141 i‡(
n1
->
ty≥
 =
FT_LNK
)

1142 
ty≥
 = 
P9_QTSYMLINK
;

1144 
ty≥
 = 
P9_QTFILE
;

1145 
buf
[
pos
++] = 
ty≥
;

1146 
	`put_À32
(
buf
 + 
pos
, 0);

1147 
pos
 += 4;

1148 
	`put_À64
(
buf
 + 
pos
, 
n1
->
öode_num
);

1149 
pos
 += 8;

1150 
	`put_À64
(
buf
 + 
pos
, 
off£t
);

1151 
pos
 += 8;

1152 
buf
[
pos
++] = 
n1
->
ty≥
;

1153 
	`put_À16
(
buf
 + 
pos
, 
«me_Àn
);

1154 
pos
 += 2;

1155 
	`mem˝y
(
buf
 + 
pos
, 
de
->
«me
, 
«me_Àn
);

1156 
pos
 +
«me_Àn
;

1157 
ñ
 =Él->
√xt
;

1159  
pos
;

1160 
	}
}

1162 
	$fs_ªad
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

1163 
uöt8_t
 *
buf
, 
cou¡
)

1165 
FSINode
 *
n
 = 
f
->
öode
;

1166 
uöt64_t
 
cou¡1
;

1168 i‡(!
f
->
is_›íed
)

1169  -
P9_EPROTO
;

1170 i‡(
n
->
ty≥
 !
FT_REG
)

1171  -
P9_EIO
;

1172 i‡((
f
->
›í_Êags
 & 
P9_O_NOACCESS
Ë=
P9_O_WRONLY
)

1173  -
P9_EIO
;

1174 i‡(
n
->
u
.
ªg
.
is_fscmd
)

1175  
	`fs_cmd_ªad
(
fs
, 
f
, 
off£t
, 
buf
, 
cou¡
);

1176 i‡(
off£t
 >
n
->
u
.
ªg
.
size
)

1178 
cou¡1
 = 
n
->
u
.
ªg
.
size
 - 
off£t
;

1179 i‡(
cou¡1
 < 
cou¡
)

1180 
cou¡
 = 
cou¡1
;

1181 
	`fûe_buf„r_ªad
(&
n
->
u
.
ªg
.
fbuf
, 
off£t
, 
buf
, 
cou¡
);

1182  
cou¡
;

1183 
	}
}

1185 
	$fs_åunˇã
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
, 
uöt64_t
 
size
)

1187 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1188 
öçå_t
 
diff
, 
diff_blocks
;

1189 
size_t
 
√w_Æloˇãd_size
;

1191 i‡(
n
->
ty≥
 !
FT_REG
)

1192  -
P9_EINVAL
;

1193 i‡(
size
 > 
UINTPTR_MAX
)

1194  -
P9_ENOSPC
;

1195 
diff
 = 
size
 - 
n
->
u
.
ªg
.size;

1196 i‡(
diff
 == 0)

1198 
diff_blocks
 = 
	`to_blocks
(
fs
, 
size
Ë-Åo_blocks(fs, 
n
->
u
.
ªg
.size);

1200 
n
->
u
.
ªg
.
°©e
) {

1201 
REG_STATE_LOADING
:

1202  -
P9_EIO
;

1203 
REG_STATE_UNLOADED
:

1204 i‡(
size
 == 0) {

1206 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_LOCAL
;

1209 
REG_STATE_LOADED
:

1210 
REG_STATE_LOCAL
:

1211 i‡(
diff
 > 0) {

1212 i‡((
fs
->
fs_blocks
 + 
diff_blocks
Ë> fs->
fs_max_blocks
)

1213  -
P9_ENOSPC
;

1214 i‡(
size
 > 
n
->
u
.
ªg
.
fbuf
.
Æloˇãd_size
) {

1215 
√w_Æloˇãd_size
 = 
n
->
u
.
ªg
.
fbuf
.
Æloˇãd_size
 * 5 / 4;

1216 i‡(
size
 > 
√w_Æloˇãd_size
)

1217 
√w_Æloˇãd_size
 = 
size
;

1218 i‡(
	`fûe_buf„r_ªsize
(&
n
->
u
.
ªg
.
fbuf
, 
√w_Æloˇãd_size
) < 0)

1219  -
P9_ENOSPC
;

1221 
	`fûe_buf„r_£t
(&
n
->
u
.
ªg
.
fbuf
,Ç->u.ªg.
size
, 0, 
diff
);

1223 
√w_Æloˇãd_size
 = 
n
->
u
.
ªg
.
fbuf
.
Æloˇãd_size
 * 4 / 5;

1224 i‡(
size
 <
√w_Æloˇãd_size
) {

1225 i‡(
	`fûe_buf„r_ªsize
(&
n
->
u
.
ªg
.
fbuf
, 
√w_Æloˇãd_size
) < 0)

1226  -
P9_ENOSPC
;

1230 i‡(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_LOADED
) {

1231 
	`li°_dñ
(&
n
->
u
.
ªg
.
lök
);

1232 
fs
->
öode_ˇche_size
 -
n
->
u
.
ªg
.
size
;

1233 
	`as£π
(
fs
->
öode_ˇche_size
 >= 0);

1234 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_LOCAL
;

1238 
	`ab‹t
();

1240 
fs
->
fs_blocks
 +
diff_blocks
;

1241 
	`as£π
(
fs
->
fs_blocks
 >= 0);

1242 
n
->
u
.
ªg
.
size
 = size;

1244 
	}
}

1246 
	$fs_wrôe
(
FSDevi˚
 *
fs1
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

1247 c⁄° 
uöt8_t
 *
buf
, 
cou¡
)

1249 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1250 
FSINode
 *
n
 = 
f
->
öode
;

1251 
uöt64_t
 
íd
;

1252 
îr
;

1254 i‡(!
f
->
is_›íed
)

1255  -
P9_EPROTO
;

1256 i‡(
n
->
ty≥
 !
FT_REG
)

1257  -
P9_EIO
;

1258 i‡((
f
->
›í_Êags
 & 
P9_O_NOACCESS
Ë=
P9_O_RDONLY
)

1259  -
P9_EIO
;

1260 i‡(
cou¡
 == 0)

1262 i‡(
n
->
u
.
ªg
.
is_fscmd
) {

1263  
	`fs_cmd_wrôe
(
fs1
, 
f
, 
off£t
, 
buf
, 
cou¡
);

1265 
íd
 = 
off£t
 + 
cou¡
;

1266 i‡(
íd
 > 
n
->
u
.
ªg
.
size
) {

1267 
îr
 = 
	`fs_åunˇã
(
fs1
, 
n
, 
íd
);

1268 i‡(
îr
)

1269  
îr
;

1271 
	`öode_upd©e_mtime
(
fs1
, 
n
);

1273 i‡(
n
->
u
.
ªg
.
°©e
 =
REG_STATE_LOADED
) {

1274 
	`li°_dñ
(&
n
->
u
.
ªg
.
lök
);

1275 
fs
->
öode_ˇche_size
 -
n
->
u
.
ªg
.
size
;

1276 
	`as£π
(
fs
->
öode_ˇche_size
 >= 0);

1277 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_LOCAL
;

1279 
	`fûe_buf„r_wrôe
(&
n
->
u
.
ªg
.
fbuf
, 
off£t
, 
buf
, 
cou¡
);

1280  
cou¡
;

1281 
	}
}

1283 
	$fs_˛o£
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
)

1285 i‡(
f
->
is_›íed
) {

1286 
f
->
is_›íed
 = 
FALSE
;

1288 i‡(
f
->
ªq
)

1289 
	`fs_cmd_˛o£
(
fs
, 
f
);

1290 
	}
}

1292 
	$fs_°©
(
FSDevi˚
 *
fs1
, 
FSFûe
 *
f
, 
FSSèt
 *
°
)

1294 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1295 
FSINode
 *
n
 = 
f
->
öode
;

1297 
	`öode_to_qid
(&
°
->
qid
, 
n
);

1298 
°
->
°_mode
 = 
n
->
mode
 | (n->
ty≥
 << 12);

1299 
°
->
°_uid
 = 
n
->
uid
;

1300 
°
->
°_gid
 = 
n
->
gid
;

1301 
°
->
°_∆ök
 = 
n
->
ªfcou¡
;

1302 i‡(
n
->
ty≥
 =
FT_BLK
 ||Ç->ty≥ =
FT_CHR
) {

1304 
°
->
°_rdev
 = (
n
->
u
.
dev
.
maj‹
 << 8Ë|Ç->u.dev.
mö‹
;

1306 
°
->
°_rdev
 = 0;

1308 
°
->
°_blksize
 = 
fs
->
block_size
;

1309 i‡(
n
->
ty≥
 =
FT_REG
) {

1310 
°
->
°_size
 = 
n
->
u
.
ªg
.
size
;

1311 } i‡(
n
->
ty≥
 =
FT_LNK
) {

1312 
°
->
°_size
 = 
	`°æí
(
n
->
u
.
symlök
.
«me
);

1313 } i‡(
n
->
ty≥
 =
FT_DIR
) {

1314 
°
->
°_size
 = 
n
->
u
.
dú
.
size
;

1316 
°
->
°_size
 = 0;

1319 
°
->
°_blocks
 = 
	`to_blocks
(
fs
, st->
°_size
Ë<< (fs->
block_size_log2
 - 9);

1322 
°
->
°_©ime_£c
 = 
n
->
mtime_£c
;

1323 
°
->
°_©ime_n£c
 = 
n
->
mtime_n£c
;

1324 
°
->
°_mtime_£c
 = 
n
->
mtime_£c
;

1325 
°
->
°_mtime_n£c
 = 
n
->
mtime_n£c
;

1326 
°
->
°_˘ime_£c
 = 
n
->
˘ime_£c
;

1327 
°
->
°_˘ime_n£c
 = 
n
->
˘ime_n£c
;

1329 
	}
}

1331 
	$fs_£èâr
(
FSDevi˚
 *
fs1
, 
FSFûe
 *
f
, 
uöt32_t
 
mask
,

1332 
uöt32_t
 
mode
, uöt32_à
uid
, uöt32_à
gid
,

1333 
uöt64_t
 
size
, uöt64_à
©ime_£c
, uöt64_à
©ime_n£c
,

1334 
uöt64_t
 
mtime_£c
, uöt64_à
mtime_n£c
)

1336 
FSINode
 *
n
 = 
f
->
öode
;

1337 
ªt
;

1339 i‡(
mask
 & 
P9_SETATTR_MODE
) {

1340 
n
->
mode
 = mode;

1342 i‡(
mask
 & 
P9_SETATTR_UID
) {

1343 
n
->
uid
 = uid;

1345 i‡(
mask
 & 
P9_SETATTR_GID
) {

1346 
n
->
gid
 = gid;

1348 i‡(
mask
 & 
P9_SETATTR_SIZE
) {

1349 
ªt
 = 
	`fs_åunˇã
(
fs1
, 
n
, 
size
);

1350 i‡(
ªt
)

1351  
ªt
;

1353 i‡(
mask
 & 
P9_SETATTR_MTIME
) {

1354 i‡(
mask
 & 
P9_SETATTR_MTIME_SET
) {

1355 
n
->
mtime_£c
 = mtime_sec;

1356 
n
->
mtime_n£c
 = mtime_nsec;

1358 
	`öode_upd©e_mtime
(
fs1
, 
n
);

1361 i‡(
mask
 & 
P9_SETATTR_CTIME
) {

1362 
timevÆ
 
tv
;

1363 
	`gëtimeofday
(&
tv
, 
NULL
);

1364 
n
->
˘ime_£c
 = 
tv
.
tv_£c
;

1365 
n
->
˘ime_n£c
 = 
tv
.
tv_u£c
 * 1000;

1368 
	}
}

1370 
	$fs_lök
(
FSDevi˚
 *
fs
, 
FSFûe
 *
df
, FSFûê*
f
, c⁄° *
«me
)

1372 
FSINode
 *
n
 = 
df
->
öode
;

1374 i‡(
f
->
öode
->
ty≥
 =
FT_DIR
)

1375  -
P9_EPERM
;

1376 i‡(
	`öode_£¨ch
(
n
, 
«me
))

1377  -
P9_EEXIST
;

1378 
	`öode_dú_add
(
fs
, 
n
, 
«me
, 
	`öode_ö¸ef
(fs, 
f
->
öode
));

1380 
	}
}

1382 
	$fs_symlök
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
,

1383 
FSFûe
 *
f
, c⁄° *
«me
, c⁄° *
symgt
, 
uöt32_t
 
gid
)

1385 
FSINode
 *
n1
, *
n
 = 
f
->
öode
;

1387 i‡(
	`öode_£¨ch
(
n
, 
«me
))

1388  -
P9_EEXIST
;

1390 
n1
 = 
	`öode_√w
(
fs
, 
FT_LNK
, 0777, 
f
->
uid
, 
gid
);

1391 
n1
->
u
.
symlök
.
«me
 = 
	`°rdup
(
symgt
);

1392 
	`öode_dú_add
(
fs
, 
n
, 
«me
, 
n1
);

1393 
	`öode_to_qid
(
qid
, 
n1
);

1395 
	}
}

1397 
	$fs_mknod
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
,

1398 
FSFûe
 *
f
, c⁄° *
«me
, 
uöt32_t
 
mode
, uöt32_à
maj‹
,

1399 
uöt32_t
 
mö‹
, uöt32_à
gid
)

1401 
ty≥
;

1402 
FSINode
 *
n1
, *
n
 = 
f
->
öode
;

1404 
ty≥
 = (
mode
 & 
P9_S_IFMT
) >> 12;

1406 i‡(
ty≥
 !
FT_FIFO
 &&Åy≥ !
FT_CHR
 &&Åy≥ !
FT_BLK
 &&

1407 
ty≥
 !
FT_REG
 &&Åy≥ !
FT_SOCK
)

1408  -
P9_EINVAL
;

1409 i‡(
	`öode_£¨ch
(
n
, 
«me
))

1410  -
P9_EEXIST
;

1411 
n1
 = 
	`öode_√w
(
fs
, 
ty≥
, 
mode
, 
f
->
uid
, 
gid
);

1412 i‡(
ty≥
 =
FT_CHR
 ||Åy≥ =
FT_BLK
) {

1413 
n1
->
u
.
dev
.
maj‹
 = major;

1414 
n1
->
u
.
dev
.
mö‹
 = minor;

1416 
	`öode_dú_add
(
fs
, 
n
, 
«me
, 
n1
);

1417 
	`öode_to_qid
(
qid
, 
n1
);

1419 
	}
}

1421 
	$fs_ªadlök
(
FSDevi˚
 *
fs
, *
buf
, 
buf_size
, 
FSFûe
 *
f
)

1423 
FSINode
 *
n
 = 
f
->
öode
;

1424 
Àn
;

1425 i‡(
n
->
ty≥
 !
FT_LNK
)

1426  -
P9_EIO
;

1427 
Àn
 = 
	`mö_öt
(
	`°æí
(
n
->
u
.
symlök
.
«me
), 
buf_size
 - 1);

1428 
	`mem˝y
(
buf
, 
n
->
u
.
symlök
.
«me
, 
Àn
);

1429 
buf
[
Àn
] = '\0';

1431 
	}
}

1433 
	$fs_ª«mót
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
«me
,

1434 
FSFûe
 *
√w_f
, c⁄° *
√w_«me
)

1436 
FSDúE¡ry
 *
de
, *
de1
;

1437 
FSINode
 *
n1
;

1439 
de
 = 
	`öode_£¨ch
(
f
->
öode
, 
«me
);

1440 i‡(!
de
)

1441  -
P9_ENOENT
;

1442 
de1
 = 
	`öode_£¨ch
(
√w_f
->
öode
, 
√w_«me
);

1443 
n1
 = 
NULL
;

1444 i‡(
de1
) {

1445 
n1
 = 
de1
->
öode
;

1446 i‡(
n1
->
ty≥
 =
FT_DIR
)

1447  -
P9_EEXIST
;

1448 
	`öode_dúít_dñëe_no_de¸ef
(
fs
, 
√w_f
->
öode
, 
de1
);

1450 
	`öode_dú_add
(
fs
, 
√w_f
->
öode
, 
√w_«me
, 
	`öode_ö¸ef
(fs, 
de
->inode));

1451 
	`öode_dúít_dñëe
(
fs
, 
f
->
öode
, 
de
);

1452 i‡(
n1
)

1453 
	`öode_de¸ef
(
fs
, 
n1
);

1455 
	}
}

1457 
	$fs_u∆ök©
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
«me
)

1459 
FSDúE¡ry
 *
de
;

1460 
FSINode
 *
n
;

1462 i‡(!
	`°rcmp
(
«me
, ".") || !strcmp(name, ".."))

1463  -
P9_ENOENT
;

1464 
de
 = 
	`öode_£¨ch
(
f
->
öode
, 
«me
);

1465 i‡(!
de
)

1466  -
P9_ENOENT
;

1467 
n
 = 
de
->
öode
;

1468 i‡(
n
->
ty≥
 =
FT_DIR
) {

1469 i‡(!
	`is_em±y_dú
(
fs
, 
n
))

1470  -
P9_ENOTEMPTY
;

1471 
	`Êush_dú
(
fs
, 
n
);

1473 
	`öode_dúít_dñëe
(
fs
, 
f
->
öode
, 
de
);

1475 
	}
}

1477 
	$fs_lock
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° 
FSLock
 *
lock
)

1479 
FSINode
 *
n
 = 
f
->
öode
;

1480 i‡(!
f
->
is_›íed
)

1481  -
P9_EPROTO
;

1482 i‡(
n
->
ty≥
 !
FT_REG
)

1483  -
P9_EIO
;

1485  
P9_LOCK_SUCCESS
;

1486 
	}
}

1488 
	$fs_gëlock
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
FSLock
 *
lock
)

1490 
FSINode
 *
n
 = 
f
->
öode
;

1491 i‡(!
f
->
is_›íed
)

1492  -
P9_EPROTO
;

1493 i‡(
n
->
ty≥
 !
FT_REG
)

1494  -
P9_EIO
;

1497 
	}
}

1500 
	$fs_mem_íd
(
FSDevi˚
 *
fs1
)

1502 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1503 
li°_hód
 *
ñ
, *
ñ1
, *
ñ2
, *
ñ3
;

1504 
FSINode
 *
n
;

1505 
FSDúE¡ry
 *
de
;

1507 
	`li°_f‹_óch_ß„
(
ñ
, 
ñ1
, &
fs
->
öode_li°
) {

1508 
n
 = 
	`li°_íåy
(
ñ
, 
FSINode
, 
lök
);

1509 
n
->
ªfcou¡
 = 0;

1510 i‡(
n
->
ty≥
 =
FT_DIR
) {

1511 
	`li°_f‹_óch_ß„
(
ñ2
, 
ñ3
, &
n
->
u
.
dú
.
de_li°
) {

1512 
de
 = 
	`li°_íåy
(
ñ2
, 
FSDúE¡ry
, 
lök
);

1513 
	`li°_dñ
(&
de
->
lök
);

1514 
	`‰ì
(
de
);

1516 
	`öô_li°_hód
(&
n
->
u
.
dú
.
de_li°
);

1518 
	`öode_‰ì
(
fs1
, 
n
);

1520 
	`as£π
(
	`li°_em±y
(&
fs
->
öode_ˇche_li°
));

1521 
	`‰ì
(
fs
->
imp‹t_dú
);

1522 
	}
}

1524 
FSDevi˚
 *
	$fs_mem_öô
()

1526 
FSDevi˚Mem
 *
fs
;

1527 
FSDevi˚
 *
fs1
;

1528 
FSINode
 *
n
;

1530 
fs
 = 
	`mÆlocz
((*fs));

1531 
fs1
 = &
fs
->
comm⁄
;

1533 
fs
->
comm⁄
.
fs_íd
 = 
fs_mem_íd
;

1534 
fs
->
comm⁄
.
fs_dñëe
 = fs_delete;

1535 
fs
->
comm⁄
.
fs_°©fs
 = fs_statfs;

1536 
fs
->
comm⁄
.
fs_©èch
 = fs_attach;

1537 
fs
->
comm⁄
.
fs_wÆk
 = fs_walk;

1538 
fs
->
comm⁄
.
fs_mkdú
 = fs_mkdir;

1539 
fs
->
comm⁄
.
fs_›í
 = fs_open;

1540 
fs
->
comm⁄
.
fs_¸óã
 = fs_create;

1541 
fs
->
comm⁄
.
fs_°©
 = fs_stat;

1542 
fs
->
comm⁄
.
fs_£èâr
 = fs_setattr;

1543 
fs
->
comm⁄
.
fs_˛o£
 = fs_close;

1544 
fs
->
comm⁄
.
fs_ªaddú
 = fs_readdir;

1545 
fs
->
comm⁄
.
fs_ªad
 = fs_read;

1546 
fs
->
comm⁄
.
fs_wrôe
 = fs_write;

1547 
fs
->
comm⁄
.
fs_lök
 = fs_link;

1548 
fs
->
comm⁄
.
fs_symlök
 = fs_symlink;

1549 
fs
->
comm⁄
.
fs_mknod
 = fs_mknod;

1550 
fs
->
comm⁄
.
fs_ªadlök
 = fs_readlink;

1551 
fs
->
comm⁄
.
fs_ª«mót
 = fs_renameat;

1552 
fs
->
comm⁄
.
fs_u∆ök©
 = fs_unlinkat;

1553 
fs
->
comm⁄
.
fs_lock
 = fs_lock;

1554 
fs
->
comm⁄
.
fs_gëlock
 = fs_getlock;

1556 
	`öô_li°_hód
(&
fs
->
öode_li°
);

1557 
fs
->
öode_num_Æloc
 = 1;

1558 
fs
->
block_size_log2
 = 
FS_BLOCK_SIZE_LOG2
;

1559 
fs
->
block_size
 = 1 << fs->
block_size_log2
;

1560 
fs
->
öode_limô
 = 1 << 20;

1561 
fs
->
fs_max_blocks
 = 1 << (30 - fs->
block_size_log2
);

1563 
	`öô_li°_hód
(&
fs
->
öode_ˇche_li°
);

1564 
fs
->
öode_ˇche_size_limô
 = 
DEFAULT_INODE_CACHE_SIZE
;

1566 
	`öô_li°_hód
(&
fs
->
¥ñﬂd_li°
);

1567 
	`öô_li°_hód
(&
fs
->
¥ñﬂd_¨chive_li°
);

1569 
	`öô_li°_hód
(&
fs
->
ba£_uæ_li°
);

1572 
n
 = 
	`öode_√w
(
fs1
, 
FT_DIR
, 0777, 0, 0);

1573 
	`öode_dú_add
(
fs1
, 
n
, ".", 
	`öode_ö¸ef
(fs1,Ç));

1574 
	`öode_dú_add
(
fs1
, 
n
, "..", 
	`öode_ö¸ef
(fs1,Ç));

1575 
fs
->
roŸ_öode
 = 
n
;

1577  (
FSDevi˚
 *)
fs
;

1578 
	}
}

1580 
BOOL
 
	$fs_is_√t
(
FSDevi˚
 *
fs
)

1582  (
fs
->
fs_íd
 =
fs_mem_íd
);

1583 
	}
}

1585 
FSBa£URL
 *
	$fs_föd_ba£_uæ
(
FSDevi˚
 *
fs1
,

1586 c⁄° *
ba£_uæ_id
)

1588 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1589 
li°_hód
 *
ñ
;

1590 
FSBa£URL
 *
bu
;

1592 
	`li°_f‹_óch
(
ñ
, &
fs
->
ba£_uæ_li°
) {

1593 
bu
 = 
	`li°_íåy
(
ñ
, 
FSBa£URL
, 
lök
);

1594 i‡(!
	`°rcmp
(
bu
->
ba£_uæ_id
, base_url_id))

1595  
bu
;

1597  
NULL
;

1598 
	}
}

1600 
	$fs_ba£_uæ_de¸ef
(
FSDevi˚
 *
fs
, 
FSBa£URL
 *
bu
)

1602 
	`as£π
(
bu
->
ªf_cou¡
 >= 1);

1603 i‡(--
bu
->
ªf_cou¡
 == 0) {

1604 
	`‰ì
(
bu
->
ba£_uæ_id
);

1605 
	`‰ì
(
bu
->
uæ
);

1606 
	`‰ì
(
bu
->
u£r
);

1607 
	`‰ì
(
bu
->
∑ssw‹d
);

1608 
	`li°_dñ
(&
bu
->
lök
);

1609 
	`‰ì
(
bu
);

1611 
	}
}

1613 
FSBa£URL
 *
	$fs_√t_£t_ba£_uæ
(
FSDevi˚
 *
fs1
,

1614 c⁄° *
ba£_uæ_id
,

1615 c⁄° *
uæ
,

1616 c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

1617 
AES_KEY
 *
´s_°©e
)

1619 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1620 
FSBa£URL
 *
bu
;

1622 
	`as£π
(
	`fs_is_√t
(
fs1
));

1623 
bu
 = 
	`fs_föd_ba£_uæ
(
fs1
, 
ba£_uæ_id
);

1624 i‡(!
bu
) {

1625 
bu
 = 
	`mÆlocz
((*bu));

1626 
bu
->
ba£_uæ_id
 = 
	`°rdup
(base_url_id);

1627 
bu
->
ªf_cou¡
 = 1;

1628 
	`li°_add_èû
(&
bu
->
lök
, &
fs
->
ba£_uæ_li°
);

1630 
	`‰ì
(
bu
->
uæ
);

1631 
	`‰ì
(
bu
->
u£r
);

1632 
	`‰ì
(
bu
->
∑ssw‹d
);

1635 
bu
->
uæ
 = 
	`°rdup
(url);

1636 i‡(
u£r
)

1637 
bu
->
u£r
 = 
	`°rdup
(user);

1639 
bu
->
u£r
 = 
NULL
;

1640 i‡(
∑ssw‹d
)

1641 
bu
->
∑ssw‹d
 = 
	`°rdup
(password);

1643 
bu
->
∑ssw‹d
 = 
NULL
;

1644 i‡(
´s_°©e
) {

1645 
bu
->
í¸y±ed
 = 
TRUE
;

1646 
bu
->
´s_°©e
 = *aes_state;

1648 
bu
->
í¸y±ed
 = 
FALSE
;

1650  
bu
;

1651 
	}
}

1653 
	$fs_√t_ª£t_ba£_uæ
(
FSDevi˚
 *
fs1
,

1654 c⁄° *
ba£_uæ_id
)

1656 
FSBa£URL
 *
bu
;

1658 
	`as£π
(
	`fs_is_√t
(
fs1
));

1659 
bu
 = 
	`fs_föd_ba£_uæ
(
fs1
, 
ba£_uæ_id
);

1660 i‡(!
bu
)

1661  -
P9_ENOENT
;

1662 
	`fs_ba£_uæ_de¸ef
(
fs1
, 
bu
);

1664 
	}
}

1666 
	$fs_√t_£t_fs_max_size
(
FSDevi˚
 *
fs1
, 
uöt64_t
 
fs_max_size
)

1668 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1670 
	`as£π
(
	`fs_is_√t
(
fs1
));

1671 
fs
->
fs_max_blocks
 = 
	`to_blocks
(fs, 
fs_max_size
);

1672 
	}
}

1674 
	$fs_√t_£t_uæ
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
,

1675 c⁄° *
ba£_uæ_id
, 
FSFûeID
 
fûe_id
, 
uöt64_t
 
size
)

1677 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1678 
FSBa£URL
 *
bu
;

1680 
	`as£π
(
	`fs_is_√t
(
fs1
));

1682 
bu
 = 
	`fs_föd_ba£_uæ
(
fs1
, 
ba£_uæ_id
);

1683 i‡(!
bu
)

1684  -
P9_ENOENT
;

1687 i‡(
n
->
ty≥
 !
FT_REG
 ||

1688 
n
->
u
.
ªg
.
°©e
 !
REG_STATE_LOCAL
 ||

1689 
n
->
u
.
ªg
.
fbuf
.
Æloˇãd_size
 != 0)

1690  -
P9_EIO
;

1692 i‡(
size
 > 0) {

1693 
n
->
u
.
ªg
.
°©e
 = 
REG_STATE_UNLOADED
;

1694 
n
->
u
.
ªg
.
ba£_uæ
 = 
bu
;

1695 
bu
->
ªf_cou¡
++;

1696 
n
->
u
.
ªg
.
size
 = size;

1697 
fs
->
fs_blocks
 +
	`to_blocks
(fs, 
size
);

1698 
n
->
u
.
ªg
.
fûe_id
 = file_id;

1701 
	}
}

1703 #ifde‡
DUMP_CACHE_LOAD


1705 
	~"js⁄.h
"

1707 
	#ARCHIVE_SIZE_MAX
 (4 << 20)

	)

1709 
	$fs_dump_add_fûe
(
li°_hód
 *
hód
, c⁄° *
«me
)

1711 
PªlﬂdFûe
 *
pf
;

1712 
pf
 = 
	`mÆlocz
((*pf));

1713 
pf
->
«me
 = 
	`°rdup
(name);

1714 
	`li°_add_èû
(&
pf
->
lök
, 
hód
);

1715 
	}
}

1717 
PªlﬂdFûe
 *
	$fs_dump_föd_fûe
(
li°_hód
 *
hód
, c⁄° *
«me
)

1719 
PªlﬂdFûe
 *
pf
;

1720 
li°_hód
 *
ñ
;

1721 
	`li°_f‹_óch
(
ñ
, 
hód
) {

1722 
pf
 = 
	`li°_íåy
(
ñ
, 
PªlﬂdFûe
, 
lök
);

1723 i‡(!
	`°rcmp
(
pf
->
«me
,Çame))

1724  
pf
;

1726  
NULL
;

1727 
	}
}

1729 
	$dump_˛o£_¨chive
(
FSDevi˚
 *
fs1
)

1731 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1732 i‡(
fs
->
dump_¨chive_fûe
) {

1733 
	`f˛o£
(
fs
->
dump_¨chive_fûe
);

1735 
fs
->
dump_¨chive_fûe
 = 
NULL
;

1736 
fs
->
dump_¨chive_size
 = 0;

1737 
	}
}

1739 
	$dump_lﬂded_fûe
(
FSDevi˚
 *
fs1
, 
FSINode
 *
n
)

1741 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1742 
fûíame
[1024];

1743 c⁄° *
‚ame
, *
p
;

1745 i‡(!
fs
->
dump_ˇche_lﬂd
 || !
n
->
u
.
ªg
.
fûíame
)

1747 
‚ame
 = 
n
->
u
.
ªg
.
fûíame
;

1749 i‡(
	`fs_dump_föd_fûe
(&
fs
->
dump_¥ñﬂd_li°
, 
‚ame
)) {

1750 
	`dump_˛o£_¨chive
(
fs1
);

1751 
p
 = 
	`°ºchr
(
‚ame
, '/');

1752 i‡(!
p
)

1753 
p
 = 
‚ame
;

1755 
p
++;

1756 
	`‰ì
(
fs
->
dump_¨chive_«me
);

1757 
fs
->
dump_¨chive_«me
 = 
	`°rdup
(
p
);

1758 
fs
->
dump_°¨ãd
 = 
TRUE
;

1759 
fs
->
dump_¨chive_num
 = 0;

1761 
	`Ârötf
(
fs
->
dump_¥ñﬂd_fûe
, "\n%†:\n", 
‚ame
);

1763 i‡(!
fs
->
dump_°¨ãd
)

1766 i‡(!
fs
->
dump_¨chive_fûe
) {

1767 
	`¢¥ötf
(
fûíame
, (filename), "%s/%s%d",

1768 
fs
->
dump_¥ñﬂd_dú
, fs->
dump_¨chive_«me
,

1769 
fs
->
dump_¨chive_num
);

1770 
fs
->
dump_¨chive_fûe
 = 
	`f›í
(
fûíame
, "wb");

1771 i‡(!
fs
->
dump_¨chive_fûe
) {

1772 
	`≥º‹
(
fûíame
);

1773 
	`exô
(1);

1775 
	`Ârötf
(
fs
->
dump_¥ñﬂd_¨chive_fûe
, "\n@.preload2/%s%d :\n",

1776 
fs
->
dump_¨chive_«me
, fs->
dump_¨chive_num
);

1777 
	`Ârötf
(
fs
->
dump_¥ñﬂd_fûe
, " @.preload2/%s%d\n",

1778 
fs
->
dump_¨chive_«me
, fs->
dump_¨chive_num
);

1779 
	`fÊush
(
fs
->
dump_¥ñﬂd_fûe
);

1780 
fs
->
dump_¨chive_num
++;

1783 i‡(
n
->
u
.
ªg
.
size
 >
ARCHIVE_SIZE_MAX
) {

1786 
	`Ârötf
(
fs
->
dump_¥ñﬂd_fûe
, " %†%" 
PRId64
 "\n",

1787 
‚ame
, 
n
->
u
.
ªg
.
size
);

1788 
	`fÊush
(
fs
->
dump_¥ñﬂd_fûe
);

1790 
	`Ârötf
(
fs
->
dump_¥ñﬂd_¨chive_fûe
, " %†%" 
PRId64
 " %" 
PRIx64
 "\n",

1791 
n
->
u
.
ªg
.
fûíame
,Ç->u.ªg.
size
,Ç->u.ªg.
fûe_id
);

1792 
	`fÊush
(
fs
->
dump_¥ñﬂd_¨chive_fûe
);

1793 
	`fwrôe
(
n
->
u
.
ªg
.
fbuf
.
d©a
, 1,Ç->u.ªg.
size
, 
fs
->
dump_¨chive_fûe
);

1794 
	`fÊush
(
fs
->
dump_¨chive_fûe
);

1795 
fs
->
dump_¨chive_size
 +
n
->
u
.
ªg
.
size
;

1796 i‡(
fs
->
dump_¨chive_size
 >
ARCHIVE_SIZE_MAX
) {

1797 
	`dump_˛o£_¨chive
(
fs1
);

1800 
	}
}

1802 
JSONVÆue
 
	$js⁄_lﬂd
(c⁄° *
fûíame
)

1804 
FILE
 *
f
;

1805 
JSONVÆue
 
vÆ
;

1806 
size_t
 
size
;

1807 *
buf
;

1809 
f
 = 
	`f›í
(
fûíame
, "rb");

1810 i‡(!
f
) {

1811 
	`≥º‹
(
fûíame
);

1812 
	`exô
(1);

1814 
	`f£ek
(
f
, 0, 
SEEK_END
);

1815 
size
 = 
	`·ñl
(
f
);

1816 
	`f£ek
(
f
, 0, 
SEEK_SET
);

1817 
buf
 = 
	`mÆloc
(
size
 + 1);

1818 
	`‰ód
(
buf
, 1, 
size
, 
f
);

1819 
	`f˛o£
(
f
);

1820 
vÆ
 = 
	`js⁄_∑r£_vÆue_Àn
(
buf
, 
size
);

1821 
	`‰ì
(
buf
);

1822  
vÆ
;

1823 
	}
}

1825 
	$fs_dump_ˇche_lﬂd
(
FSDevi˚
 *
fs1
, c⁄° *
cfg_fûíame
)

1827 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

1828 
JSONVÆue
 
cfg
, 
vÆ
, 
¨øy
;

1829 *
‚ame
;

1830 c⁄° *
¥ñﬂd_dú
, *
«me
;

1831 
i
;

1833 i‡(!
	`fs_is_√t
(
fs1
))

1835 
cfg
 = 
	`js⁄_lﬂd
(
cfg_fûíame
);

1836 i‡(
	`js⁄_is_îr‹
(
cfg
)) {

1837 
	`Ârötf
(
°dîr
, "%s\n", 
	`js⁄_gë_îr‹
(
cfg
));

1838 
	`exô
(1);

1841 
vÆ
 = 
	`js⁄_obje˘_gë
(
cfg
, "preload_dir");

1842 i‡(
	`js⁄_is_undeföed
(
cfg
)) {

1843 
c⁄fig_îr‹
:

1844 
	`exô
(1);

1846 
¥ñﬂd_dú
 = 
	`js⁄_gë_°r
(
vÆ
);

1847 i‡(!
¥ñﬂd_dú
) {

1848 
	`Ârötf
(
°dîr
, "expectingÖreload_filename\n");

1849 
c⁄fig_îr‹
;

1851 
fs
->
dump_¥ñﬂd_dú
 = 
	`°rdup
(
¥ñﬂd_dú
);

1853 
	`öô_li°_hód
(&
fs
->
dump_¥ñﬂd_li°
);

1854 
	`öô_li°_hód
(&
fs
->
dump_ex˛ude_li°
);

1856 
¨øy
 = 
	`js⁄_obje˘_gë
(
cfg
, "preload");

1857 i‡(
¨øy
.
ty≥
 !
JSON_ARRAY
) {

1858 
	`Ârötf
(
°dîr
, "expectingÖreloadárray\n");

1859 
c⁄fig_îr‹
;

1861 
i
 = 0; i < 
¨øy
.
u
.¨øy->
Àn
; i++) {

1862 
vÆ
 = 
	`js⁄_¨øy_gë
(
¨øy
, 
i
);

1863 
«me
 = 
	`js⁄_gë_°r
(
vÆ
);

1864 i‡(!
«me
) {

1865 
	`Ârötf
(
°dîr
, "expectingá string\n");

1866 
c⁄fig_îr‹
;

1868 
	`fs_dump_add_fûe
(&
fs
->
dump_¥ñﬂd_li°
, 
«me
);

1870 
	`js⁄_‰ì
(
cfg
);

1872 
‚ame
 = 
	`compo£_∑th
(
fs
->
dump_¥ñﬂd_dú
, "preload.txt");

1873 
fs
->
dump_¥ñﬂd_fûe
 = 
	`f›í
(
‚ame
, "w");

1874 i‡(!
fs
->
dump_¥ñﬂd_fûe
) {

1875 
	`≥º‹
(
‚ame
);

1876 
	`exô
(1);

1878 
	`‰ì
(
‚ame
);

1880 
‚ame
 = 
	`compo£_∑th
(
fs
->
dump_¥ñﬂd_dú
, "preload_archive.txt");

1881 
fs
->
dump_¥ñﬂd_¨chive_fûe
 = 
	`f›í
(
‚ame
, "w");

1882 i‡(!
fs
->
dump_¥ñﬂd_¨chive_fûe
) {

1883 
	`≥º‹
(
‚ame
);

1884 
	`exô
(1);

1886 
	`‰ì
(
‚ame
);

1888 
fs
->
dump_ˇche_lﬂd
 = 
TRUE
;

1889 
	}
}

1891 
	$fs_dump_ˇche_lﬂd
(
FSDevi˚
 *
fs1
, c⁄° *
cfg_fûíame
)

1893 
	}
}

1899 
	$fûñi°_lﬂd_ªc
(
FSDevi˚
 *
fs1
, c⁄° **
µ
, 
FSINode
 *
dú
,

1900 c⁄° *
∑th
)

1903 
‚ame
[1024], 
 ame
[1024];

1904 
ªt
;

1905 c⁄° *
p
;

1906 
FSINodeTy≥Enum
 
ty≥
;

1907 
uöt32_t
 
mode
, 
uid
, 
gid
;

1908 
uöt64_t
 
size
;

1909 
FSINode
 *
n
;

1911 
p
 = *
µ
;

1914 i‡(*
p
 == '\0')

1916 i‡(*
p
 == '#') {

1917 
	`skù_löe
(&
p
);

1921 i‡(*
p
 == '.') {

1922 
p
++;

1923 
	`skù_löe
(&
p
);

1926 i‡(
	`∑r£_uöt32_ba£
(&
mode
, &
p
, 8) < 0) {

1927 
	`Ârötf
(
°dîr
, "invalid mode\n");

1930 
ty≥
 = 
mode
 >> 12;

1931 
mode
 &= 0xfff;

1933 i‡(
	`∑r£_uöt32
(&
uid
, &
p
) < 0) {

1934 
	`Ârötf
(
°dîr
, "invalid uid\n");

1938 i‡(
	`∑r£_uöt32
(&
gid
, &
p
) < 0) {

1939 
	`Ârötf
(
°dîr
, "invalid gid\n");

1943 
n
 = 
	`öode_√w
(
fs1
, 
ty≥
, 
mode
, 
uid
, 
gid
);

1945 
size
 = 0;

1946 
ty≥
) {

1947 
FT_CHR
:

1948 
FT_BLK
:

1949 i‡(
	`∑r£_uöt32
(&
n
->
u
.
dev
.
maj‹
, &
p
) < 0) {

1950 
	`Ârötf
(
°dîr
, "invalid major\n");

1953 i‡(
	`∑r£_uöt32
(&
n
->
u
.
dev
.
mö‹
, &
p
) < 0) {

1954 
	`Ârötf
(
°dîr
, "invalid minor\n");

1958 
FT_REG
:

1959 i‡(
	`∑r£_uöt64
(&
size
, &
p
) < 0) {

1960 
	`Ârötf
(
°dîr
, "invalid size\n");

1964 
FT_DIR
:

1965 
	`öode_dú_add
(
fs1
, 
n
, ".", 
	`öode_ö¸ef
(fs1,Ç));

1966 
	`öode_dú_add
(
fs1
, 
n
, "..", 
	`öode_ö¸ef
(fs1, 
dú
));

1973 i‡(
	`∑r£_time
(&
n
->
mtime_£c
, &n->
mtime_n£c
, &
p
) < 0) {

1974 
	`Ârötf
(
°dîr
, "invalid mtime\n");

1978 i‡(
	`∑r£_‚ame
(
‚ame
, (‚ame), &
p
) < 0) {

1979 
	`Ârötf
(
°dîr
, "invalid filename\n");

1982 
	`öode_dú_add
(
fs1
, 
dú
, 
‚ame
, 
n
);

1984 i‡(
ty≥
 =
FT_LNK
) {

1985 i‡(
	`∑r£_‚ame
(
 ame
, ÷«me), &
p
) < 0) {

1986 
	`Ârötf
(
°dîr
, "invalid symlinkÇame\n");

1989 
n
->
u
.
symlök
.
«me
 = 
	`°rdup
(
 ame
);

1990 } i‡(
ty≥
 =
FT_REG
 && 
size
 > 0) {

1991 
FSFûeID
 
fûe_id
;

1992 i‡(
	`∑r£_fûe_id
(&
fûe_id
, &
p
) < 0) {

1993 
	`Ârötf
(
°dîr
, "invalid file id\n");

1996 
	`fs_√t_£t_uæ
(
fs1
, 
n
, "/", 
fûe_id
, 
size
);

1997 #ifde‡
DUMP_CACHE_LOAD


1999 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

2000 i‡(
fs
->
dump_ˇche_lﬂd


2001 #ifde‡
DEBUG_CACHE


2005 
n
->
u
.
ªg
.
fûíame
 = 
	`compo£_∑th
(
∑th
, 
‚ame
);

2007 
n
->
u
.
ªg
.
fûíame
 = 
NULL
;

2013 
	`skù_löe
(&
p
);

2015 i‡(
ty≥
 =
FT_DIR
) {

2016 *
∑th1
;

2017 
∑th1
 = 
	`compo£_∑th
(
∑th
, 
‚ame
);

2018 
ªt
 = 
	`fûñi°_lﬂd_ªc
(
fs1
, &
p
, 
n
, 
∑th1
);

2019 
	`‰ì
(
∑th1
);

2020 i‡(
ªt
)

2021  
ªt
;

2024 *
µ
 = 
p
;

2026 
	}
}

2028 
	$fûñi°_lﬂd
(
FSDevi˚
 *
fs1
, c⁄° *
°r
)

2030 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

2031 
ªt
;

2032 c⁄° *
p
;

2034 i‡(
	`∑r£_èg_vîsi⁄
(
°r
) != 1)

2036 
p
 = 
	`skù_hódî
(
°r
);

2037 i‡(!
p
)

2039 
ªt
 = 
	`fûñi°_lﬂd_ªc
(
fs1
, &
p
, 
fs
->
roŸ_öode
, "");

2040  
ªt
;

2041 
	}
}

2046 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 1, 2))Ë
	$Áèl_îr‹
(c⁄° *
fmt
, ...)

2048 
va_li°
 
≠
;

2049 
	`va_°¨t
(
≠
, 
fmt
);

2050 
	`Ârötf
(
°dîr
, "Error: ");

2051 
	`vÂrötf
(
°dîr
, 
fmt
, 
≠
);

2052 
	`Ârötf
(
°dîr
, "\n");

2053 
	`va_íd
(
≠
);

2054 
	`exô
(1);

2055 
	}
}

2057 
	$fs_¸óã_cmd
(
FSDevi˚
 *
fs
)

2059 
FSFûe
 *
roŸ_fd
;

2060 
FSQID
 
qid
;

2061 
FSINode
 *
n
;

2063 
	`as£π
(!
fs
->
	`fs_©èch
(fs, &
roŸ_fd
, &
qid
, 0, "", ""));

2064 
	`as£π
(!
fs
->
	`fs_¸óã
(fs, &
qid
, 
roŸ_fd
, 
FSCMD_NAME
, 
P9_O_RDWR
 | 
P9_O_TRUNC
,

2066 
n
 = 
roŸ_fd
->
öode
;

2067 
n
->
u
.
ªg
.
is_fscmd
 = 
TRUE
;

2068 
fs
->
	`fs_dñëe
(fs, 
roŸ_fd
);

2069 
	}
}

2072 
FSDevi˚
 *
	mfs
;

2073 *
	muæ
;

2074 (*
	m°¨t_cb
)(*
	m›aque
);

2075 *
	m°¨t_›aque
;

2077 
FSFûe
 *
	mroŸ_fd
;

2078 
FSFûe
 *
	mfd
;

2079 
	mfûe_ödex
;

2081 } 
	tFSNëInôSèã
;

2083 
fs_öôül_sync
(
FSDevi˚
 *
fs
,

2084 c⁄° *
uæ
, (*
°¨t_cb
)(*
›aque
),

2085 *
°¨t_›aque
);

2086 
	`hód_lﬂded
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
öt64_t
 
size
, *
›aque
);

2087 
	`fûñi°_lﬂded
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
öt64_t
 
size
, *
›aque
);

2088 
	`kî√l_lﬂd_cb
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
îr
,

2089 *
›aque
);

2090 
	`¥ñﬂd_∑r£
(
FSDevi˚
 *
fs
, c⁄° *
‚ame
, 
BOOL
 
is_√w
);

2092 #ifde‡
EMSCRIPTEN


2093 
FSDevi˚
 *
fs_imp‹t_fs
;

2096 
	#DEFAULT_IMPORT_FILE_PATH
 "/tmp"

	)

2098 
FSDevi˚
 *
	$fs_√t_öô
(c⁄° *
uæ
, (*
°¨t_cb
)(*
›aque
),

2099 *
°¨t_›aque
)

2101 
FSDevi˚
 *
fs
;

2102 
FSDevi˚Mem
 *
fs1
;

2104 
	`fs_wgë_öô
();

2106 
fs
 = 
	`fs_mem_öô
();

2107 #ifde‡
EMSCRIPTEN


2108 i‡(!
fs_imp‹t_fs
)

2109 
fs_imp‹t_fs
 = 
fs
;

2111 
fs1
 = (
FSDevi˚Mem
 *)
fs
;

2112 
fs1
->
imp‹t_dú
 = 
	`°rdup
(
DEFAULT_IMPORT_FILE_PATH
);

2114 
	`fs_¸óã_cmd
(
fs
);

2116 i‡(
uæ
) {

2117 
	`fs_öôül_sync
(
fs
, 
uæ
, 
°¨t_cb
, 
°¨t_›aque
);

2119  
fs
;

2120 
	}
}

2122 
	$fs_öôül_sync
(
FSDevi˚
 *
fs
,

2123 c⁄° *
uæ
, (*
°¨t_cb
)(*
›aque
),

2124 *
°¨t_›aque
)

2126 
FSNëInôSèã
 *
s
;

2127 
FSFûe
 *
hód_fd
;

2128 
FSQID
 
qid
;

2129 *
hód_uæ
;

2130 
buf
[128];

2131 
timevÆ
 
tv
;

2133 
s
 = 
	`mÆlocz
((*s));

2134 
s
->
fs
 = fs;

2135 
s
->
uæ
 = 
	`°rdup
(url);

2136 
s
->
°¨t_cb
 = start_cb;

2137 
s
->
°¨t_›aque
 = start_opaque;

2138 
	`as£π
(!
fs
->
	`fs_©èch
(fs, &
s
->
roŸ_fd
, &
qid
, 0, "", ""));

2141 
	`gëtimeofday
(&
tv
, 
NULL
);

2142 
	`¢¥ötf
(
buf
, (buf), 
HEAD_FILENAME
 "?noˇche=%" 
PRId64
,

2143 (
öt64_t
)
tv
.
tv_£c
 * 1000000 +Åv.
tv_u£c
);

2144 
hód_uæ
 = 
	`compo£_uæ
(
s
->
uæ
, 
buf
);

2145 
hód_fd
 = 
	`fs_dup
(
fs
, 
s
->
roŸ_fd
);

2146 
	`as£π
(!
fs
->
	`fs_¸óã
(fs, &
qid
, 
hód_fd
, ".head",

2147 
P9_O_RDWR
 | 
P9_O_TRUNC
, 0644, 0));

2148 
	`fs_wgë_fûe2
(
fs
, 
hód_fd
, 
hód_uæ
, 
NULL
, NULL, NULL, 0,

2149 
hód_lﬂded
, 
s
, 
NULL
);

2150 
	`‰ì
(
hód_uæ
);

2151 
	}
}

2153 
	$hód_lﬂded
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
öt64_t
 
size
, *
›aque
)

2155 
FSNëInôSèã
 *
s
 = 
›aque
;

2156 *
buf
, *
roŸ_uæ
, *
uæ
;

2157 
‚ame
[
FILEID_SIZE_MAX
];

2158 
FSFûeID
 
roŸ_id
;

2159 
FSFûe
 *
√w_fûñi°_fd
;

2160 
FSQID
 
qid
;

2161 
uöt64_t
 
fs_max_size
;

2163 i‡(
size
 < 0)

2164 
	`Áèl_îr‹
("couldÇŸÜﬂd 'hód' fûê(HTTPÉº‹=%d)", -()
size
);

2166 
buf
 = 
	`mÆloc
(
size
 + 1);

2167 
fs
->
	`fs_ªad
(fs, 
f
, 0, (
uöt8_t
 *)
buf
, 
size
);

2168 
buf
[
size
] = '\0';

2169 
fs
->
	`fs_dñëe
(fs, 
f
);

2170 
fs
->
	`fs_u∆ök©
(fs, 
s
->
roŸ_fd
, ".head");

2172 i‡(
	`∑r£_èg_vîsi⁄
(
buf
) != 1)

2173 
	`Áèl_îr‹
("invalid head version");

2175 i‡(
	`∑r£_èg_fûe_id
(&
roŸ_id
, 
buf
, "RootID") < 0)

2176 
	`Áèl_îr‹
("expected RootIDÅag");

2178 i‡(
	`∑r£_èg_uöt64
(&
fs_max_size
, 
buf
, "FSMaxSize") == 0 &&

2179 
fs_max_size
 >((
uöt64_t
)1 << 20)) {

2180 
	`fs_√t_£t_fs_max_size
(
fs
, 
fs_max_size
);

2184 
roŸ_uæ
 = 
	`compo£_uæ
(
s
->
uæ
, 
ROOT_FILENAME
);

2185 
	`fs_√t_£t_ba£_uæ
(
fs
, "/", 
roŸ_uæ
, 
NULL
, NULL, NULL);

2187 
√w_fûñi°_fd
 = 
	`fs_dup
(
fs
, 
s
->
roŸ_fd
);

2188 
	`as£π
(!
fs
->
	`fs_¸óã
(fs, &
qid
, 
√w_fûñi°_fd
, ".filelist.txt",

2189 
P9_O_RDWR
 | 
P9_O_TRUNC
, 0644, 0));

2191 
	`fûe_id_to_fûíame
(
‚ame
, 
roŸ_id
);

2192 
uæ
 = 
	`compo£_uæ
(
roŸ_uæ
, 
‚ame
);

2193 
	`fs_wgë_fûe2
(
fs
, 
√w_fûñi°_fd
, 
uæ
, 
NULL
, NULL, NULL, 0,

2194 
fûñi°_lﬂded
, 
s
, 
NULL
);

2195 
	`‰ì
(
roŸ_uæ
);

2196 
	`‰ì
(
uæ
);

2197 
	}
}

2199 
	$fûñi°_lﬂded
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
öt64_t
 
size
, *
›aque
)

2201 
FSNëInôSèã
 *
s
 = 
›aque
;

2202 
uöt8_t
 *
buf
;

2204 i‡(
size
 < 0)

2205 
	`Áèl_îr‹
("couldÇŸÜﬂd fûêli° (HTTPÉº‹=%d)", -()
size
);

2207 
buf
 = 
	`mÆloc
(
size
 + 1);

2208 
fs
->
	`fs_ªad
(fs, 
f
, 0, 
buf
, 
size
);

2209 
buf
[
size
] = '\0';

2210 
fs
->
	`fs_dñëe
(fs, 
f
);

2211 
fs
->
	`fs_u∆ök©
(fs, 
s
->
roŸ_fd
, ".filelist.txt");

2213 i‡(
	`fûñi°_lﬂd
(
fs
, (*)
buf
) != 0)

2214 
	`Áèl_îr‹
("error whileÖarsing fileÜist");

2217 
s
->
fûe_ödex
 = 0;

2218 
	`kî√l_lﬂd_cb
(
fs
, 
NULL
, 0, 
s
);

2219 
	}
}

2222 
	#FILE_LOAD_COUNT
 2

	)

2224 c⁄° *
	gkî√l_fûe_li°
[
FILE_LOAD_COUNT
] = {

2229 
	$kî√l_lﬂd_cb
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid1
, 
îr
,

2230 *
›aque
)

2232 
FSNëInôSèã
 *
s
 = 
›aque
;

2233 
FSQID
 
qid
;

2235 #ifde‡
DUMP_CACHE_LOAD


2237 i‡(((
FSDevi˚Mem
 *)
fs
)->
dump_ˇche_lﬂd
)

2241 i‡(
s
->
fd
) {

2242 
fs
->
	`fs_dñëe
(fs, 
s
->
fd
);

2243 
s
->
fd
 = 
NULL
;

2246 i‡(
s
->
fûe_ödex
 >
FILE_LOAD_COUNT
) {

2248 i‡(
	`¥ñﬂd_∑r£
(
fs
, ".¥ñﬂd2/¥ñﬂd.txt", 
TRUE
) < 0) {

2249 
	`¥ñﬂd_∑r£
(
fs
, ".¥ñﬂd", 
FALSE
);

2251 
fs
->
	`fs_dñëe
(fs, 
s
->
roŸ_fd
);

2252 i‡(
s
->
°¨t_cb
)

2253 
s
->
	`°¨t_cb
(s->
°¨t_›aque
);

2254 
	`‰ì
(
s
);

2256 
s
->
fd
 = 
	`fs_wÆk_∑th
(
fs
, s->
roŸ_fd
, 
kî√l_fûe_li°
[s->
fûe_ödex
++]);

2257 i‡(!
s
->
fd
)

2258 
d⁄e
;

2259 
îr
 = 
fs
->
	`fs_›í
(fs, &
qid
, 
s
->
fd
, 
P9_O_RDONLY
, 
kî√l_lﬂd_cb
, s);

2260 i‡(
îr
 <= 0) {

2261 
d⁄e
:

2262 
	`kî√l_lﬂd_cb
(
fs
, 
NULL
, 0, 
s
);

2265 
	}
}

2267 
	$¥ñﬂd_∑r£_°r_ﬁd
(
FSDevi˚
 *
fs1
, c⁄° *
p
)

2269 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

2270 
‚ame
[1024];

2271 
PªlﬂdE¡ry
 *
≥
;

2272 
PªlﬂdFûe
 *
pf
;

2273 
FSINode
 *
n
;

2276 
	`is•a˚_nﬁf
(*
p
))

2277 
p
++;

2278 i‡(*
p
 == '\n') {

2279 
p
++;

2282 i‡(*
p
 == '\0')

2284 i‡(
	`∑r£_‚ame
(
‚ame
, (‚ame), &
p
) < 0) {

2285 
	`Ârötf
(
°dîr
, "invalid filename\n");

2289 
n
 = 
	`öode_£¨ch_∑th
(
fs1
, 
‚ame
);

2290 i‡(!
n
 ||Ç->
ty≥
 !
FT_REG
 ||Ç->
u
.
ªg
.
°©e
 =
REG_STATE_LOCAL
) {

2291 
	`Ârötf
(
°dîr
, "övÆidÖªlﬂd fûe: '%s'\n", 
‚ame
);

2292 *
p
 != '\n' && *p != '\0')

2293 
p
++;

2295 
≥
 = 
	`mÆlocz
((*pe));

2296 
≥
->
fûe_id
 = 
n
->
u
.
ªg
.file_id;

2297 
	`öô_li°_hód
(&
≥
->
fûe_li°
);

2298 
	`li°_add_èû
(&
≥
->
lök
, &
fs
->
¥ñﬂd_li°
);

2300 
	`is•a˚_nﬁf
(*
p
))

2301 
p
++;

2302 i‡(*
p
 == '\0' || *p == '\n')

2304 i‡(
	`∑r£_‚ame
(
‚ame
, (‚ame), &
p
) < 0) {

2305 
	`Ârötf
(
°dîr
, "invalid filename\n");

2309 
pf
 = 
	`mÆlocz
((*pf));

2310 
pf
->
«me
 = 
	`°rdup
(
‚ame
);

2311 
	`li°_add_èû
(&
pf
->
lök
, &
≥
->
fûe_li°
);

2315 
	}
}

2317 
	$¥ñﬂd_∑r£_°r
(
FSDevi˚
 *
fs1
, c⁄° *
p
)

2319 
FSDevi˚Mem
 *
fs
 = (FSDevi˚Mem *)
fs1
;

2320 
PªlﬂdE¡ry
 *
≥
;

2321 
PªlﬂdArchive
 *
∑
;

2322 
FSINode
 *
n
;

2323 
BOOL
 
is_¨chive
;

2324 
‚ame
[1024];

2326 
≥
 = 
NULL
;

2327 
∑
 = 
NULL
;

2329 
	`is•a˚_nﬁf
(*
p
))

2330 
p
++;

2331 i‡(*
p
 == '\n') {

2332 
≥
 = 
NULL
;

2333 
p
++;

2336 i‡(*
p
 == '#')

2338 i‡(*
p
 == '\0')

2341 
is_¨chive
 = 
FALSE
;

2342 i‡(*
p
 == '@') {

2343 
is_¨chive
 = 
TRUE
;

2344 
p
++;

2346 i‡(
	`∑r£_‚ame
(
‚ame
, (‚ame), &
p
) < 0) {

2347 
	`Ârötf
(
°dîr
, "invalid filename\n");

2350 
	`is•a˚_nﬁf
(*
p
))

2351 
p
++;

2352 i‡(*
p
 == ':') {

2353 
p
++;

2355 
n
 = 
	`öode_£¨ch_∑th
(
fs1
, 
‚ame
);

2356 
≥
 = 
NULL
;

2357 
∑
 = 
NULL
;

2358 i‡(!
n
 ||Ç->
ty≥
 !
FT_REG
 ||Ç->
u
.
ªg
.
°©e
 =
REG_STATE_LOCAL
) {

2359 
	`Ârötf
(
°dîr
, "övÆidÖªlﬂd fûe: '%s'\n", 
‚ame
);

2360 *
p
 != '\n' && *p != '\0')

2361 
p
++;

2362 } i‡(
is_¨chive
) {

2363 
∑
 = 
	`mÆlocz
((*pa));

2364 
∑
->
«me
 = 
	`°rdup
(
‚ame
);

2365 
	`öô_li°_hód
(&
∑
->
fûe_li°
);

2366 
	`li°_add_èû
(&
∑
->
lök
, &
fs
->
¥ñﬂd_¨chive_li°
);

2368 
≥
 = 
	`mÆlocz
((*pe));

2369 
≥
->
fûe_id
 = 
n
->
u
.
ªg
.file_id;

2370 
	`öô_li°_hód
(&
≥
->
fûe_li°
);

2371 
	`li°_add_èû
(&
≥
->
lök
, &
fs
->
¥ñﬂd_li°
);

2374 i‡(!
≥
 && !
∑
) {

2375 
	`Ârötf
(
°dîr
, "fûíamêwôhouàèrgë: %s\n", 
‚ame
);

2378 i‡(
∑
) {

2379 
PªlﬂdArchiveFûe
 *
∑f
;

2380 
FSFûeID
 
fûe_id
;

2381 
uöt64_t
 
size
;

2383 i‡(
	`∑r£_uöt64
(&
size
, &
p
) < 0) {

2384 
	`Ârötf
(
°dîr
, "invalid size\n");

2388 i‡(
	`∑r£_fûe_id
(&
fûe_id
, &
p
) < 0) {

2389 
	`Ârötf
(
°dîr
, "invalid file id\n");

2393 
∑f
 = 
	`mÆlocz
((*paf));

2394 
∑f
->
«me
 = 
	`°rdup
(
‚ame
);

2395 
∑f
->
fûe_id
 = file_id;

2396 
∑f
->
size
 = size;

2397 
	`li°_add_èû
(&
∑f
->
lök
, &
∑
->
fûe_li°
);

2399 
PªlﬂdFûe
 *
pf
;

2400 
pf
 = 
	`mÆlocz
((*pf));

2401 
pf
->
«me
 = 
	`°rdup
(
‚ame
);

2402 
pf
->
is_¨chive
 = is_archive;

2403 
	`li°_add_èû
(&
pf
->
lök
, &
≥
->
fûe_li°
);

2407 *
p
 != '\n' && *p != '\0')

2408 
p
++;

2409 i‡(*
p
 == '\n')

2410 
p
++;

2412 
	}
}

2414 
	$¥ñﬂd_∑r£
(
FSDevi˚
 *
fs
, c⁄° *
‚ame
, 
BOOL
 
is_√w
)

2416 
FSINode
 *
n
;

2417 *
buf
;

2418 
size_t
 
size
;

2420 
n
 = 
	`öode_£¨ch_∑th
(
fs
, 
‚ame
);

2421 i‡(!
n
 ||Ç->
ty≥
 !
FT_REG
 ||Ç->
u
.
ªg
.
°©e
 !
REG_STATE_LOADED
)

2424 
size
 = 
n
->
u
.
ªg
.size;

2425 
buf
 = 
	`mÆloc
(
size
 + 1);

2426 
	`fûe_buf„r_ªad
(&
n
->
u
.
ªg
.
fbuf
, 0, (
uöt8_t
 *)
buf
, 
size
);

2427 
buf
[
size
] = '\0';

2428 i‡(
is_√w
)

2429 
	`¥ñﬂd_∑r£_°r
(
fs
, 
buf
);

2431 
	`¥ñﬂd_∑r£_°r_ﬁd
(
fs
, 
buf
);

2432 
	`‰ì
(
buf
);

2434 
	}
}

2441 
	sCmdXHRSèã
 {

2442 
FSFûe
 *
	mªq_fd
;

2443 
FSFûe
 *
	mroŸ_fd
;

2444 
FSFûe
 *
	mfd
;

2445 
FSFûe
 *
	mpo°_fd
;

2446 
AES_KEY
 
	m´s_°©e
;

2447 } 
	tCmdXHRSèã
;

2449 
fs_cmd_xhr_⁄_lﬂd
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
öt64_t
 
size
,

2450 *
›aque
);

2452 
	$∑r£_hex_buf
(
uöt8_t
 *
buf
, 
buf_size
, c⁄° **
µ
)

2454 
buf1
[1024];

2455 
Àn
;

2457 i‡(
	`∑r£_‚ame
(
buf1
, (buf1), 
µ
) < 0)

2459 
Àn
 = 
	`°æí
(
buf1
);

2460 i‡((
Àn
 & 1) != 0)

2462 
Àn
 >>= 1;

2463 i‡(
Àn
 > 
buf_size
)

2465 i‡(
	`decode_hex
(
buf
, 
buf1
, 
Àn
) < 0)

2467  
Àn
;

2468 
	}
}

2470 
	$fs_cmd_xhr
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
,

2471 c⁄° *
p
, 
uöt32_t
 
uid
, uöt32_à
gid
)

2473 
uæ
[1024], 
po°_fûíame
[1024], 
fûíame
[1024];

2474 
u£r_buf
[128], *
u£r
;

2475 
∑ssw‹d_buf
[128], *
∑ssw‹d
;

2476 
FSQID
 
qid
;

2477 
FSFûe
 *
fd
, *
roŸ_fd
, *
po°_fd
;

2478 
uöt64_t
 
po°_d©a_Àn
;

2479 
îr
, 
´s_key_Àn
;

2480 
CmdXHRSèã
 *
s
;

2481 *
«me
;

2482 
AES_KEY
 *
∑es_°©e
;

2483 
uöt8_t
 
´s_key
[
FS_KEY_LEN
];

2484 
uöt32_t
 
Êags
;

2485 
FSCMDReque°
 *
ªq
;

2488 i‡(
f
->
ªq
 !
NULL
)

2489  -
P9_EIO
;

2491 i‡(
	`∑r£_‚ame
(
uæ
, (uæ), &
p
) < 0)

2492 
Áû
;

2493 i‡(
	`∑r£_‚ame
(
u£r_buf
, (u£r_buf), &
p
) < 0)

2494 
Áû
;

2495 i‡(
	`∑r£_‚ame
(
∑ssw‹d_buf
, ’assw‹d_buf), &
p
) < 0)

2496 
Áû
;

2497 i‡(
	`∑r£_‚ame
(
po°_fûíame
, ’o°_fûíame), &
p
) < 0)

2498 
Áû
;

2499 i‡(
	`∑r£_‚ame
(
fûíame
, (fûíame), &
p
) < 0)

2500 
Áû
;

2501 
´s_key_Àn
 = 
	`∑r£_hex_buf
(
´s_key
, 
FS_KEY_LEN
, &
p
);

2502 i‡(
´s_key_Àn
 < 0)

2503 
Áû
;

2504 i‡(
	`∑r£_uöt32
(&
Êags
, &
p
) < 0)

2505 
Áû
;

2506 i‡(
´s_key_Àn
 !0 &&áes_key_À¿!
FS_KEY_LEN
)

2507 
Áû
;

2509 i‡(
u£r_buf
[0] != '\0')

2510 
u£r
 = 
u£r_buf
;

2512 
u£r
 = 
NULL
;

2513 i‡(
∑ssw‹d_buf
[0] != '\0')

2514 
∑ssw‹d
 = 
∑ssw‹d_buf
;

2516 
∑ssw‹d
 = 
NULL
;

2519 
	`as£π
(!
fs
->
	`fs_©èch
(fs, &
roŸ_fd
, &
qid
, 
uid
, "", ""));

2520 
po°_fd
 = 
NULL
;

2522 
fd
 = 
	`fs_wÆk_∑th1
(
fs
, 
roŸ_fd
, 
fûíame
, &
«me
);

2523 i‡(!
fd
) {

2524 
îr
 = -
P9_ENOENT
;

2525 
Áû1
;

2528 
fs
->
	`fs_u∆ök©
(fs, 
fd
, 
«me
);

2530 
îr
 = 
fs
->
	`fs_¸óã
(fs, &
qid
, 
fd
, 
«me
,

2531 
P9_O_RDWR
 | 
P9_O_TRUNC
, 0600, 
gid
);

2532 i‡(
îr
 < 0) {

2533 
Áû1
;

2536 i‡(
po°_fûíame
[0] != '\0') {

2537 
FSINode
 *
n
;

2539 
po°_fd
 = 
	`fs_wÆk_∑th
(
fs
, 
roŸ_fd
, 
po°_fûíame
);

2540 i‡(!
po°_fd
) {

2541 
îr
 = -
P9_ENOENT
;

2542 
Áû1
;

2544 
îr
 = 
fs
->
	`fs_›í
(fs, &
qid
, 
po°_fd
, 
P9_O_RDONLY
, 
NULL
, NULL);

2545 i‡(
îr
 < 0)

2546 
Áû1
;

2547 
n
 = 
po°_fd
->
öode
;

2548 
	`as£π
(
n
->
ty≥
 =
FT_REG
 &&Ç->
u
.
ªg
.
°©e
 =
REG_STATE_LOCAL
);

2549 
po°_d©a_Àn
 = 
n
->
u
.
ªg
.
size
;

2551 
po°_d©a_Àn
 = 0;

2554 
s
 = 
	`mÆlocz
((*s));

2555 
s
->
roŸ_fd
 =Ñoot_fd;

2556 
s
->
fd
 = fd;

2557 
s
->
po°_fd
 =Öost_fd;

2558 i‡(
´s_key_Àn
 != 0) {

2559 
	`AES_£t_de¸y±_key
(
´s_key
, 
FS_KEY_LEN
 * 8, &
s
->
´s_°©e
);

2560 
∑es_°©e
 = &
s
->
´s_°©e
;

2562 
∑es_°©e
 = 
NULL
;

2565 
ªq
 = 
	`mÆlocz
((*req));

2566 
ªq
->
ty≥
 = 
FS_CMD_XHR
;

2567 
ªq
->
ª∂y_Àn
 = 0;

2568 
ªq
->
xhr_°©e
 = 
s
;

2569 
s
->
ªq_fd
 = 
f
;

2570 
f
->
ªq
 =Ñeq;

2572 
	`fs_wgë_fûe2
(
fs
, 
fd
, 
uæ
, 
u£r
, 
∑ssw‹d
, 
po°_fd
, 
po°_d©a_Àn
,

2573 
fs_cmd_xhr_⁄_lﬂd
, 
s
, 
∑es_°©e
);

2575 
Áû1
:

2576 i‡(
fd
)

2577 
fs
->
	`fs_dñëe
(fs, 
fd
);

2578 i‡(
po°_fd
)

2579 
fs
->
	`fs_dñëe
(fs, 
po°_fd
);

2580 
fs
->
	`fs_dñëe
(fs, 
roŸ_fd
);

2581  
îr
;

2582 
Áû
:

2583  -
P9_EIO
;

2584 
	}
}

2586 
	$fs_cmd_xhr_⁄_lﬂd
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
öt64_t
 
size
,

2587 *
›aque
)

2589 
CmdXHRSèã
 *
s
 = 
›aque
;

2590 
FSCMDReque°
 *
ªq
;

2591 
ªt
;

2595 i‡(
s
->
fd
)

2596 
fs
->
	`fs_dñëe
(fs, 
s
->
fd
);

2597 i‡(
s
->
po°_fd
)

2598 
fs
->
	`fs_dñëe
(fs, 
s
->
po°_fd
);

2599 
fs
->
	`fs_dñëe
(fs, 
s
->
roŸ_fd
);

2601 i‡(
s
->
ªq_fd
) {

2602 
ªq
 = 
s
->
ªq_fd
->req;

2603 i‡(
size
 < 0) {

2604 
ªt
 = 
size
;

2606 
ªt
 = 0;

2608 
	`put_À32
(
ªq
->
ª∂y_buf
, 
ªt
);

2609 
ªq
->
ª∂y_Àn
 = (
ªt
);

2610 
ªq
->
xhr_°©e
 = 
NULL
;

2612 
	`‰ì
(
s
);

2613 
	}
}

2615 
	$fs_cmd_£t_ba£_uæ
(
FSDevi˚
 *
fs
, c⁄° *
p
)

2618 
uæ
[1024], 
ba£_uæ_id
[1024];

2619 
u£r_buf
[128], *
u£r
;

2620 
∑ssw‹d_buf
[128], *
∑ssw‹d
;

2621 
AES_KEY
 
´s_°©e
, *
∑es_°©e
;

2622 
uöt8_t
 
´s_key
[
FS_KEY_LEN
];

2623 
´s_key_Àn
;

2625 i‡(
	`∑r£_‚ame
(
ba£_uæ_id
, (ba£_uæ_id), &
p
) < 0)

2626 
Áû
;

2627 i‡(
	`∑r£_‚ame
(
uæ
, (uæ), &
p
) < 0)

2628 
Áû
;

2629 i‡(
	`∑r£_‚ame
(
u£r_buf
, (u£r_buf), &
p
) < 0)

2630 
Áû
;

2631 i‡(
	`∑r£_‚ame
(
∑ssw‹d_buf
, ’assw‹d_buf), &
p
) < 0)

2632 
Áû
;

2633 
´s_key_Àn
 = 
	`∑r£_hex_buf
(
´s_key
, 
FS_KEY_LEN
, &
p
);

2634 i‡(
´s_key_Àn
 < 0)

2635 
Áû
;

2637 i‡(
u£r_buf
[0] != '\0')

2638 
u£r
 = 
u£r_buf
;

2640 
u£r
 = 
NULL
;

2641 i‡(
∑ssw‹d_buf
[0] != '\0')

2642 
∑ssw‹d
 = 
∑ssw‹d_buf
;

2644 
∑ssw‹d
 = 
NULL
;

2646 i‡(
´s_key_Àn
 != 0) {

2647 i‡(
´s_key_Àn
 !
FS_KEY_LEN
)

2648 
Áû
;

2649 
	`AES_£t_de¸y±_key
(
´s_key
, 
FS_KEY_LEN
 * 8, &
´s_°©e
);

2650 
∑es_°©e
 = &
´s_°©e
;

2652 
∑es_°©e
 = 
NULL
;

2655 
	`fs_√t_£t_ba£_uæ
(
fs
, 
ba£_uæ_id
, 
uæ
, 
u£r
, 
∑ssw‹d
,

2656 
∑es_°©e
);

2658 
Áû
:

2659  -
P9_EINVAL
;

2660 
	}
}

2662 
	$fs_cmd_ª£t_ba£_uæ
(
FSDevi˚
 *
fs
, c⁄° *
p
)

2664 
ba£_uæ_id
[1024];

2666 i‡(
	`∑r£_‚ame
(
ba£_uæ_id
, (ba£_uæ_id), &
p
) < 0)

2667 
Áû
;

2668 
	`fs_√t_ª£t_ba£_uæ
(
fs
, 
ba£_uæ_id
);

2670 
Áû
:

2671  -
P9_EINVAL
;

2672 
	}
}

2674 
	$fs_cmd_£t_uæ
(
FSDevi˚
 *
fs
, c⁄° *
p
)

2676 
ba£_uæ_id
[1024];

2677 
fûíame
[1024];

2678 
FSFûeID
 
fûe_id
;

2679 
uöt64_t
 
size
;

2680 
FSINode
 *
n
;

2682 i‡(
	`∑r£_‚ame
(
fûíame
, (fûíame), &
p
) < 0)

2683 
Áû
;

2684 i‡(
	`∑r£_‚ame
(
ba£_uæ_id
, (ba£_uæ_id), &
p
) < 0)

2685 
Áû
;

2686 i‡(
	`∑r£_fûe_id
(&
fûe_id
, &
p
) < 0)

2687 
Áû
;

2688 i‡(
	`∑r£_uöt64
(&
size
, &
p
) < 0)

2689 
Áû
;

2691 
n
 = 
	`öode_£¨ch_∑th
(
fs
, 
fûíame
);

2692 i‡(!
n
) {

2693  -
P9_ENOENT
;

2695  
	`fs_√t_£t_uæ
(
fs
, 
n
, 
ba£_uæ_id
, 
fûe_id
, 
size
);

2696 
Áû
:

2697  -
P9_EINVAL
;

2698 
	}
}

2700 
	$fs_cmd_exp‹t_fûe
(
FSDevi˚
 *
fs
, c⁄° *
p
)

2702 
fûíame
[1024];

2703 
FSINode
 *
n
;

2704 c⁄° *
«me
;

2705 
uöt8_t
 *
buf
;

2707 i‡(
	`∑r£_‚ame
(
fûíame
, (fûíame), &
p
) < 0)

2708 
Áû
;

2709 
n
 = 
	`öode_£¨ch_∑th
(
fs
, 
fûíame
);

2710 i‡(!
n
)

2711  -
P9_ENOENT
;

2712 i‡(
n
->
ty≥
 !
FT_REG
 ||

2713 (
n
->
u
.
ªg
.
°©e
 !
REG_STATE_LOCAL
 &&

2714 
n
->
u
.
ªg
.
°©e
 !
REG_STATE_LOADED
))

2715 
Áû
;

2716 
«me
 = 
	`°ºchr
(
fûíame
, '/');

2717 i‡(
«me
)

2718 
«me
++;

2720 
«me
 = 
fûíame
;

2722 
buf
 = 
	`mÆloc
(
n
->
u
.
ªg
.
size
);

2723 
	`fûe_buf„r_ªad
(&
n
->
u
.
ªg
.
fbuf
, 0, 
buf
,Ç->u.ªg.
size
);

2724 
	`fs_exp‹t_fûe
(
«me
, 
buf
, 
n
->
u
.
ªg
.
size
);

2725 
	`‰ì
(
buf
);

2727 
Áû
:

2728  -
P9_EIO
;

2729 
	}
}

2732 
	$fs_cmd_pbkdf2
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
p
)

2734 
uöt8_t
 
pwd
[1024];

2735 
uöt8_t
 
ß…
[128];

2736 
uöt32_t
 
ôî
, 
key_Àn
;

2737 
pwd_Àn
, 
ß…_Àn
;

2738 
FSCMDReque°
 *
ªq
;

2741 i‡(
f
->
ªq
 !
NULL
)

2742  -
P9_EIO
;

2744 
pwd_Àn
 = 
	`∑r£_hex_buf
(
pwd
, ’wd), &
p
);

2745 i‡(
pwd_Àn
 < 0)

2746 
Áû
;

2747 
ß…_Àn
 = 
	`∑r£_hex_buf
(
ß…
, (ß…), &
p
);

2748 i‡(
pwd_Àn
 < 0)

2749 
Áû
;

2750 i‡(
	`∑r£_uöt32
(&
ôî
, &
p
) < 0)

2751 
Áû
;

2752 i‡(
	`∑r£_uöt32
(&
key_Àn
, &
p
) < 0)

2753 
Áû
;

2754 i‡(
key_Àn
 > 
FS_CMD_REPLY_LEN_MAX
 ||

2755 
key_Àn
 == 0)

2756 
Áû
;

2757 
ªq
 = 
	`mÆlocz
((*req));

2758 
ªq
->
ty≥
 = 
FS_CMD_PBKDF2
;

2759 
ªq
->
ª∂y_Àn
 = 
key_Àn
;

2760 
	`pbkdf2_hmac_sha256
(
pwd
, 
pwd_Àn
, 
ß…
, 
ß…_Àn
, 
ôî
, 
key_Àn
,

2761 
ªq
->
ª∂y_buf
);

2762 
f
->
ªq
 =Ñeq;

2764 
Áû
:

2765  -
P9_EINVAL
;

2766 
	}
}

2768 
	$fs_cmd_£t_imp‹t_dú
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
p
)

2770 
FSDevi˚Mem
 *
fs1
 = (FSDevi˚Mem *)
fs
;

2771 
fûíame
[1024];

2773 i‡(
	`∑r£_‚ame
(
fûíame
, (fûíame), &
p
) < 0)

2774  -
P9_EINVAL
;

2775 
	`‰ì
(
fs1
->
imp‹t_dú
);

2776 
fs1
->
imp‹t_dú
 = 
	`°rdup
(
fûíame
);

2778 
	}
}

2780 
	$fs_cmd_wrôe
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

2781 c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
)

2783 *
buf1
;

2784 c⁄° *
p
;

2785 
cmd
[64];

2786 
îr
;

2789 
buf1
 = 
	`mÆloc
(
buf_Àn
 + 1);

2790 
	`mem˝y
(
buf1
, 
buf
, 
buf_Àn
);

2791 
buf1
[
buf_Àn
] = '\0';

2793 
îr
 = 0;

2794 
p
 = 
buf1
;

2795 i‡(
	`∑r£_‚ame
(
cmd
, (cmd), &
p
) < 0)

2796 
Áû
;

2797 i‡(!
	`°rcmp
(
cmd
, "xhr")) {

2798 
îr
 = 
	`fs_cmd_xhr
(
fs
, 
f
, 
p
, f->
uid
, 0);

2799 } i‡(!
	`°rcmp
(
cmd
, "set_base_url")) {

2800 
îr
 = 
	`fs_cmd_£t_ba£_uæ
(
fs
, 
p
);

2801 } i‡(!
	`°rcmp
(
cmd
, "reset_base_url")) {

2802 
îr
 = 
	`fs_cmd_ª£t_ba£_uæ
(
fs
, 
p
);

2803 } i‡(!
	`°rcmp
(
cmd
, "set_url")) {

2804 
îr
 = 
	`fs_cmd_£t_uæ
(
fs
, 
p
);

2805 } i‡(!
	`°rcmp
(
cmd
, "export_file")) {

2806 
îr
 = 
	`fs_cmd_exp‹t_fûe
(
fs
, 
p
);

2807 } i‡(!
	`°rcmp
(
cmd
, "pbkdf2")) {

2808 
îr
 = 
	`fs_cmd_pbkdf2
(
fs
, 
f
, 
p
);

2809 } i‡(!
	`°rcmp
(
cmd
, "set_import_dir")) {

2810 
îr
 = 
	`fs_cmd_£t_imp‹t_dú
(
fs
, 
f
, 
p
);

2812 
	`¥ötf
("unknow¿comm™d: '%s'\n", 
cmd
);

2813 
Áû
:

2814 
îr
 = -
P9_EIO
;

2816 
	`‰ì
(
buf1
);

2817 i‡(
îr
 == 0)

2818  
buf_Àn
;

2820  
îr
;

2821 
	}
}

2823 
	$fs_cmd_ªad
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, 
uöt64_t
 
off£t
,

2824 
uöt8_t
 *
buf
, 
buf_Àn
)

2826 
FSCMDReque°
 *
ªq
;

2827 
l
;

2829 
ªq
 = 
f
->req;

2830 i‡(!
ªq
)

2831  -
P9_EIO
;

2832 
l
 = 
	`mö_öt
(
ªq
->
ª∂y_Àn
, 
buf_Àn
);

2833 
	`mem˝y
(
buf
, 
ªq
->
ª∂y_buf
, 
l
);

2834  
l
;

2835 
	}
}

2837 
	$fs_cmd_˛o£
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
)

2839 
FSCMDReque°
 *
ªq
;

2840 
ªq
 = 
f
->req;

2842 i‡(
ªq
) {

2843 i‡(
ªq
->
xhr_°©e
) {

2844 
ªq
->
xhr_°©e
->
ªq_fd
 = 
NULL
;

2846 
	`‰ì
(
ªq
);

2847 
f
->
ªq
 = 
NULL
;

2849 
	}
}

2853 
	$fs_√t_£t_pwd
(
FSDevi˚
 *
fs
, c⁄° *
pwd
)

2855 
FSFûe
 *
roŸ_fd
;

2856 
FSQID
 
qid
;

2858 
	`as£π
(
	`fs_is_√t
(
fs
));

2860 
	`as£π
(!
fs
->
	`fs_©èch
(fs, &
roŸ_fd
, &
qid
, 0, "", ""));

2861 
	`as£π
(!
fs
->
	`fs_¸óã
(fs, &
qid
, 
roŸ_fd
, ".fscmd_pwd", 
P9_O_RDWR
 | 
P9_O_TRUNC
,

2863 
fs
->
	`fs_wrôe
(fs, 
roŸ_fd
, 0, (
uöt8_t
 *)
pwd
, 
	`°æí
(pwd));

2864 
fs
->
	`fs_dñëe
(fs, 
roŸ_fd
);

2865 
	}
}

2869 #ifde‡
EMSCRIPTEN


2871 
	$fs_imp‹t_fûe
(c⁄° *
fûíame
, 
uöt8_t
 *
buf
, 
buf_Àn
)

2873 
FSDevi˚
 *
fs
;

2874 
FSDevi˚Mem
 *
fs1
;

2875 
FSFûe
 *
fd
, *
roŸ_fd
;

2876 
FSQID
 
qid
;

2879 
fs
 = 
fs_imp‹t_fs
;

2880 i‡(!
fs
) {

2881 
	`‰ì
(
buf
);

2885 
	`as£π
(!
fs
->
	`fs_©èch
(fs, &
roŸ_fd
, &
qid
, 1000, "", ""));

2886 
fs1
 = (
FSDevi˚Mem
 *)
fs
;

2887 
fd
 = 
	`fs_wÆk_∑th
(
fs
, 
roŸ_fd
, 
fs1
->
imp‹t_dú
);

2888 i‡(!
fd
)

2889 
Áû
;

2890 
	`fs_u∆ök©
(
fs
, 
roŸ_fd
, 
fûíame
);

2891 i‡(
fs
->
	`fs_¸óã
(fs, &
qid
, 
fd
, 
fûíame
, 
P9_O_RDWR
 | 
P9_O_TRUNC
,

2893 
Áû
;

2894 
fs
->
	`fs_wrôe
(fs, 
fd
, 0, 
buf
, 
buf_Àn
);

2895 
Áû
:

2896 i‡(
fd
)

2897 
fs
->
	`fs_dñëe
(fs, 
fd
);

2898 i‡(
roŸ_fd
)

2899 
fs
->
	`fs_dñëe
(fs, 
roŸ_fd
);

2900 
	`‰ì
(
buf
);

2901 
	}
}

2905 
	$fs_exp‹t_fûe
(c⁄° *
fûíame
,

2906 c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
)

2908 
	}
}

	@fs_utils.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

30 
	~<f˙é.h
>

31 
	~<î∫o.h
>

32 
	~<uni°d.h
>

33 
	~<time.h
>

34 
	~<˘y≥.h
>

35 
	~<sys/fûe.h
>

37 
	~"cutûs.h
"

38 
	~"li°.h
"

39 
	~"fs_utûs.h
"

42 c⁄° 
uöt8_t
 
	gí¸y±ed_fûe_magic
[4] = { 0xfb, 0xa2, 0xe9, 0x01 };

44 *
	$compo£_∑th
(c⁄° *
∑th
, c⁄° *
«me
)

46 
∑th_Àn
, 
«me_Àn
;

47 *
d
, *
q
;

49 i‡(
∑th
[0] == '\0') {

50 
d
 = 
	`°rdup
(
«me
);

52 
∑th_Àn
 = 
	`°æí
(
∑th
);

53 
«me_Àn
 = 
	`°æí
(
«me
);

54 
d
 = 
	`mÆloc
(
∑th_Àn
 + 1 + 
«me_Àn
 + 1);

55 
q
 = 
d
;

56 
	`mem˝y
(
q
, 
∑th
, 
∑th_Àn
);

57 
q
 +
∑th_Àn
;

58 i‡(
∑th
[
∑th_Àn
 - 1] != '/')

59 *
q
++ = '/';

60 
	`mem˝y
(
q
, 
«me
, 
«me_Àn
 + 1);

62  
d
;

63 
	}
}

65 *
	$compo£_uæ
(c⁄° *
ba£_uæ
, c⁄° *
«me
)

67 i‡(
	`°rchr
(
«me
, ':')) {

68  
	`°rdup
(
«me
);

70  
	`compo£_∑th
(
ba£_uæ
, 
«me
);

72 
	}
}

74 
	$skù_löe
(c⁄° **
µ
)

76 c⁄° *
p
;

77 
p
 = *
µ
;

78 *
p
 != '\n' && *p != '\0')

79 
p
++;

80 i‡(*
p
 == '\n')

81 
p
++;

82 *
µ
 = 
p
;

83 
	}
}

85 *
	$quŸed_°r
(c⁄° *
°r
)

87 c⁄° *
s
;

88 *
q
;

89 
c
;

90 *
buf
;

92 i‡(
°r
[0] == '\0')

93 
u£_quŸe
;

94 
s
 = 
°r
;

95 *
s
 != '\0') {

96 i‡(*
s
 <= ' ' || *s > '~')

97 
u£_quŸe
;

98 
s
++;

100  
	`°rdup
(
°r
);

101 
u£_quŸe
:

102 
buf
 = 
	`mÆloc
(
	`°æí
(
°r
) * 4 + 2 + 1);

103 
q
 = 
buf
;

104 
s
 = 
°r
;

105 *
q
++ = '"';

106 *
s
 != '\0') {

107 
c
 = *(
uöt8_t
 *)
s
;

108 i‡(
c
 < ' ' || c == 127) {

109 
q
 +
	`•rötf
(q, "\\x%02x", 
c
);

110 } i‡(
c
 == '\\' || c == '\"') {

111 
q
 +
	`•rötf
(q, "\\%c", 
c
);

113 *
q
++ = 
c
;

115 
s
++;

117 *
q
++ = '"';

118 *
q
 = '\0';

119  
buf
;

120 
	}
}

122 
	$∑r£_‚ame
(*
buf
, 
buf_size
, c⁄° **
µ
)

124 c⁄° *
p
;

125 *
q
;

126 
c
, 
h
;

128 
p
 = *
µ
;

129 
	`is•a˚_nﬁf
(*
p
))

130 
p
++;

131 i‡(*
p
 == '\0')

133 
q
 = 
buf
;

134 i‡(*
p
 == '"') {

135 
p
++;

137 
c
 = *
p
++;

138 i‡(
c
 == '\0' || c == '\n') {

140 } i‡(
c
 == '\"') {

142 } i‡(
c
 == '\\') {

143 
c
 = *
p
++;

144 
c
) {

148 
add_ch¨
;

150 
c
 = '\n';

151 
add_ch¨
;

153 
c
 = '\r';

154 
add_ch¨
;

156 
c
 = '\t';

157 
add_ch¨
;

159 
h
 = 
	`‰om_hex
(*
p
++);

160 i‡(
h
 < 0)

162 
c
 = 
h
 << 4;

163 
h
 = 
	`‰om_hex
(*
p
++);

164 i‡(
h
 < 0)

166 
c
 |
h
;

167 
add_ch¨
;

172 
add_ch¨
:

173 i‡(
q
 >
buf
 + 
buf_size
 - 1)

175 *
q
++ = 
c
;

179 !
	`is•a˚_nﬁf
(*
p
) && *p != '\0' && *p != '\n') {

180 i‡(
q
 >
buf
 + 
buf_size
 - 1)

182 *
q
++ = *
p
++;

185 *
q
 = '\0';

186 *
µ
 = 
p
;

188 
	}
}

190 
	$∑r£_uöt32_ba£
(
uöt32_t
 *
pvÆ
, c⁄° **
µ
, 
ba£
)

192 c⁄° *
p
, *
p1
;

193 
p
 = *
µ
;

194 
	`is•a˚_nﬁf
(*
p
))

195 
p
++;

196 *
pvÆ
 = 
	`°πoul
(
p
, (**)&
p1
, 
ba£
);

197 i‡(
p1
 =
p
)

199 *
µ
 = 
p1
;

201 
	}
}

203 
	$∑r£_uöt64_ba£
(
uöt64_t
 *
pvÆ
, c⁄° **
µ
, 
ba£
)

205 c⁄° *
p
, *
p1
;

206 
p
 = *
µ
;

207 
	`is•a˚_nﬁf
(*
p
))

208 
p
++;

209 *
pvÆ
 = 
	`°πouŒ
(
p
, (**)&
p1
, 
ba£
);

210 i‡(
p1
 =
p
)

212 *
µ
 = 
p1
;

214 
	}
}

216 
	$∑r£_uöt64
(
uöt64_t
 *
pvÆ
, c⁄° **
µ
)

218  
	`∑r£_uöt64_ba£
(
pvÆ
, 
µ
, 0);

219 
	}
}

221 
	$∑r£_uöt32
(
uöt32_t
 *
pvÆ
, c⁄° **
µ
)

223  
	`∑r£_uöt32_ba£
(
pvÆ
, 
µ
, 0);

224 
	}
}

226 
	$∑r£_time
(
uöt32_t
 *
p£c
, uöt32_à*
≤£c
, c⁄° **
µ
)

228 c⁄° *
p
;

229 
uöt32_t
 
v
, 
m
;

230 
p
 = *
µ
;

231 i‡(
	`∑r£_uöt32
(
p£c
, &
p
) < 0)

233 
v
 = 0;

234 i‡(*
p
 == '.') {

235 
p
++;

237 
m
 = 1000000000;

238 
v
 = 0;

239 *
p
 >= '0' && *p <= '9') {

240 
m
 /= 10;

241 
v
 +(*
p
 - '0'Ë* 
m
;

242 
p
++;

245 *
≤£c
 = 
v
;

246 *
µ
 = 
p
;

248 
	}
}

250 
	$∑r£_fûe_id
(
FSFûeID
 *
pvÆ
, c⁄° **
µ
)

252  
	`∑r£_uöt64_ba£
(
pvÆ
, 
µ
, 16);

253 
	}
}

255 *
	$fûe_id_to_fûíame
(*
buf
, 
FSFûeID
 
fûe_id
)

257 
	`•rötf
(
buf
, "%016" 
PRIx64
, 
fûe_id
);

258  
buf
;

259 
	}
}

261 
	$ícode_hex
(*
°r
, c⁄° 
uöt8_t
 *
buf
, 
Àn
)

263 
i
;

264 
i
 = 0; i < 
Àn
; i++)

265 
	`•rötf
(
°r
 + 2 * 
i
, "%02x", 
buf
[i]);

266 
	}
}

268 
	$decode_hex
(
uöt8_t
 *
buf
, c⁄° *
°r
, 
Àn
)

270 
h0
, 
h1
, 
i
;

272 
i
 = 0; i < 
Àn
; i++) {

273 
h0
 = 
	`‰om_hex
(
°r
[2 * 
i
]);

274 i‡(
h0
 < 0)

276 
h1
 = 
	`‰om_hex
(
°r
[2 * 
i
 + 1]);

277 i‡(
h1
 < 0)

279 
buf
[
i
] = (
h0
 << 4Ë| 
h1
;

282 
	}
}

285 c⁄° *
	$skù_hódî
(c⁄° *
p
)

287 
p
 = 
	`°r°r
(p, "\n\n");

288 i‡(!
p
)

289  
NULL
;

290  
p
 + 2;

291 
	}
}

294 
	$∑r£_èg
(*
buf
, 
buf_size
, c⁄° *
°r
, c⁄° *
èg
)

296 
èg«me
[128], *
q
;

297 c⁄° *
p
, *
p1
;

298 
Àn
;

300 
p
 = 
°r
;

302 i‡(*
p
 == '\0' || *p == '\n')

304 
q
 = 
èg«me
;

305 *
p
 != ':' && *p != '\n' && *p != '\0') {

306 i‡((
q
 - 
èg«me
) < (tagname) - 1)

307 *
q
++ = *
p
;

308 
p
++;

310 *
q
 = '\0';

311 i‡(*
p
 != ':')

313 
p
++;

314 
	`is•a˚_nﬁf
(*
p
))

315 
p
++;

316 
p1
 = 
p
;

317 
p
 = 
	`°rchr
(p, '\n');

318 i‡(!
p
)

319 
Àn
 = 
	`°æí
(
p1
);

321 
Àn
 = 
p
 - 
p1
;

322 i‡(!
	`°rcmp
(
èg«me
, 
èg
)) {

323 i‡(
Àn
 > 
buf_size
 - 1)

324 
Àn
 = 
buf_size
 - 1;

325 
	`mem˝y
(
buf
, 
p1
, 
Àn
);

326 
buf
[
Àn
] = '\0';

329 i‡(!
p
)

332 
p
++;

335 
	}
}

337 
	$∑r£_èg_uöt64
(
uöt64_t
 *
pvÆ
, c⁄° *
°r
, c⁄° *
èg
)

339 
buf
[64];

340 c⁄° *
p
;

341 i‡(
	`∑r£_èg
(
buf
, (buf), 
°r
, 
èg
))

343 
p
 = 
buf
;

344  
	`∑r£_uöt64
(
pvÆ
, &
p
);

345 
	}
}

347 
	$∑r£_èg_fûe_id
(
FSFûeID
 *
pvÆ
, c⁄° *
°r
, c⁄° *
èg
)

349 
buf
[64];

350 c⁄° *
p
;

351 i‡(
	`∑r£_èg
(
buf
, (buf), 
°r
, 
èg
))

353 
p
 = 
buf
;

354  
	`∑r£_uöt64_ba£
(
pvÆ
, &
p
, 16);

355 
	}
}

357 
	$∑r£_èg_vîsi⁄
(c⁄° *
°r
)

359 
uöt64_t
 
vîsi⁄
;

360 i‡(
	`∑r£_èg_uöt64
(&
vîsi⁄
, 
°r
, "Version"))

362  
vîsi⁄
;

363 
	}
}

365 
BOOL
 
	$is_uæ
(c⁄° *
∑th
)

367  (
	`°r°¨t
(
∑th
, "hâp:", 
NULL
) ||

368 
	`°r°¨t
(
∑th
, "hâps:", 
NULL
) ||

369 
	`°r°¨t
(
∑th
, "fûe:", 
NULL
));

370 
	}
}

	@fs_utils.h

24 
	#HEAD_FILENAME
 "hód"

	)

25 
	#ROOT_FILENAME
 "fûes"

	)

27 
	#FILEID_SIZE_MAX
 32

	)

29 
	#FS_KEY_LEN
 16

	)

32 
	#FS_BLOCK_SIZE_LOG2
 12

	)

33 
	#FS_BLOCK_SIZE
 (1 << 
FS_BLOCK_SIZE_LOG2
)

	)

36 
	mFS_ERR_OK
 = 0,

37 
	mFS_ERR_GENERIC
 = -1,

38 
	mFS_ERR_SYNTAX
 = -2,

39 
	mFS_ERR_REVISION
 = -3,

40 
	mFS_ERR_FILE_ID
 = -4,

41 
	mFS_ERR_IO
 = -5,

42 
	mFS_ERR_NOENT
 = -6,

43 
	mFS_ERR_COUNTERS
 = -7,

44 
	mFS_ERR_QUOTA
 = -8,

45 
	mFS_ERR_PROTOCOL_VERSION
 = -9,

46 
	mFS_ERR_HEAD
 = -10,

47 } 
	tFSCommôEº‹Code
;

49 
uöt64_t
 
	tFSFûeID
;

51 
ölöe
 
BOOL
 
	$is•a˚_nﬁf
(
c
)

53  (
c
 == ' ' || c == '\t');

54 
	}
}

56 
ölöe
 
	$‰om_hex
(
c
)

58 i‡(
c
 >= '0' && c <= '9')

59  
c
 - '0';

60 i‡(
c
 >= 'A' && c <= 'F')

61  
c
 - 'A' + 10;

62 i‡(
c
 >= 'a' && c <= 'f')

63  
c
 - 'a' + 10;

66 
	}
}

68 
ölöe
 
uöt64_t
 
	$block_Æign
(
uöt64_t
 
vÆ
, uöt64_à
Æign
)

70  (
vÆ
 + 
Æign
 - 1) & ~(align - 1);

71 
	}
}

73 
p°r˝y
(*
buf
, 
buf_size
, c⁄° *
°r
);

74 *
p°rˇt
(*
buf
, 
buf_size
, c⁄° *
s
);

75 *
compo£_∑th
(c⁄° *
∑th
, c⁄° *
«me
);

76 *
compo£_uæ
(c⁄° *
ba£_uæ
, c⁄° *
«me
);

77 
skù_löe
(c⁄° **
µ
);

78 *
quŸed_°r
(c⁄° *
°r
);

79 
∑r£_‚ame
(*
buf
, 
buf_size
, c⁄° **
µ
);

80 
∑r£_uöt32_ba£
(
uöt32_t
 *
pvÆ
, c⁄° **
µ
, 
ba£
);

81 
∑r£_uöt64_ba£
(
uöt64_t
 *
pvÆ
, c⁄° **
µ
, 
ba£
);

82 
∑r£_uöt64
(
uöt64_t
 *
pvÆ
, c⁄° **
µ
);

83 
∑r£_uöt32
(
uöt32_t
 *
pvÆ
, c⁄° **
µ
);

84 
∑r£_time
(
uöt32_t
 *
p£c
, uöt32_à*
≤£c
, c⁄° **
µ
);

85 
∑r£_fûe_id
(
FSFûeID
 *
pvÆ
, c⁄° **
µ
);

86 *
fûe_id_to_fûíame
(*
buf
, 
FSFûeID
 
fûe_id
);

87 
ícode_hex
(*
°r
, c⁄° 
uöt8_t
 *
buf
, 
Àn
);

88 
decode_hex
(
uöt8_t
 *
buf
, c⁄° *
°r
, 
Àn
);

89 
BOOL
 
is_uæ
(c⁄° *
∑th
);

91 c⁄° *
skù_hódî
(c⁄° *
p
);

92 
∑r£_èg
(*
buf
, 
buf_size
, c⁄° *
°r
, c⁄° *
èg
);

93 
∑r£_èg_uöt64
(
uöt64_t
 *
pvÆ
, c⁄° *
°r
, c⁄° *
èg
);

94 
∑r£_èg_fûe_id
(
FSFûeID
 *
pvÆ
, c⁄° *
°r
, c⁄° *
èg
);

95 
∑r£_èg_vîsi⁄
(c⁄° *
°r
);

	@fs_wget.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

30 
	~<sys/time.h
>

31 
	~<˘y≥.h
>

33 
	~"cutûs.h
"

34 
	~"li°.h
"

35 
	~"fs.h
"

36 
	~"fs_utûs.h
"

37 
	~"fs_wgë.h
"

39 #i‡
deföed
(
EMSCRIPTEN
)

40 
	~<ems¸ùãn.h
>

42 
	~<cuæ/mu…i.h
>

48 #ifde‡
EMSCRIPTEN


50 
	sXHRSèã
 {

51 *
	m›aque
;

52 
WGëWrôeCÆlback
 *
	mcb
;

55 
	gdow∆ﬂdög_cou¡
;

57 
	$fs_wgë_öô
()

59 
	}
}

61 
fs_wgë_upd©e_dow∆ﬂdög
(
Êag
);

63 
	$fs_wgë_upd©e_dow∆ﬂdög_cou¡
(
ö¸
)

65 
¥ev_°©e
, 
°©e
;

66 
¥ev_°©e
 = (
dow∆ﬂdög_cou¡
 > 0);

67 
dow∆ﬂdög_cou¡
 +
ö¸
;

68 
°©e
 = (
dow∆ﬂdög_cou¡
 > 0);

69 i‡(
¥ev_°©e
 !
°©e
)

70 
	`fs_wgë_upd©e_dow∆ﬂdög
(
°©e
);

71 
	}
}

73 
	$fs_wgë_⁄îr‹
(
h™dÀ
, *
›aque
, 
°©us
,

74 c⁄° *
°©us_ãxt
)

76 
XHRSèã
 *
s
 = 
›aque
;

77 i‡(
°©us
 <= 0)

78 
°©us
 = -404;

80 
°©us
 = -status;

81 
	`fs_wgë_upd©e_dow∆ﬂdög_cou¡
(-1);

82 i‡(
s
->
cb
)

83 
s
->
	`cb
(s->
›aque
, 
°©us
, 
NULL
, 0);

84 
	}
}

86 
	$fs_wgë_⁄lﬂd
(
h™dÀ
,

87 *
›aque
, *
d©a
, 
size
)

89 
XHRSèã
 *
s
 = 
›aque
;

90 
	`fs_wgë_upd©e_dow∆ﬂdög_cou¡
(-1);

91 i‡(
s
->
cb
)

92 
s
->
	`cb
(s->
›aque
, 0, 
d©a
, 
size
);

93 
	}
}

95 
ems¸ùãn_async_wgë3_d©a
(c⁄° * 
uæ
, c⁄° * 
ªque°ty≥
, c⁄° *
u£r
, c⁄° *
∑ssw‹d
, c⁄° 
uöt8_t
 *
po°_d©a
, 
po°_d©a_Àn
, *
¨g
, 
‰ì
, 
em_async_wgë2_d©a_⁄lﬂd_func
 
⁄lﬂd
, 
em_async_wgë2_d©a_⁄îr‹_func
 
⁄îr‹
, 
em_async_wgë2_d©a_⁄¥ogªss_func
 
⁄¥ogªss
);

97 
XHRSèã
 *
	$fs_wgë2
(c⁄° *
uæ
, c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

98 
WGëRódCÆlback
 *
ªad_cb
, 
uöt64_t
 
po°_d©a_Àn
,

99 *
›aque
, 
WGëWrôeCÆlback
 *
cb
, 
BOOL
 
sögÀ_wrôe
)

101 
XHRSèã
 *
s
;

102 c⁄° *
ªque°
;

103 
uöt8_t
 *
po°_d©a
;

105 
s
 = 
	`mÆlocz
((*s));

106 
s
->
›aque
 = opaque;

107 
s
->
cb
 = cb;

109 i‡(
po°_d©a_Àn
 != 0) {

110 
ªque°
 = "POST";

111 
po°_d©a
 = 
	`mÆloc
(
po°_d©a_Àn
);

112 
	`ªad_cb
(
›aque
, 
po°_d©a
, 
po°_d©a_Àn
);

114 
ªque°
 = "GET";

115 
po°_d©a
 = 
NULL
;

117 
	`fs_wgë_upd©e_dow∆ﬂdög_cou¡
(1);

119 
	`ems¸ùãn_async_wgë3_d©a
(
uæ
, 
ªque°
, 
u£r
, 
∑ssw‹d
,

120 
po°_d©a
, 
po°_d©a_Àn
, 
s
, 1, 
fs_wgë_⁄lﬂd
,

121 
fs_wgë_⁄îr‹
, 
NULL
);

122 i‡(
po°_d©a_Àn
 != 0)

123 
	`‰ì
(
po°_d©a
);

124  
s
;

125 
	}
}

127 
	$fs_wgë_‰ì
(
XHRSèã
 *
s
)

129 
s
->
cb
 = 
NULL
;

130 
s
->
›aque
 = 
NULL
;

131 
	}
}

135 
	sXHRSèã
 {

136 
li°_hód
 
	mlök
;

137 
CURL
 *
	meh
;

138 *
	m›aque
;

139 
WGëWrôeCÆlback
 *
	mwrôe_cb
;

140 
WGëRódCÆlback
 *
	mªad_cb
;

142 
BOOL
 
	msögÀ_wrôe
;

143 
DynBuf
 
	mdbuf
;

147 
li°_hód
 
	mlök
;

148 
öt64_t
 
	mtimeout
;

149 (*
	mcb
)(*
	m›aque
);

150 *
	m›aque
;

151 } 
	tAsyncCÆlSèã
;

153 
CURLM
 *
	gcuæ_mu…i_˘x
;

154 
li°_hód
 
	gxhr_li°
;

156 
	$fs_wgë_öô
()

158 i‡(
cuæ_mu…i_˘x
)

160 
	`cuæ_globÆ_öô
(
CURL_GLOBAL_ALL
);

161 
cuæ_mu…i_˘x
 = 
	`cuæ_mu…i_öô
();

162 
	`öô_li°_hód
(&
xhr_li°
);

163 
	}
}

165 
	$fs_wgë_íd
()

167 
	`cuæ_mu…i_˛ónup
(
cuæ_mu…i_˘x
);

168 
	`cuæ_globÆ_˛ónup
();

169 
	}
}

171 
size_t
 
	$fs_wgë_wrôe_cb
(*
±r
, 
size_t
 
size
, size_à
nmemb
,

172 *
u£rd©a
)

174 
XHRSèã
 *
s
 = 
u£rd©a
;

175 
size
 *
nmemb
;

177 i‡(
s
->
sögÀ_wrôe
) {

178 
	`dbuf_wrôe
(&
s
->
dbuf
, s->dbuf.
size
, (*)
±r
, size);

180 
s
->
	`wrôe_cb
(s->
›aque
, 1, 
±r
, 
size
);

182  
size
;

183 
	}
}

185 
size_t
 
	$fs_wgë_ªad_cb
(*
±r
, 
size_t
 
size
, size_à
nmemb
,

186 *
u£rd©a
)

188 
XHRSèã
 *
s
 = 
u£rd©a
;

189 
size
 *
nmemb
;

190  
s
->
	`ªad_cb
(s->
›aque
, 
±r
, 
size
);

191 
	}
}

193 
XHRSèã
 *
	$fs_wgë2
(c⁄° *
uæ
, c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

194 
WGëRódCÆlback
 *
ªad_cb
, 
uöt64_t
 
po°_d©a_Àn
,

195 *
›aque
, 
WGëWrôeCÆlback
 *
wrôe_cb
, 
BOOL
 
sögÀ_wrôe
)

197 
XHRSèã
 *
s
;

198 
s
 = 
	`mÆlocz
((*s));

199 
s
->
eh
 = 
	`cuæ_ósy_öô
();

200 
s
->
›aque
 = opaque;

201 
s
->
wrôe_cb
 = write_cb;

202 
s
->
ªad_cb
 =Ñead_cb;

203 
s
->
sögÀ_wrôe
 = single_write;

204 
	`dbuf_öô
(&
s
->
dbuf
);

206 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_PRIVATE
, s);

207 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_WRITEDATA
, s);

208 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_WRITEFUNCTION
, 
fs_wgë_wrôe_cb
);

209 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_HEADER
, 0);

210 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_URL
, 
uæ
);

211 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_VERBOSE
, 0L);

212 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_ACCEPT_ENCODING
, "");

213 i‡(
u£r
) {

214 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_USERNAME
, 
u£r
);

215 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_PASSWORD
, 
∑ssw‹d
);

217 i‡(
po°_d©a_Àn
 != 0) {

218 
cuæ_¶i°
 *
hódîs
 = 
NULL
;

219 
hódîs
 = 
	`cuæ_¶i°_≠≥nd
(headers,

221 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_HTTPHEADER
, 
hódîs
);

222 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_POST
, 1L);

223 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_POSTFIELDSIZE_LARGE
,

224 (
cuæ_off_t
)
po°_d©a_Àn
);

225 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_READDATA
, s);

226 
	`cuæ_ósy_£t›t
(
s
->
eh
, 
CURLOPT_READFUNCTION
, 
fs_wgë_ªad_cb
);

228 
	`cuæ_mu…i_add_h™dÀ
(
cuæ_mu…i_˘x
, 
s
->
eh
);

229 
	`li°_add_èû
(&
s
->
lök
, &
xhr_li°
);

230  
s
;

231 
	}
}

233 
	$fs_wgë_‰ì
(
XHRSèã
 *
s
)

235 
	`dbuf_‰ì
(&
s
->
dbuf
);

236 
	`cuæ_ósy_˛ónup
(
s
->
eh
);

237 
	`li°_dñ
(&
s
->
lök
);

238 
	`‰ì
(
s
);

239 
	}
}

242 
	$fs_√t_£t_fd£t
(*
pfd_max
, 
fd_£t
 *
rfds
, fd_£à*
wfds
, fd_£à*
efds
,

243 *
±imeout
)

245 
timeout
;

246 
n
, 
fd_max
;

247 
CURLMsg
 *
msg
;

249 i‡(!
cuæ_mu…i_˘x
)

252 
	`cuæ_mu…i_≥rf‹m
(
cuæ_mu…i_˘x
, &
n
);

255 
msg
 = 
	`cuæ_mu…i_öfo_ªad
(
cuæ_mu…i_˘x
, &
n
);

256 i‡(!
msg
)

258 i‡(
msg
->msg =
CURLMSG_DONE
) {

259 
XHRSèã
 *
s
;

260 
hâp_code
;

262 
	`cuæ_ósy_gëöfo
(
msg
->
ósy_h™dÀ
, 
CURLINFO_PRIVATE
, (**)&
s
);

263 
	`cuæ_ósy_gëöfo
(
msg
->
ósy_h™dÀ
, 
CURLINFO_RESPONSE_CODE
,

264 &
hâp_code
);

266 i‡(
hâp_code
 == 200) {

267 i‡(
s
->
sögÀ_wrôe
) {

268 
s
->
	`wrôe_cb
(s->
›aque
, 0, s->
dbuf
.
buf
, s->dbuf.
size
);

270 
s
->
	`wrôe_cb
(s->
›aque
, 0, 
NULL
, 0);

273 
s
->
	`wrôe_cb
(s->
›aque
, -
hâp_code
, 
NULL
, 0);

275 
	`cuæ_mu…i_ªmove_h™dÀ
(
cuæ_mu…i_˘x
, 
s
->
eh
);

276 
	`cuæ_ósy_˛ónup
(
s
->
eh
);

277 
	`dbuf_‰ì
(&
s
->
dbuf
);

278 
	`li°_dñ
(&
s
->
lök
);

279 
	`‰ì
(
s
);

283 
	`cuæ_mu…i_fd£t
(
cuæ_mu…i_˘x
, 
rfds
, 
wfds
, 
efds
, &
fd_max
);

284 *
pfd_max
 = 
	`max_öt
(*pfd_max, 
fd_max
);

285 
	`cuæ_mu…i_timeout
(
cuæ_mu…i_˘x
, &
timeout
);

286 i‡(
timeout
 >= 0)

287 *
±imeout
 = 
	`mö_öt
(*±imeout, 
timeout
);

288 
	}
}

290 
	$fs_√t_evít_lo›
(
FSNëEvítLo›Com∂ëi⁄Func
 *
cb
, *
›aque
)

292 
fd_£t
 
rfds
, 
wfds
, 
efds
;

293 
timeout
, 
fd_max
;

294 
timevÆ
 
tv
;

296 i‡(!
cuæ_mu…i_˘x
)

300 
fd_max
 = -1;

301 
	`FD_ZERO
(&
rfds
);

302 
	`FD_ZERO
(&
wfds
);

303 
	`FD_ZERO
(&
efds
);

304 
timeout
 = 10000;

305 
	`fs_√t_£t_fd£t
(&
fd_max
, &
rfds
, &
wfds
, &
efds
, &
timeout
);

306 i‡(
cb
) {

307 i‡(
	`cb
(
›aque
))

310 i‡(
	`li°_em±y
(&
xhr_li°
))

313 
tv
.
tv_£c
 = 
timeout
 / 1000;

314 
tv
.
tv_u£c
 = (
timeout
 % 1000) * 1000;

315 
	`£À˘
(
fd_max
 + 1, &
rfds
, &
wfds
, &
efds
, &
tv
);

317 
	}
}

321 
XHRSèã
 *
	$fs_wgë
(c⁄° *
uæ
, c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

322 *
›aque
, 
WGëWrôeCÆlback
 *
cb
, 
BOOL
 
sögÀ_wrôe
)

324  
	`fs_wgë2
(
uæ
, 
u£r
, 
∑ssw‹d
, 
NULL
, 0, 
›aque
, 
cb
, 
sögÀ_wrôe
);

325 
	}
}

330 
	#ENCRYPTED_FILE_HEADER_SIZE
 (4 + 
AES_BLOCK_SIZE
)

	)

332 
	#DEC_BUF_SIZE
 (256 * 
AES_BLOCK_SIZE
)

	)

334 
	sDe¸y±FûeSèã
 {

335 
De¸y±FûeCB
 *
	mwrôe_cb
;

336 *
	m›aque
;

337 
	mdec_°©e
;

338 
	mdec_buf_pos
;

339 
AES_KEY
 *
	m´s_°©e
;

340 
uöt8_t
 
	miv
[
AES_BLOCK_SIZE
];

341 
uöt8_t
 
	mdec_buf
[
DEC_BUF_SIZE
];

344 
De¸y±FûeSèã
 *
	$de¸y±_fûe_öô
(
AES_KEY
 *
´s_°©e
,

345 
De¸y±FûeCB
 *
wrôe_cb
,

346 *
›aque
)

348 
De¸y±FûeSèã
 *
s
;

349 
s
 = 
	`mÆlocz
((*s));

350 
s
->
wrôe_cb
 = write_cb;

351 
s
->
›aque
 = opaque;

352 
s
->
´s_°©e
 =áes_state;

353  
s
;

354 
	}
}

356 
	$de¸y±_fûe
(
De¸y±FûeSèã
 *
s
, c⁄° 
uöt8_t
 *
d©a
,

357 
size_t
 
size
)

359 
l
, 
Àn
, 
ªt
;

361 
size
 != 0) {

362 
s
->
dec_°©e
) {

364 
l
 = 
	`mö_öt
(
size
, 
ENCRYPTED_FILE_HEADER_SIZE
 - 
s
->
dec_buf_pos
);

365 
	`mem˝y
(
s
->
dec_buf
 + s->
dec_buf_pos
, 
d©a
, 
l
);

366 
s
->
dec_buf_pos
 +
l
;

367 i‡(
s
->
dec_buf_pos
 >
ENCRYPTED_FILE_HEADER_SIZE
) {

368 i‡(
	`memcmp
(
s
->
dec_buf
, 
í¸y±ed_fûe_magic
, 4) != 0)

370 
	`mem˝y
(
s
->
iv
, s->
dec_buf
 + 4, 
AES_BLOCK_SIZE
);

371 
s
->
dec_°©e
 = 1;

372 
s
->
dec_buf_pos
 = 0;

376 
l
 = 
	`mö_öt
(
size
, 
DEC_BUF_SIZE
 - 
s
->
dec_buf_pos
);

377 
	`mem˝y
(
s
->
dec_buf
 + s->
dec_buf_pos
, 
d©a
, 
l
);

378 
s
->
dec_buf_pos
 +
l
;

379 i‡(
s
->
dec_buf_pos
 >
DEC_BUF_SIZE
) {

381 
Àn
 = 
s
->
dec_buf_pos
 - 
AES_BLOCK_SIZE
;

382 
	`AES_cbc_í¸y±
(
s
->
dec_buf
, s->dec_buf, 
Àn
,

383 
s
->
´s_°©e
, s->
iv
, 
FALSE
);

384 
ªt
 = 
s
->
	`wrôe_cb
(s->
›aque
, s->
dec_buf
, 
Àn
);

385 i‡(
ªt
 < 0)

386  
ªt
;

387 
	`mem˝y
(
s
->
dec_buf
, s->dec_bu‡+ s->
dec_buf_pos
 - 
AES_BLOCK_SIZE
,

388 
AES_BLOCK_SIZE
);

389 
s
->
dec_buf_pos
 = 
AES_BLOCK_SIZE
;

393 
	`ab‹t
();

395 
d©a
 +
l
;

396 
size
 -
l
;

399 
	}
}

402 
	$de¸y±_fûe_Êush
(
De¸y±FûeSèã
 *
s
)

404 
Àn
, 
∑d_Àn
, 
ªt
;

406 i‡(
s
->
dec_°©e
 != 1)

408 
Àn
 = 
s
->
dec_buf_pos
;

409 i‡(
Àn
 == 0 ||

410 (
Àn
 % 
AES_BLOCK_SIZE
) != 0)

412 
	`AES_cbc_í¸y±
(
s
->
dec_buf
, s->dec_buf, 
Àn
,

413 
s
->
´s_°©e
, s->
iv
, 
FALSE
);

414 
∑d_Àn
 = 
s
->
dec_buf
[s->
dec_buf_pos
 - 1];

415 i‡(
∑d_Àn
 < 1 ||Öad_À¿> 
AES_BLOCK_SIZE
)

417 
Àn
 -
∑d_Àn
;

418 i‡(
Àn
 != 0) {

419 
ªt
 = 
s
->
	`wrôe_cb
(s->
›aque
, s->
dec_buf
, 
Àn
);

420 i‡(
ªt
 < 0)

421  
ªt
;

424 
	}
}

426 
	$de¸y±_fûe_íd
(
De¸y±FûeSèã
 *
s
)

428 
	`‰ì
(
s
);

429 
	}
}

434 
FSDevi˚
 *
	mfs
;

435 
FSFûe
 *
	mf
;

436 
öt64_t
 
	mpos
;

437 
FSWGëFûeCB
 *
	mcb
;

438 *
	m›aque
;

439 
FSFûe
 *
	mpo°ed_fûe
;

440 
öt64_t
 
	mªad_pos
;

441 
De¸y±FûeSèã
 *
	mdec_°©e
;

442 } 
	tFSWGëFûeSèã
;

444 
	$fs_wgë_fûe_wrôe_cb
(*
›aque
, c⁄° 
uöt8_t
 *
d©a
,

445 
size_t
 
size
)

447 
FSWGëFûeSèã
 *
s
 = 
›aque
;

448 
FSDevi˚
 *
fs
 = 
s
->fs;

449 
ªt
;

451 
ªt
 = 
fs
->
	`fs_wrôe
(fs, 
s
->
f
, s->
pos
, 
d©a
, 
size
);

452 i‡(
ªt
 < 0)

453  
ªt
;

454 
s
->
pos
 +
ªt
;

455  
ªt
;

456 
	}
}

458 
	$fs_wgë_fûe_⁄_lﬂd
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
)

460 
FSWGëFûeSèã
 *
s
 = 
›aque
;

461 
FSDevi˚
 *
fs
 = 
s
->fs;

462 
ªt
;

463 
öt64_t
 
ªt_size
;

466 i‡(
îr
 < 0) {

467 
ªt_size
 = 
îr
;

468 
d⁄e
;

470 i‡(
s
->
dec_°©e
) {

471 
ªt
 = 
	`de¸y±_fûe
(
s
->
dec_°©e
, 
d©a
, 
size
);

472 i‡(
ªt
 >0 && 
îr
 == 0) {

474 
	`de¸y±_fûe_Êush
(
s
->
dec_°©e
);

477 
ªt
 = 
	`fs_wgë_fûe_wrôe_cb
(
s
, 
d©a
, 
size
);

479 i‡(
ªt
 < 0) {

480 
ªt_size
 = 
ªt
;

481 
d⁄e
;

482 } i‡(
îr
 == 0) {

484 
ªt_size
 = 
s
->
pos
;

485 
d⁄e
:

486 
s
->
	`cb
(
fs
, s->
f
, 
ªt_size
, s->
›aque
);

487 i‡(
s
->
dec_°©e
)

488 
	`de¸y±_fûe_íd
(
s
->
dec_°©e
);

489 
	`‰ì
(
s
);

492 
	}
}

494 
size_t
 
	$fs_wgë_fûe_ªad_cb
(*
›aque
, *
d©a
, 
size_t
 
size
)

496 
FSWGëFûeSèã
 *
s
 = 
›aque
;

497 
FSDevi˚
 *
fs
 = 
s
->fs;

498 
ªt
;

500 i‡(!
s
->
po°ed_fûe
)

502 
ªt
 = 
fs
->
	`fs_ªad
(fs, 
s
->
po°ed_fûe
, s->
ªad_pos
, 
d©a
, 
size
);

503 i‡(
ªt
 < 0)

505 
s
->
ªad_pos
 +
ªt
;

506  
ªt
;

507 
	}
}

509 
	$fs_wgë_fûe2
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
uæ
,

510 c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

511 
FSFûe
 *
po°ed_fûe
, 
uöt64_t
 
po°_d©a_Àn
,

512 
FSWGëFûeCB
 *
cb
, *
›aque
,

513 
AES_KEY
 *
´s_°©e
)

515 
FSWGëFûeSèã
 *
s
;

516 
s
 = 
	`mÆlocz
((*s));

517 
s
->
fs
 = fs;

518 
s
->
f
 = f;

519 
s
->
pos
 = 0;

520 
s
->
cb
 = cb;

521 
s
->
›aque
 = opaque;

522 
s
->
po°ed_fûe
 =Öosted_file;

523 
s
->
ªad_pos
 = 0;

524 i‡(
´s_°©e
) {

525 
s
->
dec_°©e
 = 
	`de¸y±_fûe_öô
(
´s_°©e
, 
fs_wgë_fûe_wrôe_cb
, s);

528 
	`fs_wgë2
(
uæ
, 
u£r
, 
∑ssw‹d
, 
fs_wgë_fûe_ªad_cb
, 
po°_d©a_Àn
,

529 
s
, 
fs_wgë_fûe_⁄_lﬂd
, 
FALSE
);

530 
	}
}

535 #ifde‡
USE_BUILTIN_CRYPTO


537 
	#HMAC_BLOCK_SIZE
 64

	)

540 
SHA256_CTX
 
	m˘x
;

541 
uöt8_t
 
	mK
[
HMAC_BLOCK_SIZE
 + 
SHA256_DIGEST_LENGTH
];

542 } 
	tHMAC_SHA256_CTX
;

544 
	$hmac_sha256_öô
(
HMAC_SHA256_CTX
 *
s
, c⁄° 
uöt8_t
 *
key
, 
key_Àn
)

546 
i
, 
l
;

548 i‡(
key_Àn
 > 
HMAC_BLOCK_SIZE
) {

549 
	`SHA256
(
key
, 
key_Àn
, 
s
->
K
);

550 
l
 = 
SHA256_DIGEST_LENGTH
;

552 
	`mem˝y
(
s
->
K
, 
key
, 
key_Àn
);

553 
l
 = 
key_Àn
;

555 
	`mem£t
(
s
->
K
 + 
l
, 0, 
HMAC_BLOCK_SIZE
 -Ü);

556 
i
 = 0; i < 
HMAC_BLOCK_SIZE
; i++)

557 
s
->
K
[
i
] ^= 0x36;

558 
	`SHA256_Inô
(&
s
->
˘x
);

559 
	`SHA256_Upd©e
(&
s
->
˘x
, s->
K
, 
HMAC_BLOCK_SIZE
);

560 
	}
}

562 
	$hmac_sha256_upd©e
(
HMAC_SHA256_CTX
 *
s
, c⁄° 
uöt8_t
 *
buf
, 
Àn
)

564 
	`SHA256_Upd©e
(&
s
->
˘x
, 
buf
, 
Àn
);

565 
	}
}

568 
	$hmac_sha256_föÆ
(
HMAC_SHA256_CTX
 *
s
, 
uöt8_t
 *
out
)

570 
i
;

572 
	`SHA256_FöÆ
(
s
->
K
 + 
HMAC_BLOCK_SIZE
, &s->
˘x
);

573 
i
 = 0; i < 
HMAC_BLOCK_SIZE
; i++)

574 
s
->
K
[
i
] ^= (0x36 ^ 0x5c);

575 
	`SHA256
(
s
->
K
, 
HMAC_BLOCK_SIZE
 + 
SHA256_DIGEST_LENGTH
, 
out
);

576 
	}
}

578 
	#SALT_LEN_MAX
 32

	)

580 
	$pbkdf2_hmac_sha256
(c⁄° 
uöt8_t
 *
pwd
, 
pwd_Àn
,

581 c⁄° 
uöt8_t
 *
ß…
, 
ß…_Àn
,

582 
ôî
, 
key_Àn
, 
uöt8_t
 *
out
)

584 
uöt8_t
 
F
[
SHA256_DIGEST_LENGTH
], 
U
[
SALT_LEN_MAX
 + 4];

585 
HMAC_SHA256_CTX
 
˘x
;

586 
ô
, 
U_Àn
, 
j
, 
l
;

587 
uöt32_t
 
i
;

589 
	`as£π
(
ß…_Àn
 <
SALT_LEN_MAX
);

590 
i
 = 1;

591 
key_Àn
 > 0) {

592 
	`mem£t
(
F
, 0, 
SHA256_DIGEST_LENGTH
);

593 
	`mem˝y
(
U
, 
ß…
, 
ß…_Àn
);

594 
U
[
ß…_Àn
] = 
i
 >> 24;

595 
U
[
ß…_Àn
 + 1] = 
i
 >> 16;

596 
U
[
ß…_Àn
 + 2] = 
i
 >> 8;

597 
U
[
ß…_Àn
 + 3] = 
i
;

598 
U_Àn
 = 
ß…_Àn
 + 4;

599 
ô
 = 0; ià< 
ôî
; it++) {

600 
	`hmac_sha256_öô
(&
˘x
, 
pwd
, 
pwd_Àn
);

601 
	`hmac_sha256_upd©e
(&
˘x
, 
U
, 
U_Àn
);

602 
	`hmac_sha256_föÆ
(&
˘x
, 
U
);

603 
j
 = 0; j < 
SHA256_DIGEST_LENGTH
; j++)

604 
F
[
j
] ^
U
[j];

605 
U_Àn
 = 
SHA256_DIGEST_LENGTH
;

607 
l
 = 
	`mö_öt
(
key_Àn
, 
SHA256_DIGEST_LENGTH
);

608 
	`mem˝y
(
out
, 
F
, 
l
);

609 
out
 +
l
;

610 
key_Àn
 -
l
;

611 
i
++;

613 
	}
}

617 
	$pbkdf2_hmac_sha256
(c⁄° 
uöt8_t
 *
pwd
, 
pwd_Àn
,

618 c⁄° 
uöt8_t
 *
ß…
, 
ß…_Àn
,

619 
ôî
, 
key_Àn
, 
uöt8_t
 *
out
)

621 
	`PKCS5_PBKDF2_HMAC
((c⁄° *)
pwd
, 
pwd_Àn
, 
ß…
, 
ß…_Àn
,

622 
ôî
, 
	`EVP_sha256
(), 
key_Àn
, 
out
);

623 
	}
}

	@fs_wget.h

24 #i‡
deföed
(
EMSCRIPTEN
)

25 
	#USE_BUILTIN_CRYPTO


	)

28 #ifde‡
USE_BUILTIN_CRYPTO


29 
	~"´s.h
"

30 
	~"sha256.h
"

32 
	~<›ís¶/´s.h
>

33 
	~<›ís¶/sha.h
>

34 
	~<›ís¶/evp.h
>

36 #ifde‡
_WIN32


37 
	~<wösock2.h
>

40 
	#LOG
(Ë
	`¥ötf
("%s:%d\n", 
__func__
, 
__LINE__
)

	)

48 
	tWGëWrôeCÆlback
(*
	t›aque
, 
	tîr
, *
	td©a
, 
	tsize_t
 
	tsize
);

49 
size_t
 
	tWGëRódCÆlback
(*
	t›aque
, *
	td©a
, 
	tsize_t
 
	tsize
);

50 
XHRSèã
 
	tXHRSèã
;

52 
XHRSèã
 *
fs_wgë
(c⁄° *
uæ
, c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

53 *
›aque
, 
WGëWrôeCÆlback
 *
cb
, 
BOOL
 
sögÀ_wrôe
);

54 
fs_wgë_‰ì
(
XHRSèã
 *
s
);

56 
fs_wgë_öô
();

57 
fs_wgë_íd
();

59 #i‚de‡
EMSCRIPTEN


60 
BOOL
 
	tFSNëEvítLo›Com∂ëi⁄Func
(*
	t›aque
);

61 
fs_√t_£t_fd£t
(*
pfd_max
, 
fd_£t
 *
rfds
, fd_£à*
wfds
, fd_£à*
efds
,

62 *
±imeout
);

63 
fs_√t_evít_lo›
(
FSNëEvítLo›Com∂ëi⁄Func
 *
cb
, *
›aque
);

68 c⁄° 
uöt8_t
 
í¸y±ed_fûe_magic
[4];

70 
	tDe¸y±FûeCB
(*
	t›aque
, c⁄° 
	tuöt8_t
 *
	td©a
, 
	tsize_t
 
	tÀn
);

71 
De¸y±FûeSèã
 
	tDe¸y±FûeSèã
;

73 
De¸y±FûeSèã
 *
de¸y±_fûe_öô
(
AES_KEY
 *
´s_°©e
,

74 
De¸y±FûeCB
 *
wrôe_cb
,

75 *
›aque
);

76 
de¸y±_fûe
(
De¸y±FûeSèã
 *
s
, c⁄° 
uöt8_t
 *
d©a
,

77 
size_t
 
size
);

78 
de¸y±_fûe_Êush
(
De¸y±FûeSèã
 *
s
);

79 
de¸y±_fûe_íd
(
De¸y±FûeSèã
 *
s
);

81 
pbkdf2_hmac_sha256
(c⁄° 
uöt8_t
 *
pwd
, 
pwd_Àn
,

82 c⁄° 
uöt8_t
 *
ß…
, 
ß…_Àn
,

83 
ôî
, 
key_Àn
, 
uöt8_t
 *
out
);

87 
	tFSWGëFûeCB
(
	tFSDevi˚
 *
	tfs
, 
	tFSFûe
 *
	tf
, 
	töt64_t
 
	tsize
, *
	t›aque
);

89 
fs_wgë_fûe2
(
FSDevi˚
 *
fs
, 
FSFûe
 *
f
, c⁄° *
uæ
,

90 c⁄° *
u£r
, c⁄° *
∑ssw‹d
,

91 
FSFûe
 *
po°ed_fûe
, 
uöt64_t
 
po°_d©a_Àn
,

92 
FSWGëFûeCB
 *
cb
, *
›aque
,

93 
AES_KEY
 *
´s_°©e
);

	@ide.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

30 
	~"cutûs.h
"

31 
	~"ide.h
"

36 
	#ERR_STAT
 0x01

	)

37 
	#INDEX_STAT
 0x02

	)

38 
	#ECC_STAT
 0x04

	)

39 
	#DRQ_STAT
 0x08

	)

40 
	#SEEK_STAT
 0x10

	)

41 
	#SRV_STAT
 0x10

	)

42 
	#WRERR_STAT
 0x20

	)

43 
	#READY_STAT
 0x40

	)

44 
	#BUSY_STAT
 0x80

	)

47 
	#MARK_ERR
 0x01

	)

48 
	#TRK0_ERR
 0x02

	)

49 
	#ABRT_ERR
 0x04

	)

50 
	#MCR_ERR
 0x08

	)

51 
	#ID_ERR
 0x10

	)

52 
	#MC_ERR
 0x20

	)

53 
	#ECC_ERR
 0x40

	)

54 
	#BBD_ERR
 0x80

	)

55 
	#ICRC_ERR
 0x80

	)

58 
	#CD
 0x01

	)

59 
	#IO
 0x02

	)

60 
	#REL
 0x04

	)

61 
	#TAG_MASK
 0xf8

	)

63 
	#IDE_CMD_RESET
 0x04

	)

64 
	#IDE_CMD_DISABLE_IRQ
 0x02

	)

67 
	#WIN_NOP
 0x00

	)

71 
	#CFA_REQ_EXT_ERROR_CODE
 0x03

	)

75 
	#WIN_SRST
 0x08

	)

76 
	#WIN_DEVICE_RESET
 0x08

	)

80 
	#WIN_RECAL
 0x10

	)

81 
	#WIN_RESTORE
 
WIN_RECAL


	)

85 
	#WIN_READ
 0x20

	)

86 
	#WIN_READ_ONCE
 0x21

	)

87 
	#WIN_READ_LONG
 0x22

	)

88 
	#WIN_READ_LONG_ONCE
 0x23

	)

89 
	#WIN_READ_EXT
 0x24

	)

90 
	#WIN_READDMA_EXT
 0x25

	)

91 
	#WIN_READDMA_QUEUED_EXT
 0x26

	)

92 
	#WIN_READ_NATIVE_MAX_EXT
 0x27

	)

96 
	#WIN_MULTREAD_EXT
 0x29

	)

100 
	#WIN_WRITE
 0x30

	)

101 
	#WIN_WRITE_ONCE
 0x31

	)

102 
	#WIN_WRITE_LONG
 0x32

	)

103 
	#WIN_WRITE_LONG_ONCE
 0x33

	)

104 
	#WIN_WRITE_EXT
 0x34

	)

105 
	#WIN_WRITEDMA_EXT
 0x35

	)

106 
	#WIN_WRITEDMA_QUEUED_EXT
 0x36

	)

107 
	#WIN_SET_MAX_EXT
 0x37

	)

108 
	#CFA_WRITE_SECT_WO_ERASE
 0x38

	)

109 
	#WIN_MULTWRITE_EXT
 0x39

	)

113 
	#WIN_WRITE_VERIFY
 0x3C

	)

117 
	#WIN_VERIFY
 0x40

	)

118 
	#WIN_VERIFY_ONCE
 0x41

	)

119 
	#WIN_VERIFY_EXT
 0x42

	)

123 
	#WIN_FORMAT
 0x50

	)

127 
	#WIN_INIT
 0x60

	)

131 
	#WIN_SEEK
 0x70

	)

132 
	#CFA_TRANSLATE_SECTOR
 0x87

	)

133 
	#WIN_DIAGNOSE
 0x90

	)

134 
	#WIN_SPECIFY
 0x91

	)

135 
	#WIN_DOWNLOAD_MICROCODE
 0x92

	)

136 
	#WIN_STANDBYNOW2
 0x94

	)

137 
	#WIN_STANDBY2
 0x96

	)

138 
	#WIN_SETIDLE2
 0x97

	)

139 
	#WIN_CHECKPOWERMODE2
 0x98

	)

140 
	#WIN_SLEEPNOW2
 0x99

	)

144 
	#WIN_PACKETCMD
 0xA0

	)

145 
	#WIN_PIDENTIFY
 0xA1

	)

146 
	#WIN_QUEUED_SERVICE
 0xA2

	)

147 
	#WIN_SMART
 0xB0

	)

148 
	#CFA_ERASE_SECTORS
 0xC0

	)

149 
	#WIN_MULTREAD
 0xC4

	)

150 
	#WIN_MULTWRITE
 0xC5

	)

151 
	#WIN_SETMULT
 0xC6

	)

152 
	#WIN_READDMA_QUEUED
 0xC7

	)

153 
	#WIN_READDMA
 0xC8

	)

154 
	#WIN_READDMA_ONCE
 0xC9

	)

155 
	#WIN_WRITEDMA
 0xCA

	)

156 
	#WIN_WRITEDMA_ONCE
 0xCB

	)

157 
	#WIN_WRITEDMA_QUEUED
 0xCC

	)

158 
	#CFA_WRITE_MULTI_WO_ERASE
 0xCD

	)

159 
	#WIN_GETMEDIASTATUS
 0xDA

	)

160 
	#WIN_ACKMEDIACHANGE
 0xDB

	)

161 
	#WIN_POSTBOOT
 0xDC

	)

162 
	#WIN_PREBOOT
 0xDD

	)

163 
	#WIN_DOORLOCK
 0xDE

	)

164 
	#WIN_DOORUNLOCK
 0xDF

	)

165 
	#WIN_STANDBYNOW1
 0xE0

	)

166 
	#WIN_IDLEIMMEDIATE
 0xE1

	)

167 
	#WIN_STANDBY
 0xE2

	)

168 
	#WIN_SETIDLE1
 0xE3

	)

169 
	#WIN_READ_BUFFER
 0xE4

	)

170 
	#WIN_CHECKPOWERMODE1
 0xE5

	)

171 
	#WIN_SLEEPNOW1
 0xE6

	)

172 
	#WIN_FLUSH_CACHE
 0xE7

	)

173 
	#WIN_WRITE_BUFFER
 0xE8

	)

174 
	#WIN_WRITE_SAME
 0xE9

	)

176 
	#WIN_FLUSH_CACHE_EXT
 0xEA

	)

177 
	#WIN_IDENTIFY
 0xEC

	)

178 
	#WIN_MEDIAEJECT
 0xED

	)

179 
	#WIN_IDENTIFY_DMA
 0xEE

	)

180 
	#WIN_SETFEATURES
 0xEF

	)

181 
	#EXABYTE_ENABLE_NEST
 0xF0

	)

182 
	#WIN_SECURITY_SET_PASS
 0xF1

	)

183 
	#WIN_SECURITY_UNLOCK
 0xF2

	)

184 
	#WIN_SECURITY_ERASE_PREPARE
 0xF3

	)

185 
	#WIN_SECURITY_ERASE_UNIT
 0xF4

	)

186 
	#WIN_SECURITY_FREEZE_LOCK
 0xF5

	)

187 
	#WIN_SECURITY_DISABLE
 0xF6

	)

188 
	#WIN_READ_NATIVE_MAX
 0xF8

	)

189 
	#WIN_SET_MAX
 0xF9

	)

190 
	#DISABLE_SEAGATE
 0xFB

	)

192 
	#MAX_MULT_SECTORS
 128

	)

194 
IDESèã
 
	tIDESèã
;

196 
	tEndTøns„rFunc
(
	tIDESèã
 *);

198 
	sIDESèã
 {

199 
IDEIFSèã
 *
	mide_if
;

200 
BlockDevi˚
 *
	mbs
;

201 
	mcylödîs
, 
	mhóds
, 
	m£˘‹s
;

202 
	mmu…_£˘‹s
;

203 
öt64_t
 
	mnb_£˘‹s
;

206 
uöt8_t
 
	m„©uª
;

207 
uöt8_t
 
	mîr‹
;

208 
uöt16_t
 
	mn£˘‹
;

209 
uöt8_t
 
	m£˘‹
;

210 
uöt8_t
 
	mlcyl
;

211 
uöt8_t
 
	mhcyl
;

212 
uöt8_t
 
	m£À˘
;

213 
uöt8_t
 
	m°©us
;

215 
	mio_nb_£˘‹s
;

216 
	mªq_nb_£˘‹s
;

217 
EndTøns„rFunc
 *
	míd_å™s„r_func
;

219 
	md©a_ödex
;

220 
	md©a_íd
;

221 
uöt8_t
 
	mio_buf„r
[
MAX_MULT_SECTORS
*512 + 4];

224 
	sIDEIFSèã
 {

225 
IRQSig«l
 *
	múq
;

226 
IDESèã
 *
	mcur_drive
;

227 
IDESèã
 *
	mdrives
[2];

229 
uöt8_t
 
	mcmd
;

232 
ide_£˘‹_ªad_cb
(*
›aque
, 
ªt
);

233 
ide_£˘‹_ªad_cb_íd
(
IDESèã
 *
s
);

234 
ide_£˘‹_wrôe_cb2
(*
›aque
, 
ªt
);

236 
	$∑d°r
(*
°r
, c⁄° *
§c
, 
Àn
)

238 
i
, 
v
;

239 
i
 = 0; i < 
Àn
; i++) {

240 i‡(*
§c
)

241 
v
 = *
§c
++;

243 
v
 = ' ';

244 *(*)(()
°r
 ^ 1Ë
v
;

245 
°r
++;

247 
	}
}

250 
	$°w
(
uöt16_t
 *
buf
, 
v
)

252 *
buf
 = 
v
;

253 
	}
}

255 
	$ide_idítify
(
IDESèã
 *
s
)

257 
uöt16_t
 *
èb
;

258 
uöt32_t
 
ﬁdsize
;

260 
èb
 = (
uöt16_t
 *)
s
->
io_buf„r
;

262 
	`mem£t
(
èb
, 0, 512 * 2);

264 
	`°w
(
èb
 + 0, 0x0040);

265 
	`°w
(
èb
 + 1, 
s
->
cylödîs
);

266 
	`°w
(
èb
 + 3, 
s
->
hóds
);

267 
	`°w
(
èb
 + 4, 512 * 
s
->
£˘‹s
);

268 
	`°w
(
èb
 + 5, 512);

269 
	`°w
(
èb
 + 6, 
s
->
£˘‹s
);

270 
	`°w
(
èb
 + 20, 3);

271 
	`°w
(
èb
 + 21, 512);

272 
	`°w
(
èb
 + 22, 4);

273 
	`∑d°r
((*)(
èb
 + 27), "RISCVEMU HARDDISK", 40);

274 
	`°w
(
èb
 + 47, 0x8000 | 
MAX_MULT_SECTORS
);

275 
	`°w
(
èb
 + 48, 0);

276 
	`°w
(
èb
 + 49, 1 << 9);

277 
	`°w
(
èb
 + 51, 0x200);

278 
	`°w
(
èb
 + 52, 0x200);

279 
	`°w
(
èb
 + 54, 
s
->
cylödîs
);

280 
	`°w
(
èb
 + 55, 
s
->
hóds
);

281 
	`°w
(
èb
 + 56, 
s
->
£˘‹s
);

282 
ﬁdsize
 = 
s
->
cylödîs
 * s->
hóds
 * s->
£˘‹s
;

283 
	`°w
(
èb
 + 57, 
ﬁdsize
);

284 
	`°w
(
èb
 + 58, 
ﬁdsize
 >> 16);

285 i‡(
s
->
mu…_£˘‹s
)

286 
	`°w
(
èb
 + 59, 0x100 | 
s
->
mu…_£˘‹s
);

287 
	`°w
(
èb
 + 60, 
s
->
nb_£˘‹s
);

288 
	`°w
(
èb
 + 61, 
s
->
nb_£˘‹s
 >> 16);

289 
	`°w
(
èb
 + 80, (1 << 1) | (1 << 2));

290 
	`°w
(
èb
 + 82, (1 << 14));

291 
	`°w
(
èb
 + 83, (1 << 14));

292 
	`°w
(
èb
 + 84, (1 << 14));

293 
	`°w
(
èb
 + 85, (1 << 14));

294 
	`°w
(
èb
 + 86, 0);

295 
	`°w
(
èb
 + 87, (1 << 14));

296 
	}
}

298 
	$ide_£t_sig«tuª
(
IDESèã
 *
s
)

300 
s
->
£À˘
 &= 0xf0;

301 
s
->
n£˘‹
 = 1;

302 
s
->
£˘‹
 = 1;

303 
s
->
lcyl
 = 0;

304 
s
->
hcyl
 = 0;

305 
	}
}

307 
	$ide_ab‹t_comm™d
(
IDESèã
 *
s
)

309 
s
->
°©us
 = 
READY_STAT
 | 
ERR_STAT
;

310 
s
->
îr‹
 = 
ABRT_ERR
;

311 
	}
}

313 
	$ide_£t_úq
(
IDESèã
 *
s
)

315 
IDEIFSèã
 *
ide_if
 = 
s
->ide_if;

316 i‡(!(
ide_if
->
cmd
 & 
IDE_CMD_DISABLE_IRQ
)) {

317 
	`£t_úq
(
ide_if
->
úq
, 1);

319 
	}
}

322 
	$ide_å™s„r_°¨t
(
IDESèã
 *
s
, 
size
,

323 
EndTøns„rFunc
 *
íd_å™s„r_func
)

325 
s
->
íd_å™s„r_func
 =Énd_transfer_func;

326 
s
->
d©a_ödex
 = 0;

327 
s
->
d©a_íd
 = 
size
;

328 
	}
}

330 
	$ide_å™s„r_°›
(
IDESèã
 *
s
)

332 
s
->
íd_å™s„r_func
 = 
ide_å™s„r_°›
;

333 
s
->
d©a_ödex
 = 0;

334 
s
->
d©a_íd
 = 0;

335 
	}
}

337 
öt64_t
 
	$ide_gë_£˘‹
(
IDESèã
 *
s
)

339 
öt64_t
 
£˘‹_num
;

340 i‡(
s
->
£À˘
 & 0x40) {

342 
£˘‹_num
 = ((
s
->
£À˘
 & 0x0fË<< 24Ë| (s->
hcyl
 << 16) |

343 (
s
->
lcyl
 << 8Ë| s->
£˘‹
;

345 
£˘‹_num
 = ((
s
->
hcyl
 << 8Ë| s->
lcyl
) *

346 
s
->
hóds
 * s->
£˘‹s
 +

347 (
s
->
£À˘
 & 0x0fË* s->
£˘‹s
 + (s->
£˘‹
 - 1);

349  
£˘‹_num
;

350 
	}
}

352 
	$ide_£t_£˘‹
(
IDESèã
 *
s
, 
öt64_t
 
£˘‹_num
)

354 
cyl
, 
r
;

355 i‡(
s
->
£À˘
 & 0x40) {

356 
s
->
£À˘
 = (s->£À˘ & 0xf0Ë| ((
£˘‹_num
 >> 24) & 0x0f);

357 
s
->
hcyl
 = (
£˘‹_num
 >> 16) & 0xff;

358 
s
->
lcyl
 = (
£˘‹_num
 >> 8) & 0xff;

359 
s
->
£˘‹
 = 
£˘‹_num
 & 0xff;

361 
cyl
 = 
£˘‹_num
 / (
s
->
hóds
 * s->
£˘‹s
);

362 
r
 = 
£˘‹_num
 % (
s
->
hóds
 * s->
£˘‹s
);

363 
s
->
hcyl
 = (
cyl
 >> 8) & 0xff;

364 
s
->
lcyl
 = 
cyl
 & 0xff;

365 
s
->
£À˘
 = (s->£À˘ & 0xf0Ë| ((
r
 / s->
£˘‹s
) & 0x0f);

366 
s
->
£˘‹
 = (
r
 % s->
£˘‹s
) + 1;

368 
	}
}

370 
	$ide_£˘‹_ªad
(
IDESèã
 *
s
)

372 
öt64_t
 
£˘‹_num
;

373 
ªt
, 
n
;

375 
£˘‹_num
 = 
	`ide_gë_£˘‹
(
s
);

376 
n
 = 
s
->
n£˘‹
;

377 i‡(
n
 == 0)

378 
n
 = 256;

379 i‡(
n
 > 
s
->
ªq_nb_£˘‹s
)

380 
n
 = 
s
->
ªq_nb_£˘‹s
;

381 #i‡
	`deföed
(
DEBUG_IDE
)

382 
	`¥ötf
("ªad se˘‹=%" 
PRId64
 " cou¡=%d\n", 
£˘‹_num
, 
n
);

384 
s
->
io_nb_£˘‹s
 = 
n
;

385 
ªt
 = 
s
->
bs
->
	`ªad_async
(s->bs, 
£˘‹_num
, s->
io_buf„r
, 
n
,

386 
ide_£˘‹_ªad_cb
, 
s
);

387 i‡(
ªt
 < 0) {

389 
	`ide_ab‹t_comm™d
(
s
);

390 
	`ide_£t_úq
(
s
);

391 } i‡(
ªt
 == 0) {

393 
	`ide_£˘‹_ªad_cb
(
s
, 0);

396 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
 | 
BUSY_STAT
;

397 
s
->
îr‹
 = 0;

399 
	}
}

401 
	$ide_£˘‹_ªad_cb
(*
›aque
, 
ªt
)

403 
IDESèã
 *
s
 = 
›aque
;

404 
n
;

405 
EndTøns„rFunc
 *
func
;

407 
n
 = 
s
->
io_nb_£˘‹s
;

408 
	`ide_£t_£˘‹
(
s
, 
	`ide_gë_£˘‹
(sË+ 
n
);

409 
s
->
n£˘‹
 = (s->n£˘‹ - 
n
) & 0xff;

410 i‡(
s
->
n£˘‹
 == 0)

411 
func
 = 
ide_£˘‹_ªad_cb_íd
;

413 
func
 = 
ide_£˘‹_ªad
;

414 
	`ide_å™s„r_°¨t
(
s
, 512 * 
n
, 
func
);

415 
	`ide_£t_úq
(
s
);

416 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
 | 
DRQ_STAT
;

417 
s
->
îr‹
 = 0;

418 
	}
}

420 
	$ide_£˘‹_ªad_cb_íd
(
IDESèã
 *
s
)

423 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
;

424 
s
->
îr‹
 = 0;

425 
	`ide_å™s„r_°›
(
s
);

426 
	}
}

428 
	$ide_£˘‹_wrôe_cb1
(
IDESèã
 *
s
)

430 
öt64_t
 
£˘‹_num
;

431 
ªt
;

433 
	`ide_å™s„r_°›
(
s
);

434 
£˘‹_num
 = 
	`ide_gë_£˘‹
(
s
);

435 #i‡
	`deföed
(
DEBUG_IDE
)

436 
	`¥ötf
("wrôê£˘‹=%" 
PRId64
 " count=%d\n",

437 
£˘‹_num
, 
s
->
io_nb_£˘‹s
);

439 
ªt
 = 
s
->
bs
->
	`wrôe_async
(s->bs, 
£˘‹_num
, s->
io_buf„r
, s->
io_nb_£˘‹s
,

440 
ide_£˘‹_wrôe_cb2
, 
s
);

441 i‡(
ªt
 < 0) {

443 
	`ide_ab‹t_comm™d
(
s
);

444 
	`ide_£t_úq
(
s
);

445 } i‡(
ªt
 == 0) {

447 
	`ide_£˘‹_wrôe_cb2
(
s
, 0);

450 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
 | 
BUSY_STAT
;

452 
	}
}

454 
	$ide_£˘‹_wrôe_cb2
(*
›aque
, 
ªt
)

456 
IDESèã
 *
s
 = 
›aque
;

457 
n
;

459 
n
 = 
s
->
io_nb_£˘‹s
;

460 
	`ide_£t_£˘‹
(
s
, 
	`ide_gë_£˘‹
(sË+ 
n
);

461 
s
->
n£˘‹
 = (s->n£˘‹ - 
n
) & 0xff;

462 i‡(
s
->
n£˘‹
 == 0) {

464 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
;

466 
n
 = 
s
->
n£˘‹
;

467 i‡(
n
 > 
s
->
ªq_nb_£˘‹s
)

468 
n
 = 
s
->
ªq_nb_£˘‹s
;

469 
s
->
io_nb_£˘‹s
 = 
n
;

470 
	`ide_å™s„r_°¨t
(
s
, 512 * 
n
, 
ide_£˘‹_wrôe_cb1
);

471 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
 | 
DRQ_STAT
;

473 
	`ide_£t_úq
(
s
);

474 
	}
}

476 
	$ide_£˘‹_wrôe
(
IDESèã
 *
s
)

478 
n
;

479 
n
 = 
s
->
n£˘‹
;

480 i‡(
n
 == 0)

481 
n
 = 256;

482 i‡(
n
 > 
s
->
ªq_nb_£˘‹s
)

483 
n
 = 
s
->
ªq_nb_£˘‹s
;

484 
s
->
io_nb_£˘‹s
 = 
n
;

485 
	`ide_å™s„r_°¨t
(
s
, 512 * 
n
, 
ide_£˘‹_wrôe_cb1
);

486 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
 | 
DRQ_STAT
;

487 
	}
}

489 
	$ide_idítify_cb
(
IDESèã
 *
s
)

491 
	`ide_å™s„r_°›
(
s
);

492 
s
->
°©us
 = 
READY_STAT
;

493 
	}
}

495 
	$ide_exec_cmd
(
IDESèã
 *
s
, 
vÆ
)

497 #i‡
	`deföed
(
DEBUG_IDE
)

498 
	`¥ötf
("ide:Éxec_cmd=0x%02x\n", 
vÆ
);

500 
vÆ
) {

501 
WIN_IDENTIFY
:

502 
	`ide_idítify
(
s
);

503 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
 | 
DRQ_STAT
;

504 
	`ide_å™s„r_°¨t
(
s
, 512, 
ide_idítify_cb
);

505 
	`ide_£t_úq
(
s
);

507 
WIN_SPECIFY
:

508 
WIN_RECAL
:

509 
s
->
îr‹
 = 0;

510 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
;

511 
	`ide_£t_úq
(
s
);

513 
WIN_SETMULT
:

514 i‡(
s
->
n£˘‹
 > 
MAX_MULT_SECTORS
 ||

515 (
s
->
n£˘‹
 & (s->nsector - 1)) != 0) {

516 
	`ide_ab‹t_comm™d
(
s
);

518 
s
->
mu…_£˘‹s
 = s->
n£˘‹
;

519 #i‡
	`deföed
(
DEBUG_IDE
)

520 
	`¥ötf
("ide: sëmu…=%d\n", 
s
->
mu…_£˘‹s
);

522 
s
->
°©us
 = 
READY_STAT
;

524 
	`ide_£t_úq
(
s
);

526 
WIN_READ
:

527 
WIN_READ_ONCE
:

528 
s
->
ªq_nb_£˘‹s
 = 1;

529 
	`ide_£˘‹_ªad
(
s
);

531 
WIN_WRITE
:

532 
WIN_WRITE_ONCE
:

533 
s
->
ªq_nb_£˘‹s
 = 1;

534 
	`ide_£˘‹_wrôe
(
s
);

536 
WIN_MULTREAD
:

537 i‡(!
s
->
mu…_£˘‹s
) {

538 
	`ide_ab‹t_comm™d
(
s
);

539 
	`ide_£t_úq
(
s
);

541 
s
->
ªq_nb_£˘‹s
 = s->
mu…_£˘‹s
;

542 
	`ide_£˘‹_ªad
(
s
);

545 
WIN_MULTWRITE
:

546 i‡(!
s
->
mu…_£˘‹s
) {

547 
	`ide_ab‹t_comm™d
(
s
);

548 
	`ide_£t_úq
(
s
);

550 
s
->
ªq_nb_£˘‹s
 = s->
mu…_£˘‹s
;

551 
	`ide_£˘‹_wrôe
(
s
);

554 
WIN_READ_NATIVE_MAX
:

555 
	`ide_£t_£˘‹
(
s
, s->
nb_£˘‹s
 - 1);

556 
s
->
°©us
 = 
READY_STAT
;

557 
	`ide_£t_úq
(
s
);

560 
	`ide_ab‹t_comm™d
(
s
);

561 
	`ide_£t_úq
(
s
);

564 
	}
}

566 
	$ide_i›‹t_wrôe
(*
›aque
, 
uöt32_t
 
off£t
,

567 
uöt32_t
 
vÆ
, 
size_log2
)

569 
IDEIFSèã
 *
s1
 = 
›aque
;

570 
IDESèã
 *
s
 = 
s1
->
cur_drive
;

571 
addr
 = 
off£t
 + 1;

573 #ifde‡
DEBUG_IDE


574 
	`¥ötf
("ide: wrôêaddr=0x%02x vÆ=0x%02x\n", 
addr
, 
vÆ
);

576 
addr
) {

580 i‡(
s
) {

581 
s
->
„©uª
 = 
vÆ
;

585 i‡(
s
) {

586 
s
->
n£˘‹
 = 
vÆ
;

590 i‡(
s
) {

591 
s
->
£˘‹
 = 
vÆ
;

595 i‡(
s
) {

596 
s
->
lcyl
 = 
vÆ
;

600 i‡(
s
) {

601 
s
->
hcyl
 = 
vÆ
;

606 
s
 = 
s1
->
cur_drive
 = s1->
drives
[(
vÆ
 >> 4) & 1];

607 i‡(
s
) {

608 
s
->
£À˘
 = 
vÆ
;

614 i‡(
s
) {

615 
	`ide_exec_cmd
(
s
, 
vÆ
);

619 
	}
}

621 
uöt32_t
 
	$ide_i›‹t_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

623 
IDEIFSèã
 *
s1
 = 
›aque
;

624 
IDESèã
 *
s
 = 
s1
->
cur_drive
;

625 
ªt
, 
addr
 = 
off£t
 + 1;

627 i‡(!
s
) {

628 
ªt
 = 0x00;

630 
addr
) {

632 
ªt
 = 0xff;

635 
ªt
 = 
s
->
îr‹
;

638 
ªt
 = 
s
->
n£˘‹
;

641 
ªt
 = 
s
->
£˘‹
;

644 
ªt
 = 
s
->
lcyl
;

647 
ªt
 = 
s
->
hcyl
;

650 
ªt
 = 
s
->
£À˘
;

654 
ªt
 = 
s
->
°©us
;

655 
	`£t_úq
(
s1
->
úq
, 0);

659 #ifde‡
DEBUG_IDE


660 
	`¥ötf
("ide:Ñódáddr=0x%02x vÆ=0x%02x\n", 
addr
, 
ªt
);

662  
ªt
;

663 
	}
}

665 
uöt32_t
 
	$ide_°©us_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

667 
IDEIFSèã
 *
s1
 = 
›aque
;

668 
IDESèã
 *
s
 = 
s1
->
cur_drive
;

669 
ªt
;

671 i‡(
s
) {

672 
ªt
 = 
s
->
°©us
;

674 
ªt
 = 0;

676 #ifde‡
DEBUG_IDE


677 
	`¥ötf
("ide:Ñód sètus=0x%02x\n", 
ªt
);

679  
ªt
;

680 
	}
}

682 
	$ide_cmd_wrôe
(*
›aque
, 
uöt32_t
 
off£t
,

683 
uöt32_t
 
vÆ
, 
size_log2
)

685 
IDEIFSèã
 *
s1
 = 
›aque
;

686 
IDESèã
 *
s
;

687 
i
;

689 #ifde‡
DEBUG_IDE


690 
	`¥ötf
("ide: cmd wrôe=0x%02x\n", 
vÆ
);

692 i‡(!(
s1
->
cmd
 & 
IDE_CMD_RESET
Ë&& (
vÆ
 & IDE_CMD_RESET)) {

694 
i
 = 0; i < 2; i++) {

695 
s
 = 
s1
->
drives
[
i
];

696 i‡(
s
) {

697 
s
->
°©us
 = 
BUSY_STAT
 | 
SEEK_STAT
;

698 
s
->
îr‹
 = 0x01;

701 } i‡((
s1
->
cmd
 & 
IDE_CMD_RESET
Ë&& !(
vÆ
 & IDE_CMD_RESET)) {

703 
i
 = 0; i < 2; i++) {

704 
s
 = 
s1
->
drives
[
i
];

705 i‡(
s
) {

706 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
;

707 
	`ide_£t_sig«tuª
(
s
);

711 
s1
->
cmd
 = 
vÆ
;

712 
	}
}

714 
	$ide_d©a_wrôew
(*
›aque
, 
uöt32_t
 
off£t
,

715 
uöt32_t
 
vÆ
, 
size_log2
)

717 
IDEIFSèã
 *
s1
 = 
›aque
;

718 
IDESèã
 *
s
 = 
s1
->
cur_drive
;

719 
p
;

720 
uöt8_t
 *
èb
;

722 i‡(!
s
)

724 
p
 = 
s
->
d©a_ödex
;

725 
èb
 = 
s
->
io_buf„r
;

726 
èb
[
p
] = 
vÆ
 & 0xff;

727 
èb
[
p
 + 1] = (
vÆ
 >> 8) & 0xff;

728 
p
 += 2;

729 
s
->
d©a_ödex
 = 
p
;

730 i‡(
p
 >
s
->
d©a_íd
)

731 
s
->
	`íd_å™s„r_func
(s);

732 
	}
}

734 
uöt32_t
 
	$ide_d©a_ªadw
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

736 
IDEIFSèã
 *
s1
 = 
›aque
;

737 
IDESèã
 *
s
 = 
s1
->
cur_drive
;

738 
p
, 
ªt
;

739 
uöt8_t
 *
èb
;

741 i‡(!
s
) {

742 
ªt
 = 0;

744 
p
 = 
s
->
d©a_ödex
;

745 
èb
 = 
s
->
io_buf„r
;

746 
ªt
 = 
èb
[
p
] | (tab[p + 1] << 8);

747 
p
 += 2;

748 
s
->
d©a_ödex
 = 
p
;

749 i‡(
p
 >
s
->
d©a_íd
)

750 
s
->
	`íd_å™s„r_func
(s);

752  
ªt
;

753 
	}
}

755 
IDESèã
 *
	$ide_drive_öô
(
IDEIFSèã
 *
ide_if
, 
BlockDevi˚
 *
bs
)

757 
IDESèã
 *
s
;

758 
uöt32_t
 
cylödîs
;

759 
uöt64_t
 
nb_£˘‹s
;

761 
s
 = 
	`mÆloc
((*s));

762 
	`mem£t
(
s
, 0, (*s));

764 
s
->
ide_if
 = ide_if;

765 
s
->
bs
 = bs;

767 
nb_£˘‹s
 = 
s
->
bs
->
	`gë_£˘‹_cou¡
(s->bs);

768 
cylödîs
 = 
nb_£˘‹s
 / (16 * 63);

769 i‡(
cylödîs
 > 16383)

770 
cylödîs
 = 16383;

771 i‡(
cylödîs
 < 2)

772 
cylödîs
 = 2;

773 
s
->
cylödîs
 = cylinders;

774 
s
->
hóds
 = 16;

775 
s
->
£˘‹s
 = 63;

776 
s
->
nb_£˘‹s
 =Çb_sectors;

778 
s
->
mu…_£˘‹s
 = 
MAX_MULT_SECTORS
;

780 
s
->
„©uª
 = 0;

781 
s
->
îr‹
 = 0;

782 
s
->
n£˘‹
 = 0;

783 
s
->
£˘‹
 = 0;

784 
s
->
lcyl
 = 0;

785 
s
->
hcyl
 = 0;

786 
s
->
£À˘
 = 0xa0;

787 
s
->
°©us
 = 
READY_STAT
 | 
SEEK_STAT
;

790 
s
->
d©a_ödex
 = 0;

791 
s
->
d©a_íd
 = 0;

792 
s
->
íd_å™s„r_func
 = 
ide_å™s„r_°›
;

794 
s
->
ªq_nb_£˘‹s
 = 0;

795 
s
->
io_nb_£˘‹s
 = 0;

796  
s
;

797 
	}
}

799 
IDEIFSèã
 *
	$ide_öô
(
PhysMem‹yM≠
 *
p‹t_m≠
, 
uöt32_t
 
addr
, uöt32_à
addr2
,

800 
IRQSig«l
 *
úq
, 
BlockDevi˚
 **
èb_bs
)

802 
i
;

803 
IDEIFSèã
 *
s
;

805 
s
 = 
	`mÆloc
((
IDEIFSèã
));

806 
	`mem£t
(
s
, 0, (*s));

808 
s
->
úq
 = irq;

809 
s
->
cmd
 = 0;

811 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 
addr
, 1, 
s
, 
ide_d©a_ªadw
, 
ide_d©a_wrôew
,

812 
DEVIO_SIZE16
);

813 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 
addr
 + 1, 7, 
s
, 
ide_i›‹t_ªad
, 
ide_i›‹t_wrôe
,

814 
DEVIO_SIZE8
);

815 i‡(
addr2
) {

816 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 
addr2
, 1, 
s
, 
ide_°©us_ªad
, 
ide_cmd_wrôe
,

817 
DEVIO_SIZE8
);

820 
i
 = 0; i < 2; i++) {

821 i‡(
èb_bs
[
i
])

822 
s
->
drives
[
i
] = 
	`ide_drive_öô
(s, 
èb_bs
[i]);

824 
s
->
cur_drive
 = s->
drives
[0];

825  
s
;

826 
	}
}

829 
PCIDevi˚
 *
	$piix3_ide_öô
(
PCIBus
 *
pci_bus
, 
dev‚
)

831 
PCIDevi˚
 *
d
;

832 
d
 = 
	`pci_ªgi°î_devi˚
(
pci_bus
, "PIIX3 IDE", 
dev‚
, 0x8086, 0x7010, 0x00, 0x0101);

833 
	`pci_devi˚_£t_c⁄fig8
(
d
, 0x09, 0x00);

834  
d
;

835 
	}
}

	@ide.h

24 
	~"vútio.h
"

25 
	~"iomem.h
"

26 
	~"pci.h
"

28 
IDEIFSèã
 
	tIDEIFSèã
;

30 
IDEIFSèã
 *
ide_öô
(
PhysMem‹yM≠
 *
p‹t_m≠
, 
uöt32_t
 
addr
, uöt32_à
addr2
,

31 
IRQSig«l
 *
úq
, 
BlockDevi˚
 **
èb_bs
);

32 
PCIDevi˚
 *
piix3_ide_öô
(
PCIBus
 *
pci_bus
, 
dev‚
);

	@iomem.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

31 
	~"cutûs.h
"

32 
	~"iomem.h
"

34 
PhysMem‹yR™ge
 *
deÁu…_ªgi°î_øm
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

35 
uöt64_t
 
size
, 
devøm_Êags
);

36 
deÁu…_‰ì_øm
(
PhysMem‹yM≠
 *
s
, 
PhysMem‹yR™ge
 *
¥
);

37 c⁄° 
uöt32_t
 *
deÁu…_gë_dúty_bôs
(
PhysMem‹yM≠
 *
m≠
, 
PhysMem‹yR™ge
 *
¥
);

38 
deÁu…_£t_addr
(
PhysMem‹yM≠
 *
m≠
,

39 
PhysMem‹yR™ge
 *
¥
, 
uöt64_t
 
addr
, 
BOOL
 
íabÀd
);

41 
PhysMem‹yM≠
 *
	$phys_mem_m≠_öô
()

43 
PhysMem‹yM≠
 *
s
;

44 
s
 = 
	`mÆlocz
((*s));

45 
s
->
ªgi°î_øm
 = 
deÁu…_ªgi°î_øm
;

46 
s
->
‰ì_øm
 = 
deÁu…_‰ì_øm
;

47 
s
->
gë_dúty_bôs
 = 
deÁu…_gë_dúty_bôs
;

48 
s
->
£t_øm_addr
 = 
deÁu…_£t_addr
;

49  
s
;

50 
	}
}

52 
	$phys_mem_m≠_íd
(
PhysMem‹yM≠
 *
s
)

54 
i
;

55 
PhysMem‹yR™ge
 *
¥
;

57 
i
 = 0; i < 
s
->
n_phys_mem_ønge
; i++) {

58 
¥
 = &
s
->
phys_mem_ønge
[
i
];

59 i‡(
¥
->
is_øm
) {

60 
s
->
	`‰ì_øm
(s, 
¥
);

63 
	`‰ì
(
s
);

64 
	}
}

68 
PhysMem‹yR™ge
 *
	$gë_phys_mem_ønge
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
∑ddr
)

70 
PhysMem‹yR™ge
 *
¥
;

71 
i
;

72 
i
 = 0; i < 
s
->
n_phys_mem_ønge
; i++) {

73 
¥
 = &
s
->
phys_mem_ønge
[
i
];

74 i‡(
∑ddr
 >
¥
->
addr
 &&Öadd∏<Ör->add∏+Ör->
size
)

75  
¥
;

77  
NULL
;

78 
	}
}

80 
PhysMem‹yR™ge
 *
	$ªgi°î_øm_íåy
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

81 
uöt64_t
 
size
, 
devøm_Êags
)

83 
PhysMem‹yR™ge
 *
¥
;

85 
	`as£π
(
s
->
n_phys_mem_ønge
 < 
PHYS_MEM_RANGE_MAX
);

86 
	`as£π
((
size
 & (
DEVRAM_PAGE_SIZE
 - 1)) == 0 && size != 0);

87 
¥
 = &
s
->
phys_mem_ønge
[s->
n_phys_mem_ønge
++];

88 
¥
->
m≠
 = 
s
;

89 
¥
->
is_øm
 = 
TRUE
;

90 
¥
->
devøm_Êags
 = devøm_Êag†& ~
DEVRAM_FLAG_DISABLED
;

91 
¥
->
addr
 =áddr;

92 
¥
->
‹g_size
 = 
size
;

93 i‡(
devøm_Êags
 & 
DEVRAM_FLAG_DISABLED
)

94 
¥
->
size
 = 0;

96 
¥
->
size
 =Ör->
‹g_size
;

97 
¥
->
phys_mem
 = 
NULL
;

98 
¥
->
dúty_bôs
 = 
NULL
;

99  
¥
;

100 
	}
}

102 
PhysMem‹yR™ge
 *
	$deÁu…_ªgi°î_øm
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

103 
uöt64_t
 
size
, 
devøm_Êags
)

105 
PhysMem‹yR™ge
 *
¥
;

107 
¥
 = 
	`ªgi°î_øm_íåy
(
s
, 
addr
, 
size
, 
devøm_Êags
);

109 
¥
->
phys_mem
 = 
	`mÆlocz
(
size
);

110 i‡(!
¥
->
phys_mem
) {

111 
	`Ârötf
(
°dîr
, "CouldÇotállocate VM memory\n");

112 
	`exô
(1);

115 i‡(
devøm_Êags
 & 
DEVRAM_FLAG_DIRTY_BITS
) {

116 
size_t
 
nb_∑ges
;

117 
i
;

118 
nb_∑ges
 = 
size
 >> 
DEVRAM_PAGE_SIZE_LOG2
;

119 
¥
->
dúty_bôs_size
 = ((
nb_∑ges
 + 31Ë/ 32Ë* (
uöt32_t
);

120 
¥
->
dúty_bôs_ödex
 = 0;

121 
i
 = 0; i < 2; i++) {

122 
¥
->
dúty_bôs_èb
[
i
] = 
	`mÆlocz
’r->
dúty_bôs_size
);

124 
¥
->
dúty_bôs
 =Ör->
dúty_bôs_èb
[¥->
dúty_bôs_ödex
];

126  
¥
;

127 
	}
}

130 c⁄° 
uöt32_t
 *
	$deÁu…_gë_dúty_bôs
(
PhysMem‹yM≠
 *
m≠
,

131 
PhysMem‹yR™ge
 *
¥
)

133 
uöt32_t
 *
dúty_bôs
;

134 
BOOL
 
has_dúty_bôs
;

135 
size_t
 
n
, 
i
;

137 
dúty_bôs
 = 
¥
->dirty_bits;

139 
has_dúty_bôs
 = 
FALSE
;

140 
n
 = 
¥
->
dúty_bôs_size
 / (
uöt32_t
);

141 
i
 = 0; i < 
n
; i++) {

142 i‡(
dúty_bôs
[
i
] != 0) {

143 
has_dúty_bôs
 = 
TRUE
;

147 i‡(
has_dúty_bôs
 && 
¥
->
size
 != 0) {

149 
m≠
->
	`Êush_éb_wrôe_ønge
(m≠->
›aque
, 
¥
->
phys_mem
,Ör->
‹g_size
);

152 
¥
->
dúty_bôs_ödex
 ^= 1;

153 
¥
->
dúty_bôs
 =Ör->
dúty_bôs_èb
[¥->
dúty_bôs_ödex
];

154 
	`mem£t
(
¥
->
dúty_bôs
, 0,Ör->
dúty_bôs_size
);

155  
dúty_bôs
;

156 
	}
}

159 
	$phys_mem_ª£t_dúty_bô
(
PhysMem‹yR™ge
 *
¥
, 
size_t
 
off£t
)

161 
size_t
 
∑ge_ödex
;

162 
uöt32_t
 
mask
, *
dúty_bôs_±r
;

163 
PhysMem‹yM≠
 *
m≠
;

164 i‡(
¥
->
dúty_bôs
) {

165 
∑ge_ödex
 = 
off£t
 >> 
DEVRAM_PAGE_SIZE_LOG2
;

166 
mask
 = 1 << (
∑ge_ödex
 & 0x1f);

167 
dúty_bôs_±r
 = 
¥
->
dúty_bôs
 + (
∑ge_ödex
 >> 5);

168 i‡(*
dúty_bôs_±r
 & 
mask
) {

169 *
dúty_bôs_±r
 &~
mask
;

171 
m≠
 = 
¥
->map;

172 
m≠
->
	`Êush_éb_wrôe_ønge
(m≠->
›aque
,

173 
¥
->
phys_mem
 + (
off£t
 & ~(
DEVRAM_PAGE_SIZE
 - 1)),

174 
DEVRAM_PAGE_SIZE
);

177 
	}
}

179 
	$deÁu…_‰ì_øm
(
PhysMem‹yM≠
 *
s
, 
PhysMem‹yR™ge
 *
¥
)

181 
	`‰ì
(
¥
->
phys_mem
);

182 
	}
}

184 
PhysMem‹yR™ge
 *
	$˝u_ªgi°î_devi˚
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

185 
uöt64_t
 
size
, *
›aque
,

186 
Devi˚RódFunc
 *
ªad_func
, 
Devi˚WrôeFunc
 *
wrôe_func
,

187 
devio_Êags
)

189 
PhysMem‹yR™ge
 *
¥
;

190 
	`as£π
(
s
->
n_phys_mem_ønge
 < 
PHYS_MEM_RANGE_MAX
);

191 
	`as£π
(
size
 <= 0xffffffff);

192 
¥
 = &
s
->
phys_mem_ønge
[s->
n_phys_mem_ønge
++];

193 
¥
->
m≠
 = 
s
;

194 
¥
->
addr
 =áddr;

195 
¥
->
‹g_size
 = 
size
;

196 i‡(
devio_Êags
 & 
DEVIO_DISABLED
)

197 
¥
->
size
 = 0;

199 
¥
->
size
 =Ör->
‹g_size
;

200 
¥
->
is_øm
 = 
FALSE
;

201 
¥
->
›aque
 = opaque;

202 
¥
->
ªad_func
 =Ñead_func;

203 
¥
->
wrôe_func
 = write_func;

204 
¥
->
devio_Êags
 = devio_flags;

205  
¥
;

206 
	}
}

208 
	$deÁu…_£t_addr
(
PhysMem‹yM≠
 *
m≠
,

209 
PhysMem‹yR™ge
 *
¥
, 
uöt64_t
 
addr
, 
BOOL
 
íabÀd
)

211 i‡(
íabÀd
) {

212 i‡(
¥
->
size
 =0 ||Ör->
addr
 !=áddr) {

214 i‡(
¥
->
is_øm
) {

215 
m≠
->
	`Êush_éb_wrôe_ønge
(m≠->
›aque
,

216 
¥
->
phys_mem
,Ör->
‹g_size
);

218 
¥
->
addr
 =áddr;

219 
¥
->
size
 =Ör->
‹g_size
;

222 i‡(
¥
->
size
 != 0) {

224 i‡(
¥
->
is_øm
) {

225 
m≠
->
	`Êush_éb_wrôe_ønge
(m≠->
›aque
,

226 
¥
->
phys_mem
,Ör->
‹g_size
);

228 
¥
->
addr
 = 0;

229 
¥
->
size
 = 0;

232 
	}
}

234 
	$phys_mem_£t_addr
(
PhysMem‹yR™ge
 *
¥
, 
uöt64_t
 
addr
, 
BOOL
 
íabÀd
)

236 
PhysMem‹yM≠
 *
m≠
 = 
¥
->map;

237 i‡(!
¥
->
is_øm
) {

238 
	`deÁu…_£t_addr
(
m≠
, 
¥
, 
addr
, 
íabÀd
);

240  
m≠
->
	`£t_øm_addr
(m≠, 
¥
, 
addr
, 
íabÀd
);

242 
	}
}

245 
uöt8_t
 *
	$phys_mem_gë_øm_±r
(
PhysMem‹yM≠
 *
m≠
, 
uöt64_t
 
∑ddr
, 
BOOL
 
is_rw
)

247 
PhysMem‹yR™ge
 *
¥
 = 
	`gë_phys_mem_ønge
(
m≠
, 
∑ddr
);

248 
uöçå_t
 
off£t
;

249 i‡(!
¥
 || !¥->
is_øm
)

250  
NULL
;

251 
off£t
 = 
∑ddr
 - 
¥
->
addr
;

252 i‡(
is_rw
)

253 
	`phys_mem_£t_dúty_bô
(
¥
, 
off£t
);

254  
¥
->
phys_mem
 + (
uöçå_t
)
off£t
;

255 
	}
}

259 
	$úq_öô
(
IRQSig«l
 *
úq
, 
SëIRQFunc
 *
£t_úq
, *
›aque
, 
úq_num
)

261 
úq
->
£t_úq
 = set_irq;

262 
úq
->
›aque
 = opaque;

263 
úq
->
úq_num
 = irq_num;

264 
	}
}

	@iomem.h

24 #i‚de‡
IOMEM_H


25 
	#IOMEM_H


	)

27 
	tDevi˚WrôeFunc
(*
	t›aque
, 
	tuöt32_t
 
	toff£t
,

28 
	tuöt32_t
 
	tvÆ
, 
	tsize_log2
);

29 
uöt32_t
 
	tDevi˚RódFunc
(*
	t›aque
, 
	tuöt32_t
 
	toff£t
, 
	tsize_log2
);

31 
	#DEVIO_SIZE8
 (1 << 0)

	)

32 
	#DEVIO_SIZE16
 (1 << 1)

	)

33 
	#DEVIO_SIZE32
 (1 << 2)

	)

36 
	#DEVIO_DISABLED
 (1 << 4)

	)

38 
	#DEVRAM_FLAG_ROM
 (1 << 0Ë

	)

39 
	#DEVRAM_FLAG_DIRTY_BITS
 (1 << 1Ë

	)

40 
	#DEVRAM_FLAG_DISABLED
 (1 << 2Ë

	)

41 
	#DEVRAM_PAGE_SIZE_LOG2
 12

	)

42 
	#DEVRAM_PAGE_SIZE
 (1 << 
DEVRAM_PAGE_SIZE_LOG2
)

	)

44 
PhysMem‹yM≠
 
	tPhysMem‹yM≠
;

47 
PhysMem‹yM≠
 *
	mm≠
;

48 
uöt64_t
 
	maddr
;

49 
uöt64_t
 
	m‹g_size
;

50 
uöt64_t
 
	msize
;

51 
BOOL
 
	mis_øm
;

53 
	mdevøm_Êags
;

54 
uöt8_t
 *
	mphys_mem
;

55 
	mdúty_bôs_size
;

56 
uöt32_t
 *
	mdúty_bôs
;

57 
uöt32_t
 *
	mdúty_bôs_èb
[2];

58 
	mdúty_bôs_ödex
;

60 *
	m›aque
;

61 
Devi˚RódFunc
 *
	mªad_func
;

62 
Devi˚WrôeFunc
 *
	mwrôe_func
;

63 
	mdevio_Êags
;

64 } 
	tPhysMem‹yR™ge
;

66 
	#PHYS_MEM_RANGE_MAX
 32

	)

68 
	sPhysMem‹yM≠
 {

69 
	mn_phys_mem_ønge
;

70 
PhysMem‹yR™ge
 
	mphys_mem_ønge
[
PHYS_MEM_RANGE_MAX
];

71 
	mPhysMem‹yR™ge
 *(*
	mªgi°î_øm
)(
PhysMem‹yM≠
 *
	ms
, 
uöt64_t
 
	maddr
,

72 
uöt64_t
 
	msize
, 
	mdevøm_Êags
);

73 (*
	m‰ì_øm
)(
PhysMem‹yM≠
 *
	ms
, 
PhysMem‹yR™ge
 *
	m¥
);

74 c⁄° 
	muöt32_t
 *(*
	mgë_dúty_bôs
)(
PhysMem‹yM≠
 *
	ms
, 
PhysMem‹yR™ge
 *
	m¥
);

75 (*
	m£t_øm_addr
)(
PhysMem‹yM≠
 *
	ms
, 
PhysMem‹yR™ge
 *
	m¥
, 
uöt64_t
 
	maddr
,

76 
BOOL
 
	míabÀd
);

77 *
	m›aque
;

78 (*
	mÊush_éb_wrôe_ønge
)(*
	m›aque
, 
uöt8_t
 *
	møm_addr
,

79 
size_t
 
	møm_size
);

83 
PhysMem‹yM≠
 *
phys_mem_m≠_öô
();

84 
phys_mem_m≠_íd
(
PhysMem‹yM≠
 *
s
);

85 
PhysMem‹yR™ge
 *
ªgi°î_øm_íåy
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

86 
uöt64_t
 
size
, 
devøm_Êags
);

87 
ölöe
 
PhysMem‹yR™ge
 *
	$˝u_ªgi°î_øm
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

88 
uöt64_t
 
size
, 
devøm_Êags
)

90  
s
->
	`ªgi°î_øm
(s, 
addr
, 
size
, 
devøm_Êags
);

91 
	}
}

92 
PhysMem‹yR™ge
 *
˝u_ªgi°î_devi˚
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
addr
,

93 
uöt64_t
 
size
, *
›aque
,

94 
Devi˚RódFunc
 *
ªad_func
, 
Devi˚WrôeFunc
 *
wrôe_func
,

95 
devio_Êags
);

96 
PhysMem‹yR™ge
 *
gë_phys_mem_ønge
(
PhysMem‹yM≠
 *
s
, 
uöt64_t
 
∑ddr
);

97 
phys_mem_£t_addr
(
PhysMem‹yR™ge
 *
¥
, 
uöt64_t
 
addr
, 
BOOL
 
íabÀd
);

99 
ölöe
 c⁄° 
uöt32_t
 *
	$phys_mem_gë_dúty_bôs
(
PhysMem‹yR™ge
 *
¥
)

101 
PhysMem‹yM≠
 *
m≠
 = 
¥
->map;

102  
m≠
->
	`gë_dúty_bôs
(m≠, 
¥
);

103 
	}
}

105 
ölöe
 
	$phys_mem_£t_dúty_bô
(
PhysMem‹yR™ge
 *
¥
, 
size_t
 
off£t
)

107 
size_t
 
∑ge_ödex
;

108 
uöt32_t
 
mask
, *
dúty_bôs_±r
;

109 i‡(
¥
->
dúty_bôs
) {

110 
∑ge_ödex
 = 
off£t
 >> 
DEVRAM_PAGE_SIZE_LOG2
;

111 
mask
 = 1 << (
∑ge_ödex
 & 0x1f);

112 
dúty_bôs_±r
 = 
¥
->
dúty_bôs
 + (
∑ge_ödex
 >> 5);

113 *
dúty_bôs_±r
 |
mask
;

115 
	}
}

117 
ölöe
 
BOOL
 
	$phys_mem_is_dúty_bô
(
PhysMem‹yR™ge
 *
¥
, 
size_t
 
off£t
)

119 
size_t
 
∑ge_ödex
;

120 
uöt32_t
 *
dúty_bôs_±r
;

121 i‡(!
¥
->
dúty_bôs
)

122  
TRUE
;

123 
∑ge_ödex
 = 
off£t
 >> 
DEVRAM_PAGE_SIZE_LOG2
;

124 
dúty_bôs_±r
 = 
¥
->
dúty_bôs
 + (
∑ge_ödex
 >> 5);

125  (*
dúty_bôs_±r
 >> (
∑ge_ödex
 & 0x1f)) & 1;

126 
	}
}

128 
phys_mem_ª£t_dúty_bô
(
PhysMem‹yR™ge
 *
¥
, 
size_t
 
off£t
);

129 
uöt8_t
 *
phys_mem_gë_øm_±r
(
PhysMem‹yM≠
 *
m≠
, 
uöt64_t
 
∑ddr
, 
BOOL
 
is_rw
);

133 
	tSëIRQFunc
(*
	t›aque
, 
	túq_num
, 
	tÀvñ
);

136 
SëIRQFunc
 *
	m£t_úq
;

137 *
	m›aque
;

138 
	múq_num
;

139 } 
	tIRQSig«l
;

141 
úq_öô
(
IRQSig«l
 *
úq
, 
SëIRQFunc
 *
£t_úq
, *
›aque
, 
úq_num
);

143 
ölöe
 
	$£t_úq
(
IRQSig«l
 *
úq
, 
Àvñ
)

145 
úq
->
	`£t_úq
(úq->
›aque
, irq->
úq_num
, 
Àvñ
);

146 
	}
}

	@json.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

30 
	~<f˙é.h
>

31 
	~<î∫o.h
>

32 
	~<uni°d.h
>

33 
	~<time.h
>

34 
	~<˘y≥.h
>

36 
	~"cutûs.h
"

37 
	~"js⁄.h
"

38 
	~"fs_utûs.h
"

40 
JSONVÆue
 
	$∑r£_°rög
(c⁄° **
µ
)

42 
buf
[4096], *
q
;

43 c⁄° *
p
;

44 
c
, 
h
;

46 
q
 = 
buf
;

47 
p
 = *
µ
;

48 
p
++;

50 
c
 = *
p
++;

51 i‡(
c
 == '\0' || c == '\n') {

52  
	`js⁄_îr‹_√w
("unterminated string");

53 } i‡(
c
 == '\"') {

55 } i‡(
c
 == '\\') {

56 
c
 = *
p
++;

57 
c
) {

61 
add_ch¨
;

63 
c
 = '\n';

64 
add_ch¨
;

66 
c
 = '\r';

67 
add_ch¨
;

69 
c
 = '\t';

70 
add_ch¨
;

72 
h
 = 
	`‰om_hex
(*
p
++);

73 i‡(
h
 < 0)

74  
	`js⁄_îr‹_√w
("invalig hex digit");

75 
c
 = 
h
 << 4;

76 
h
 = 
	`‰om_hex
(*
p
++);

77 i‡(
h
 < 0)

78  
	`js⁄_îr‹_√w
("invalig hex digit");

79 
c
 |
h
;

80 
add_ch¨
;

82  
	`js⁄_îr‹_√w
("unknownÉscape code");

85 
add_ch¨
:

86 i‡(
q
 >
buf
 + (buf) - 1)

87  
	`js⁄_îr‹_√w
("stringÅooÜong");

88 *
q
++ = 
c
;

91 *
q
 = '\0';

92 *
µ
 = 
p
;

93  
	`js⁄_°rög_√w
(
buf
);

94 
	}
}

96 
JSONPr›îty
 *
	$js⁄_obje˘_gë2
(
JSONObje˘
 *
obj
, c⁄° *
«me
)

98 
JSONPr›îty
 *
f
;

99 
i
;

100 
i
 = 0; i < 
obj
->
Àn
; i++) {

101 
f
 = &
obj
->
¥›s
[
i
];

102 i‡(!
	`°rcmp
(
f
->
«me
.
u
.
°r
->
d©a
,Çame))

103  
f
;

105  
NULL
;

106 
	}
}

108 
JSONVÆue
 
	$js⁄_obje˘_gë
(
JSONVÆue
 
vÆ
, c⁄° *
«me
)

110 
JSONPr›îty
 *
f
;

111 
JSONObje˘
 *
obj
;

113 i‡(
vÆ
.
ty≥
 !
JSON_OBJ
)

114  
	`js⁄_undeföed_√w
();

115 
obj
 = 
vÆ
.
u
.obj;

116 
f
 = 
	`js⁄_obje˘_gë2
(
obj
, 
«me
);

117 i‡(!
f
)

118  
	`js⁄_undeföed_√w
();

119  
f
->
vÆue
;

120 
	}
}

122 
	$js⁄_obje˘_£t
(
JSONVÆue
 
vÆ
, c⁄° *
«me
, JSONVÆuê
¥›_vÆ
)

124 
JSONObje˘
 *
obj
;

125 
JSONPr›îty
 *
f
;

126 
√w_size
;

128 i‡(
vÆ
.
ty≥
 !
JSON_OBJ
)

130 
obj
 = 
vÆ
.
u
.obj;

131 
f
 = 
	`js⁄_obje˘_gë2
(
obj
, 
«me
);

132 i‡(
f
) {

133 
	`js⁄_‰ì
(
f
->
vÆue
);

134 
f
->
vÆue
 = 
¥›_vÆ
;

136 i‡(
obj
->
Àn
 >obj->
size
) {

137 
√w_size
 = 
	`max_öt
(
obj
->
Àn
 + 1, obj->
size
 * 3 / 2);

138 
obj
->
¥›s
 = 
	`ªÆloc
(obj->¥›s, 
√w_size
 * (
JSONPr›îty
));

139 
obj
->
size
 = 
√w_size
;

141 
f
 = &
obj
->
¥›s
[obj->
Àn
++];

142 
f
->
«me
 = 
	`js⁄_°rög_√w
(name);

143 
f
->
vÆue
 = 
¥›_vÆ
;

146 
	}
}

148 
JSONVÆue
 
	$js⁄_¨øy_gë
(
JSONVÆue
 
vÆ
, 
idx
)

150 
JSONAºay
 *
¨øy
;

152 i‡(
vÆ
.
ty≥
 !
JSON_ARRAY
)

153  
	`js⁄_undeföed_√w
();

154 
¨øy
 = 
vÆ
.
u
.array;

155 i‡(
idx
 < 
¨øy
->
Àn
) {

156  
¨øy
->
èb
[
idx
];

158  
	`js⁄_undeföed_√w
();

160 
	}
}

162 
	$js⁄_¨øy_£t
(
JSONVÆue
 
vÆ
, 
idx
, JSONVÆuê
¥›_vÆ
)

164 
JSONAºay
 *
¨øy
;

165 
√w_size
;

167 i‡(
vÆ
.
ty≥
 !
JSON_ARRAY
)

169 
¨øy
 = 
vÆ
.
u
.array;

170 i‡(
idx
 < 
¨øy
->
Àn
) {

171 
	`js⁄_‰ì
(
¨øy
->
èb
[
idx
]);

172 
¨øy
->
èb
[
idx
] = 
¥›_vÆ
;

173 } i‡(
idx
 =
¨øy
->
Àn
) {

174 i‡(
¨øy
->
Àn
 >¨øy->
size
) {

175 
√w_size
 = 
	`max_öt
(
¨øy
->
Àn
 + 1,áºay->
size
 * 3 / 2);

176 
¨øy
->
èb
 = 
	`ªÆloc
◊ºay->èb, 
√w_size
 * (
JSONVÆue
));

177 
¨øy
->
size
 = 
√w_size
;

179 
¨øy
->
èb
[¨øy->
Àn
++] = 
¥›_vÆ
;

184 
	}
}

186 c⁄° *
	$js⁄_gë_°r
(
JSONVÆue
 
vÆ
)

188 i‡(
vÆ
.
ty≥
 !
JSON_STR
)

189  
NULL
;

190  
vÆ
.
u
.
°r
->
d©a
;

191 
	}
}

193 c⁄° *
	$js⁄_gë_îr‹
(
JSONVÆue
 
vÆ
)

195 i‡(
vÆ
.
ty≥
 !
JSON_EXCEPTION
)

196  
NULL
;

197  
vÆ
.
u
.
°r
->
d©a
;

198 
	}
}

200 
JSONVÆue
 
	$js⁄_°rög_√w2
(c⁄° *
°r
, 
Àn
)

202 
JSONVÆue
 
vÆ
;

203 
JSONSåög
 *
°r1
;

205 
°r1
 = 
	`mÆloc
((
JSONSåög
Ë+ 
Àn
 + 1);

206 
°r1
->
Àn
 =Üen;

207 
	`mem˝y
(
°r1
->
d©a
, 
°r
, 
Àn
 + 1);

208 
vÆ
.
ty≥
 = 
JSON_STR
;

209 
vÆ
.
u
.
°r
 = 
°r1
;

210  
vÆ
;

211 
	}
}

213 
JSONVÆue
 
	$js⁄_°rög_√w
(c⁄° *
°r
)

215  
	`js⁄_°rög_√w2
(
°r
, 
	`°æí
(str));

216 
	}
}

218 
JSONVÆue
 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 1, 2))Ë
	$js⁄_îr‹_√w
(c⁄° *
fmt
, ...)

220 
JSONVÆue
 
vÆ
;

221 
va_li°
 
≠
;

222 
buf
[256];

224 
	`va_°¨t
(
≠
, 
fmt
);

225 
	`v¢¥ötf
(
buf
, (buf), 
fmt
, 
≠
);

226 
	`va_íd
(
≠
);

227 
vÆ
 = 
	`js⁄_°rög_√w
(
buf
);

228 
vÆ
.
ty≥
 = 
JSON_EXCEPTION
;

229  
vÆ
;

230 
	}
}

232 
JSONVÆue
 
	$js⁄_obje˘_√w
()

234 
JSONVÆue
 
vÆ
;

235 
JSONObje˘
 *
obj
;

236 
obj
 = 
	`mÆlocz
((
JSONObje˘
));

237 
vÆ
.
ty≥
 = 
JSON_OBJ
;

238 
vÆ
.
u
.
obj
 = obj;

239  
vÆ
;

240 
	}
}

242 
JSONVÆue
 
	$js⁄_¨øy_√w
()

244 
JSONVÆue
 
vÆ
;

245 
JSONAºay
 *
¨øy
;

246 
¨øy
 = 
	`mÆlocz
((
JSONAºay
));

247 
vÆ
.
ty≥
 = 
JSON_ARRAY
;

248 
vÆ
.
u
.
¨øy
 =árray;

249  
vÆ
;

250 
	}
}

252 
	$js⁄_‰ì
(
JSONVÆue
 
vÆ
)

254 
vÆ
.
ty≥
) {

255 
JSON_STR
:

256 
JSON_EXCEPTION
:

257 
	`‰ì
(
vÆ
.
u
.
°r
);

259 
JSON_INT
:

260 
JSON_BOOL
:

261 
JSON_NULL
:

262 
JSON_UNDEFINED
:

264 
JSON_ARRAY
:

266 
JSONAºay
 *
¨øy
 = 
vÆ
.
u
.array;

267 
i
;

269 
i
 = 0; i < 
¨øy
->
Àn
; i++) {

270 
	`js⁄_‰ì
(
¨øy
->
èb
[
i
]);

272 
	`‰ì
(
¨øy
);

275 
JSON_OBJ
:

277 
JSONObje˘
 *
obj
 = 
vÆ
.
u
.obj;

278 
JSONPr›îty
 *
f
;

279 
i
;

281 
i
 = 0; i < 
obj
->
Àn
; i++) {

282 
f
 = &
obj
->
¥›s
[
i
];

283 
	`js⁄_‰ì
(
f
->
«me
);

284 
	`js⁄_‰ì
(
f
->
vÆue
);

286 
	`‰ì
(
obj
);

290 
	`ab‹t
();

292 
	}
}

294 
	$skù_•a˚s
(c⁄° **
µ
)

296 c⁄° *
p
;

297 
p
 = *
µ
;

299 i‡(
	`is•a˚
(*
p
)) {

300 
p
++;

301 } i‡(
p
[0] == '/' &&Ö[1] == '/') {

302 
p
 += 2;

303 *
p
 != '\0' && *p != '\n')

304 
p
++;

305 } i‡(
p
[0] == '/' &&Ö[1] == '*') {

306 
p
 += 2;

307 *
p
 != '\0' && (p[0] != '*' ||Ö[1] != '/'))

308 
p
++;

309 i‡(*
p
 != '\0')

310 
p
 += 2;

315 *
µ
 = 
p
;

316 
	}
}

318 
ölöe
 
BOOL
 
	$is_idít_fú°
(
c
)

320  (
c
 >= 'a' && c <= 'z') ||

321 (
c
 >= 'A' && c <= 'Z') ||

322 
c
 == '_' || c == '$';

323 
	}
}

325 
	$∑r£_idít
(*
buf
, 
buf_size
, c⁄° **
µ
)

327 *
q
;

328 c⁄° *
p
;

329 
p
 = *
µ
;

330 
q
 = 
buf
;

331 *
q
++ = *
p
++;

332 
	`is_idít_fú°
(*
p
Ë|| 
	`isdigô
(*p)) {

333 i‡((
q
 - 
buf
Ë>
buf_size
 - 1)

335 *
q
++ = *
p
++;

337 *
µ
 = 
p
;

338 *
q
 = '\0';

340 
	}
}

342 
JSONVÆue
 
	$js⁄_∑r£_vÆue2
(c⁄° **
µ
)

344 
buf
[128];

345 c⁄° *
p
;

346 
JSONVÆue
 
vÆ
, 
vÆ1
, 
èg
;

348 
p
 = *
µ
;

349 
	`skù_•a˚s
(&
p
);

350 i‡(*
p
 == '\0') {

351  
	`js⁄_îr‹_√w
("unexpectedÉnd of file");

353 i‡(
	`isdigô
(*
p
)) {

354 
vÆ
 = 
	`js⁄_öt32_√w
(
	`°πﬁ
(
p
, (**)&p, 0));

355 } i‡(*
p
 == '"') {

356 
vÆ
 = 
	`∑r£_°rög
(&
p
);

357 } i‡(*
p
 == '{') {

358 
p
++;

359 
vÆ
 = 
	`js⁄_obje˘_√w
();

361 
	`skù_•a˚s
(&
p
);

362 i‡(*
p
 == '}') {

363 
p
++;

366 i‡(*
p
 == '"') {

367 
èg
 = 
	`∑r£_°rög
(&
p
);

368 i‡(
	`js⁄_is_îr‹
(
èg
))

369  
èg
;

370 } i‡(
	`is_idít_fú°
(*
p
)) {

371 i‡(
	`∑r£_idít
(
buf
, (buf), &
p
) < 0)

372 
övÆid_¥›
;

373 
èg
 = 
	`js⁄_°rög_√w
(
buf
);

375 
övÆid_¥›
;

378 i‡(
èg
.
u
.
°r
->
Àn
 == 0) {

379 
övÆid_¥›
:

380  
	`js⁄_îr‹_√w
("InvalidÖropertyÇame");

382 
	`skù_•a˚s
(&
p
);

383 i‡(*
p
 != ':') {

384  
	`js⁄_îr‹_√w
("':'Éxpected");

386 
p
++;

388 
vÆ1
 = 
	`js⁄_∑r£_vÆue2
(&
p
);

389 
	`js⁄_obje˘_£t
(
vÆ
, 
èg
.
u
.
°r
->
d©a
, 
vÆ1
);

391 
	`skù_•a˚s
(&
p
);

392 i‡(*
p
 == ',') {

393 
p
++;

394 } i‡(*
p
 != '}') {

395  
	`js⁄_îr‹_√w
("expecting ',' or '}'");

398 } i‡(*
p
 == '[') {

399 
idx
;

401 
p
++;

402 
vÆ
 = 
	`js⁄_¨øy_√w
();

403 
idx
 = 0;

405 
	`skù_•a˚s
(&
p
);

406 i‡(*
p
 == ']') {

407 
p
++;

410 
vÆ1
 = 
	`js⁄_∑r£_vÆue2
(&
p
);

411 
	`js⁄_¨øy_£t
(
vÆ
, 
idx
++, 
vÆ1
);

413 
	`skù_•a˚s
(&
p
);

414 i‡(*
p
 == ',') {

415 
p
++;

416 } i‡(*
p
 != ']') {

417  
	`js⁄_îr‹_√w
("expecting ',' or ']'");

420 } i‡(
	`is_idít_fú°
(*
p
)) {

421 i‡(
	`∑r£_idít
(
buf
, (buf), &
p
) < 0)

422 
unknown_id
;

423 i‡(!
	`°rcmp
(
buf
, "null")) {

424 
vÆ
 = 
	`js⁄_nuŒ_√w
();

425 } i‡(!
	`°rcmp
(
buf
, "true")) {

426 
vÆ
 = 
	`js⁄_boﬁ_√w
(
TRUE
);

427 } i‡(!
	`°rcmp
(
buf
, "false")) {

428 
vÆ
 = 
	`js⁄_boﬁ_√w
(
FALSE
);

430 
unknown_id
:

431  
	`js⁄_îr‹_√w
("unknow¿idítifõr: '%s'", 
buf
);

434  
	`js⁄_îr‹_√w
("unexpected character");

436 *
µ
 = 
p
;

437  
vÆ
;

438 
	}
}

440 
JSONVÆue
 
	$js⁄_∑r£_vÆue
(c⁄° *
p
)

442 
JSONVÆue
 
vÆ
;

443 
vÆ
 = 
	`js⁄_∑r£_vÆue2
(&
p
);

444 i‡(
	`js⁄_is_îr‹
(
vÆ
))

445  
vÆ
;

446 
	`skù_•a˚s
(&
p
);

447 i‡(*
p
 != '\0') {

448 
	`js⁄_‰ì
(
vÆ
);

449  
	`js⁄_îr‹_√w
("unexpected charactersátÅheÉnd");

451  
vÆ
;

452 
	}
}

454 
JSONVÆue
 
	$js⁄_∑r£_vÆue_Àn
(c⁄° *
p
, 
Àn
)

456 *
°r
;

457 
JSONVÆue
 
vÆ
;

458 
°r
 = 
	`mÆloc
(
Àn
 + 1);

459 
	`mem˝y
(
°r
, 
p
, 
Àn
);

460 
°r
[
Àn
] = '\0';

461 
vÆ
 = 
	`js⁄_∑r£_vÆue
(
°r
);

462 
	`‰ì
(
°r
);

463  
vÆ
;

464 
	}
}

	@json.h

24 #i‚de‡
JSON_H


25 
	#JSON_H


	)

28 
	mJSON_STR
,

29 
	mJSON_INT
,

30 
	mJSON_OBJ
,

31 
	mJSON_ARRAY
,

32 
	mJSON_BOOL
,

33 
	mJSON_NULL
,

34 
	mJSON_UNDEFINED
,

35 
	mJSON_EXCEPTION
,

36 } 
	tJSONTy≥Enum
;

39 
	mÀn
;

40 
	md©a
[0];

41 } 
	tJSONSåög
;

43 
	sJSONVÆue
 {

44 
JSONTy≥Enum
 
	mty≥
;

46 
JSONSåög
 *
	m°r
;

47 
	möt32
;

48 
BOOL
 
	mb
;

49 
JSONObje˘
 *
	mobj
;

50 
JSONAºay
 *
	m¨øy
;

51 } 
	mu
;

52 } 
	tJSONVÆue
;

54 
	sJSONPr›îty
 {

55 
JSONVÆue
 
	m«me
;

56 
JSONVÆue
 
	mvÆue
;

57 } 
	tJSONPr›îty
;

59 
	sJSONObje˘
 {

60 
	mÀn
;

61 
	msize
;

62 
JSONPr›îty
 *
	m¥›s
;

63 } 
	tJSONObje˘
;

65 
	sJSONAºay
 {

66 
	mÀn
;

67 
	msize
;

68 
JSONVÆue
 *
	mèb
;

69 } 
	tJSONAºay
;

71 
JSONVÆue
 
js⁄_°rög_√w2
(c⁄° *
°r
, 
Àn
);

72 
JSONVÆue
 
js⁄_°rög_√w
(c⁄° *
°r
);

73 
JSONVÆue
 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 1, 2))Ë
	`js⁄_îr‹_√w
(c⁄° *
fmt
, ...);

74 
	`js⁄_‰ì
(
JSONVÆue
 
vÆ
);

76 
JSONVÆue
 
	`js⁄_obje˘_√w
();

77 
JSONVÆue
 
	`js⁄_obje˘_gë
(JSONVÆuê
vÆ
, c⁄° *
«me
);

78 
	`js⁄_obje˘_£t
(
JSONVÆue
 
vÆ
, c⁄° *
«me
, JSONVÆuê
¥›_vÆ
);

80 
JSONVÆue
 
	`js⁄_¨øy_√w
();

81 
JSONVÆue
 
	`js⁄_¨øy_gë
(JSONVÆuê
vÆ
, 
idx
);

82 
	`js⁄_¨øy_£t
(
JSONVÆue
 
vÆ
, 
idx
, JSONVÆuê
¥›_vÆ
);

84 
ölöe
 
BOOL
 
	$js⁄_is_îr‹
(
JSONVÆue
 
vÆ
)

86  
vÆ
.
ty≥
 =
JSON_EXCEPTION
;

87 
	}
}

89 
ölöe
 
BOOL
 
	$js⁄_is_undeföed
(
JSONVÆue
 
vÆ
)

91  
vÆ
.
ty≥
 =
JSON_UNDEFINED
;

92 
	}
}

94 
ölöe
 
JSONVÆue
 
	$js⁄_undeföed_√w
()

96 
JSONVÆue
 
vÆ
;

97 
vÆ
.
ty≥
 = 
JSON_UNDEFINED
;

98 
vÆ
.
u
.
öt32
 = 0;

99  
vÆ
;

100 
	}
}

102 
ölöe
 
JSONVÆue
 
	$js⁄_nuŒ_√w
()

104 
JSONVÆue
 
vÆ
;

105 
vÆ
.
ty≥
 = 
JSON_NULL
;

106 
vÆ
.
u
.
öt32
 = 0;

107  
vÆ
;

108 
	}
}

110 
ölöe
 
JSONVÆue
 
	$js⁄_öt32_√w
(
v
)

112 
JSONVÆue
 
vÆ
;

113 
vÆ
.
ty≥
 = 
JSON_INT
;

114 
vÆ
.
u
.
öt32
 = 
v
;

115  
vÆ
;

116 
	}
}

118 
ölöe
 
JSONVÆue
 
	$js⁄_boﬁ_√w
(
BOOL
 
v
)

120 
JSONVÆue
 
vÆ
;

121 
vÆ
.
ty≥
 = 
JSON_BOOL
;

122 
vÆ
.
u
.
b
 = 
v
;

123  
vÆ
;

124 
	}
}

126 c⁄° *
js⁄_gë_°r
(
JSONVÆue
 
vÆ
);

127 c⁄° *
js⁄_gë_îr‹
(
JSONVÆue
 
vÆ
);

129 
JSONVÆue
 
js⁄_∑r£_vÆue
(c⁄° *
p
);

130 
JSONVÆue
 
js⁄_∑r£_vÆue_Àn
(c⁄° *
p
, 
Àn
);

	@list.h

24 #i‚de‡
LIST_H


25 
	#LIST_H


	)

27 
	sli°_hód
 {

28 
li°_hód
 *
	m¥ev
;

29 
li°_hód
 *
	m√xt
;

33 
	#li°_íåy
(
ñ
, 
ty≥
, 
membî
) \

34 ((
ty≥
 *)((
uöt8_t
 *)(
ñ
Ë- 
	`off£tof
—y≥, 
membî
)))

	)

36 
ölöe
 
	$öô_li°_hód
(
li°_hód
 *
hód
)

38 
hód
->
¥ev
 = head;

39 
hód
->
√xt
 = head;

40 
	}
}

43 
ölöe
 
	$__li°_add
(
li°_hód
 *
ñ
,

44 
li°_hód
 *
¥ev
, li°_hód *
√xt
)

46 
¥ev
->
√xt
 = 
ñ
;

47 
ñ
->
¥ev
 =Örev;

48 
ñ
->
√xt
 =Çext;

49 
√xt
->
¥ev
 = 
ñ
;

50 
	}
}

53 
ölöe
 
	$li°_add
(
li°_hód
 *
ñ
, li°_hód *
hód
)

55 
	`__li°_add
(
ñ
, 
hód
, hód->
√xt
);

56 
	}
}

59 
ölöe
 
	$li°_add_èû
(
li°_hód
 *
ñ
, li°_hód *
hód
)

61 
	`__li°_add
(
ñ
, 
hód
->
¥ev
, head);

62 
	}
}

64 
ölöe
 
	$li°_dñ
(
li°_hód
 *
ñ
)

66 
li°_hód
 *
¥ev
, *
√xt
;

67 
¥ev
 = 
ñ
->prev;

68 
√xt
 = 
ñ
->next;

69 
¥ev
->
√xt
 =Çext;

70 
√xt
->
¥ev
 =Örev;

71 
ñ
->
¥ev
 = 
NULL
;

72 
ñ
->
√xt
 = 
NULL
;

73 
	}
}

75 
ölöe
 
	$li°_em±y
(
li°_hód
 *
ñ
)

77  
ñ
->
√xt
 ==Él;

78 
	}
}

80 
	#li°_f‹_óch
(
ñ
, 
hód
) \

81 
ñ
 = (
hód
)->
√xt
;É»!(hód);É»ñ->√xt)

	)

83 
	#li°_f‹_óch_ß„
(
ñ
, 
ñ1
, 
hód
) \

84 
ñ
 = (
hód
)->
√xt
, 
ñ1
 =Él->next;Él != (head); \

85 
ñ
 = 
ñ1
,Él1 =Él->
√xt
)

	)

87 
	#li°_f‹_óch_¥ev
(
ñ
, 
hód
) \

88 
ñ
 = (
hód
)->
¥ev
;É»!(hód);É»ñ->¥ev)

	)

90 
	#li°_f‹_óch_¥ev_ß„
(
ñ
, 
ñ1
, 
hód
) \

91 
ñ
 = (
hód
)->
¥ev
, 
ñ1
 =Él->prev;Él != (head); \

92 
ñ
 = 
ñ1
,Él1 =Él->
¥ev
)

	)

	@machine.c

32 
	~<°dlib.h
>

33 
	~<°dio.h
>

34 
	~<°d¨g.h
>

35 
	~<°rög.h
>

36 
	~<öây≥s.h
>

37 
	~<as£π.h
>

38 
	~<f˙é.h
>

39 
	~<î∫o.h
>

40 
	~<uni°d.h
>

41 
	~<time.h
>

43 
	~"cutûs.h
"

44 
	~"iomem.h
"

45 
	~"vútio.h
"

46 
	~"machöe.h
"

47 
	~"fs_utûs.h
"

48 #ifde‡
CONFIG_FS_NET


49 
	~"fs_wgë.h
"

52 
	~"riscvsim/sim_∑øms_°©s.h
"

54 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 1, 2))Ë
	$vm_îr‹
(c⁄° *
fmt
, ...)

56 
va_li°
 
≠
;

57 
	`va_°¨t
(
≠
, 
fmt
);

58 #ifde‡
EMSCRIPTEN


59 
	`v¥ötf
(
fmt
, 
≠
);

61 
	`vÂrötf
(
°dîr
, 
fmt
, 
≠
);

63 
	`va_íd
(
≠
);

64 
	}
}

66 
	$vm_gë_öt
(
JSONVÆue
 
obj
, c⁄° *
«me
, *
pvÆ
)

68 
JSONVÆue
 
vÆ
;

69 
vÆ
 = 
	`js⁄_obje˘_gë
(
obj
, 
«me
);

70 i‡(
	`js⁄_is_undeföed
(
vÆ
)) {

71 
	`vm_îr‹
("ex≥˘ög '%s'Ör›îty\n", 
«me
);

74 i‡(
vÆ
.
ty≥
 !
JSON_INT
) {

75 
	`vm_îr‹
("%s: i¡egîÉx≥˘ed\n", 
«me
);

78 *
pvÆ
 = 
vÆ
.
u
.
öt32
;

80 
	}
}

82 
	$vm_gë_öt_›t
(
JSONVÆue
 
obj
, c⁄° *
«me
, *
pvÆ
, 
def_vÆ
)

84 
JSONVÆue
 
vÆ
;

85 
vÆ
 = 
	`js⁄_obje˘_gë
(
obj
, 
«me
);

86 i‡(
	`js⁄_is_undeföed
(
vÆ
)) {

87 *
pvÆ
 = 
def_vÆ
;

90 i‡(
vÆ
.
ty≥
 !
JSON_INT
) {

91 
	`vm_îr‹
("%s: i¡egîÉx≥˘ed\n", 
«me
);

94 *
pvÆ
 = 
vÆ
.
u
.
öt32
;

96 
	}
}

98 
	$vm_gë_°r2
(
JSONVÆue
 
obj
, c⁄° *
«me
, c⁄° **
p°r
,

99 
BOOL
 
is_›t
)

101 
JSONVÆue
 
vÆ
;

102 
vÆ
 = 
	`js⁄_obje˘_gë
(
obj
, 
«me
);

103 i‡(
	`js⁄_is_undeföed
(
vÆ
)) {

104 i‡(
is_›t
) {

105 *
p°r
 = 
NULL
;

108 
	`vm_îr‹
("ex≥˘ög '%s'Ör›îty\n", 
«me
);

112 i‡(
vÆ
.
ty≥
 !
JSON_STR
) {

113 
	`vm_îr‹
("%s: såögÉx≥˘ed\n", 
«me
);

116 *
p°r
 = 
vÆ
.
u
.
°r
->
d©a
;

118 
	}
}

120 
	$vm_gë_°r
(
JSONVÆue
 
obj
, c⁄° *
«me
, c⁄° **
p°r
)

122  
	`vm_gë_°r2
(
obj
, 
«me
, 
p°r
, 
FALSE
);

123 
	}
}

125 
	$vm_gë_°r_›t
(
JSONVÆue
 
obj
, c⁄° *
«me
, c⁄° **
p°r
)

127  
	`vm_gë_°r2
(
obj
, 
«me
, 
p°r
, 
TRUE
);

128 
	}
}

130 *
	$°rdup_nuŒ
(c⁄° *
°r
)

132 i‡(!
°r
)

133  
NULL
;

135  
	`°rdup
(
°r
);

136 
	}
}

139 *
	$cmdlöe_sub°
(c⁄° *
cmdlöe
)

141 
DynBuf
 
dbuf
;

142 c⁄° *
p
;

143 
v¨_«me
[32], *
q
, 
buf
[32];

145 
	`dbuf_öô
(&
dbuf
);

146 
p
 = 
cmdlöe
;

147 *
p
 != '\0') {

148 i‡(
p
[0] == '$' &&Ö[1] == '{') {

149 
p
 += 2;

150 
q
 = 
v¨_«me
;

151 *
p
 != '\0' && *p != '}') {

152 i‡((
q
 - 
v¨_«me
) < (var_name) - 1)

153 *
q
++ = *
p
;

154 
p
++;

156 *
q
 = '\0';

157 i‡(*
p
 == '}')

158 
p
++;

159 i‡(!
	`°rcmp
(
v¨_«me
, "TZ")) {

160 
time_t
 
ti
;

161 
tm
Åm;

162 
n
, 
sg
;

164 
	`time
(&
ti
);

165 
	`loˇ…ime_r
(&
ti
, &
tm
);

166 
n
 = 
tm
.
tm_gmtoff
 / 60;

167 
sg
 = '-';

168 i‡(
n
 < 0) {

169 
sg
 = '+';

170 
n
 = -n;

172 
	`¢¥ötf
(
buf
, (buf), "UTC%c%02d:%02d",

173 
sg
, 
n
 / 60,Ç % 60);

174 
	`dbuf_put°r
(&
dbuf
, 
buf
);

177 
	`dbuf_putc
(&
dbuf
, *
p
++);

180 
	`dbuf_putc
(&
dbuf
, 0);

181  (*)
dbuf
.
buf
;

182 
	}
}

186 
	#LATENCY_STRING_MAX_LENGTH
 256

	)

188 
	$∑r£_°age_œãncy_°r
(**
de°
, 
max_°age_cou¡
, *
°r
)

190 
pos
;

191 *
±r
;

194 *
de°
 = (*)
	`ªÆloc
((*de°), 
max_°age_cou¡
 * ());

195 
	`as£π
(*
de°
);

197 
pos
 = 0;

198 
±r
 = 
	`°πok
(
°r
, ",");

199 
±r
 !
NULL
)

201 (*
de°
)[
pos
++] = 
	`©oi
(
±r
);

202 
±r
 = 
	`°πok
(
NULL
, ",");

203 i‡(
pos
 >
max_°age_cou¡
)

210 i‡(
pos
 !
max_°age_cou¡
)

212 
	`Ârötf
(
°dîr
, "îr‹:Ü©ícy såög %†d€†nŸ s≥cifyáŒÅhêœãncõs\n", 
°r
);

213 
	`exô
(1);

215 
	}
}

217 
BOOL
 
	$föd_«me
(c⁄° *
«me
, c⁄° *
«me_li°
)

219 
size_t
 
Àn
;

220 c⁄° *
p
, *
r
;

222 
p
 = 
«me_li°
;

224 
r
 = 
	`°rchr
(
p
, ',');

225 i‡(!
r
) {

226 i‡(!
	`°rcmp
(
«me
, 
p
))

227  
TRUE
;

230 
Àn
 = 
r
 - 
p
;

231 i‡(
Àn
 =
	`°æí
(
«me
Ë&& !
	`memcmp
“ame, 
p
,Üen))

232  
TRUE
;

233 
p
 = 
r
 + 1;

236  
FALSE
;

237 
	}
}

239 c⁄° 
VútMachöeCœss
 *
	gvút_machöe_li°
[] = {

240 #i‡
deföed
(
EMSCRIPTEN
)

242 #i‚de‡
CONFIG_X86EMU


243 &
riscv_machöe_˛ass
,

246 &
riscv_machöe_˛ass
,

248 #ifde‡
CONFIG_X86EMU


249 &
pc_machöe_˛ass
,

251 
NULL
,

254 c⁄° 
VútMachöeCœss
 *
	$vút_machöe_föd_˛ass
(c⁄° *
machöe_«me
)

256 c⁄° 
VútMachöeCœss
 *
vmc
, **
pvmc
;

258 
pvmc
 = 
vút_machöe_li°
; *pvm¯!
NULL
;Övmc++) {

259 
vmc
 = *
pvmc
;

260 i‡(
	`föd_«me
(
machöe_«me
, 
vmc
->
machöe_«mes
))

261  
vmc
;

263  
NULL
;

264 
	}
}

266 
	$vút_machöe_∑r£_c⁄fig
(
VútMachöeP¨ams
 *
p
,

267 *
c⁄fig_fûe_°r
, 
Àn
)

269 
vîsi⁄
, 
vÆ
;

270 c⁄° *
èg_«me
, *
°r
;

271 
buf1
[256];

272 
JSONVÆue
 
cfg
, 
obj
, 
obj1
, 
ñ
;

273 
°age_œãncy_°r
[
LATENCY_STRING_MAX_LENGTH
];

275 
cfg
 = 
	`js⁄_∑r£_vÆue_Àn
(
c⁄fig_fûe_°r
, 
Àn
);

276 i‡(
	`js⁄_is_îr‹
(
cfg
)) {

277 
	`vm_îr‹
("îr‹: %s\n", 
	`js⁄_gë_îr‹
(
cfg
));

278 
	`js⁄_‰ì
(
cfg
);

282 i‡(
	`vm_gë_öt
(
cfg
, "vîsi⁄", &
vîsi⁄
) < 0)

283 
èg_Áû
;

284 i‡(
vîsi⁄
 !
VM_CONFIG_VERSION
) {

285 i‡(
vîsi⁄
 > 
VM_CONFIG_VERSION
) {

286 
	`vm_îr‹
("TheÉmulator isÅoo oldÅoÑunÅhis VM:Ölease upgrade\n");

289 
	`vm_îr‹
("The VM configuration file isÅoo old forÅhisÉmulator version:Ölease upgradeÅhe VM configuration file\n");

294 i‡(
	`vm_gë_°r
(
cfg
, "machöe", &
°r
) < 0)

295 
èg_Áû
;

296 
p
->
machöe_«me
 = 
	`°rdup
(
°r
);

297 
p
->
vmc
 = 
	`vút_machöe_föd_˛ass
’->
machöe_«me
);

298 i‡(!
p
->
vmc
) {

299 
	`vm_îr‹
("Unknow¿machöê«me: %s\n", 
p
->
machöe_«me
);

300 
èg_Áû
;

302 
p
->
vmc
->
	`vút_machöe_£t_deÁu…s
(p);

304 
èg_«me
 = "memory_size";

305 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
vÆ
) < 0)

306 
èg_Áû
;

307 
p
->
øm_size
 = (
uöt64_t
)
vÆ
 << 20;

309 
èg_«me
 = "bios";

310 i‡(
	`vm_gë_°r_›t
(
cfg
, 
èg_«me
, &
°r
) < 0)

311 
èg_Áû
;

312 i‡(
°r
) {

313 
p
->
fûes
[
VM_FILE_BIOS
].
fûíame
 = 
	`°rdup
(
°r
);

316 
èg_«me
 = "kernel";

317 i‡(
	`vm_gë_°r_›t
(
cfg
, 
èg_«me
, &
°r
) < 0)

318 
èg_Áû
;

319 i‡(
°r
) {

320 
p
->
fûes
[
VM_FILE_KERNEL
].
fûíame
 = 
	`°rdup
(
°r
);

323 
èg_«me
 = "initrd";

324 i‡(
	`vm_gë_°r_›t
(
cfg
, 
èg_«me
, &
°r
) < 0)

325 
èg_Áû
;

326 i‡(
°r
) {

327 
p
->
fûes
[
VM_FILE_INITRD
].
fûíame
 = 
	`°rdup
(
°r
);

330 i‡(
	`vm_gë_°r_›t
(
cfg
, "cmdlöe", &
°r
) < 0)

331 
èg_Áû
;

332 i‡(
°r
) {

333 
p
->
cmdlöe
 = 
	`cmdlöe_sub°
(
°r
);

337 
	`¢¥ötf
(
buf1
, (buf1), "drive%d", 
p
->
drive_cou¡
);

338 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

339 i‡(
	`js⁄_is_undeföed
(
obj
))

341 i‡(
p
->
drive_cou¡
 >
MAX_DRIVE_DEVICE
) {

342 
	`vm_îr‹
("Too many drives\n");

345 i‡(
	`vm_gë_°r
(
obj
, "fûe", &
°r
) < 0)

346 
èg_Áû
;

347 
p
->
èb_drive
[p->
drive_cou¡
].
fûíame
 = 
	`°rdup
(
°r
);

348 i‡(
	`vm_gë_°r_›t
(
obj
, "devi˚", &
°r
) < 0)

349 
èg_Áû
;

350 
p
->
èb_drive
[p->
drive_cou¡
].
devi˚
 = 
	`°rdup_nuŒ
(
°r
);

351 
p
->
drive_cou¡
++;

355 
	`¢¥ötf
(
buf1
, (buf1), "fs%d", 
p
->
fs_cou¡
);

356 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

357 i‡(
	`js⁄_is_undeföed
(
obj
))

359 i‡(
p
->
fs_cou¡
 >
MAX_DRIVE_DEVICE
) {

360 
	`vm_îr‹
("Too many filesystems\n");

363 i‡(
	`vm_gë_°r
(
obj
, "fûe", &
°r
) < 0)

364 
èg_Áû
;

365 
p
->
èb_fs
[p->
fs_cou¡
].
fûíame
 = 
	`°rdup
(
°r
);

366 i‡(
	`vm_gë_°r_›t
(
obj
, "èg", &
°r
) < 0)

367 
èg_Áû
;

368 i‡(!
°r
) {

369 i‡(
p
->
fs_cou¡
 == 0)

370 
	`°r˝y
(
buf1
, "/dev/root");

372 
	`¢¥ötf
(
buf1
, (buf1), "/dev/roŸ%d", 
p
->
fs_cou¡
);

373 
°r
 = 
buf1
;

375 
p
->
èb_fs
[p->
fs_cou¡
].
èg
 = 
	`°rdup
(
°r
);

376 
p
->
fs_cou¡
++;

380 
	`¢¥ötf
(
buf1
, (buf1), "ëh%d", 
p
->
ëh_cou¡
);

381 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

382 i‡(
	`js⁄_is_undeföed
(
obj
))

384 i‡(
p
->
ëh_cou¡
 >
MAX_ETH_DEVICE
) {

385 
	`vm_îr‹
("Too manyÉthernet interfaces\n");

388 i‡(
	`vm_gë_°r
(
obj
, "drivî", &
°r
) < 0)

389 
èg_Áû
;

390 
p
->
èb_ëh
[p->
ëh_cou¡
].
drivî
 = 
	`°rdup
(
°r
);

391 i‡(!
	`°rcmp
(
°r
, "tap")) {

392 i‡(
	`vm_gë_°r
(
obj
, "i‚ame", &
°r
) < 0)

393 
èg_Áû
;

394 
p
->
èb_ëh
[p->
ëh_cou¡
].
i‚ame
 = 
	`°rdup
(
°r
);

396 
p
->
ëh_cou¡
++;

399 
p
->
di•œy_devi˚
 = 
NULL
;

400 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, "display0");

401 i‡(!
	`js⁄_is_undeföed
(
obj
)) {

402 i‡(
	`vm_gë_°r
(
obj
, "devi˚", &
°r
) < 0)

403 
èg_Áû
;

404 
p
->
di•œy_devi˚
 = 
	`°rdup
(
°r
);

405 i‡(
	`vm_gë_öt
(
obj
, "width", &
p
->
width
) < 0)

406 
èg_Áû
;

407 i‡(
	`vm_gë_öt
(
obj
, "height", &
p
->
height
) < 0)

408 
èg_Áû
;

409 i‡(
	`vm_gë_°r_›t
(
obj
, "vga_bios", &
°r
) < 0)

410 
èg_Áû
;

411 i‡(
°r
) {

412 
p
->
fûes
[
VM_FILE_VGA_BIOS
].
fûíame
 = 
	`°rdup
(
°r
);

416 i‡(
	`vm_gë_°r_›t
(
cfg
, "öput_devi˚", &
°r
) < 0)

417 
èg_Áû
;

418 
p
->
öput_devi˚
 = 
	`°rdup_nuŒ
(
°r
);

420 i‡(
	`vm_gë_°r_›t
(
cfg
, "ac˚l", &
°r
) < 0)

421 
èg_Áû
;

422 i‡(
°r
) {

423 i‡(!
	`°rcmp
(
°r
, "none")) {

424 
p
->
ac˚l_íabÀ
 = 
FALSE
;

425 } i‡(!
	`°rcmp
(
°r
, "auto")) {

426 
p
->
ac˚l_íabÀ
 = 
TRUE
;

428 
	`vm_îr‹
("unsuµ‹ãd 'ac˚l' c⁄fig: %s\n", 
°r
);

433 
èg_«me
 = "rtc_local_time";

434 
ñ
 = 
	`js⁄_obje˘_gë
(
cfg
, 
èg_«me
);

435 i‡(!
	`js⁄_is_undeföed
(
ñ
)) {

436 i‡(
ñ
.
ty≥
 !
JSON_BOOL
) {

437 
	`vm_îr‹
("%s: boﬁó¿ex≥˘ed\n", 
èg_«me
);

438 
èg_Áû
;

440 
p
->
πc_loˇl_time
 = 
ñ
.
u
.
b
;

444 
èg_«me
 = "core_name";

445 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

446 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %s\n", 
èg_«me
,

447 
p
->
sim_∑øms
->
c‹e_«me
);

449 
	`‰ì
(
p
->
sim_∑øms
->
c‹e_«me
);

450 
p
->
sim_∑øms
->
c‹e_«me
 = 
	`°rdup
(
°r
);

453 
èg_«me
 = "core_type";

454 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

455 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %s\n", 
èg_«me
,

456 
c‹e_ty≥_°r
[
p
->
sim_∑øms
->
c‹e_ty≥
]);

458 i‡(
	`°rcmp
(
°r
, "incore") == 0){

459 
p
->
sim_∑øms
->
c‹e_ty≥
 = 
CORE_TYPE_INCORE
;

460 } i‡(
	`°rcmp
(
°r
, "oocore") == 0){

461 
p
->
sim_∑øms
->
c‹e_ty≥
 = 
CORE_TYPE_OOCORE
;

465 i‡(
p
->
sim_∑øms
->
c‹e_ty≥
 =
CORE_TYPE_INCORE
) {

466 
èg_«me
 = "num_cpu_stages";

467 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
num_˝u_°ages
) < 0) {

468 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

469 
èg_«me
, 
p
->
sim_∑øms
->
num_˝u_°ages
);

472 
èg_«me
 = "enable_parallel_fu";

473 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

474 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆuê%s\n", 
èg_«me
,

475 
sim_∑øm_°©us
[
p
->
sim_∑øms
->
íabÀ_∑øŒñ_fu
]);

478 i‡(
	`°rcmp
(
°r
, "false") == 0) {

479 
p
->
sim_∑øms
->
íabÀ_∑øŒñ_fu
 = 
DISABLE
;

480 } i‡(
	`°rcmp
(
°r
, "true") == 0) {

481 
p
->
sim_∑øms
->
íabÀ_∑øŒñ_fu
 = 
ENABLE
;

483 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

484 
	`exô
(1);

488 } i‡(
p
->
sim_∑øms
->
c‹e_ty≥
 =
CORE_TYPE_OOCORE
) {

489 
èg_«me
 = "iq_size";

490 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
iq_size
) < 0) {

491 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

492 
èg_«me
, 
p
->
sim_∑øms
->
iq_size
);

495 
èg_«me
 = "iq_issue_ports";

496 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
iq_issue_p‹ts
) < 0) {

497 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

498 
èg_«me
, 
p
->
sim_∑øms
->
iq_issue_p‹ts
);

501 
èg_«me
 = "rob_size";

502 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
rob_size
) < 0) {

503 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

504 
èg_«me
, 
p
->
sim_∑øms
->
rob_size
);

507 
èg_«me
 = "rob_commit_ports";

508 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
rob_commô_p‹ts
) < 0) {

509 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

510 
èg_«me
, 
p
->
sim_∑øms
->
rob_commô_p‹ts
);

514 
èg_«me
 = "lsq_size";

515 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
lsq_size
) < 0) {

516 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

517 
èg_«me
, 
p
->
sim_∑øms
->
lsq_size
);

521 
èg_«me
 = "sim_stats_path";

522 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

523 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %s\n",

524 
èg_«me
, 
p
->
sim_∑øms
->
sim_°©s_∑th
);

526 
	`‰ì
(
p
->
sim_∑øms
->
sim_°©s_∑th
);

527 
p
->
sim_∑øms
->
sim_°©s_∑th
 = 
	`°rdup
(
°r
);

530 
	`¢¥ötf
(
buf1
, (buf1), "%s", "execution_units");

531 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

533 i‡(
	`js⁄_is_undeföed
(
obj
)) {

534 
	`Ârötf
(
°dîr
, "%s objectÇot found, selecting default values\n",

535 
buf1
);

538 
èg_«me
 = "num_alu_stages";

539 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
num_Æu_°ages
) < 0) {

540 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

541 
èg_«me
, 
p
->
sim_∑øms
->
num_Æu_°ages
);

544 
èg_«me
 = "alu_stage_latency";

545 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

546 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue\n", 
èg_«me
);

548 
	`°∫˝y
(
°age_œãncy_°r
, 
°r
, 
LATENCY_STRING_MAX_LENGTH
 - 1);

549 
°age_œãncy_°r
[
LATENCY_STRING_MAX_LENGTH
 - 1] = '\0';

550 
	`∑r£_°age_œãncy_°r
(&
p
->
sim_∑øms
->
Æu_°age_œãncy
,

551 
p
->
sim_∑øms
->
num_Æu_°ages
, 
°age_œãncy_°r
);

554 
èg_«me
 = "num_mul_stages";

555 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
num_mul_°ages
) < 0) {

556 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %d\n", 
èg_«me
,

557 
p
->
sim_∑øms
->
num_mul_°ages
);

560 
èg_«me
 = "mul_stage_latency";

561 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

562 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue\n", 
èg_«me
);

564 
	`°∫˝y
(
°age_œãncy_°r
, 
°r
, 
LATENCY_STRING_MAX_LENGTH
 - 1);

565 
°age_œãncy_°r
[
LATENCY_STRING_MAX_LENGTH
 - 1] = '\0';

566 
	`∑r£_°age_œãncy_°r
(&
p
->
sim_∑øms
->
mul_°age_œãncy
,

567 
p
->
sim_∑øms
->
num_mul_°ages
, 
°age_œãncy_°r
);

570 
èg_«me
 = "num_div_stages";

571 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
num_div_°ages
) < 0) {

572 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

573 
èg_«me
, 
p
->
sim_∑øms
->
num_div_°ages
);

576 
èg_«me
 = "div_stage_latency";

577 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

578 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue\n", 
èg_«me
);

580 
	`°∫˝y
(
°age_œãncy_°r
, 
°r
, 
LATENCY_STRING_MAX_LENGTH
 - 1);

581 
°age_œãncy_°r
[
LATENCY_STRING_MAX_LENGTH
 - 1] = '\0';

582 
	`∑r£_°age_œãncy_°r
(&
p
->
sim_∑øms
->
div_°age_œãncy
,

583 
p
->
sim_∑øms
->
num_div_°ages
, 
°age_œãncy_°r
);

586 
èg_«me
 = "num_fpu_fma_stages";

587 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
num_Âu_fma_°ages
) < 0) {

588 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

589 
èg_«me
, 
p
->
sim_∑øms
->
num_Âu_fma_°ages
);

592 
èg_«me
 = "fpu_fma_stage_latency";

593 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

594 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue\n", 
èg_«me
);

596 
	`°∫˝y
(
°age_œãncy_°r
, 
°r
, 
LATENCY_STRING_MAX_LENGTH
 - 1);

597 
°age_œãncy_°r
[
LATENCY_STRING_MAX_LENGTH
 - 1] = '\0';

598 
	`∑r£_°age_œãncy_°r
(&
p
->
sim_∑øms
->
Âu_fma_°age_œãncy
,

599 
p
->
sim_∑øms
->
num_Âu_fma_°ages
,

600 
°age_œãncy_°r
);

603 
	`¢¥ötf
(
buf1
, (buf1), "%s", "fpu_alu");

604 
obj1
 = 
	`js⁄_obje˘_gë
(
obj
, 
buf1
);

606 
èg_«me
 = "fadd";

607 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FADD
]) < 0) {

608 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

609 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FADD
]);

612 
èg_«me
 = "fsub";

613 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSUB
]) < 0) {

614 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

615 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSUB
]);

618 
èg_«me
 = "fmul";

619 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMUL
]) < 0) {

620 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

621 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMUL
]);

624 
èg_«me
 = "fdiv";

625 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FDIV
]) < 0) {

626 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

627 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FDIV
]);

630 
èg_«me
 = "fsqrt";

631 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSQRT
]) < 0) {

632 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

633 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSQRT
]);

636 
èg_«me
 = "fsgnj";

637 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSGNJ
]) < 0) {

638 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

639 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSGNJ
]);

642 
èg_«me
 = "fmin";

643 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMIN
]) < 0) {

644 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

645 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMIN
]);

648 
èg_«me
 = "fmax";

649 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMAX
]) < 0) {

650 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

651 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMAX
]);

654 
èg_«me
 = "feq";

655 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FEQ
]) < 0) {

656 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

657 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FEQ
]);

660 
èg_«me
 = "flt";

661 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLT
]) < 0) {

662 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

663 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLT
]);

666 
èg_«me
 = "fle";

667 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLE
]) < 0) {

668 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

669 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLE
]);

672 
èg_«me
 = "fcvt";

673 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCVT
]) < 0) {

674 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

675 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCVT
]);

678 
èg_«me
 = "cvt";

679 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_CVT
]) < 0) {

680 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

681 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_CVT
]);

684 
èg_«me
 = "fmv";

685 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMV
]) < 0) {

686 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

687 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMV
]);

690 
èg_«me
 = "fclass";

691 i‡(
	`vm_gë_öt
(
obj1
, 
èg_«me
, &
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCLASS
]) < 0) {

692 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

693 
èg_«me
, 
p
->
sim_∑øms
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCLASS
]);

696 
èg_«me
 = "sim_trace_file";

697 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

698 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %s\n",

699 
èg_«me
, 
p
->
sim_∑øms
->
sim_åa˚_fûe
);

701 
	`‰ì
(
p
->
sim_∑øms
->
sim_åa˚_fûe
);

702 
p
->
sim_∑øms
->
sim_åa˚_fûe
 = 
	`°rdup
(
°r
);

705 
èg_«me
 = "tlb_size";

706 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
éb_size
) < 0) {

707 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

708 
èg_«me
, 
p
->
sim_∑øms
->
éb_size
);

711 
èg_«me
 = "pte_rw_latency";

712 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
±e_rw_œãncy
) < 0) {

713 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

714 
èg_«me
, 
p
->
sim_∑øms
->
±e_rw_œãncy
);

718 
èg_«me
 = "enable_bpu";

719 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

720 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆuê%s\n", 
èg_«me
,

721 
sim_∑øm_°©us
[
p
->
sim_∑øms
->
íabÀ_bpu
]);

724 i‡(
	`°rcmp
(
°r
, "false") == 0) {

725 
p
->
sim_∑øms
->
íabÀ_bpu
 = 
DISABLE
;

726 } i‡(
	`°rcmp
(
°r
, "true") == 0) {

727 
p
->
sim_∑øms
->
íabÀ_bpu
 = 
ENABLE
;

729 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

730 
	`exô
(1);

734 i‡(
p
->
sim_∑øms
->
íabÀ_bpu
 =
ENABLE
) {

735 
èg_«me
 = "btb_size";

736 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
btb_size
) < 0) {

737 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

738 
èg_«me
, 
p
->
sim_∑øms
->
btb_size
);

741 
èg_«me
 = "btb_ways";

742 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
btb_ways
) < 0) {

743 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

744 
èg_«me
, 
p
->
sim_∑øms
->
btb_ways
);

747 
èg_«me
 = "bpu_type";

748 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

749 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆuê%s\n", 
èg_«me
,

750 
bpu_ty≥_°r
[
p
->
sim_∑øms
->
bpu_ty≥
]);

753 i‡(
	`°rcmp
(
°r
, "bimodal") == 0) {

754 
p
->
sim_∑øms
->
bpu_ty≥
 = 
BPU_TYPE_BIMODAL
;

755 } i‡(
	`°rcmp
(
°r
, "adaptive") == 0) {

756 
p
->
sim_∑øms
->
bpu_ty≥
 = 
BPU_TYPE_ADAPTIVE
;

758 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

759 
	`exô
(1);

763 
èg_«me
 = "btb_eviction_policy";

764 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

765 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆuê%s\n", 
èg_«me
,

766 
btb_evi˘_°r
[
p
->
sim_∑øms
->
btb_evi˘i⁄_pﬁicy
]);

769 i‡(
	`°rcmp
(
°r
, "random") == 0) {

770 
p
->
sim_∑øms
->
btb_evi˘i⁄_pﬁicy
 = 
BTB_RANDOM_EVICT
;

771 } i‡(
	`°rcmp
(
°r
, "lru") == 0) {

772 
p
->
sim_∑øms
->
btb_evi˘i⁄_pﬁicy
 = 
BTB_LRU_EVICT
;

774 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

775 
	`exô
(1);

779 i‡(
p
->
sim_∑øms
->
bpu_ty≥
 =
BPU_TYPE_ADAPTIVE
) {

780 
èg_«me
 = "bpu_ght_size";

781 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
bpu_ght_size
) < 0) {

782 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

783 
èg_«me
, 
p
->
sim_∑øms
->
bpu_ght_size
);

786 
èg_«me
 = "bpu_pht_size";

787 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
bpu_pht_size
) < 0) {

788 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

789 
èg_«me
, 
p
->
sim_∑øms
->
bpu_pht_size
);

792 
èg_«me
 = "bpu_history_bits";

793 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
bpu_hi°‹y_bôs
) < 0) {

794 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

795 
èg_«me
, 
p
->
sim_∑øms
->
bpu_hi°‹y_bôs
);

798 i‡((
p
->
sim_∑øms
->
bpu_ght_size
 =1Ë&& (p->sim_∑øms->
bpu_pht_size
 == 1))

800 
èg_«me
 = "bpu_aliasing_func_type";

801 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

802 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆuê%s\n", 
èg_«me
,

803 
bpu_Æüsög_func_ty≥_°r
[
p
->
sim_∑øms
->
bpu_Æüsög_func_ty≥
]);

806 i‡(
	`°rcmp
(
°r
, "xor") == 0) {

807 
p
->
sim_∑øms
->
bpu_Æüsög_func_ty≥
 = 
BPU_ALIAS_FUNC_XOR
;

808 } i‡(
	`°rcmp
(
°r
, "and") == 0) {

809 
p
->
sim_∑øms
->
bpu_Æüsög_func_ty≥
 = 
BPU_ALIAS_FUNC_AND
;

810 } i‡(
	`°rcmp
(
°r
, "none") == 0) {

811 
p
->
sim_∑øms
->
bpu_Æüsög_func_ty≥
 = 
BPU_ALIAS_FUNC_NONE
;

813 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

814 
	`exô
(1);

819 
èg_«me
 = "bht_size";

820 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
bht_size
) < 0) {

821 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

822 
èg_«me
, 
p
->
sim_∑øms
->
bht_size
);

826 
èg_«me
 = "ras_size";

827 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
øs_size
) < 0) {

828 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value: %d\n",

829 
èg_«me
, 
p
->
sim_∑øms
->
øs_size
);

835 
èg_«me
 = "enable_l1_caches";

836 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

837 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆuê%s\n", 
èg_«me
,

838 
sim_∑øm_°©us
[
p
->
sim_∑øms
->
íabÀ_l1_ˇches
]);

841 i‡(
	`°rcmp
(
°r
, "false") == 0) {

842 
p
->
sim_∑øms
->
íabÀ_l1_ˇches
 = 
DISABLE
;

843 } i‡(
	`°rcmp
(
°r
, "true") == 0) {

844 
p
->
sim_∑øms
->
íabÀ_l1_ˇches
 = 
ENABLE
;

846 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

847 
	`exô
(1);

851 i‡(
p
->
sim_∑øms
->
íabÀ_l1_ˇches
) {

852 
	`¢¥ötf
(
buf1
, (buf1), "%s", "icache");

853 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

855 i‡(
	`js⁄_is_undeföed
(
obj
)) {

856 
	`Ârötf
(
°dîr
, "%s objectÇot found, selecting default values\n",

857 
buf1
);

860 
èg_«me
 = "read_latency";

861 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_code_ˇche_ªad_œãncy
) < 0) {

862 
	`Ârötf
(
°dîr
, "icache %sÇot found, selecting default value: %d\n",

863 
èg_«me
, 
p
->
sim_∑øms
->
l1_code_ˇche_ªad_œãncy
);

866 
èg_«me
 = "size";

867 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_code_ˇche_size
) < 0) {

868 
	`Ârötf
(
°dîr
, "icache %sÇot found, selecting default value: %d\n",

869 
èg_«me
, 
p
->
sim_∑øms
->
l1_code_ˇche_size
);

872 
èg_«me
 = "ways";

873 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_code_ˇche_ways
) < 0) {

874 
	`Ârötf
(
°dîr
, "icache %sÇot found, selecting default value: %d\n",

875 
èg_«me
, 
p
->
sim_∑øms
->
l1_code_ˇche_ways
);

878 
èg_«me
 = "eviction";

879 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

880 
	`Ârötf
(
°dîr
, "icache %sÖolicyÇot found, selecting default value %s\n",

881 
èg_«me
, 
ˇche_evi˘_°r
[
p
->
sim_∑øms
->
l1_code_ˇche_evi˘
]);

884 i‡(
	`°rcmp
(
°r
, "lru") == 0) {

885 
p
->
sim_∑øms
->
l1_code_ˇche_evi˘
 = 
CACHE_LRU_EVICT
;

886 } i‡(
	`°rcmp
(
°r
, "random") == 0) {

887 
p
->
sim_∑øms
->
l1_code_ˇche_evi˘
 = 
CACHE_RANDOM_EVICT
;

889 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ iˇchê%†pﬁicy ha†övÆid vÆue\n", 
èg_«me
);

890 
	`exô
(1);

894 
	`¢¥ötf
(
buf1
, (buf1), "%s", "dcache");

895 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

897 i‡(
	`js⁄_is_undeföed
(
obj
)) {

898 
	`Ârötf
(
°dîr
, "%s objectÇot found, selecting default values\n",

899 
buf1
);

902 
èg_«me
 = "read_latency";

903 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_d©a_ˇche_ªad_œãncy
) < 0) {

904 
	`Ârötf
(
°dîr
, "dcache %sÇot found, selecting default value: %d\n",

905 
èg_«me
, 
p
->
sim_∑øms
->
l1_d©a_ˇche_ªad_œãncy
);

908 
èg_«me
 = "write_latency";

909 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_d©a_ˇche_wrôe_œãncy
) < 0) {

910 
	`Ârötf
(
°dîr
, "dcache %sÇot found, selecting default value: %d\n",

911 
èg_«me
, 
p
->
sim_∑øms
->
l1_d©a_ˇche_wrôe_œãncy
);

914 
èg_«me
 = "size";

915 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_d©a_ˇche_size
) < 0) {

916 
	`Ârötf
(
°dîr
, "dcache %sÇot found, selecting default value: %d\n",

917 
èg_«me
, 
p
->
sim_∑øms
->
l1_d©a_ˇche_size
);

920 
èg_«me
 = "ways";

921 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l1_d©a_ˇche_ways
) < 0) {

922 
	`Ârötf
(
°dîr
, "dcache %sÇot found, selecting default value: %d\n",

923 
èg_«me
, 
p
->
sim_∑øms
->
l1_d©a_ˇche_ways
);

926 
èg_«me
 = "eviction";

927 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

928 
	`Ârötf
(
°dîr
, "dcache %sÖolicyÇot found, selecting default value %s\n",

929 
èg_«me
, 
ˇche_evi˘_°r
[
p
->
sim_∑øms
->
l1_d©a_ˇche_evi˘
]);

932 i‡(
	`°rcmp
(
°r
, "lru") == 0) {

933 
p
->
sim_∑øms
->
l1_d©a_ˇche_evi˘
 = 
CACHE_LRU_EVICT
;

934 } i‡(
	`°rcmp
(
°r
, "random") == 0) {

935 
p
->
sim_∑øms
->
l1_d©a_ˇche_evi˘
 = 
CACHE_RANDOM_EVICT
;

937 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ dˇchê%†pﬁicy ha†övÆid vÆue\n", 
èg_«me
);

938 
	`exô
(1);

942 
èg_«me
 = "words_per_cache_line";

943 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
w‹ds_≥r_ˇche_löe
) < 0) {

944 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %d\n", 
èg_«me
,

945 
p
->
sim_∑øms
->
w‹ds_≥r_ˇche_löe
);

964 
èg_«me
 = "cache_allocate_on_write_miss";

965 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

966 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value %s\n",

967 
èg_«me
, 
ˇche_wa_°r
[
p
->
sim_∑øms
->
ˇche_wrôe_Æloˇã_pﬁicy
]);

970 i‡(
	`°rcmp
(
°r
, "true") == 0) {

971 
p
->
sim_∑øms
->
ˇche_wrôe_Æloˇã_pﬁicy
 = 
CACHE_WRITE_ALLOC
;

972 } i‡(
	`°rcmp
(
°r
, "false") == 0) {

973 
p
->
sim_∑øms
->
ˇche_wrôe_Æloˇã_pﬁicy
 = 
CACHE_WRITE_NO_ALLOC
;

975 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

976 
	`exô
(1);

980 
èg_«me
 = "cache_write_policy";

981 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

982 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value %s\n",

983 
èg_«me
, 
ˇche_wp_°r
[
p
->
sim_∑øms
->
ˇche_wrôe_pﬁicy
]);

986 i‡(
	`°rcmp
(
°r
, "writeback") == 0) {

987 
p
->
sim_∑øms
->
ˇche_wrôe_pﬁicy
 = 
CACHE_WRITEBACK
;

988 } i‡(
	`°rcmp
(
°r
, "writethrough") == 0) {

989 
p
->
sim_∑øms
->
ˇche_wrôe_pﬁicy
 = 
CACHE_WRITETHROUGH
;

991 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

992 
	`exô
(1);

996 
èg_«me
 = "enable_l2_cache";

997 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

998 
	`Ârötf
(
°dîr
, "%sÇot found, selecting default value %s\n",

999 
èg_«me
, 
sim_∑øm_°©us
[
p
->
sim_∑øms
->
íabÀ_l2_ˇche
]);

1002 i‡(
	`°rcmp
(
°r
, "false") == 0) {

1003 
p
->
sim_∑øms
->
íabÀ_l2_ˇche
 = 
DISABLE
;

1004 } i‡(
	`°rcmp
(
°r
, "true") == 0) {

1005 
p
->
sim_∑øms
->
íabÀ_l2_ˇche
 = 
ENABLE
;

1007 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄ %†ha†övÆid vÆue\n", 
èg_«me
);

1008 
	`exô
(1);

1012 i‡(
p
->
sim_∑øms
->
íabÀ_l2_ˇche
) {

1013 
	`¢¥ötf
(
buf1
, (buf1), "%s", "l2_shared_cache");

1014 
obj
 = 
	`js⁄_obje˘_gë
(
cfg
, 
buf1
);

1016 i‡(
	`js⁄_is_undeföed
(
obj
)) {

1017 
	`Ârötf
(
°dîr
, "%s objectÇot found, selecting default values\n",

1018 
buf1
);

1021 
èg_«me
 = "read_latency";

1022 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_ªad_œãncy
) < 0) {

1023 
	`Ârötf
(
°dîr
, "dcache %sÇot found, selecting default value: %d\n",

1024 
èg_«me
, 
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_ªad_œãncy
);

1027 
èg_«me
 = "write_latency";

1028 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_wrôe_œãncy
) < 0) {

1029 
	`Ârötf
(
°dîr
, "dcache %sÇot found, selecting default value: %d\n",

1030 
èg_«me
, 
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_wrôe_œãncy
);

1033 
èg_«me
 = "size";

1034 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_size
) < 0) {

1035 
	`Ârötf
(
°dîr
, "l2_shared_cache %sÇot found, selecting default value: %d\n",

1036 
èg_«me
, 
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_size
);

1039 
èg_«me
 = "ways";

1040 i‡(
	`vm_gë_öt
(
obj
, 
èg_«me
, &
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_ways
) < 0) {

1041 
	`Ârötf
(
°dîr
, "l2_shared_cache %sÇot found, selecting default value: %d\n",

1042 
èg_«me
, 
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_ways
);

1045 
èg_«me
 = "eviction";

1046 i‡(
	`vm_gë_°r
(
obj
, 
èg_«me
, &
°r
) < 0) {

1047 
	`Ârötf
(
°dîr
, "l2-cache %sÖolicyÇot found, selecting default value %s\n",

1048 
èg_«me
, 
ˇche_evi˘_°r
[
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_evi˘
]);

1051 i‡(
	`°rcmp
(
°r
, "lru") == 0) {

1052 
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_evi˘
 = 
CACHE_LRU_EVICT
;

1053 } i‡(
	`°rcmp
(
°r
, "random") == 0) {

1054 
p
->
sim_∑øms
->
l2_sh¨ed_ˇche_evi˘
 = 
CACHE_RANDOM_EVICT
;

1056 
	`Ârötf
(
°dîr
, "îr‹: o±i⁄Ü2-ˇchê%†pﬁicy ha†övÆid vÆue\n", 
èg_«me
);

1057 
	`exô
(1);

1064 
p
->
sim_∑øms
->
mem_modñ_ty≥
)

1066 
MEM_MODEL_BASE
:

1068 
èg_«me
 = "mem_access_latency";

1069 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, &
p
->
sim_∑øms
->
mem_ac˚ss_œãncy
) < 0) {

1070 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %d\n", 
èg_«me
,

1071 
p
->
sim_∑øms
->
mem_ac˚ss_œãncy
);

1073 
èg_«me
 = "dram_burst_size";

1074 i‡(
	`vm_gë_öt
(
cfg
, 
èg_«me
, (*)&
p
->
sim_∑øms
->
døm_bur°_size
) < 0) {

1075 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %u\n", 
èg_«me
,

1076 
p
->
sim_∑øms
->
døm_bur°_size
);

1080 
MEM_MODEL_DRAMSIM
:

1082 
èg_«me
 = "dramsim_ini_file";

1083 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

1084 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %s\n", 
èg_«me
,

1085 
p
->
sim_∑øms
->
dømsim_öi_fûe
);

1087 
	`‰ì
(
p
->
sim_∑øms
->
dømsim_öi_fûe
);

1088 
p
->
sim_∑øms
->
dømsim_öi_fûe
 = 
	`°rdup
(
°r
);

1091 
èg_«me
 = "dramsim_system_ini_file";

1092 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

1093 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %s\n", 
èg_«me
,

1094 
p
->
sim_∑øms
->
dømsim_sy°em_öi_fûe
);

1096 
	`‰ì
(
p
->
sim_∑øms
->
dømsim_sy°em_öi_fûe
);

1097 
p
->
sim_∑øms
->
dømsim_sy°em_öi_fûe
 = 
	`°rdup
(
°r
);

1100 
èg_«me
 = "dramsim_stats_dir";

1101 i‡(
	`vm_gë_°r
(
cfg
, 
èg_«me
, &
°r
) < 0) {

1102 
	`Ârötf
(
°dîr
, "%†nŸ found, sñe˘ög deÁu… vÆue: %s\n", 
èg_«me
,

1103 
p
->
sim_∑øms
->
dømsim_°©s_dú
);

1105 
	`‰ì
(
p
->
sim_∑øms
->
dømsim_°©s_dú
);

1106 
p
->
sim_∑øms
->
dømsim_°©s_dú
 = 
	`°rdup
(
°r
);

1112 
	`Ârötf
(
°dîr
, "error: invalid memory model\n");

1113 
	`exô
(1);

1117 
p
->
sim_∑øms
->
gue°_øm_size
 =Ö->
øm_size
 >> 20;

1119 
	`js⁄_‰ì
(
cfg
);

1121 
èg_Áû
:

1122 
	`js⁄_‰ì
(
cfg
);

1124 
	}
}

1126 
	tFSLﬂdFûeCB
(*
	t›aque
, 
	tuöt8_t
 *
	tbuf
, 
	tbuf_Àn
);

1129 
VútMachöeP¨ams
 *
	mvm_∑øms
;

1130 (*
	m°¨t_cb
)(*
	m›aque
);

1131 *
	m›aque
;

1133 
FSLﬂdFûeCB
 *
	mfûe_lﬂd_cb
;

1134 *
	mfûe_lﬂd_›aque
;

1135 
	mfûe_ödex
;

1136 } 
	tVMC⁄figLﬂdSèã
;

1138 
c⁄fig_fûe_lﬂded
(*
›aque
, 
uöt8_t
 *
buf
, 
buf_Àn
);

1139 
c⁄fig_addôi⁄Æ_fûe_lﬂd
(
VMC⁄figLﬂdSèã
 *
s
);

1140 
c⁄fig_addôi⁄Æ_fûe_lﬂd_cb
(*
›aque
,

1141 
uöt8_t
 *
buf
, 
buf_Àn
);

1144 *
	$gë_fûe_∑th
(c⁄° *
ba£_fûíame
, c⁄° *
fûíame
)

1146 
Àn
, 
Àn1
;

1147 *
‚ame
, *
p
;

1149 i‡(!
ba£_fûíame
)

1150 
d⁄e
;

1151 i‡(
	`°rchr
(
fûíame
, ':'))

1152 
d⁄e
;

1153 i‡(
fûíame
[0] == '/')

1154 
d⁄e
;

1155 
p
 = 
	`°ºchr
(
ba£_fûíame
, '/');

1156 i‡(!
p
) {

1157 
d⁄e
:

1158  
	`°rdup
(
fûíame
);

1160 
Àn
 = 
p
 + 1 - 
ba£_fûíame
;

1161 
Àn1
 = 
	`°æí
(
fûíame
);

1162 
‚ame
 = 
	`mÆloc
(
Àn
 + 
Àn1
 + 1);

1163 
	`mem˝y
(
‚ame
, 
ba£_fûíame
, 
Àn
);

1164 
	`mem˝y
(
‚ame
 + 
Àn
, 
fûíame
, 
Àn1
 + 1);

1165  
‚ame
;

1166 
	}
}

1169 #ifde‡
EMSCRIPTEN


1170 
	$lﬂd_fûe
(
uöt8_t
 **
pbuf
, c⁄° *
fûíame
)

1172 
	`ab‹t
();

1173 
	}
}

1176 
	$lﬂd_fûe
(
uöt8_t
 **
pbuf
, c⁄° *
fûíame
)

1178 
FILE
 *
f
;

1179 
size
;

1180 
uöt8_t
 *
buf
;

1182 
f
 = 
	`f›í
(
fûíame
, "rb");

1183 i‡(!
f
) {

1184 
	`≥º‹
(
fûíame
);

1185 
	`exô
(1);

1187 
	`f£ek
(
f
, 0, 
SEEK_END
);

1188 
size
 = 
	`·ñl
(
f
);

1189 
	`f£ek
(
f
, 0, 
SEEK_SET
);

1190 
buf
 = 
	`mÆloc
(
size
);

1191 i‡(
	`‰ód
(
buf
, 1, 
size
, 
f
) != size) {

1192 
	`Ârötf
(
°dîr
, "%s:ÑódÉº‹\n", 
fûíame
);

1193 
	`exô
(1);

1195 
	`f˛o£
(
f
);

1196 *
pbuf
 = 
buf
;

1197  
size
;

1198 
	}
}

1201 #ifde‡
CONFIG_FS_NET


1202 
	$c⁄fig_lﬂd_fûe_cb
(*
›aque
, 
îr
, *
d©a
, 
size_t
 
size
)

1204 
VMC⁄figLﬂdSèã
 *
s
 = 
›aque
;

1207 i‡(
îr
 < 0) {

1208 
	`vm_îr‹
("Eº‹ %d whûêlﬂdög fûe\n", -
îr
);

1209 
	`exô
(1);

1211 
s
->
	`fûe_lﬂd_cb
(s->
fûe_lﬂd_›aque
, 
d©a
, 
size
);

1212 
	}
}

1215 
	$c⁄fig_lﬂd_fûe
(
VMC⁄figLﬂdSèã
 *
s
, c⁄° *
fûíame
,

1216 
FSLﬂdFûeCB
 *
cb
, *
›aque
)

1219 #ifde‡
CONFIG_FS_NET


1220 i‡(
	`is_uæ
(
fûíame
)) {

1221 
s
->
fûe_lﬂd_cb
 = 
cb
;

1222 
s
->
fûe_lﬂd_›aque
 = 
›aque
;

1223 
	`fs_wgë
(
fûíame
, 
NULL
, NULL, 
s
, 
c⁄fig_lﬂd_fûe_cb
, 
TRUE
);

1227 
uöt8_t
 *
buf
;

1228 
size
;

1229 
size
 = 
	`lﬂd_fûe
(&
buf
, 
fûíame
);

1230 
	`cb
(
›aque
, 
buf
, 
size
);

1231 
	`‰ì
(
buf
);

1233 
	}
}

1235 
	$vút_machöe_lﬂd_c⁄fig_fûe
(
VútMachöeP¨ams
 *
p
,

1236 c⁄° *
fûíame
,

1237 (*
°¨t_cb
)(*
›aque
),

1238 *
›aque
)

1240 
VMC⁄figLﬂdSèã
 *
s
;

1242 
s
 = 
	`mÆlocz
((*s));

1243 
s
->
vm_∑øms
 = 
p
;

1244 
s
->
°¨t_cb
 = start_cb;

1245 
s
->
›aque
 = opaque;

1246 
p
->
cfg_fûíame
 = 
	`°rdup
(
fûíame
);

1248 
	`c⁄fig_lﬂd_fûe
(
s
, 
fûíame
, 
c⁄fig_fûe_lﬂded
, s);

1249 
	}
}

1251 
	$c⁄fig_fûe_lﬂded
(*
›aque
, 
uöt8_t
 *
buf
, 
buf_Àn
)

1253 
VMC⁄figLﬂdSèã
 *
s
 = 
›aque
;

1254 
VútMachöeP¨ams
 *
p
 = 
s
->
vm_∑øms
;

1256 i‡(
	`vút_machöe_∑r£_c⁄fig
(
p
, (*)
buf
, 
buf_Àn
) < 0)

1257 
	`exô
(1);

1260 
s
->
fûe_ödex
 = 0;

1261 
	`c⁄fig_addôi⁄Æ_fûe_lﬂd
(
s
);

1262 
	}
}

1264 
	$c⁄fig_addôi⁄Æ_fûe_lﬂd
(
VMC⁄figLﬂdSèã
 *
s
)

1266 
VútMachöeP¨ams
 *
p
 = 
s
->
vm_∑øms
;

1267 
s
->
fûe_ödex
 < 
VM_FILE_COUNT
 &&

1268 
p
->
fûes
[
s
->
fûe_ödex
].
fûíame
 =
NULL
) {

1269 
s
->
fûe_ödex
++;

1271 i‡(
s
->
fûe_ödex
 =
VM_FILE_COUNT
) {

1272 i‡(
s
->
°¨t_cb
)

1273 
s
->
	`°¨t_cb
(s->
›aque
);

1274 
	`‰ì
(
s
);

1276 *
‚ame
;

1278 
‚ame
 = 
	`gë_fûe_∑th
(
p
->
cfg_fûíame
,

1279 
p
->
fûes
[
s
->
fûe_ödex
].
fûíame
);

1280 
	`c⁄fig_lﬂd_fûe
(
s
, 
‚ame
,

1281 
c⁄fig_addôi⁄Æ_fûe_lﬂd_cb
, 
s
);

1282 
	`‰ì
(
‚ame
);

1284 
	}
}

1286 
	$c⁄fig_addôi⁄Æ_fûe_lﬂd_cb
(*
›aque
,

1287 
uöt8_t
 *
buf
, 
buf_Àn
)

1289 
VMC⁄figLﬂdSèã
 *
s
 = 
›aque
;

1290 
VútMachöeP¨ams
 *
p
 = 
s
->
vm_∑øms
;

1292 
p
->
fûes
[
s
->
fûe_ödex
].
buf
 = 
	`mÆloc
(
buf_Àn
);

1293 
	`mem˝y
(
p
->
fûes
[
s
->
fûe_ödex
].
buf
, buf, 
buf_Àn
);

1294 
p
->
fûes
[
s
->
fûe_ödex
].
Àn
 = 
buf_Àn
;

1297 
s
->
fûe_ödex
++;

1298 
	`c⁄fig_addôi⁄Æ_fûe_lﬂd
(
s
);

1299 
	}
}

1301 
	$vm_add_cmdlöe
(
VútMachöeP¨ams
 *
p
, c⁄° *
cmdlöe
)

1303 *
√w_cmdlöe
, *
ﬁd_cmdlöe
;

1304 i‡(
cmdlöe
[0] == '!') {

1305 
√w_cmdlöe
 = 
	`°rdup
(
cmdlöe
 + 1);

1307 
ﬁd_cmdlöe
 = 
p
->
cmdlöe
;

1308 i‡(!
ﬁd_cmdlöe
)

1309 
ﬁd_cmdlöe
 = "";

1310 
√w_cmdlöe
 = 
	`mÆloc
(
	`°æí
(
ﬁd_cmdlöe
Ë+ 1 + såÀn(
cmdlöe
) + 1);

1311 
	`°r˝y
(
√w_cmdlöe
, 
ﬁd_cmdlöe
);

1312 
	`°rˇt
(
√w_cmdlöe
, " ");

1313 
	`°rˇt
(
√w_cmdlöe
, 
cmdlöe
);

1315 
	`‰ì
(
p
->
cmdlöe
);

1316 
p
->
cmdlöe
 = 
√w_cmdlöe
;

1317 
	}
}

1319 
	$vút_machöe_‰ì_c⁄fig
(
VútMachöeP¨ams
 *
p
)

1321 
i
;

1323 
	`‰ì
(
p
->
machöe_«me
);

1324 
	`‰ì
(
p
->
cmdlöe
);

1325 
i
 = 0; i < 
VM_FILE_COUNT
; i++) {

1326 
	`‰ì
(
p
->
fûes
[
i
].
fûíame
);

1327 
	`‰ì
(
p
->
fûes
[
i
].
buf
);

1329 
i
 = 0; i < 
p
->
drive_cou¡
; i++) {

1330 
	`‰ì
(
p
->
èb_drive
[
i
].
fûíame
);

1331 
	`‰ì
(
p
->
èb_drive
[
i
].
devi˚
);

1333 
i
 = 0; i < 
p
->
fs_cou¡
; i++) {

1334 
	`‰ì
(
p
->
èb_fs
[
i
].
fûíame
);

1335 
	`‰ì
(
p
->
èb_fs
[
i
].
èg
);

1337 
i
 = 0; i < 
p
->
ëh_cou¡
; i++) {

1338 
	`‰ì
(
p
->
èb_ëh
[
i
].
drivî
);

1339 
	`‰ì
(
p
->
èb_ëh
[
i
].
i‚ame
);

1341 
	`‰ì
(
p
->
öput_devi˚
);

1342 
	`‰ì
(
p
->
di•œy_devi˚
);

1343 
	`‰ì
(
p
->
cfg_fûíame
);

1344 
	}
}

1346 
VútMachöe
 *
	$vút_machöe_öô
(c⁄° 
VútMachöeP¨ams
 *
p
)

1348 c⁄° 
VútMachöeCœss
 *
vmc
 = 
p
->vmc;

1349  
vmc
->
	`vút_machöe_öô
(
p
);

1350 
	}
}

1352 
	$vút_machöe_£t_deÁu…s
(
VútMachöeP¨ams
 *
p
)

1354 
	`mem£t
(
p
, 0, (*p));

1355 
p
->
sim_∑øms
 = 
	`sim_∑øms_öô
();

1356 
	}
}

1358 
	$vút_machöe_íd
(
VútMachöe
 *
s
)

1360 
s
->
vmc
->
	`vút_machöe_íd
(s);

1361 
	}
}

	@machine.h

24 
	~"js⁄.h
"

26 
SimP¨ams
 
	tSimP¨ams
;

28 
FBDevi˚
 
	tFBDevi˚
;

30 
	tSim∂eFBDøwFunc
(
	tFBDevi˚
 *
	tfb_dev
, *
	t›aque
,

31 
	tx
, 
	ty
, 
	tw
, 
	th
);

33 
	sFBDevi˚
 {

35 
	mwidth
;

36 
	mheight
;

37 
	m°ride
;

38 
uöt8_t
 *
	mfb_d©a
;

39 
	mfb_size
;

40 *
	mdevi˚_›aque
;

41 (*
	mª‰esh
)(
FBDevi˚
 *
	mfb_dev
,

42 
Sim∂eFBDøwFunc
 *
	mªdøw_func
, *
	m›aque
);

45 
	#MAX_DRIVE_DEVICE
 4

	)

46 
	#MAX_FS_DEVICE
 4

	)

47 
	#MAX_ETH_DEVICE
 1

	)

49 
	#VM_CONFIG_VERSION
 1

	)

52 
	mVM_FILE_BIOS
,

53 
	mVM_FILE_VGA_BIOS
,

54 
	mVM_FILE_KERNEL
,

55 
	mVM_FILE_INITRD
,

57 
	mVM_FILE_COUNT
,

58 } 
	tVMFûeTy≥Enum
;

61 *
	mfûíame
;

62 
uöt8_t
 *
	mbuf
;

63 
	mÀn
;

64 } 
	tVMFûeE¡ry
;

67 *
	mdevi˚
;

68 *
	mfûíame
;

69 
BlockDevi˚
 *
	mblock_dev
;

70 } 
	tVMDriveE¡ry
;

73 *
	mdevi˚
;

74 *
	mèg
;

75 *
	mfûíame
;

76 
FSDevi˚
 *
	mfs_dev
;

77 } 
	tVMFSE¡ry
;

80 *
	mdrivî
;

81 *
	mi‚ame
;

82 
Ethî√tDevi˚
 *
	m√t
;

83 } 
	tVMEthE¡ry
;

85 
VútMachöeCœss
 
	tVútMachöeCœss
;

88 *
	mcfg_fûíame
;

89 c⁄° 
VútMachöeCœss
 *
	mvmc
;

90 *
	mmachöe_«me
;

91 
uöt64_t
 
	møm_size
;

92 
BOOL
 
	mπc_ªÆ_time
;

93 
BOOL
 
	mπc_loˇl_time
;

94 *
	mdi•œy_devi˚
;

95 
	mwidth
, 
	mheight
;

96 
Ch¨a˘îDevi˚
 *
	mc⁄sﬁe
;

97 
VMDriveE¡ry
 
	mèb_drive
[
MAX_DRIVE_DEVICE
];

98 
	mdrive_cou¡
;

99 
VMFSE¡ry
 
	mèb_fs
[
MAX_FS_DEVICE
];

100 
	mfs_cou¡
;

101 
VMEthE¡ry
 
	mèb_ëh
[
MAX_ETH_DEVICE
];

102 
	mëh_cou¡
;

104 *
	mcmdlöe
;

105 
BOOL
 
	mac˚l_íabÀ
;

106 *
	möput_devi˚
;

109 
VMFûeE¡ry
 
	mfûes
[
VM_FILE_COUNT
];

112 
SimP¨ams
 *
	msim_∑øms
;

113 } 
	tVútMachöeP¨ams
;

115 
	sVútMachöe
 {

116 c⁄° 
VútMachöeCœss
 *
	mvmc
;

118 
Ethî√tDevi˚
 *
	m√t
;

120 
VIRTIODevi˚
 *
	mc⁄sﬁe_dev
;

121 
Ch¨a˘îDevi˚
 *
	mc⁄sﬁe
;

123 
FBDevi˚
 *
	mfb_dev
;

125 
VútMachöeP¨ams
 *
	mvút_machöe_∑øms
;

126 } 
	tVútMachöe
;

128 
	sVútMachöeCœss
 {

129 c⁄° *
	mmachöe_«mes
;

130 (*
	mvút_machöe_£t_deÁu…s
)(
VútMachöeP¨ams
 *
	mp
);

131 
	mVútMachöe
 *(*
	mvút_machöe_öô
)(c⁄° 
VútMachöeP¨ams
 *
	mp
);

132 (*
	mvút_machöe_íd
)(
VútMachöe
 *
	ms
);

133 (*
	mvút_machöe_gë_¶ìp_duøti⁄
)(
VútMachöe
 *
	ms
, 
	mdñay
);

134 (*
	mvút_machöe_öãΩ
)(
VútMachöe
 *
	ms
, 
	mmax_exec_cy˛e
);

135 
BOOL
 (*
vm_mou£_is_absﬁuã
)(
VútMachöe
 *
	ms
);

136 (*
	mvm_£nd_mou£_evít
)(
VútMachöe
 *
	ms1
, 
	mdx
, 
	mdy
, 
	mdz
,

137 
	mbuâ⁄s
);

138 (*
	mvm_£nd_key_evít
)(
VútMachöe
 *
	ms1
, 
BOOL
 
	mis_down
, 
uöt16_t
 
	mkey_code
);

141 c⁄° 
VútMachöeCœss
 
riscv_machöe_˛ass
;

142 c⁄° 
VútMachöeCœss
 
pc_machöe_˛ass
;

144 
__©åibuã__
((
	$f‹m©
(
¥ötf
, 1, 2))Ë
	`vm_îr‹
(c⁄° *
fmt
, ...);

145 
	`vm_gë_öt
(
JSONVÆue
 
obj
, c⁄° *
«me
, *
pvÆ
);

146 
	`vm_gë_öt_›t
(
JSONVÆue
 
obj
, c⁄° *
«me
, *
pvÆ
, 
def_vÆ
);

148 
	`vút_machöe_£t_deÁu…s
(
VútMachöeP¨ams
 *
p
);

149 
	`vút_machöe_lﬂd_c⁄fig_fûe
(
VútMachöeP¨ams
 *
p
,

150 c⁄° *
fûíame
,

151 (*
°¨t_cb
)(*
›aque
),

152 *
›aque
);

153 
	`vm_add_cmdlöe
(
VútMachöeP¨ams
 *
p
, c⁄° *
cmdlöe
);

154 *
	`gë_fûe_∑th
(c⁄° *
ba£_fûíame
, c⁄° *
fûíame
);

155 
	`vút_machöe_‰ì_c⁄fig
(
VútMachöeP¨ams
 *
p
);

156 
VútMachöe
 *
	`vút_machöe_öô
(c⁄° 
VútMachöeP¨ams
 *
p
);

157 
	`vút_machöe_íd
(
VútMachöe
 *
s
);

158 
ölöe
 
	$vút_machöe_gë_¶ìp_duøti⁄
(
VútMachöe
 *
s
, 
dñay
)

160  
s
->
vmc
->
	`vút_machöe_gë_¶ìp_duøti⁄
(s, 
dñay
);

161 
	}
}

162 
ölöe
 
	$vút_machöe_öãΩ
(
VútMachöe
 *
s
, 
max_exec_cy˛e
)

164 
s
->
vmc
->
	`vút_machöe_öãΩ
(s, 
max_exec_cy˛e
);

165 
	}
}

166 
ölöe
 
BOOL
 
	$vm_mou£_is_absﬁuã
(
VútMachöe
 *
s
)

168  
s
->
vmc
->
	`vm_mou£_is_absﬁuã
(s);

169 
	}
}

170 
ölöe
 
	$vm_£nd_mou£_evít
(
VútMachöe
 *
s1
, 
dx
, 
dy
, 
dz
,

171 
buâ⁄s
)

173 
s1
->
vmc
->
	`vm_£nd_mou£_evít
(s1, 
dx
, 
dy
, 
dz
, 
buâ⁄s
);

174 
	}
}

175 
ölöe
 
	$vm_£nd_key_evít
(
VútMachöe
 *
s1
, 
BOOL
 
is_down
, 
uöt16_t
 
key_code
)

177 
s1
->
vmc
->
	`vm_£nd_key_evít
(s1, 
is_down
, 
key_code
);

178 
	}
}

181 
sdl_ª‰esh
(
VútMachöe
 *
m
);

182 
sdl_öô
(
width
, 
height
);

185 
Sim∂eFBSèã
 
	tSim∂eFBSèã
;

186 
Sim∂eFBSèã
 *
sim∂efb_öô
(
PhysMem‹yM≠
 *
m≠
, 
uöt64_t
 
phys_addr
,

187 
FBDevi˚
 *
fb_dev
, 
width
, 
height
);

188 
sim∂efb_ª‰esh
(
FBDevi˚
 *
fb_dev
,

189 
Sim∂eFBDøwFunc
 *
ªdøw_func
, *
›aque
,

190 
PhysMem‹yR™ge
 *
mem_ønge
,

191 
fb_∑ge_cou¡
);

194 
VGASèã
 
	tVGASèã
;

195 
VGASèã
 *
pci_vga_öô
(
PCIBus
 *
bus
, 
FBDevi˚
 *
fb_dev
,

196 
width
, 
height
,

197 c⁄° 
uöt8_t
 *
vga_rom_buf
, 
vga_rom_size
);

200 
BlockDevi˚
 *
block_devi˚_öô_hâp
(c⁄° *
uæ
,

201 
max_ˇche_size_kb
,

202 (*
°¨t_cb
)(*
›aque
),

203 *
°¨t_›aque
);

206 
	`u¨t_rx_d©a
(
VútMachöe
 *
v
, 
uöt8_t
 *
buf
, 
size
);

207 
	`u¨t_ˇn_rx
(
VútMachöe
 *
v
);

	@pci.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

31 
	~"cutûs.h
"

32 
	~"pci.h
"

37 
uöt32_t
 
	msize
;

38 
uöt8_t
 
	mty≥
;

39 
uöt8_t
 
	míabÀd
;

40 *
	m›aque
;

41 
PCIB¨SëFunc
 *
	mb¨_£t
;

42 } 
	tPCIIORegi⁄
;

44 
	sPCIDevi˚
 {

45 
PCIBus
 *
	mbus
;

46 
uöt8_t
 
	mdev‚
;

47 
IRQSig«l
 
	múq
[4];

48 
uöt8_t
 
	mc⁄fig
[256];

49 
uöt8_t
 
	m√xt_ˇp_off£t
;

50 *
	m«me
;

51 
PCIIORegi⁄
 
	mio_ªgi⁄s
[
PCI_NUM_REGIONS
];

54 
	sPCIBus
 {

55 
	mbus_num
;

56 
PCIDevi˚
 *
	mdevi˚
[256];

57 
PhysMem‹yM≠
 *
	mmem_m≠
;

58 
PhysMem‹yM≠
 *
	mp‹t_m≠
;

59 
uöt32_t
 
	múq_°©e
[4][8];

60 
IRQSig«l
 
	múq
[4];

63 
	$bus_m≠_úq
(
PCIDevi˚
 *
d
, 
úq_num
)

65 
¶Ÿ_addíd
;

66 
¶Ÿ_addíd
 = (
d
->
dev‚
 >> 3) - 1;

67  (
úq_num
 + 
¶Ÿ_addíd
) & 3;

68 
	}
}

70 
	$pci_devi˚_£t_úq
(*
›aque
, 
úq_num
, 
Àvñ
)

72 
PCIDevi˚
 *
d
 = 
›aque
;

73 
PCIBus
 *
b
 = 
d
->
bus
;

74 
uöt32_t
 
mask
;

75 
i
, 
úq_Àvñ
;

78 
úq_num
 = 
	`bus_m≠_úq
(
d
, irq_num);

79 
mask
 = 1 << (
d
->
dev‚
 & 0x1f);

80 i‡(
Àvñ
)

81 
b
->
úq_°©e
[
úq_num
][
d
->
dev‚
 >> 5] |
mask
;

83 
b
->
úq_°©e
[
úq_num
][
d
->
dev‚
 >> 5] &~
mask
;

86 
mask
 = 0;

87 
i
 = 0; i < 8; i++)

88 
mask
 |
b
->
úq_°©e
[
úq_num
][
i
];

89 
úq_Àvñ
 = (
mask
 != 0);

90 
	`£t_úq
(&
b
->
úq
[
úq_num
], 
úq_Àvñ
);

91 
	}
}

93 
	$dev‚_Æloc
(
PCIBus
 *
b
)

95 
dev‚
;

96 
dev‚
 = 0; devfn < 256; devfn += 8) {

97 i‡(!
b
->
devi˚
[
dev‚
])

98  
dev‚
;

101 
	}
}

104 
PCIDevi˚
 *
	$pci_ªgi°î_devi˚
(
PCIBus
 *
b
, c⁄° *
«me
, 
dev‚
,

105 
uöt16_t
 
víd‹_id
, uöt16_à
devi˚_id
,

106 
uöt8_t
 
ªvisi⁄
, 
uöt16_t
 
˛ass_id
)

108 
PCIDevi˚
 *
d
;

109 
i
;

111 i‡(
dev‚
 < 0) {

112 
dev‚
 = 
	`dev‚_Æloc
(
b
);

113 i‡(
dev‚
 < 0)

114  
NULL
;

116 i‡(
b
->
devi˚
[
dev‚
])

117  
NULL
;

119 
d
 = 
	`mÆlocz
((
PCIDevi˚
));

120 
d
->
bus
 = 
b
;

121 
d
->
«me
 = 
	`°rdup
(name);

122 
d
->
dev‚
 = devfn;

124 
	`put_À16
(
d
->
c⁄fig
 + 0x00, 
víd‹_id
);

125 
	`put_À16
(
d
->
c⁄fig
 + 0x02, 
devi˚_id
);

126 
d
->
c⁄fig
[0x08] = 
ªvisi⁄
;

127 
	`put_À16
(
d
->
c⁄fig
 + 0x0a, 
˛ass_id
);

128 
d
->
c⁄fig
[0x0e] = 0x00;

129 
d
->
√xt_ˇp_off£t
 = 0x40;

131 
i
 = 0; i < 4; i++)

132 
	`úq_öô
(&
d
->
úq
[
i
], 
pci_devi˚_£t_úq
, d, i);

133 
b
->
devi˚
[
dev‚
] = 
d
;

135  
d
;

136 
	}
}

138 
IRQSig«l
 *
	$pci_devi˚_gë_úq
(
PCIDevi˚
 *
d
, 
úq_num
)

140 
	`as£π
(
úq_num
 < 4);

141  &
d
->
úq
[
úq_num
];

142 
	}
}

144 
uöt32_t
 
	$pci_devi˚_c⁄fig_ªad
(
PCIDevi˚
 *
d
, 
uöt32_t
 
addr
,

145 
size_log2
)

147 
uöt32_t
 
vÆ
;

148 
size_log2
) {

150 
vÆ
 = *(
uöt8_t
 *)(
d
->
c⁄fig
 + 
addr
);

154 i‡(
addr
 <= 0xfe)

155 
vÆ
 = 
	`gë_À16
(
d
->
c⁄fig
 + 
addr
);

157 
vÆ
 = *(
uöt8_t
 *)(
d
->
c⁄fig
 + 
addr
);

161 
vÆ
 = 
	`gë_À32
(
d
->
c⁄fig
 + 
addr
);

164 
	`ab‹t
();

166 #ifde‡
DEBUG_CONFIG


167 
	`¥ötf
("pci_config_read: dev=%sáddr=0x%02x val=0x%x s=%d\n",

168 
d
->
«me
, 
addr
, 
vÆ
, 1 << 
size_log2
);

170  
vÆ
;

171 
	}
}

173 
PhysMem‹yM≠
 *
	$pci_devi˚_gë_mem_m≠
(
PCIDevi˚
 *
d
)

175  
d
->
bus
->
mem_m≠
;

176 
	}
}

178 
PhysMem‹yM≠
 *
	$pci_devi˚_gë_p‹t_m≠
(
PCIDevi˚
 *
d
)

180  
d
->
bus
->
p‹t_m≠
;

181 
	}
}

183 
	$pci_ªgi°î_b¨
(
PCIDevi˚
 *
d
, 
b¨_num
,

184 
uöt32_t
 
size
, 
ty≥
,

185 *
›aque
, 
PCIB¨SëFunc
 *
b¨_£t
)

187 
PCIIORegi⁄
 *
r
;

188 
uöt32_t
 
vÆ
, 
c⁄fig_addr
;

190 
	`as£π
(
b¨_num
 < 
PCI_NUM_REGIONS
);

191 
	`as£π
((
size
 & (size - 1)) == 0);

192 
	`as£π
(
size
 >= 4);

193 
r
 = &
d
->
io_ªgi⁄s
[
b¨_num
];

194 
	`as£π
(
r
->
size
 == 0);

195 
r
->
size
 = size;

196 
r
->
ty≥
 =Åype;

197 
r
->
íabÀd
 = 
FALSE
;

198 
r
->
›aque
 = opaque;

199 
r
->
b¨_£t
 = bar_set;

201 
vÆ
 = 0;

202 i‡(
b¨_num
 =
PCI_ROM_SLOT
) {

203 
c⁄fig_addr
 = 0x30;

205 
vÆ
 |
r
->
ty≥
;

206 
c⁄fig_addr
 = 0x10 + 4 * 
b¨_num
;

208 
	`put_À32
(&
d
->
c⁄fig
[
c⁄fig_addr
], 
vÆ
);

209 
	}
}

211 
	$pci_upd©e_m≠pögs
(
PCIDevi˚
 *
d
)

213 
cmd
, 
i
, 
off£t
;

214 
uöt32_t
 
√w_addr
;

215 
BOOL
 
√w_íabÀd
;

216 
PCIIORegi⁄
 *
r
;

218 
cmd
 = 
	`gë_À16
(&
d
->
c⁄fig
[
PCI_COMMAND
]);

220 
i
 = 0; i < 
PCI_NUM_REGIONS
; i++) {

221 
r
 = &
d
->
io_ªgi⁄s
[
i
];

222 i‡(
i
 =
PCI_ROM_SLOT
) {

223 
off£t
 = 0x30;

225 
off£t
 = 0x10 + 
i
 * 4;

227 
√w_addr
 = 
	`gë_À32
(&
d
->
c⁄fig
[
off£t
]);

228 
√w_íabÀd
 = 
FALSE
;

229 i‡(
r
->
size
 != 0) {

230 i‡((
r
->
ty≥
 & 
PCI_ADDRESS_SPACE_IO
) &&

231 (
cmd
 & 
PCI_COMMAND_IO
)) {

232 
√w_íabÀd
 = 
TRUE
;

234 i‡(
cmd
 & 
PCI_COMMAND_MEMORY
) {

235 i‡(
i
 =
PCI_ROM_SLOT
) {

236 
√w_íabÀd
 = (
√w_addr
 & 1);

238 
√w_íabÀd
 = 
TRUE
;

243 i‡(
√w_íabÀd
) {

245 
√w_addr
 = 
	`gë_À32
(&
d
->
c⁄fig
[
off£t
]Ë& ~(
r
->
size
 - 1);

246 
r
->
	`b¨_£t
‘->
›aque
, 
i
, 
√w_addr
, 
TRUE
);

247 
r
->
íabÀd
 = 
TRUE
;

248 } i‡(
r
->
íabÀd
) {

249 
r
->
	`b¨_£t
‘->
›aque
, 
i
, 0, 
FALSE
);

250 
r
->
íabÀd
 = 
FALSE
;

253 
	}
}

256 
	$pci_wrôe_b¨
(
PCIDevi˚
 *
d
, 
uöt32_t
 
addr
,

257 
uöt32_t
 
vÆ
)

259 
PCIIORegi⁄
 *
r
;

260 
ªg
;

262 i‡(
addr
 == 0x30)

263 
ªg
 = 
PCI_ROM_SLOT
;

265 
ªg
 = (
addr
 - 0x10) >> 2;

267 
r
 = &
d
->
io_ªgi⁄s
[
ªg
];

268 i‡(
r
->
size
 == 0)

270 i‡(
ªg
 =
PCI_ROM_SLOT
) {

271 
vÆ
 = vÆ & ((~(
r
->
size
 - 1)) | 1);

273 
vÆ
 = (vÆ & ~(
r
->
size
 - 1)Ë|Ñ->
ty≥
;

275 
	`put_À32
(
d
->
c⁄fig
 + 
addr
, 
vÆ
);

276 
	`pci_upd©e_m≠pögs
(
d
);

278 
	}
}

280 
	$pci_devi˚_c⁄fig_wrôe8
(
PCIDevi˚
 *
d
, 
uöt32_t
 
addr
,

281 
uöt32_t
 
d©a
)

283 
ˇn_wrôe
;

285 i‡(
addr
 =
PCI_STATUS
 ||áddr == (PCI_STATUS + 1)) {

287 
d
->
c⁄fig
[
addr
] &~
d©a
;

291 
d
->
c⁄fig
[0x0e]) {

294 
addr
) {

307 
ˇn_wrôe
 = 0;

310 
ˇn_wrôe
 = 1;

316 
addr
) {

328 
ˇn_wrôe
 = 0;

331 
ˇn_wrôe
 = 1;

336 i‡(
ˇn_wrôe
)

337 
d
->
c⁄fig
[
addr
] = 
d©a
;

338 
	}
}

341 
	$pci_devi˚_c⁄fig_wrôe
(
PCIDevi˚
 *
d
, 
uöt32_t
 
addr
,

342 
uöt32_t
 
d©a
, 
size_log2
)

344 
size
, 
i
;

345 
uöt32_t
 
addr1
;

347 #ifde‡
DEBUG_CONFIG


348 
	`¥ötf
("pci_config_write: dev=%sáddr=0x%02x val=0x%x s=%d\n",

349 
d
->
«me
, 
addr
, 
d©a
, 1 << 
size_log2
);

351 i‡(
size_log2
 == 2 &&

352 ((
addr
 >= 0x10 &&áddr < 0x10 + 4 * 6) ||

353 
addr
 == 0x30)) {

354 i‡(
	`pci_wrôe_b¨
(
d
, 
addr
, 
d©a
) == 0)

357 
size
 = 1 << 
size_log2
;

358 
i
 = 0; i < 
size
; i++) {

359 
addr1
 = 
addr
 + 
i
;

360 i‡(
addr1
 <= 0xff) {

361 
	`pci_devi˚_c⁄fig_wrôe8
(
d
, 
addr1
, (
d©a
 >> (
i
 * 8)) & 0xff);

364 i‡(
PCI_COMMAND
 >
addr
 && PCI_COMMAND <ádd∏+ 
size
) {

365 
	`pci_upd©e_m≠pögs
(
d
);

367 
	}
}

370 
	$pci_d©a_wrôe
(
PCIBus
 *
s
, 
uöt32_t
 
addr
,

371 
uöt32_t
 
d©a
, 
size_log2
)

373 
PCIDevi˚
 *
d
;

374 
bus_num
, 
dev‚
, 
c⁄fig_addr
;

376 
bus_num
 = (
addr
 >> 16) & 0xff;

377 i‡(
bus_num
 !
s
->bus_num)

379 
dev‚
 = (
addr
 >> 8) & 0xff;

380 
d
 = 
s
->
devi˚
[
dev‚
];

381 i‡(!
d
)

383 
c⁄fig_addr
 = 
addr
 & 0xff;

384 
	`pci_devi˚_c⁄fig_wrôe
(
d
, 
c⁄fig_addr
, 
d©a
, 
size_log2
);

385 
	}
}

387 c⁄° 
uöt32_t
 
	gvÆ_⁄es
[3] = { 0xff, 0xffff, 0xffffffff };

389 
uöt32_t
 
	$pci_d©a_ªad
(
PCIBus
 *
s
, 
uöt32_t
 
addr
, 
size_log2
)

391 
PCIDevi˚
 *
d
;

392 
bus_num
, 
dev‚
, 
c⁄fig_addr
;

394 
bus_num
 = (
addr
 >> 16) & 0xff;

395 i‡(
bus_num
 !
s
->bus_num)

396  
vÆ_⁄es
[
size_log2
];

397 
dev‚
 = (
addr
 >> 8) & 0xff;

398 
d
 = 
s
->
devi˚
[
dev‚
];

399 i‡(!
d
)

400  
vÆ_⁄es
[
size_log2
];

401 
c⁄fig_addr
 = 
addr
 & 0xff;

402  
	`pci_devi˚_c⁄fig_ªad
(
d
, 
c⁄fig_addr
, 
size_log2
);

403 
	}
}

407 
uöt8_t
 *
	$pci_devi˚_gë_dma_±r
(
PCIDevi˚
 *
d
, 
uöt64_t
 
addr
, 
BOOL
 
is_rw
)

409  
	`phys_mem_gë_øm_±r
(
d
->
bus
->
mem_m≠
, 
addr
, 
is_rw
);

410 
	}
}

412 
	$pci_devi˚_£t_c⁄fig8
(
PCIDevi˚
 *
d
, 
uöt8_t
 
addr
, uöt8_à
vÆ
)

414 
d
->
c⁄fig
[
addr
] = 
vÆ
;

415 
	}
}

417 
	$pci_devi˚_£t_c⁄fig16
(
PCIDevi˚
 *
d
, 
uöt8_t
 
addr
, 
uöt16_t
 
vÆ
)

419 
	`put_À16
(&
d
->
c⁄fig
[
addr
], 
vÆ
);

420 
	}
}

422 
	$pci_devi˚_gë_dev‚
(
PCIDevi˚
 *
d
)

424  
d
->
dev‚
;

425 
	}
}

428 
	$pci_add_ˇ∑bûôy
(
PCIDevi˚
 *
d
, c⁄° 
uöt8_t
 *
buf
, 
size
)

430 
off£t
;

432 
off£t
 = 
d
->
√xt_ˇp_off£t
;

433 i‡((
off£t
 + 
size
) > 256)

435 
d
->
√xt_ˇp_off£t
 +
size
;

436 
d
->
c⁄fig
[
PCI_STATUS
] |
PCI_STATUS_CAP_LIST
;

437 
	`mem˝y
(
d
->
c⁄fig
 + 
off£t
, 
buf
, 
size
);

438 
d
->
c⁄fig
[
off£t
 + 1] = d->c⁄fig[
PCI_CAPABILITY_LIST
];

439 
d
->
c⁄fig
[
PCI_CAPABILITY_LIST
] = 
off£t
;

440  
off£t
;

441 
	}
}

445 
	sI440FXSèã
 {

446 
PCIBus
 *
	mpci_bus
;

447 
PCIDevi˚
 *
	mpci_dev
;

448 
PCIDevi˚
 *
	mpiix3_dev
;

449 
uöt32_t
 
	mc⁄fig_ªg
;

450 
uöt8_t
 
	mpic_úq_°©e
[16];

451 
IRQSig«l
 *
	mpic_úqs
;

454 
	$i440fx_wrôe_addr
(*
›aque
, 
uöt32_t
 
off£t
,

455 
uöt32_t
 
d©a
, 
size_log2
)

457 
I440FXSèã
 *
s
 = 
›aque
;

458 
s
->
c⁄fig_ªg
 = 
d©a
;

459 
	}
}

461 
uöt32_t
 
	$i440fx_ªad_addr
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

463 
I440FXSèã
 *
s
 = 
›aque
;

464  
s
->
c⁄fig_ªg
;

465 
	}
}

467 
	$i440fx_wrôe_d©a
(*
›aque
, 
uöt32_t
 
off£t
,

468 
uöt32_t
 
d©a
, 
size_log2
)

470 
I440FXSèã
 *
s
 = 
›aque
;

471 i‡(
s
->
c⁄fig_ªg
 & 0x80000000) {

472 i‡(
size_log2
 == 2) {

475 
	`pci_d©a_wrôe
(
s
->
pci_bus
, s->
c⁄fig_ªg
 & ~3, 
d©a
, 
size_log2
);

477 
	`pci_d©a_wrôe
(
s
->
pci_bus
, s->
c⁄fig_ªg
 | 
off£t
, 
d©a
, 
size_log2
);

480 
	}
}

482 
uöt32_t
 
	$i440fx_ªad_d©a
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

484 
I440FXSèã
 *
s
 = 
›aque
;

485 i‡(!(
s
->
c⁄fig_ªg
 & 0x80000000))

486  
vÆ_⁄es
[
size_log2
];

487 i‡(
size_log2
 == 2) {

490  
	`pci_d©a_ªad
(
s
->
pci_bus
, s->
c⁄fig_ªg
 & ~3, 
size_log2
);

492  
	`pci_d©a_ªad
(
s
->
pci_bus
, s->
c⁄fig_ªg
 | 
off£t
, 
size_log2
);

494 
	}
}

496 
	$i440fx_£t_úq
(*
›aque
, 
úq_num
, 
úq_Àvñ
)

498 
I440FXSèã
 *
s
 = 
›aque
;

499 
PCIDevi˚
 *
hd
 = 
s
->
piix3_dev
;

500 
pic_úq
;

504 
hd
->
c⁄fig
[0x60 + 
úq_num
] &= ~0x80;

505 
pic_úq
 = 
hd
->
c⁄fig
[0x60 + 
úq_num
];

506 i‡(
pic_úq
 < 16) {

507 i‡(
úq_Àvñ
)

508 
s
->
pic_úq_°©e
[
pic_úq
] |1 << 
úq_num
;

510 
s
->
pic_úq_°©e
[
pic_úq
] &~(1 << 
úq_num
);

511 
	`£t_úq
(&
s
->
pic_úqs
[
pic_úq
], (s->
pic_úq_°©e
[pic_irq] != 0));

513 
	}
}

515 
I440FXSèã
 *
	$i440fx_öô
(
PCIBus
 **
pbus
, *
µiix3_dev‚
,

516 
PhysMem‹yM≠
 *
mem_m≠
, PhysMem‹yM≠ *
p‹t_m≠
,

517 
IRQSig«l
 *
pic_úqs
)

519 
I440FXSèã
 *
s
;

520 
PCIBus
 *
b
;

521 
PCIDevi˚
 *
d
;

522 
i
;

524 
s
 = 
	`mÆlocz
((*s));

526 
b
 = 
	`mÆlocz
((
PCIBus
));

527 
b
->
bus_num
 = 0;

528 
b
->
mem_m≠
 = mem_map;

529 
b
->
p‹t_m≠
 =Öort_map;

531 
s
->
pic_úqs
 =Öic_irqs;

532 
i
 = 0; i < 4; i++) {

533 
	`úq_öô
(&
b
->
úq
[
i
], 
i440fx_£t_úq
, 
s
, i);

536 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0xcf8, 1, 
s
, 
i440fx_ªad_addr
, 
i440fx_wrôe_addr
,

537 
DEVIO_SIZE32
);

538 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0xcfc, 4, 
s
, 
i440fx_ªad_d©a
, 
i440fx_wrôe_d©a
,

539 
DEVIO_SIZE8
 | 
DEVIO_SIZE16
 | 
DEVIO_SIZE32
);

540 
d
 = 
	`pci_ªgi°î_devi˚
(
b
, "i440FX", 0, 0x8086, 0x1237, 0x02, 0x0600);

541 
	`put_À16
(&
d
->
c⁄fig
[
PCI_SUBSYSTEM_VENDOR_ID
], 0x1af4);

542 
	`put_À16
(&
d
->
c⁄fig
[
PCI_SUBSYSTEM_ID
], 0x1100);

544 
s
->
pci_dev
 = 
d
;

545 
s
->
pci_bus
 = 
b
;

547 
s
->
piix3_dev
 = 
	`pci_ªgi°î_devi˚
(
b
, "PIIX3", 8, 0x8086, 0x7000,

549 
	`pci_devi˚_£t_c⁄fig8
(
s
->
piix3_dev
, 0x0e, 0x80);

551 *
pbus
 = 
b
;

552 *
µiix3_dev‚
 = 
s
->
piix3_dev
->
dev‚
;

553  
s
;

554 
	}
}

557 
	$i440fx_m≠_öãºu±s
(
I440FXSèã
 *
s
, 
uöt8_t
 *
ñ¸
,

558 c⁄° 
uöt8_t
 *
pci_úqs
)

560 
PCIBus
 *
b
 = 
s
->
pci_bus
;

561 
PCIDevi˚
 *
d
, *
hd
;

562 
úq_num
, 
pic_úq
, 
dev‚
, 
i
;

565 
hd
 = 
s
->
piix3_dev
;

567 
ñ¸
[0] = 0;

568 
ñ¸
[1] = 0;

569 
i
 = 0; i < 4; i++) {

570 
úq_num
 = 
pci_úqs
[
i
];

571 
hd
->
c⁄fig
[0x60 + 
i
] = 
úq_num
;

572 
ñ¸
[
úq_num
 >> 3] |= (1 << (irq_num & 7));

575 
dev‚
 = 0; devfn < 256; devfn++) {

576 
d
 = 
b
->
devi˚
[
dev‚
];

577 i‡(!
d
)

579 i‡(
d
->
c⁄fig
[
PCI_INTERRUPT_PIN
]) {

580 
úq_num
 = 0;

581 
úq_num
 = 
	`bus_m≠_úq
(
d
, irq_num);

582 
pic_úq
 = 
hd
->
c⁄fig
[0x60 + 
úq_num
];

583 i‡(
pic_úq
 < 16) {

584 
d
->
c⁄fig
[
PCI_INTERRUPT_LINE
] = 
pic_úq
;

588 
	}
}

	@pci.h

24 #i‚de‡
PCI_H


25 
	#PCI_H


	)

27 
	~"iomem.h
"

29 
PCIBus
 
	tPCIBus
;

30 
PCIDevi˚
 
	tPCIDevi˚
;

33 
	#PCI_ADDRESS_SPACE_MEM
 0x00

	)

34 
	#PCI_ADDRESS_SPACE_IO
 0x01

	)

35 
	#PCI_ADDRESS_SPACE_MEM_PREFETCH
 0x08

	)

37 
	#PCI_ROM_SLOT
 6

	)

38 
	#PCI_NUM_REGIONS
 7

	)

41 
	#PCI_VENDOR_ID
 0x00

	)

42 
	#PCI_DEVICE_ID
 0x02

	)

43 
	#PCI_COMMAND
 0x04

	)

44 
	#PCI_COMMAND_IO
 (1 << 0)

	)

45 
	#PCI_COMMAND_MEMORY
 (1 << 1)

	)

46 
	#PCI_STATUS
 0x06

	)

47 
	#PCI_STATUS_CAP_LIST
 (1 << 4)

	)

48 
	#PCI_CLASS_PROG
 0x09

	)

49 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2¯

	)

50 
	#PCI_SUBSYSTEM_ID
 0x2ê

	)

51 
	#PCI_CAPABILITY_LIST
 0x34

	)

52 
	#PCI_INTERRUPT_LINE
 0x3¯

	)

53 
	#PCI_INTERRUPT_PIN
 0x3d

	)

55 
	tPCIB¨SëFunc
(*
	t›aque
, 
	tb¨_num
, 
	tuöt32_t
 
	taddr
,

56 
	tBOOL
 
	tíabÀd
);

58 
PCIDevi˚
 *
pci_ªgi°î_devi˚
(
PCIBus
 *
b
, c⁄° *
«me
, 
dev‚
,

59 
uöt16_t
 
víd‹_id
, uöt16_à
devi˚_id
,

60 
uöt8_t
 
ªvisi⁄
, 
uöt16_t
 
˛ass_id
);

61 
PhysMem‹yM≠
 *
pci_devi˚_gë_mem_m≠
(
PCIDevi˚
 *
d
);

62 
PhysMem‹yM≠
 *
pci_devi˚_gë_p‹t_m≠
(
PCIDevi˚
 *
d
);

63 
pci_ªgi°î_b¨
(
PCIDevi˚
 *
d
, 
b¨_num
,

64 
uöt32_t
 
size
, 
ty≥
,

65 *
›aque
, 
PCIB¨SëFunc
 *
b¨_£t
);

66 
IRQSig«l
 *
pci_devi˚_gë_úq
(
PCIDevi˚
 *
d
, 
úq_num
);

67 
uöt8_t
 *
pci_devi˚_gë_dma_±r
(
PCIDevi˚
 *
d
, 
uöt64_t
 
addr
, 
BOOL
 
is_rw
);

68 
pci_devi˚_£t_c⁄fig8
(
PCIDevi˚
 *
d
, 
uöt8_t
 
addr
, uöt8_à
vÆ
);

69 
pci_devi˚_£t_c⁄fig16
(
PCIDevi˚
 *
d
, 
uöt8_t
 
addr
, 
uöt16_t
 
vÆ
);

70 
pci_devi˚_gë_dev‚
(
PCIDevi˚
 *
d
);

71 
pci_add_ˇ∑bûôy
(
PCIDevi˚
 *
d
, c⁄° 
uöt8_t
 *
buf
, 
size
);

73 
I440FXSèã
 
	tI440FXSèã
;

75 
I440FXSèã
 *
i440fx_öô
(
PCIBus
 **
pbus
, *
µiix3_dev‚
,

76 
PhysMem‹yM≠
 *
mem_m≠
, PhysMem‹yM≠ *
p‹t_m≠
,

77 
IRQSig«l
 *
pic_úqs
);

78 
i440fx_m≠_öãºu±s
(
I440FXSèã
 *
s
, 
uöt8_t
 *
ñ¸
,

79 c⁄° 
uöt8_t
 *
pci_úqs
);

	@pckbd.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

30 
	~"cutûs.h
"

31 
	~"iomem.h
"

32 
	~"ps2.h
"

33 
	~"vútio.h
"

34 
	~"machöe.h
"

43 
	#KBD_CCMD_READ_MODE
 0x20

	)

44 
	#KBD_CCMD_WRITE_MODE
 0x60

	)

45 
	#KBD_CCMD_GET_VERSION
 0xA1

	)

46 
	#KBD_CCMD_MOUSE_DISABLE
 0xA7

	)

47 
	#KBD_CCMD_MOUSE_ENABLE
 0xA8

	)

48 
	#KBD_CCMD_TEST_MOUSE
 0xA9

	)

49 
	#KBD_CCMD_SELF_TEST
 0xAA

	)

50 
	#KBD_CCMD_KBD_TEST
 0xAB

	)

51 
	#KBD_CCMD_KBD_DISABLE
 0xAD

	)

52 
	#KBD_CCMD_KBD_ENABLE
 0xAE

	)

53 
	#KBD_CCMD_READ_INPORT
 0xC0

	)

54 
	#KBD_CCMD_READ_OUTPORT
 0xD0

	)

55 
	#KBD_CCMD_WRITE_OUTPORT
 0xD1

	)

56 
	#KBD_CCMD_WRITE_OBUF
 0xD2

	)

57 
	#KBD_CCMD_WRITE_AUX_OBUF
 0xD3

	)

59 
	#KBD_CCMD_WRITE_MOUSE
 0xD4

	)

60 
	#KBD_CCMD_DISABLE_A20
 0xDD

	)

61 
	#KBD_CCMD_ENABLE_A20
 0xDF

	)

62 
	#KBD_CCMD_RESET
 0xFE

	)

65 
	#KBD_STAT_OBF
 0x01

	)

66 
	#KBD_STAT_IBF
 0x02

	)

67 
	#KBD_STAT_SELFTEST
 0x04

	)

68 
	#KBD_STAT_CMD
 0x08

	)

69 
	#KBD_STAT_UNLOCKED
 0x10

	)

70 
	#KBD_STAT_MOUSE_OBF
 0x20

	)

71 
	#KBD_STAT_GTO
 0x40

	)

72 
	#KBD_STAT_PERR
 0x80

	)

75 
	#KBD_MODE_KBD_INT
 0x01

	)

76 
	#KBD_MODE_MOUSE_INT
 0x02

	)

77 
	#KBD_MODE_SYS
 0x04

	)

78 
	#KBD_MODE_NO_KEYLOCK
 0x08

	)

79 
	#KBD_MODE_DISABLE_KBD
 0x10

	)

80 
	#KBD_MODE_DISABLE_MOUSE
 0x20

	)

81 
	#KBD_MODE_KCC
 0x40

	)

82 
	#KBD_MODE_RFU
 0x80

	)

84 
	#KBD_PENDING_KBD
 1

	)

85 
	#KBD_PENDING_AUX
 2

	)

87 
	sKBDSèã
 {

88 
uöt8_t
 
	mwrôe_cmd
;

89 
uöt8_t
 
	m°©us
;

90 
uöt8_t
 
	mmode
;

92 
uöt8_t
 
	m≥ndög
;

93 
PS2KbdSèã
 *
	mkbd
;

94 
PS2Mou£Sèã
 *
	mmou£
;

96 
IRQSig«l
 *
	múq_kbd
;

97 
IRQSig«l
 *
	múq_mou£
;

100 
	$qemu_sy°em_ª£t_ªque°
()

102 
	`¥ötf
("system_reset_request\n");

103 
	`exô
(1);

105 
	}
}

107 
	$i›‹t_£t_a20
(
vÆ
)

109 
	}
}

111 
	$i›‹t_gë_a20
()

114 
	}
}

119 
	$kbd_upd©e_úq
(
KBDSèã
 *
s
)

121 
úq_kbd_Àvñ
, 
úq_mou£_Àvñ
;

123 
úq_kbd_Àvñ
 = 0;

124 
úq_mou£_Àvñ
 = 0;

125 
s
->
°©us
 &~(
KBD_STAT_OBF
 | 
KBD_STAT_MOUSE_OBF
);

126 i‡(
s
->
≥ndög
) {

127 
s
->
°©us
 |
KBD_STAT_OBF
;

129 i‡(
s
->
≥ndög
 =
KBD_PENDING_AUX
) {

130 
s
->
°©us
 |
KBD_STAT_MOUSE_OBF
;

131 i‡(
s
->
mode
 & 
KBD_MODE_MOUSE_INT
)

132 
úq_mou£_Àvñ
 = 1;

134 i‡((
s
->
mode
 & 
KBD_MODE_KBD_INT
) &&

135 !(
s
->
mode
 & 
KBD_MODE_DISABLE_KBD
))

136 
úq_kbd_Àvñ
 = 1;

139 
	`£t_úq
(
s
->
úq_kbd
, 
úq_kbd_Àvñ
);

140 
	`£t_úq
(
s
->
úq_mou£
, 
úq_mou£_Àvñ
);

141 
	}
}

143 
	$kbd_upd©e_kbd_úq
(*
›aque
, 
Àvñ
)

145 
KBDSèã
 *
s
 = (KBDSèã *)
›aque
;

147 i‡(
Àvñ
)

148 
s
->
≥ndög
 |
KBD_PENDING_KBD
;

150 
s
->
≥ndög
 &~
KBD_PENDING_KBD
;

151 
	`kbd_upd©e_úq
(
s
);

152 
	}
}

154 
	$kbd_upd©e_aux_úq
(*
›aque
, 
Àvñ
)

156 
KBDSèã
 *
s
 = (KBDSèã *)
›aque
;

158 i‡(
Àvñ
)

159 
s
->
≥ndög
 |
KBD_PENDING_AUX
;

161 
s
->
≥ndög
 &~
KBD_PENDING_AUX
;

162 
	`kbd_upd©e_úq
(
s
);

163 
	}
}

165 
uöt32_t
 
	$kbd_ªad_°©us
(*
›aque
, 
uöt32_t
 
addr
, 
size_log2
)

167 
KBDSèã
 *
s
 = 
›aque
;

168 
vÆ
;

169 
vÆ
 = 
s
->
°©us
;

170 #i‡
	`deföed
(
DEBUG_KBD
)

171 
	`¥ötf
("kbd:Ñód sètus=0x%02x\n", 
vÆ
);

173  
vÆ
;

174 
	}
}

176 
	$kbd_queue
(
KBDSèã
 *
s
, 
b
, 
aux
)

178 i‡(
aux
)

179 
	`ps2_queue
(
s
->
mou£
, 
b
);

181 
	`ps2_queue
(
s
->
kbd
, 
b
);

182 
	}
}

184 
	$kbd_wrôe_comm™d
(*
›aque
, 
uöt32_t
 
addr
, uöt32_à
vÆ
,

185 
size_log2
)

187 
KBDSèã
 *
s
 = 
›aque
;

189 #i‡
	`deföed
(
DEBUG_KBD
)

190 
	`¥ötf
("kbd: wrôêcmd=0x%02x\n", 
vÆ
);

192 
vÆ
) {

193 
KBD_CCMD_READ_MODE
:

194 
	`kbd_queue
(
s
, s->
mode
, 1);

196 
KBD_CCMD_WRITE_MODE
:

197 
KBD_CCMD_WRITE_OBUF
:

198 
KBD_CCMD_WRITE_AUX_OBUF
:

199 
KBD_CCMD_WRITE_MOUSE
:

200 
KBD_CCMD_WRITE_OUTPORT
:

201 
s
->
wrôe_cmd
 = 
vÆ
;

203 
KBD_CCMD_MOUSE_DISABLE
:

204 
s
->
mode
 |
KBD_MODE_DISABLE_MOUSE
;

206 
KBD_CCMD_MOUSE_ENABLE
:

207 
s
->
mode
 &~
KBD_MODE_DISABLE_MOUSE
;

209 
KBD_CCMD_TEST_MOUSE
:

210 
	`kbd_queue
(
s
, 0x00, 0);

212 
KBD_CCMD_SELF_TEST
:

213 
s
->
°©us
 |
KBD_STAT_SELFTEST
;

214 
	`kbd_queue
(
s
, 0x55, 0);

216 
KBD_CCMD_KBD_TEST
:

217 
	`kbd_queue
(
s
, 0x00, 0);

219 
KBD_CCMD_KBD_DISABLE
:

220 
s
->
mode
 |
KBD_MODE_DISABLE_KBD
;

221 
	`kbd_upd©e_úq
(
s
);

223 
KBD_CCMD_KBD_ENABLE
:

224 
s
->
mode
 &~
KBD_MODE_DISABLE_KBD
;

225 
	`kbd_upd©e_úq
(
s
);

227 
KBD_CCMD_READ_INPORT
:

228 
	`kbd_queue
(
s
, 0x00, 0);

230 
KBD_CCMD_READ_OUTPORT
:

232 
vÆ
 = 0x01 | (
	`i›‹t_gë_a20
() << 1);

233 i‡(
s
->
°©us
 & 
KBD_STAT_OBF
)

234 
vÆ
 |= 0x10;

235 i‡(
s
->
°©us
 & 
KBD_STAT_MOUSE_OBF
)

236 
vÆ
 |= 0x20;

237 
	`kbd_queue
(
s
, 
vÆ
, 0);

239 
KBD_CCMD_ENABLE_A20
:

240 
	`i›‹t_£t_a20
(1);

242 
KBD_CCMD_DISABLE_A20
:

243 
	`i›‹t_£t_a20
(0);

245 
KBD_CCMD_RESET
:

246 
	`qemu_sy°em_ª£t_ªque°
();

252 
	`Ârötf
(
°dîr
, "qemu: unsuµ‹ãd keybﬂrd cmd=0x%02x\n", 
vÆ
);

255 
	}
}

257 
uöt32_t
 
	$kbd_ªad_d©a
(*
›aque
, 
uöt32_t
 
addr
, 
size_log2
)

259 
KBDSèã
 *
s
 = 
›aque
;

260 
uöt32_t
 
vÆ
;

261 i‡(
s
->
≥ndög
 =
KBD_PENDING_AUX
)

262 
vÆ
 = 
	`ps2_ªad_d©a
(
s
->
mou£
);

264 
vÆ
 = 
	`ps2_ªad_d©a
(
s
->
kbd
);

265 #ifde‡
DEBUG_KBD


266 
	`¥ötf
("kbd:Ñód d©a=0x%02x\n", 
vÆ
);

268  
vÆ
;

269 
	}
}

271 
	$kbd_wrôe_d©a
(*
›aque
, 
uöt32_t
 
addr
, uöt32_à
vÆ
, 
size_log2
)

273 
KBDSèã
 *
s
 = 
›aque
;

275 #ifde‡
DEBUG_KBD


276 
	`¥ötf
("kbd: wrôêd©a=0x%02x\n", 
vÆ
);

279 
s
->
wrôe_cmd
) {

281 
	`ps2_wrôe_keybﬂrd
(
s
->
kbd
, 
vÆ
);

283 
KBD_CCMD_WRITE_MODE
:

284 
s
->
mode
 = 
vÆ
;

285 
	`ps2_keybﬂrd_£t_å™¶©i⁄
(
s
->
kbd
, (s->
mode
 & 
KBD_MODE_KCC
) != 0);

287 
	`kbd_upd©e_úq
(
s
);

289 
KBD_CCMD_WRITE_OBUF
:

290 
	`kbd_queue
(
s
, 
vÆ
, 0);

292 
KBD_CCMD_WRITE_AUX_OBUF
:

293 
	`kbd_queue
(
s
, 
vÆ
, 1);

295 
KBD_CCMD_WRITE_OUTPORT
:

296 
	`i›‹t_£t_a20
((
vÆ
 >> 1) & 1);

297 i‡(!(
vÆ
 & 1)) {

298 
	`qemu_sy°em_ª£t_ªque°
();

301 
KBD_CCMD_WRITE_MOUSE
:

302 
	`ps2_wrôe_mou£
(
s
->
mou£
, 
vÆ
);

307 
s
->
wrôe_cmd
 = 0;

308 
	}
}

310 
	$kbd_ª£t
(*
›aque
)

312 
KBDSèã
 *
s
 = 
›aque
;

314 
s
->
mode
 = 
KBD_MODE_KBD_INT
 | 
KBD_MODE_MOUSE_INT
;

315 
s
->
°©us
 = 
KBD_STAT_CMD
 | 
KBD_STAT_UNLOCKED
;

316 
	}
}

318 
KBDSèã
 *
	$i8042_öô
(
PS2KbdSèã
 **
pkbd
,

319 
PS2Mou£Sèã
 **
pmou£
,

320 
PhysMem‹yM≠
 *
p‹t_m≠
,

321 
IRQSig«l
 *
kbd_úq
, IRQSig«»*
mou£_úq
, 
uöt32_t
 
io_ba£
)

323 
KBDSèã
 *
s
;

325 
s
 = 
	`mÆlocz
((*s));

327 
s
->
úq_kbd
 = 
kbd_úq
;

328 
s
->
úq_mou£
 = 
mou£_úq
;

330 
	`kbd_ª£t
(
s
);

331 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 
io_ba£
, 1, 
s
, 
kbd_ªad_d©a
, 
kbd_wrôe_d©a
,

332 
DEVIO_SIZE8
);

333 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 
io_ba£
 + 4, 1, 
s
, 
kbd_ªad_°©us
, 
kbd_wrôe_comm™d
,

334 
DEVIO_SIZE8
);

336 
s
->
kbd
 = 
	`ps2_kbd_öô
(
kbd_upd©e_kbd_úq
, s);

337 
s
->
mou£
 = 
	`ps2_mou£_öô
(
kbd_upd©e_aux_úq
, s);

339 *
pkbd
 = 
s
->
kbd
;

340 *
pmou£
 = 
s
->
mou£
;

341  
s
;

342 
	}
}

	@ps2.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

30 
	~"cutûs.h
"

31 
	~"iomem.h
"

32 
	~"ps2.h
"

41 
	#KBD_CMD_SET_LEDS
 0xED

	)

42 
	#KBD_CMD_ECHO
 0xEE

	)

43 
	#KBD_CMD_GET_ID
 0xF2

	)

44 
	#KBD_CMD_SET_RATE
 0xF3

	)

45 
	#KBD_CMD_ENABLE
 0xF4

	)

46 
	#KBD_CMD_RESET_DISABLE
 0xF5

	)

47 
	#KBD_CMD_RESET_ENABLE
 0xF6

	)

48 
	#KBD_CMD_RESET
 0xFF

	)

51 
	#KBD_REPLY_POR
 0xAA

	)

52 
	#KBD_REPLY_ACK
 0xFA

	)

53 
	#KBD_REPLY_RESEND
 0xFE

	)

56 
	#AUX_SET_SCALE11
 0xE6

	)

57 
	#AUX_SET_SCALE21
 0xE7

	)

58 
	#AUX_SET_RES
 0xE8

	)

59 
	#AUX_GET_SCALE
 0xE9

	)

60 
	#AUX_SET_STREAM
 0xEA

	)

61 
	#AUX_POLL
 0xEB

	)

62 
	#AUX_RESET_WRAP
 0xEC

	)

63 
	#AUX_SET_WRAP
 0xEE

	)

64 
	#AUX_SET_REMOTE
 0xF0

	)

65 
	#AUX_GET_TYPE
 0xF2

	)

66 
	#AUX_SET_SAMPLE
 0xF3

	)

67 
	#AUX_ENABLE_DEV
 0xF4

	)

68 
	#AUX_DISABLE_DEV
 0xF5

	)

69 
	#AUX_SET_DEFAULT
 0xF6

	)

70 
	#AUX_RESET
 0xFF

	)

71 
	#AUX_ACK
 0xFA

	)

73 
	#MOUSE_STATUS_REMOTE
 0x40

	)

74 
	#MOUSE_STATUS_ENABLED
 0x20

	)

75 
	#MOUSE_STATUS_SCALE21
 0x10

	)

77 
	#PS2_QUEUE_SIZE
 256

	)

80 
uöt8_t
 
	md©a
[
PS2_QUEUE_SIZE
];

81 
	mΩå
, 
	mw±r
, 
	mcou¡
;

82 } 
	tPS2Queue
;

85 
PS2Queue
 
	mqueue
;

86 
öt32_t
 
	mwrôe_cmd
;

87 (*
	mupd©e_úq
)(*, );

88 *
	mupd©e_¨g
;

89 } 
	tPS2Sèã
;

91 
	sPS2KbdSèã
 {

92 
PS2Sèã
 
	mcomm⁄
;

93 
	msˇn_íabÀd
;

97 
	må™¶©e
;

100 
	sPS2Mou£Sèã
 {

101 
PS2Sèã
 
	mcomm⁄
;

102 
uöt8_t
 
	mmou£_°©us
;

103 
uöt8_t
 
	mmou£_ªsﬁuti⁄
;

104 
uöt8_t
 
	mmou£_ßm∂e_øã
;

105 
uöt8_t
 
	mmou£_wøp
;

106 
uöt8_t
 
	mmou£_ty≥
;

107 
uöt8_t
 
	mmou£_dëe˘_°©e
;

108 
	mmou£_dx
;

109 
	mmou£_dy
;

110 
	mmou£_dz
;

111 
uöt8_t
 
	mmou£_buâ⁄s
;

114 
	$ps2_queue
(*
›aque
, 
b
)

116 
PS2Sèã
 *
s
 = (PS2Sèã *)
›aque
;

117 
PS2Queue
 *
q
 = &
s
->
queue
;

119 i‡(
q
->
cou¡
 >
PS2_QUEUE_SIZE
)

121 
q
->
d©a
[q->
w±r
] = 
b
;

122 i‡(++
q
->
w±r
 =
PS2_QUEUE_SIZE
)

123 
q
->
w±r
 = 0;

124 
q
->
cou¡
++;

125 
s
->
	`upd©e_úq
(s->
upd©e_¨g
, 1);

126 
	}
}

128 
	#INPUT_MAKE_KEY_MIN
 96

	)

129 
	#INPUT_MAKE_KEY_MAX
 127

	)

131 c⁄° 
uöt8_t
 
	glöux_öput_to_keycode_£t1
[
INPUT_MAKE_KEY_MAX
 - 
INPUT_MAKE_KEY_MIN
 + 1] = {

140 
	$ps2_put_keycode
(
PS2KbdSèã
 *
s
, 
BOOL
 
is_down
, 
keycode
)

142 i‡(
keycode
 >
INPUT_MAKE_KEY_MIN
) {

143 i‡(
keycode
 > 
INPUT_MAKE_KEY_MAX
)

145 
keycode
 = 
löux_öput_to_keycode_£t1
[keycodê- 
INPUT_MAKE_KEY_MIN
];

146 i‡(
keycode
 == 0)

148 
	`ps2_queue
(&
s
->
comm⁄
, 0xe0);

150 
	`ps2_queue
(&
s
->
comm⁄
, 
keycode
 | ((!
is_down
) << 7));

151 
	}
}

153 
uöt32_t
 
	$ps2_ªad_d©a
(*
›aque
)

155 
PS2Sèã
 *
s
 = (PS2Sèã *)
›aque
;

156 
PS2Queue
 *
q
;

157 
vÆ
, 
ödex
;

159 
q
 = &
s
->
queue
;

160 i‡(
q
->
cou¡
 == 0) {

164 
ödex
 = 
q
->
Ωå
 - 1;

165 i‡(
ödex
 < 0)

166 
ödex
 = 
PS2_QUEUE_SIZE
 - 1;

167 
vÆ
 = 
q
->
d©a
[
ödex
];

169 
vÆ
 = 
q
->
d©a
[q->
Ωå
];

170 i‡(++
q
->
Ωå
 =
PS2_QUEUE_SIZE
)

171 
q
->
Ωå
 = 0;

172 
q
->
cou¡
--;

174 
s
->
	`upd©e_úq
(s->
upd©e_¨g
, 0);

176 
s
->
	`upd©e_úq
(s->
upd©e_¨g
, 
q
->
cou¡
 != 0);

178  
vÆ
;

179 
	}
}

181 
	$ps2_ª£t_keybﬂrd
(
PS2KbdSèã
 *
s
)

183 
s
->
sˇn_íabÀd
 = 1;

184 
	}
}

186 
	$ps2_wrôe_keybﬂrd
(*
›aque
, 
vÆ
)

188 
PS2KbdSèã
 *
s
 = (PS2KbdSèã *)
›aque
;

190 
s
->
comm⁄
.
wrôe_cmd
) {

193 
vÆ
) {

195 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

198 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_RESEND
);

200 
KBD_CMD_GET_ID
:

201 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

202 
	`ps2_queue
(&
s
->
comm⁄
, 0xab);

203 
	`ps2_queue
(&
s
->
comm⁄
, 0x83);

205 
KBD_CMD_ECHO
:

206 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_CMD_ECHO
);

208 
KBD_CMD_ENABLE
:

209 
s
->
sˇn_íabÀd
 = 1;

210 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

212 
KBD_CMD_SET_LEDS
:

213 
KBD_CMD_SET_RATE
:

214 
s
->
comm⁄
.
wrôe_cmd
 = 
vÆ
;

215 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

217 
KBD_CMD_RESET_DISABLE
:

218 
	`ps2_ª£t_keybﬂrd
(
s
);

219 
s
->
sˇn_íabÀd
 = 0;

220 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

222 
KBD_CMD_RESET_ENABLE
:

223 
	`ps2_ª£t_keybﬂrd
(
s
);

224 
s
->
sˇn_íabÀd
 = 1;

225 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

227 
KBD_CMD_RESET
:

228 
	`ps2_ª£t_keybﬂrd
(
s
);

229 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

230 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_POR
);

233 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

237 
KBD_CMD_SET_LEDS
:

238 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

239 
s
->
comm⁄
.
wrôe_cmd
 = -1;

241 
KBD_CMD_SET_RATE
:

242 
	`ps2_queue
(&
s
->
comm⁄
, 
KBD_REPLY_ACK
);

243 
s
->
comm⁄
.
wrôe_cmd
 = -1;

246 
	}
}

252 
	$ps2_keybﬂrd_£t_å™¶©i⁄
(*
›aque
, 
mode
)

254 
PS2KbdSèã
 *
s
 = (PS2KbdSèã *)
›aque
;

255 
s
->
å™¶©e
 = 
mode
;

256 
	}
}

258 
	$ps2_mou£_£nd_∑ckë
(
PS2Mou£Sèã
 *
s
)

260 
b
;

261 
dx1
, 
dy1
, 
dz1
;

263 
dx1
 = 
s
->
mou£_dx
;

264 
dy1
 = 
s
->
mou£_dy
;

265 
dz1
 = 
s
->
mou£_dz
;

267 i‡(
dx1
 > 127)

268 
dx1
 = 127;

269 i‡(
dx1
 < -127)

270 
dx1
 = -127;

271 i‡(
dy1
 > 127)

272 
dy1
 = 127;

273 i‡(
dy1
 < -127)

274 
dy1
 = -127;

275 
b
 = 0x08 | ((
dx1
 < 0Ë<< 4Ë| ((
dy1
 < 0Ë<< 5Ë| (
s
->
mou£_buâ⁄s
 & 0x07);

276 
	`ps2_queue
(&
s
->
comm⁄
, 
b
);

277 
	`ps2_queue
(&
s
->
comm⁄
, 
dx1
 & 0xff);

278 
	`ps2_queue
(&
s
->
comm⁄
, 
dy1
 & 0xff);

280 
s
->
mou£_ty≥
) {

284 i‡(
dz1
 > 127)

285 
dz1
 = 127;

286 i‡(
dz1
 < -127)

287 
dz1
 = -127;

288 
	`ps2_queue
(&
s
->
comm⁄
, 
dz1
 & 0xff);

291 i‡(
dz1
 > 7)

292 
dz1
 = 7;

293 i‡(
dz1
 < -7)

294 
dz1
 = -7;

295 
b
 = (
dz1
 & 0x0fË| ((
s
->
mou£_buâ⁄s
 & 0x18) << 1);

296 
	`ps2_queue
(&
s
->
comm⁄
, 
b
);

301 
s
->
mou£_dx
 -
dx1
;

302 
s
->
mou£_dy
 -
dy1
;

303 
s
->
mou£_dz
 -
dz1
;

304 
	}
}

306 
	$ps2_mou£_evít
(
PS2Mou£Sèã
 *
s
,

307 
dx
, 
dy
, 
dz
, 
buâ⁄s_°©e
)

310 i‡(!(
s
->
mou£_°©us
 & 
MOUSE_STATUS_ENABLED
))

313 
s
->
mou£_dx
 +
dx
;

314 
s
->
mou£_dy
 -
dy
;

315 
s
->
mou£_dz
 +
dz
;

317 i‡(
s
->
mou£_dx
 =0 && s->
mou£_dy
 =0 && s->
mou£_dz
 == 0 &&

318 
s
->
mou£_buâ⁄s
 =
buâ⁄s_°©e
)

320 
s
->
mou£_buâ⁄s
 = 
buâ⁄s_°©e
;

322 i‡(!(
s
->
mou£_°©us
 & 
MOUSE_STATUS_REMOTE
) &&

323 (
s
->
comm⁄
.
queue
.
cou¡
 < (
PS2_QUEUE_SIZE
 - 16))) {

327 
	`ps2_mou£_£nd_∑ckë
(
s
);

328 i‡(
s
->
mou£_dx
 =0 && s->
mou£_dy
 =0 && s->
mou£_dz
 == 0)

332 
	}
}

334 
	$ps2_wrôe_mou£
(*
›aque
, 
vÆ
)

336 
PS2Mou£Sèã
 *
s
 = (PS2Mou£Sèã *)
›aque
;

337 #ifde‡
DEBUG_MOUSE


338 
	`¥ötf
("kbd: wrôêmou£ 0x%02x\n", 
vÆ
);

340 
s
->
comm⁄
.
wrôe_cmd
) {

344 i‡(
s
->
mou£_wøp
) {

345 i‡(
vÆ
 =
AUX_RESET_WRAP
) {

346 
s
->
mou£_wøp
 = 0;

347 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

349 } i‡(
vÆ
 !
AUX_RESET
) {

350 
	`ps2_queue
(&
s
->
comm⁄
, 
vÆ
);

354 
vÆ
) {

355 
AUX_SET_SCALE11
:

356 
s
->
mou£_°©us
 &~
MOUSE_STATUS_SCALE21
;

357 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

359 
AUX_SET_SCALE21
:

360 
s
->
mou£_°©us
 |
MOUSE_STATUS_SCALE21
;

361 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

363 
AUX_SET_STREAM
:

364 
s
->
mou£_°©us
 &~
MOUSE_STATUS_REMOTE
;

365 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

367 
AUX_SET_WRAP
:

368 
s
->
mou£_wøp
 = 1;

369 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

371 
AUX_SET_REMOTE
:

372 
s
->
mou£_°©us
 |
MOUSE_STATUS_REMOTE
;

373 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

375 
AUX_GET_TYPE
:

376 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

377 
	`ps2_queue
(&
s
->
comm⁄
, s->
mou£_ty≥
);

379 
AUX_SET_RES
:

380 
AUX_SET_SAMPLE
:

381 
s
->
comm⁄
.
wrôe_cmd
 = 
vÆ
;

382 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

384 
AUX_GET_SCALE
:

385 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

386 
	`ps2_queue
(&
s
->
comm⁄
, s->
mou£_°©us
);

387 
	`ps2_queue
(&
s
->
comm⁄
, s->
mou£_ªsﬁuti⁄
);

388 
	`ps2_queue
(&
s
->
comm⁄
, s->
mou£_ßm∂e_øã
);

390 
AUX_POLL
:

391 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

392 
	`ps2_mou£_£nd_∑ckë
(
s
);

394 
AUX_ENABLE_DEV
:

395 
s
->
mou£_°©us
 |
MOUSE_STATUS_ENABLED
;

396 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

398 
AUX_DISABLE_DEV
:

399 
s
->
mou£_°©us
 &~
MOUSE_STATUS_ENABLED
;

400 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

402 
AUX_SET_DEFAULT
:

403 
s
->
mou£_ßm∂e_øã
 = 100;

404 
s
->
mou£_ªsﬁuti⁄
 = 2;

405 
s
->
mou£_°©us
 = 0;

406 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

408 
AUX_RESET
:

409 
s
->
mou£_ßm∂e_øã
 = 100;

410 
s
->
mou£_ªsﬁuti⁄
 = 2;

411 
s
->
mou£_°©us
 = 0;

412 
s
->
mou£_ty≥
 = 0;

413 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

414 
	`ps2_queue
(&
s
->
comm⁄
, 0xaa);

415 
	`ps2_queue
(&
s
->
comm⁄
, s->
mou£_ty≥
);

421 
AUX_SET_SAMPLE
:

422 
s
->
mou£_ßm∂e_øã
 = 
vÆ
;

424 
s
->
mou£_dëe˘_°©e
) {

427 i‡(
vÆ
 == 200)

428 
s
->
mou£_dëe˘_°©e
 = 1;

431 i‡(
vÆ
 == 100)

432 
s
->
mou£_dëe˘_°©e
 = 2;

433 i‡(
vÆ
 == 200)

434 
s
->
mou£_dëe˘_°©e
 = 3;

436 
s
->
mou£_dëe˘_°©e
 = 0;

439 i‡(
vÆ
 == 80)

440 
s
->
mou£_ty≥
 = 3;

441 
s
->
mou£_dëe˘_°©e
 = 0;

444 i‡(
vÆ
 == 80)

445 
s
->
mou£_ty≥
 = 4;

446 
s
->
mou£_dëe˘_°©e
 = 0;

449 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

450 
s
->
comm⁄
.
wrôe_cmd
 = -1;

452 
AUX_SET_RES
:

453 
s
->
mou£_ªsﬁuti⁄
 = 
vÆ
;

454 
	`ps2_queue
(&
s
->
comm⁄
, 
AUX_ACK
);

455 
s
->
comm⁄
.
wrôe_cmd
 = -1;

458 
	}
}

460 
	$ps2_ª£t
(*
›aque
)

462 
PS2Sèã
 *
s
 = (PS2Sèã *)
›aque
;

463 
PS2Queue
 *
q
;

464 
s
->
wrôe_cmd
 = -1;

465 
q
 = &
s
->
queue
;

466 
q
->
Ωå
 = 0;

467 
q
->
w±r
 = 0;

468 
q
->
cou¡
 = 0;

469 
	}
}

471 
PS2KbdSèã
 *
	$ps2_kbd_öô
((*
upd©e_úq
)(*, ), *
upd©e_¨g
)

473 
PS2KbdSèã
 *
s
 = (PS2KbdSèã *)
	`mÆlocz
((PS2KbdState));

475 
s
->
comm⁄
.
upd©e_úq
 = update_irq;

476 
s
->
comm⁄
.
upd©e_¨g
 = update_arg;

477 
	`ps2_ª£t
(&
s
->
comm⁄
);

478  
s
;

479 
	}
}

481 
PS2Mou£Sèã
 *
	$ps2_mou£_öô
((*
upd©e_úq
)(*, ), *
upd©e_¨g
)

483 
PS2Mou£Sèã
 *
s
 = (PS2Mou£Sèã *)
	`mÆlocz
((PS2MouseState));

485 
s
->
comm⁄
.
upd©e_úq
 = update_irq;

486 
s
->
comm⁄
.
upd©e_¨g
 = update_arg;

487 
	`ps2_ª£t
(&
s
->
comm⁄
);

488  
s
;

489 
	}
}

	@ps2.h

2 
PS2Mou£Sèã
 
	tPS2Mou£Sèã
;

3 
PS2KbdSèã
 
	tPS2KbdSèã
;

5 
PS2KbdSèã
 *
ps2_kbd_öô
((*
upd©e_úq
)(*, ), *
upd©e_¨g
);

6 
PS2Mou£Sèã
 *
	`ps2_mou£_öô
((*
upd©e_úq
)(*, ), *
upd©e_¨g
);

7 
	`ps2_wrôe_mou£
(*, 
vÆ
);

8 
	`ps2_wrôe_keybﬂrd
(*, 
vÆ
);

9 
uöt32_t
 
	`ps2_ªad_d©a
(*);

10 
	`ps2_queue
(*, 
b
);

11 
	`ps2_keybﬂrd_£t_å™¶©i⁄
(*
›aque
, 
mode
);

13 
	`ps2_put_keycode
(
PS2KbdSèã
 *
s
, 
BOOL
 
is_down
, 
keycode
);

14 
	`ps2_mou£_evít
(
PS2Mou£Sèã
 *
s
,

15 
dx
, 
dy
, 
dz
, 
buâ⁄s_°©e
);

18 
VMMou£Sèã
 
	tVMMou£Sèã
;

20 
VMMou£Sèã
 *
	`vmmou£_öô
(
PS2Mou£Sèã
 *
ps2_mou£
);

21 
BOOL
 
	`vmmou£_is_absﬁuã
(
VMMou£Sèã
 *
s
);

22 
	`vmmou£_£nd_mou£_evít
(
VMMou£Sèã
 *
s
, 
x
, 
y
, 
dz
,

23 
buâ⁄s
);

24 
	`vmmou£_h™dÀr
(
VMMou£Sèã
 *
s
, 
uöt32_t
 *
ªgs
);

28 
KBDSèã
 
	tKBDSèã
;

30 
KBDSèã
 *
	`i8042_öô
(
PS2KbdSèã
 **
pkbd
,

31 
PS2Mou£Sèã
 **
pmou£
,

32 
PhysMem‹yM≠
 *
p‹t_m≠
,

33 
IRQSig«l
 *
kbd_úq
, IRQSig«»*
mou£_úq
,

34 
uöt32_t
 
io_ba£
);

	@riscv_cpu.c

32 
	~<°dlib.h
>

33 
	~<°dio.h
>

34 
	~<°d¨g.h
>

35 
	~<°rög.h
>

36 
	~<öây≥s.h
>

37 
	~<as£π.h
>

38 
	~<f˙é.h
>

39 
	~<sys/mm™.h
>

40 
	~<sys/°©.h
>

41 
	~<time.h
>

42 
	~<uni°d.h
>

44 
	~"cutûs.h
"

45 
	~"iomem.h
"

46 
	~"riscv_˝u.h
"

47 
	~"riscvsim/sim_∑øms_°©s.h
"

48 
	~"riscvsim/dømsim_wøµî_c_c⁄√˘‹.h
"

50 #i‚de‡
MAX_XLEN


51 #îr‹ 
MAX_XLEN
 
mu°
 
be
 
deföed


53 #i‚de‡
CONFIG_RISCV_MAX_XLEN


54 #îr‹ 
CONFIG_RISCV_MAX_XLEN
 
mu°
 
be
 
deföed


65 
	~"riscv_˝u_¥iv.h
"

67 #i‡
FLEN
 > 0

68 
	~"so·Â.h
"

71 #ifde‡
USE_GLOBAL_STATE


72 
RISCVCPUSèã
 
	griscv_˝u_globÆ_°©e
;

74 #ifde‡
USE_GLOBAL_VARIABLES


75 
	#code_±r
 
s
->
__code_±r


	)

76 
	#code_íd
 
s
->
__code_íd


	)

77 
	#code_to_pc_addíd
 
s
->
__code_to_pc_addíd


	)

80 #ifde‡
CONFIG_LOGFILE


81 
FILE
 *
	glog_fûe
;

83 
	$log_v¥ötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

85 i‡(!
log_fûe
)

86 
log_fûe
 = 
	`f›í
("/tmp/riscemu.log", "wb");

87 
	`vÂrötf
(
log_fûe
, 
fmt
, 
≠
);

88 
	}
}

90 
	$log_v¥ötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

92 
	`v¥ötf
(
fmt
, 
≠
);

93 
	}
}

96 
__©åibuã__
((
f‹m©
(
¥ötf
, 1, 2), 
unu£d
)Ë
	$log_¥ötf
(c⁄° *
fmt
, ...)

98 
va_li°
 
≠
;

99 
	`va_°¨t
(
≠
, 
fmt
);

100 
	`log_v¥ötf
(
fmt
, 
≠
);

101 
	`va_íd
(
≠
);

102 
	}
}

104 #i‡
MAX_XLEN
 == 128

105 
	$Âröt_èrgë_ul⁄g
(
FILE
 *
f
, 
èrgë_ul⁄g
 
a
)

107 
	`Ârötf
(
f
, "%016" 
PRIx64
 "%016" PRIx64, (
uöt64_t
)(
a
 >> 64), (uint64_t)a);

108 
	}
}

110 
	$Âröt_èrgë_ul⁄g
(
FILE
 *
f
, 
èrgë_ul⁄g
 
a
)

112 
	`Ârötf
(
f
, "%" 
PR_èrgë_ul⁄g
, 
a
);

113 
	}
}

116 
	$¥öt_èrgë_ul⁄g
(
èrgë_ul⁄g
 
a
)

118 
	`Âröt_èrgë_ul⁄g
(
°dout
, 
a
);

119 
	}
}

121 *
	gªg_«me
[32] = {

128 
	$dump_ªgs
(
RISCVCPUSèã
 *
s
)

130 
i
, 
cﬁs
;

131 c⁄° 
¥iv_°r
[4] = "USHM";

132 
cﬁs
 = 256 / 
MAX_XLEN
;

133 
	`¥ötf
("pc =");

134 
	`¥öt_èrgë_ul⁄g
(
s
->
pc
);

135 
	`¥ötf
(" ");

136 
i
 = 1; i < 32; i++) {

137 
	`¥ötf
("%-3s=", 
ªg_«me
[
i
]);

138 
	`¥öt_èrgë_ul⁄g
(
s
->
ªg
[
i
]);

139 i‡((
i
 & (
cﬁs
 - 1)) == (cols - 1))

140 
	`¥ötf
("\n");

142 
	`¥ötf
(" ");

144 
	`¥ötf
("¥iv=%c", 
¥iv_°r
[
s
->
¥iv
]);

145 
	`¥ötf
(" mstatus=");

146 
	`¥öt_èrgë_ul⁄g
(
s
->
m°©us
);

147 
	`¥ötf
(" cy˛es=%" 
PRId64
, 
s
->
ö¢_cou¡î
);

148 
	`¥ötf
("\n");

150 
	`¥ötf
(" mideleg=");

151 
	`¥öt_èrgë_ul⁄g
(
s
->
midñeg
);

152 
	`¥ötf
(" mie=");

153 
	`¥öt_èrgë_ul⁄g
(
s
->
mõ
);

154 
	`¥ötf
(" mip=");

155 
	`¥öt_èrgë_ul⁄g
(
s
->
mù
);

156 
	`¥ötf
("\n");

158 
	}
}

160 
__©åibuã__
((
unu£d
)Ë
	$˝u_ab‹t
(
RISCVCPUSèã
 *
s
)

162 
	`dump_ªgs
(
s
);

163 
	`ab‹t
();

164 
	}
}

167 
	#PHYS_MEM_READ_WRITE
(
size
, 
uöt_ty≥
) \

168 
__maybe_unu£d
 
ölöe
 
phys_wrôe_u
 ## 
	`size
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
addr
,\

169 
uöt_ty≥
 
vÆ
) \

171 
PhysMem‹yR™ge
 *
¥
 = 
	`gë_phys_mem_ønge
(
s
->
mem_m≠
, 
addr
);\

172 i‡(!
¥
 || !¥->
is_øm
)\

174 *(
uöt_ty≥
 *)(
¥
->
phys_mem
 + \

175 (
uöçå_t
)(
addr
 - 
¥
->addr)Ë
vÆ
;\

178 
__maybe_unu£d
 
ölöe
 
uöt_ty≥
 
phys_ªad_u
 ## 
	`size
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
addr
) \

180 
PhysMem‹yR™ge
 *
¥
 = 
	`gë_phys_mem_ønge
(
s
->
mem_m≠
, 
addr
);\

181 i‡(!
¥
 || !¥->
is_øm
)\

183  *(
uöt_ty≥
 *)(
¥
->
phys_mem
 + \

184 (
uöçå_t
)(
addr
 - 
¥
->addr)); \

185 }

	)

187 
	$PHYS_MEM_READ_WRITE
(8, 
uöt8_t
)

188 
	$PHYS_MEM_READ_WRITE
(32, 
uöt32_t
)

189 
	$PHYS_MEM_READ_WRITE
(64, 
uöt64_t
)

191 
	#PTE_V_MASK
 (1 << 0)

	)

192 
	#PTE_U_MASK
 (1 << 4)

	)

193 
	#PTE_A_MASK
 (1 << 6)

	)

194 
	#PTE_D_MASK
 (1 << 7)

	)

196 
	#ACCESS_READ
 0

	)

197 
	#ACCESS_WRITE
 1

	)

198 
	#ACCESS_CODE
 2

	)

200 
	#MODE_SIM_START
 1

	)

201 
	#MODE_SIM_STOP
 2

	)

204 
	$dump_simuœti⁄_°©s
(
RISCVCPUSèã
 *
s
)

206 
SimP¨ams
 *
∑øms
 = 
s
->
sim_∑øms
;

209 
	`c›y_ˇche_°©s_to_globÆ_°©s
(
s
);

211 
	`sim_°©s_¥öt
(
s
->
sim˝u
->
°©s
, 
∑øms
->
sim_°©s_∑th
);

213 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

215 
	`Ârötf
(
°dîr
, "(marss-riscv): Saved simulationÅrace in %s\n",

216 
s
->
sim_∑øms
->
sim_åa˚_fûe
);

218 
	}
}

221 
	$°¨t_sy°em_simuœti⁄
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
pc
, 
uöt64_t
 
icou¡
)

223 i‡(!
s
->
simuœti⁄
)

225 
s
->
°¨t_simuœti⁄
 = 
TRUE
;

226 
s
->
°›_simuœti⁄
 = 
FALSE
;

228 
	}
}

231 
	$°›_sy°em_simuœti⁄
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
pc
, 
uöt64_t
 
icou¡
)

233 
uöt64_t
 
sim_time
;

235 i‡(
s
->
simuœti⁄
)

237 
s
->
°¨t_simuœti⁄
 = 
FALSE
;

238 
s
->
°›_simuœti⁄
 = 
TRUE
;

239 
s
->
simuœti⁄
 = 
FALSE
;

240 
	`STOP_SIM_TIMER
(
s
->
sim_íd
);

241 
sim_time
 = 
	`GET_SIM_TIMER_DIFF
(
s
->
sim_°¨t
, s->
sim_íd
) / 1000000;

243 i‡(
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
mem_modñ_ty≥
 =
MEM_MODEL_DRAMSIM
)

245 
	`dømsim_wøµî_¥öt_°©s
();

248 
	`dump_simuœti⁄_°©s
(
s
);

250 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

252 
	`f˛o£
(
s
->
sim_åa˚
);

255 
	`Ârötf
(
°dîr
, "(marss-riscv): SwitchingÅoÉmulation modeátÖc = "

256 "0x%" 
PR_èrgë_ul⁄g
 "\n",

257 
pc
);

259 
	`PRINT_SIM_STAT_HEADER_TO_TERMINAL
(
°dîr
);

262 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "commôs",
ös_simuœãd
);

263 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "cy˛es", 
cy˛es
);

266 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "lﬂd_ö¢", 
ös_ty≥
[
INS_TYPE_LOAD
]);

267 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "°‹e_ö¢", 
ös_ty≥
[
INS_TYPE_STORE
]);

268 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "©omic_ö¢", 
ös_ty≥
[
INS_TYPE_ATOMIC
]);

269 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "sy°em_ö¢", 
ös_emuœãd
);

270 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "¨ômëic_ö¢", 
ös_ty≥
[
INS_TYPE_ARITMETIC
]);

271 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "c⁄d_bønches", 
ös_ty≥
[
INS_TYPE_COND_BRANCH
]);

272 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "jÆ_ö¢", 
ös_ty≥
[
INS_TYPE_JAL
]);

273 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "jÆr_ö¢", 
ös_ty≥
[
INS_TYPE_JALR
]);

275 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "öt_mul_ö¢", 
ös_ty≥
[
INS_TYPE_INT_MUL
]);

276 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "öt_div_ö¢", 
ös_ty≥
[
INS_TYPE_INT_DIV
]);

277 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_lﬂd_ö¢", 
ös_ty≥
[
INS_TYPE_FP_LOAD
]);

278 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_°‹e_ö¢", 
ös_ty≥
[
INS_TYPE_FP_STORE
]);

279 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_add_ö¢", 
ös_ty≥
[
INS_TYPE_FP_ADD
]);

280 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_mul_ö¢", 
ös_ty≥
[
INS_TYPE_FP_MUL
]);

281 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_fma_ö¢", 
ös_ty≥
[
INS_TYPE_FP_FMA
]);

282 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_div_sqπ_ö¢", 
ös_ty≥
[
INS_TYPE_FP_DIV_SQRT
]);

283 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "Â_misc_ö¢", 
ös_ty≥
[
INS_TYPE_FP_MISC
]);

285 i‡(
s
->
sim˝u
->
∑øms
->
íabÀ_l1_ˇches
)

287 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "icache_read",

288 
iˇche_ªad
);

289 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

290 "iˇche_ªad_miss", 
iˇche_ªad_miss
);

291 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "dcache_read",

292 
dˇche_ªad
);

293 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

294 "dˇche_ªad_miss", 
dˇche_ªad_miss
);

295 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "dcache_write",

296 
dˇche_wrôe
);

297 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

298 "dˇche_wrôe_miss", 
dˇche_wrôe_miss
);

300 i‡(
s
->
sim˝u
->
∑øms
->
íabÀ_l2_ˇche
)

302 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "l2_cache_read",

303 
l2_ˇche_ªad
);

304 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

305 "l2_ˇche_ªad_miss", 
l2_ˇche_ªad_miss
);

306 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

307 "l2_ˇche_wrôe", 
l2_ˇche_wrôe
);

308 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

309 "l2_ˇche_wrôe_miss", 
l2_ˇche_wrôe_miss
);

313 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "ö¢_mem_dñay", 
ö¢_mem_dñay
);

314 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "d©a_mem_dñay", 
d©a_mem_dñay
);

315 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "exec_unô_dñay", 
exec_unô_dñay
);

317 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

318 "bpu_c⁄d_öc‹ª˘", 
bpu_c⁄d_öc‹ª˘
);

319 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

321 
bpu_unc⁄d_öc‹ª˘
);

323 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "itlb_reads",

324 
code_éb_lookups
);

325 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "itlb_hits",

326 
code_éb_hôs
);

327 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "load_tlb_reads",

328 
lﬂd_éb_lookups
);

329 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "load_tlb_hits",

330 
lﬂd_éb_hôs
);

331 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "store_tlb_reads",

332 
°‹e_éb_lookups
);

333 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "store_tlb_hits",

334 
°‹e_éb_hôs
);

336 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "ins_page_walks",

337 
ös_∑ge_wÆks
);

338 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "load_page_walks",

339 
lﬂd_∑ge_wÆks
);

340 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "store_page_walks",

341 
°‹e_∑ge_wÆks
);

343 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "ins_page_faults",

344 
ös_∑ge_Áu…s
);

345 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
, "load_page_faults",

346 
lﬂd_∑ge_Áu…s
);

347 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

348 "°‹e_∑ge_Áu…s", 
°‹e_∑ge_Áu…s
);

349 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

350 "eˇŒ (sy°em cÆl)", 
eˇŒ
);

351 
	`PRINT_SIM_STAT_TO_TERMINAL
(
°dîr
, 
s
->
sim˝u
->
°©s
,

352 "öãºu±s", 
öãºu±s
);

353 
	`Ârötf
(
°dîr
, "(marss-riscv): TimeÉlapsed on host-machine %lu ms\n",

354 
sim_time
);

356 
	}
}

360 
	$gë_phys_addr
(
RISCVCPUSèã
 *
s
,

361 
èrgë_ul⁄g
 *
µaddr
,Å¨gë_ul⁄g 
vaddr
,

362 
ac˚ss
)

364 
mode
, 
Àvñs
, 
±e_bôs
, 
±e_idx
, 
±e_mask
, 
±e_size_log2
, 
xwr
, 
¥iv
;

365 
√ed_wrôe
, 
vaddr_shi·
, 
i
, 
±e_addr_bôs
;

366 
èrgë_ul⁄g
 
±e_addr
, 
±e
, 
vaddr_mask
, 
∑ddr
;

368 i‡((
s
->
m°©us
 & 
MSTATUS_MPRV
Ë&& 
ac˚ss
 !
ACCESS_CODE
) {

370 
¥iv
 = (
s
->
m°©us
 >> 
MSTATUS_MPP_SHIFT
) & 3;

372 
¥iv
 = 
s
->priv;

375 i‡(
¥iv
 =
PRV_M
) {

376 i‡(
s
->
cur_xÀn
 < 
MAX_XLEN
) {

378 *
µaddr
 = 
vaddr
 & (((
èrgë_ul⁄g
)1 << 
s
->
cur_xÀn
) - 1);

380 *
µaddr
 = 
vaddr
;

384 #i‡
MAX_XLEN
 == 32

386 
mode
 = 
s
->
ßç
 >> 31;

387 i‡(
mode
 == 0) {

389 *
µaddr
 = 
vaddr
;

393 
Àvñs
 = 2;

394 
±e_size_log2
 = 2;

395 
±e_addr_bôs
 = 22;

398 
mode
 = (
s
->
ßç
 >> 60) & 0xf;

399 i‡(
mode
 == 0) {

401 *
µaddr
 = 
vaddr
;

405 
Àvñs
 = 
mode
 - 8 + 3;

406 
±e_size_log2
 = 3;

407 
vaddr_shi·
 = 
MAX_XLEN
 - (
PG_SHIFT
 + 
Àvñs
 * 9);

408 i‡((((
èrgë_l⁄g
)
vaddr
 << 
vaddr_shi·
) >> vaddr_shift) != vaddr)

410 
±e_addr_bôs
 = 44;

415 i‡(
s
->
simuœti⁄
 && (
ac˚ss
 == 2)) {

416 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_∑ge_wÆks
;

420 i‡(
s
->
simuœti⁄
 && (
ac˚ss
 == 0)) {

421 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
lﬂd_∑ge_wÆks
;

425 i‡(
s
->
simuœti⁄
 && (
ac˚ss
 == 1)) {

426 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
°‹e_∑ge_wÆks
;

429 
±e_addr
 = (
s
->
ßç
 & (((
èrgë_ul⁄g
)1 << 
±e_addr_bôs
Ë- 1)Ë<< 
PG_SHIFT
;

430 
±e_bôs
 = 12 - 
±e_size_log2
;

431 
±e_mask
 = (1 << 
±e_bôs
) - 1;

432 
i
 = 0; i < 
Àvñs
; i++) {

433 
vaddr_shi·
 = 
PG_SHIFT
 + 
±e_bôs
 * (
Àvñs
 - 1 - 
i
);

434 
±e_idx
 = (
vaddr
 >> 
vaddr_shi·
Ë& 
±e_mask
;

435 
±e_addr
 +
±e_idx
 << 
±e_size_log2
;

436 i‡(
±e_size_log2
 == 2) {

437 
±e
 = 
	`phys_ªad_u32
(
s
, 
±e_addr
);

438 i‡(
s
->
simuœti⁄
) {

439 
s
->
hw_pg_tb_wlk_œãncy


440 +
	`mmu_±e_ªad
(
s
->
sim˝u
->
mmu
, 
±e_addr
, 4,

441 
s
->
hw_pg_tb_wlk_°age_id
, s->
¥iv
);

445 
±e
 = 
	`phys_ªad_u64
(
s
, 
±e_addr
);

446 i‡(
s
->
simuœti⁄
) {

447 
s
->
hw_pg_tb_wlk_œãncy


448 +
	`mmu_±e_ªad
(
s
->
sim˝u
->
mmu
, 
±e_addr
, 8,

449 
s
->
hw_pg_tb_wlk_°age_id
, s->
¥iv
);

453 i‡(!(
±e
 & 
PTE_V_MASK
))

455 
∑ddr
 = (
±e
 >> 10Ë<< 
PG_SHIFT
;

456 
xwr
 = (
±e
 >> 1) & 7;

457 i‡(
xwr
 != 0) {

458 i‡(
xwr
 == 2 || xwr == 6)

461 i‡(
¥iv
 =
PRV_S
) {

462 i‡((
±e
 & 
PTE_U_MASK
Ë&& !(
s
->
m°©us
 & 
MSTATUS_SUM
))

465 i‡(!(
±e
 & 
PTE_U_MASK
))

470 i‡(
s
->
m°©us
 & 
MSTATUS_MXR
)

471 
xwr
 |= (xwr >> 2);

473 i‡(((
xwr
 >> 
ac˚ss
) & 1) == 0)

475 
√ed_wrôe
 = !(
±e
 & 
PTE_A_MASK
) ||

476 (!(
±e
 & 
PTE_D_MASK
Ë&& 
ac˚ss
 =
ACCESS_WRITE
);

477 
±e
 |
PTE_A_MASK
;

478 i‡(
ac˚ss
 =
ACCESS_WRITE
)

479 
±e
 |
PTE_D_MASK
;

480 i‡(
√ed_wrôe
) {

481 i‡(
±e_size_log2
 == 2) {

482 
	`phys_wrôe_u32
(
s
, 
±e_addr
, 
±e
);

483 i‡(
s
->
simuœti⁄
) {

484 
s
->
hw_pg_tb_wlk_œãncy


485 +
	`mmu_±e_wrôe
(
s
->
sim˝u
->
mmu
, 
±e_addr
, 4,

486 
s
->
hw_pg_tb_wlk_°age_id
, s->
¥iv
);

490 
	`phys_wrôe_u64
(
s
, 
±e_addr
, 
±e
);

491 i‡(
s
->
simuœti⁄
) {

492 
s
->
hw_pg_tb_wlk_œãncy


493 +
	`mmu_±e_wrôe
(
s
->
sim˝u
->
mmu
, 
±e_addr
, 8,

494 
s
->
hw_pg_tb_wlk_°age_id
, s->
¥iv
);

498 
vaddr_mask
 = ((
èrgë_ul⁄g
)1 << 
vaddr_shi·
) - 1;

499 *
µaddr
 = (
vaddr
 & 
vaddr_mask
Ë| (
∑ddr
 & ~vaddr_mask);

502 
±e_addr
 = 
∑ddr
;

506 
	}
}

509 
	$èrgë_ªad_¶ow
(
RISCVCPUSèã
 *
s
, 
mem_uöt_t
 *
pvÆ
,

510 
èrgë_ul⁄g
 
addr
, 
size_log2
)

512 
size
, 
éb_idx
, 
îr
, 
Æ
;

513 
èrgë_ul⁄g
 
∑ddr
, 
off£t
;

514 
uöt8_t
 *
±r
;

515 
PhysMem‹yR™ge
 *
¥
;

516 
mem_uöt_t
 
ªt
;

519 
size
 = 1 << 
size_log2
;

520 
Æ
 = 
addr
 & (
size
 - 1);

521 i‡(
Æ
 != 0) {

522 
size_log2
) {

525 
uöt8_t
 
v0
, 
v1
;

526 
îr
 = 
	`èrgë_ªad_u8
(
s
, &
v0
, 
addr
);

527 i‡(
îr
)

528  
îr
;

529 
îr
 = 
	`èrgë_ªad_u8
(
s
, &
v1
, 
addr
 + 1);

530 i‡(
îr
)

531  
îr
;

532 
ªt
 = 
v0
 | (
v1
 << 8);

537 
uöt32_t
 
v0
, 
v1
;

538 
addr
 -
Æ
;

539 
îr
 = 
	`èrgë_ªad_u32
(
s
, &
v0
, 
addr
);

540 i‡(
îr
)

541  
îr
;

542 
îr
 = 
	`èrgë_ªad_u32
(
s
, &
v1
, 
addr
 + 4);

543 i‡(
îr
)

544  
îr
;

545 
ªt
 = (
v0
 >> (
Æ
 * 8)Ë| (
v1
 << (32 -ál * 8));

548 #i‡
MLEN
 >= 64

551 
uöt64_t
 
v0
, 
v1
;

552 
addr
 -
Æ
;

553 
îr
 = 
	`èrgë_ªad_u64
(
s
, &
v0
, 
addr
);

554 i‡(
îr
)

555  
îr
;

556 
îr
 = 
	`èrgë_ªad_u64
(
s
, &
v1
, 
addr
 + 8);

557 i‡(
îr
)

558  
îr
;

559 
ªt
 = (
v0
 >> (
Æ
 * 8)Ë| (
v1
 << (64 -ál * 8));

563 #i‡
MLEN
 >= 128

566 
uöt128_t
 
v0
, 
v1
;

567 
addr
 -
Æ
;

568 
îr
 = 
	`èrgë_ªad_u128
(
s
, &
v0
, 
addr
);

569 i‡(
îr
)

570  
îr
;

571 
îr
 = 
	`èrgë_ªad_u128
(
s
, &
v1
, 
addr
 + 16);

572 i‡(
îr
)

573  
îr
;

574 
ªt
 = (
v0
 >> (
Æ
 * 8)Ë| (
v1
 << (128 -ál * 8));

579 
	`ab‹t
();

582 i‡(
	`gë_phys_addr
(
s
, &
∑ddr
, 
addr
, 
ACCESS_READ
)) {

583 
s
->
≥ndög_tvÆ
 = 
addr
;

584 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_LOAD_PAGE_FAULT
;

586 i‡(
s
->
simuœti⁄
) {

587 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
lﬂd_∑ge_Áu…s
;

592 
¥
 = 
	`gë_phys_mem_ønge
(
s
->
mem_m≠
, 
∑ddr
);

593 i‡(!
¥
) {

594 #ifde‡
DUMP_INVALID_MEM_ACCESS


595 
	`¥ötf
("target_read_slow: invalidÖhysicaláddress 0x");

596 
	`¥öt_èrgë_ul⁄g
(
∑ddr
);

597 
	`¥ötf
("\n");

600 } i‡(
¥
->
is_øm
) {

601 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1);

602 
±r
 = 
¥
->
phys_mem
 + (
uöçå_t
)(
∑ddr
 -Ör->
addr
);

603 
s
->
éb_ªad
[
éb_idx
].
vaddr
 = 
addr
 & ~
PG_MASK
;

604 
s
->
éb_ªad
[
éb_idx
].
mem_addíd
 = (
uöçå_t
)
±r
 - 
addr
;

605 
s
->
éb_ªad
[
éb_idx
].
gue°_∑ddr
 = 
∑ddr
 & ~
PG_MASK
;

606 
size_log2
) {

608 
ªt
 = *(
uöt8_t
 *)
±r
;

611 
ªt
 = *(
uöt16_t
 *)
±r
;

614 
ªt
 = *(
uöt32_t
 *)
±r
;

616 #i‡
MLEN
 >= 64

618 
ªt
 = *(
uöt64_t
 *)
±r
;

621 #i‡
MLEN
 >= 128

623 
ªt
 = *(
uöt128_t
 *)
±r
;

627 
	`ab‹t
();

630 
s
->
is_devi˚_io
 = 1;

631 
s
->
d©a_gue°_∑ddr
 = 
∑ddr
;

632 
off£t
 = 
∑ddr
 - 
¥
->
addr
;

633 i‡(((
¥
->
devio_Êags
 >> 
size_log2
) & 1) != 0) {

634 
ªt
 = 
¥
->
	`ªad_func
’r->
›aque
, 
off£t
, 
size_log2
);

636 #i‡
MLEN
 >= 64

637 i‡((
¥
->
devio_Êags
 & 
DEVIO_SIZE32
Ë&& 
size_log2
 == 3) {

639 
ªt
 = 
¥
->
	`ªad_func
’r->
›aque
, 
off£t
, 2);

640 
ªt
 |(
uöt64_t
)
¥
->
	`ªad_func
’r->
›aque
, 
off£t
 + 4, 2) << 32;

645 #ifde‡
DUMP_INVALID_MEM_ACCESS


646 
	`¥ötf
("unsupported deviceÑeadáccess:áddr=0x");

647 
	`¥öt_èrgë_ul⁄g
(
∑ddr
);

648 
	`¥ötf
(" width=%d bôs\n", 1 << (3 + 
size_log2
));

650 
ªt
 = 0;

654 *
pvÆ
 = 
ªt
;

656 
	}
}

659 
	$èrgë_wrôe_¶ow
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
addr
,

660 
mem_uöt_t
 
vÆ
, 
size_log2
)

662 
size
, 
i
, 
éb_idx
, 
îr
;

663 
èrgë_ul⁄g
 
∑ddr
, 
off£t
;

664 
uöt8_t
 *
±r
;

665 
PhysMem‹yR™ge
 *
¥
;

668 
size
 = 1 << 
size_log2
;

669 i‡((
addr
 & (
size
 - 1)) != 0) {

671 
i
 = 0; i < 
size
; i++) {

672 
îr
 = 
	`èrgë_wrôe_u8
(
s
, 
addr
 + 
i
, (
vÆ
 >> (8 * i)) & 0xff);

673 i‡(
îr
)

674  
îr
;

677 i‡(
	`gë_phys_addr
(
s
, &
∑ddr
, 
addr
, 
ACCESS_WRITE
)) {

678 
s
->
≥ndög_tvÆ
 = 
addr
;

679 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_STORE_PAGE_FAULT
;

681 i‡(
s
->
simuœti⁄
) {

682 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
°‹e_∑ge_Áu…s
;

687 
¥
 = 
	`gë_phys_mem_ønge
(
s
->
mem_m≠
, 
∑ddr
);

688 i‡(!
¥
) {

689 #ifde‡
DUMP_INVALID_MEM_ACCESS


690 
	`¥ötf
("target_write_slow: invalidÖhysicaláddress 0x");

691 
	`¥öt_èrgë_ul⁄g
(
∑ddr
);

692 
	`¥ötf
("\n");

694 } i‡(
¥
->
is_øm
) {

695 
	`phys_mem_£t_dúty_bô
(
¥
, 
∑ddr
 -Ör->
addr
);

696 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1);

697 
±r
 = 
¥
->
phys_mem
 + (
uöçå_t
)(
∑ddr
 -Ör->
addr
);

698 
s
->
éb_wrôe
[
éb_idx
].
vaddr
 = 
addr
 & ~
PG_MASK
;

699 
s
->
éb_wrôe
[
éb_idx
].
mem_addíd
 = (
uöçå_t
)
±r
 - 
addr
;

700 
s
->
éb_wrôe
[
éb_idx
].
gue°_∑ddr
 = 
∑ddr
 & ~
PG_MASK
;

701 
size_log2
) {

703 *(
uöt8_t
 *)
±r
 = 
vÆ
;

706 *(
uöt16_t
 *)
±r
 = 
vÆ
;

709 *(
uöt32_t
 *)
±r
 = 
vÆ
;

711 #i‡
MLEN
 >= 64

713 *(
uöt64_t
 *)
±r
 = 
vÆ
;

716 #i‡
MLEN
 >= 128

718 *(
uöt128_t
 *)
±r
 = 
vÆ
;

722 
	`ab‹t
();

725 
s
->
is_devi˚_io
 = 1;

726 
s
->
d©a_gue°_∑ddr
 = 
∑ddr
;

727 
off£t
 = 
∑ddr
 - 
¥
->
addr
;

728 i‡(((
¥
->
devio_Êags
 >> 
size_log2
) & 1) != 0) {

729 
¥
->
	`wrôe_func
’r->
›aque
, 
off£t
, 
vÆ
, 
size_log2
);

731 #i‡
MLEN
 >= 64

732 i‡((
¥
->
devio_Êags
 & 
DEVIO_SIZE32
Ë&& 
size_log2
 == 3) {

734 
¥
->
	`wrôe_func
’r->
›aque
, 
off£t
,

735 
vÆ
 & 0xffffffff, 2);

736 
¥
->
	`wrôe_func
’r->
›aque
, 
off£t
 + 4,

737 (
vÆ
 >> 32) & 0xffffffff, 2);

741 #ifde‡
DUMP_INVALID_MEM_ACCESS


742 
	`¥ötf
("unsupported device writeáccess:áddr=0x");

743 
	`¥öt_èrgë_ul⁄g
(
∑ddr
);

744 
	`¥ötf
(" width=%d bôs\n", 1 << (3 + 
size_log2
));

750 
	}
}

752 
__©åibuã__
((
∑cked
)Ë
	gu«lig√d_u32
 {

753 
uöt32_t
 
	gu32
;

757 
uöt32_t
 
	$gë_ö¢32
(
uöt8_t
 *
±r
)

759 #i‡
	`deföed
(
EMSCRIPTEN
)

760  ((
uöt16_t
 *)
±r
)[0] | (((uint16_t *)ptr)[1] << 16);

762  ((
u«lig√d_u32
 *)
±r
)->
u32
;

764 
	}
}

767 
no_ölöe
 
__ex˚±i⁄
 
	$èrgë_ªad_ö¢_¶ow
(
RISCVCPUSèã
 *
s
,

768 
uöt8_t
 **
µå
,

769 
èrgë_ul⁄g
 
addr
)

771 
éb_idx
;

772 
èrgë_ul⁄g
 
∑ddr
;

773 
uöt8_t
 *
±r
;

774 
PhysMem‹yR™ge
 *
¥
;

776 i‡(
	`gë_phys_addr
(
s
, &
∑ddr
, 
addr
, 
ACCESS_CODE
)) {

777 
s
->
≥ndög_tvÆ
 = 
addr
;

778 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_FETCH_PAGE_FAULT
;

780 i‡(
s
->
simuœti⁄
) {

781 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_∑ge_Áu…s
;

786 
¥
 = 
	`gë_phys_mem_ønge
(
s
->
mem_m≠
, 
∑ddr
);

787 i‡(!
¥
 || !¥->
is_øm
) {

789 
s
->
≥ndög_tvÆ
 = 
addr
;

790 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_FAULT_FETCH
;

793 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1);

794 
±r
 = 
¥
->
phys_mem
 + (
uöçå_t
)(
∑ddr
 -Ör->
addr
);

795 
s
->
éb_code
[
éb_idx
].
vaddr
 = 
addr
 & ~
PG_MASK
;

796 
s
->
éb_code
[
éb_idx
].
mem_addíd
 = (
uöçå_t
)
±r
 - 
addr
;

797 
s
->
éb_code
[
éb_idx
].
gue°_∑ddr
 = 
∑ddr
 & ~
PG_MASK
;

798 *
µå
 = 
±r
;

800 
	}
}

803 
__ex˚±i⁄
 
	$èrgë_ªad_ö¢_u16
(
RISCVCPUSèã
 *
s
, 
uöt16_t
 *
pö¢
,

804 
èrgë_ul⁄g
 
addr
)

806 
uöt32_t
 
éb_idx
;

807 
uöt8_t
 *
±r
;

809 i‡(
s
->
simuœti⁄
 && !s->
ös_éb_lookup_accou¡ed
) {

810 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
code_éb_lookups
;

811 
s
->
ös_éb_lookup_accou¡ed
 = 1;

814 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1);

815 i‡(
	`likñy
(
s
->
éb_code
[
éb_idx
].
vaddr
 =(
addr
 & ~
PG_MASK
))) {

816 
±r
 = (
uöt8_t
 *)(
s
->
éb_code
[
éb_idx
].
mem_addíd
 +

817 (
uöçå_t
)
addr
);

819 i‡(
s
->
simuœti⁄
 && !s->
ös_éb_hô_accou¡ed
) {

820 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
code_éb_hôs
;

821 
s
->
ös_éb_hô_accou¡ed
 = 1;

825 i‡(
	`èrgë_ªad_ö¢_¶ow
(
s
, &
±r
, 
addr
))

828 *
pö¢
 = *(
uöt16_t
 *)
±r
;

830 
	}
}

832 
	$éb_öô
(
RISCVCPUSèã
 *
s
)

834 
i
;

836 
i
 = 0; i < 
s
->
sim_∑øms
->
éb_size
; i++) {

837 
s
->
éb_ªad
[
i
].
vaddr
 = -1;

838 
s
->
éb_wrôe
[
i
].
vaddr
 = -1;

839 
s
->
éb_code
[
i
].
vaddr
 = -1;

840 
s
->
éb_ªad
[
i
].
gue°_∑ddr
 = -1;

841 
s
->
éb_wrôe
[
i
].
gue°_∑ddr
 = -1;

842 
s
->
éb_code
[
i
].
gue°_∑ddr
 = -1;

846 i‡(
s
->
simuœti⁄
 && s->
sim_∑øms
->
íabÀ_bpu
)

848 
	`bpu_Êush
(
s
->
sim˝u
->
bpu
);

850 
	}
}

852 
	$éb_Êush_Æl
(
RISCVCPUSèã
 *
s
)

854 
	`éb_öô
(
s
);

855 
	}
}

857 
	$éb_Êush_vaddr
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
vaddr
)

859 
	`éb_Êush_Æl
(
s
);

860 
	}
}

863 
	$glue
(
riscv_˝u_Êush_éb_wrôe_ønge_øm
,

864 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
,

865 
uöt8_t
 *
øm_±r
, 
size_t
 
øm_size
)

867 
uöt8_t
 *
±r
, *
øm_íd
;

868 
i
;

870 
øm_íd
 = 
øm_±r
 + 
øm_size
;

871 
i
 = 0; i < 
TLB_SIZE
; i++) {

872 i‡(
s
->
éb_wrôe
[
i
].
vaddr
 != -1) {

873 
±r
 = (
uöt8_t
 *)(
s
->
éb_wrôe
[
i
].
mem_addíd
 +

874 (
uöçå_t
)
s
->
éb_wrôe
[
i
].
vaddr
);

875 i‡(
±r
 >
øm_±r
 &&Öå < 
øm_íd
) {

876 
s
->
éb_wrôe
[
i
].
vaddr
 = -1;

880 
	}
}

883 
	#SSTATUS_MASK0
 (
MSTATUS_UIE
 | 
MSTATUS_SIE
 | \

884 
MSTATUS_UPIE
 | 
MSTATUS_SPIE
 | \

885 
MSTATUS_SPP
 | \

886 
MSTATUS_FS
 | 
MSTATUS_XS
 | \

887 
MSTATUS_SUM
 | 
MSTATUS_MXR
)

	)

888 #i‡
MAX_XLEN
 >= 64

889 
	#SSTATUS_MASK
 (
SSTATUS_MASK0
 | 
MSTATUS_UXL_MASK
)

	)

891 
	#SSTATUS_MASK
 
SSTATUS_MASK0


	)

895 
	#MSTATUS_MASK
 (
MSTATUS_UIE
 | 
MSTATUS_SIE
 | 
MSTATUS_MIE
 | \

896 
MSTATUS_UPIE
 | 
MSTATUS_SPIE
 | 
MSTATUS_MPIE
 | \

897 
MSTATUS_SPP
 | 
MSTATUS_MPP
 | \

898 
MSTATUS_FS
 | \

899 
MSTATUS_MPRV
 | 
MSTATUS_SUM
 | 
MSTATUS_MXR
)

	)

902 
	#COUNTEREN_MASK
 ((1 << 0Ë| (1 << 2))

	)

905 
èrgë_ul⁄g
 
	$gë_m°©us
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
mask
)

907 
èrgë_ul⁄g
 
vÆ
;

908 
BOOL
 
sd
;

909 
vÆ
 = 
s
->
m°©us
 | (s->
fs
 << 
MSTATUS_FS_SHIFT
);

910 
vÆ
 &
mask
;

911 
sd
 = ((
vÆ
 & 
MSTATUS_FS
) == MSTATUS_FS) |

912 ((
vÆ
 & 
MSTATUS_XS
) == MSTATUS_XS);

913 i‡(
sd
)

914 
vÆ
 |(
èrgë_ul⁄g
)1 << (
s
->
cur_xÀn
 - 1);

915  
vÆ
;

916 
	}
}

918 
	$gë_ba£_‰om_xÀn
(
xÀn
)

920 i‡(
xÀn
 == 32)

922 i‡(
xÀn
 == 64)

926 
	}
}

928 
	$£t_m°©us
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
vÆ
)

930 
èrgë_ul⁄g
 
mod
, 
mask
;

933 
mod
 = 
s
->
m°©us
 ^ 
vÆ
;

934 i‡((
mod
 & (
MSTATUS_MPRV
 | 
MSTATUS_SUM
 | 
MSTATUS_MXR
)) != 0 ||

935 ((
s
->
m°©us
 & 
MSTATUS_MPRV
Ë&& (
mod
 & 
MSTATUS_MPP
) != 0)) {

936 
	`éb_Êush_Æl
(
s
);

938 
s
->
fs
 = (
vÆ
 >> 
MSTATUS_FS_SHIFT
) & 3;

940 
mask
 = 
MSTATUS_MASK
 & ~
MSTATUS_FS
;

941 #i‡
MAX_XLEN
 >= 64

943 
uxl
, 
sxl
;

944 
uxl
 = (
vÆ
 >> 
MSTATUS_UXL_SHIFT
) & 3;

945 i‡(
uxl
 >1 && ux»<
	`gë_ba£_‰om_xÀn
(
MAX_XLEN
))

946 
mask
 |
MSTATUS_UXL_MASK
;

947 
sxl
 = (
vÆ
 >> 
MSTATUS_UXL_SHIFT
) & 3;

948 i‡(
sxl
 >1 && sx»<
	`gë_ba£_‰om_xÀn
(
MAX_XLEN
))

949 
mask
 |
MSTATUS_SXL_MASK
;

952 
s
->
m°©us
 = (s->m°©u†& ~
mask
Ë| (
vÆ
 & mask);

953 
	}
}

957 
	$c§_ªad
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 *
pvÆ
, 
uöt32_t
 
c§
,

958 
BOOL
 
wûl_wrôe
, * 
run_mode
)

960 
èrgë_ul⁄g
 
vÆ
;

962 i‡(
s
->
simuœti⁄
) {

963 
s
->
sim˝u
->
°©s
[s->
¥iv
].
c§_ªads
++;

965 i‡(((
c§
 & 0xc00Ë=0xc00Ë&& 
wûl_wrôe
)

967 i‡(
s
->
¥iv
 < ((
c§
 >> 8) & 3))

970 
c§
) {

971 #i‡
FLEN
 > 0

973 i‡(
s
->
fs
 == 0)

975 
vÆ
 = 
s
->
fÊags
;

978 i‡(
s
->
fs
 == 0)

980 
vÆ
 = 
s
->
‰m
;

983 i‡(
s
->
fs
 == 0)

985 
vÆ
 = 
s
->
fÊags
 | (s->
‰m
 << 5);

991 
uöt32_t
 
cou¡îí
;

992 i‡(
s
->
¥iv
 < 
PRV_M
) {

993 i‡(
s
->
¥iv
 < 
PRV_S
)

994 
cou¡îí
 = 
s
->
scou¡îí
;

996 
cou¡îí
 = 
s
->
mcou¡îí
;

997 i‡(((
cou¡îí
 >> (
c§
 & 0x1f)) & 1) == 0)

998 
övÆid_c§
;

1001 
vÆ
 = (
öt64_t
)
s
->
ö¢_cou¡î
;

1005 i‡(
s
->
cur_xÀn
 != 32)

1006 
övÆid_c§
;

1008 
uöt32_t
 
cou¡îí
;

1009 i‡(
s
->
¥iv
 < 
PRV_M
) {

1010 i‡(
s
->
¥iv
 < 
PRV_S
)

1011 
cou¡îí
 = 
s
->
scou¡îí
;

1013 
cou¡îí
 = 
s
->
mcou¡îí
;

1014 i‡(((
cou¡îí
 >> (
c§
 & 0x1f)) & 1) == 0)

1015 
övÆid_c§
;

1018 
vÆ
 = 
s
->
ö¢_cou¡î
 >> 32;

1022 
vÆ
 = 
	`gë_m°©us
(
s
, 
SSTATUS_MASK
);

1025 
vÆ
 = 
s
->
mõ
 & s->
midñeg
;

1028 
vÆ
 = 
s
->
°vec
;

1031 
vÆ
 = 
s
->
scou¡îí
;

1034 
vÆ
 = 
s
->
ss¸©ch
;

1037 
vÆ
 = 
s
->
£pc
;

1040 
vÆ
 = 
s
->
sˇu£
;

1043 
vÆ
 = 
s
->
°vÆ
;

1046 
vÆ
 = 
s
->
mù
 & s->
midñeg
;

1049 
vÆ
 = 
s
->
ßç
;

1052 
vÆ
 = 
	`gë_m°©us
(
s
, (
èrgë_ul⁄g
)-1);

1055 
vÆ
 = 
s
->
miß
;

1056 
vÆ
 |(
èrgë_ul⁄g
)
s
->
mxl
 << (s->
cur_xÀn
 - 2);

1059 
vÆ
 = 
s
->
medñeg
;

1062 
vÆ
 = 
s
->
midñeg
;

1065 
vÆ
 = 
s
->
mõ
;

1068 
vÆ
 = 
s
->
mtvec
;

1071 
vÆ
 = 
s
->
mcou¡îí
;

1074 
vÆ
 = 
s
->
ms¸©ch
;

1077 
vÆ
 = 
s
->
mïc
;

1080 
vÆ
 = 
s
->
mˇu£
;

1083 
vÆ
 = 
s
->
mtvÆ
;

1086 
vÆ
 = 
s
->
mù
;

1090 
vÆ
 = (
öt64_t
)
s
->
ö¢_cou¡î
;

1094 i‡(
s
->
cur_xÀn
 != 32)

1095 
övÆid_c§
;

1096 
vÆ
 = 
s
->
ö¢_cou¡î
 >> 32;

1099 
vÆ
 = 
s
->
mh¨tid
;

1102 *
run_mode
 = 
MODE_SIM_START
;

1103 
vÆ
 = 0;

1106 *
run_mode
 = 
MODE_SIM_STOP
;

1107 
vÆ
 = 0;

1110 
övÆid_c§
:

1111 #ifde‡
DUMP_INVALID_CSR


1113 i‡(
c§
 != 0xc01 && csr != 0xc81) {

1114 
	`¥ötf
("c§_ªad: invÆid CSR=0x%x\n", 
c§
);

1117 *
pvÆ
 = 0;

1120 *
pvÆ
 = 
vÆ
;

1122 
	}
}

1124 #i‡
FLEN
 > 0

1125 
	$£t_‰m
(
RISCVCPUSèã
 *
s
, 
vÆ
)

1127 i‡(
vÆ
 >= 5)

1128 
vÆ
 = 0;

1129 
s
->
‰m
 = 
vÆ
;

1130 
	}
}

1133 
	$gë_ö¢_rm
(
RISCVCPUSèã
 *
s
, 
rm
)

1135 i‡(
rm
 == 7)

1136  
s
->
‰m
;

1137 i‡(
rm
 >= 5)

1140  
rm
;

1141 
	}
}

1146 
	$c§_wrôe
(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
c§
, 
èrgë_ul⁄g
 
vÆ
)

1148 
èrgë_ul⁄g
 
mask
;

1150 i‡(
s
->
simuœti⁄
) {

1151 
s
->
sim˝u
->
°©s
[s->
¥iv
].
c§_wrôes
++;

1154 #i‡
	`deföed
(
DUMP_CSR
)

1155 
	`¥ötf
("c§_wrôe: c§=0x%03x vÆ=0x", 
c§
);

1156 
	`¥öt_èrgë_ul⁄g
(
vÆ
);

1157 
	`¥ötf
("\n");

1159 
c§
) {

1160 #i‡
FLEN
 > 0

1162 
s
->
fÊags
 = 
vÆ
 & 0x1f;

1163 
s
->
fs
 = 3;

1166 
	`£t_‰m
(
s
, 
vÆ
 & 7);

1167 
s
->
fs
 = 3;

1170 
	`£t_‰m
(
s
, (
vÆ
 >> 5) & 7);

1171 
s
->
fÊags
 = 
vÆ
 & 0x1f;

1172 
s
->
fs
 = 3;

1176 
	`£t_m°©us
(
s
, (s->
m°©us
 & ~
SSTATUS_MASK
Ë| (
vÆ
 & SSTATUS_MASK));

1179 
mask
 = 
s
->
midñeg
;

1180 
s
->
mõ
 = (s->mõ & ~
mask
Ë| (
vÆ
 & mask);

1183 
s
->
°vec
 = 
vÆ
 & ~3;

1186 
s
->
scou¡îí
 = 
vÆ
 & 
COUNTEREN_MASK
;

1189 
s
->
ss¸©ch
 = 
vÆ
;

1192 
s
->
£pc
 = 
vÆ
 & ~1;

1195 
s
->
sˇu£
 = 
vÆ
;

1198 
s
->
°vÆ
 = 
vÆ
;

1201 
mask
 = 
s
->
midñeg
;

1202 
s
->
mù
 = (s->mù & ~
mask
Ë| (
vÆ
 & mask);

1206 #i‡
MAX_XLEN
 == 32

1208 
√w_mode
;

1209 
√w_mode
 = (
vÆ
 >> 31) & 1;

1210 
s
->
ßç
 = (
vÆ
 & (((
èrgë_ul⁄g
)1 << 22) - 1)) |

1211 (
√w_mode
 << 31);

1215 
mode
, 
√w_mode
;

1216 
mode
 = 
s
->
ßç
 >> 60;

1217 
√w_mode
 = (
vÆ
 >> 60) & 0xf;

1218 i‡(
√w_mode
 == 0 || (new_mode >= 8 &&Çew_mode <= 9))

1219 
mode
 = 
√w_mode
;

1220 
s
->
ßç
 = (
vÆ
 & (((
uöt64_t
)1 << 44) - 1)) |

1221 ((
uöt64_t
)
mode
 << 60);

1224 
	`éb_Êush_Æl
(
s
);

1228 
	`£t_m°©us
(
s
, 
vÆ
);

1231 #i‡
MAX_XLEN
 >= 64

1233 
√w_mxl
;

1234 
√w_mxl
 = (
vÆ
 >> (
s
->
cur_xÀn
 - 2)) & 3;

1235 i‡(
√w_mxl
 >1 &&Çew_mx»<
	`gë_ba£_‰om_xÀn
(
MAX_XLEN
)) {

1238 i‡(
s
->
mxl
 !
√w_mxl
) {

1239 
s
->
mxl
 = 
√w_mxl
;

1240 
s
->
cur_xÀn
 = 1 << (
√w_mxl
 + 4);

1248 
mask
 = (1 << (
CAUSE_STORE_PAGE_FAULT
 + 1)) - 1;

1249 
s
->
medñeg
 = (s->medñeg & ~
mask
Ë| (
vÆ
 & mask);

1252 
mask
 = 
MIP_SSIP
 | 
MIP_STIP
 | 
MIP_SEIP
;

1253 
s
->
midñeg
 = (s->midñeg & ~
mask
Ë| (
vÆ
 & mask);

1256 
mask
 = 
MIP_MSIP
 | 
MIP_MTIP
 | 
MIP_SSIP
 | 
MIP_STIP
 | 
MIP_SEIP
;

1257 
s
->
mõ
 = (s->mõ & ~
mask
Ë| (
vÆ
 & mask);

1260 
s
->
mtvec
 = 
vÆ
 & ~3;

1263 
s
->
mcou¡îí
 = 
vÆ
 & 
COUNTEREN_MASK
;

1266 
s
->
ms¸©ch
 = 
vÆ
;

1269 
s
->
mïc
 = 
vÆ
 & ~1;

1272 
s
->
mˇu£
 = 
vÆ
;

1275 
s
->
mtvÆ
 = 
vÆ
;

1278 
mask
 = 
MIP_SSIP
 | 
MIP_STIP
;

1279 
s
->
mù
 = (s->mù & ~
mask
Ë| (
vÆ
 & mask);

1282 #ifde‡
DUMP_INVALID_CSR


1283 
	`¥ötf
("c§_wrôe: invÆid CSR=0x%x\n", 
c§
);

1288 
	}
}

1290 
	$£t_¥iv
(
RISCVCPUSèã
 *
s
, 
¥iv
)

1292 i‡(
s
->
¥iv
 !=Öriv) {

1293 
	`éb_Êush_Æl
(
s
);

1295 #i‡
MAX_XLEN
 >= 64

1298 
mxl
;

1299 i‡(
¥iv
 =
PRV_S
)

1300 
mxl
 = (
s
->
m°©us
 >> 
MSTATUS_SXL_SHIFT
) & 3;

1301 i‡(
¥iv
 =
PRV_U
)

1302 
mxl
 = (
s
->
m°©us
 >> 
MSTATUS_UXL_SHIFT
) & 3;

1304 
mxl
 = 
s
->mxl;

1305 
s
->
cur_xÀn
 = 1 << (4 + 
mxl
);

1308 
s
->
¥iv
 =Öriv;

1310 
	}
}

1312 
	$øi£_ex˚±i⁄2
(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
ˇu£
,

1313 
èrgë_ul⁄g
 
tvÆ
)

1315 
BOOL
 
dñeg
;

1316 
èrgë_ul⁄g
 
ˇu£l
;

1318 #i‡
	`deföed
(
DUMP_EXCEPTIONS
Ë|| deföed(
DUMP_MMU_EXCEPTIONS
Ë|| deföed(
DUMP_INTERRUPTS
)

1320 
Êag
;

1321 
Êag
 = 0;

1322 #ifde‡
DUMP_MMU_EXCEPTIONS


1323 i‡(
ˇu£
 =
CAUSE_FAULT_FETCH
 ||

1324 
ˇu£
 =
CAUSE_FAULT_LOAD
 ||

1325 
ˇu£
 =
CAUSE_FAULT_STORE
 ||

1326 
ˇu£
 =
CAUSE_FETCH_PAGE_FAULT
 ||

1327 
ˇu£
 =
CAUSE_LOAD_PAGE_FAULT
 ||

1328 
ˇu£
 =
CAUSE_STORE_PAGE_FAULT
)

1329 
Êag
 = 1;

1331 #ifde‡
DUMP_INTERRUPTS


1332 
Êag
 |(
ˇu£
 & 
CAUSE_INTERRUPT
) != 0;

1334 #ifde‡
DUMP_EXCEPTIONS


1335 
Êag
 = 1;

1336 
Êag
 = (
ˇu£
 & 
CAUSE_INTERRUPT
) == 0;

1337 i‡(
ˇu£
 =
CAUSE_SUPERVISOR_ECALL
 || cau£ =
CAUSE_ILLEGAL_INSTRUCTION
)

1338 
Êag
 = 0;

1340 i‡(
Êag
) {

1341 
	`log_¥ötf
("øi£_ex˚±i⁄: cau£=0x%08xÅvÆ=0x", 
ˇu£
);

1342 #ifde‡
CONFIG_LOGFILE


1343 
	`Âröt_èrgë_ul⁄g
(
log_fûe
, 
tvÆ
);

1345 
	`¥öt_èrgë_ul⁄g
(
tvÆ
);

1347 
	`log_¥ötf
("\n");

1348 
	`dump_ªgs
(
s
);

1353 i‡(
s
->
¥iv
 <
PRV_S
) {

1355 i‡(
ˇu£
 & 
CAUSE_INTERRUPT
)

1356 
dñeg
 = (
s
->
midñeg
 >> (
ˇu£
 & (
MAX_XLEN
 - 1))) & 1;

1358 
dñeg
 = (
s
->
medñeg
 >> 
ˇu£
) & 1;

1360 
dñeg
 = 0;

1363 
ˇu£l
 = 
ˇu£
 & 0x7fffffff;

1364 i‡(
ˇu£
 & 
CAUSE_INTERRUPT
)

1365 
ˇu£l
 |(
èrgë_ul⁄g
)1 << (
s
->
cur_xÀn
 - 1);

1367 i‡(
dñeg
) {

1368 
s
->
sˇu£
 = 
ˇu£l
;

1369 
s
->
£pc
 = s->
pc
;

1370 
s
->
°vÆ
 = 
tvÆ
;

1371 
s
->
m°©us
 = (s->m°©u†& ~
MSTATUS_SPIE
) |

1372 (((
s
->
m°©us
 >> s->
¥iv
Ë& 1Ë<< 
MSTATUS_SPIE_SHIFT
);

1373 
s
->
m°©us
 = (s->m°©u†& ~
MSTATUS_SPP
) |

1374 (
s
->
¥iv
 << 
MSTATUS_SPP_SHIFT
);

1375 
s
->
m°©us
 &~
MSTATUS_SIE
;

1376 
	`£t_¥iv
(
s
, 
PRV_S
);

1377 
s
->
pc
 = s->
°vec
;

1379 
s
->
mˇu£
 = 
ˇu£l
;

1380 
s
->
mïc
 = s->
pc
;

1381 
s
->
mtvÆ
 = 
tvÆ
;

1382 
s
->
m°©us
 = (s->m°©u†& ~
MSTATUS_MPIE
) |

1383 (((
s
->
m°©us
 >> s->
¥iv
Ë& 1Ë<< 
MSTATUS_MPIE_SHIFT
);

1384 
s
->
m°©us
 = (s->m°©u†& ~
MSTATUS_MPP
) |

1385 (
s
->
¥iv
 << 
MSTATUS_MPP_SHIFT
);

1386 
s
->
m°©us
 &~
MSTATUS_MIE
;

1387 
	`£t_¥iv
(
s
, 
PRV_M
);

1388 
s
->
pc
 = s->
mtvec
;

1390 
	}
}

1392 
	$øi£_ex˚±i⁄
(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
ˇu£
)

1394 
	`øi£_ex˚±i⁄2
(
s
, 
ˇu£
, 0);

1395 
	}
}

1397 
	$h™dÀ_§ë
(
RISCVCPUSèã
 *
s
)

1399 
•p
, 
•õ
;

1400 
•p
 = (
s
->
m°©us
 >> 
MSTATUS_SPP_SHIFT
) & 1;

1402 
•õ
 = (
s
->
m°©us
 >> 
MSTATUS_SPIE_SHIFT
) & 1;

1403 
s
->
m°©us
 = (s->m°©u†& ~(1 << 
•p
)) |

1404 (
•õ
 << 
•p
);

1406 
s
->
m°©us
 |
MSTATUS_SPIE
;

1408 
s
->
m°©us
 &~
MSTATUS_SPP
;

1409 
	`£t_¥iv
(
s
, 
•p
);

1410 
s
->
pc
 = s->
£pc
;

1411 
	}
}

1413 
	$h™dÀ_mªt
(
RISCVCPUSèã
 *
s
)

1415 
mµ
, 
mpõ
;

1416 
mµ
 = (
s
->
m°©us
 >> 
MSTATUS_MPP_SHIFT
) & 3;

1418 
mpõ
 = (
s
->
m°©us
 >> 
MSTATUS_MPIE_SHIFT
) & 1;

1419 
s
->
m°©us
 = (s->m°©u†& ~(1 << 
mµ
)) |

1420 (
mpõ
 << 
mµ
);

1422 
s
->
m°©us
 |
MSTATUS_MPIE
;

1424 
s
->
m°©us
 &~
MSTATUS_MPP
;

1425 
	`£t_¥iv
(
s
, 
mµ
);

1426 
s
->
pc
 = s->
mïc
;

1427 
	}
}

1429 
ölöe
 
uöt32_t
 
	$gë_≥ndög_úq_mask
(
RISCVCPUSèã
 *
s
)

1431 
uöt32_t
 
≥ndög_öts
, 
íabÀd_öts
;

1433 
≥ndög_öts
 = 
s
->
mù
 & s->
mõ
;

1434 i‡(
≥ndög_öts
 == 0)

1437 
íabÀd_öts
 = 0;

1438 
s
->
¥iv
) {

1439 
PRV_M
:

1440 i‡(
s
->
m°©us
 & 
MSTATUS_MIE
)

1441 
íabÀd_öts
 = ~
s
->
midñeg
;

1443 
PRV_S
:

1444 
íabÀd_öts
 = ~
s
->
midñeg
;

1445 i‡(
s
->
m°©us
 & 
MSTATUS_SIE
)

1446 
íabÀd_öts
 |
s
->
midñeg
;

1449 
PRV_U
:

1450 
íabÀd_öts
 = -1;

1453  
≥ndög_öts
 & 
íabÀd_öts
;

1454 
	}
}

1456 
__ex˚±i⁄
 
	$øi£_öãºu±
(
RISCVCPUSèã
 *
s
)

1458 
uöt32_t
 
mask
;

1459 
úq_num
;

1461 
mask
 = 
	`gë_≥ndög_úq_mask
(
s
);

1462 i‡(
mask
 == 0)

1464 
úq_num
 = 
	`˘z32
(
mask
);

1465 i‡(
s
->
simuœti⁄
){

1466 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
öãºu±s
;

1468 
	`øi£_ex˚±i⁄
(
s
, 
úq_num
 | 
CAUSE_INTERRUPT
);

1470 
	}
}

1472 
ölöe
 
öt32_t
 
	$£xt
(
öt32_t
 
vÆ
, 
n
)

1474  (
vÆ
 << (32 - 
n
)) >> (32 -Ç);

1475 
	}
}

1477 
ölöe
 
uöt32_t
 
	$gë_fõld1
(
uöt32_t
 
vÆ
, 
§c_pos
,

1478 
d°_pos
, 
d°_pos_max
)

1480 
mask
;

1481 
	`as£π
(
d°_pos_max
 >
d°_pos
);

1482 
mask
 = ((1 << (
d°_pos_max
 - 
d°_pos
 + 1)) - 1) << dst_pos;

1483 i‡(
d°_pos
 >
§c_pos
)

1484  (
vÆ
 << (
d°_pos
 - 
§c_pos
)Ë& 
mask
;

1486  (
vÆ
 >> (
§c_pos
 - 
d°_pos
)Ë& 
mask
;

1487 
	}
}

1489 
	#XLEN
 32

	)

1490 
	~"riscv_˝u_ãm∂©e.h
"

1492 #i‡
MAX_XLEN
 >= 64

1493 
	#XLEN
 64

	)

1494 
	~"riscv_˝u_ãm∂©e.h
"

1497 #i‡
MAX_XLEN
 >= 128

1498 
	#XLEN
 128

	)

1499 
	~"riscv_˝u_ãm∂©e.h
"

1502 
	$glue
(
riscv_˝u_öãΩ
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
, 
n_cy˛es
)

1504 #ifde‡
USE_GLOBAL_STATE


1505 
s
 = &
riscv_˝u_globÆ_°©e
;

1507 
uöt64_t
 
timeout
;

1509 
timeout
 = 
s
->
ö¢_cou¡î
 + 
n_cy˛es
;

1510 !
s
->
powî_down_Êag
 &&

1511 ()(
timeout
 - 
s
->
ö¢_cou¡î
) > 0) {

1512 
n_cy˛es
 = 
timeout
 - 
s
->
ö¢_cou¡î
;

1513 
s
->
cur_xÀn
) {

1515 
	`riscv_˝u_öãΩ_x32
(
s
, 
n_cy˛es
);

1517 #i‡
MAX_XLEN
 >= 64

1519 
	`riscv_˝u_öãΩ_x64
(
s
, 
n_cy˛es
);

1522 #i‡
MAX_XLEN
 >= 128

1524 
	`riscv_˝u_öãΩ_x128
(
s
, 
n_cy˛es
);

1528 
	`ab‹t
();

1531 
	}
}

1534 
uöt64_t
 
	$glue
(
riscv_˝u_gë_cy˛es
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
)

1536  
s
->
ö¢_cou¡î
;

1537 
	}
}

1539 
	$glue
(
riscv_˝u_£t_mù
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
mask
)

1541 
s
->
mù
 |
mask
;

1543 i‡(
s
->
powî_down_Êag
 && (s->
mù
 & s->
mõ
) != 0)

1544 
s
->
powî_down_Êag
 = 
FALSE
;

1545 
	}
}

1547 
	$glue
(
riscv_˝u_ª£t_mù
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
mask
)

1549 
s
->
mù
 &~
mask
;

1550 
	}
}

1552 
uöt32_t
 
	$glue
(
riscv_˝u_gë_mù
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
)

1554  
s
->
mù
;

1555 
	}
}

1557 
BOOL
 
	$glue
(
riscv_˝u_gë_powî_down
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
)

1559  
s
->
powî_down_Êag
;

1560 
	}
}

1562 
RISCVCPUSèã
 *
	$glue
(
riscv_˝u_öô
, 
MAX_XLEN
)(
PhysMem‹yM≠
 *
mem_m≠
, c⁄° 
SimP¨ams
 *
p
)

1564 
RISCVCPUSèã
 *
s
;

1566 #ifde‡
USE_GLOBAL_STATE


1567 
s
 = &
riscv_˝u_globÆ_°©e
;

1569 
s
 = 
	`mÆlocz
((*s));

1571 
s
->
comm⁄
.
˛ass_±r
 = &
	`glue
(
riscv_˝u_˛ass
, 
MAX_XLEN
);

1572 
s
->
sim_∑øms
 = (
SimP¨ams
 *)
p
;

1573 
s
->
mem_m≠
 = mem_map;

1574 
s
->
pc
 = 0x1000;

1575 
s
->
¥iv
 = 
PRV_M
;

1576 
s
->
cur_xÀn
 = 
MAX_XLEN
;

1577 
s
->
mxl
 = 
	`gë_ba£_‰om_xÀn
(
MAX_XLEN
);

1578 
s
->
m°©us
 = ((
uöt64_t
)s->
mxl
 << 
MSTATUS_UXL_SHIFT
) |

1579 ((
uöt64_t
)
s
->
mxl
 << 
MSTATUS_SXL_SHIFT
);

1580 
s
->
miß
 |
MCPUID_SUPER
 | 
MCPUID_USER
 | 
MCPUID_I
 | 
MCPUID_M
 | 
MCPUID_A
;

1581 #i‡
FLEN
 >= 32

1582 
s
->
miß
 |
MCPUID_F
;

1584 #i‡
FLEN
 >= 64

1585 
s
->
miß
 |
MCPUID_D
;

1587 #i‡
FLEN
 >= 128

1588 
s
->
miß
 |
MCPUID_Q
;

1590 #ifde‡
CONFIG_EXT_C


1591 
s
->
miß
 |
MCPUID_C
;

1594 
s
->
éb_code
 = (
TLBE¡ry
*Ë
	`mÆloc
((TLBE¡ryË* s->
sim_∑øms
->
éb_size
);

1595 
s
->
éb_ªad
 = (
TLBE¡ry
*Ë
	`mÆloc
((TLBE¡ryË* s->
sim_∑øms
->
éb_size
);

1596 
s
->
éb_wrôe
 = (
TLBE¡ry
*Ë
	`mÆloc
((TLBE¡ryË* s->
sim_∑øms
->
éb_size
);

1597 
	`as£π
(
s
->
éb_code
);

1598 
	`as£π
(
s
->
éb_ªad
);

1599 
	`as£π
(
s
->
éb_wrôe
);

1601 
	`éb_öô
(
s
);

1603 
s
->
sim˝u
 = 
	`riscv_sim_˝u_öô
(s->
sim_∑øms
, s);

1606 i‡(
p
->
íabÀ_°©s_di•œy
) {

1607 
s
->
°©s_shm_fd
 =

1608 
	`shm_›í
(
MARSS_STATS_SHM_NAME
, 
O_RDWR
 | 
O_CREAT
, 
ALL_RW_PERMS
);

1609 i‡(
s
->
°©s_shm_fd
 < 0) {

1610 
	`Ârötf
(
°dîr
, "error: cannot create marss-stats-shm %s,Åerminating\n",

1611 
MARSS_STATS_SHM_NAME
);

1612 
	`exô
(1);

1615 i‡(
	`·runˇã
(
s
->
°©s_shm_fd
, 
NUM_MAX_PRV_LEVELS
 * (
SimSèts
)) < 0) {

1616 
	`Ârötf
(
°dîr
, "error: cannotÑesize marss-stats-shm %s,Åerminating\n",

1617 
MARSS_STATS_SHM_NAME
);

1618 
	`˛o£
(
s
->
°©s_shm_fd
);

1619 
	`exô
(1);

1622 
s
->
°©s_shm_±r
 = 
NULL
;

1623 i‡((
s
->
°©s_shm_±r
 = (
SimSèts
*)
	`mm≠
(
NULL
, 
NUM_MAX_PRV_LEVELS
 * (SimSèts), 
PROT_READ
 | 
PROT_WRITE
,

1624 
MAP_SHARED
, 
s
->
°©s_shm_fd
, 0)) ==

1625 
MAP_FAILED
) {

1626 
	`Ârötf
(
°dîr
, "îr‹: c™nŸ mm≠ shm %s,Åîmö©ög", 
MARSS_STATS_SHM_NAME
);

1627 
	`˛o£
(
s
->
°©s_shm_fd
);

1628 
	`exô
(1);

1631 
	`mem£t
(
s
->
°©s_shm_±r
, 0, 
NUM_MAX_PRV_LEVELS
 * (
SimSèts
));

1633 
s
->
sim_ïc_°r
[0] = '\0';

1634 
s
->
°¨t_simuœti⁄
 = 
p
->
°¨t_ö_sim
;

1635 
s
->
simuœti⁄
 = 0;

1636 
s
->
ªtu∫_to_sim
 = 0;

1637 
s
->
°›_simuœti⁄
 = 0;

1638  
s
;

1639 
	}
}

1641 
	$glue
(
riscv_˝u_íd
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
)

1643 
	`‰ì
(
s
->
éb_code
);

1644 
	`‰ì
(
s
->
éb_ªad
);

1645 
	`‰ì
(
s
->
éb_wrôe
);

1646 
	`riscv_sim_˝u_‰ì
(&
s
->
sim˝u
);

1647 
	`‰ì
(
s
);

1648 
	}
}

1650 
uöt32_t
 
	$glue
(
riscv_˝u_gë_miß
, 
MAX_XLEN
)(
RISCVCPUSèã
 *
s
)

1652  
s
->
miß
;

1653 
	}
}

1655 c⁄° 
RISCVCPUCœss
 
glue
(
riscv_˝u_˛ass
, 
MAX_XLEN
) = {

1656 
glue
(
riscv_˝u_öô
, 
MAX_XLEN
),

1657 
glue
(
riscv_˝u_íd
, 
MAX_XLEN
),

1658 
glue
(
riscv_˝u_öãΩ
, 
MAX_XLEN
),

1659 
glue
(
riscv_˝u_gë_cy˛es
, 
MAX_XLEN
),

1660 
glue
(
riscv_˝u_£t_mù
, 
MAX_XLEN
),

1661 
glue
(
riscv_˝u_ª£t_mù
, 
MAX_XLEN
),

1662 
glue
(
riscv_˝u_gë_mù
, 
MAX_XLEN
),

1663 
glue
(
riscv_˝u_gë_powî_down
, 
MAX_XLEN
),

1664 
glue
(
riscv_˝u_gë_miß
, 
MAX_XLEN
),

1665 
glue
(
riscv_˝u_Êush_éb_wrôe_ønge_øm
, 
MAX_XLEN
),

1669 
RISCVCPUSèã
 *
	$riscv_˝u_öô
(
PhysMem‹yM≠
 *
mem_m≠
, 
max_xÀn
, c⁄° 
SimP¨ams
 *
p
)

1671 c⁄° 
RISCVCPUCœss
 *
c
;

1672 
max_xÀn
) {

1674 #i‡
	`deföed
(
EMSCRIPTEN
)

1675 
MAX_XLEN
:

1676 
c
 = &
	`glue
(
riscv_˝u_˛ass
, 
MAX_XLEN
);

1679 #i‡
MAX_XLEN
 == 32

1681 
c
 = &
riscv_˝u_˛ass32
;

1684 #i‡
MAX_XLEN
 == 64

1686 
c
 = &
riscv_˝u_˛ass64
;

1689 #i‡
CONFIG_RISCV_MAX_XLEN
 == 128

1691 
c
 = &
riscv_˝u_˛ass128
;

1696  
NULL
;

1698  
c
->
	`riscv_˝u_öô
(
mem_m≠
, 
p
);

1699 
	}
}

1703 
	$swôch_to_˝u_simuœti⁄
(
RISCVCPUSèã
* 
s
)

1705 
s
->
sim_ex˚±i⁄
 = 0;

1706 
	`riscv_sim_˝u_ª£t
(
s
->
sim˝u
);

1707  
	`riscv_sim_˝u_run
(
s
->
sim˝u
);

1708 
	}
}

	@riscv_cpu.h

32 #i‚de‡
RISCV_CPU_H


33 
	#RISCV_CPU_H


	)

35 
	~<°dlib.h
>

36 
	~"cutûs.h
"

37 
	~"iomem.h
"

38 
	~"riscvsim/sim_∑øms_°©s.h
"

40 
	#MIP_USIP
 (1 << 0)

	)

41 
	#MIP_SSIP
 (1 << 1)

	)

42 
	#MIP_HSIP
 (1 << 2)

	)

43 
	#MIP_MSIP
 (1 << 3)

	)

44 
	#MIP_UTIP
 (1 << 4)

	)

45 
	#MIP_STIP
 (1 << 5)

	)

46 
	#MIP_HTIP
 (1 << 6)

	)

47 
	#MIP_MTIP
 (1 << 7)

	)

48 
	#MIP_UEIP
 (1 << 8)

	)

49 
	#MIP_SEIP
 (1 << 9)

	)

50 
	#MIP_HEIP
 (1 << 10)

	)

51 
	#MIP_MEIP
 (1 << 11)

	)

53 
RISCVCPUSèã
 
	tRISCVCPUSèã
;

56 
	mRISCVCPUSèã
 *(*
	mriscv_˝u_öô
)(
PhysMem‹yM≠
 *
	mmem_m≠
, c⁄° 
SimP¨ams
 *
	mp
);

57 (*
	mriscv_˝u_íd
)(
RISCVCPUSèã
 *
	ms
);

58 (*
	mriscv_˝u_öãΩ
)(
RISCVCPUSèã
 *
	ms
, 
	mn_cy˛es
);

59 
uöt64_t
 (*
riscv_˝u_gë_cy˛es
)(
RISCVCPUSèã
 *
	ms
);

60 (*
	mriscv_˝u_£t_mù
)(
RISCVCPUSèã
 *
	ms
, 
uöt32_t
 
	mmask
);

61 (*
	mriscv_˝u_ª£t_mù
)(
RISCVCPUSèã
 *
	ms
, 
uöt32_t
 
	mmask
);

62 
uöt32_t
 (*
riscv_˝u_gë_mù
)(
RISCVCPUSèã
 *
	ms
);

63 
BOOL
 (*
riscv_˝u_gë_powî_down
)(
RISCVCPUSèã
 *
	ms
);

64 
uöt32_t
 (*
riscv_˝u_gë_miß
)(
RISCVCPUSèã
 *
	ms
);

65 (*
	mriscv_˝u_Êush_éb_wrôe_ønge_øm
)(
RISCVCPUSèã
 *
	ms
,

66 
uöt8_t
 *
	møm_±r
, 
size_t
 
	møm_size
);

67 } 
	tRISCVCPUCœss
;

70 c⁄° 
RISCVCPUCœss
 *
	m˛ass_±r
;

71 } 
	tRISCVCPUComm⁄Sèã
;

73 
ª£t_simuœti⁄_°©s
(
RISCVCPUSèã
 *
s
);

74 
swôch_to_˝u_simuœti⁄
(
RISCVCPUSèã
 *
s
);

75 
riscv_˝u_gë_max_xÀn
();

77 c⁄° 
RISCVCPUCœss
 
riscv_˝u_˛ass32
;

78 c⁄° 
RISCVCPUCœss
 
riscv_˝u_˛ass64
;

79 c⁄° 
RISCVCPUCœss
 
riscv_˝u_˛ass128
;

81 
RISCVCPUSèã
 *
riscv_˝u_öô
(
PhysMem‹yM≠
 *
mem_m≠
, 
max_xÀn
, c⁄° 
SimP¨ams
 *
sim_∑øms
);

82 
ölöe
 
	$riscv_˝u_íd
(
RISCVCPUSèã
 *
s
)

84 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

85 
c
->
	`riscv_˝u_íd
(
s
);

86 
	}
}

87 
ölöe
 
	$riscv_˝u_öãΩ
(
RISCVCPUSèã
 *
s
, 
n_cy˛es
)

89 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

90 
c
->
	`riscv_˝u_öãΩ
(
s
, 
n_cy˛es
);

91 
	}
}

92 
ölöe
 
uöt64_t
 
	$riscv_˝u_gë_cy˛es
(
RISCVCPUSèã
 *
s
)

94 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

95  
c
->
	`riscv_˝u_gë_cy˛es
(
s
);

96 
	}
}

97 
ölöe
 
	$riscv_˝u_£t_mù
(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
mask
)

99 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

100 
c
->
	`riscv_˝u_£t_mù
(
s
, 
mask
);

101 
	}
}

102 
ölöe
 
	$riscv_˝u_ª£t_mù
(
RISCVCPUSèã
 *
s
, 
uöt32_t
 
mask
)

104 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

105 
c
->
	`riscv_˝u_ª£t_mù
(
s
, 
mask
);

106 
	}
}

107 
ölöe
 
uöt32_t
 
	$riscv_˝u_gë_mù
(
RISCVCPUSèã
 *
s
)

109 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

110  
c
->
	`riscv_˝u_gë_mù
(
s
);

111 
	}
}

112 
ölöe
 
BOOL
 
	$riscv_˝u_gë_powî_down
(
RISCVCPUSèã
 *
s
)

114 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

115  
c
->
	`riscv_˝u_gë_powî_down
(
s
);

116 
	}
}

117 
ölöe
 
uöt32_t
 
	$riscv_˝u_gë_miß
(
RISCVCPUSèã
 *
s
)

119 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

120  
c
->
	`riscv_˝u_gë_miß
(
s
);

121 
	}
}

122 
ölöe
 
	$riscv_˝u_Êush_éb_wrôe_ønge_øm
(
RISCVCPUSèã
 *
s
,

123 
uöt8_t
 *
øm_±r
, 
size_t
 
øm_size
)

125 c⁄° 
RISCVCPUCœss
 *
c
 = ((
RISCVCPUComm⁄Sèã
 *)
s
)->
˛ass_±r
;

126 
c
->
	`riscv_˝u_Êush_éb_wrôe_ønge_øm
(
s
, 
øm_±r
, 
øm_size
);

127 
	}
}

	@riscv_cpu_fp_template.h

24 #i‡
F_SIZE
 == 32

25 
	#OPID
 0

	)

26 
	#F_HIGH
 
F32_HIGH


	)

27 #ñi‡
F_SIZE
 == 64

28 
	#OPID
 1

	)

29 
	#F_HIGH
 
F64_HIGH


	)

30 #ñi‡
F_SIZE
 == 128

31 
	#OPID
 3

	)

32 
	#F_HIGH
 0

	)

34 #îr‹ 
unsuµ‹ãd
 
F_SIZE


37 
	#FSIGN_MASK
 
	`glue
(
FSIGN_MASK
, 
F_SIZE
)

	)

39 (0x00 << 2Ë| 
	gOPID
:

40 
rm
 = 
gë_ö¢_rm
(
s
,Ñm);

41 i‡(
	grm
 < 0)

42 
	gûÀgÆ_ö¢
;

43 
	gs
->
	gÂ_ªg
[
rd
] = 
	$glue
(
add_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
],

44 
s
->
Â_ªg
[
rs2
],

45 
rm
, &
s
->
fÊags
Ë| 
F_HIGH
;

46 
s
->
fs
 = 3;

48 (0x01 << 2Ë| 
OPID
:

49 
rm
 = 
	`gë_ö¢_rm
(
s
,Ñm);

50 i‡(
rm
 < 0)

51 
ûÀgÆ_ö¢
;

52 
s
->
Â_ªg
[
rd
] = 
	$glue
(
sub_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
],

53 
s
->
Â_ªg
[
rs2
],

54 
rm
, &
s
->
fÊags
Ë| 
F_HIGH
;

55 
s
->
fs
 = 3;

57 (0x02 << 2Ë| 
OPID
:

58 
rm
 = 
	`gë_ö¢_rm
(
s
,Ñm);

59 i‡(
rm
 < 0)

60 
ûÀgÆ_ö¢
;

61 
s
->
Â_ªg
[
rd
] = 
	$glue
(
mul_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
],

62 
s
->
Â_ªg
[
rs2
],

63 
rm
, &
s
->
fÊags
Ë| 
F_HIGH
;

64 
s
->
fs
 = 3;

66 (0x03 << 2Ë| 
OPID
:

67 
rm
 = 
	`gë_ö¢_rm
(
s
,Ñm);

68 i‡(
rm
 < 0)

69 
ûÀgÆ_ö¢
;

70 
s
->
Â_ªg
[
rd
] = 
	$glue
(
div_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
],

71 
s
->
Â_ªg
[
rs2
],

72 
rm
, &
s
->
fÊags
Ë| 
F_HIGH
;

73 
s
->
fs
 = 3;

75 (0x0b << 2Ë| 
OPID
:

76 
rm
 = 
	`gë_ö¢_rm
(
s
,Ñm);

77 i‡(
rm
 < 0 || 
rs2
 != 0)

78 
ûÀgÆ_ö¢
;

79 
s
->
Â_ªg
[
rd
] = 
	$glue
(
sqπ_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
],

80 
rm
, &
s
->
fÊags
Ë| 
F_HIGH
;

81 
s
->
fs
 = 3;

83 (0x04 << 2Ë| 
OPID
:

84 
rm
) {

86 
s
->
Â_ªg
[
rd
] = (s->Â_ªg[
rs1
] & ~
FSIGN_MASK
) |

87 (
s
->
Â_ªg
[
rs2
] & 
FSIGN_MASK
);

90 
s
->
Â_ªg
[
rd
] = (s->Â_ªg[
rs1
] & ~
FSIGN_MASK
) |

91 ((
s
->
Â_ªg
[
rs2
] & 
FSIGN_MASK
) ^ FSIGN_MASK);

94 
s
->
Â_ªg
[
rd
] = s->Â_ªg[
rs1
] ^

95 (
s
->
Â_ªg
[
rs2
] & 
FSIGN_MASK
);

98 
ûÀgÆ_ö¢
;

99 
	}
}

100 
	gs
->
	gfs
 = 3;

102 (0x05 << 2Ë| 
	gOPID
:

103 
rm
) {

105 
s
->
Â_ªg
[
rd
] = 
	`glue
(
mö_sf
, 
F_SIZE
)(s->Â_ªg[
rs1
],

106 
s
->
Â_ªg
[
rs2
],

107 &
s
->
fÊags
,

108 
FMINMAX_IEEE754_201X
Ë| 
F_HIGH
;

111 
s
->
Â_ªg
[
rd
] = 
	`glue
(
max_sf
, 
F_SIZE
)(s->Â_ªg[
rs1
],

112 
s
->
Â_ªg
[
rs2
],

113 &
s
->
fÊags
,

114 
FMINMAX_IEEE754_201X
Ë| 
F_HIGH
;

117 
ûÀgÆ_ö¢
;

118 
	}
}

119 
	gs
->
	gfs
 = 3;

121 (0x18 << 2Ë| 
	gOPID
:

122 
rm
 = 
gë_ö¢_rm
(
s
,Ñm);

123 i‡(
	grm
 < 0)

124 
	gûÀgÆ_ö¢
;

125 
rs2
) {

127 
vÆ
 = (
öt32_t
)
	`glue
(glue(
cvt_sf
, 
F_SIZE
), 
_i32
)(
s
->
Â_ªg
[
rs1
], 
rm
,

128 &
s
->
fÊags
);

131 
vÆ
 = (
öt32_t
)
	`glue
(glue(
cvt_sf
, 
F_SIZE
), 
_u32
)(
s
->
Â_ªg
[
rs1
], 
rm
,

132 &
s
->
fÊags
);

134 #i‡
XLEN
 >= 64

136 
vÆ
 = (
öt64_t
)
	`glue
(glue(
cvt_sf
, 
F_SIZE
), 
_i64
)(
s
->
Â_ªg
[
rs1
], 
rm
,

137 &
s
->
fÊags
);

140 
vÆ
 = (
öt64_t
)
	`glue
(glue(
cvt_sf
, 
F_SIZE
), 
_u64
)(
s
->
Â_ªg
[
rs1
], 
rm
,

141 &
s
->
fÊags
);

144 #i‡
XLEN
 >= 128

147 
vÆ
 = 
	`glue
(glue(
cvt_sf
, 
F_SIZE
), 
_i128
)(
s
->
Â_ªg
[
rs1
], 
rm
,

148 &
s
->
fÊags
);

151 
vÆ
 = 
	`glue
(glue(
cvt_sf
, 
F_SIZE
), 
_u128
)(
s
->
Â_ªg
[
rs1
], 
rm
,

152 &
s
->
fÊags
);

156 
ûÀgÆ_ö¢
;

157 
	}
}

158 i‡(
	grd
 != 0)

159 
s
->
ªg
[
rd
] = 
vÆ
;

161 (0x14 << 2Ë| 
	gOPID
:

162 
rm
) {

164 
vÆ
 = 
	`glue
(
À_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
], s->Â_ªg[
rs2
],

165 &
s
->
fÊags
);

168 
vÆ
 = 
	`glue
(
…_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
], s->Â_ªg[
rs2
],

169 &
s
->
fÊags
);

172 
vÆ
 = 
	`glue
(
eq_quõt_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
], s->Â_ªg[
rs2
],

173 &
s
->
fÊags
);

176 
ûÀgÆ_ö¢
;

177 
	}
}

178 i‡(
	grd
 != 0)

179 
s
->
ªg
[
rd
] = 
vÆ
;

181 (0x1®<< 2Ë| 
	gOPID
:

182 
rm
 = 
gë_ö¢_rm
(
s
,Ñm);

183 i‡(
	grm
 < 0)

184 
	gûÀgÆ_ö¢
;

185 
rs2
) {

187 
s
->
Â_ªg
[
rd
] = 
	`glue
(
cvt_i32_sf
, 
F_SIZE
)(s->
ªg
[
rs1
], 
rm
,

188 &
s
->
fÊags
Ë| 
F_HIGH
;

191 
s
->
Â_ªg
[
rd
] = 
	`glue
(
cvt_u32_sf
, 
F_SIZE
)(s->
ªg
[
rs1
], 
rm
,

192 &
s
->
fÊags
Ë| 
F_HIGH
;

194 #i‡
XLEN
 >= 64

196 
s
->
Â_ªg
[
rd
] = 
	`glue
(
cvt_i64_sf
, 
F_SIZE
)(s->
ªg
[
rs1
], 
rm
,

197 &
s
->
fÊags
Ë| 
F_HIGH
;

200 
s
->
Â_ªg
[
rd
] = 
	`glue
(
cvt_u64_sf
, 
F_SIZE
)(s->
ªg
[
rs1
], 
rm
,

201 &
s
->
fÊags
Ë| 
F_HIGH
;

204 #i‡
XLEN
 >= 128

207 
s
->
Â_ªg
[
rd
] = 
	`glue
(
cvt_i128_sf
, 
F_SIZE
)(s->
ªg
[
rs1
], 
rm
,

208 &
s
->
fÊags
Ë| 
F_HIGH
;

211 
s
->
Â_ªg
[
rd
] = 
	`glue
(
cvt_u128_sf
, 
F_SIZE
)(s->
ªg
[
rs1
], 
rm
,

212 &
s
->
fÊags
Ë| 
F_HIGH
;

216 
ûÀgÆ_ö¢
;

217 
	}
}

218 
	gs
->
	gfs
 = 3;

221 (0x08 << 2Ë| 
	gOPID
:

222 
rm
 = 
gë_ö¢_rm
(
s
,Ñm);

223 i‡(
	grm
 < 0)

224 
	gûÀgÆ_ö¢
;

225 
rs2
) {

226 #i‡
F_SIZE
 =32 && 
FLEN
 >= 64

228 
s
->
Â_ªg
[
rd
] = 
	`cvt_sf64_sf32
(s->Â_ªg[
rs1
], 
rm
, &s->
fÊags
Ë| 
F32_HIGH
;

230 #i‡
FLEN
 >= 128

232 
s
->
Â_ªg
[
rd
] = 
	`cvt_sf128_sf32
(s->Â_ªg[
rs1
], 
rm
, &s->
fÊags
Ë| 
F32_HIGH
;

236 #i‡
F_SIZE
 == 64

238 
s
->
Â_ªg
[
rd
] = 
	`cvt_sf32_sf64
(s->Â_ªg[
rs1
], &s->
fÊags
Ë| 
F64_HIGH
;

240 #i‡
FLEN
 >= 128

242 
s
->
Â_ªg
[
rd
] = 
	`cvt_sf128_sf64
(s->Â_ªg[
rs1
], 
rm
, &s->
fÊags
Ë| 
F64_HIGH
;

246 #i‡
F_SIZE
 == 128

248 
s
->
Â_ªg
[
rd
] = 
	`cvt_sf32_sf128
(s->Â_ªg[
rs1
], &s->
fÊags
);

251 
s
->
Â_ªg
[
rd
] = 
	`cvt_sf64_sf128
(s->Â_ªg[
rs1
], &s->
fÊags
);

256 
ûÀgÆ_ö¢
;

257 
	}
}

258 
	gs
->
	gfs
 = 3;

261 (0x1¯<< 2Ë| 
	gOPID
:

262 i‡(
rs2
 != 0)

263 
ûÀgÆ_ö¢
;

264 
rm
) {

265 #i‡
F_SIZE
 <
XLEN


267 #i‡
F_SIZE
 == 32

268 
vÆ
 = (
öt32_t
)
s
->
Â_ªg
[
rs1
];

269 #ñi‡
F_SIZE
 == 64

270 
vÆ
 = (
öt64_t
)
s
->
Â_ªg
[
rs1
];

272 
vÆ
 = (
öt128_t
)
s
->
Â_ªg
[
rs1
];

277 
vÆ
 = 
	`glue
(
f˛ass_sf
, 
F_SIZE
)(
s
->
Â_ªg
[
rs1
]);

280 
ûÀgÆ_ö¢
;

281 
	}
}

282 i‡(
	grd
 != 0)

283 
s
->
ªg
[
rd
] = 
vÆ
;

286 #i‡
F_SIZE
 <
XLEN


287 (0x1ê<< 2Ë| 
	gOPID
:

288 i‡(
rs2
 !0 || 
rm
 != 0)

289 
ûÀgÆ_ö¢
;

290 #i‡
F_SIZE
 == 32

291 
	gs
->
	gÂ_ªg
[
rd
] = (
öt32_t
)
s
->
ªg
[
rs1
];

292 #ñi‡
F_SIZE
 == 64

293 
	gs
->
	gÂ_ªg
[
rd
] = (
öt64_t
)
s
->
ªg
[
rs1
];

295 
	gs
->
	gÂ_ªg
[
rd
] = (
öt128_t
)
s
->
ªg
[
rs1
];

297 
	gs
->
	gfs
 = 3;

301 #unde‡
F_SIZE


302 #unde‡
F_HIGH


303 #unde‡
OPID


304 #unde‡
FSIGN_MASK


	@riscv_cpu_priv.h

32 #i‚de‡
RISCV_CPU_PRIV_H


33 
	#RISCV_CPU_PRIV_H


	)

35 
	~<sys/time.h
>

36 
	~<î∫o.h
>

37 
	~<°dio.h
>

38 
	~<time.h
>

39 
	~"riscv_˝u.h
"

40 
	~"cutûs.h
"

41 
	~"riscvsim/sim_∑øms_°©s.h
"

42 
	~"riscvsim/riscv_sim_˝u.h
"

44 
	#__ex˚±i⁄
 
	`__©åibuã__
((
w¨n_unu£d_ªsu…
))

	)

46 
	#CONFIG_EXT_C


	)

48 #i‡
deföed
(
EMSCRIPTEN
)

49 
	#USE_GLOBAL_STATE


	)

51 
	#USE_GLOBAL_VARIABLES


	)

54 
	~"riscv_˝u_xÀn_ty≥defs.h
"

56 
	#CAUSE_MISALIGNED_FETCH
 0x0

	)

57 
	#CAUSE_FAULT_FETCH
 0x1

	)

58 
	#CAUSE_ILLEGAL_INSTRUCTION
 0x2

	)

59 
	#CAUSE_BREAKPOINT
 0x3

	)

60 
	#CAUSE_MISALIGNED_LOAD
 0x4

	)

61 
	#CAUSE_FAULT_LOAD
 0x5

	)

62 
	#CAUSE_MISALIGNED_STORE
 0x6

	)

63 
	#CAUSE_FAULT_STORE
 0x7

	)

64 
	#CAUSE_USER_ECALL
 0x8

	)

65 
	#CAUSE_SUPERVISOR_ECALL
 0x9

	)

66 
	#CAUSE_HYPERVISOR_ECALL
 0xa

	)

67 
	#CAUSE_MACHINE_ECALL
 0xb

	)

68 
	#CAUSE_FETCH_PAGE_FAULT
 0xc

	)

69 
	#CAUSE_LOAD_PAGE_FAULT
 0xd

	)

70 
	#CAUSE_STORE_PAGE_FAULT
 0xf

	)

73 
	#CAUSE_INTERRUPT
 ((
uöt32_t
)1 << 31)

	)

75 
	#PRV_U
 0

	)

76 
	#PRV_S
 1

	)

77 
	#PRV_H
 2

	)

78 
	#PRV_M
 3

	)

81 
	#MCPUID_SUPER
 (1 << ('S' - 'A'))

	)

82 
	#MCPUID_USER
 (1 << ('U' - 'A'))

	)

83 
	#MCPUID_I
 (1 << ('I' - 'A'))

	)

84 
	#MCPUID_M
 (1 << ('M' - 'A'))

	)

85 
	#MCPUID_A
 (1 << ('A' - 'A'))

	)

86 
	#MCPUID_F
 (1 << ('F' - 'A'))

	)

87 
	#MCPUID_D
 (1 << ('D' - 'A'))

	)

88 
	#MCPUID_Q
 (1 << ('Q' - 'A'))

	)

89 
	#MCPUID_C
 (1 << ('C' - 'A'))

	)

93 
	#MSTATUS_SPIE_SHIFT
 5

	)

94 
	#MSTATUS_MPIE_SHIFT
 7

	)

95 
	#MSTATUS_SPP_SHIFT
 8

	)

96 
	#MSTATUS_MPP_SHIFT
 11

	)

97 
	#MSTATUS_FS_SHIFT
 13

	)

98 
	#MSTATUS_UXL_SHIFT
 32

	)

99 
	#MSTATUS_SXL_SHIFT
 34

	)

101 
	#MSTATUS_UIE
 (1 << 0)

	)

102 
	#MSTATUS_SIE
 (1 << 1)

	)

103 
	#MSTATUS_HIE
 (1 << 2)

	)

104 
	#MSTATUS_MIE
 (1 << 3)

	)

105 
	#MSTATUS_UPIE
 (1 << 4)

	)

106 
	#MSTATUS_SPIE
 (1 << 
MSTATUS_SPIE_SHIFT
)

	)

107 
	#MSTATUS_HPIE
 (1 << 6)

	)

108 
	#MSTATUS_MPIE
 (1 << 
MSTATUS_MPIE_SHIFT
)

	)

109 
	#MSTATUS_SPP
 (1 << 
MSTATUS_SPP_SHIFT
)

	)

110 
	#MSTATUS_HPP
 (3 << 9)

	)

111 
	#MSTATUS_MPP
 (3 << 
MSTATUS_MPP_SHIFT
)

	)

112 
	#MSTATUS_FS
 (3 << 
MSTATUS_FS_SHIFT
)

	)

113 
	#MSTATUS_XS
 (3 << 15)

	)

114 
	#MSTATUS_MPRV
 (1 << 17)

	)

115 
	#MSTATUS_SUM
 (1 << 18)

	)

116 
	#MSTATUS_MXR
 (1 << 19)

	)

120 
	#MSTATUS_UXL_MASK
 ((
uöt64_t
)3 << 
MSTATUS_UXL_SHIFT
)

	)

121 
	#MSTATUS_SXL_MASK
 ((
uöt64_t
)3 << 
MSTATUS_SXL_SHIFT
)

	)

123 
	#PG_SHIFT
 12

	)

124 
	#PG_MASK
 ((1 << 
PG_SHIFT
Ë- 1)

	)

125 
	#TLB_SIZE
 (
s
->
sim_∑øms
->
éb_size
)

	)

127 
	#START_SIM_TIMER
(
°¨t
Ë
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &°¨t)

	)

128 
	#STOP_SIM_TIMER
(
íd
Ë
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &íd)

	)

129 
	#GET_SIM_TIMER_DIFF
(
°¨t
, 
íd
) \

130 (1000000000L * (
íd
.
tv_£c
 - 
°¨t
.tv_£cË+Énd.
tv_n£c
 - sèπ.tv_n£c)

	)

133 
èrgë_ul⁄g
 
	mvaddr
;

134 
uöçå_t
 
	mmem_addíd
;

135 
èrgë_ul⁄g
 
	mgue°_∑ddr
;

136 } 
	tTLBE¡ry
;

138 
	sRISCVCPUSèã
 {

139 
RISCVCPUComm⁄Sèã
 
	mcomm⁄
;

141 
èrgë_ul⁄g
 
	mpc
;

142 
èrgë_ul⁄g
 
	mªg
[32];

144 #ifde‡
USE_GLOBAL_VARIABLES


146 
uöt8_t
 *
	m__code_±r
, *
	m__code_íd
;

147 
èrgë_ul⁄g
 
	m__code_to_pc_addíd
;

150 #i‡
FLEN
 > 0

151 
Â_uöt
 
	mÂ_ªg
[32];

152 
uöt32_t
 
	mfÊags
;

153 
uöt8_t
 
	m‰m
;

156 
uöt8_t
 
	mcur_xÀn
;

157 
uöt8_t
 
	m¥iv
;

158 
uöt8_t
 
	mfs
;

159 
uöt8_t
 
	mmxl
;

161 
öt32_t
 
	mn_cy˛es
;

162 
uöt64_t
 
	mö¢_cou¡î
;

163 
BOOL
 
	mpowî_down_Êag
;

164 
	m≥ndög_ex˚±i⁄
;

165 
èrgë_ul⁄g
 
	m≥ndög_tvÆ
;

168 
èrgë_ul⁄g
 
	mm°©us
;

169 
èrgë_ul⁄g
 
	mmtvec
;

170 
èrgë_ul⁄g
 
	mms¸©ch
;

171 
èrgë_ul⁄g
 
	mmïc
;

172 
èrgë_ul⁄g
 
	mmˇu£
;

173 
èrgë_ul⁄g
 
	mmtvÆ
;

174 
èrgë_ul⁄g
 
	mmh¨tid
;

175 
uöt32_t
 
	mmiß
;

176 
uöt32_t
 
	mmõ
;

177 
uöt32_t
 
	mmù
;

178 
uöt32_t
 
	mmedñeg
;

179 
uöt32_t
 
	mmidñeg
;

180 
uöt32_t
 
	mmcou¡îí
;

182 
èrgë_ul⁄g
 
	m°vec
;

183 
èrgë_ul⁄g
 
	mss¸©ch
;

184 
èrgë_ul⁄g
 
	m£pc
;

185 
èrgë_ul⁄g
 
	msˇu£
;

186 
èrgë_ul⁄g
 
	m°vÆ
;

187 #i‡
MAX_XLEN
 == 32

188 
uöt32_t
 
	mßç
;

190 
uöt64_t
 
	mßç
;

192 
uöt32_t
 
	mscou¡îí
;

194 
èrgë_ul⁄g
 
	mlﬂd_ªs
;

196 
PhysMem‹yM≠
 *
	mmem_m≠
;

198 
TLBE¡ry
 *
	méb_ªad
;

199 
TLBE¡ry
 *
	méb_wrôe
;

200 
TLBE¡ry
 *
	méb_code
;

202 
öt32_t
 
	msim_n_cy˛es
;

204 
time•ec
 
	msim_°¨t
, 
	msim_íd
;

207 
uöt8_t
 *
	mcode_±r
, *
	mcode_íd
;

208 
èrgë_ul⁄g
 
	mcode_to_pc_addíd
;

212 
èrgë_ul⁄g
 
	mcode_gue°_∑ddr
;

213 
èrgë_ul⁄g
 
	md©a_gue°_∑ddr
;

214 
	mis_devi˚_io
;

216 
	mhw_pg_tb_wlk_œãncy
;

217 
	mhw_pg_tb_wlk_°age_id
;

218 
	mös_éb_lookup_accou¡ed
;

219 
	mös_éb_hô_accou¡ed
;

222 
RISCVSIMCPUSèã
 *
	msim˝u
;

224 
FILE
* 
	msim_åa˚
;

228 
	m°©s_shm_fd
;

229 
	m°©s_shm_«me
[256];

230 
SimSèts
 *
	m°©s_shm_±r
;

233 
	msim_ex˚±i⁄
;

234 
èrgë_ul⁄g
 
	msim_ïc
;

235 
	msim_ex˚±i⁄_ˇu£
;

236 
	msim_ex˚±i⁄_°age
;

237 
uöt32_t
 
	msim_ex˚±i⁄_ös
;

238 
	msim_ïc_°r
[
RISCV_INS_STR_MAX_LENGTH
];

241 
	m°¨t_simuœti⁄
;

242 
	m°›_simuœti⁄
;

243 
	msimuœti⁄
;

244 
	mªtu∫_to_sim
;

246 
SimP¨ams
 *
	msim_∑øms
;

247 } 
	tRISCVCPUSèã
;

250 
gë_ö¢_rm
(
RISCVCPUSèã
 *
s
, 
rm
);

252 
no_ölöe
 
__ex˚±i⁄
 

253 
èrgë_ªad_ö¢_¶ow
(
RISCVCPUSèã
 *
s
, 
uöt8_t
 **
µå
, 
èrgë_ul⁄g
 
addr
);

255 
__ex˚±i⁄
 
èrgë_ªad_ö¢_u16
(
RISCVCPUSèã
 *
s
, 
uöt16_t
 *
pö¢
,

256 
èrgë_ul⁄g
 
addr
);

258 
uöt32_t
 
gë_ö¢32
(
uöt8_t
 *
±r
);

260 
	#èrgë_ªad_¶ow
 
	`glue
(glue(
riscv
, 
MAX_XLEN
), 
_ªad_¶ow
)

	)

261 
	#èrgë_wrôe_¶ow
 
	`glue
(glue(
riscv
, 
MAX_XLEN
), 
_wrôe_¶ow
)

	)

263 
DLL_PUBLIC
 
èrgë_ªad_¶ow
(
RISCVCPUSèã
 *
s
, 
mem_uöt_t
 *
pvÆ
,

264 
èrgë_ul⁄g
 
addr
, 
size_log2
);

265 
DLL_PUBLIC
 
èrgë_wrôe_¶ow
(
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
addr
,

266 
mem_uöt_t
 
vÆ
, 
size_log2
);

269 
	#TARGET_READ_WRITE
(
size
, 
uöt_ty≥
, 
size_log2
) \

270 
ölöe
 
__ex˚±i⁄
 
èrgë_ªad_u
##
	`size
( \

271 
RISCVCPUSèã
 *
s
, 
uöt_ty≥
 *
pvÆ
, 
èrgë_ul⁄g
 
addr
) \

273 
uöt32_t
 
éb_idx
; \

275 
s
->
is_devi˚_io
 = 0; \

276 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1); \

277 i‡(
s
->
simuœti⁄
) \

279 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
lﬂd_éb_lookups
; \

281 i‡(
	`likñy
(
s
->
éb_ªad
[
éb_idx
].
vaddr
 \

282 =(
addr
 & ~(
PG_MASK
 & ~((
size
 / 8) - 1))))) \

284 *
pvÆ
 = *(
uöt_ty≥
 *)(
s
->
éb_ªad
[
éb_idx
].
mem_addíd
 \

285 + (
uöçå_t
)
addr
); \

286 i‡(
s
->
simuœti⁄
) \

288 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
lﬂd_éb_hôs
; \

293 
mem_uöt_t
 
vÆ
; \

294 
ªt
; \

295 
ªt
 = 
	`èrgë_ªad_¶ow
(
s
, &
vÆ
, 
addr
, 
size_log2
); \

296 i‡(
ªt
) \

297  
ªt
; \

298 *
pvÆ
 = 
vÆ
; \

301 i‡(!
s
->
is_devi˚_io
) \

303 
s
->
d©a_gue°_∑ddr
 = s->
éb_ªad
[
éb_idx
].
gue°_∑ddr
 \

304 + (
addr
 - 
s
->
éb_ªad
[
éb_idx
].
vaddr
); \

309 
ölöe
 
__ex˚±i⁄
 
èrgë_wrôe_u
##
	`size
( \

310 
RISCVCPUSèã
 *
s
, 
èrgë_ul⁄g
 
addr
, 
uöt_ty≥
 
vÆ
) \

312 
uöt32_t
 
éb_idx
; \

314 
s
->
is_devi˚_io
 = 0; \

315 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1); \

316 i‡(
s
->
simuœti⁄
) \

318 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
°‹e_éb_lookups
; \

320 i‡(
	`likñy
(
s
->
éb_wrôe
[
éb_idx
].
vaddr
 \

321 =(
addr
 & ~(
PG_MASK
 & ~((
size
 / 8) - 1))))) \

323 *(
uöt_ty≥
 *)(
s
->
éb_wrôe
[
éb_idx
].
mem_addíd
 + (
uöçå_t
)
addr
) \

324 
vÆ
; \

325 i‡(
s
->
simuœti⁄
) \

327 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
°‹e_éb_hôs
; \

332 
ªt
; \

333 
ªt
 = 
	`èrgë_wrôe_¶ow
(
s
, 
addr
, 
vÆ
, 
size_log2
); \

334 i‡(
ªt
) \

335  
ªt
; \

338 i‡(!
s
->
is_devi˚_io
) \

340 
s
->
d©a_gue°_∑ddr
 = s->
éb_wrôe
[
éb_idx
].
gue°_∑ddr
 \

341 + (
addr
 - 
s
->
éb_wrôe
[
éb_idx
].
vaddr
); \

344 }

	)

346 
	$TARGET_READ_WRITE
(8, 
uöt8_t
, 0)

347 
	$TARGET_READ_WRITE
(16, 
uöt16_t
, 1)

348 
	$TARGET_READ_WRITE
(32, 
uöt32_t
, 2)

349 #i‡
MLEN
 >= 64

350 
	$TARGET_READ_WRITE
(64, 
uöt64_t
, 3)

352 #i‡
MLEN
 >= 128

353 
	$TARGET_READ_WRITE
(128, 
uöt128_t
, 4)

	@riscv_cpu_template.h

32 #i‡
XLEN
 == 32

33 
	#uötx_t
 
uöt32_t


	)

34 
	#ötx_t
 
öt32_t


	)

35 #ñi‡
XLEN
 == 64

36 
	#uötx_t
 
uöt64_t


	)

37 
	#ötx_t
 
öt64_t


	)

38 #ñi‡
XLEN
 == 128

39 
	#uötx_t
 
uöt128_t


	)

40 
	#ötx_t
 
öt128_t


	)

42 #îr‹ 
unsuµ‹ãd
 
XLEN


45 
ölöe
 
ötx_t
 
	$glue
(
div
, 
XLEN
)(
ötx_t
 
a
, i¡x_à
b
)

47 i‡(
b
 == 0) {

49 } i‡(
a
 =((
ötx_t
)1 << (
XLEN
 - 1)Ë&& 
b
 == -1) {

50  
a
;

52  
a
 / 
b
;

54 
	}
}

56 
ölöe
 
uötx_t
 
	$glue
(
divu
, 
XLEN
)(
uötx_t
 
a
, uötx_à
b
)

58 i‡(
b
 == 0) {

61  
a
 / 
b
;

63 
	}
}

65 
ölöe
 
ötx_t
 
	$glue
(
ªm
, 
XLEN
)(
ötx_t
 
a
, i¡x_à
b
)

67 i‡(
b
 == 0) {

68  
a
;

69 } i‡(
a
 =((
ötx_t
)1 << (
XLEN
 - 1)Ë&& 
b
 == -1) {

72  
a
 % 
b
;

74 
	}
}

76 
ölöe
 
uötx_t
 
	$glue
(
ªmu
, 
XLEN
)(
uötx_t
 
a
, uötx_à
b
)

78 i‡(
b
 == 0) {

79  
a
;

81  
a
 % 
b
;

83 
	}
}

85 #i‡
XLEN
 == 32

87 
ölöe
 
uöt32_t
 
	$mulh32
(
öt32_t
 
a
, i¡32_à
b
)

89  ((
öt64_t
)
a
 * (öt64_t)
b
) >> 32;

90 
	}
}

92 
ölöe
 
uöt32_t
 
	$mulhsu32
(
öt32_t
 
a
, 
uöt32_t
 
b
)

94  ((
öt64_t
)
a
 * (öt64_t)
b
) >> 32;

95 
	}
}

97 
ölöe
 
uöt32_t
 
	$mulhu32
(
uöt32_t
 
a
, uöt32_à
b
)

99  ((
öt64_t
)
a
 * (öt64_t)
b
) >> 32;

100 
	}
}

102 #ñi‡
XLEN
 =64 && 
deföed
(
HAVE_INT128
)

104 
ölöe
 
uöt64_t
 
	$mulh64
(
öt64_t
 
a
, i¡64_à
b
)

106  ((
öt128_t
)
a
 * (öt128_t)
b
) >> 64;

107 
	}
}

109 
ölöe
 
uöt64_t
 
	$mulhsu64
(
öt64_t
 
a
, 
uöt64_t
 
b
)

111  ((
öt128_t
)
a
 * (öt128_t)
b
) >> 64;

112 
	}
}

114 
ölöe
 
uöt64_t
 
	$mulhu64
(
uöt64_t
 
a
, uöt64_à
b
)

116  ((
öt128_t
)
a
 * (öt128_t)
b
) >> 64;

117 
	}
}

121 #i‡
XLEN
 == 64

122 
	#UHALF
 
uöt32_t


	)

123 
	#UHALF_LEN
 32

	)

124 #ñi‡
XLEN
 == 128

125 
	#UHALF
 
uöt64_t


	)

126 
	#UHALF_LEN
 64

	)

128 #îr‹ 
unsuµ‹ãd
 
XLEN


131 
uötx_t
 
	$glue
(
mulhu
, 
XLEN
)(
uötx_t
 
a
, uötx_à
b
)

133 
UHALF
 
a0
, 
a1
, 
b0
, 
b1
, 
r2
, 
r3
;

134 
uötx_t
 
r00
, 
r01
, 
r10
, 
r11
, 
c
;

135 
a0
 = 
a
;

136 
a1
 = 
a
 >> 
UHALF_LEN
;

137 
b0
 = 
b
;

138 
b1
 = 
b
 >> 
UHALF_LEN
;

140 
r00
 = (
uötx_t
)
a0
 * (uötx_t)
b0
;

141 
r01
 = (
uötx_t
)
a0
 * (uötx_t)
b1
;

142 
r10
 = (
uötx_t
)
a1
 * (uötx_t)
b0
;

143 
r11
 = (
uötx_t
)
a1
 * (uötx_t)
b1
;

146 
c
 = (
r00
 >> 
UHALF_LEN
Ë+ (
UHALF
)
r01
 + (UHALF)
r10
;

148 
c
 = (¯>> 
UHALF_LEN
Ë+ (
r01
 >> UHALF_LENË+ (
r10
 >> UHALF_LENË+ (
UHALF
)
r11
;

149 
r2
 = 
c
;

150 
r3
 = (
c
 >> 
UHALF_LEN
Ë+ (
r11
 >> UHALF_LEN);

153  ((
uötx_t
)
r3
 << 
UHALF_LEN
Ë| 
r2
;

154 
	}
}

156 #unde‡
UHALF


158 
ölöe
 
uötx_t
 
	$glue
(
mulh
, 
XLEN
)(
ötx_t
 
a
, i¡x_à
b
)

160 
uötx_t
 
r1
;

161 
r1
 = 
	`glue
(
mulhu
, 
XLEN
)(
a
, 
b
);

162 i‡(
a
 < 0)

163 
r1
 -
a
;

164 i‡(
b
 < 0)

165 
r1
 -
b
;

166  
r1
;

167 
	}
}

169 
ölöe
 
uötx_t
 
	$glue
(
mulhsu
, 
XLEN
)(
ötx_t
 
a
, 
uötx_t
 
b
)

171 
uötx_t
 
r1
;

172 
r1
 = 
	`glue
(
mulhu
, 
XLEN
)(
a
, 
b
);

173 i‡(
a
 < 0)

174 
r1
 -
a
;

175  
r1
;

176 
	}
}

180 
	#DUP2
(
F
, 
n
Ë
	`F
“ËF“+1)

	)

181 
	#DUP4
(
F
, 
n
Ë
	`DUP2
(F,ÇËDUP2(F,Ç + 2)

	)

182 
	#DUP8
(
F
, 
n
Ë
	`DUP4
(F,ÇËDUP4(F,Ç + 4)

	)

183 
	#DUP16
(
F
, 
n
Ë
	`DUP8
(F,ÇËDUP8(F,Ç + 8)

	)

184 
	#DUP32
(
F
, 
n
Ë
	`DUP16
(F,ÇËDUP16(F,Ç + 16)

	)

186 
	#C_QUADRANT
(
n
) \

187 
n
+(0 << 2): n+(1 << 2): n+(2 << 2): n+(3 << 2): \

188 
n
+(4 << 2): n+(5 << 2): n+(6 << 2): n+(7 << 2): \

189 
n
+(8 << 2): n+(9 << 2): n+(10 << 2): n+(11 << 2): \

190 
n
+(12 << 2): n+(13 << 2): n+(14 << 2): n+(15 << 2): \

191 
n
+(16 << 2): n+(17 << 2): n+(18 << 2): n+(19 << 2): \

192 
n
+(20 << 2): n+(21 << 2): n+(22 << 2): n+(23 << 2): \

193 
n
+(24 << 2): n+(25 << 2): n+(26 << 2): n+(27 << 2): \

194 
n
+(28 << 2): n+(29 << 2): n+(30 << 2): n+(31 << 2):

	)

196 
	#GET_PC
(Ë(
èrgë_ul⁄g
)((
uöçå_t
)
code_±r
 + 
code_to_pc_addíd
)

	)

197 
	#GET_INSN_COUNTER
(Ë(
ö¢_cou¡î_addíd
 - 
s
->
n_cy˛es
)

	)

199 
	#C_NEXT_INSN
 
code_±r
 +2; 

	)

200 
	#NEXT_INSN
 
code_±r
 +4; 

	)

201 
	#JUMP_INSN
 do { \

202 
code_±r
 = 
NULL
; \

203 
code_íd
 = 
NULL
; \

204 
code_to_pc_addíd
 = 
s
->
pc
; \

205 
jump_ö¢
; \

206 } 0)

	)

208 
no_ölöe
 
	$glue
(
riscv_˝u_öãΩ_x
, 
XLEN
)(
RISCVCPUSèã
 *
s
,

209 
n_cy˛es1
)

211 
uöt32_t
 
›code
, 
ö¢
, 
rd
, 
rs1
, 
rs2
, 
fun˘3
;

212 
öt32_t
 
imm
, 
c⁄d
, 
îr
;

213 
run_mode
 = 0;

214 
sim_exô_°©us
;

215 
èrgë_ul⁄g
 
addr
, 
vÆ
, 
vÆ2
;

216 #i‚de‡
USE_GLOBAL_VARIABLES


217 
uöt8_t
 *
code_±r
, *
code_íd
;

218 
èrgë_ul⁄g
 
code_to_pc_addíd
;

220 
uöt64_t
 
ö¢_cou¡î_addíd
;

221 #i‡
FLEN
 > 0

222 
uöt32_t
 
rs3
;

223 
öt32_t
 
rm
;

226 i‡(
n_cy˛es1
 == 0)

228 
ö¢_cou¡î_addíd
 = 
s
->
ö¢_cou¡î
 + 
n_cy˛es1
;

229 
s
->
n_cy˛es
 = 
n_cy˛es1
;

232 i‡(
	`u∆ikñy
((
s
->
mù
 & s->
mõ
) != 0)) {

233 i‡(
	`øi£_öãºu±
(
s
)) {

234 
s
->
n_cy˛es
--;

235 
d⁄e_öãΩ
;

239 
s
->
≥ndög_ex˚±i⁄
 = -1;

241 
code_±r
 = 
NULL
;

242 
code_íd
 = 
NULL
;

243 
code_to_pc_addíd
 = 
s
->
pc
;

245 i‡(
s
->
°¨t_simuœti⁄
)

247 
s
->
simuœti⁄
 = 
TRUE
;

248 
s
->
°¨t_simuœti⁄
 = 
FALSE
;

249 
s
->
sim˝u
->
˛ock
 = 0;

252 
	`sim_°©s_ª£t
(
s
->
sim˝u
->
°©s
);

254 
	`START_SIM_TIMER
(
s
->
sim_°¨t
);

257 i‡(
s
->
sim_∑øms
->
íabÀ_bpu
)

259 
	`bpu_Êush
(
s
->
sim˝u
->
bpu
);

263 i‡(
s
->
sim_∑øms
->
íabÀ_l1_ˇches
)

265 
	`ª£t_ˇche_°©s
(
s
->
sim˝u
->
mmu
->
iˇche
);

266 
	`ª£t_ˇche_°©s
(
s
->
sim˝u
->
mmu
->
dˇche
);

268 i‡(
s
->
sim_∑øms
->
Êush_sim_mem
)

270 
	`ˇche_Êush
(
s
->
sim˝u
->
mmu
->
iˇche
);

271 
	`ˇche_Êush
(
s
->
sim˝u
->
mmu
->
dˇche
);

274 i‡(
s
->
sim_∑øms
->
íabÀ_l2_ˇche
)

276 
	`ª£t_ˇche_°©s
(
s
->
sim˝u
->
mmu
->
l2_ˇche
);

278 i‡(
s
->
sim_∑øms
->
Êush_sim_mem
)

280 
	`ˇche_Êush
(
s
->
sim˝u
->
mmu
->
l2_ˇche
);

286 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
mem_modñ_ty≥
)

288 
MEM_MODEL_BASE
:

292 
MEM_MODEL_DRAMSIM
:

294 
	`dømsim_wøµî_de°roy
();

295 
	`dømsim_wøµî_öô
(

296 
s
->
sim_∑øms
->
dømsim_öi_fûe
,

297 
s
->
sim_∑øms
->
dømsim_sy°em_öi_fûe
,

298 
s
->
sim_∑øms
->
dømsim_°©s_dú
, s->sim_∑øms->
c‹e_«me
,

299 
s
->
sim_∑øms
->
gue°_øm_size
,

300 &
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue
,

301 &
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
backíd_mem_ac˚ss_queue
);

307 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

309 
s
->
sim_åa˚
 = 
	`f›í
(s->
sim_∑øms
->
sim_åa˚_fûe
, "w");

310 
	`as£π
(
s
->
sim_åa˚
);

311 
s
->
sim_∑øms
->
¸óã_ös_°r
 = 
TRUE
;

314 
	`Ârötf
(
°dîr
, "(marss-riscv): SwitchingÅo full-system simulation "

315 "modê©Ö¯0x%" 
PR_èrgë_ul⁄g
 "\n",

316 
s
->
pc
);

319 i‡(
s
->
simuœti⁄
)

322 
s
->
code_±r
 = code_ptr;

323 
s
->
code_íd
 = code_end;

324 
s
->
code_to_pc_addíd
 = code_to_pc_addend;

325 
s
->
sim_n_cy˛es
 = s->
n_cy˛es
;

328 
sim_exô_°©us
 = 
	`swôch_to_˝u_simuœti⁄
(
s
);

331 
s
->
n_cy˛es
 = s->
sim_n_cy˛es
;

332 
code_±r
 = 
NULL
;

333 
code_íd
 = 
NULL
;

336 
code_to_pc_addíd
 = 
s
->
sim_ïc
;

341 
sim_exô_°©us
)

343 
SIM_ILLEGAL_OPCODE
:

346 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

348 
	`sim_¥öt_exp_åa˚
(
s
);

350 
ûÀgÆ_ö¢
;

354 
SIM_COMPLEX_OPCODE
:

358 
s
->
ªtu∫_to_sim
 = 1;

359 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_simuœãd
;

365 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_emuœãd
;

367 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

369 
	`sim_¥öt_exp_åa˚
(
s
);

374 
SIM_TIMEOUT_EXCEPTION
:

379 
	`as£π
(
s
->
n_cy˛es
 == 0);

380 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

382 
	`sim_¥öt_exp_åa˚
(
s
);

387 
SIM_MMU_EXCEPTION
:

389 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

391 
	`sim_¥öt_exp_åa˚
(
s
);

396 
mmu_ex˚±i⁄
;

400 
	`Ârötf
(
°dîr
, "%s\n", "InvalidÉxception cause");

401 
	`exô
(1);

408 i‡(
	`u∆ikñy
(
code_±r
 >
code_íd
)) {

409 
uöt32_t
 
éb_idx
;

410 
uöt16_t
 
ö¢_high
;

411 
èrgë_ul⁄g
 
addr
;

412 
uöt8_t
 *
±r
;

414 
s
->
pc
 = 
	`GET_PC
();

418 i‡(
	`u∆ikñy
(
s
->
n_cy˛es
 <= 0))

419 
the_íd
;

422 i‡(
	`u∆ikñy
((
s
->
mù
 & s->
mõ
) != 0)) {

423 i‡(
	`øi£_öãºu±
(
s
)) {

424 
s
->
n_cy˛es
--;

425 
the_íd
;

429 
addr
 = 
s
->
pc
;

430 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1);

431 i‡(
	`likñy
(
s
->
éb_code
[
éb_idx
].
vaddr
 =(
addr
 & ~
PG_MASK
))) {

433 
±r
 = (
uöt8_t
 *)(
s
->
éb_code
[
éb_idx
].
mem_addíd
 +

434 (
uöçå_t
)
addr
);

436 i‡(
	`u∆ikñy
(
	`èrgë_ªad_ö¢_¶ow
(
s
, &
±r
, 
addr
)))

437 
mmu_ex˚±i⁄
;

439 
code_±r
 = 
±r
;

440 
code_íd
 = 
±r
 + (
PG_MASK
 - 1 - (
addr
 & PG_MASK));

441 
code_to_pc_addíd
 = 
addr
 - (
uöçå_t
)
code_±r
;

442 i‡(
	`u∆ikñy
(
code_±r
 >
code_íd
)) {

445 
ö¢
 = *(
uöt16_t
 *)
code_±r
;

446 i‡((
ö¢
 & 3) == 3) {

448 i‡(
	`u∆ikñy
(
	`èrgë_ªad_ö¢_u16
(
s
, &
ö¢_high
, 
addr
 + 2)))

449 
mmu_ex˚±i⁄
;

450 
ö¢
 |
ö¢_high
 << 16;

453 
ö¢
 = 
	`gë_ö¢32
(
code_±r
);

457 
ö¢
 = 
	`gë_ö¢32
(
code_±r
);

459 
s
->
n_cy˛es
--;

462 #ifde‡
CONFIG_LOGFILE


463 
	`log_¥ötf
("pc=0x"); 
	`Âröt_èrgë_ul⁄g
(
log_fûe
, 
	`GET_PC
());Üog_¥ötf(" in¢=%08x\n", 
ö¢
);

464 
	`fÊush
(
log_fûe
);

466 
	`¥ötf
("pc=0x"); 
	`¥öt_èrgë_ul⁄g
(
	`GET_PC
());Örötf(" in¢=%08x\n", 
ö¢
);

471 
›code
 = 
ö¢
 & 0x7f;

472 
rd
 = (
ö¢
 >> 7) & 0x1f;

473 
rs1
 = (
ö¢
 >> 15) & 0x1f;

474 
rs2
 = (
ö¢
 >> 20) & 0x1f;

475 
›code
) {

476 #ifde‡
CONFIG_EXT_C


477 
	`C_QUADRANT
(0)

478 
fun˘3
 = (
ö¢
 >> 13) & 7;

479 
rd
 = ((
ö¢
 >> 2) & 7) | 8;

480 
fun˘3
) {

482 
imm
 = 
	`gë_fõld1
(
ö¢
, 11, 4, 5) |

483 
	`gë_fõld1
(
ö¢
, 7, 6, 9) |

484 
	`gë_fõld1
(
ö¢
, 6, 2, 2) |

485 
	`gë_fõld1
(
ö¢
, 5, 3, 3);

486 i‡(
imm
 == 0)

487 
ûÀgÆ_ö¢
;

488 
s
->
ªg
[
rd
] = (
ötx_t
)(s->ªg[2] + 
imm
);

490 #i‡
XLEN
 >= 128

492 
imm
 = 
	`gë_fõld1
(
ö¢
, 11, 4, 5) |

493 
	`gë_fõld1
(
ö¢
, 10, 8, 8) |

494 
	`gë_fõld1
(
ö¢
, 5, 6, 7);

495 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

496 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

497 i‡(
	`èrgë_ªad_u128
(
s
, &
vÆ
, 
addr
))

498 
mmu_ex˚±i⁄
;

499 
s
->
ªg
[
rd
] = 
vÆ
;

501 #ñi‡
FLEN
 >= 64

504 
uöt64_t
 
rvÆ
;

505 i‡(
s
->
fs
 == 0)

506 
ûÀgÆ_ö¢
;

507 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

508 
	`gë_fõld1
(
ö¢
, 5, 6, 7);

509 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

510 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

511 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

512 
mmu_ex˚±i⁄
;

513 
s
->
Â_ªg
[
rd
] = 
rvÆ
 | 
F64_HIGH
;

514 
s
->
fs
 = 3;

520 
uöt32_t
 
rvÆ
;

521 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

522 
	`gë_fõld1
(
ö¢
, 6, 2, 2) |

523 
	`gë_fõld1
(
ö¢
, 5, 6, 6);

524 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

525 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

526 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

527 
mmu_ex˚±i⁄
;

528 
s
->
ªg
[
rd
] = (
öt32_t
)
rvÆ
;

531 #i‡
XLEN
 >= 64

534 
uöt64_t
 
rvÆ
;

535 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

536 
	`gë_fõld1
(
ö¢
, 5, 6, 7);

537 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

538 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

539 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

540 
mmu_ex˚±i⁄
;

541 
s
->
ªg
[
rd
] = (
öt64_t
)
rvÆ
;

544 #ñi‡
FLEN
 >= 32

547 
uöt32_t
 
rvÆ
;

548 i‡(
s
->
fs
 == 0)

549 
ûÀgÆ_ö¢
;

550 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

551 
	`gë_fõld1
(
ö¢
, 6, 2, 2) |

552 
	`gë_fõld1
(
ö¢
, 5, 6, 6);

553 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

554 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

555 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

556 
mmu_ex˚±i⁄
;

557 
s
->
Â_ªg
[
rd
] = 
rvÆ
 | 
F32_HIGH
;

558 
s
->
fs
 = 3;

562 #i‡
XLEN
 >= 128

564 
imm
 = 
	`gë_fõld1
(
ö¢
, 11, 4, 5) |

565 
	`gë_fõld1
(
ö¢
, 10, 8, 8) |

566 
	`gë_fõld1
(
ö¢
, 5, 6, 7);

567 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

568 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

569 
vÆ
 = 
s
->
ªg
[
rd
];

570 i‡(
	`èrgë_wrôe_u128
(
s
, 
addr
, 
vÆ
))

571 
mmu_ex˚±i⁄
;

573 #ñi‡
FLEN
 >= 64

575 i‡(
s
->
fs
 == 0)

576 
ûÀgÆ_ö¢
;

577 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

578 
	`gë_fõld1
(
ö¢
, 5, 6, 7);

579 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

580 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

581 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, s->
Â_ªg
[
rd
]))

582 
mmu_ex˚±i⁄
;

586 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

587 
	`gë_fõld1
(
ö¢
, 6, 2, 2) |

588 
	`gë_fõld1
(
ö¢
, 5, 6, 6);

589 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

590 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

591 
vÆ
 = 
s
->
ªg
[
rd
];

592 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, 
vÆ
))

593 
mmu_ex˚±i⁄
;

595 #i‡
XLEN
 >= 64

597 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

598 
	`gë_fõld1
(
ö¢
, 5, 6, 7);

599 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

600 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

601 
vÆ
 = 
s
->
ªg
[
rd
];

602 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, 
vÆ
))

603 
mmu_ex˚±i⁄
;

605 #ñi‡
FLEN
 >= 32

607 i‡(
s
->
fs
 == 0)

608 
ûÀgÆ_ö¢
;

609 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

610 
	`gë_fõld1
(
ö¢
, 6, 2, 2) |

611 
	`gë_fõld1
(
ö¢
, 5, 6, 6);

612 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

613 
addr
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

614 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, s->
Â_ªg
[
rd
]))

615 
mmu_ex˚±i⁄
;

619 
ûÀgÆ_ö¢
;

621 
C_NEXT_INSN
;

622 
	`C_QUADRANT
(1)

623 
fun˘3
 = (
ö¢
 >> 13) & 7;

624 
fun˘3
) {

626 i‡(
rd
 != 0) {

627 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

628 
	`gë_fõld1
(
ö¢
, 2, 0, 4), 6);

629 
s
->
ªg
[
rd
] = (
ötx_t
)(s->ªg[rd] + 
imm
);

632 #i‡
XLEN
 == 32

634 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 11, 11) |

635 
	`gë_fõld1
(
ö¢
, 11, 4, 4) |

636 
	`gë_fõld1
(
ö¢
, 9, 8, 9) |

637 
	`gë_fõld1
(
ö¢
, 8, 10, 10) |

638 
	`gë_fõld1
(
ö¢
, 7, 6, 6) |

639 
	`gë_fõld1
(
ö¢
, 6, 7, 7) |

640 
	`gë_fõld1
(
ö¢
, 3, 1, 3) |

641 
	`gë_fõld1
(
ö¢
, 2, 5, 5), 12);

642 
s
->
ªg
[1] = 
	`GET_PC
() + 2;

643 
s
->
pc
 = (
ötx_t
)(
	`GET_PC
(Ë+ 
imm
);

644 
JUMP_INSN
;

647 i‡(
rd
 != 0) {

648 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

649 
	`gë_fõld1
(
ö¢
, 2, 0, 4), 6);

650 
s
->
ªg
[
rd
] = (
öt32_t
)(s->ªg[rd] + 
imm
);

655 i‡(
rd
 != 0) {

656 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

657 
	`gë_fõld1
(
ö¢
, 2, 0, 4), 6);

658 
s
->
ªg
[
rd
] = 
imm
;

662 i‡(
rd
 == 2) {

664 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 9, 9) |

665 
	`gë_fõld1
(
ö¢
, 6, 4, 4) |

666 
	`gë_fõld1
(
ö¢
, 5, 6, 6) |

667 
	`gë_fõld1
(
ö¢
, 3, 7, 8) |

668 
	`gë_fõld1
(
ö¢
, 2, 5, 5), 10);

669 i‡(
imm
 == 0)

670 
ûÀgÆ_ö¢
;

671 
s
->
ªg
[2] = (
ötx_t
)(s->ªg[2] + 
imm
);

672 } i‡(
rd
 != 0) {

674 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 17, 17) |

675 
	`gë_fõld1
(
ö¢
, 2, 12, 16), 18);

676 
s
->
ªg
[
rd
] = 
imm
;

680 
fun˘3
 = (
ö¢
 >> 10) & 3;

681 
rd
 = ((
ö¢
 >> 7) & 7) | 8;

682 
fun˘3
) {

685 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

686 
	`gë_fõld1
(
ö¢
, 2, 0, 4);

687 #i‡
XLEN
 == 32

688 i‡(
imm
 & 0x20)

689 
ûÀgÆ_ö¢
;

690 #ñi‡
XLEN
 == 128

691 i‡(
imm
 == 0)

692 
imm
 = 64;

693 i‡(
imm
 >= 32)

694 
imm
 = 128 - imm;

696 i‡(
fun˘3
 == 0)

697 
s
->
ªg
[
rd
] = (
ötx_t
)((
uötx_t
)s->ªg[rd] >> 
imm
);

699 
s
->
ªg
[
rd
] = (
ötx_t
)s->ªg[rd] >> 
imm
;

703 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

704 
	`gë_fõld1
(
ö¢
, 2, 0, 4), 6);

705 
s
->
ªg
[
rd
] &
imm
;

708 
rs2
 = ((
ö¢
 >> 2) & 7) | 8;

709 
fun˘3
 = ((
ö¢
 >> 5) & 3) | ((insn >> (12 - 2)) & 4);

710 
fun˘3
) {

712 
s
->
ªg
[
rd
] = (
ötx_t
)(s->ªg[rd] - s->ªg[
rs2
]);

715 
s
->
ªg
[
rd
] = s->ªg[rd] ^ s->ªg[
rs2
];

718 
s
->
ªg
[
rd
] = s->ªg[rd] | s->ªg[
rs2
];

721 
s
->
ªg
[
rd
] = s->ªg[rd] & s->ªg[
rs2
];

723 #i‡
XLEN
 >= 64

725 
s
->
ªg
[
rd
] = (
öt32_t
)(s->ªg[rd] - s->ªg[
rs2
]);

728 
s
->
ªg
[
rd
] = (
öt32_t
)(s->ªg[rd] + s->ªg[
rs2
]);

732 
ûÀgÆ_ö¢
;

738 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 11, 11) |

739 
	`gë_fõld1
(
ö¢
, 11, 4, 4) |

740 
	`gë_fõld1
(
ö¢
, 9, 8, 9) |

741 
	`gë_fõld1
(
ö¢
, 8, 10, 10) |

742 
	`gë_fõld1
(
ö¢
, 7, 6, 6) |

743 
	`gë_fõld1
(
ö¢
, 6, 7, 7) |

744 
	`gë_fõld1
(
ö¢
, 3, 1, 3) |

745 
	`gë_fõld1
(
ö¢
, 2, 5, 5), 12);

746 
s
->
pc
 = (
ötx_t
)(
	`GET_PC
(Ë+ 
imm
);

747 
JUMP_INSN
;

749 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

750 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 8, 8) |

751 
	`gë_fõld1
(
ö¢
, 10, 3, 4) |

752 
	`gë_fõld1
(
ö¢
, 5, 6, 7) |

753 
	`gë_fõld1
(
ö¢
, 3, 1, 2) |

754 
	`gë_fõld1
(
ö¢
, 2, 5, 5), 9);

755 i‡(
s
->
ªg
[
rs1
] == 0) {

756 
s
->
pc
 = (
ötx_t
)(
	`GET_PC
(Ë+ 
imm
);

757 
JUMP_INSN
;

761 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

762 
imm
 = 
	`£xt
(
	`gë_fõld1
(
ö¢
, 12, 8, 8) |

763 
	`gë_fõld1
(
ö¢
, 10, 3, 4) |

764 
	`gë_fõld1
(
ö¢
, 5, 6, 7) |

765 
	`gë_fõld1
(
ö¢
, 3, 1, 2) |

766 
	`gë_fõld1
(
ö¢
, 2, 5, 5), 9);

767 i‡(
s
->
ªg
[
rs1
] != 0) {

768 
s
->
pc
 = (
ötx_t
)(
	`GET_PC
(Ë+ 
imm
);

769 
JUMP_INSN
;

773 
ûÀgÆ_ö¢
;

775 
C_NEXT_INSN
;

776 
	`C_QUADRANT
(2)

777 
fun˘3
 = (
ö¢
 >> 13) & 7;

778 
rs2
 = (
ö¢
 >> 2) & 0x1f;

779 
fun˘3
) {

781 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5Ë| 
rs2
;

782 #i‡
XLEN
 == 32

783 i‡(
imm
 & 0x20)

784 
ûÀgÆ_ö¢
;

785 #ñi‡
XLEN
 == 128

786 i‡(
imm
 == 0)

787 
imm
 = 64;

789 i‡(
rd
 != 0)

790 
s
->
ªg
[
rd
] = (
ötx_t
)(s->ªg[rd] << 
imm
);

792 #i‡
XLEN
 == 128

794 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

795 (
rs2
 & (1 << 4)) |

796 
	`gë_fõld1
(
ö¢
, 2, 6, 9);

797 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

798 i‡(
	`èrgë_ªad_u128
(
s
, &
vÆ
, 
addr
))

799 
mmu_ex˚±i⁄
;

800 i‡(
rd
 != 0)

801 
s
->
ªg
[
rd
] = 
vÆ
;

803 #ñi‡
FLEN
 >= 64

806 
uöt64_t
 
rvÆ
;

807 i‡(
s
->
fs
 == 0)

808 
ûÀgÆ_ö¢
;

809 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

810 (
rs2
 & (3 << 3)) |

811 
	`gë_fõld1
(
ö¢
, 2, 6, 8);

812 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

813 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

814 
mmu_ex˚±i⁄
;

815 
s
->
Â_ªg
[
rd
] = 
rvÆ
 | 
F64_HIGH
;

816 
s
->
fs
 = 3;

822 
uöt32_t
 
rvÆ
;

823 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

824 (
rs2
 & (7 << 2)) |

825 
	`gë_fõld1
(
ö¢
, 2, 6, 7);

826 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

827 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

828 
mmu_ex˚±i⁄
;

829 i‡(
rd
 != 0)

830 
s
->
ªg
[
rd
] = (
öt32_t
)
rvÆ
;

833 #i‡
XLEN
 >= 64

836 
uöt64_t
 
rvÆ
;

837 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

838 (
rs2
 & (3 << 3)) |

839 
	`gë_fõld1
(
ö¢
, 2, 6, 8);

840 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

841 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

842 
mmu_ex˚±i⁄
;

843 i‡(
rd
 != 0)

844 
s
->
ªg
[
rd
] = (
öt64_t
)
rvÆ
;

847 #ñi‡
FLEN
 >= 32

850 
uöt32_t
 
rvÆ
;

851 i‡(
s
->
fs
 == 0)

852 
ûÀgÆ_ö¢
;

853 
imm
 = 
	`gë_fõld1
(
ö¢
, 12, 5, 5) |

854 (
rs2
 & (7 << 2)) |

855 
	`gë_fõld1
(
ö¢
, 2, 6, 7);

856 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

857 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

858 
mmu_ex˚±i⁄
;

859 
s
->
Â_ªg
[
rd
] = 
rvÆ
 | 
F32_HIGH
;

860 
s
->
fs
 = 3;

865 i‡(((
ö¢
 >> 12) & 1) == 0) {

866 i‡(
rs2
 == 0) {

868 i‡(
rd
 == 0)

869 
ûÀgÆ_ö¢
;

870 
s
->
pc
 = s->
ªg
[
rd
] & ~1;

871 
JUMP_INSN
;

874 i‡(
rd
 != 0)

875 
s
->
ªg
[
rd
] = s->ªg[
rs2
];

878 i‡(
rs2
 == 0) {

879 i‡(
rd
 == 0) {

881 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_BREAKPOINT
;

882 
ex˚±i⁄
;

885 
vÆ
 = 
	`GET_PC
() + 2;

886 
s
->
pc
 = s->
ªg
[
rd
] & ~1;

887 
s
->
ªg
[1] = 
vÆ
;

888 
JUMP_INSN
;

891 i‡(
rd
 != 0) {

892 
s
->
ªg
[
rd
] = (
ötx_t
)(s->ªg[rd] + s->ªg[
rs2
]);

897 #i‡
XLEN
 == 128

899 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

900 
	`gë_fõld1
(
ö¢
, 7, 6, 8);

901 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

902 i‡(
	`èrgë_wrôe_u128
(
s
, 
addr
, s->
ªg
[
rs2
]))

903 
mmu_ex˚±i⁄
;

905 #ñi‡
FLEN
 >= 64

907 i‡(
s
->
fs
 == 0)

908 
ûÀgÆ_ö¢
;

909 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

910 
	`gë_fõld1
(
ö¢
, 7, 6, 8);

911 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

912 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, s->
Â_ªg
[
rs2
]))

913 
mmu_ex˚±i⁄
;

917 
imm
 = 
	`gë_fõld1
(
ö¢
, 9, 2, 5) |

918 
	`gë_fõld1
(
ö¢
, 7, 6, 7);

919 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

920 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, s->
ªg
[
rs2
]))

921 
mmu_ex˚±i⁄
;

923 #i‡
XLEN
 >= 64

925 
imm
 = 
	`gë_fõld1
(
ö¢
, 10, 3, 5) |

926 
	`gë_fõld1
(
ö¢
, 7, 6, 8);

927 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

928 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, s->
ªg
[
rs2
]))

929 
mmu_ex˚±i⁄
;

931 #ñi‡
FLEN
 >= 32

933 i‡(
s
->
fs
 == 0)

934 
ûÀgÆ_ö¢
;

935 
imm
 = 
	`gë_fõld1
(
ö¢
, 9, 2, 5) |

936 
	`gë_fõld1
(
ö¢
, 7, 6, 7);

937 
addr
 = (
ötx_t
)(
s
->
ªg
[2] + 
imm
);

938 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, s->
Â_ªg
[
rs2
]))

939 
mmu_ex˚±i⁄
;

943 
ûÀgÆ_ö¢
;

945 
C_NEXT_INSN
;

949 i‡(
rd
 != 0)

950 
s
->
ªg
[
rd
] = (
öt32_t
)(
ö¢
 & 0xfffff000);

951 
NEXT_INSN
;

953 i‡(
rd
 != 0)

954 
s
->
ªg
[
rd
] = (
ötx_t
)(
	`GET_PC
(Ë+ (
öt32_t
)(
ö¢
 & 0xfffff000));

955 
NEXT_INSN
;

957 
imm
 = ((
ö¢
 >> (31 - 20)) & (1 << 20)) |

958 ((
ö¢
 >> (21 - 1)) & 0x7fe) |

959 ((
ö¢
 >> (20 - 11)) & (1 << 11)) |

960 (
ö¢
 & 0xff000);

961 
imm
 = (imm << 11) >> 11;

962 i‡(
rd
 != 0)

963 
s
->
ªg
[
rd
] = 
	`GET_PC
() + 4;

964 
s
->
pc
 = (
ötx_t
)(
	`GET_PC
(Ë+ 
imm
);

965 
JUMP_INSN
;

967 
imm
 = (
öt32_t
)
ö¢
 >> 20;

968 
vÆ
 = 
	`GET_PC
() + 4;

969 
s
->
pc
 = (
ötx_t
)(s->
ªg
[
rs1
] + 
imm
) & ~1;

970 i‡(
rd
 != 0)

971 
s
->
ªg
[
rd
] = 
vÆ
;

972 
JUMP_INSN
;

974 
fun˘3
 = (
ö¢
 >> 12) & 7;

975 
fun˘3
 >> 1) {

977 
c⁄d
 = (
s
->
ªg
[
rs1
] =s->ªg[
rs2
]);

980 
c⁄d
 = ((
èrgë_l⁄g
)
s
->
ªg
[
rs1
] < (èrgë_l⁄g)s->ªg[
rs2
]);

983 
c⁄d
 = (
s
->
ªg
[
rs1
] < s->ªg[
rs2
]);

986 
ûÀgÆ_ö¢
;

988 
c⁄d
 ^(
fun˘3
 & 1);

989 i‡(
c⁄d
) {

990 
imm
 = ((
ö¢
 >> (31 - 12)) & (1 << 12)) |

991 ((
ö¢
 >> (25 - 5)) & 0x7e0) |

992 ((
ö¢
 >> (8 - 1)) & 0x1e) |

993 ((
ö¢
 << (11 - 7)) & (1 << 11));

994 
imm
 = (imm << 19) >> 19;

995 
s
->
pc
 = (
ötx_t
)(
	`GET_PC
(Ë+ 
imm
);

996 
JUMP_INSN
;

998 
NEXT_INSN
;

1000 
fun˘3
 = (
ö¢
 >> 12) & 7;

1001 
imm
 = (
öt32_t
)
ö¢
 >> 20;

1002 
addr
 = 
s
->
ªg
[
rs1
] + 
imm
;

1003 
fun˘3
) {

1006 
uöt8_t
 
rvÆ
;

1007 i‡(
	`èrgë_ªad_u8
(
s
, &
rvÆ
, 
addr
))

1008 
mmu_ex˚±i⁄
;

1009 
vÆ
 = (
öt8_t
)
rvÆ
;

1014 
uöt16_t
 
rvÆ
;

1015 i‡(
	`èrgë_ªad_u16
(
s
, &
rvÆ
, 
addr
))

1016 
mmu_ex˚±i⁄
;

1017 
vÆ
 = (
öt16_t
)
rvÆ
;

1022 
uöt32_t
 
rvÆ
;

1023 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

1024 
mmu_ex˚±i⁄
;

1025 
vÆ
 = (
öt32_t
)
rvÆ
;

1030 
uöt8_t
 
rvÆ
;

1031 i‡(
	`èrgë_ªad_u8
(
s
, &
rvÆ
, 
addr
))

1032 
mmu_ex˚±i⁄
;

1033 
vÆ
 = 
rvÆ
;

1038 
uöt16_t
 
rvÆ
;

1039 i‡(
	`èrgë_ªad_u16
(
s
, &
rvÆ
, 
addr
))

1040 
mmu_ex˚±i⁄
;

1041 
vÆ
 = 
rvÆ
;

1044 #i‡
XLEN
 >= 64

1047 
uöt64_t
 
rvÆ
;

1048 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

1049 
mmu_ex˚±i⁄
;

1050 
vÆ
 = (
öt64_t
)
rvÆ
;

1055 
uöt32_t
 
rvÆ
;

1056 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

1057 
mmu_ex˚±i⁄
;

1058 
vÆ
 = 
rvÆ
;

1062 #i‡
XLEN
 >= 128

1065 
uöt64_t
 
rvÆ
;

1066 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

1067 
mmu_ex˚±i⁄
;

1068 
vÆ
 = 
rvÆ
;

1073 
ûÀgÆ_ö¢
;

1075 i‡(
rd
 != 0)

1076 
s
->
ªg
[
rd
] = 
vÆ
;

1077 
NEXT_INSN
;

1079 
fun˘3
 = (
ö¢
 >> 12) & 7;

1080 
imm
 = 
rd
 | ((
ö¢
 >> (25 - 5)) & 0xfe0);

1081 
imm
 = (imm << 20) >> 20;

1082 
addr
 = 
s
->
ªg
[
rs1
] + 
imm
;

1083 
vÆ
 = 
s
->
ªg
[
rs2
];

1084 
fun˘3
) {

1086 i‡(
	`èrgë_wrôe_u8
(
s
, 
addr
, 
vÆ
))

1087 
mmu_ex˚±i⁄
;

1090 i‡(
	`èrgë_wrôe_u16
(
s
, 
addr
, 
vÆ
))

1091 
mmu_ex˚±i⁄
;

1094 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, 
vÆ
))

1095 
mmu_ex˚±i⁄
;

1097 #i‡
XLEN
 >= 64

1099 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, 
vÆ
))

1100 
mmu_ex˚±i⁄
;

1103 #i‡
XLEN
 >= 128

1105 i‡(
	`èrgë_wrôe_u128
(
s
, 
addr
, 
vÆ
))

1106 
mmu_ex˚±i⁄
;

1110 
ûÀgÆ_ö¢
;

1112 
NEXT_INSN
;

1114 
fun˘3
 = (
ö¢
 >> 12) & 7;

1115 
imm
 = (
öt32_t
)
ö¢
 >> 20;

1116 
fun˘3
) {

1118 
vÆ
 = (
ötx_t
)(
s
->
ªg
[
rs1
] + 
imm
);

1121 i‡((
imm
 & ~(
XLEN
 - 1)) != 0)

1122 
ûÀgÆ_ö¢
;

1123 
vÆ
 = (
ötx_t
)(
s
->
ªg
[
rs1
] << (
imm
 & (
XLEN
 - 1)));

1126 
vÆ
 = (
èrgë_l⁄g
)
s
->
ªg
[
rs1
] < (èrgë_l⁄g)
imm
;

1129 
vÆ
 = 
s
->
ªg
[
rs1
] < (
èrgë_ul⁄g
)
imm
;

1132 
vÆ
 = 
s
->
ªg
[
rs1
] ^ 
imm
;

1135 i‡((
imm
 & ~((
XLEN
 - 1) | 0x400)) != 0)

1136 
ûÀgÆ_ö¢
;

1137 i‡(
imm
 & 0x400)

1138 
vÆ
 = (
ötx_t
)
s
->
ªg
[
rs1
] >> (
imm
 & (
XLEN
 - 1));

1140 
vÆ
 = (
ötx_t
)((
uötx_t
)
s
->
ªg
[
rs1
] >> (
imm
 & (
XLEN
 - 1)));

1143 
vÆ
 = 
s
->
ªg
[
rs1
] | 
imm
;

1147 
vÆ
 = 
s
->
ªg
[
rs1
] & 
imm
;

1150 i‡(
rd
 != 0)

1151 
s
->
ªg
[
rd
] = 
vÆ
;

1152 
NEXT_INSN
;

1153 #i‡
XLEN
 >= 64

1155 
fun˘3
 = (
ö¢
 >> 12) & 7;

1156 
imm
 = (
öt32_t
)
ö¢
 >> 20;

1157 
vÆ
 = 
s
->
ªg
[
rs1
];

1158 
fun˘3
) {

1160 
vÆ
 = (
öt32_t
)(vÆ + 
imm
);

1163 i‡((
imm
 & ~31) != 0)

1164 
ûÀgÆ_ö¢
;

1165 
vÆ
 = (
öt32_t
)(vÆ << (
imm
 & 31));

1168 i‡((
imm
 & ~(31 | 0x400)) != 0)

1169 
ûÀgÆ_ö¢
;

1170 i‡(
imm
 & 0x400)

1171 
vÆ
 = (
öt32_t
)vÆ >> (
imm
 & 31);

1173 
vÆ
 = (
öt32_t
)((
uöt32_t
)vÆ >> (
imm
 & 31));

1176 
ûÀgÆ_ö¢
;

1178 i‡(
rd
 != 0)

1179 
s
->
ªg
[
rd
] = 
vÆ
;

1180 
NEXT_INSN
;

1182 #i‡
XLEN
 >= 128

1184 
fun˘3
 = (
ö¢
 >> 12) & 7;

1185 
imm
 = (
öt32_t
)
ö¢
 >> 20;

1186 
vÆ
 = 
s
->
ªg
[
rs1
];

1187 
fun˘3
) {

1189 
vÆ
 = (
öt64_t
)(vÆ + 
imm
);

1192 i‡((
imm
 & ~63) != 0)

1193 
ûÀgÆ_ö¢
;

1194 
vÆ
 = (
öt64_t
)(vÆ << (
imm
 & 63));

1197 i‡((
imm
 & ~(63 | 0x400)) != 0)

1198 
ûÀgÆ_ö¢
;

1199 i‡(
imm
 & 0x400)

1200 
vÆ
 = (
öt64_t
)vÆ >> (
imm
 & 63);

1202 
vÆ
 = (
öt64_t
)((
uöt64_t
)vÆ >> (
imm
 & 63));

1205 
ûÀgÆ_ö¢
;

1207 i‡(
rd
 != 0)

1208 
s
->
ªg
[
rd
] = 
vÆ
;

1209 
NEXT_INSN
;

1212 
imm
 = 
ö¢
 >> 25;

1213 
vÆ
 = 
s
->
ªg
[
rs1
];

1214 
vÆ2
 = 
s
->
ªg
[
rs2
];

1215 i‡(
imm
 == 1) {

1216 
fun˘3
 = (
ö¢
 >> 12) & 7;

1217 
fun˘3
) {

1219 
vÆ
 = (
ötx_t
)((ötx_t)vÆ * (ötx_t)
vÆ2
);

1222 
vÆ
 = (
ötx_t
)
	`glue
(
mulh
, 
XLEN
)(vÆ, 
vÆ2
);

1225 
vÆ
 = (
ötx_t
)
	`glue
(
mulhsu
, 
XLEN
)(vÆ, 
vÆ2
);

1228 
vÆ
 = (
ötx_t
)
	`glue
(
mulhu
, 
XLEN
)(vÆ, 
vÆ2
);

1231 
vÆ
 = 
	`glue
(
div
, 
XLEN
)(vÆ, 
vÆ2
);

1234 
vÆ
 = (
ötx_t
)
	`glue
(
divu
, 
XLEN
)(vÆ, 
vÆ2
);

1237 
vÆ
 = 
	`glue
(
ªm
, 
XLEN
)(vÆ, 
vÆ2
);

1240 
vÆ
 = (
ötx_t
)
	`glue
(
ªmu
, 
XLEN
)(vÆ, 
vÆ2
);

1243 
ûÀgÆ_ö¢
;

1246 i‡(
imm
 & ~0x20)

1247 
ûÀgÆ_ö¢
;

1248 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

1249 
fun˘3
) {

1251 
vÆ
 = (
ötx_t
)(vÆ + 
vÆ2
);

1254 
vÆ
 = (
ötx_t
)(vÆ - 
vÆ2
);

1257 
vÆ
 = (
ötx_t
)(vÆ << (
vÆ2
 & (
XLEN
 - 1)));

1260 
vÆ
 = (
èrgë_l⁄g
)vÆ < (èrgë_l⁄g)
vÆ2
;

1263 
vÆ
 = vÆ < 
vÆ2
;

1266 
vÆ
 = vÆ ^ 
vÆ2
;

1269 
vÆ
 = (
ötx_t
)((
uötx_t
)vÆ >> (
vÆ2
 & (
XLEN
 - 1)));

1272 
vÆ
 = (
ötx_t
)vÆ >> (
vÆ2
 & (
XLEN
 - 1));

1275 
vÆ
 = vÆ | 
vÆ2
;

1278 
vÆ
 = vÆ & 
vÆ2
;

1281 
ûÀgÆ_ö¢
;

1284 i‡(
rd
 != 0)

1285 
s
->
ªg
[
rd
] = 
vÆ
;

1286 
NEXT_INSN
;

1287 #i‡
XLEN
 >= 64

1289 
imm
 = 
ö¢
 >> 25;

1290 
vÆ
 = 
s
->
ªg
[
rs1
];

1291 
vÆ2
 = 
s
->
ªg
[
rs2
];

1292 i‡(
imm
 == 1) {

1293 
fun˘3
 = (
ö¢
 >> 12) & 7;

1294 
fun˘3
) {

1296 
vÆ
 = (
öt32_t
)((öt32_t)vÆ * (öt32_t)
vÆ2
);

1299 
vÆ
 = 
	`div32
(vÆ, 
vÆ2
);

1302 
vÆ
 = (
öt32_t
)
	`divu32
(vÆ, 
vÆ2
);

1305 
vÆ
 = 
	`ªm32
(vÆ, 
vÆ2
);

1308 
vÆ
 = (
öt32_t
)
	`ªmu32
(vÆ, 
vÆ2
);

1311 
ûÀgÆ_ö¢
;

1314 i‡(
imm
 & ~0x20)

1315 
ûÀgÆ_ö¢
;

1316 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

1317 
fun˘3
) {

1319 
vÆ
 = (
öt32_t
)(vÆ + 
vÆ2
);

1322 
vÆ
 = (
öt32_t
)(vÆ - 
vÆ2
);

1325 
vÆ
 = (
öt32_t
)((
uöt32_t
)vÆ << (
vÆ2
 & 31));

1328 
vÆ
 = (
öt32_t
)((
uöt32_t
)vÆ >> (
vÆ2
 & 31));

1331 
vÆ
 = (
öt32_t
)vÆ >> (
vÆ2
 & 31);

1334 
ûÀgÆ_ö¢
;

1337 i‡(
rd
 != 0)

1338 
s
->
ªg
[
rd
] = 
vÆ
;

1339 
NEXT_INSN
;

1341 #i‡
XLEN
 >= 128

1343 
imm
 = 
ö¢
 >> 25;

1344 
vÆ
 = 
s
->
ªg
[
rs1
];

1345 
vÆ2
 = 
s
->
ªg
[
rs2
];

1346 i‡(
imm
 == 1) {

1347 
fun˘3
 = (
ö¢
 >> 12) & 7;

1348 
fun˘3
) {

1350 
vÆ
 = (
öt64_t
)((öt64_t)vÆ * (öt64_t)
vÆ2
);

1353 
vÆ
 = 
	`div64
(vÆ, 
vÆ2
);

1356 
vÆ
 = (
öt64_t
)
	`divu64
(vÆ, 
vÆ2
);

1359 
vÆ
 = 
	`ªm64
(vÆ, 
vÆ2
);

1362 
vÆ
 = (
öt64_t
)
	`ªmu64
(vÆ, 
vÆ2
);

1365 
ûÀgÆ_ö¢
;

1368 i‡(
imm
 & ~0x20)

1369 
ûÀgÆ_ö¢
;

1370 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

1371 
fun˘3
) {

1373 
vÆ
 = (
öt64_t
)(vÆ + 
vÆ2
);

1376 
vÆ
 = (
öt64_t
)(vÆ - 
vÆ2
);

1379 
vÆ
 = (
öt64_t
)((
uöt64_t
)vÆ << (
vÆ2
 & 63));

1382 
vÆ
 = (
öt64_t
)((
uöt64_t
)vÆ >> (
vÆ2
 & 63));

1385 
vÆ
 = (
öt64_t
)vÆ >> (
vÆ2
 & 63);

1388 
ûÀgÆ_ö¢
;

1391 i‡(
rd
 != 0)

1392 
s
->
ªg
[
rd
] = 
vÆ
;

1393 
NEXT_INSN
;

1396 
fun˘3
 = (
ö¢
 >> 12) & 7;

1397 
imm
 = 
ö¢
 >> 20;

1398 i‡(
fun˘3
 & 4)

1399 
vÆ
 = 
rs1
;

1401 
vÆ
 = 
s
->
ªg
[
rs1
];

1402 
fun˘3
 &= 3;

1403 
fun˘3
) {

1405 
s
->
ö¢_cou¡î
 = 
	`GET_INSN_COUNTER
();

1406 i‡(
	`c§_ªad
(
s
, &
vÆ2
, 
imm
, 
TRUE
, &
run_mode
))

1407 
ûÀgÆ_ö¢
;

1408 
vÆ2
 = (
ötx_t
)val2;

1409 
îr
 = 
	`c§_wrôe
(
s
, 
imm
, 
vÆ
);

1410 i‡(
îr
 < 0)

1411 
ûÀgÆ_ö¢
;

1412 i‡(
rd
 != 0)

1413 
s
->
ªg
[
rd
] = 
vÆ2
;

1414 i‡(
îr
 > 0) {

1415 
s
->
pc
 = 
	`GET_PC
() + 4;

1416 i‡(
îr
 == 2)

1417 
JUMP_INSN
;

1419 
d⁄e_öãΩ
;

1424 
s
->
ö¢_cou¡î
 = 
	`GET_INSN_COUNTER
();

1425 i‡(
	`c§_ªad
(
s
, &
vÆ2
, 
imm
, (
rs1
 !0), &
run_mode
))

1426 
ûÀgÆ_ö¢
;

1427 
vÆ2
 = (
ötx_t
)val2;

1428 
run_mode
) {

1429 
MODE_SIM_START
: {

1430 
	`°¨t_sy°em_simuœti⁄
(
s
, 
	`GET_PC
() + 4,

1431 
	`GET_INSN_COUNTER
());

1432 
s
->
pc
 = 
	`GET_PC
() + 4;

1433 
the_íd
;

1435 
MODE_SIM_STOP
: {

1436 
	`°›_sy°em_simuœti⁄
(
s
, 
	`GET_PC
(), 
	`GET_INSN_COUNTER
());

1437 
s
->
pc
 = 
	`GET_PC
() + 4;

1438 
the_íd
;

1443 i‡(
rs1
 != 0) {

1444 i‡(
fun˘3
 == 2)

1445 
vÆ
 = 
vÆ2
 | val;

1447 
vÆ
 = 
vÆ2
 & ~val;

1448 
îr
 = 
	`c§_wrôe
(
s
, 
imm
, 
vÆ
);

1449 i‡(
îr
 < 0)

1450 
ûÀgÆ_ö¢
;

1452 
îr
 = 0;

1454 i‡(
rd
 != 0)

1455 
s
->
ªg
[
rd
] = 
vÆ2
;

1456 i‡(
îr
 > 0) {

1457 
s
->
pc
 = 
	`GET_PC
() + 4;

1458 i‡(
îr
 == 2)

1459 
JUMP_INSN
;

1461 
d⁄e_öãΩ
;

1465 
imm
) {

1467 i‡(
ö¢
 & 0x000fff80)

1468 
ûÀgÆ_ö¢
;

1469 i‡(
s
->
simuœti⁄
)

1471 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
eˇŒ
;

1473 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_USER_ECALL
 + s->
¥iv
;

1474 
ex˚±i⁄
;

1476 i‡(
ö¢
 & 0x000fff80)

1477 
ûÀgÆ_ö¢
;

1478 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_BREAKPOINT
;

1479 
ex˚±i⁄
;

1482 i‡(
ö¢
 & 0x000fff80)

1483 
ûÀgÆ_ö¢
;

1484 i‡(
s
->
¥iv
 < 
PRV_S
)

1485 
ûÀgÆ_ö¢
;

1486 
s
->
pc
 = 
	`GET_PC
();

1487 
	`h™dÀ_§ë
(
s
);

1488 
d⁄e_öãΩ
;

1493 i‡(
ö¢
 & 0x000fff80)

1494 
ûÀgÆ_ö¢
;

1495 i‡(
s
->
¥iv
 < 
PRV_M
)

1496 
ûÀgÆ_ö¢
;

1497 
s
->
pc
 = 
	`GET_PC
();

1498 
	`h™dÀ_mªt
(
s
);

1499 
d⁄e_öãΩ
;

1503 i‡(
ö¢
 & 0x00007f80)

1504 
ûÀgÆ_ö¢
;

1505 i‡(
s
->
¥iv
 =
PRV_U
)

1506 
ûÀgÆ_ö¢
;

1509 i‡((
s
->
mù
 & s->
mõ
) == 0) {

1510 
s
->
powî_down_Êag
 = 
TRUE
;

1511 
s
->
pc
 = 
	`GET_PC
() + 4;

1512 
d⁄e_öãΩ
;

1516 i‡((
imm
 >> 5) == 0x09) {

1518 i‡(
ö¢
 & 0x00007f80)

1519 
ûÀgÆ_ö¢
;

1520 i‡(
s
->
¥iv
 =
PRV_U
)

1521 
ûÀgÆ_ö¢
;

1522 i‡(
rs1
 == 0) {

1523 
	`éb_Êush_Æl
(
s
);

1525 
	`éb_Êush_vaddr
(
s
, s->
ªg
[
rs1
]);

1528 
s
->
pc
 = 
	`GET_PC
() + 4;

1529 
JUMP_INSN
;

1531 
ûÀgÆ_ö¢
;

1537 
ûÀgÆ_ö¢
;

1539 
NEXT_INSN
;

1541 
fun˘3
 = (
ö¢
 >> 12) & 7;

1542 
fun˘3
) {

1544 i‡(
ö¢
 & 0xf00fff80)

1545 
ûÀgÆ_ö¢
;

1548 i‡(
ö¢
 != 0x0000100f)

1549 
ûÀgÆ_ö¢
;

1551 #i‡
XLEN
 >= 128

1553 
imm
 = (
öt32_t
)
ö¢
 >> 20;

1554 
addr
 = 
s
->
ªg
[
rs1
] + 
imm
;

1555 i‡(
	`èrgë_ªad_u128
(
s
, &
vÆ
, 
addr
))

1556 
mmu_ex˚±i⁄
;

1557 i‡(
rd
 != 0)

1558 
s
->
ªg
[
rd
] = 
vÆ
;

1562 
ûÀgÆ_ö¢
;

1564 
NEXT_INSN
;

1566 
fun˘3
 = (
ö¢
 >> 12) & 7;

1567 
	#OP_A
(
size
) \

1569 
uöt
 ## 
size
 ##
_t
 
rvÆ
; \

1571 
addr
 = 
s
->
ªg
[
rs1
]; \

1572 
fun˘3
 = 
ö¢
 >> 27; \

1573 
fun˘3
) { \

1575 i‡(
rs2
 != 0) \

1576 
ûÀgÆ_ö¢
; \

1577 i‡(
èrgë_ªad_u
 ## 
	`size
(
s
, &
rvÆ
, 
addr
)) \

1578 
mmu_ex˚±i⁄
; \

1579 
vÆ
 = (## 
size
 ## 
_t
)
rvÆ
; \

1580 
s
->
lﬂd_ªs
 = 
addr
; \

1583 i‡(
s
->
lﬂd_ªs
 =
addr
) { \

1584 i‡(
èrgë_wrôe_u
 ## 
	`size
(
s
, 
addr
, s->
ªg
[
rs2
])) \

1585 
mmu_ex˚±i⁄
; \

1586 
vÆ
 = 0; \

1588 
vÆ
 = 1; \

1600 i‡(
èrgë_ªad_u
 ## 
	`size
(
s
, &
rvÆ
, 
addr
)) \

1601 
mmu_ex˚±i⁄
; \

1602 
vÆ
 = (## 
size
 ## 
_t
)
rvÆ
; \

1603 
vÆ2
 = 
s
->
ªg
[
rs2
]; \

1604 
fun˘3
) { \

1608 
vÆ2
 = (## 
size
 ## 
_t
)(
vÆ
 + val2); \

1611 
vÆ2
 = (## 
size
 ## 
_t
)(
vÆ
 ^ val2); \

1614 
vÆ2
 = (## 
size
 ## 
_t
)(
vÆ
 & val2); \

1617 
vÆ2
 = (## 
size
 ## 
_t
)(
vÆ
 | val2); \

1620 i‡((## 
size
 ## 
_t
)
vÆ
 < (## sizê## _t)
vÆ2
) \

1621 
vÆ2
 = (## 
size
 ## 
_t
)
vÆ
; \

1624 i‡((## 
size
 ## 
_t
)
vÆ
 > (## sizê## _t)
vÆ2
) \

1625 
vÆ2
 = (## 
size
 ## 
_t
)
vÆ
; \

1628 i‡((
uöt
## 
size
 ## 
_t
)
vÆ
 < (uöt## sizê## _t)
vÆ2
) \

1629 
vÆ2
 = (## 
size
 ## 
_t
)
vÆ
; \

1632 i‡((
uöt
## 
size
 ## 
_t
)
vÆ
 > (uöt## sizê## _t)
vÆ2
) \

1633 
vÆ2
 = (## 
size
 ## 
_t
)
vÆ
; \

1636 
ûÀgÆ_ö¢
; \

1638 i‡(
èrgë_wrôe_u
 ## 
	`size
(
s
, 
addr
, 
vÆ2
)) \

1639 
mmu_ex˚±i⁄
; \

1642 
ûÀgÆ_ö¢
; \

1644 }

	)

1646 
fun˘3
) {

1648 
	`OP_A
(32);

1650 #i‡
XLEN
 >= 64

1652 
	`OP_A
(64);

1655 #i‡
XLEN
 >= 128

1657 
	`OP_A
(128);

1661 
ûÀgÆ_ö¢
;

1663 i‡(
rd
 != 0)

1664 
s
->
ªg
[
rd
] = 
vÆ
;

1665 
NEXT_INSN
;

1666 #i‡
FLEN
 > 0

1669 i‡(
s
->
fs
 == 0)

1670 
ûÀgÆ_ö¢
;

1671 
fun˘3
 = (
ö¢
 >> 12) & 7;

1672 
imm
 = (
öt32_t
)
ö¢
 >> 20;

1673 
addr
 = 
s
->
ªg
[
rs1
] + 
imm
;

1674 
fun˘3
) {

1677 
uöt32_t
 
rvÆ
;

1678 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

1679 
mmu_ex˚±i⁄
;

1680 
s
->
Â_ªg
[
rd
] = 
rvÆ
 | 
F32_HIGH
;

1683 #i‡
FLEN
 >= 64

1686 
uöt64_t
 
rvÆ
;

1687 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

1688 
mmu_ex˚±i⁄
;

1689 
s
->
Â_ªg
[
rd
] = 
rvÆ
 | 
F64_HIGH
;

1693 #i‡
FLEN
 >= 128

1696 
uöt128_t
 
rvÆ
;

1697 i‡(
	`èrgë_ªad_u128
(
s
, &
rvÆ
, 
addr
))

1698 
mmu_ex˚±i⁄
;

1699 
s
->
Â_ªg
[
rd
] = 
rvÆ
;

1704 
ûÀgÆ_ö¢
;

1706 
s
->
fs
 = 3;

1707 
NEXT_INSN
;

1709 i‡(
s
->
fs
 == 0)

1710 
ûÀgÆ_ö¢
;

1711 
fun˘3
 = (
ö¢
 >> 12) & 7;

1712 
imm
 = 
rd
 | ((
ö¢
 >> (25 - 5)) & 0xfe0);

1713 
imm
 = (imm << 20) >> 20;

1714 
addr
 = 
s
->
ªg
[
rs1
] + 
imm
;

1715 
fun˘3
) {

1717 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, s->
Â_ªg
[
rs2
]))

1718 
mmu_ex˚±i⁄
;

1720 #i‡
FLEN
 >= 64

1722 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, s->
Â_ªg
[
rs2
]))

1723 
mmu_ex˚±i⁄
;

1726 #i‡
FLEN
 >= 128

1728 i‡(
	`èrgë_wrôe_u128
(
s
, 
addr
, s->
Â_ªg
[
rs2
]))

1729 
mmu_ex˚±i⁄
;

1733 
ûÀgÆ_ö¢
;

1735 
NEXT_INSN
;

1737 i‡(
s
->
fs
 == 0)

1738 
ûÀgÆ_ö¢
;

1739 
fun˘3
 = (
ö¢
 >> 25) & 3;

1740 
rs3
 = 
ö¢
 >> 27;

1741 
rm
 = 
	`gë_ö¢_rm
(
s
, (
ö¢
 >> 12) & 7);

1742 i‡(
rm
 < 0)

1743 
ûÀgÆ_ö¢
;

1744 
fun˘3
) {

1746 
s
->
Â_ªg
[
rd
] = 
	`fma_sf32
(s->Â_ªg[
rs1
], s->Â_ªg[
rs2
],

1747 
s
->
Â_ªg
[
rs3
], 
rm
, &s->
fÊags
Ë| 
F32_HIGH
;

1749 #i‡
FLEN
 >= 64

1751 
s
->
Â_ªg
[
rd
] = 
	`fma_sf64
(s->Â_ªg[
rs1
], s->Â_ªg[
rs2
],

1752 
s
->
Â_ªg
[
rs3
], 
rm
, &s->
fÊags
Ë| 
F64_HIGH
;

1755 #i‡
FLEN
 >= 128

1757 
s
->
Â_ªg
[
rd
] = 
	`fma_sf128
(s->Â_ªg[
rs1
], s->Â_ªg[
rs2
],

1758 
s
->
Â_ªg
[
rs3
], 
rm
, &s->
fÊags
);

1762 
ûÀgÆ_ö¢
;

1764 
s
->
fs
 = 3;

1765 
NEXT_INSN
;

1767 i‡(
s
->
fs
 == 0)

1768 
ûÀgÆ_ö¢
;

1769 
fun˘3
 = (
ö¢
 >> 25) & 3;

1770 
rs3
 = 
ö¢
 >> 27;

1771 
rm
 = 
	`gë_ö¢_rm
(
s
, (
ö¢
 >> 12) & 7);

1772 i‡(
rm
 < 0)

1773 
ûÀgÆ_ö¢
;

1774 
fun˘3
) {

1776 
s
->
Â_ªg
[
rd
] = 
	`fma_sf32
(s->Â_ªg[
rs1
],

1777 
s
->
Â_ªg
[
rs2
],

1778 
s
->
Â_ªg
[
rs3
] ^ 
FSIGN_MASK32
,

1779 
rm
, &
s
->
fÊags
Ë| 
F32_HIGH
;

1781 #i‡
FLEN
 >= 64

1783 
s
->
Â_ªg
[
rd
] = 
	`fma_sf64
(s->Â_ªg[
rs1
],

1784 
s
->
Â_ªg
[
rs2
],

1785 
s
->
Â_ªg
[
rs3
] ^ 
FSIGN_MASK64
,

1786 
rm
, &
s
->
fÊags
Ë| 
F64_HIGH
;

1789 #i‡
FLEN
 >= 128

1791 
s
->
Â_ªg
[
rd
] = 
	`fma_sf128
(s->Â_ªg[
rs1
],

1792 
s
->
Â_ªg
[
rs2
],

1793 
s
->
Â_ªg
[
rs3
] ^ 
FSIGN_MASK128
,

1794 
rm
, &
s
->
fÊags
);

1798 
ûÀgÆ_ö¢
;

1800 
s
->
fs
 = 3;

1801 
NEXT_INSN
;

1803 i‡(
s
->
fs
 == 0)

1804 
ûÀgÆ_ö¢
;

1805 
fun˘3
 = (
ö¢
 >> 25) & 3;

1806 
rs3
 = 
ö¢
 >> 27;

1807 
rm
 = 
	`gë_ö¢_rm
(
s
, (
ö¢
 >> 12) & 7);

1808 i‡(
rm
 < 0)

1809 
ûÀgÆ_ö¢
;

1810 
fun˘3
) {

1812 
s
->
Â_ªg
[
rd
] = 
	`fma_sf32
(s->Â_ªg[
rs1
] ^ 
FSIGN_MASK32
,

1813 
s
->
Â_ªg
[
rs2
],

1814 
s
->
Â_ªg
[
rs3
],

1815 
rm
, &
s
->
fÊags
Ë| 
F32_HIGH
;

1817 #i‡
FLEN
 >= 64

1819 
s
->
Â_ªg
[
rd
] = 
	`fma_sf64
(s->Â_ªg[
rs1
] ^ 
FSIGN_MASK64
,

1820 
s
->
Â_ªg
[
rs2
],

1821 
s
->
Â_ªg
[
rs3
],

1822 
rm
, &
s
->
fÊags
Ë| 
F64_HIGH
;

1825 #i‡
FLEN
 >= 128

1827 
s
->
Â_ªg
[
rd
] = 
	`fma_sf128
(s->Â_ªg[
rs1
] ^ 
FSIGN_MASK128
,

1828 
s
->
Â_ªg
[
rs2
],

1829 
s
->
Â_ªg
[
rs3
],

1830 
rm
, &
s
->
fÊags
);

1834 
ûÀgÆ_ö¢
;

1836 
s
->
fs
 = 3;

1837 
NEXT_INSN
;

1839 i‡(
s
->
fs
 == 0)

1840 
ûÀgÆ_ö¢
;

1841 
fun˘3
 = (
ö¢
 >> 25) & 3;

1842 
rs3
 = 
ö¢
 >> 27;

1843 
rm
 = 
	`gë_ö¢_rm
(
s
, (
ö¢
 >> 12) & 7);

1844 i‡(
rm
 < 0)

1845 
ûÀgÆ_ö¢
;

1846 
fun˘3
) {

1848 
s
->
Â_ªg
[
rd
] = 
	`fma_sf32
(s->Â_ªg[
rs1
] ^ 
FSIGN_MASK32
,

1849 
s
->
Â_ªg
[
rs2
],

1850 
s
->
Â_ªg
[
rs3
] ^ 
FSIGN_MASK32
,

1851 
rm
, &
s
->
fÊags
Ë| 
F32_HIGH
;

1853 #i‡
FLEN
 >= 64

1855 
s
->
Â_ªg
[
rd
] = 
	`fma_sf64
(s->Â_ªg[
rs1
] ^ 
FSIGN_MASK64
,

1856 
s
->
Â_ªg
[
rs2
],

1857 
s
->
Â_ªg
[
rs3
] ^ 
FSIGN_MASK64
,

1858 
rm
, &
s
->
fÊags
Ë| 
F64_HIGH
;

1861 #i‡
FLEN
 >= 128

1863 
s
->
Â_ªg
[
rd
] = 
	`fma_sf128
(s->Â_ªg[
rs1
] ^ 
FSIGN_MASK128
,

1864 
s
->
Â_ªg
[
rs2
],

1865 
s
->
Â_ªg
[
rs3
] ^ 
FSIGN_MASK128
,

1866 
rm
, &
s
->
fÊags
);

1870 
ûÀgÆ_ö¢
;

1872 
s
->
fs
 = 3;

1873 
NEXT_INSN
;

1875 i‡(
s
->
fs
 == 0)

1876 
ûÀgÆ_ö¢
;

1877 
imm
 = 
ö¢
 >> 25;

1878 
rm
 = (
ö¢
 >> 12) & 7;

1879 
imm
) {

1881 
	#F_SIZE
 32

	)

1882 
	~"riscv_˝u_Â_ãm∂©e.h
"

1883 #i‡
FLEN
 >= 64

1884 
	#F_SIZE
 64

	)

1885 
	~"riscv_˝u_Â_ãm∂©e.h
"

1887 #i‡
FLEN
 >= 128

1888 
	#F_SIZE
 128

	)

1889 
	~"riscv_˝u_Â_ãm∂©e.h
"

1893 
ûÀgÆ_ö¢
;

1895 
NEXT_INSN
;

1898 
ûÀgÆ_ö¢
;

1901 
jump_ö¢
: ;

1904 i‡(
s
->
ªtu∫_to_sim
)

1906 
s
->
ªtu∫_to_sim
 = 0;

1907 
s
->
pc
 = 
	`GET_PC
();

1908 
the_íd
;

1912 i‡(
s
->
simuœti⁄
)

1914 
	`as£π
(0);

1918 
ûÀgÆ_ö¢
:

1919 
s
->
≥ndög_ex˚±i⁄
 = 
CAUSE_ILLEGAL_INSTRUCTION
;

1920 
s
->
≥ndög_tvÆ
 = 
ö¢
;

1921 
mmu_ex˚±i⁄
:

1922 
ex˚±i⁄
:

1923 
s
->
pc
 = 
	`GET_PC
();

1924 i‡(
s
->
≥ndög_ex˚±i⁄
 >= 0) {

1926 
s
->
n_cy˛es
--;

1927 
	`øi£_ex˚±i⁄2
(
s
, s->
≥ndög_ex˚±i⁄
, s->
≥ndög_tvÆ
);

1930 
d⁄e_öãΩ
:

1931 
the_íd
:

1932 
s
->
ö¢_cou¡î
 = 
	`GET_INSN_COUNTER
();

1934 
	`¥ötf
("done interp %lx int=%x mstatus=%lxÖrv=%d\n",

1935 (
uöt64_t
)
s
->
ö¢_cou¡î
, s->
mù
 & s->
mõ
, (uöt64_t)s->
m°©us
,

1936 
s
->
¥iv
);

1938 
	}
}

1940 #unde‡
uötx_t


1941 #unde‡
ötx_t


1942 #unde‡
XLEN


1943 #unde‡
OP_A


	@riscv_cpu_xlen_typedefs.h

1 #i‚de‡
_RISCV_CPU_XLEN_TYPEDEFS_


2 
	#_RISCV_CPU_XLEN_TYPEDEFS_


	)

4 #i‚de‡
FLEN


5 #i‡
MAX_XLEN
 == 128

6 
	#FLEN
 128

	)

8 
	#FLEN
 64

	)

12 #i‡
MAX_XLEN
 == 32

13 
uöt32_t
 
	tèrgë_ul⁄g
;

14 
öt32_t
 
	tèrgë_l⁄g
;

15 
	#PR_èrgë_ul⁄g
 "08x"

	)

16 #ñi‡
MAX_XLEN
 == 64

17 
uöt64_t
 
	tèrgë_ul⁄g
;

18 
öt64_t
 
	tèrgë_l⁄g
;

19 
	#PR_èrgë_ul⁄g
 "016" 
PRIx64


	)

20 #ñi‡
MAX_XLEN
 == 128

21 
uöt128_t
 
	tèrgë_ul⁄g
;

22 
öt128_t
 
	tèrgë_l⁄g
;

23 
	#PR_èrgë_ul⁄g
 "016" 
PRIx64


	)

25 #îr‹ 
unsuµ‹ãd
 
MAX_XLEN


29 #i‡
FLEN
 > 0

30 #i‡
FLEN
 == 32

31 
uöt32_t
 
	tÂ_uöt
;

32 
	#F32_HIGH
 0

	)

33 #ñi‡
FLEN
 == 64

34 
uöt64_t
 
	tÂ_uöt
;

35 
	#F32_HIGH
 ((
Â_uöt
)-1 << 32)

	)

36 
	#F64_HIGH
 0

	)

37 #ñi‡
FLEN
 == 128

38 
uöt128_t
 
	tÂ_uöt
;

39 
	#F32_HIGH
 ((
Â_uöt
)-1 << 32)

	)

40 
	#F64_HIGH
 ((
Â_uöt
)-1 << 64)

	)

42 #îr‹ 
unsuµ‹ãd
 
FLEN


47 #i‡
MAX_XLEN
 <32 && 
FLEN
 <= 32

48 
	#MLEN
 32

	)

49 #ñi‡
MAX_XLEN
 <64 && 
FLEN
 <= 64

50 
	#MLEN
 64

	)

52 
	#MLEN
 128

	)

55 #i‡
MLEN
 == 32

56 
uöt32_t
 
	tmem_uöt_t
;

57 #ñi‡
MLEN
 == 64

58 
uöt64_t
 
	tmem_uöt_t
;

59 #ñi‡
MLEN
 == 128

60 
uöt128_t
 
	tmem_uöt_t
;

62 #unsuµ‹ãd 
MLEN


	@riscv_machine.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

30 
	~<f˙é.h
>

31 
	~<î∫o.h
>

32 
	~<uni°d.h
>

33 
	~<time.h
>

35 
	~"cutûs.h
"

36 
	~"iomem.h
"

37 
	~"riscv_˝u.h
"

38 
	~"vútio.h
"

39 
	~"machöe.h
"

40 
	~"riscvsim/sim_∑øms_°©s.h
"

42 
	#UART_RX_BUFSIZE
 16

	)

46 
	sRISCVMachöe
 {

47 
VútMachöe
 
	mcomm⁄
;

48 
PhysMem‹yM≠
 *
	mmem_m≠
;

49 
	mmax_xÀn
;

50 
RISCVCPUSèã
 *
	m˝u_°©e
;

51 
uöt64_t
 
	møm_size
;

53 
BOOL
 
	mπc_ªÆ_time
;

54 
uöt64_t
 
	mπc_°¨t_time
;

55 
uöt64_t
 
	mtimecmp
;

57 
uöt32_t
 
	m∂ic_≥ndög_úq
, 
	m∂ic_£rved_úq
;

58 
IRQSig«l
 
	m∂ic_úq
[32];

60 
uöt64_t
 
	mhtif_toho°
, 
	mhtif_‰omho°
;

62 
uöt8_t
 
	mu¨t_dŒ
;

63 
uöt8_t
 
	mu¨t_dlm
;

64 
uöt8_t
 
	mu¨t_õr
;

65 
uöt8_t
 
	mu¨t_f¸
;

66 
uöt8_t
 
	mu¨t_l¸
;

67 
uöt8_t
 
	mu¨t_m¸
;

68 
uöt8_t
 
	mu¨t_s¸
;

69 
uöt8_t
 
	mu¨t_rx_≥ndög
, 
	mu¨t_tx_≥ndög
;

70 
	mu¨t_rx_hód
, 
	mu¨t_rx_èû
;

71 
uöt8_t
 
	mu¨t_rx_buf
[
UART_RX_BUFSIZE
];

72 #i‡
deföed
(
UART_OUT_DEBUG
)

73 
	mu¨t_pos
;

76 
VIRTIODevi˚
 *
	mkeybﬂrd_dev
;

77 
VIRTIODevi˚
 *
	mmou£_dev
;

79 
	mvútio_cou¡
;

80 } 
	tRISCVMachöe
;

82 
	#LOW_RAM_SIZE
 0x00010000

	)

83 
	#RAM_BASE_ADDR
 0x80000000

	)

84 
	#CLINT_BASE_ADDR
 0x02000000

	)

85 
	#CLINT_SIZE
 0x000c0000

	)

86 
	#HTIF_BASE_ADDR
 0x40008000

	)

87 
	#IDE_BASE_ADDR
 0x40009000

	)

88 
	#UART_BASE_ADDR
 0x4000A000

	)

89 
	#UART_IRQ
 1

	)

90 
	#VIRTIO_BASE_ADDR
 0x40010000

	)

91 
	#VIRTIO_SIZE
 0x1000

	)

92 
	#VIRTIO_IRQ
 2

	)

93 
	#PLIC_BASE_ADDR
 0x40100000

	)

94 
	#PLIC_SIZE
 0x00400000

	)

95 
	#FRAMEBUFFER_BASE_ADDR
 0x41000000

	)

100 
	#RTC_FREQ
 10000000

	)

101 
	#RTC_FREQ_DIV
 16

	)

104 
uöt64_t
 
	$πc_gë_ªÆ_time
(
RISCVMachöe
 *
s
)

106 
time•ec
 
ts
;

107 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ts
);

108  (
uöt64_t
)
ts
.
tv_£c
 * 
RTC_FREQ
 +

109 (
ts
.
tv_n£c
 / (1000000000 / 
RTC_FREQ
));

110 
	}
}

112 
uöt64_t
 
	$πc_gë_time
(
RISCVMachöe
 *
m
)

114 
uöt64_t
 
vÆ
;

115 i‡(
m
->
πc_ªÆ_time
) {

116 
vÆ
 = 
	`πc_gë_ªÆ_time
(
m
Ë- m->
πc_°¨t_time
;

118 
vÆ
 = 
	`riscv_˝u_gë_cy˛es
(
m
->
˝u_°©e
Ë/ 
RTC_FREQ_DIV
;

121  
vÆ
;

122 
	}
}

127 
	#UART_REG_DATA
 0

	)

129 
	#UART_REG_IER
 1

	)

132 
	#UART_REG_IIR
 2

	)

133 
	#UART_REG_FCR
 2

	)

134 
	#UART_REG_LCR
 3

	)

135 
	#UART_REG_MCR
 4

	)

136 
	#UART_REG_LSR
 5

	)

137 
	#UART_REG_MSR
 6

	)

138 
	#UART_REG_SCR
 7

	)

140 
	#UART_LCR_DLAB
 0x80

	)

142 
	$u¨t_£t_úq
(
RISCVMachöe
 *
s
)

144 
≥ndög
 = (
s
->
u¨t_rx_≥ndög
 && (s->
u¨t_õr
 & 0x01) != 0)

145 || (
s
->
u¨t_tx_≥ndög
 && (s->
u¨t_õr
 & 0x02) != 0);

146 
	`£t_úq
(&
s
->
∂ic_úq
[
UART_IRQ
], 
≥ndög
);

147 
	}
}

149 
uöt32_t
 
	$u¨t_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

151 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
›aque
;

152 
uöt32_t
 
vÆ
;

154 
	`as£π
(
size_log2
 == 0);

155 
off£t
) {

157 
UART_REG_DATA
:

158 i‡(
s
->
u¨t_l¸
 & 
UART_LCR_DLAB
)

159 
vÆ
 = 
s
->
u¨t_dŒ
;

160 i‡(
s
->
u¨t_rx_hód
 !s->
u¨t_rx_èû
)

162 
vÆ
 = 
s
->
u¨t_rx_buf
[s->
u¨t_rx_hód
];

163 
s
->
u¨t_rx_hód
 = (s->u¨t_rx_hód + 1Ë% 
UART_RX_BUFSIZE
;

164 i‡(
s
->
u¨t_rx_hód
 =s->
u¨t_rx_èû
)

166 
s
->
u¨t_rx_≥ndög
 = 0;

167 
	`u¨t_£t_úq
(
s
);

171 
vÆ
 = 0;

174 
UART_REG_IER
:

175 
vÆ
 = (
s
->
u¨t_l¸
 & 
UART_LCR_DLAB
Ë? s->
u¨t_dlm
 : s->
u¨t_õr
;

178 
UART_REG_LCR
:

179 
vÆ
 = 
s
->
u¨t_l¸
;

182 
UART_REG_IIR
:

183 
vÆ
 = ((
s
->
u¨t_f¸
 & 0x01) ? 0xC0 : 0x00)

184 | (
s
->
u¨t_rx_≥ndög
 ? ((s->
u¨t_f¸
 & 0xC0Ë? 0x0C : 0x04Ë: s->
u¨t_tx_≥ndög
 ? 0x02 : 0x01);

185 
s
->
u¨t_rx_≥ndög
 = 0;

186 
s
->
u¨t_tx_≥ndög
 = 0;

187 
	`u¨t_£t_úq
(
s
);

190 
UART_REG_MCR
:

191 
vÆ
 = 
s
->
u¨t_m¸
;

194 
UART_REG_LSR
:

195 
vÆ
 = 0x60 | 
s
->
u¨t_rx_≥ndög
;

198 
UART_REG_MSR
:

199 
vÆ
 = 0xB0;

202 
UART_REG_SCR
:

203 
vÆ
 = 
s
->
u¨t_s¸
;

207 
vÆ
 = 0;

211  
vÆ
;

212 
	}
}

214 
ölöe
 
	$c⁄sﬁe_wrôe_ch¨
(
RISCVMachöe
 *
s
, 
uöt8_t
 
c
)

216 
s
->
comm⁄
.
c⁄sﬁe
->
	`wrôe_d©a
(s->comm⁄.c⁄sﬁe->
›aque
, &
c
, 1);

217 
	}
}

219 #i‡
deföed
(
UART_OUT_DEBUG
)

220 
	$c⁄sﬁe_wrôe_°rög
(
RISCVMachöe
 *
s
, *
°r
)

222 *
°r
)

223 
	`c⁄sﬁe_wrôe_ch¨
(
s
, (
uöt8_t
)*
°r
++);

224 
	}
}

227 
	$u¨t_wrôe
(*
›aque
, 
uöt32_t
 
off£t
, uöt32_à
vÆ
,

228 
size_log2
)

230 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
›aque
;

232 
	`as£π
(
size_log2
 == 0);

233 
off£t
) {

234 
UART_REG_DATA
:

235 i‡(
s
->
u¨t_l¸
 & 
UART_LCR_DLAB
)

236 
s
->
u¨t_dŒ
 = 
vÆ
;

239 #i‡
	`deföed
(
UART_OUT_DEBUG
)

240 i‡(
s
->
u¨t_pos
 == 0)

241 
	`c⁄sﬁe_wrôe_°rög
(
s
, "uart: ");

242 i‡(
vÆ
 == '\n')

243 
s
->
u¨t_pos
 = 0;

245 
s
->
u¨t_pos
++;

247 
	`c⁄sﬁe_wrôe_ch¨
(
s
, 
vÆ
);

248 
s
->
u¨t_tx_≥ndög
 = 1;

249 
	`u¨t_£t_úq
(
s
);

252 
UART_REG_IER
:

253 i‡(
s
->
u¨t_l¸
 & 
UART_LCR_DLAB
)

254 
s
->
u¨t_dlm
 = 
vÆ
;

257 
s
->
u¨t_õr
 = 
vÆ
;

258 
	`u¨t_£t_úq
(
s
);

261 
UART_REG_LCR
:

262 
s
->
u¨t_l¸
 = 
vÆ
;

264 
UART_REG_FCR
:

265 
s
->
u¨t_f¸
 = 
vÆ
;

267 
UART_REG_MCR
:

268 
s
->
u¨t_m¸
 = (
vÆ
 & 0xF);

270 
UART_REG_SCR
:

271 
s
->
u¨t_s¸
 = 
vÆ
;

276 
	}
}

279 
	$u¨t_ˇn_rx
(
VútMachöe
 *
v
)

281 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
v
;

283  (
s
->
u¨t_rx_hód
 + 
UART_RX_BUFSIZE
-1 - s->
u¨t_rx_èû
) % UART_RX_BUFSIZE;

284 
	}
}

287 
	$u¨t_rx_d©a
(
VútMachöe
 *
v
, 
uöt8_t
 *
buf
, 
size
)

289 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
v
;

291 ; 
size
 > 0; size--)

293 
èû
 = 
s
->
u¨t_rx_èû
;

294 
√wèû
 = (
èû
 + 1Ë% 
UART_RX_BUFSIZE
;

295 i‡(
√wèû
 =
s
->
u¨t_rx_hód
)

297 
s
->
u¨t_rx_buf
[
èû
] = *
buf
++;

298 
s
->
u¨t_rx_èû
 = 
√wèû
;

299 
s
->
u¨t_rx_≥ndög
 = 1;

300 
	`u¨t_£t_úq
(
s
);

302 
	}
}

307 
uöt32_t
 
	$htif_ªad
(*
›aque
, 
uöt32_t
 
off£t
,

308 
size_log2
)

310 
RISCVMachöe
 *
s
 = 
›aque
;

311 
uöt32_t
 
vÆ
;

313 
	`as£π
(
size_log2
 == 2);

314 
off£t
) {

316 
vÆ
 = 
s
->
htif_toho°
;

319 
vÆ
 = 
s
->
htif_toho°
 >> 32;

322 
vÆ
 = 
s
->
htif_‰omho°
;

325 
vÆ
 = 
s
->
htif_‰omho°
 >> 32;

328 
vÆ
 = 0;

331  
vÆ
;

332 
	}
}

334 
	$htif_h™dÀ_cmd
(
RISCVMachöe
 *
s
)

336 
uöt32_t
 
devi˚
, 
cmd
;

338 
devi˚
 = 
s
->
htif_toho°
 >> 56;

339 
cmd
 = (
s
->
htif_toho°
 >> 48) & 0xff;

340 i‡(
s
->
htif_toho°
 == 1) {

342 
	`¥ötf
("\nPower off.\n");

343 
	`exô
(0);

344 } i‡(
devi˚
 =1 && 
cmd
 == 1) {

345 
	`c⁄sﬁe_wrôe_ch¨
(
s
, s->
htif_toho°
 & 0xff);

346 
s
->
htif_toho°
 = 0;

347 
s
->
htif_‰omho°
 = ((
uöt64_t
)
devi˚
 << 56Ë| ((uöt64_t)
cmd
 << 48);

348 } i‡(
devi˚
 =1 && 
cmd
 == 0) {

350 
s
->
htif_toho°
 = 0;

352 
	`¥ötf
("HTIF: unsuµ‹ãdÅoho°=0x%016" 
PRIx64
 "\n", 
s
->
htif_toho°
);

354 
	}
}

356 
	$htif_wrôe
(*
›aque
, 
uöt32_t
 
off£t
, uöt32_à
vÆ
,

357 
size_log2
)

359 
RISCVMachöe
 *
s
 = 
›aque
;

361 
	`as£π
(
size_log2
 == 2);

362 
off£t
) {

364 
s
->
htif_toho°
 = (s->htif_toho° & ~0xffffffffË| 
vÆ
;

367 
s
->
htif_toho°
 = (s->htif_toho° & 0xffffffffË| ((
uöt64_t
)
vÆ
 << 32);

368 
	`htif_h™dÀ_cmd
(
s
);

371 
s
->
htif_‰omho°
 = (s->htif_‰omho° & ~0xffffffffË| 
vÆ
;

374 
s
->
htif_‰omho°
 = (s->htif_fromhost & 0xffffffff) |

375 (
uöt64_t
)
vÆ
 << 32;

380 
	}
}

383 
	$htif_pﬁl
(
RISCVMachöe
 *
s
)

385 
uöt8_t
 
buf
[1];

386 
ªt
;

388 i‡(
s
->
htif_‰omho°
 == 0) {

389 
ªt
 = 
s
->
c⁄sﬁe
->
	`ªad_d©a
(s->c⁄sﬁe->
›aque
, 
buf
, 1);

390 i‡(
ªt
 == 1) {

391 
s
->
htif_‰omho°
 = ((
uöt64_t
)1 << 56) | ((uint64_t)0 << 48) |

392 
buf
[0];

395 
	}
}

401 
uöt32_t
 
	$˛öt_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

403 
RISCVMachöe
 *
m
 = 
›aque
;

404 
uöt32_t
 
vÆ
;

406 
	`as£π
(
size_log2
 == 2);

407 
off£t
) {

409 
vÆ
 = 
	`πc_gë_time
(
m
);

412 
vÆ
 = 
	`πc_gë_time
(
m
) >> 32;

415 
vÆ
 = 
m
->
timecmp
;

418 
vÆ
 = 
m
->
timecmp
 >> 32;

421 
vÆ
 = 0;

424  
vÆ
;

425 
	}
}

427 
	$˛öt_wrôe
(*
›aque
, 
uöt32_t
 
off£t
, uöt32_à
vÆ
,

428 
size_log2
)

430 
RISCVMachöe
 *
m
 = 
›aque
;

432 
	`as£π
(
size_log2
 == 2);

433 
off£t
) {

435 
m
->
timecmp
 = (m->timecm∞& ~0xffffffffË| 
vÆ
;

436 
	`riscv_˝u_ª£t_mù
(
m
->
˝u_°©e
, 
MIP_MTIP
);

439 
m
->
timecmp
 = (m->timecm∞& 0xffffffffË| ((
uöt64_t
)
vÆ
 << 32);

440 
	`riscv_˝u_ª£t_mù
(
m
->
˝u_°©e
, 
MIP_MTIP
);

445 
	}
}

450 
	$∂ic_upd©e_mù
(
RISCVMachöe
 *
s
)

452 
RISCVCPUSèã
 *
˝u
 = 
s
->
˝u_°©e
;

453 
uöt32_t
 
mask
;

454 
mask
 = 
s
->
∂ic_≥ndög_úq
 & ~s->
∂ic_£rved_úq
;

455 i‡(
mask
) {

456 
	`riscv_˝u_£t_mù
(
˝u
, 
MIP_MEIP
 | 
MIP_SEIP
);

458 
	`riscv_˝u_ª£t_mù
(
˝u
, 
MIP_MEIP
 | 
MIP_SEIP
);

460 
	}
}

462 
	#PLIC_HART_BASE
 0x200000

	)

463 
	#PLIC_HART_SIZE
 0x1000

	)

465 
uöt32_t
 
	$∂ic_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

467 
RISCVMachöe
 *
s
 = 
›aque
;

468 
uöt32_t
 
vÆ
, 
mask
;

469 
i
;

470 
	`as£π
(
size_log2
 == 2);

471 
off£t
) {

472 
PLIC_HART_BASE
:

473 
vÆ
 = 0;

475 
PLIC_HART_BASE
 + 4:

476 
mask
 = 
s
->
∂ic_≥ndög_úq
 & ~s->
∂ic_£rved_úq
;

477 i‡(
mask
 != 0) {

478 
i
 = 
	`˘z32
(
mask
);

479 
s
->
∂ic_£rved_úq
 |1 << 
i
;

480 
	`∂ic_upd©e_mù
(
s
);

481 
vÆ
 = 
i
 + 1;

483 
vÆ
 = 0;

487 
vÆ
 = 0;

490  
vÆ
;

491 
	}
}

493 
	$∂ic_wrôe
(*
›aque
, 
uöt32_t
 
off£t
, uöt32_à
vÆ
,

494 
size_log2
)

496 
RISCVMachöe
 *
s
 = 
›aque
;

498 
	`as£π
(
size_log2
 == 2);

499 
off£t
) {

500 
PLIC_HART_BASE
 + 4:

501 
vÆ
--;

502 i‡(
vÆ
 < 32) {

503 
s
->
∂ic_£rved_úq
 &~(1 << 
vÆ
);

504 
	`∂ic_upd©e_mù
(
s
);

510 
	}
}

512 
	$∂ic_£t_úq
(*
›aque
, 
úq_num
, 
°©e
)

514 
RISCVMachöe
 *
s
 = 
›aque
;

515 
uöt32_t
 
mask
;

517 
mask
 = 1 << (
úq_num
 - 1);

518 i‡(
°©e
)

519 
s
->
∂ic_≥ndög_úq
 |
mask
;

521 
s
->
∂ic_≥ndög_úq
 &~
mask
;

522 
	`∂ic_upd©e_mù
(
s
);

523 
	}
}

527 
uöt8_t
 *
	$gë_øm_±r
(
RISCVMachöe
 *
s
, 
uöt64_t
 
∑ddr
, 
BOOL
 
is_rw
)

529  
	`phys_mem_gë_øm_±r
(
s
->
mem_m≠
, 
∑ddr
, 
is_rw
);

530 
	}
}

537 
	#FDT_MAGIC
 0xd00d„ed

	)

538 
	#FDT_VERSION
 17

	)

540 
	sfdt_hódî
 {

541 
uöt32_t
 
	mmagic
;

542 
uöt32_t
 
	mtŸÆsize
;

543 
uöt32_t
 
	moff_dt_°ru˘
;

544 
uöt32_t
 
	moff_dt_°rögs
;

545 
uöt32_t
 
	moff_mem_rsvm≠
;

546 
uöt32_t
 
	mvîsi⁄
;

547 
uöt32_t
 
	mœ°_comp_vîsi⁄
;

548 
uöt32_t
 
	mboŸ_˝uid_phys
;

549 
uöt32_t
 
	msize_dt_°rögs
;

550 
uöt32_t
 
	msize_dt_°ru˘
;

553 
	sfdt_ª£rve_íåy
 {

554 
uöt64_t
 
	maddªss
;

555 
uöt64_t
 
	msize
;

558 
	#FDT_BEGIN_NODE
 1

	)

559 
	#FDT_END_NODE
 2

	)

560 
	#FDT_PROP
 3

	)

561 
	#FDT_NOP
 4

	)

562 
	#FDT_END
 9

	)

565 
uöt32_t
 *
	mèb
;

566 
	mèb_Àn
;

567 
	mèb_size
;

568 
	m›í_node_cou¡
;

570 *
	m°rög_èbÀ
;

571 
	m°rög_èbÀ_Àn
;

572 
	m°rög_èbÀ_size
;

573 } 
	tFDTSèã
;

575 
FDTSèã
 *
	$fdt_öô
()

577 
FDTSèã
 *
s
;

578 
s
 = 
	`mÆlocz
((*s));

579  
s
;

580 
	}
}

582 
	$fdt_Æloc_Àn
(
FDTSèã
 *
s
, 
Àn
)

584 
√w_size
;

585 i‡(
	`u∆ikñy
(
Àn
 > 
s
->
èb_size
)) {

586 
√w_size
 = 
	`max_öt
(
Àn
, 
s
->
èb_size
 * 3 / 2);

587 
s
->
èb
 = 
	`ªÆloc
(s->èb, 
√w_size
 * (
uöt32_t
));

588 
s
->
èb_size
 = 
√w_size
;

590 
	}
}

592 
	$fdt_put32
(
FDTSèã
 *
s
, 
v
)

594 
	`fdt_Æloc_Àn
(
s
, s->
èb_Àn
 + 1);

595 
s
->
èb
[s->
èb_Àn
++] = 
	`˝u_to_be32
(
v
);

596 
	}
}

599 
	$fdt_put_d©a
(
FDTSèã
 *
s
, c⁄° 
uöt8_t
 *
d©a
, 
Àn
)

601 
Àn1
;

603 
Àn1
 = (
Àn
 + 3) / 4;

604 
	`fdt_Æloc_Àn
(
s
, s->
èb_Àn
 + 
Àn1
);

605 
	`mem˝y
(
s
->
èb
 + s->
èb_Àn
, 
d©a
, 
Àn
);

606 
	`mem£t
((
uöt8_t
 *)(
s
->
èb
 + s->
èb_Àn
Ë+ 
Àn
, 0, -len & 3);

607 
s
->
èb_Àn
 +
Àn1
;

608 
	}
}

610 
	$fdt_begö_node
(
FDTSèã
 *
s
, c⁄° *
«me
)

612 
	`fdt_put32
(
s
, 
FDT_BEGIN_NODE
);

613 
	`fdt_put_d©a
(
s
, (
uöt8_t
 *)
«me
, 
	`°æí
(name) + 1);

614 
s
->
›í_node_cou¡
++;

615 
	}
}

617 
	$fdt_begö_node_num
(
FDTSèã
 *
s
, c⁄° *
«me
, 
uöt64_t
 
n
)

619 
buf
[256];

620 
	`¢¥ötf
(
buf
, (buf), "%s@%" 
PRIx64
, 
«me
, 
n
);

621 
	`fdt_begö_node
(
s
, 
buf
);

622 
	}
}

624 
	$fdt_íd_node
(
FDTSèã
 *
s
)

626 
	`fdt_put32
(
s
, 
FDT_END_NODE
);

627 
s
->
›í_node_cou¡
--;

628 
	}
}

630 
	$fdt_gë_°rög_off£t
(
FDTSèã
 *
s
, c⁄° *
«me
)

632 
pos
, 
√w_size
, 
«me_size
, 
√w_Àn
;

634 
pos
 = 0;

635 
pos
 < 
s
->
°rög_èbÀ_Àn
) {

636 i‡(!
	`°rcmp
(
s
->
°rög_èbÀ
 + 
pos
, 
«me
))

637  
pos
;

638 
pos
 +
	`°æí
(
s
->
°rög_èbÀ
 +Öos) + 1;

641 
«me_size
 = 
	`°æí
(
«me
) + 1;

642 
√w_Àn
 = 
s
->
°rög_èbÀ_Àn
 + 
«me_size
;

643 i‡(
√w_Àn
 > 
s
->
°rög_èbÀ_size
) {

644 
√w_size
 = 
	`max_öt
(
√w_Àn
, 
s
->
°rög_èbÀ_size
 * 3 / 2);

645 
s
->
°rög_èbÀ
 = 
	`ªÆloc
(s->°rög_èbÀ, 
√w_size
);

646 
s
->
°rög_èbÀ_size
 = 
√w_size
;

648 
pos
 = 
s
->
°rög_èbÀ_Àn
;

649 
	`mem˝y
(
s
->
°rög_èbÀ
 + 
pos
, 
«me
, 
«me_size
);

650 
s
->
°rög_èbÀ_Àn
 = 
√w_Àn
;

651  
pos
;

652 
	}
}

654 
	$fdt_¥›
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
,

655 c⁄° *
d©a
, 
d©a_Àn
)

657 
	`fdt_put32
(
s
, 
FDT_PROP
);

658 
	`fdt_put32
(
s
, 
d©a_Àn
);

659 
	`fdt_put32
(
s
, 
	`fdt_gë_°rög_off£t
(s, 
¥›_«me
));

660 
	`fdt_put_d©a
(
s
, 
d©a
, 
d©a_Àn
);

661 
	}
}

663 
	$fdt_¥›_èb_u32
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
,

664 
uöt32_t
 *
èb
, 
èb_Àn
)

666 
i
;

667 
	`fdt_put32
(
s
, 
FDT_PROP
);

668 
	`fdt_put32
(
s
, 
èb_Àn
 * (
uöt32_t
));

669 
	`fdt_put32
(
s
, 
	`fdt_gë_°rög_off£t
(s, 
¥›_«me
));

670 
i
 = 0; i < 
èb_Àn
; i++)

671 
	`fdt_put32
(
s
, 
èb
[
i
]);

672 
	}
}

674 
	$fdt_¥›_u32
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
, 
uöt32_t
 
vÆ
)

676 
	`fdt_¥›_èb_u32
(
s
, 
¥›_«me
, &
vÆ
, 1);

677 
	}
}

679 
	$fdt_¥›_èb_u64
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
,

680 
uöt64_t
 
v0
)

682 
uöt32_t
 
èb
[2];

683 
èb
[0] = 
v0
 >> 32;

684 
èb
[1] = 
v0
;

685 
	`fdt_¥›_èb_u32
(
s
, 
¥›_«me
, 
èb
, 2);

686 
	}
}

688 
	$fdt_¥›_èb_u64_2
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
,

689 
uöt64_t
 
v0
, uöt64_à
v1
)

691 
uöt32_t
 
èb
[4];

692 
èb
[0] = 
v0
 >> 32;

693 
èb
[1] = 
v0
;

694 
èb
[2] = 
v1
 >> 32;

695 
èb
[3] = 
v1
;

696 
	`fdt_¥›_èb_u32
(
s
, 
¥›_«me
, 
èb
, 4);

697 
	}
}

699 
	$fdt_¥›_°r
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
,

700 c⁄° *
°r
)

702 
	`fdt_¥›
(
s
, 
¥›_«me
, 
°r
, 
	`°æí
(str) + 1);

703 
	}
}

706 
	$fdt_¥›_èb_°r
(
FDTSèã
 *
s
, c⁄° *
¥›_«me
,

709 
va_li°
 
≠
;

710 
size
, 
°r_size
;

711 *
±r
, *
èb
;

713 
	`va_°¨t
(
≠
, 
¥›_«me
);

714 
size
 = 0;

716 
±r
 = 
	`va_¨g
(
≠
, *);

717 i‡(!
±r
)

719 
°r_size
 = 
	`°æí
(
±r
) + 1;

720 
size
 +
°r_size
;

722 
	`va_íd
(
≠
);

724 
èb
 = 
	`mÆloc
(
size
);

725 
	`va_°¨t
(
≠
, 
¥›_«me
);

726 
size
 = 0;

728 
±r
 = 
	`va_¨g
(
≠
, *);

729 i‡(!
±r
)

731 
°r_size
 = 
	`°æí
(
±r
) + 1;

732 
	`mem˝y
(
èb
 + 
size
, 
±r
, 
°r_size
);

733 
size
 +
°r_size
;

735 
	`va_íd
(
≠
);

737 
	`fdt_¥›
(
s
, 
¥›_«me
, 
èb
, 
size
);

738 
	`‰ì
(
èb
);

739 
	}
}

742 
	$fdt_ouçut
(
FDTSèã
 *
s
, 
uöt8_t
 *
d°
)

744 
fdt_hódî
 *
h
;

745 
fdt_ª£rve_íåy
 *
ª
;

746 
dt_°ru˘_size
;

747 
dt_°rögs_size
;

748 
pos
;

750 
	`as£π
(
s
->
›í_node_cou¡
 == 0);

752 
	`fdt_put32
(
s
, 
FDT_END
);

754 
dt_°ru˘_size
 = 
s
->
èb_Àn
 * (
uöt32_t
);

755 
dt_°rögs_size
 = 
s
->
°rög_èbÀ_Àn
;

757 
h
 = (
fdt_hódî
 *)
d°
;

758 
h
->
magic
 = 
	`˝u_to_be32
(
FDT_MAGIC
);

759 
h
->
vîsi⁄
 = 
	`˝u_to_be32
(
FDT_VERSION
);

760 
h
->
œ°_comp_vîsi⁄
 = 
	`˝u_to_be32
(16);

761 
h
->
boŸ_˝uid_phys
 = 
	`˝u_to_be32
(0);

762 
h
->
size_dt_°rögs
 = 
	`˝u_to_be32
(
dt_°rögs_size
);

763 
h
->
size_dt_°ru˘
 = 
	`˝u_to_be32
(
dt_°ru˘_size
);

765 
pos
 = (
fdt_hódî
);

767 
h
->
off_dt_°ru˘
 = 
	`˝u_to_be32
(
pos
);

768 
	`mem˝y
(
d°
 + 
pos
, 
s
->
èb
, 
dt_°ru˘_size
);

769 
pos
 +
dt_°ru˘_size
;

772 (
pos
 & 7) != 0) {

773 
d°
[
pos
++] = 0;

775 
h
->
off_mem_rsvm≠
 = 
	`˝u_to_be32
(
pos
);

776 
ª
 = (
fdt_ª£rve_íåy
 *)(
d°
 + 
pos
);

777 
ª
->
addªss
 = 0;

778 
ª
->
size
 = 0;

779 
pos
 +(
fdt_ª£rve_íåy
);

781 
h
->
off_dt_°rögs
 = 
	`˝u_to_be32
(
pos
);

782 
	`mem˝y
(
d°
 + 
pos
, 
s
->
°rög_èbÀ
, 
dt_°rögs_size
);

783 
pos
 +
dt_°rögs_size
;

786 (
pos
 & 7) != 0) {

787 
d°
[
pos
++] = 0;

790 
h
->
tŸÆsize
 = 
	`˝u_to_be32
(
pos
);

791  
pos
;

792 
	}
}

794 
	$fdt_íd
(
FDTSèã
 *
s
)

796 
	`‰ì
(
s
->
èb
);

797 
	`‰ì
(
s
->
°rög_èbÀ
);

798 
	`‰ì
(
s
);

799 
	}
}

801 
	$riscv_buûd_fdt
(
RISCVMachöe
 *
m
, 
uöt8_t
 *
d°
,

802 
uöt64_t
 
kî√l_°¨t
, uöt64_à
kî√l_size
,

803 
uöt64_t
 
öôrd_°¨t
, uöt64_à
öôrd_size
,

804 c⁄° *
cmd_löe
)

806 
FDTSèã
 *
s
;

807 
size
, 
max_xÀn
, 
i
, 
cur_ph™dÀ
, 
ötc_ph™dÀ
, 
∂ic_ph™dÀ
;

808 
iß_°rög
[128], *
q
;

809 
uöt32_t
 
miß
;

810 
uöt32_t
 
èb
[4];

811 
FBDevi˚
 *
fb_dev
;

813 
s
 = 
	`fdt_öô
();

815 
cur_ph™dÀ
 = 1;

817 
	`fdt_begö_node
(
s
, "");

818 
	`fdt_¥›_u32
(
s
, "#address-cells", 2);

819 
	`fdt_¥›_u32
(
s
, "#size-cells", 2);

820 
	`fdt_¥›_°r
(
s
, "compatible", "ucbbar,riscvemu-bar_dev");

821 
	`fdt_¥›_°r
(
s
, "model", "ucbbar,riscvemu-bare");

824 
	`fdt_begö_node
(
s
, "cpus");

825 
	`fdt_¥›_u32
(
s
, "#address-cells", 1);

826 
	`fdt_¥›_u32
(
s
, "#size-cells", 0);

827 
	`fdt_¥›_u32
(
s
, "timeba£-‰equícy", 
RTC_FREQ
);

830 
	`fdt_begö_node_num
(
s
, "cpu", 0);

831 
	`fdt_¥›_°r
(
s
, "device_type", "cpu");

832 
	`fdt_¥›_u32
(
s
, "reg", 0);

833 
	`fdt_¥›_°r
(
s
, "status", "okay");

834 
	`fdt_¥›_°r
(
s
, "compatible", "riscv");

836 
max_xÀn
 = 
m
->max_xlen;

837 
miß
 = 
	`riscv_˝u_gë_miß
(
m
->
˝u_°©e
);

838 
q
 = 
iß_°rög
;

839 
q
 +
	`¢¥ötf
(
iß_°rög
, (iß_°rög), "rv%d", 
max_xÀn
);

840 
i
 = 0; i < 26; i++) {

841 i‡(
miß
 & (1 << 
i
))

842 *
q
++ = 'a' + 
i
;

844 *
q
 = '\0';

845 
	`fdt_¥›_°r
(
s
, "riscv,iß", 
iß_°rög
);

847 
	`fdt_¥›_°r
(
s
, "mmu-ty≥", 
max_xÀn
 <= 32 ? "riscv,sv32" : "riscv,sv48");

848 
	`fdt_¥›_u32
(
s
, "clock-frequency", 2000000000);

850 
	`fdt_begö_node
(
s
, "interrupt-controller");

851 
	`fdt_¥›_u32
(
s
, "#interrupt-cells", 1);

852 
	`fdt_¥›
(
s
, "öãºu±-c⁄åﬁÀr", 
NULL
, 0);

853 
	`fdt_¥›_°r
(
s
, "compatible", "riscv,cpu-intc");

854 
ötc_ph™dÀ
 = 
cur_ph™dÀ
++;

855 
	`fdt_¥›_u32
(
s
, "ph™dÀ", 
ötc_ph™dÀ
);

856 
	`fdt_íd_node
(
s
);

858 
	`fdt_íd_node
(
s
);

860 
	`fdt_íd_node
(
s
);

862 
	`fdt_begö_node_num
(
s
, "mem‹y", 
RAM_BASE_ADDR
);

863 
	`fdt_¥›_°r
(
s
, "device_type", "memory");

864 
èb
[0] = (
uöt64_t
)
RAM_BASE_ADDR
 >> 32;

865 
èb
[1] = 
RAM_BASE_ADDR
;

866 
èb
[2] = 
m
->
øm_size
 >> 32;

867 
èb
[3] = 
m
->
øm_size
;

868 
	`fdt_¥›_èb_u32
(
s
, "ªg", 
èb
, 4);

870 
	`fdt_íd_node
(
s
);

872 
	`fdt_begö_node
(
s
, "soc");

873 
	`fdt_¥›_u32
(
s
, "#address-cells", 2);

874 
	`fdt_¥›_u32
(
s
, "#size-cells", 2);

875 
	`fdt_¥›_èb_°r
(
s
, "compatible",

876 "ucbb¨,riscvemu-b¨-soc", "sim∂e-bus", 
NULL
);

877 
	`fdt_¥›
(
s
, "ønges", 
NULL
, 0);

879 
	`fdt_begö_node_num
(
s
, "˛öt", 
CLINT_BASE_ADDR
);

880 
	`fdt_¥›_°r
(
s
, "compatible", "riscv,clint0");

882 
èb
[0] = 
ötc_ph™dÀ
;

883 
èb
[1] = 3;

884 
èb
[2] = 
ötc_ph™dÀ
;

885 
èb
[3] = 7;

886 
	`fdt_¥›_èb_u32
(
s
, "öãºu±s-exãnded", 
èb
, 4);

888 
	`fdt_¥›_èb_u64_2
(
s
, "ªg", 
CLINT_BASE_ADDR
, 
CLINT_SIZE
);

890 
	`fdt_íd_node
(
s
);

892 
	`fdt_begö_node_num
(
s
, "∂ic", 
PLIC_BASE_ADDR
);

893 
	`fdt_¥›_u32
(
s
, "#interrupt-cells", 1);

894 
	`fdt_¥›
(
s
, "öãºu±-c⁄åﬁÀr", 
NULL
, 0);

895 
	`fdt_¥›_°r
(
s
, "compatible", "riscv,plic0");

896 
	`fdt_¥›_u32
(
s
, "riscv,ndev", 31);

897 
	`fdt_¥›_èb_u64_2
(
s
, "ªg", 
PLIC_BASE_ADDR
, 
PLIC_SIZE
);

899 
èb
[0] = 
ötc_ph™dÀ
;

900 
èb
[1] = 9;

901 
èb
[2] = 
ötc_ph™dÀ
;

902 
èb
[3] = 11;

903 
	`fdt_¥›_èb_u32
(
s
, "öãºu±s-exãnded", 
èb
, 4);

905 
∂ic_ph™dÀ
 = 
cur_ph™dÀ
++;

906 
	`fdt_¥›_u32
(
s
, "ph™dÀ", 
∂ic_ph™dÀ
);

908 
	`fdt_íd_node
(
s
);

910 
i
 = 0; i < 
m
->
vútio_cou¡
; i++) {

911 
	`fdt_begö_node_num
(
s
, "vútio", 
VIRTIO_BASE_ADDR
 + 
i
 * 
VIRTIO_SIZE
);

912 
	`fdt_¥›_°r
(
s
, "compatible", "virtio,mmio");

913 
	`fdt_¥›_èb_u64_2
(
s
, "ªg", 
VIRTIO_BASE_ADDR
 + 
i
 * 
VIRTIO_SIZE
,

914 
VIRTIO_SIZE
);

915 
èb
[0] = 
∂ic_ph™dÀ
;

916 
èb
[1] = 
VIRTIO_IRQ
 + 
i
;

917 
	`fdt_¥›_èb_u32
(
s
, "öãºu±s-exãnded", 
èb
, 2);

918 
	`fdt_íd_node
(
s
);

921 
fb_dev
 = 
m
->
comm⁄
.fb_dev;

922 i‡(
fb_dev
) {

923 
	`fdt_begö_node_num
(
s
, "‰amebuf„r", 
FRAMEBUFFER_BASE_ADDR
);

924 
	`fdt_¥›_°r
(
s
, "compatible", "simple-framebuffer");

925 
	`fdt_¥›_èb_u64_2
(
s
, "ªg", 
FRAMEBUFFER_BASE_ADDR
, 
fb_dev
->
fb_size
);

926 
	`fdt_¥›_u32
(
s
, "width", 
fb_dev
->
width
);

927 
	`fdt_¥›_u32
(
s
, "height", 
fb_dev
->
height
);

928 
	`fdt_¥›_u32
(
s
, "°ride", 
fb_dev
->
°ride
);

929 
	`fdt_¥›_°r
(
s
, "format", "a8r8g8b8");

930 
	`fdt_íd_node
(
s
);

933 
	`fdt_íd_node
(
s
);

935 
	`fdt_begö_node
(
s
, "chosen");

936 
	`fdt_¥›_°r
(
s
, "boŸ¨gs", 
cmd_löe
 ? cmd_line : "");

937 i‡(
kî√l_size
 > 0) {

938 
	`fdt_¥›_èb_u64
(
s
, "riscv,kî√l-°¨t", 
kî√l_°¨t
);

939 
	`fdt_¥›_èb_u64
(
s
, "riscv,kî√l-íd", 
kî√l_°¨t
 + 
kî√l_size
);

941 i‡(
öôrd_size
 > 0) {

942 
	`fdt_¥›_èb_u64
(
s
, "löux,öôrd-°¨t", 
öôrd_°¨t
);

943 
	`fdt_¥›_èb_u64
(
s
, "löux,öôrd-íd", 
öôrd_°¨t
 + 
öôrd_size
);

947 
	`fdt_íd_node
(
s
);

950 
	`fdt_begö_node_num
(
s
, "u¨t", 
UART_BASE_ADDR
);

951 
èb
[0] = 
∂ic_ph™dÀ
;

952 
èb
[1] = 
UART_IRQ
;

953 
	`fdt_¥›_èb_u32
(
s
, "öãºu±s-exãnded", 
èb
, 2);

956 
	`fdt_¥›_u32
(
s
, "clock-frequency", 384000);

957 
	`fdt_¥›_èb_u64_2
(
s
, "ªg", 
UART_BASE_ADDR
, 0x100);

958 
	`fdt_¥›_°r
(
s
, "compatible", "ns16550a");

959 
	`fdt_íd_node
(
s
);

963 
	`fdt_begö_node
(
s
, "htif");

964 
	`fdt_¥›_°r
(
s
, "compatible", "ucb,htif0");

965 
	`fdt_íd_node
(
s
);

968 
	`fdt_íd_node
(
s
);

970 
size
 = 
	`fdt_ouçut
(
s
, 
d°
);

973 
FILE
 *
f
;

974 
f
 = 
	`f›í
("/tmp/riscvemu.dtb", "wb");

975 
	`fwrôe
(
d°
, 1, 
size
, 
f
);

976 
	`f˛o£
(
f
);

979 
	`fdt_íd
(
s
);

980  
size
;

981 
	}
}

985 
	$c›y_kî√l
(
RISCVMachöe
 *
s
, c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
,

986 c⁄° *
cmd_löe
)

988 
uöt32_t
 
fdt_addr
;

989 
uöt8_t
 *
øm_±r
;

990 
uöt32_t
 *
q
;

992 i‡(
buf_Àn
 > 
s
->
øm_size
) {

993 
	`vm_îr‹
("KernelÅoo big\n");

994 
	`exô
(1);

997 
øm_±r
 = 
	`gë_øm_±r
(
s
, 
RAM_BASE_ADDR
, 
TRUE
);

998 
	`mem˝y
(
øm_±r
, 
buf
, 
buf_Àn
);

1000 
øm_±r
 = 
	`gë_øm_±r
(
s
, 0, 
TRUE
);

1002 
fdt_addr
 = 0x1000 + 8 * 8;

1004 
	`riscv_buûd_fdt
(
s
, 
øm_±r
 + 
fdt_addr
, 0, 0, 0, 0, 
cmd_löe
);

1008 
q
 = (
uöt32_t
 *)(
øm_±r
 + 0x1000);

1009 
q
[0] = 0x297 + 0x80000000 - 0x1000;

1010 
q
[1] = 0x597;

1011 
q
[2] = 0x58593 + ((
fdt_addr
 - 4) << 20);

1012 
q
[3] = 0xf1402573;

1013 
q
[4] = 0x00028067;

1014 
	}
}

1016 
	$c›y_bios
(
RISCVMachöe
 *
s
, c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
,

1017 c⁄° 
uöt8_t
 *
kî√l_buf
, 
kî√l_buf_Àn
,

1018 c⁄° 
uöt8_t
 *
öôrd_buf
, 
öôrd_buf_Àn
,

1019 c⁄° *
cmd_löe
)

1021 
uöt32_t
 
fdt_addr
, 
Æign
, 
kî√l_ba£
, 
öôrd_ba£
;

1022 
uöt8_t
 *
øm_±r
;

1023 
uöt32_t
 *
q
;

1025 i‡(
buf_Àn
 > 
s
->
øm_size
) {

1026 
	`vm_îr‹
("BIOSÅoo big\n");

1027 
	`exô
(1);

1030 
øm_±r
 = 
	`gë_øm_±r
(
s
, 
RAM_BASE_ADDR
, 
TRUE
);

1031 
	`mem˝y
(
øm_±r
, 
buf
, 
buf_Àn
);

1033 
kî√l_ba£
 = 0;

1034 i‡(
kî√l_buf_Àn
 > 0) {

1036 i‡(
s
->
max_xÀn
 == 32)

1037 
Æign
 = 4 << 20;

1039 
Æign
 = 2 << 20;

1040 
kî√l_ba£
 = (
buf_Àn
 + 
Æign
 - 1) & ~(align - 1);

1041 
	`mem˝y
(
øm_±r
 + 
kî√l_ba£
, 
kî√l_buf
, 
kî√l_buf_Àn
);

1042 i‡(
kî√l_buf_Àn
 + 
kî√l_ba£
 > 
s
->
øm_size
) {

1043 
	`vm_îr‹
("kernelÅoo big");

1044 
	`exô
(1);

1048 
öôrd_ba£
 = 0;

1049 i‡(
öôrd_buf_Àn
 > 0) {

1051 
öôrd_ba£
 = 
s
->
øm_size
 / 2;

1052 i‡(
öôrd_ba£
 > (128 << 20))

1053 
öôrd_ba£
 = 128 << 20;

1054 
	`mem˝y
(
øm_±r
 + 
öôrd_ba£
, 
öôrd_buf
, 
öôrd_buf_Àn
);

1055 i‡(
öôrd_buf_Àn
 + 
öôrd_ba£
 > 
s
->
øm_size
) {

1056 
	`vm_îr‹
("initrdÅoo big");

1057 
	`exô
(1);

1061 
øm_±r
 = 
	`gë_øm_±r
(
s
, 0, 
TRUE
);

1063 
fdt_addr
 = 0x1000 + 8 * 8;

1065 
	`riscv_buûd_fdt
(
s
, 
øm_±r
 + 
fdt_addr
,

1066 
RAM_BASE_ADDR
 + 
kî√l_ba£
, 
kî√l_buf_Àn
,

1067 
RAM_BASE_ADDR
 + 
öôrd_ba£
, 
öôrd_buf_Àn
,

1068 
cmd_löe
);

1072 
q
 = (
uöt32_t
 *)(
øm_±r
 + 0x1000);

1073 
q
[0] = 0x297 + 0x80000000 - 0x1000;

1074 
q
[1] = 0x597;

1075 
q
[2] = 0x58593 + ((
fdt_addr
 - 4) << 20);

1076 
q
[3] = 0xf1402573;

1077 
q
[4] = 0x00028067;

1078 
	}
}

1080 
	$riscv_Êush_éb_wrôe_ønge
(*
›aque
, 
uöt8_t
 *
øm_addr
,

1081 
size_t
 
øm_size
)

1083 
RISCVMachöe
 *
s
 = 
›aque
;

1084 
	`riscv_˝u_Êush_éb_wrôe_ønge_øm
(
s
->
˝u_°©e
, 
øm_addr
, 
øm_size
);

1085 
	}
}

1087 
	$riscv_machöe_£t_deÁu…s
(
VútMachöeP¨ams
 *
p
)

1089 
	}
}

1091 
VútMachöe
 *
	$riscv_machöe_öô
(c⁄° 
VútMachöeP¨ams
 *
p
)

1093 
RISCVMachöe
 *
s
;

1094 
VIRTIODevi˚
 *
blk_dev
;

1095 
úq_num
, 
i
, 
max_xÀn
, 
øm_Êags
;

1096 
VIRTIOBusDef
 
vbus_s
, *
vbus
 = &vbus_s;

1099 i‡(!
	`°rcmp
(
p
->
machöe_«me
, "riscv32")) {

1100 
max_xÀn
 = 32;

1101 } i‡(!
	`°rcmp
(
p
->
machöe_«me
, "riscv64")) {

1102 
max_xÀn
 = 64;

1103 } i‡(!
	`°rcmp
(
p
->
machöe_«me
, "riscv128")) {

1104 
max_xÀn
 = 128;

1106 
	`vm_îr‹
("unsuµ‹ãd machöe: %s\n", 
p
->
machöe_«me
);

1107  
NULL
;

1110 
s
 = 
	`mÆlocz
((*s));

1111 
s
->
comm⁄
.
vmc
 = 
p
->vmc;

1112 
s
->
øm_size
 = 
p
->ram_size;

1113 
s
->
max_xÀn
 = max_xlen;

1114 
s
->
mem_m≠
 = 
	`phys_mem_m≠_öô
();

1116 
s
->
mem_m≠
->
›aque
 = s;

1117 
s
->
mem_m≠
->
Êush_éb_wrôe_ønge
 = 
riscv_Êush_éb_wrôe_ønge
;

1119 
s
->
comm⁄
.
vút_machöe_∑øms
 = (
VútMachöeP¨ams
 *)
p
;

1122 
	`sim_∑øms_vÆid©e
(
p
->
sim_∑øms
);

1124 
s
->
˝u_°©e
 = 
	`riscv_˝u_öô
(s->
mem_m≠
, 
max_xÀn
, 
p
->
sim_∑øms
);

1125 i‡(!
s
->
˝u_°©e
) {

1126 
	`vm_îr‹
("unsuµ‹ãd max_xÀn=%d\n", 
max_xÀn
);

1128  
NULL
;

1131 
øm_Êags
 = 0;

1132 
	`˝u_ªgi°î_øm
(
s
->
mem_m≠
, 
RAM_BASE_ADDR
, 
p
->
øm_size
, 
øm_Êags
);

1133 
	`˝u_ªgi°î_øm
(
s
->
mem_m≠
, 0x00000000, 
LOW_RAM_SIZE
, 0);

1134 
s
->
πc_ªÆ_time
 = 
p
->rtc_real_time;

1135 i‡(
p
->
πc_ªÆ_time
) {

1136 
s
->
πc_°¨t_time
 = 
	`πc_gë_ªÆ_time
(s);

1139 
	`˝u_ªgi°î_devi˚
(
s
->
mem_m≠
, 
CLINT_BASE_ADDR
, 
CLINT_SIZE
, s,

1140 
˛öt_ªad
, 
˛öt_wrôe
, 
DEVIO_SIZE32
);

1141 
	`˝u_ªgi°î_devi˚
(
s
->
mem_m≠
, 
PLIC_BASE_ADDR
, 
PLIC_SIZE
, s,

1142 
∂ic_ªad
, 
∂ic_wrôe
, 
DEVIO_SIZE32
);

1143 
i
 = 1; i < 32; i++) {

1144 
	`úq_öô
(&
s
->
∂ic_úq
[
i
], 
∂ic_£t_úq
, s, i);

1147 
	`˝u_ªgi°î_devi˚
(
s
->
mem_m≠
, 
UART_BASE_ADDR
, 16,

1148 
s
, 
u¨t_ªad
, 
u¨t_wrôe
, 
DEVIO_SIZE8
);

1149 
	`˝u_ªgi°î_devi˚
(
s
->
mem_m≠
, 
HTIF_BASE_ADDR
, 16,

1150 
s
, 
htif_ªad
, 
htif_wrôe
, 
DEVIO_SIZE32
);

1151 
s
->
comm⁄
.
c⁄sﬁe
 = 
p
->console;

1153 
	`mem£t
(
vbus
, 0, (*vbus));

1154 
vbus
->
mem_m≠
 = 
s
->mem_map;

1155 
vbus
->
addr
 = 
VIRTIO_BASE_ADDR
;

1156 
úq_num
 = 
VIRTIO_IRQ
;

1159 i‡(
p
->
c⁄sﬁe
) {

1160 
vbus
->
úq
 = &
s
->
∂ic_úq
[
úq_num
];

1161 
s
->
comm⁄
.
c⁄sﬁe_dev
 = 
	`vútio_c⁄sﬁe_öô
(
vbus
, 
p
->
c⁄sﬁe
);

1162 
vbus
->
addr
 +
VIRTIO_SIZE
;

1163 
úq_num
++;

1164 
s
->
vútio_cou¡
++;

1168 
i
 = 0; i < 
p
->
ëh_cou¡
; i++) {

1169 
vbus
->
úq
 = &
s
->
∂ic_úq
[
úq_num
];

1170 
	`vútio_√t_öô
(
vbus
, 
p
->
èb_ëh
[
i
].
√t
);

1171 
s
->
comm⁄
.
√t
 = 
p
->
èb_ëh
[
i
].net;

1172 
vbus
->
addr
 +
VIRTIO_SIZE
;

1173 
úq_num
++;

1174 
s
->
vútio_cou¡
++;

1178 
i
 = 0; i < 
p
->
drive_cou¡
; i++) {

1179 
vbus
->
úq
 = &
s
->
∂ic_úq
[
úq_num
];

1180 
blk_dev
 = 
	`vútio_block_öô
(
vbus
, 
p
->
èb_drive
[
i
].
block_dev
);

1181 ()
blk_dev
;

1182 
vbus
->
addr
 +
VIRTIO_SIZE
;

1183 
úq_num
++;

1184 
s
->
vútio_cou¡
++;

1188 
i
 = 0; i < 
p
->
fs_cou¡
; i++) {

1189 
VIRTIODevi˚
 *
fs_dev
;

1190 
vbus
->
úq
 = &
s
->
∂ic_úq
[
úq_num
];

1191 
fs_dev
 = 
	`vútio_9p_öô
(
vbus
, 
p
->
èb_fs
[
i
].fs_dev,

1192 
p
->
èb_fs
[
i
].
èg
);

1193 ()
fs_dev
;

1195 
vbus
->
addr
 +
VIRTIO_SIZE
;

1196 
úq_num
++;

1197 
s
->
vútio_cou¡
++;

1200 i‡(
p
->
di•œy_devi˚
) {

1201 
FBDevi˚
 *
fb_dev
;

1202 
fb_dev
 = 
	`mÆlocz
((*fb_dev));

1203 
s
->
comm⁄
.
fb_dev
 = fb_dev;

1204 i‡(!
	`°rcmp
(
p
->
di•œy_devi˚
, "simplefb")) {

1205 
	`sim∂efb_öô
(
s
->
mem_m≠
,

1206 
FRAMEBUFFER_BASE_ADDR
,

1207 
fb_dev
,

1208 
p
->
width
,Ö->
height
);

1211 
	`vm_îr‹
("unsuµ‹ãd di•œy devi˚: %s\n", 
p
->
di•œy_devi˚
);

1212 
	`exô
(1);

1216 i‡(
p
->
öput_devi˚
) {

1217 i‡(!
	`°rcmp
(
p
->
öput_devi˚
, "virtio")) {

1218 
vbus
->
úq
 = &
s
->
∂ic_úq
[
úq_num
];

1219 
s
->
keybﬂrd_dev
 = 
	`vútio_öput_öô
(
vbus
,

1220 
VIRTIO_INPUT_TYPE_KEYBOARD
);

1221 
vbus
->
addr
 +
VIRTIO_SIZE
;

1222 
úq_num
++;

1223 
s
->
vútio_cou¡
++;

1225 
vbus
->
úq
 = &
s
->
∂ic_úq
[
úq_num
];

1226 
s
->
mou£_dev
 = 
	`vútio_öput_öô
(
vbus
,

1227 
VIRTIO_INPUT_TYPE_TABLET
);

1228 
vbus
->
addr
 +
VIRTIO_SIZE
;

1229 
úq_num
++;

1230 
s
->
vútio_cou¡
++;

1232 
	`vm_îr‹
("unsuµ‹ãd i≈uàdevi˚: %s\n", 
p
->
öput_devi˚
);

1233 
	`exô
(1);

1237 i‡(!
p
->
fûes
[
VM_FILE_BIOS
].
buf
) {

1238 
	`vm_îr‹
("No bios found");

1241 i‡(
p
->
fûes
[
VM_FILE_KERNEL
].
buf
||Ö->fûes[
VM_FILE_INITRD
].buf) {

1242 
	`c›y_bios
(
s
, 
p
->
fûes
[
VM_FILE_BIOS
].
buf
,Ö->fûes[VM_FILE_BIOS].
Àn
,

1243 
p
->
fûes
[
VM_FILE_KERNEL
].
buf
,Ö->fûes[VM_FILE_KERNEL].
Àn
,

1244 
p
->
fûes
[
VM_FILE_INITRD
].
buf
,Ö->fûes[VM_FILE_INITRD].
Àn
,

1245 
p
->
cmdlöe
);

1247 
	`c›y_kî√l
(
s
, 
p
->
fûes
[
VM_FILE_BIOS
].
buf
,Ö->fûes[VM_FILE_BIOS].
Àn
,

1248 
p
->
cmdlöe
);

1251  (
VútMachöe
 *)
s
;

1252 
	}
}

1254 
	$riscv_machöe_íd
(
VútMachöe
 *
s1
)

1256 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
s1
;

1259 
	`riscv_˝u_íd
(
s
->
˝u_°©e
);

1260 
	`sim_∑øms_‰ì
(
s
->
comm⁄
.
vút_machöe_∑øms
->
sim_∑øms
);

1261 
	`phys_mem_m≠_íd
(
s
->
mem_m≠
);

1262 
	`‰ì
(
s
);

1263 
	}
}

1266 
	$riscv_machöe_gë_¶ìp_duøti⁄
(
VútMachöe
 *
s1
, 
dñay
)

1268 
RISCVMachöe
 *
m
 = (RISCVMachöê*)
s1
;

1269 
RISCVCPUSèã
 *
s
 = 
m
->
˝u_°©e
;

1270 
öt64_t
 
dñay1
;

1273 i‡(!(
	`riscv_˝u_gë_mù
(
s
Ë& 
MIP_MTIP
)) {

1274 
dñay1
 = 
m
->
timecmp
 - 
	`πc_gë_time
(m);

1275 i‡(
dñay1
 <= 0) {

1276 
	`riscv_˝u_£t_mù
(
s
, 
MIP_MTIP
);

1277 
dñay
 = 0;

1280 
dñay1
 = dñay1 / (
RTC_FREQ
 / 1000);

1281 i‡(
dñay1
 < 
dñay
)

1282 
dñay
 = 
dñay1
;

1285 i‡(!
	`riscv_˝u_gë_powî_down
(
s
))

1286 
dñay
 = 0;

1287  
dñay
;

1288 
	}
}

1290 
	$riscv_machöe_öãΩ
(
VútMachöe
 *
s1
, 
max_exec_cy˛e
)

1292 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
s1
;

1293 
	`riscv_˝u_öãΩ
(
s
->
˝u_°©e
, 
max_exec_cy˛e
);

1294 
	}
}

1296 
	$riscv_vm_£nd_key_evít
(
VútMachöe
 *
s1
, 
BOOL
 
is_down
,

1297 
uöt16_t
 
key_code
)

1299 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
s1
;

1300 i‡(
s
->
keybﬂrd_dev
) {

1301 
	`vútio_öput_£nd_key_evít
(
s
->
keybﬂrd_dev
, 
is_down
, 
key_code
);

1303 
	}
}

1305 
BOOL
 
	$riscv_vm_mou£_is_absﬁuã
(
VútMachöe
 *
s
)

1307  
TRUE
;

1308 
	}
}

1310 
	$riscv_vm_£nd_mou£_evít
(
VútMachöe
 *
s1
, 
dx
, 
dy
, 
dz
,

1311 
buâ⁄s
)

1313 
RISCVMachöe
 *
s
 = (RISCVMachöê*)
s1
;

1314 i‡(
s
->
mou£_dev
) {

1315 
	`vútio_öput_£nd_mou£_evít
(
s
->
mou£_dev
, 
dx
, 
dy
, 
dz
, 
buâ⁄s
);

1317 
	}
}

1319 c⁄° 
VútMachöeCœss
 
	griscv_machöe_˛ass
 = {

1321 
riscv_machöe_£t_deÁu…s
,

1322 
riscv_machöe_öô
,

1323 
riscv_machöe_íd
,

1324 
riscv_machöe_gë_¶ìp_duøti⁄
,

1325 
riscv_machöe_öãΩ
,

1326 
riscv_vm_mou£_is_absﬁuã
,

1327 
riscv_vm_£nd_mou£_evít
,

1328 
riscv_vm_£nd_key_evít
,

	@riscvsim/adaptive_predictor.c

30 
	~<as£π.h
>

31 
	~<m©h.h
>

32 
	~<°dlib.h
>

33 
	~<°rög.h
>

35 
	~"ad≠tive_¥edi˘‹.h
"

37 
	#GAG
 0x0

	)

38 
	#GAP
 0x1

	)

39 
	#PAG
 0x2

	)

40 
	#PAP
 0x3

	)

42 
	#GET_SET_ADDR
(
pc
, 
bôs
Ë(
	`GET_INDEX
(’c), (bôs)))

	)

43 
	#UPDATE_GHR
(
ghr
, 
bôs
, 
¥ed
Ë(
	`GET_INDEX
((((ghrË<< 1Ë| (¥ed)), (bôs)))

	)

45 
	#PRED_NOT_TAKEN
 0x0

	)

46 
	#PRED_TAKEN
 0x1

	)

47 
	#BPU_MISS
 0x0

	)

48 
	#BPU_HIT
 0x1

	)

50 
uöt32_t


51 
	$x‹_Æüsög_func
(
Ad≠tivePªdi˘‹
 *
a
, 
uöt32_t
 
hr
, 
èrgë_ul⁄g
 
pc
)

53  
	`GET_INDEX
(
hr
 ^ 
pc
, 
a
->
hªg_bôs
);

54 
	}
}

56 
uöt32_t


57 
	$™d_Æüsög_func
(
Ad≠tivePªdi˘‹
 *
a
, 
uöt32_t
 
hr
, 
èrgë_ul⁄g
 
pc
)

59  
	`GET_INDEX
(
hr
 & 
pc
, 
a
->
hªg_bôs
);

60 
	}
}

62 
uöt32_t


63 
	$n⁄e_Æüsög_func
(
Ad≠tivePªdi˘‹
 *
a
, 
uöt32_t
 
hr
, 
èrgë_ul⁄g
 
pc
)

65  
	`GET_INDEX
(
hr
, 
a
->
hªg_bôs
);

66 
	}
}

68 
Ad≠tivePªdi˘‹
 *

69 
	$ad≠tive_¥edi˘‹_öô
(c⁄° 
SimP¨ams
 *
p
)

71 
i
;

72 
Ad≠tivePªdi˘‹
 *
a
;

74 
a
 = (
Ad≠tivePªdi˘‹
 *)
	`ˇŒoc
(1, (AdaptivePredictor));

75 
	`as£π
(
a
);

78 
a
->
ght
 = (
GHTE¡ry
 *)
	`mÆloc
((GHTE¡ryË* 
p
->
bpu_ght_size
);

79 
	`as£π
(
a
->
ght
);

80 
a
->
ght_size
 = 
p
->
bpu_ght_size
;

81 
a
->
ght_ödex_bôs
 = 
	`GET_NUM_BITS
(
p
->
bpu_ght_size
);

82 
a
->
hªg_bôs
 = 
p
->
bpu_hi°‹y_bôs
;

83 
	`mem£t
(
a
->
ght
, 0,á->
ght_size
 * (
GHTE¡ry
));

86 
a
->
pht
 = (
PHTE¡ry
 *)
	`mÆloc
((PHTE¡ryË* 
p
->
bpu_pht_size
);

87 
	`as£π
(
a
->
pht
);

88 
a
->
pht_size
 = 
p
->
bpu_pht_size
;

89 
a
->
pht_ödex_bôs
 = 
	`GET_NUM_BITS
(
p
->
bpu_pht_size
);

90 
	`mem£t
(
a
->
pht
, 0,á->
pht_size
 * (
PHTE¡ry
));

91 
i
 = 0; i < 
a
->
pht_size
; ++i)

93 
a
->
pht
[
i
].
˘r
 = (*)
	`mÆloc
((Ë* (1 <<á->
hªg_bôs
));

94 
	`as£π
(
a
->
pht
[
i
].
˘r
);

95 
	`mem£t
(
a
->
pht
[
i
].
˘r
, 0, (Ë* (1 <<á->
hªg_bôs
));

97 
a
->
p‚_≠_Æüsög_func
 = 
NULL
;

99 i‡((
a
->
ght_size
 =1Ë&& (a->
pht_size
 == 1))

101 
a
->
ty≥
 = 
GAG
;

105 
p
->
bpu_Æüsög_func_ty≥
)

107 
BPU_ALIAS_FUNC_XOR
:

109 
a
->
p‚_≠_Æüsög_func
 = &
x‹_Æüsög_func
;

112 
BPU_ALIAS_FUNC_AND
:

114 
a
->
p‚_≠_Æüsög_func
 = &
™d_Æüsög_func
;

117 
BPU_ALIAS_FUNC_NONE
:

119 
a
->
p‚_≠_Æüsög_func
 = &
n⁄e_Æüsög_func
;

125 i‡((
a
->
ght_size
 =1Ë&& (a->
pht_size
 > 1))

127 
a
->
ty≥
 = 
GAP
;

129 i‡((
a
->
ght_size
 > 1Ë&& (a->
pht_size
 == 1))

131 
a
->
ty≥
 = 
PAG
;

133 i‡((
a
->
ght_size
 > 1Ë&& (a->
pht_size
 > 1))

135 
a
->
ty≥
 = 
PAP
;

138  
a
;

139 
	}
}

142 
	$upd©e_two_bô_cou¡î
(*
˘r
, 
¥ed
)

144 i‡(
¥ed
)

146 i‡((*
˘r
 >= 0) && (*ctr < 3))

148 (*
˘r
)++;

153 i‡((*
˘r
 >= 1) && (*ctr <= 3))

155 (*
˘r
)--;

158 
	}
}

161 
	$ad≠tive_¥edi˘‹_‰ì
(
Ad≠tivePªdi˘‹
 **
a
)

163 
i
;

165 
i
 = 0; i < (*
a
)->
pht_size
; ++i)

167 
	`‰ì
((*
a
)->
pht
[
i
].
˘r
);

168 (*
a
)->
pht
[
i
].
˘r
 = 
NULL
;

170 
	`‰ì
((*
a
)->
pht
);

171 (*
a
)->
pht
 = 
NULL
;

172 
	`‰ì
((*
a
)->
ght
);

173 (*
a
)->
ght
 = 
NULL
;

174 
	`‰ì
(*
a
);

175 *
a
 = 
NULL
;

176 
	}
}

180 
	$ad≠tive_¥edi˘‹_ght_¥obe
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
)

182 
ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

184 i‡(
a
->
ght
[
ödex
].
pc
 ==Öc)

186  
BPU_HIT
;

189  
BPU_MISS
;

190 
	}
}

194 
	$ad≠tive_¥edi˘‹_pht_¥obe
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
)

196 
ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

198 i‡(
a
->
pht
[
ödex
].
pc
 ==Öc)

200  
BPU_HIT
;

203  
BPU_MISS
;

204 
	}
}

211 
	$ad≠tive_¥edi˘‹_¥obe
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
)

213 
a
->
ty≥
)

215 
GAG
:

217  
BPU_HIT
;

219 
GAP
:

221  
	`ad≠tive_¥edi˘‹_pht_¥obe
(
a
, 
pc
);

223 
PAG
:

225  
	`ad≠tive_¥edi˘‹_ght_¥obe
(
a
, 
pc
);

227 
PAP
:

229  (
	`ad≠tive_¥edi˘‹_ght_¥obe
(
a
, 
pc
)

230 && 
	`ad≠tive_¥edi˘‹_pht_¥obe
(
a
, 
pc
));

234 
	`as£π
(0);

236 
	}
}

243 
	$ad≠tive_¥edi˘‹_gë_¥edi˘i⁄
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
)

245 
l1_ödex
;

246 
l2_ödex
;

247 
uöt32_t
 
ghr
;

249 
a
->
ty≥
)

251 
GAG
:

253 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[0].ghr,á->
hªg_bôs
);

256 
ghr
 = 
a
->
	`p‚_≠_Æüsög_func
◊, ghr, 
pc
);

257 i‡(
a
->
pht
[0].
˘r
[
ghr
] > 1)

263 
GAP
:

265 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[0].ghr,á->
hªg_bôs
);

266 
l2_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

267 i‡(
a
->
pht
[
l2_ödex
].
˘r
[
ghr
] > 1)

273 
PAG
:

275 
l1_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

276 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[
l1_ödex
].ghr,á->
hªg_bôs
);

277 i‡(
a
->
pht
[0].
˘r
[
ghr
] > 1)

283 
PAP
:

285 
l1_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

286 
l2_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

287 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[
l1_ödex
].ghr,á->
hªg_bôs
);

288 i‡(
a
->
pht
[
l2_ödex
].
˘r
[
ghr
] > 1)

296 
	`as£π
(0);

298 
	}
}

309 
	$ad≠tive_¥edi˘‹_add
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
)

311 
l1_ödex
;

312 
l2_ödex
;

314 
a
->
ty≥
)

316 
GAG
:

320 
GAP
:

322 
l2_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

323 
a
->
pht
[
l2_ödex
].
pc
 =Öc;

324 
	`mem£t
(
a
->
pht
[
l2_ödex
].
˘r
, 0, (Ë* (1 <<á->
hªg_bôs
));

327 
PAG
:

329 
l1_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

330 
a
->
ght
[
l1_ödex
].
pc
 =Öc;

331 
a
->
ght
[
l1_ödex
].
ghr
 = 0;

334 
PAP
:

336 
l1_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

337 
l2_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

338 
a
->
ght
[
l1_ödex
].
pc
 =Öc;

339 
a
->
ght
[
l1_ödex
].
ghr
 = 0;

340 
a
->
pht
[
l2_ödex
].
pc
 =Öc;

341 
	`mem£t
(
a
->
pht
[
l2_ödex
].
˘r
, 0, (Ë* (1 <<á->
hªg_bôs
));

345 
	}
}

354 
	$ad≠tive_¥edi˘‹_upd©e
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
, 
¥ed
)

356 
l1_ödex
;

357 
l2_ödex
;

358 
uöt32_t
 
ghr
;

360 
a
->
ty≥
)

362 
GAG
:

364 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[0].ghr,á->
hªg_bôs
);

367 
ghr
 = 
a
->
	`p‚_≠_Æüsög_func
◊, ghr, 
pc
);

368 
	`upd©e_two_bô_cou¡î
(&
a
->
pht
[0].
˘r
[
ghr
], 
¥ed
);

369 
a
->
ght
[0].
ghr
 = 
	`UPDATE_GHR
◊->ght[0].ghr,á->
hªg_bôs
, 
¥ed
);

372 
GAP
:

374 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[0].ghr,á->
hªg_bôs
);

375 
l2_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

376 
	`upd©e_two_bô_cou¡î
(&
a
->
pht
[
l2_ödex
].
˘r
[
ghr
], 
¥ed
);

377 
a
->
ght
[0].
ghr
 = 
	`UPDATE_GHR
◊->ght[0].ghr,á->
hªg_bôs
, 
¥ed
);

380 
PAG
:

382 
l1_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

383 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[
l1_ödex
].ghr,á->
hªg_bôs
);

384 
	`upd©e_two_bô_cou¡î
(&
a
->
pht
[0].
˘r
[
ghr
], 
¥ed
);

385 
a
->
ght
[
l1_ödex
].
ghr


386 
	`UPDATE_GHR
(
a
->
ght
[
l1_ödex
].
ghr
,á->
hªg_bôs
, 
¥ed
);

389 
PAP
:

391 
l1_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
ght_ödex_bôs
);

392 
ghr
 = 
	`GET_INDEX
(
a
->
ght
[
l1_ödex
].ghr,á->
hªg_bôs
);

393 
l2_ödex
 = 
	`GET_INDEX
(
pc
 >> 1, 
a
->
pht_ödex_bôs
);

394 
	`upd©e_two_bô_cou¡î
(&
a
->
pht
[
l2_ödex
].
˘r
[
ghr
], 
¥ed
);

395 
a
->
ght
[
l1_ödex
].
ghr


396 
	`UPDATE_GHR
(
a
->
ght
[
l1_ödex
].
ghr
,á->
hªg_bôs
, 
¥ed
);

400 
	}
}

403 
	$ad≠tive_¥edi˘‹_Êush
(
Ad≠tivePªdi˘‹
 *
a
)

405 
i
;

407 
	`mem£t
(
a
->
ght
, 0,á->
ght_size
 * (
GHTE¡ry
));

408 
i
 = 0; i < 
a
->
pht_size
; ++i)

410 
a
->
pht
[
i
].
pc
 = 0;

411 
	`mem£t
(
a
->
pht
[
i
].
˘r
, 0, (Ë* (1 <<á->
hªg_bôs
));

413 
	}
}

	@riscvsim/adaptive_predictor.h

30 #i‚de‡
_ADAPTIVE_PREDICTOR_H_


31 
	#_ADAPTIVE_PREDICTOR_H_


	)

33 
	~"sim_∑øms_°©s.h
"

34 
	~"riscv_sim_ty≥defs.h
"

37 
	sGHTE¡ry


39 
èrgë_ul⁄g
 
	mpc
;

40 
uöt32_t
 
	mghr
;

41 } 
	tGHTE¡ry
;

44 
	sPHTE¡ry


46 
èrgë_ul⁄g
 
	mpc
;

47 *
	m˘r
;

48 } 
	tPHTE¡ry
;

50 
	sAd≠tivePªdi˘‹


52 
GHTE¡ry
 *
	mght
;

53 
PHTE¡ry
 *
	mpht
;

54 
	mght_size
;

55 
	mpht_size
;

56 
uöt32_t
 
	mght_ödex_bôs
;

57 
uöt32_t
 
	mpht_ödex_bôs
;

58 
uöt32_t
 
	mhªg_bôs
;

59 
	mty≥
;

61 
uöt32_t
 (*
p‚_≠_Æüsög_func
)(
Ad≠tivePªdi˘‹
 *
	ma
, uöt32_à
	mhr
,

62 
èrgë_ul⁄g
 
	mpc
);

63 } 
	tAd≠tivePªdi˘‹
;

65 
Ad≠tivePªdi˘‹
 * 
ad≠tive_¥edi˘‹_öô
(c⁄° 
SimP¨ams
 *
p
);

66 
ad≠tive_¥edi˘‹_‰ì
(
Ad≠tivePªdi˘‹
 **
a
);

67 
ad≠tive_¥edi˘‹_¥obe
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
);

68 
ad≠tive_¥edi˘‹_gë_¥edi˘i⁄
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
);

69 
ad≠tive_¥edi˘‹_add
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
);

70 
ad≠tive_¥edi˘‹_upd©e
(
Ad≠tivePªdi˘‹
 *
a
, 
èrgë_ul⁄g
 
pc
, 
¥ed
);

71 
ad≠tive_¥edi˘‹_Êush
(
Ad≠tivePªdi˘‹
 *
a
);

	@riscvsim/bht.c

27 
	~<as£π.h
>

28 
	~<°dlib.h
>

29 
	~<m©h.h
>

30 
	~<°rög.h
>

32 
	~"bht.h
"

33 
	~"riscv_sim_ma¸os.h
"

36 
	$upd©e_two_bô_cou¡î
(*
˘r
, 
¥ed
)

38 i‡(
¥ed
)

40 i‡((*
˘r
 >= 0) && (*ctr < 3))

42 (*
˘r
)++;

47 i‡((*
˘r
 >= 1) && (*ctr <= 3))

49 (*
˘r
)--;

52 
	}
}

54 
Bht
 *

55 
	$bht_öô
(c⁄° 
SimP¨ams
 *
p
)

57 
Bht
 *
b
;

59 
b
 = 
	`ˇŒoc
(1, (
Bht
));

60 
	`as£π
(
b
);

62 
b
->
bht_size
 = 
p
->bht_size;

63 
b
->
bht_íåy
 = 
	`ˇŒoc
(b->
bht_size
, (
BhtE¡ry
));

64 
	`as£π
(
b
->
bht_íåy
);

66 
b
->
bht_ödex_bôs
 = 
	`GET_NUM_BITS
(b->
bht_size
);

68  
b
;

69 
	}
}

72 
	$bht_‰ì
(
Bht
 **
b
)

74 
	`‰ì
((*
b
)->
bht_íåy
);

75 (*
b
)->
bht_íåy
 = 
NULL
;

76 
	}
}

79 
	$bht_gë_¥ed
(
Bht
 *
b
, 
èrgë_ul⁄g
 
pc
)

81 
idx
;

83 
idx
 = 
	`GET_INDEX
(
pc
, 
b
->
bht_ödex_bôs
);

84  
b
->
bht_íåy
[
idx
].
¥ed
;

85 
	}
}

88 
	$bht_add
(
Bht
 *
b
, 
èrgë_ul⁄g
 
pc
)

90 
idx
;

94 
idx
 = 
	`GET_INDEX
(
pc
, 
b
->
bht_ödex_bôs
);

95 
b
->
bht_íåy
[
idx
].
¥ed
 = 1;

96 
	}
}

99 
	$bht_upd©e
(
Bht
 *
b
, 
èrgë_ul⁄g
 
pc
, 
¥ed
)

101 
idx
;

103 
idx
 = 
	`GET_INDEX
(
pc
, 
b
->
bht_ödex_bôs
);

104 
	`upd©e_two_bô_cou¡î
(&
b
->
bht_íåy
[
idx
].
¥ed
,Öred);

105 
	}
}

108 
	$bht_Êush
(
Bht
 *
b
)

110 
i
;

112 
i
 = 0; i < 
b
->
bht_size
; ++i)

114 
b
->
bht_íåy
[
i
].
¥ed
 = 1;

116 
	}
}

	@riscvsim/bht.h

27 #i‚de‡
_BHT_H_


28 
	#_BHT_H_


	)

30 
	~"riscv_sim_ty≥defs.h
"

31 
	~"sim_∑øms_°©s.h
"

33 
	sBhtE¡ry


35 
	m¥ed
;

36 } 
	tBhtE¡ry
;

38 
	sBht


40 
BhtE¡ry
 *
	mbht_íåy
;

41 
	mbht_ödex_bôs
;

42 
	mbht_size
;

43 } 
	tBht
;

45 
Bht
 *
bht_öô
(c⁄° 
SimP¨ams
 *
p
);

46 
bht_‰ì
(
Bht
 **
b
);

47 
bht_Êush
(
Bht
 *
b
);

48 
bht_gë_¥ed
(
Bht
 *
b
, 
èrgë_ul⁄g
 
pc
);

49 
bht_add
(
Bht
 *
b
, 
èrgë_ul⁄g
 
pc
);

50 
bht_upd©e
(
Bht
 *
b
, 
èrgë_ul⁄g
 
pc
, 
¥ed
);

	@riscvsim/bpu.c

30 
	~"bpu.h
"

32 
BønchPªdUnô
 *

33 
	$bpu_öô
(c⁄° 
SimP¨ams
 *
p
, 
SimSèts
 *
s
)

35 
BønchPªdUnô
 *
u
;

37 
u
 = (
BønchPªdUnô
 *)
	`ˇŒoc
(1, (BranchPredUnit));

38 
	`as£π
(
u
);

39 
u
->
btb
 = 
NULL
;

40 
u
->
bht
 = 
NULL
;

41 
u
->
≠
 = 
NULL
;

42 
u
->
øs
 = 
NULL
;

43 
u
->
°©s
 = 
s
;

44 
u
->
btb
 = 
	`btb_öô
(
p
);

45 
u
->
bpu_ty≥
 = 
p
->bpu_type;

47 
u
->
bpu_ty≥
)

49 
BPU_TYPE_BIMODAL
:

51 
u
->
bht
 = 
	`bht_öô
(
p
);

55 
BPU_TYPE_ADAPTIVE
:

57 
u
->
≠
 = 
	`ad≠tive_¥edi˘‹_öô
(
p
);

62 i‡(
p
->
øs_size
)

64 
u
->
øs
 = 
	`øs_öô
(
p
);

67  
u
;

68 
	}
}

71 
	$bpu_Êush
(
BønchPªdUnô
 *
u
)

73 
	`btb_Êush
(
u
->
btb
);

75 
u
->
bpu_ty≥
)

77 
BPU_TYPE_BIMODAL
:

79 
	`bht_Êush
(
u
->
bht
);

83 
BPU_TYPE_ADAPTIVE
:

85 
	`ad≠tive_¥edi˘‹_Êush
(
u
->
≠
);

90 i‡(
u
->
øs
)

92 
	`øs_Êush
(
u
->
øs
);

94 
	}
}

97 
	$bpu_‰ì
(
BønchPªdUnô
 **
u
)

99 
	`btb_‰ì
(&(*
u
)->
btb
);

101 (*
u
)->
bpu_ty≥
)

103 
BPU_TYPE_BIMODAL
:

105 
	`bht_‰ì
(&(*
u
)->
bht
);

109 
BPU_TYPE_ADAPTIVE
:

111 
	`ad≠tive_¥edi˘‹_‰ì
(&(*
u
)->
≠
);

116 i‡((*
u
)->
øs
)

118 
	`øs_‰ì
(&(*
u
)->
øs
);

121 
	`‰ì
(*
u
);

122 *
u
 = 
NULL
;

123 
	}
}

127 
	$bpu_¥obe
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
, 
BPURe•⁄£Pkt
 *
p
, 
¥iv
)

129 
p
->
≠_¥obe_°©us
 = 
BPU_HIT
;

130 
p
->
btb_¥obe_°©us
 = 
	`btb_¥obe
(
u
->
btb
, 
pc
, &p->
btb_íåy
);

131 i‡(
p
->
btb_¥obe_°©us
 =
BPU_HIT
)

133 ++(
u
->
°©s
[
¥iv
].
btb_hôs
);

135 ++(
u
->
°©s
[
¥iv
].
btb_¥obes
);

138 i‡(
u
->
≠
 && ((
p
->
btb_¥obe_°©us
 =
BPU_MISS
)

139 || (
p
->
btb_íåy
->
ty≥
 =
BRANCH_COND
)))

141 
p
->
≠_¥obe_°©us
 = 
	`ad≠tive_¥edi˘‹_¥obe
(
u
->
≠
, 
pc
);

144 
p
->
bpu_¥obe_°©us
 =Ö->
btb_¥obe_°©us
 &&Ö->
≠_¥obe_°©us
;

145 
	}
}

152 
èrgë_ul⁄g


153 
	$bpu_gë_èrgë
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
, 
BtbE¡ry
 *
btb_íåy
)

155 
btb_íåy
->
ty≥
)

157 
BRANCH_UNCOND
:

161  
btb_íåy
->
èrgë
;

164 
BRANCH_COND
:

168 
u
->
bpu_ty≥
)

170 
BPU_TYPE_BIMODAL
:

172 i‡(
	`bht_gë_¥ed
(
u
->
bht
, 
pc
) > 1)

174  
btb_íåy
->
èrgë
;

179 
BPU_TYPE_ADAPTIVE
:

181 i‡(
	`ad≠tive_¥edi˘‹_gë_¥edi˘i⁄
(
u
->
≠
, 
pc
))

183  
btb_íåy
->
èrgë
;

194 
	}
}

197 
	$bpu_add
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
, 
ty≥
, 
BPURe•⁄£Pkt
 *
p
,

198 
¥iv
, 
‰ë
)

201 i‡(!
p
->
btb_¥obe_°©us
)

204 i‡(!(
u
->
øs
 && 
‰ë
))

206 
	`btb_add
(
u
->
btb
, 
pc
, 
ty≥
);

207 ++(
u
->
°©s
[
¥iv
].
btb_ö£πs
);

211 
u
->
bpu_ty≥
)

213 
BPU_TYPE_BIMODAL
:

215 i‡(
ty≥
 =
BRANCH_COND
)

217 
	`bht_add
(
u
->
bht
, 
pc
);

222 
BPU_TYPE_ADAPTIVE
:

227 i‡((
ty≥
 =
BRANCH_COND
Ë&& !
p
->
≠_¥obe_°©us
)

229 
	`ad≠tive_¥edi˘‹_add
(
u
->
≠
, 
pc
);

234 
	}
}

237 
	$bpu_upd©e
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
,Å¨gë_ul⁄g 
èrgë
, 
¥ed
,

238 
ty≥
, 
BPURe•⁄£Pkt
 *
p
, 
¥iv
)

240 i‡(
p
->
btb_¥obe_°©us
)

242 
	`btb_upd©e
(
p
->
btb_íåy
, 
èrgë
, 
ty≥
);

243 ++(
u
->
°©s
[
¥iv
].
btb_upd©es
);

246 
u
->
bpu_ty≥
)

248 
BPU_TYPE_BIMODAL
:

250 i‡(
ty≥
 =
BRANCH_COND
)

252 
	`bht_upd©e
(
u
->
bht
, 
pc
, 
¥ed
);

257 
BPU_TYPE_ADAPTIVE
:

261 i‡((
ty≥
 =
BRANCH_COND
Ë&& 
p
->
≠_¥obe_°©us
)

263 
	`ad≠tive_¥edi˘‹_upd©e
(
u
->
≠
, 
pc
, 
¥ed
);

268 
	}
}

	@riscvsim/bpu.h

30 #i‚de‡
_BRANCH_PRED_UNIT_H_


31 
	#_BRANCH_PRED_UNIT_H_


	)

33 
	~<as£π.h
>

34 
	~<öây≥s.h
>

35 
	~<m©h.h
>

36 
	~<°dio.h
>

37 
	~<°dlib.h
>

38 
	~<°rög.h
>

40 
	~"sim_∑øms_°©s.h
"

41 
	~"ad≠tive_¥edi˘‹.h
"

42 
	~"btb.h
"

43 
	~"bht.h
"

44 
	~"øs.h
"

45 
	~"riscv_sim_ty≥defs.h
"

47 
	sBønchPªdUnô


49 
BønchT¨gëBuf„r
 *
	mbtb
;

50 
Bht
 *
	mbht
;

51 
Ras
 *
	møs
;

52 
Ad≠tivePªdi˘‹
 *
	m≠
;

53 
SimSèts
 *
	m°©s
;

54 
	mbpu_ty≥
;

55 } 
	tBønchPªdUnô
;

57 
	sBPURe•⁄£Pkt


59 
	mbtb_¥obe_°©us
;

60 
	m≠_¥obe_°©us
;

61 
	mbpu_¥obe_°©us
;

62 
BtbE¡ry
 *
	mbtb_íåy
;

63 } 
	tBPURe•⁄£Pkt
;

65 
BønchPªdUnô
 *
bpu_öô
(c⁄° 
SimP¨ams
 *
p
, 
SimSèts
 *
s
);

66 
bpu_‰ì
(
BønchPªdUnô
 **
u
);

67 
bpu_¥obe
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
, 
BPURe•⁄£Pkt
 *
p
, 
¥iv
);

68 
èrgë_ul⁄g
 
bpu_gë_èrgë
(
BønchPªdUnô
 *
u
,Å¨gë_ul⁄g 
pc
,

69 
BtbE¡ry
 *
btb_íåy
);

70 
bpu_add
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
, 
ty≥
, 
BPURe•⁄£Pkt
 *
p
,

71 
¥iv
, 
‰ë
);

72 
bpu_upd©e
(
BønchPªdUnô
 *
u
, 
èrgë_ul⁄g
 
pc
,Å¨gë_ul⁄g 
èrgë
,

73 
¥ed
, 
ty≥
, 
BPURe•⁄£Pkt
 *
p
, 
¥iv
);

74 
bpu_Êush
(
BønchPªdUnô
 *
u
);

	@riscvsim/btb.c

30 
	~<as£π.h
>

31 
	~<m©h.h
>

32 
	~<°dlib.h
>

33 
	~<°rög.h
>

35 
	~"btb.h
"

37 
	#GET_SET_ADDR
(
pc
, 
bôs
Ë(
	`GET_INDEX
(’c), (bôs)))

	)

44 
	$btb_evi˘_pﬁicy_øndom
(
BønchT¨gëBuf„r
 *
b
, 
£t
)

46  
	`ønd
(Ë% 
b
->
ways
;

47 
	}
}

54 
	$btb_evi˘_pﬁicy_Ãu
(
BønchT¨gëBuf„r
 *
b
, 
£t
)

56 
check_bô
 = 0;

57 
lowî_bound
 = 0;

58 
uµî_bound
 = 
b
->
ways
 - 1;

60 
check_bô
 < (
b
->
ways
 - 1))

62 i‡(
b
->
°©us_bôs
[
£t
][
check_bô
])

64 
check_bô
 = ((check_bit + 1) * 2) - 1;

65 
uµî_bound
 = 
	`Êo‹
((
lowî_bound
 + upper_bound) / 2);

69 
check_bô
 = ((check_bit + 1) * 2);

70 
lowî_bound
 = 
	`Êo‹
(÷owî_bound + 
uµî_bound
) / 2) + 1;

75 
	`as£π
(
lowî_bound
 =
uµî_bound
);

76  
lowî_bound
;

77 
	}
}

85 
	$btb_upd©e_Ãu_°©us_bôs
(
BønchT¨gëBuf„r
 *
b
, 
£t
, 
way
)

87 
upd©e_bô
 = 0;

88 
comp
 = 
	`Êo‹
(
b
->
ways
 / 2);

90 
upd©e_bô
 < (
b
->
ways
 - 1))

92 i‡(
way
 <
comp
)

95 
b
->
°©us_bôs
[
£t
][
upd©e_bô
] = 0;

96 
upd©e_bô
 = ((update_bit + 1) * 2) - 1;

97 
comp
 = 
	`Êo‹
(comp / 2);

102 
b
->
°©us_bôs
[
£t
][
upd©e_bô
] = 1;

103 
upd©e_bô
 = ((update_bit + 1) * 2);

104 
comp
 = 
	`Êo‹
((com∞+ 
b
->
ways
 - 1) / 2);

107 
	}
}

109 
BønchT¨gëBuf„r
 *

110 
	$btb_öô
(c⁄° 
SimP¨ams
 *
p
)

112 
i
;

113 
BønchT¨gëBuf„r
 *
b
;

115 
b
 = (
BønchT¨gëBuf„r
 *)
	`ˇŒoc
(1, (BranchTargetBuffer));

116 
	`as£π
(
b
);

117 
b
->
size
 = 
p
->
btb_size
;

118 
b
->
£ts
 = b->
size
 / 
p
->
btb_ways
;

119 
b
->
ways
 = 
p
->
btb_ways
;

120 
b
->
£t_bôs
 = 
	`GET_NUM_BITS
(b->
£ts
);

121 
b
->
p‚_btb_evi˘_h™dÀr
 = 
NULL
;

122 i‡(
p
->
btb_evi˘i⁄_pﬁicy
 =
BTB_RANDOM_EVICT
)

124 
b
->
ønd_evi˘
 = 1;

125 
b
->
p‚_btb_evi˘_h™dÀr
 = &
btb_evi˘_pﬁicy_øndom
;

129 
b
->
ønd_evi˘
 = 0;

130 
b
->
p‚_btb_evi˘_h™dÀr
 = &
btb_evi˘_pﬁicy_Ãu
;

133 
b
->
d©a
 = (
BtbE¡ry
 **)
	`ˇŒoc
(b->
£ts
, (BtbEntry *));

134 
b
->
°©us_bôs
 = (**)
	`ˇŒoc
(b->
£ts
, (*));

135 
	`as£π
(
b
->
d©a
);

136 
	`as£π
(
b
->
°©us_bôs
);

137 
i
 = 0; i < 
b
->
£ts
; ++i)

139 
b
->
d©a
[
i
] = (
BtbE¡ry
 *)
	`ˇŒoc
(b->
ways
, (BtbEntry));

140 
	`as£π
(
b
->
d©a
[
i
]);

141 
b
->
°©us_bôs
[
i
] = (*)
	`ˇŒoc
(b->
ways
, ());

142 
	`as£π
(
b
->
°©us_bôs
[
i
]);

145  
b
;

146 
	}
}

149 
	$btb_‰ì
(
BønchT¨gëBuf„r
 **
b
)

151 
i
;

153 
i
 = 0; i < (*
b
)->
£ts
; ++i)

155 
	`‰ì
((*
b
)->
°©us_bôs
[
i
]);

156 (*
b
)->
°©us_bôs
[
i
] = 
NULL
;

157 
	`‰ì
((*
b
)->
d©a
[
i
]);

158 (*
b
)->
d©a
[
i
] = 
NULL
;

160 
	`‰ì
((*
b
)->
°©us_bôs
);

161 (*
b
)->
°©us_bôs
 = 
NULL
;

162 
	`‰ì
((*
b
)->
d©a
);

163 (*
b
)->
d©a
 = 
NULL
;

164 
	`‰ì
(*
b
);

165 *
b
 = 
NULL
;

166 
	}
}

169 
	$btb_Êush
(
BønchT¨gëBuf„r
 *
b
)

171 
i
;

173 
i
 = 0; i < 
b
->
£ts
; ++i)

175 
	`mem£t
((*)
b
->
d©a
[
i
], 0, b->
ways
 * (
BtbE¡ry
));

176 
	`mem£t
((*)
b
->
°©us_bôs
[
i
], 0, b->
ways
 * ());

178 
	}
}

186 
	$btb_¥obe
(
BønchT¨gëBuf„r
 *
b
, 
èrgë_ul⁄g
 
pc
, 
BtbE¡ry
 **
btb_íåy
)

188 
j
;

189 
£t_addr
 = 
	`GET_SET_ADDR
(
pc
 >> 1, 
b
->
£t_bôs
);

191 *
btb_íåy
 = 
NULL
;

193 
j
 = 0; j < 
b
->
ways
; ++j)

195 i‡(
b
->
d©a
[
£t_addr
][
j
].
pc
 ==Öc)

199 i‡(!
b
->
ønd_evi˘
)

201 
	`btb_upd©e_Ãu_°©us_bôs
(
b
, 
£t_addr
, 
j
);

203 *
btb_íåy
 = &(
b
->
d©a
[
£t_addr
][
j
]);

204  
BPU_HIT
;

209  
BPU_MISS
;

210 
	}
}

218 
	$btb_add
(
BønchT¨gëBuf„r
 *
b
, 
èrgë_ul⁄g
 
pc
, 
ty≥
)

220 
£t_addr
 = 
	`GET_SET_ADDR
(
pc
 >> 1, 
b
->
£t_bôs
);

221 
pos
 = 
b
->
	`p‚_btb_evi˘_h™dÀr
(b, 
£t_addr
);

224 
b
->
d©a
[
£t_addr
][
pos
].
pc
 =Öc;

225 
b
->
d©a
[
£t_addr
][
pos
].
èrgë
 = 0;

226 
b
->
d©a
[
£t_addr
][
pos
].
ty≥
 =Åype;

227 
	}
}

235 
	$btb_upd©e
(
BtbE¡ry
 *
btb_íåy
, 
èrgë_ul⁄g
 
èrgë
,
ty≥
)

237 
btb_íåy
->
èrgë
 =Åarget;

238 
btb_íåy
->
ty≥
 =Åype;

239 
	}
}

	@riscvsim/btb.h

30 #i‚de‡
_BRANCH_TARGET_BUFFER_H_


31 
	#_BRANCH_TARGET_BUFFER_H_


	)

33 
	~"sim_∑øms_°©s.h
"

34 
	~"riscv_sim_ty≥defs.h
"

36 
	sBtbE¡ry


38 
èrgë_ul⁄g
 
	mpc
;

39 
èrgë_ul⁄g
 
	mèrgë
;

40 
	mty≥
;

41 } 
	tBtbE¡ry
;

43 
	sBønchT¨gëBuf„r


45 
BtbE¡ry
 **
	md©a
;

46 **
	m°©us_bôs
;

47 
	mønd_evi˘
;

48 
	msize
;

49 
	m£ts
;

50 
uöt32_t
 
	m£t_bôs
;

51 
	mways
;

52 (*
	mp‚_btb_evi˘_h™dÀr
)(
BønchT¨gëBuf„r
 *
	mb
,

53 
	m£t
);

54 } 
	tBønchT¨gëBuf„r
;

56 
BønchT¨gëBuf„r
 *
btb_öô
(c⁄° 
SimP¨ams
 *
p
);

57 
btb_¥obe
(
BønchT¨gëBuf„r
 *
b
, 
èrgë_ul⁄g
 
pc
, 
BtbE¡ry
 **
btb_íåy
);

58 
btb_add
(
BønchT¨gëBuf„r
 *
b
, 
èrgë_ul⁄g
 
pc
, 
ty≥
);

59 
btb_upd©e
(
BtbE¡ry
 *
btb_íåy
, 
èrgë_ul⁄g
 
èrgë
, 
ty≥
);

60 
btb_‰ì
(
BønchT¨gëBuf„r
 **
b
);

61 
btb_Êush
(
BønchT¨gëBuf„r
 *
b
);

	@riscvsim/cache.c

30 
	~<as£π.h
>

31 
	~<m©h.h
>

32 
	~<°dio.h
>

33 
	~<°dlib.h
>

34 
	~<°rög.h
>

36 
	~"ˇche.h
"

38 
	#MAX_STR
 32

	)

48 
	$upd©e_èg_addªss
(c⁄° 
Cache
 *
c
, 
uöt32_t
 *
p£t
, 
CacheBlk
 **
pblk
,

49 
èrgë_ul⁄g
 *
±ag
,Å¨gë_ul⁄g *
∑ddr
,

50 *
pbyãs_to_ac˚ss
, 
avaûabÀ_byãs
)

54 *
pbyãs_to_ac˚ss
 = *pbyãs_to_ac˚s†- 
avaûabÀ_byãs
;

58 *
p£t
 = (*p£à+ 1Ë% 
c
->
num_£ts
;

59 *
pblk
 = 
c
->
blk
[*
p£t
];

60 *
±ag
 = (*±ag + 1Ë% 
c
->
max_èg_vÆ
;

61 *
∑ddr
 = *
±ag
 << 
c
->
w‹d_bôs
;

62 
	}
}

65 
	$upd©e_°©us_bôs
(c⁄° 
Cache
 *
c
, 
£t
, 
way
)

68 
upd©e_bô
 = 0;

69 
comp
 = 
	`Êo‹
(
c
->
num_ways
 / 2);

71 
upd©e_bô
 < (
c
->
num_ways
 - 1))

73 i‡(
way
 <
comp
)

76 
c
->
°©us_bôs
[
£t
][
upd©e_bô
] = 0;

77 
upd©e_bô
 = ((update_bit + 1) * 2) - 1;

78 
comp
 = 
	`Êo‹
(comp / 2);

83 
c
->
°©us_bôs
[
£t
][
upd©e_bô
] = 1;

84 
upd©e_bô
 = ((update_bit + 1) * 2);

85 
comp
 = 
	`Êo‹
((com∞+ 
c
->
num_ways
 - 1) / 2);

88 
	}
}

91 
	$gë_Ãu_vi˘im_ödex
(c⁄° 
Cache
 *
c
, 
£t
)

93 
check_bô
 = 0;

94 
lowî_bound
 = 0;

95 
uµî_bound
 = 
c
->
num_ways
 - 1;

97 
check_bô
 < (
c
->
num_ways
 - 1))

99 i‡(
c
->
°©us_bôs
[
£t
][
check_bô
])

102 
check_bô
 = ((check_bit + 1) * 2) - 1;

103 
uµî_bound
 = 
	`Êo‹
((
lowî_bound
 + upper_bound) / 2);

108 
check_bô
 = ((check_bit + 1) * 2);

109 
lowî_bound
 = 
	`Êo‹
(÷owî_bound + 
uµî_bound
) / 2) + 1;

113  
lowî_bound
;

114 
	}
}

117 
	$gë_øndom_vi˘im_ödex
(c⁄° 
Cache
 *
c
, 
£t
)

119  
	`ønd
(Ë% 
c
->
num_ways
;

120 
	}
}

123 
	$ªad_d©a_öã∫Æ
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

124 *
p_mem_ac˚ss_öfo
, 
¥iv
)

127 i‡(
NULL
 !
c
->
√xt_Àvñ_ˇche
)

129  
	`ˇche_ªad
(
c
->
√xt_Àvñ_ˇche
, 
∑ddr
, 
byãs_to_ªad
,

130 
p_mem_ac˚ss_öfo
, 
¥iv
);

133  
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
c
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_ªad
, 
Ród
,

134 
p_mem_ac˚ss_öfo
);

135 
	}
}

138 
	$ªad_Æloˇã_h™dÀr
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

139 
£t
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

141 
èrgë_ul⁄g
 
èg
;

142 
œãncy
 = 0;

143 
CacheBlk
 *
blk
 = 
c
->blk[
£t
];

145 
vi˘im
 = (*
c
->
p‚_gë_vi˘im_ödex
)(c, 
£t
);

149 
∑ddr
 =Öadd∏& 
c
->
èg_bôs_mask
;

150 
byãs_to_ªad
 = (
WORD_SIZE
 * 
c
->
max_w‹ds_≥r_blk
);

151 
èg
 = 
∑ddr
 >> (
c
->
w‹d_bôs
);

154 
œãncy
 +(*
c
->
p‚_vi˘im_evi˘_h™dÀr
)(c, &(
blk
[
vi˘im
]), 
£t
, victim,

155 
p_mem_ac˚ss_öfo
, 
¥iv
);

159 
œãncy
 +
	`ªad_d©a_öã∫Æ
(
c
, 
∑ddr
, 
byãs_to_ªad
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

161 
blk
[
vi˘im
].
èg
 =Åag;

162 
blk
[
vi˘im
].
°©us
 = 
VÆid
;

165 
	`upd©e_°©us_bôs
(
c
, 
£t
, 
vi˘im
);

167  
œãncy
;

168 
	}
}

171 
	$ªad_no_Æloˇã_h™dÀr
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

172 
£t
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

175  
	`ªad_d©a_öã∫Æ
(
c
, 
∑ddr
, 
byãs_to_ªad
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

176 
	}
}

179 
	$ˇche_ªad
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

180 *
p_mem_ac˚ss_öfo
, 
¥iv
)

182 
i
;

183 
uöt32_t
 
°¨t_byã
 = (
∑ddr
 & ((1 << 
c
->
w‹d_bôs
) - 1));

184 
uöt32_t
 
£t
 = (
∑ddr
 >> 
c
->
w‹d_bôs
Ë& ((1 << c->
£t_bôs
) - 1);

185 
èrgë_ul⁄g
 
èg
 = 
∑ddr
 >> (
c
->
w‹d_bôs
);

186 
œãncy
 = 
c
->
ªad_œãncy
;

187 
avaûabÀ_byãs
 = 0;

188 
ˇche_miss_upd©ed
 = 0;

189 
CacheBlk
 *
blk
 = 
c
->blk[
£t
];

191 
c
->
°©s
[
¥iv
].
tŸÆ_ªad_˙t
++;

193 
byãs_to_ªad
 > 0)

195 
i
 = 0; i < 
c
->
num_ways
; ++i)

197 i‡((
blk
[
i
].
èg
 =ègË&& (blk[i].
°©us
 =
VÆid
))

200 
	`upd©e_°©us_bôs
(
c
, 
£t
, 
i
);

201 i‡((
°¨t_byã
 + 
byãs_to_ªad
)

202 <(
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
))

205  
œãncy
;

210 
avaûabÀ_byãs


211 ((
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
Ë- 
°¨t_byã
);

215 
	`upd©e_èg_addªss
(
c
, &
£t
, &
blk
, &
èg
, &
∑ddr
, &
byãs_to_ªad
,

216 
avaûabÀ_byãs
);

221 i‡(
i
 < 
c
->
num_ways
)

229 i‡(!
ˇche_miss_upd©ed
)

231 
c
->
°©s
[
¥iv
].
ªad_miss_˙t
++;

232 
ˇche_miss_upd©ed
 = 1;

235 i‡((
°¨t_byã
 + 
byãs_to_ªad
Ë<(
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
))

238 
œãncy
 +(*
c
->
p‚_ªad_Æloc_h™dÀr
)(c, 
∑ddr
, 
byãs_to_ªad
,

239 
£t
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

245 
avaûabÀ_byãs
 = ((
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
Ë- 
°¨t_byã
);

249 
œãncy
 +(*
c
->
p‚_ªad_Æloc_h™dÀr
)(c, 
∑ddr
, 
avaûabÀ_byãs
,

250 
£t
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

254 
	`upd©e_èg_addªss
(
c
, &
£t
, &
blk
, &
èg
, &
∑ddr
, &
byãs_to_ªad
,

255 
avaûabÀ_byãs
);

260  
œãncy
;

261 
	}
}

264 
	$wrôeback_h™dÀr
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
,

265 
£t
, 
way
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

268 
CacheBlk
 *
blk
 = 
c
->blk[
£t
];

269 
blk
[
way
].
dúty
 = 
Dúty
;

271 
	`upd©e_°©us_bôs
(
c
, 
£t
, 
way
);

273 
	}
}

276 
	$wrôëhrough_h™dÀr
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
,

277 
£t
, 
way
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

280 
CacheBlk
 *
blk
 = 
c
->blk[
£t
];

281 
blk
[
way
].
dúty
 = 
Dúty
;

282 
	`upd©e_°©us_bôs
(
c
, 
£t
, 
way
);

285 i‡(
NULL
 !
c
->
√xt_Àvñ_ˇche
)

287  
	`ˇche_wrôe
(
c
->
√xt_Àvñ_ˇche
, 
∑ddr
, 
byãs_to_wrôe
,

288 
p_mem_ac˚ss_öfo
, 
¥iv
);

291  
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
c
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_wrôe
, 
Wrôe
,

292 
p_mem_ac˚ss_öfo
);

293 
	}
}

296 
	$wrôe_Æloˇã_h™dÀr
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
,

297 
£t
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

299 
œãncy
 = 0;

300 
CacheBlk
 *
blk
 = 
c
->blk[
£t
];

304 
byãs_to_ªad
 = (
WORD_SIZE
 * 
c
->
max_w‹ds_≥r_blk
);

308 
èrgë_ul⁄g
 
√w_∑ddr
 = 
∑ddr
 & 
c
->
èg_bôs_mask
;

309 
èrgë_ul⁄g
 
èg
 = 
∑ddr
 >> (
c
->
w‹d_bôs
);

312 
vi˘im
 = (*
c
->
p‚_gë_vi˘im_ödex
)(c, 
£t
);

314 
œãncy
 +(*
c
->
p‚_vi˘im_evi˘_h™dÀr
)(c, &(
blk
[
vi˘im
]), 
£t
, victim,

315 
p_mem_ac˚ss_öfo
, 
¥iv
);

319 
œãncy


320 +
	`ªad_d©a_öã∫Æ
(
c
, 
√w_∑ddr
, 
byãs_to_ªad
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

322 
blk
[
vi˘im
].
èg
 =Åag;

323 
blk
[
vi˘im
].
°©us
 = 
VÆid
;

326 
œãncy
 +(*
c
->
p‚_wrôe_h™dÀr
)(c, 
∑ddr
, 
byãs_to_wrôe
, 
£t
, 
vi˘im
,

327 
p_mem_ac˚ss_öfo
, 
¥iv
);

329  
œãncy
;

330 
	}
}

333 
	$wrôe_no_Æloˇã_h™dÀr
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
,

334 
byãs_to_wrôe
, 
£t
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

338 i‡(
NULL
 !
c
->
√xt_Àvñ_ˇche
)

340  
	`ˇche_wrôe
(
c
->
√xt_Àvñ_ˇche
, 
∑ddr
, 
byãs_to_wrôe
,

341 
p_mem_ac˚ss_öfo
, 
¥iv
);

344  
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
c
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_wrôe
, 
Wrôe
,

345 
p_mem_ac˚ss_öfo
);

346 
	}
}

349 
	$wrôeback_vi˘im_evi˘_h™dÀr
(c⁄° 
Cache
 *
c
, 
CacheBlk
 *
pBlk
, 
£t
, 
way
,

350 *
p_mem_ac˚ss_öfo
, 
¥iv
)

352 
œãncy
 = 0;

354 i‡(
NULL
 !
pBlk
)

358 i‡(
VÆid
 =
pBlk
->
°©us
 && 
Dúty
 =pBlk->
dúty
)

360 i‡(
NULL
 !
c
->
√xt_Àvñ_ˇche
)

362 
œãncy
 +
	`ˇche_wrôe
(

363 
c
->
√xt_Àvñ_ˇche
, (
pBlk
->
èg
 << c->
w‹d_bôs
),

364 (
WORD_SIZE
 * 
c
->
max_w‹ds_≥r_blk
), 
p_mem_ac˚ss_öfo
, 
¥iv
);

368 
œãncy


369 +
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
c
->
mem_c⁄åﬁÀr
, 
pBlk
->
èg
 << c->
w‹d_bôs
,

370 (
WORD_SIZE
 * 
c
->
max_w‹ds_≥r_blk
), 
Wrôe
,

371 
p_mem_ac˚ss_öfo
);

374 
	`mem£t
(
pBlk
, 0, (
CacheBlk
));

377  
œãncy
;

378 
	}
}

381 
	$wrôëhrough_vi˘im_evi˘_h™dÀr
(c⁄° 
Cache
 *
c
, 
CacheBlk
 *
pBlk
, 
£t
,

382 
way
, *
p_mem_ac˚ss_öfo
, 
¥iv
)

386 
	`mem£t
(
pBlk
, 0, (
CacheBlk
));

388 
	}
}

391 
	$ˇche_wrôe
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
,

392 *
p_mem_ac˚ss_öfo
, 
¥iv
)

394 
i
;

395 
uöt32_t
 
°¨t_byã
 = (
∑ddr
 & ((1 << 
c
->
w‹d_bôs
) - 1));

396 
uöt32_t
 
£t
 = (
∑ddr
 >> 
c
->
w‹d_bôs
Ë& ((1 << c->
£t_bôs
) - 1);

397 
èrgë_ul⁄g
 
èg
 = 
∑ddr
 >> (
c
->
w‹d_bôs
);

398 
œãncy
 = 
c
->
wrôe_œãncy
;

399 
avaûabÀ_byãs
 = 0;

400 
ˇche_miss_upd©ed
 = 0;

401 
CacheBlk
 *
blk
 = 
c
->blk[
£t
];

403 
c
->
°©s
[
¥iv
].
tŸÆ_wrôe_˙t
++;

405 
byãs_to_wrôe
 > 0)

407 
i
 = 0; i < 
c
->
num_ways
; ++i)

409 i‡((
blk
[
i
].
èg
 =ègË&& (blk[i].
°©us
 =
VÆid
))

412 i‡((
°¨t_byã
 + 
byãs_to_wrôe
)

413 <(
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
))

416 
œãncy
 +(*
c
->
p‚_wrôe_h™dÀr
)(

417 
c
, 
∑ddr
, 
byãs_to_wrôe
, 
£t
, 
i
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

418  
œãncy
;

422 
avaûabÀ_byãs


423 ((
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
Ë- 
°¨t_byã
);

427 
œãncy
 +(*
c
->
p‚_wrôe_h™dÀr
)(c, 
∑ddr
, 
avaûabÀ_byãs
,

428 
£t
, 
i
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

431 
	`upd©e_èg_addªss
(
c
, &
£t
, &
blk
, &
èg
, &
∑ddr
, &
byãs_to_wrôe
,

432 
avaûabÀ_byãs
);

437 i‡(
i
 < 
c
->
num_ways
)

446 i‡(!
ˇche_miss_upd©ed
)

448 
c
->
°©s
[
¥iv
].
wrôe_miss_˙t
++;

449 
ˇche_miss_upd©ed
 = 1;

453 i‡((
°¨t_byã
 + 
byãs_to_wrôe
Ë<(
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
))

455 
œãncy
 +(*
c
->
p‚_wrôe_Æloc_h™dÀr
)(c, 
∑ddr
, 
byãs_to_wrôe
,

456 
£t
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

461 
avaûabÀ_byãs
 = ((
c
->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
Ë- 
°¨t_byã
);

465 
œãncy
 +(*
c
->
p‚_wrôe_Æloc_h™dÀr
)(

466 
c
, 
∑ddr
, ((c->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
Ë- 
°¨t_byã
),

467 
£t
, 
p_mem_ac˚ss_öfo
, 
¥iv
);

470 
	`upd©e_èg_addªss
(
c
, &
£t
, &
blk
, &
èg
, &
∑ddr
, &
byãs_to_wrôe
,

471 
avaûabÀ_byãs
);

476  
œãncy
;

477 
	}
}

480 
	$ˇche_Êush
(c⁄° 
Cache
 *
c
)

482 
i
;

484 
i
 = 0; i < 
c
->
num_£ts
; ++i)

486 
	`mem£t
((*)
c
->
blk
[
i
], 0, (
CacheBlk
Ë* c->
num_ways
);

487 
	`mem£t
((*)
c
->
°©us_bôs
[
i
], 0, (Ë* (c->
num_ways
));

489 
	}
}

491 c⁄° 
CacheSèts
 *const

492 
	$gë_ˇche_°©s
(
Cache
 *
c
)

494  (c⁄° 
CacheSèts
 *c⁄°)(
c
->
°©s
);

495 
	}
}

498 
	$ª£t_ˇche_°©s
(
Cache
 *
c
)

500 
	`mem£t
((*)
c
->
°©s
, 0, 
NUM_MAX_PRV_LEVELS
 * (
CacheSèts
));

501 
	}
}

503 
Cache
 *

504 
	$¸óã_ˇche
(
CacheTy≥s
 
ty≥
, 
CacheLevñs
 
Àvñ
, 
uöt32_t
 
blks
, uöt32_à
ways
,

505 
ªad_œãncy
, 
wrôe_œãncy
, 
Cache
 *
√xt_Àvñ_ˇche
, 
w‹ds_≥r_blk
,

506 
CacheEvi˘i⁄Pﬁicy
 
evi˘_pﬁicy
, 
CacheWrôePﬁicy
 
wrôe_pﬁicy
,

507 
CacheRódAŒocPﬁicy
 
ªad_Æloc_pﬁicy
,

508 
CacheWrôeAŒocPﬁicy
 
wrôe_Æloc_pﬁicy
,

509 
Mem‹yC⁄åﬁÀr
 *
mem_c⁄åﬁÀr
)

511 
i
;

512 
Cache
 *
c
 = (Cachê*)
	`mÆloc
((Cache));

514 
c
->
ty≥
 =Åype;

515 
c
->
Àvñ
 =Üevel;

516 
c
->
num_blks
 = 
blks
;

517 
c
->
num_ways
 = 
ways
;

518 
c
->
num_£ts
 = (
blks
 / 
ways
);

521 
c
->
blk
 = (
CacheBlk
 **)
	`ˇŒoc
(c->
num_£ts
, (CacheBlk *));

522 
	`as£π
(
c
->
blk
);

525 
c
->
°©us_bôs
 = (**)
	`ˇŒoc
(c->
num_£ts
, (*));

526 
	`as£π
(
c
->
°©us_bôs
);

529 
i
 = 0; i < 
c
->
num_£ts
; ++i)

531 
c
->
blk
[
i
] = (
CacheBlk
 *)
	`ˇŒoc
(c->
num_ways
, (CacheBlk));

532 
	`as£π
(
c
->
blk
[
i
]);

534 
c
->
°©us_bôs
[
i
] = (*)
	`ˇŒoc
(c->
num_ways
, ());

535 
	`as£π
(
c
->
°©us_bôs
[
i
]);

538 
c
->
max_w‹ds_≥r_blk
 = 
w‹ds_≥r_blk
;

541 
c
->
w‹d_bôs
 = 
	`GET_NUM_BITS
(
WORD_SIZE
 * c->
max_w‹ds_≥r_blk
);

543 
c
->
£t_bôs
 = 
	`GET_NUM_BITS
(c->
num_£ts
);

546 
c
->
size
 = (c->
num_blks
 * c->
max_w‹ds_≥r_blk
 * 
WORD_SIZE
) / 1000;

549 
c
->
èg_bôs
 = ((
èrgë_ul⁄g
Ë* 8Ë- c->
w‹d_bôs
;

550 
c
->
èg_bôs_mask
 = (
èrgë_ul⁄g
)(
	`pow
(2, (target_ulong) * 8) - 1)

551 << 
c
->
w‹d_bôs
;

552 
c
->
max_èg_vÆ
 = (1 << c->
èg_bôs
);

554 
c
->
ªad_œãncy
 =Ñead_latency;

555 
c
->
wrôe_œãncy
 = write_latency;

556 
c
->
mem_c⁄åﬁÀr
 = mem_controller;

558 
c
->
√xt_Àvñ_ˇche
 =Çext_level_cache;

559 i‡(
NULL
 =
c
->
√xt_Àvñ_ˇche
)

561 
	`as£π
(
c
->
mem_c⁄åﬁÀr
);

564 
c
->
°©s
 = (
CacheSèts
 *)
	`ˇŒoc
(
NUM_MAX_PRV_LEVELS
, (CacheStats));

565 
	`as£π
(
c
->
°©s
);

567 
c
->
ˇche_evi˘_pﬁicy
 = 
evi˘_pﬁicy
;

568 
c
->
ˇche_wrôe_pﬁicy
 = 
wrôe_pﬁicy
;

569 
c
->
ˇche_ªad_Æloc_pﬁicy
 = 
ªad_Æloc_pﬁicy
;

570 
c
->
ˇche_wrôe_Æloc_pﬁicy
 = 
wrôe_Æloc_pﬁicy
;

573 
evi˘_pﬁicy
)

575 
R™dom
:

577 
c
->
p‚_gë_vi˘im_ödex
 = &
gë_øndom_vi˘im_ödex
;

581 
LRU
:

583 
c
->
p‚_gë_vi˘im_ödex
 = &
gë_Ãu_vi˘im_ödex
;

589 
wrôe_pﬁicy
)

591 
WrôeBack
:

593 
c
->
p‚_wrôe_h™dÀr
 = &
wrôeback_h™dÀr
;

594 
c
->
p‚_vi˘im_evi˘_h™dÀr
 = &
wrôeback_vi˘im_evi˘_h™dÀr
;

598 
WrôeThrough
:

600 
c
->
p‚_wrôe_h™dÀr
 = &
wrôëhrough_h™dÀr
;

601 
c
->
p‚_vi˘im_evi˘_h™dÀr
 = &
wrôëhrough_vi˘im_evi˘_h™dÀr
;

607 
ªad_Æloc_pﬁicy
)

609 
RódAŒoˇã
:

611 
c
->
p‚_ªad_Æloc_h™dÀr
 = &
ªad_Æloˇã_h™dÀr
;

615 
RódNoAŒoˇã
:

617 
c
->
p‚_ªad_Æloc_h™dÀr
 = &
ªad_no_Æloˇã_h™dÀr
;

623 
wrôe_Æloc_pﬁicy
)

625 
WrôeAŒoˇã
:

627 
c
->
p‚_wrôe_Æloc_h™dÀr
 = &
wrôe_Æloˇã_h™dÀr
;

631 
WrôeNoAŒoˇã
:

633 
c
->
p‚_wrôe_Æloc_h™dÀr
 = &
wrôe_no_Æloˇã_h™dÀr
;

638  
c
;

639 
	}
}

642 
	$dñëe_ˇche
(
Cache
 **
c
)

644 
i
;

646 
i
 = 0; i < (*
c
)->
num_£ts
; ++i)

648 
	`‰ì
((*
c
)->
blk
[
i
]);

649 (*
c
)->
blk
[
i
] = 
NULL
;

650 
	`‰ì
((*
c
)->
°©us_bôs
[
i
]);

651 (*
c
)->
°©us_bôs
[
i
] = 
NULL
;

653 
	`‰ì
((*
c
)->
blk
);

654 (*
c
)->
blk
 = 
NULL
;

655 
	`‰ì
((*
c
)->
°©us_bôs
);

656 (*
c
)->
°©us_bôs
 = 
NULL
;

657 
	`‰ì
((*
c
)->
°©s
);

658 (*
c
)->
°©s
 = 
NULL
;

659 
	`‰ì
(*
c
);

660 *
c
 = 
NULL
;

661 
	}
}

664 
	$¥öt_ˇche_c⁄fig
(c⁄° 
Cache
 *c⁄° 
c
)

666 
	`Ârötf
(
°dîr
, "\n");

667 
	`Ârötf
(
°dîr
, "Cache Configurations\n");

668 
	`Ârötf
(
°dîr
, "CachêTy≥: %u\n", 
c
->
ty≥
);

669 
	`Ârötf
(
°dîr
, "CachêLevñ: %u\n", 
c
->
Àvñ
);

670 
	`Ârötf
(
°dîr
, "TŸÆ No. o‡Blocks: %u\n", 
c
->
num_blks
);

671 
	`Ârötf
(
°dîr
, "TŸÆ No. o‡Ways: %u\n", 
c
->
num_ways
);

672 
	`Ârötf
(
°dîr
, "TŸÆ No. o‡Sës: %u\n", 
c
->
num_£ts
);

673 
	`Ârötf
(
°dîr
, "W‹d†≥∏Block: %u\n", 
c
->
max_w‹ds_≥r_blk
);

674 
	`Ârötf
(
°dîr
, "W‹d Size: %lu\n", 
WORD_SIZE
);

675 
	`Ârötf
(
°dîr
, "TŸÆ CachêSize: %lu KB\n", 
c
->
size
);

676 
	`Ârötf
(
°dîr
, "Off£t(w‹dËbôs: %u\n", 
c
->
w‹d_bôs
);

677 
	`Ârötf
(
°dîr
, "Së bôs: %u\n", 
c
->
£t_bôs
);

678 
	`Ârötf
(
°dîr
, "Tag bôs: %u\n", 
c
->
èg_bôs
);

679 
	`Ârötf
(
°dîr
, "Evi˘i⁄ Pﬁicy: [%d] %s\n", 
c
->
ˇche_evi˘_pﬁicy
,

680 
ˇche_evi˘_°r
[
c
->
ˇche_evi˘_pﬁicy
]);

681 
	`Ârötf
(
°dîr
, "WrôêPﬁicy: [%d] %s\n", 
c
->
ˇche_wrôe_pﬁicy
,

682 
ˇche_wp_°r
[
c
->
ˇche_wrôe_pﬁicy
]);

683 
	`Ârötf
(
°dîr
, "Ród AŒo¯Pﬁicy: [%d] %s\n", 
c
->
ˇche_ªad_Æloc_pﬁicy
,

684 
ˇche_ø_°r
[
c
->
ˇche_ªad_Æloc_pﬁicy
]);

685 
	`Ârötf
(
°dîr
, "Write Alloc Policy: [%d] %s\n",

686 
c
->
ˇche_wrôe_Æloc_pﬁicy
,

687 
ˇche_wa_°r
[
c
->
ˇche_wrôe_Æloc_pﬁicy
]);

688 
	`Ârötf
(
°dîr
, "\n");

689 
	`Ârötf
(
°dîr
, "\n");

690 
	}
}

	@riscvsim/cache.h

30 #i‚de‡
_CACHE_H_


31 
	#_CACHE_H_


	)

33 
	~"mem‹y_c⁄åﬁÀr.h
"

34 
	~"riscv_sim_ty≥defs.h
"

35 
	~"sim_∑øms_°©s.h
"

38 
	#WORD_SIZE
 ((
èrgë_ul⁄g
))

	)

40 
	gCacheBlk
;

41 
	gCache
;

43 (*
	tPFN_GET_VICTIM_INDEX
)(c⁄° 
	tCache
 *
	tc
, 
	t£t
);

44 (*
	tPFN_READ_ALLOC_HANDLER
)(c⁄° 
	tCache
 *
	tc
, 
	tèrgë_ul⁄g
 
	t∑ddr
,

45 
	tbyãs_to_ªad
, 
	t£t
,

46 *
	tp_mem_ac˚ss_öfo
, 
	t¥iv
);

47 (*
	tPFN_WRITE_HANDLER
)(c⁄° 
	tCache
 *
	tc
, 
	tèrgë_ul⁄g
 
	t∑ddr
,

48 
	tbyãs_to_wrôe
, 
	t£t
, 
	tway
,

49 *
	tp_mem_ac˚ss_öfo
, 
	t¥iv
);

50 (*
	tPFN_WRITE_ALLOC_HANDLER
)(c⁄° 
	tCache
 *
	tc
, 
	tèrgë_ul⁄g
 
	t∑ddr
,

51 
	tbyãs_to_wrôe
, 
	t£t
,

52 *
	tp_mem_ac˚ss_öfo
, 
	t¥iv
);

53 (*
	tPFN_VICTIM_EVICTION_HANDLER
)(c⁄° 
	tCache
 *
	tc
, 
	tCacheBlk
 *
	tpBlk
,

54 
	t£t
, 
	tway
,

55 *
	tp_mem_ac˚ss_öfo
, 
	t¥iv
);

58 
	eCacheTy≥s


60 
In°ru˘i⁄Cache
 = 0x1,

61 
D©aCache
 = 0x2,

62 
Sh¨edCache
 = 0x3,

63 } 
	tCacheTy≥s
;

66 
	eCacheLevñs


68 
L1
 = 0x1,

69 
L2
 = 0x2,

70 
L3
 = 0x3,

71 } 
	tCacheLevñs
;

74 
	eCacheEvi˘i⁄Pﬁicy


76 
R™dom
,

77 
LRU
,

78 } 
	tCacheEvi˘i⁄Pﬁicy
;

81 
	eBlockSètus


83 
Unu£d
 = 0x0,

84 
VÆid
 = 0x1,

85 } 
	tBlockSètus
;

88 
	eBlockDútySètus


90 
N⁄Dúty
 = 0x0,

91 
Dúty
 = 0x1

92 } 
	tBlockDútySètus
;

95 
	eCacheWrôeAŒocPﬁicy


97 
WrôeAŒoˇã
 = 0x0,

98 
WrôeNoAŒoˇã
 = 0x1,

99 } 
	tCacheWrôeAŒocPﬁicy
;

102 
	eCacheRódAŒocPﬁicy


104 
RódAŒoˇã
 = 0x0,

105 
RódNoAŒoˇã
 = 0x1,

106 } 
	tCacheRódAŒocPﬁicy
;

109 
	eCacheWrôePﬁicy


111 
WrôeBack
 = 0x0,

112 
WrôeThrough
 = 0x1,

113 } 
	tCacheWrôePﬁicy
;

116 
	sCacheSèts


118 
uöt64_t
 
tŸÆ_ªad_˙t
;

119 
uöt64_t
 
tŸÆ_wrôe_˙t
;

120 
uöt64_t
 
ªad_miss_˙t
;

121 
uöt64_t
 
wrôe_miss_˙t
;

122 } 
	tCacheSèts
;

125 
	sCacheBlk


127 
uöt8_t
 
°©us
;

128 
uöt8_t
 
dúty
;

129 
èrgë_ul⁄g
 
èg
;

130 } 
	tCacheBlk
;

133 
	sCache


135 
Àvñ
;

136 
ty≥
;

138 
num_ways
;

139 
num_blks
;

140 
num_£ts
;

141 
èg_bôs
;

142 
£t_bôs
;

143 
w‹d_bôs
;

144 
uöt64_t
 
size
;

146 
max_w‹ds_≥r_blk
;

147 
èrgë_ul⁄g
 
max_èg_vÆ
;

149 
èrgë_ul⁄g
 
èg_bôs_mask
;

150 
ªad_œãncy
;

151 
wrôe_œãncy
;

153 
CacheEvi˘i⁄Pﬁicy
 
ˇche_evi˘_pﬁicy
;

155 
CacheWrôePﬁicy
 
ˇche_wrôe_pﬁicy
;

156 
CacheRódAŒocPﬁicy
 
ˇche_ªad_Æloc_pﬁicy
;

157 
CacheWrôeAŒocPﬁicy
 
ˇche_wrôe_Æloc_pﬁicy
;

159 
Mem‹yC⁄åﬁÀr
 *
mem_c⁄åﬁÀr
;

163 
PFN_GET_VICTIM_INDEX
 
p‚_gë_vi˘im_ödex
;

166 
PFN_READ_ALLOC_HANDLER
 
p‚_ªad_Æloc_h™dÀr
;

169 
PFN_WRITE_HANDLER
 
p‚_wrôe_h™dÀr
;

172 
PFN_WRITE_ALLOC_HANDLER
 
p‚_wrôe_Æloc_h™dÀr
;

175 
PFN_VICTIM_EVICTION_HANDLER
 
p‚_vi˘im_evi˘_h™dÀr
;

177 
CacheBlk
 **
blk
;

178 **
°©us_bôs
;

181 
Cache
 *
√xt_Àvñ_ˇche
;

182 
CacheSèts
 *
°©s
;

183 } 
	tCache
;

185 
	`ˇche_ªad
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

186 *
p_mem_ac˚ss_öfo
, 
¥iv
);

187 
	`ˇche_wrôe
(c⁄° 
Cache
 *
c
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

188 *
p_mem_ac˚ss_öfo
, 
¥iv
);

190 
Cache
 *
	`¸óã_ˇche
(
CacheTy≥s
 
ty≥
, 
CacheLevñs
 
Àvñ
, 
uöt32_t
 
blks
,

191 
uöt32_t
 
ways
, 
ªad_œãncy
, 
wrôe_œãncy
, 
Cache
 *
√xt_Àvñ_ˇche
,

192 
w‹ds_≥r_blk
, 
CacheEvi˘i⁄Pﬁicy
 
evi˘_pﬁicy
,

193 
CacheWrôePﬁicy
 
wrôe_pﬁicy
,

194 
CacheRódAŒocPﬁicy
 
ªad_Æloc_pﬁicy
,

195 
CacheWrôeAŒocPﬁicy
 
wrôe_Æloc_pﬁicy
,

196 
Mem‹yC⁄åﬁÀr
 *
mem_c⁄åﬁÀr
);

197 
	`dñëe_ˇche
(
Cache
 **
c
);

199 c⁄° 
CacheSèts
 *c⁄° 
	`gë_ˇche_°©s
(
Cache
 *
c
);

200 
	`ª£t_ˇche_°©s
(
Cache
 *
c
);

201 
	`ˇche_Êush
(c⁄° 
Cache
 *
c
);

202 
	`¥öt_ˇche_c⁄fig
(c⁄° 
Cache
 *c⁄° 
c
);

	@riscvsim/circular_queue.c

30 
	~"cúcuœr_queue.h
"

33 
	$cq_öô
(
CQ
 *
p
, 
max_size_vÆ
)

35 
p
->
‰⁄t
 = -1;

36 
p
->
ª¨
 = -1;

37 
p
->
max_size
 = 
max_size_vÆ
;

38 
	}
}

41 
	$cq_íqueue
(
CQ
 *
p
)

43 i‡(
	`cq_fuŒ
(
p
))

48 i‡(
	`cq_em±y
(
p
))

51 
p
->
‰⁄t
 = 0;

52 
p
->
ª¨
 = 0;

53  
p
->
‰⁄t
;

55 i‡((
p
->
ª¨
 =’->
max_size
 - 1)Ë&& (p->
‰⁄t
 != 0))

58 
p
->
ª¨
 = 0;

59  
p
->
ª¨
;

63 (
p
->
ª¨
)++;

64  
p
->
ª¨
;

66 
	}
}

69 
	$cq_dequeue
(
CQ
 *
p
)

71 
ﬁd_‰⁄t
;

73 i‡(
	`cq_em±y
(
p
))

79 
ﬁd_‰⁄t
 = 
p
->
‰⁄t
;

81 i‡(
p
->
‰⁄t
 =p->
ª¨
)

84 
p
->
‰⁄t
 = -1;

85 
p
->
ª¨
 = -1;

87 i‡(
p
->
‰⁄t
 =’->
max_size
 - 1))

90 
p
->
‰⁄t
 = 0;

94 (
p
->
‰⁄t
)++;

97  
ﬁd_‰⁄t
;

98 
	}
}

101 
	$cq_em±y
(
CQ
 *
p
)

103 i‡(
p
->
‰⁄t
 == -1)

108 
	}
}

111 
	$cq_fuŒ
(
CQ
 *
p
)

113 i‡((
p
->
‰⁄t
 =0 && (p->
ª¨
 =’->
max_size
 - 1)))

114 || ((
p
->
max_size
 > 1)

115 && (
p
->
ª¨
 =(’->
‰⁄t
 - 1Ë% (p->
max_size
 - 1)))))

120 
	}
}

123 
	$cq_ª£t
(
CQ
 *
p
)

125 
p
->
‰⁄t
 = -1;

126 
p
->
ª¨
 = -1;

127 
	}
}

130 
	$cq_‰⁄t
(
CQ
 *
p
)

132  
p
->
‰⁄t
;

133 
	}
}

136 
	$cq_ª¨
(
CQ
 *
p
)

138  
p
->
ª¨
;

139 
	}
}

142 
	$cq_£t_ª¨
(
CQ
 *
p
, 
ª¨
)

144 
p
->
ª¨
 =Ñear;

145 
	}
}

	@riscvsim/circular_queue.h

33 #i‚de‡
_CIRCULAR_QUEUE_H_


34 
	#_CIRCULAR_QUEUE_H_


	)

36 
	sCúcuœrQueue


38 
	m‰⁄t
;

39 
	mª¨
;

40 
	mmax_size
;

41 } 
	tCQ
;

43 
cq_öô
(
CQ
 *
p
, 
max_size_vÆ
);

44 
cq_ª£t
(
CQ
 *
p
);

45 
cq_íqueue
(
CQ
 *
p
);

46 
cq_dequeue
(
CQ
 *
p
);

47 
cq_em±y
(
CQ
 *
p
);

48 
cq_fuŒ
(
CQ
 *
p
);

49 
cq_‰⁄t
(
CQ
 *
p
);

50 
cq_ª¨
(
CQ
 *
p
);

51 
cq_£t_ª¨
(
CQ
 *
p
, 
ª¨
);

	@riscvsim/common_core_utils.c

30 
	~"comm⁄_c‹e_utûs.h
"

31 
	~"../cutûs.h
"

32 
	~"../riscv_˝u_¥iv.h
"

33 
	~"riscv_iß_decodî_lib.h
"

35 
	g˝u_mode_°r
[][128] = { "U-mode", "S-mode", "H-mode", "M-mode" };

40 
	$˝u_°age_Êush
(
CPUSège
 *
°age
)

42 
°age
->
has_d©a
 = 
FALSE
;

43 
°age
->
im≠_ödex
 = -1;

44 
°age
->
°age_exec_d⁄e
 = 
FALSE
;

45 
	}
}

48 
	$exec_unô_Êush
(
CPUSège
 *
°age
, 
num_°ages
)

50 
i
;

52 
i
 = 0; i < 
num_°ages
; ++i)

54 
	`˝u_°age_Êush
(&
°age
[
i
]);

56 
	}
}

60 
	$•ecuœtive_˝u_°age_Êush
(
CPUSège
 *
°age
, 
IM≠E¡ry
 *
im≠
)

62 i‡(
°age
->
im≠_ödex
 != -1)

64 
im≠
[
°age
->
im≠_ödex
].
°©us
 = 
IMAP_ENTRY_STATUS_FREE
;

66 
	`˝u_°age_Êush
(
°age
);

67 
	}
}

71 
	$•ecuœtive_exec_unô_Êush
(
CPUSège
 *
°age
, 
num_°ages
, 
IM≠E¡ry
 *
im≠
)

73 
i
;

75 
i
 = 0; i < 
num_°ages
; ++i)

77 
	`•ecuœtive_˝u_°age_Êush
(&
°age
[
i
], 
im≠
);

79 
	}
}

82 
	$gë_‰ì_im≠_íåy
(
IM≠E¡ry
 *
im≠
)

84 
i
;

86 
i
 = 0; i < 
NUM_IMAP_ENTRY
; ++i)

88 i‡(
im≠
[
i
].
°©us
 =
IMAP_ENTRY_STATUS_FREE
)

90  
i
;

95 
	}
}

97 
IM≠E¡ry
 *

98 
	$Æloˇã_im≠_íåy
(
IM≠E¡ry
 *
im≠
)

100 
IM≠E¡ry
 *
e
;

101 
im≠_ödex
;

103 
im≠_ödex
 = 
	`gë_‰ì_im≠_íåy
(
im≠
);

104 
	`as£π
(
im≠_ödex
 != -1);

105 
e
 = &
im≠
[
im≠_ödex
];

106 
	`mem£t
((*)
e
, 0, (
IM≠E¡ry
));

107 
e
->
°©us
 = 
IMAP_ENTRY_STATUS_ALLOCATED
;

108 
e
->
im≠_ödex
 = imap_index;

109  
e
;

110 
	}
}

113 
	$ª£t_im≠
(
IM≠E¡ry
 *
im≠
)

115 
i
;

118 
i
 = 0; i < 
NUM_IMAP_ENTRY
; ++i)

120 
im≠
[
i
].
°©us
 = 
IMAP_ENTRY_STATUS_FREE
;

122 
	}
}

124 
IM≠E¡ry
 *

125 
	$gë_im≠_íåy
(
IM≠E¡ry
 *
im≠
, 
ödex
)

127  (&
im≠
[
ödex
]);

128 
	}
}

131 
	$code_éb_ac˚ss_™d_ös_„tch
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

133 
RISCVSIMCPUSèã
 *
sim˝u
 = 
s
->simcpu;

135 i‡(
	`u∆ikñy
(
s
->
code_±r
 >s->
code_íd
))

137 
uöt32_t
 
éb_idx
;

138 
uöt16_t
 
ö¢_high
;

139 
uöt8_t
 *
±r
;

140 
èrgë_ul⁄g
 
addr
 = 
sim˝u
->
pc
;

142 ++
sim˝u
->
°©s
[
s
->
¥iv
].
code_éb_lookups
;

145 
éb_idx
 = (
addr
 >> 
PG_SHIFT
Ë& (
TLB_SIZE
 - 1);

146 i‡(
	`likñy
(
s
->
éb_code
[
éb_idx
].
vaddr
 =(
addr
 & ~
PG_MASK
)))

149 
±r
 = (
uöt8_t
 *)(
s
->
éb_code
[
éb_idx
].
mem_addíd


150 + (
uöçå_t
)
addr
);

151 ++
sim˝u
->
°©s
[
s
->
¥iv
].
code_éb_hôs
;

155 i‡(
	`u∆ikñy
(
	`èrgë_ªad_ö¢_¶ow
(
s
, &
±r
, 
addr
)))

156 
ex˚±i⁄
;

159 
s
->
code_±r
 = 
±r
;

160 
s
->
code_íd
 = 
±r
 + (
PG_MASK
 - 1 - (
addr
 & PG_MASK));

161 
s
->
code_to_pc_addíd
 = 
addr
 - (
uöçå_t
)s->
code_±r
;

163 
s
->
code_gue°_∑ddr
 = s->
éb_code
[
éb_idx
].
gue°_∑ddr


164 + (
addr
 - 
s
->
éb_code
[
éb_idx
].
vaddr
);

166 i‡(
	`u∆ikñy
(
s
->
code_±r
 >s->
code_íd
))

169 
e
->
ös
.
bö¨y
 = *(
uöt16_t
 *)(
s
->
code_±r
);

170 i‡((
e
->
ös
.
bö¨y
 & 3) == 3)

173 i‡(
	`u∆ikñy
(
	`èrgë_ªad_ö¢_u16
(
s
, &
ö¢_high
, 
addr
 + 2)))

174 
ex˚±i⁄
;

175 
e
->
ös
.
bö¨y
 |
ö¢_high
 << 16;

180 
e
->
ös
.
bö¨y
 = 
	`gë_ö¢32
(
s
->
code_±r
);

186 
e
->
ös
.
bö¨y
 = 
	`gë_ö¢32
(
s
->
code_±r
);

189 
ex˚±i⁄
:

191 
	}
}

194 
	$do_„tch_°age_exec
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

200 
s
->
hw_pg_tb_wlk_œãncy
 = 1;

201 
s
->
hw_pg_tb_wlk_°age_id
 = 
FETCH
;

202 
s
->
ös_éb_lookup_accou¡ed
 = 
FALSE
;

203 
s
->
ös_éb_hô_accou¡ed
 = 
FALSE
;

207 
e
->
cuºít_œãncy
 = 1;

208 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_size
 = 0;

211 i‡(
	`code_éb_ac˚ss_™d_ös_„tch
(
s
, 
e
))

215 
e
->
ös
.
ex˚±i⁄
 = 
TRUE
;

216 
e
->
ös
.
ex˚±i⁄_ˇu£
 = 
SIM_MMU_EXCEPTION
;

220 
e
->
max_œãncy
 = 
s
->
hw_pg_tb_wlk_œãncy
;

226 
e
->
max_œãncy
 = 
s
->
hw_pg_tb_wlk_œãncy


227 + 
	`mmu_ö¢_ªad
(
s
->
sim˝u
->
mmu
, s->
code_gue°_∑ddr
, 4,

228 
FETCH
, 
s
->
¥iv
);

230 i‡(
s
->
sim_∑øms
->
íabÀ_l1_ˇches
)

233 
e
->
max_œãncy
 -
	`mö_öt
(
s
->
hw_pg_tb_wlk_œãncy
,

234 
s
->
sim˝u
->
mmu
->
iˇche
->
ªad_œãncy
);

238 i‡(3 =(
e
->
ös
.
bö¨y
 & 3))

240 
s
->
code_±r
 = s->code_ptr + 4;

241 
s
->
code_gue°_∑ddr
 = s->code_guest_paddr + 4;

246 
s
->
code_±r
 = s->code_ptr + 2;

247 
s
->
code_gue°_∑ddr
 = s->code_guest_paddr + 2;

251 
s
->
sim˝u
->
	`p‚_bønch_‰⁄ãnd_¥obe_h™dÀr
(s, 
e
);

253 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_„tch
;

255 
	}
}

258 
	$do_decode_°age_exec
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

261 
e
->
ös
.
cuºít_fs
 = 
s
->
fs
;

262 
e
->
ös
.
rm
 = 
	`gë_ö¢_rm
(
s
, (e->ös.
bö¨y
 >> 12) & 7);

265 
	`decode_riscv_bö¨y
(&
e
->
ös
,É->ös.
bö¨y
);

266 
	}
}

269 
	$£t_ex˚±i⁄_°©e
(
RISCVCPUSèã
 *
s
, c⁄° 
IM≠E¡ry
 *
e
)

271 
s
->
sim_ex˚±i⁄
 = 
TRUE
;

272 
s
->
sim_ïc
 = 
e
->
ös
.
pc
;

273 
s
->
sim_ex˚±i⁄_ˇu£
 = 
e
->
ös
.
ex˚±i⁄_ˇu£
;

274 
s
->
sim_ex˚±i⁄_ös
 = 
e
->
ös
.
bö¨y
;

275 
	`°∫˝y
(
s
->
sim_ïc_°r
, 
e
->
ös
.
°r
, 
RISCV_INS_STR_MAX_LENGTH
);

276 
s
->
sim_ïc_°r
[
RISCV_INS_STR_MAX_LENGTH
 - 1] = '\0';

277 
	}
}

280 
	$£t_timî_ex˚±i⁄_°©e
(
RISCVCPUSèã
 *
s
, c⁄° 
IM≠E¡ry
 *
e
)

282 
uöt32_t
 
ö¢
 = 
e
->
ös
.
bö¨y
;

283 
èrgë_ul⁄g
 
pc
 = 
e
->
ös
.pc;

285 
s
->
sim_ex˚±i⁄
 = 
TRUE
;

286 
s
->
sim_ex˚±i⁄_ˇu£
 = 
SIM_TIMEOUT_EXCEPTION
;

290 i‡(
	`u∆ikñy
(
e
->
ös
.
is_bønch
 &&É->
is_bønch_èkí
))

292 
s
->
sim_ïc
 = 
e
->
bønch_èrgë
;

297 i‡((
ö¢
 & 3) != 3)

299 
s
->
sim_ïc
 = 
pc
 + 2;

303 
s
->
sim_ïc
 = 
pc
 + 4;

306 
	}
}

308 
	#MEMORY_OP_A
(
size
) \

310 
uöt
##
size
##
_t
 
rvÆ
; \

311 
èrgë_ul⁄g
 
addr
 = 
e
->
ös
.
mem_addr
; \

312 
uöt32_t
 
fun˘3
 = 
e
->
ös
.
bö¨y
 >> 27; \

313 
fun˘3
) \

316 i‡(
èrgë_ªad_u
##
	`size
(
s
, &
rvÆ
, 
addr
)) \

317 
mmu_ex˚±i⁄
; \

318 
vÆ
 = (##
size
##
_t
)
rvÆ
; \

319 
s
->
lﬂd_ªs
 = 
e
->
ös
.
mem_addr
; \

322 i‡(
s
->
lﬂd_ªs
 =
addr
) \

324 i‡(
èrgë_wrôe_u
##
	`size
(
s
, 
addr
, 
e
->
ös
.
rs2_vÆ
)) \

325 
mmu_ex˚±i⁄
; \

326 
vÆ
 = 0; \

330 
vÆ
 = 1; \

342 i‡(
èrgë_ªad_u
##
	`size
(
s
, &
rvÆ
, 
addr
)) \

344 
mmu_ex˚±i⁄
; \

346 
vÆ
 = (##
size
##
_t
)
rvÆ
; \

347 
vÆ2
 = 
e
->
ös
.
rs2_vÆ
; \

348 
fun˘3
) \

353 
vÆ2
 = (##
size
##
_t
)(
vÆ
 + val2); \

356 
vÆ2
 = (##
size
##
_t
)(
vÆ
 ^ val2); \

359 
vÆ2
 = (##
size
##
_t
)(
vÆ
 & val2); \

362 
vÆ2
 = (##
size
##
_t
)(
vÆ
 | val2); \

365 i‡((##
size
##
_t
)
vÆ
 < (##size##_t)
vÆ2
) \

366 
vÆ2
 = (##
size
##
_t
)
vÆ
; \

369 i‡((##
size
##
_t
)
vÆ
 > (##size##_t)
vÆ2
) \

370 
vÆ2
 = (##
size
##
_t
)
vÆ
; \

373 i‡((
uöt
##
size
##
_t
)
vÆ
 < (uöt##size##_t)
vÆ2
) \

374 
vÆ2
 = (##
size
##
_t
)
vÆ
; \

377 i‡((
uöt
##
size
##
_t
)
vÆ
 > (uöt##size##_t)
vÆ2
) \

378 
vÆ2
 = (##
size
##
_t
)
vÆ
; \

381 i‡(
èrgë_wrôe_u
##
	`size
(
s
, 
addr
, 
vÆ2
)) \

383 
mmu_ex˚±i⁄
; \

387 }

	)

390 
	$execuã_©omic
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

392 
èrgë_ul⁄g
 
vÆ
 = 0, 
vÆ2
 = 0;

394 
e
->
ös
.
fun˘3
)

397 
	`MEMORY_OP_A
(32);

399 #i‡
BIT_SIZE
 >= 64

401 
	`MEMORY_OP_A
(64);

405 
e
->
ös
.
buf„r
 = 
vÆ
;

407 
mmu_ex˚±i⁄
:

409 
	}
}

412 
	$execuã_lﬂd_°‹e
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

414 
èrgë_ul⁄g
 
addr
 = 
e
->
ös
.
mem_addr
;

416 i‡(
e
->
ös
.
is_lﬂd
)

418 
e
->
ös
.
byãs_to_rw
)

422 
uöt8_t
 
rvÆ
;

423 i‡(
	`èrgë_ªad_u8
(
s
, &
rvÆ
, 
addr
))

424 
ex˚±i⁄
;

425 i‡(
e
->
ös
.
is_unsig√d
)

427 
e
->
ös
.
buf„r
 = 
rvÆ
;

431 
e
->
ös
.
buf„r
 = (
öt8_t
)
rvÆ
;

438 
uöt16_t
 
rvÆ
;

439 i‡(
	`èrgë_ªad_u16
(
s
, &
rvÆ
, 
addr
))

440 
ex˚±i⁄
;

441 i‡(
e
->
ös
.
is_unsig√d
)

443 
e
->
ös
.
buf„r
 = 
rvÆ
;

447 
e
->
ös
.
buf„r
 = (
öt16_t
)
rvÆ
;

454 
uöt32_t
 
rvÆ
;

455 i‡(
	`èrgë_ªad_u32
(
s
, &
rvÆ
, 
addr
))

456 
ex˚±i⁄
;

457 i‡(
e
->
ös
.
is_unsig√d
)

459 
e
->
ös
.
buf„r
 = 
rvÆ
;

463 
e
->
ös
.
buf„r
 = (
öt32_t
)
rvÆ
;

470 
uöt64_t
 
rvÆ
;

471 i‡(
	`èrgë_ªad_u64
(
s
, &
rvÆ
, 
addr
))

472 
ex˚±i⁄
;

473 i‡(
e
->
ös
.
is_unsig√d
)

475 
e
->
ös
.
buf„r
 = 
rvÆ
;

479 
e
->
ös
.
buf„r
 = (
öt64_t
)
rvÆ
;

485 i‡(
e
->
ös
.
is_°‹e
)

487 
e
->
ös
.
byãs_to_rw
)

491 i‡(
	`èrgë_wrôe_u8
(
s
, 
addr
, 
e
->
ös
.
rs2_vÆ
))

492 
ex˚±i⁄
;

498 i‡(
	`èrgë_wrôe_u16
(
s
, 
addr
, 
e
->
ös
.
rs2_vÆ
))

499 
ex˚±i⁄
;

505 i‡(
	`èrgë_wrôe_u32
(
s
, 
addr
, 
e
->
ös
.
rs2_vÆ
))

506 
ex˚±i⁄
;

512 i‡(
	`èrgë_wrôe_u64
(
s
, 
addr
, 
e
->
ös
.
rs2_vÆ
))

513 
ex˚±i⁄
;

518 i‡(
e
->
ös
.
is_©omic
)

520 i‡(
	`execuã_©omic
(
s
, 
e
))

522 
ex˚±i⁄
;

530 
ex˚±i⁄
:

532 
	}
}

535 
	$gë_d©a_mem_ac˚ss_œãncy
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

537 
œãncy
 = 0;

538 
RISCVSIMCPUSèã
 *
sim˝u
 = 
s
->simcpu;

540 i‡((
e
->
ös
.
is_lﬂd
 ||É->ös.
is_©omic_lﬂd
))

542 
œãncy
 +
	`mmu_d©a_ªad
(
sim˝u
->
mmu
, 
s
->
d©a_gue°_∑ddr
,

543 
e
->
ös
.
byãs_to_rw
, 
MEMORY
, 
s
->
¥iv
);

545 i‡((
e
->
ös
.
is_°‹e
 ||É->ös.
is_©omic_°‹e
))

547 
œãncy
 +
	`mmu_d©a_wrôe
(
sim˝u
->
mmu
, 
s
->
d©a_gue°_∑ddr
,

548 
e
->
ös
.
byãs_to_rw
, 
MEMORY
, 
s
->
¥iv
);

550 i‡(
œãncy
)

552  
œãncy
;

559 
	}
}

562 
	$h™dÀ_bpu_‰⁄ãnd_¥obe
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

564 
èrgë_ul⁄g
 
bpu_èrgë
;

566 
bpu_èrgë
 = 0;

567 
	`bpu_¥obe
(
s
->
sim˝u
->
bpu
, 
e
->
ös
.
pc
, &e->
bpu_ª•_pkt
, s->
¥iv
);

568 i‡(
e
->
bpu_ª•_pkt
.
bpu_¥obe_°©us
)

570 
bpu_èrgë
 = 
	`bpu_gë_èrgë
(
s
->
sim˝u
->
bpu
, 
e
->
ös
.
pc
,

571 
e
->
bpu_ª•_pkt
.
btb_íåy
);

575 i‡(
bpu_èrgë
)

577 
s
->
code_±r
 = 
NULL
;

578 
s
->
code_íd
 = 
NULL
;

579 
s
->
code_to_pc_addíd
 = 
bpu_èrgë
;

585 
e
->
¥edi˘ed_èrgë
 = 
bpu_èrgë
;

586 
	}
}

589 
	$h™dÀ_no_bpu_‰⁄ãnd_¥obe
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

593 
	}
}

596 
	$h™dÀ_bønch_decode_no_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

598  
FALSE
;

599 
	}
}

602 
	$h™dÀ_bønch_decode_wôh_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

604 
èrgë_ul⁄g
 
øs_èrgë
 = 0;

608 i‡(!
e
->
bpu_ª•_pkt
.
bpu_¥obe_°©us
)

610 
	`bpu_add
(
s
->
sim˝u
->
bpu
, 
e
->
ös
.
pc
,É->ös.
bønch_ty≥
, &e->
bpu_ª•_pkt
,

611 
s
->
¥iv
, 
e
->
ös
.
is_func_ªt
);

615 i‡(
s
->
sim˝u
->
∑øms
->
øs_size
)

617 i‡(
e
->
ös
.
is_func_ˇŒ
)

619 
	`øs_push
(

620 
s
->
sim˝u
->
bpu
->
øs
,

621 ((
e
->
ös
.
bö¨y
 & 3Ë=3 ?É->ös.
pc
 + 4 :É->ins.pc + 2));

624 i‡(
e
->
ös
.
is_func_ªt
)

626 
øs_èrgë
 = 
	`øs_p›
(
s
->
sim˝u
->
bpu
->
øs
);

629 i‡(
øs_èrgë
)

631 
s
->
code_±r
 = 
NULL
;

632 
s
->
code_íd
 = 
NULL
;

633 
s
->
code_to_pc_addíd
 = 
øs_èrgë
;

634 
e
->
¥edi˘ed_èrgë
 = 
øs_èrgë
;

636 
	`mem_c⁄åﬁÀr_Êush_°age_mem_ac˚ss_queue
(

637 &
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue
);

640  
TRUE
;

646  
FALSE
;

647 
	}
}

653 
	$h™dÀ_c⁄d_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

655 
èrgë_ul⁄g
 
ª°‹e_pc
;

656 
¥ed
 = 0;

657 
mi•ªdi˘
 = 
FALSE
;

658 
RISCVSIMCPUSèã
 *
sim˝u
 = 
s
->simcpu;

660 
	`bpu_¥obe
(
sim˝u
->
bpu
, 
e
->
ös
.
pc
, &e->
bpu_ª•_pkt
, 
s
->
¥iv
);

662 i‡(
e
->
ös
.
c⁄d
)

665 
¥ed
 = 
TRUE
;

666 i‡(!
e
->
¥edi˘ed_èrgë
)

668 ++
sim˝u
->
°©s
[
s
->
¥iv
].
bpu_c⁄d_öc‹ª˘
;

669 
e
->
bønch_èrgë
 =É->
ös
.
èrgë
;

670 
mi•ªdi˘
 = 
TRUE
;

675 
	`as£π
(
e
->
¥edi˘ed_èrgë
 =e->
ös
.
èrgë
);

676 
e
->
is_¥ed_c‹ª˘
 = 
TRUE
;

677 
e
->
bønch_èrgë
 =É->
¥edi˘ed_èrgë
;

678 ++
sim˝u
->
°©s
[
s
->
¥iv
].
bpu_c⁄d_c‹ª˘
;

680 
e
->
is_bønch_èkí
 = 
TRUE
;

685 i‡(
e
->
¥edi˘ed_èrgë
)

689 
ª°‹e_pc


690 ((
e
->
ös
.
bö¨y
 & 3Ë!3Ë?É->ös.
pc
 + 2 :É->ins.pc + 4;

691 ++
sim˝u
->
°©s
[
s
->
¥iv
].
bpu_c⁄d_öc‹ª˘
;

692 
e
->
bønch_èrgë
 = 
ª°‹e_pc
;

693 
mi•ªdi˘
 = 
TRUE
;

698 
e
->
is_¥ed_c‹ª˘
 = 
TRUE
;

699 ++
sim˝u
->
°©s
[
s
->
¥iv
].
bpu_c⁄d_c‹ª˘
;

701 
e
->
is_bønch_èkí
 = 
FALSE
;

705 
	`bpu_upd©e
(
sim˝u
->
bpu
, 
e
->
ös
.
pc
,É->ös.
èrgë
, 
¥ed
, 
BRANCH_COND
,

706 &
e
->
bpu_ª•_pkt
, 
s
->
¥iv
);

708  
mi•ªdi˘
;

709 
	}
}

715 
	$h™dÀ_unc⁄d_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

717 
RISCVSIMCPUSèã
 *
sim˝u
 = 
s
->simcpu;

718 
ty≥
 = 
BRANCH_UNCOND
;

719 
mi•ªdi˘
 = 
FALSE
;

720 
	`bpu_¥obe
(
sim˝u
->
bpu
, 
e
->
ös
.
pc
, &e->
bpu_ª•_pkt
, 
s
->
¥iv
);

723 
	`bpu_upd©e
(
sim˝u
->
bpu
, 
e
->
ös
.
pc
,É->ös.
èrgë
, 
TRUE
, 
ty≥
,

724 &
e
->
bpu_ª•_pkt
, 
s
->
¥iv
);

726 i‡(
e
->
¥edi˘ed_èrgë
 =e->
ös
.
èrgë
)

729 
e
->
is_¥ed_c‹ª˘
 = 
TRUE
;

733 
e
->
bønch_èrgë
 =É->
¥edi˘ed_èrgë
;

734 ++
sim˝u
->
°©s
[
s
->
¥iv
].
bpu_unc⁄d_c‹ª˘
;

739 ++
sim˝u
->
°©s
[
s
->
¥iv
].
bpu_unc⁄d_öc‹ª˘
;

740 
e
->
bønch_èrgë
 =É->
ös
.
èrgë
;

741 
mi•ªdi˘
 = 
TRUE
;

744 
e
->
is_bønch_èkí
 = 
TRUE
;

745  
mi•ªdi˘
;

746 
	}
}

749 
	$h™dÀ_bønch_wôh_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

751 
e
->
ös
.
bønch_ty≥
)

753 
BRANCH_UNCOND
:

755  
	`h™dÀ_unc⁄d_bpu
(
s
, 
e
);

757 
BRANCH_COND
:

759  
	`h™dÀ_c⁄d_bpu
(
s
, 
e
);

764 
	}
}

767 
	$h™dÀ_bønch_no_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

769 
mi•ªdi˘
 = 
FALSE
;

771 
e
->
ös
.
bønch_ty≥
)

773 
BRANCH_UNCOND
:

775 
e
->
is_bønch_èkí
 = 
TRUE
;

776 
e
->
bønch_èrgë
 =É->
ös
.
èrgë
;

777 
mi•ªdi˘
 = 
TRUE
;

780 
BRANCH_COND
:

782 i‡(
e
->
ös
.
c⁄d
)

784 
e
->
is_bønch_èkí
 = 
TRUE
;

785 
e
->
bønch_èrgë
 =É->
ös
.
èrgë
;

786 
mi•ªdi˘
 = 
TRUE
;

792  
mi•ªdi˘
;

793 
	}
}

796 
	$c›y_ˇche_°©s_to_globÆ_°©s
(
RISCVCPUSèã
 *
s
)

798 
i
;

799 c⁄° 
CacheSèts
 *
ˇche_°©s
;

802 i‡(
s
->
sim_∑øms
->
íabÀ_l1_ˇches
)

804 
i
 = 0; i < 
NUM_MAX_PRV_LEVELS
; ++i)

806 
ˇche_°©s
 = 
	`gë_ˇche_°©s
(
s
->
sim˝u
->
mmu
->
iˇche
);

807 
s
->
sim˝u
->
°©s
[
i
].
iˇche_ªad
 = 
ˇche_°©s
[i].
tŸÆ_ªad_˙t
;

808 
s
->
sim˝u
->
°©s
[
i
].
iˇche_ªad_miss
 = 
ˇche_°©s
[i].
ªad_miss_˙t
;

810 
ˇche_°©s
 = 
	`gë_ˇche_°©s
(
s
->
sim˝u
->
mmu
->
dˇche
);

811 
s
->
sim˝u
->
°©s
[
i
].
dˇche_ªad
 = 
ˇche_°©s
[i].
tŸÆ_ªad_˙t
;

812 
s
->
sim˝u
->
°©s
[
i
].
dˇche_ªad_miss
 = 
ˇche_°©s
[i].
ªad_miss_˙t
;

813 
s
->
sim˝u
->
°©s
[
i
].
dˇche_wrôe
 = 
ˇche_°©s
[i].
tŸÆ_wrôe_˙t
;

814 
s
->
sim˝u
->
°©s
[
i
].
dˇche_wrôe_miss
 = 
ˇche_°©s
[i].
wrôe_miss_˙t
;

816 i‡(
s
->
sim_∑øms
->
íabÀ_l2_ˇche
)

818 
ˇche_°©s
 = 
	`gë_ˇche_°©s
(
s
->
sim˝u
->
mmu
->
l2_ˇche
);

819 
s
->
sim˝u
->
°©s
[
i
].
l2_ˇche_ªad
 = 
ˇche_°©s
[i].
tŸÆ_ªad_˙t
;

820 
s
->
sim˝u
->
°©s
[
i
].
l2_ˇche_ªad_miss
 = 
ˇche_°©s
[i].
ªad_miss_˙t
;

821 
s
->
sim˝u
->
°©s
[
i
].
l2_ˇche_wrôe
 = 
ˇche_°©s
[i].
tŸÆ_wrôe_˙t
;

822 
s
->
sim˝u
->
°©s
[
i
].
l2_ˇche_wrôe_miss


823 
ˇche_°©s
[
i
].
wrôe_miss_˙t
;

827 
	}
}

830 
	$sim_¥öt_ös_åa˚
(
RISCVCPUSèã
 *
s
)

832 
	`Ârötf
(
s
->
sim_åa˚
, "cy˛e=%" 
TARGET_ULONG_FMT
, s->
sim˝u
->
˛ock
);

833 
	`Ârötf
(
s
->
sim_åa˚
, "Öc=%" 
TARGET_ULONG_HEX
,

834 
s
->
sim˝u
->
sim_åa˚_pkt
.
e
->
ös
.
pc
);

835 
	`Ârötf
(
s
->
sim_åa˚
, " in¢=%" 
PRIx32
, s->
sim˝u
->
sim_åa˚_pkt
.
e
->
ös
.
bö¨y
);

836 
	`Ârötf
(
s
->
sim_åa˚
, " %s", s->
sim˝u
->
sim_åa˚_pkt
.
e
->
ös
.
°r
);

837 
	`Ârötf
(
s
->
sim_åa˚
, " mode=%s", 
˝u_mode_°r
[s->
¥iv
]);

838 
	`Ârötf
(
s
->
sim_åa˚
, "\n");

839 
	}
}

842 
	$sim_¥öt_exp_åa˚
(
RISCVCPUSèã
 *
s
)

844 
	`Ârötf
(
s
->
sim_åa˚
, "cy˛e=%" 
TARGET_ULONG_FMT
, s->
sim˝u
->
˛ock
);

845 
	`Ârötf
(
s
->
sim_åa˚
, "Öc=%" 
TARGET_ULONG_HEX
, s->
sim_ïc
);

846 
	`Ârötf
(
s
->
sim_åa˚
, " in¢=%" 
PRIx32
, s->
sim_ex˚±i⁄_ös
);

847 
	`Ârötf
(
s
->
sim_åa˚
, " %s", s->
sim_ïc_°r
);

848 
	`Ârötf
(
s
->
sim_åa˚
, " mode=%s", 
˝u_mode_°r
[s->
¥iv
]);

849 
	`Ârötf
(
s
->
sim_åa˚
, "\n");

850 
	}
}

853 
	$upd©e_¨ch_ªg_öt
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

855 i‡(
e
->
ös
.
rd
)

857 
s
->
ªg
[
e
->
ös
.
rd
] =É->ös.
buf„r
;

858 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
öt_ªgfûe_wrôes
;

860 
	}
}

863 
	$upd©e_¨ch_ªg_Â
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

865 i‡(
e
->
ös
.
f32_mask
)

867 
e
->
ös
.
buf„r
 |
F32_HIGH
;

869 i‡(
e
->
ös
.
f64_mask
)

871 
e
->
ös
.
buf„r
 |
F64_HIGH
;

873 
s
->
Â_ªg
[
e
->
ös
.
rd
] =É->ös.
buf„r
;

874 i‡(
e
->
ös
.
£t_fs
)

876 
s
->
fs
 = 3;

878 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
Â_ªgfûe_wrôes
;

879 
	}
}

882 
	$upd©e_ö¢_commô_°©s
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

884 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_simuœãd
;

885 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_ty≥
[
e
->
ös
.
ty≥
];

887 i‡((
e
->
ös
.
ty≥
 =
INS_TYPE_COND_BRANCH
Ë&&É->
is_bønch_èkí
)

889 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ös_c⁄d_bønch_èkí
;

891 
	}
}

894 
	$£tup_sim_åa˚_pkt
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
)

896 
s
->
sim˝u
->
sim_åa˚_pkt
.
cy˛e
 = s->sim˝u->
˛ock
;

897 
s
->
sim˝u
->
sim_åa˚_pkt
.
e
 =É;

898 
	`sim_¥öt_ös_åa˚
(
s
);

899 
	}
}

902 
	$wrôe_°©s_to_°©s_di•œy_shm
(
RISCVCPUSèã
 *
s
)

904 i‡((
s
->
sim˝u
->
˛ock
 % 
REALTIME_STATS_CLOCK_CYCLES_INTERVAL
) == 0)

909 
	`c›y_ˇche_°©s_to_globÆ_°©s
(
s
);

910 
	`mem˝y
(
s
->
°©s_shm_±r
, s->
sim˝u
->
°©s
,

911 
NUM_MAX_PRV_LEVELS
 * (
SimSèts
));

913 
	}
}

916 
	$£t_max_œãncy_f‹_n⁄_pùe_fu
(
RISCVCPUSèã
 *
s
, 
fu_ty≥
, 
IM≠E¡ry
 *
e
)

918 
fu_ty≥
)

920 
FU_FPU_ALU
:

922  
s
->
sim˝u
->
∑øms
->
Âu_Æu_œãncy
[
e
->
ös
.
Âu_Æu_ty≥
];

928 
	}
}

	@riscvsim/common_core_utils.h

30 #i‚de‡
_COMMON_CORE_UTILS_H_


31 
	#_COMMON_CORE_UTILS_H_


	)

33 
	~"bpu.h
"

34 
	~"riscv_ö°ru˘i⁄.h
"

35 
	~"riscv_sim_ty≥defs.h
"

37 
	gRISCVCPUSèã
;

39 
	sD©aFWDL©ch


41 
uöt64_t
 
	mbuf„r
;

42 
	mrd
;

43 
	mvÆid
;

44 
	mÂ_de°
;

45 
	möt_de°
;

46 } 
	tD©aFWDL©ch
;

48 
	sIn°ru˘i⁄M≠E¡ry


50 
	m°©us
;

51 
uöt64_t
 
	mös_di•©ch_id
;

52 
uöt32_t
 
	mis_decoded
;

53 
uöt32_t
 
	mis_bønch_èkí
;

54 
èrgë_ul⁄g
 
	mbønch_èrgë
;

55 
uöt32_t
 
	mbpu_¥obe
;

56 
èrgë_ul⁄g
 
	m¥edi˘ed_èrgë
;

57 
uöt32_t
 
	mis_¥ed_c‹ª˘
;

58 
	mmax_œãncy
;

59 
	mcuºít_œãncy
;

60 
	md©a_fwd_d⁄e
;

61 
	mªad_rs1
;

62 
	mªad_rs2
;

63 
	mªad_rs3
;

64 
	mª«med
;

65 
	mrob_idx
;

66 
	miq_idx
;

67 
	mlsq_idx
;

68 
	mim≠_ödex
;

69 
	mbønch_¥o˚s£d
;

70 
	m°›_Êush
;

71 
	mmi•ªdi˘
;

72 
	mkìp_de°_busy
;

73 
RVIn°ru˘i⁄
 
	mös
;

74 
BPURe•⁄£Pkt
 
	mbpu_ª•_pkt
;

75 } 
	tIM≠E¡ry
;

77 
	sCPUSège


79 
uöt32_t
 
	mhas_d©a
;

80 
	mim≠_ödex
;

81 
uöt32_t
 
	m°age_exec_d⁄e
;

82 } 
	tCPUSège
;

84 
	sSimTø˚Packë


86 
uöt32_t
 
	mcy˛e
;

87 
IM≠E¡ry
 *
	me
;

88 } 
	tSimTø˚Packë
;

90 
˝u_°age_Êush
(
CPUSège
 *
°age
);

91 
exec_unô_Êush
(
CPUSège
 *
°age
, 
num_°ages
);

92 
•ecuœtive_˝u_°age_Êush
(
CPUSège
 *
°age
, 
IM≠E¡ry
 *
im≠
);

93 
•ecuœtive_exec_unô_Êush
(
CPUSège
 *
°age
, 
num_°ages
,

94 
IM≠E¡ry
 *
im≠
);

96 
IM≠E¡ry
 *
Æloˇã_im≠_íåy
(IM≠E¡ry *
im≠
);

97 
ª£t_im≠
(
IM≠E¡ry
 *
e
);

98 
IM≠E¡ry
 *
gë_im≠_íåy
(IM≠E¡ry *
im≠
, 
ödex
);

100 
code_éb_ac˚ss_™d_ös_„tch
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

101 
do_„tch_°age_exec
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

103 
do_decode_°age_exec
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

105 
£t_ex˚±i⁄_°©e
(
RISCVCPUSèã
 *
s
, c⁄° 
IM≠E¡ry
 *
e
);

106 
£t_timî_ex˚±i⁄_°©e
(
RISCVCPUSèã
 *
s
, c⁄° 
IM≠E¡ry
 *
e
);

107 
execuã_lﬂd_°‹e
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

108 
gë_d©a_mem_ac˚ss_œãncy
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

110 
h™dÀ_bpu_‰⁄ãnd_¥obe
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

111 
h™dÀ_no_bpu_‰⁄ãnd_¥obe
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

112 
h™dÀ_bønch_wôh_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

113 
h™dÀ_bønch_no_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

115 
h™dÀ_bønch_decode_wôh_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

116 
h™dÀ_bønch_decode_no_bpu
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

118 
c›y_ˇche_°©s_to_globÆ_°©s
(
RISCVCPUSèã
 *
s
);

119 
sim_¥öt_ös_åa˚
(
RISCVCPUSèã
 *
s
);

120 
sim_¥öt_exp_åa˚
(
RISCVCPUSèã
 *
s
);

122 
upd©e_¨ch_ªg_öt
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

123 
upd©e_¨ch_ªg_Â
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

124 
upd©e_ö¢_commô_°©s
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

125 
£tup_sim_åa˚_pkt
(
RISCVCPUSèã
 *
s
, 
IM≠E¡ry
 *
e
);

126 
wrôe_°©s_to_°©s_di•œy_shm
(
RISCVCPUSèã
 *
s
);

127 
£t_max_œãncy_f‹_n⁄_pùe_fu
(
RISCVCPUSèã
 *
s
, 
fu_ty≥
,

128 
IM≠E¡ry
 *
e
);

	@riscvsim/decode_fpa_template.h

32 #i‡
F_SIZE
 == 32

33 
	#OPID
 0

	)

34 #ñi‡
F_SIZE
 == 64

35 
	#OPID
 1

	)

36 #ñi‡
F_SIZE
 == 128

37 
	#OPID
 3

	)

39 #îr‹ 
unsuµ‹ãd
 
F_SIZE


42 (0x00 << 2Ë| 
	gOPID
:

43 (0x01 << 2Ë| 
OPID
:

44 (0x02 << 2Ë| 
OPID
:

45 (0x03 << 2Ë| 
OPID
:

47 i‡(
ös
->
rm
 < 0)

48 
ex˚±i⁄
;

49 
	gös
->
	g£t_fs
 = 1;

50 
	gös
->
	ghas_Â_§c1
 = 1;

51 
	gös
->
	ghas_Â_§c2
 = 1;

52 
	gös
->
	ghas_Â_de°
 = 1;

56 (0x0b << 2Ë| 
	gOPID
:

58 i‡(
ös
->
rm
 < 0)

59 
ex˚±i⁄
;

60 
	gös
->
	g£t_fs
 = 1;

61 
	gös
->
	ghas_Â_§c1
 = 1;

62 
	gös
->
	ghas_Â_de°
 = 1;

66 (0x04 << 2Ë| 
	gOPID
:

68 
ös
->
£t_fs
 = 1;

69 
	gös
->
	ghas_Â_§c1
 = 1;

70 
	gös
->
	ghas_Â_§c2
 = 1;

71 
	gös
->
	ghas_Â_de°
 = 1;

75 (0x05 << 2Ë| 
	gOPID
:

77 
ös
->
£t_fs
 = 1;

78 
	gös
->
	ghas_Â_§c1
 = 1;

79 
	gös
->
	ghas_Â_§c2
 = 1;

80 
	gös
->
	ghas_Â_de°
 = 1;

84 (0x18 << 2Ë| 
	gOPID
:

86 i‡(
ös
->
rm
 < 0)

87 
ex˚±i⁄
;

88 
	gös
->
	ghas_Â_§c1
 = 1;

89 
	gös
->
	ghas_de°
 = 1;

93 (0x14 << 2Ë| 
	gOPID
:

95 
ös
->
has_de°
 = 1;

96 
	gös
->
	ghas_Â_§c1
 = 1;

97 
	gös
->
	ghas_Â_§c2
 = 1;

101 (0x1®<< 2Ë| 
	gOPID
:

103 i‡(
ös
->
rm
 < 0)

104 
ex˚±i⁄
;

105 
	gös
->
	g£t_fs
 = 1;

106 
	gös
->
	ghas_Â_de°
 = 1;

107 
	gös
->
	ghas_§c1
 = 1;

111 (0x08 << 2Ë| 
	gOPID
:

113 i‡(
ös
->
rm
 < 0)

114 
ex˚±i⁄
;

115 
	gös
->
	g£t_fs
 = 1;

116 
	gös
->
	ghas_Â_de°
 = 1;

117 
	gös
->
	ghas_Â_§c1
 = 1;

121 (0x1¯<< 2Ë| 
	gOPID
:

123 i‡(
ös
->
rs2
 != 0)

124 
ex˚±i⁄
;

125 
	gös
->
	ghas_de°
 = 1;

126 
	gös
->
	ghas_Â_§c1
 = 1;

130 #i‡
F_SIZE
 <
BIT_SIZE


131 (0x1ê<< 2Ë| 
	gOPID
:

133 i‡((
ös
->
rs2
 !0Ë|| (ös->
rm
 != 0))

134 
ex˚±i⁄
;

135 
	gös
->
	ghas_Â_de°
 = 1;

136 
	gös
->
	ghas_§c1
 = 1;

140 #unde‡
F_SIZE


141 #unde‡
OPID


	@riscvsim/dramsim_wrapper.cpp

27 
	~<c°dio
>

28 
	~<°rög
>

30 
	~"dømsim_wøµî.h
"

32 
	gdømsim_wøµî
::
	$dømsim_wøµî
(c⁄° *
døm_öi_fûe
,

33 c⁄° *
sy°em_öi_fûe
,

34 c⁄° *
°©s_dú
, c⁄° *
≠p_«me
,

35 
size_mb
,

36 
SègeMemAc˚ssQueue
 *
‰⁄ãnd_queue
,

37 
SègeMemAc˚ssQueue
 *
backíd_queue
)

39 
ªad_cb
 = 
√w
 
CÆlback
<
dømsim_wøµî
, , , 
uöt64_t
, uint64_t>(

40 
this
, &
dømsim_wøµî
::
ªad_com∂ëe
);

42 
wrôe_cb


43 
√w
 
CÆlback
<
dømsim_wøµî
, , , 
uöt64_t
, uint64_t>(

44 
this
, &
dømsim_wøµî
::
wrôe_com∂ëe
);

46 
‰⁄ãnd_mem_ac˚ss_queue
 = 
‰⁄ãnd_queue
;

47 
backíd_mem_ac˚ss_queue
 = 
backíd_queue
;

49 
dømsim
 = 
	`gëMem‹ySy°emIn°™˚
(

50 
°d
::
	`°rög
(
døm_öi_fûe
), std::°rög(
sy°em_öi_fûe
),

51 
°d
::
	`°rög
(
°©s_dú
), std::°rög(
≠p_«me
), 
size_mb
);

53 
dømsim
->
	`Regi°îCÆlbacks
(
ªad_cb
, 
wrôe_cb
, 
NULL
);

55 
dømsim
->
	`£tCPUClockS≥ed
(0);

56 
	}
}

58 
	gdømsim_wøµî
::~
	$dømsim_wøµî
()

60 
dñëe
 
dømsim
;

61 
	}
}

64 
	gdømsim_wøµî
::
	$ªad_com∂ëe
(
id
, 
uöt64_t
 
addr
, uöt64_à
˛ock_cy˛e
)

66 
i
;

68 
i
 = 0; i < 
‰⁄ãnd_mem_ac˚ss_queue
->
cur_idx
; ++i)

70 i‡((
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
)

71 && (
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
addr
 ==áddr)

72 && (
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
ty≥
 =
Ród
))

74 
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
 = 0;

75 --
‰⁄ãnd_mem_ac˚ss_queue
->
cur_size
;

80 
i
 = 0; i < 
backíd_mem_ac˚ss_queue
->
cur_idx
; ++i)

82 i‡((
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
)

83 && (
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
addr
 ==áddr)

84 && (
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
ty≥
 =
Ród
))

86 
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
 = 0;

87 --
backíd_mem_ac˚ss_queue
->
cur_size
;

91 
	}
}

94 
	gdømsim_wøµî
::
	$wrôe_com∂ëe
(
id
, 
uöt64_t
 
addr
,

95 
uöt64_t
 
˛ock_cy˛e
)

97 
i
;

99 
i
 = 0; i < 
‰⁄ãnd_mem_ac˚ss_queue
->
cur_idx
; ++i)

101 i‡((
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
)

102 && (
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
addr
 ==áddr)

103 && (
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
ty≥
 =
Wrôe
))

105 
‰⁄ãnd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
 = 0;

106 --
‰⁄ãnd_mem_ac˚ss_queue
->
cur_size
;

111 
i
 = 0; i < 
backíd_mem_ac˚ss_queue
->
cur_idx
; ++i)

113 i‡((
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
)

114 && (
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
addr
 ==áddr)

115 && (
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
ty≥
 =
Wrôe
))

117 
backíd_mem_ac˚ss_queue
->
íåy
[
i
].
vÆid
 = 0;

118 --
backíd_mem_ac˚ss_queue
->
cur_size
;

122 
	}
}

124 
boﬁ


125 
	gdømsim_wøµî
::
	$ˇn_add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
)

127  
dømsim
->
	`wûlAc˚±Tønß˘i⁄
(
addr
);

128 
	}
}

130 
boﬁ


131 
	gdømsim_wøµî
::
	$add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
, 
boﬁ
 
isWrôe
)

133  
dømsim
->
	`addTønß˘i⁄
(
isWrôe
, 
addr
);

134 
	}
}

137 
	gdømsim_wøµî
::
	$upd©e
()

139 
dømsim
->
	`upd©e
();

140 
	}
}

143 
	gdømsim_wøµî
::
	$¥öt_°©s
()

145 
dømsim
->
	`¥ötSèts
(
åue
);

146 
	}
}

149 
	gdømsim_wøµî
::
	$gë_bur°_size
()

151 
BL
, 
jdec_bus_bôs
;

153 i‡(
dømsim
->
	`gëIniUöt
("BL", &
BL
)

154 || 
dømsim
->
	`gëIniUöt
("JEDEC_DATA_BUS_BITS", &
jdec_bus_bôs
))

156 
	`Ârötf
(
°dîr
, "%s\n", "unableÅoÑead BLánd JEDEC_DATA_BUS_BITS "

158 
	`exô
(1);

161  (
jdec_bus_bôs
 * 
BL
) / 8;

162 
	}
}

	@riscvsim/dramsim_wrapper.h

27 #i‚de‡
_DRAMSIM_WRAPPER_H_


28 
	#_DRAMSIM_WRAPPER_H_


	)

30 
	~<c°döt
>

32 
	~"mem‹y_c⁄åﬁÀr_utûs.h
"

33 
	~"riscv_sim_ty≥defs.h
"

34 
	~<DRAMSim.h
>

36 
usög
 
«me•a˚
 
	gDRAMSim
;

38 ˛as†
	cdømsim_wøµî


40 
	mpublic
:

41 
dømsim_wøµî
();

42 
dømsim_wøµî
(c⁄° *
døm_öi_fûe
, c⁄° *
sy°em_öi_fûe
,

43 c⁄° *
°©s_dú
, c⁄° *
≠p_«me
, 
size_mb
,

44 
SègeMemAc˚ssQueue
 *
‰⁄ãnd_mem_ac˚ss_queue
,

45 
SègeMemAc˚ssQueue
 *
backíd_mem_ac˚ss_queue
);

46 ~
dømsim_wøµî
();

47 
boﬁ
 
ˇn_add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
);

48 
boﬁ
 
add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
, boﬁ 
isWrôe
);

49 
upd©e
();

50 
¥öt_°©s
();

51 
gë_bur°_size
();

52 
ªad_com∂ëe
(, 
uöt64_t
, uint64_t);

53 
wrôe_com∂ëe
(, 
uöt64_t
, uint64_t);

55 
Mu…iCh™√lMem‹ySy°em
 *
	mdømsim
;

56 
Tønß˘i⁄Com∂ëeCB
 *
	mªad_cb
;

57 
Tønß˘i⁄Com∂ëeCB
 *
	mwrôe_cb
;

58 
SègeMemAc˚ssQueue
 *
	m‰⁄ãnd_mem_ac˚ss_queue
;

59 
SègeMemAc˚ssQueue
 *
	mbackíd_mem_ac˚ss_queue
;

	@riscvsim/dramsim_wrapper_c_connector.cpp

27 
	~<c°dlib
>

29 
	~"dømsim_wøµî.h
"

30 
	~"dømsim_wøµî_c_c⁄√˘‹.h
"

32 #ifde‡
__˝lu•lus


36 
dømsim_wøµî
 *
dømsim_wøµî_obj
 = 
NULL
;

39 
dømsim_wøµî_öô
(c⁄° *
døm_öi_fûe
, c⁄° *
sy°em_öi_fûe
,

40 c⁄° *
°©s_dú
, c⁄° *
≠p_«me
, 
size_mb
,

41 
SègeMemAc˚ssQueue
 *
‰⁄ãnd_mem_ac˚ss_queue
,

42 
SègeMemAc˚ssQueue
 *
backíd_mem_ac˚ss_queue
)

44 i‡(
dømsim_wøµî_obj
 =
NULL
)

46 
dømsim_wøµî_obj
 = 
√w
 
dømsim_wøµî
(

47 
døm_öi_fûe
, 
sy°em_öi_fûe
, 
°©s_dú
, 
≠p_«me
, 
size_mb
,

48 
‰⁄ãnd_mem_ac˚ss_queue
, 
backíd_mem_ac˚ss_queue
);

53 
dømsim_wøµî_de°roy
()

55 
dñëe
 
dømsim_wøµî_obj
;

56 
dømsim_wøµî_obj
 = 
NULL
;

60 
dømsim_wøµî_ˇn_add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
)

62  
dømsim_wøµî_obj
->
ˇn_add_å™ß˘i⁄
(
addr
);

66 
dømsim_wøµî_add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
, 
isWrôe
)

68  
dømsim_wøµî_obj
->
add_å™ß˘i⁄
(
addr
, (
boﬁ
)
isWrôe
);

72 
dømsim_wøµî_upd©e
()

74 
dømsim_wøµî_obj
->
upd©e
();

78 
dømsim_wøµî_¥öt_°©s
()

80 
dømsim_wøµî_obj
->
¥öt_°©s
();

84 
dømsim_gë_bur°_size
()

86  
dømsim_wøµî_obj
->
gë_bur°_size
();

89 #ifde‡
__˝lu•lus


	@riscvsim/dramsim_wrapper_c_connector.h

27 #i‚de‡
_DRAMSIM_WRAPPER_C_CONNECTOR_H_


28 
	#_DRAMSIM_WRAPPER_C_CONNECTOR_H_


	)

30 
	~<öây≥s.h
>

32 
	~"mem‹y_c⁄åﬁÀr_utûs.h
"

33 
	~"riscv_sim_ty≥defs.h
"

35 #ifde‡
__˝lu•lus


38 
dømsim_wøµî_öô
(c⁄° *
døm_öi_fûe
,

39 c⁄° *
sy°em_öi_fûe
, c⁄° *
°©s_dú
,

40 c⁄° *
≠p_«me
, 
size_mb
,

41 
SègeMemAc˚ssQueue
 *
‰⁄ãnd_mem_ac˚ss_queue
,

42 
SègeMemAc˚ssQueue
 *
backíd_mem_ac˚ss_queue
);

43 
dømsim_wøµî_de°roy
();

44 
dømsim_wøµî_ˇn_add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
);

45 
dømsim_wøµî_add_å™ß˘i⁄
(
èrgë_ul⁄g
 
addr
, 
isWrôe
);

46 
dømsim_wøµî_upd©e
();

47 
dømsim_wøµî_¥öt_°©s
();

48 
dømsim_gë_bur°_size
();

50 #ifde‡
__˝lu•lus


	@riscvsim/execute_fpa_template.h

30 #i‡
F_SIZE
 == 32

31 
	#OPID
 0

	)

32 
	#F_HIGH
 
F32_HIGH


	)

33 #ñi‡
F_SIZE
 == 64

34 
	#OPID
 1

	)

35 
	#F_HIGH
 
F64_HIGH


	)

36 #ñi‡
F_SIZE
 == 128

37 
	#OPID
 3

	)

38 
	#F_HIGH
 0

	)

40 #îr‹ 
unsuµ‹ãd
 
F_SIZE


43 
	#FSIGN_MASK
 
	`simglue
(
FSIGN_MASK
, 
F_SIZE
)

	)

45 (0x00 << 2Ë| 
	gOPID
:

46 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FADD
;

47 
	gi
->
	gbuf„r
 = 
	$simglue
(
add_sf
, 
F_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
,

48 (
RoundögModeEnum
)
rm
, 
fÊags
)

49 | 
F_HIGH
;

50 
i
->
ty≥
 = 
INS_TYPE_FP_ADD
;

53 (0x01 << 2Ë| 
OPID
:

54 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FSUB
;

55 
i
->
buf„r
 = 
	$simglue
(
sub_sf
, 
F_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
,

56 (
RoundögModeEnum
)
rm
, 
fÊags
)

57 | 
F_HIGH
;

60 (0x02 << 2Ë| 
OPID
:

61 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FMUL
;

62 
i
->
buf„r
 = 
	$simglue
(
mul_sf
, 
F_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
,

63 (
RoundögModeEnum
)
rm
, 
fÊags
)

64 | 
F_HIGH
;

65 
i
->
ty≥
 = 
INS_TYPE_FP_MUL
;

68 (0x03 << 2Ë| 
OPID
:

69 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FDIV
;

70 
i
->
buf„r
 = 
	$simglue
(
div_sf
, 
F_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
,

71 (
RoundögModeEnum
)
rm
, 
fÊags
)

72 | 
F_HIGH
;

73 
i
->
ty≥
 = 
INS_TYPE_FP_DIV_SQRT
;

76 (0x0b << 2Ë| 
OPID
:

77 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FSQRT
;

78 
i
->
buf„r


79 
	$simglue
(
sqπ_sf
, 
F_SIZE
)(
i
->
rs1_vÆ
, (
RoundögModeEnum
)
rm
, 
fÊags
)

80 | 
F_HIGH
;

81 
i
->
ty≥
 = 
INS_TYPE_FP_DIV_SQRT
;

84 (0x04 << 2Ë| 
OPID
:

85 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FSGNJ
;

86 
rm
)

89 
i
->
buf„r
 = (i->
rs1_vÆ
 & ~
FSIGN_MASK
Ë| (i->
rs2_vÆ
 & FSIGN_MASK);

92 
i
->
buf„r
 = (i->
rs1_vÆ
 & ~
FSIGN_MASK
)

93 | ((
i
->
rs2_vÆ
 & 
FSIGN_MASK
) ^ FSIGN_MASK);

96 
i
->
buf„r
 = i->
rs1_vÆ
 ^ (i->
rs2_vÆ
 & 
FSIGN_MASK
);

98 
	}
}

101 (0x05 << 2Ë| 
	gOPID
:

102 
rm
)

105 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FMIN
;

106 
i
->
buf„r
 = 
	`simglue
(
mö_sf
, 
F_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
, 
fÊags
,

107 
FMINMAX_IEEE754_201X
)

108 | 
F_HIGH
;

111 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FMAX
;

112 
i
->
buf„r
 = 
	`simglue
(
max_sf
, 
F_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
, 
fÊags
,

113 
FMINMAX_IEEE754_201X
)

114 | 
F_HIGH
;

116 
	}
}

119 (0x18 << 2Ë| 
	gOPID
:

120 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FCVT
;

121 
	gi
->
	grs2
)

124 
i
->
buf„r
 = (
öt32_t
)
simglue
(simglue(
cvt_sf
, 
F_SIZE
), 
_i32
)(

125 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
);

128 
i
->
buf„r
 = (
öt32_t
)
simglue
(simglue(
cvt_sf
, 
F_SIZE
), 
_u32
)(

129 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
);

131 #i‡
BIT_SIZE
 >= 64

133 
i
->
buf„r
 = (
öt64_t
)
simglue
(simglue(
cvt_sf
, 
F_SIZE
), 
_i64
)(

134 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
);

137 
i
->
buf„r
 = (
öt64_t
)
simglue
(simglue(
cvt_sf
, 
F_SIZE
), 
_u64
)(

138 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
);

144 (0x14 << 2Ë| 
	gOPID
:

145 
rm
)

148 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FLE
;

149 
i
->
buf„r
 = 
	`simglue
(
À_sf
, 
F_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
, 
fÊags
);

152 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FLT
;

153 
i
->
buf„r
 = 
	`simglue
(
…_sf
, 
F_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
, 
fÊags
);

156 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FEQ
;

157 
i
->
buf„r


158 
	`simglue
(
eq_quõt_sf
, 
F_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
, 
fÊags
);

160 
	}
}

163 (0x1®<< 2Ë| 
	gOPID
:

164 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FCVT
;

165 
	gi
->
	grs2
)

168 
i
->
buf„r
 = 
simglue
(
cvt_i32_sf
, 
F_SIZE
)(

169 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
)

170 | 
	gF_HIGH
;

173 
i
->
buf„r
 = 
simglue
(
cvt_u32_sf
, 
F_SIZE
)(

174 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
)

175 | 
	gF_HIGH
;

177 #i‡
BIT_SIZE
 >= 64

179 
i
->
buf„r
 = 
simglue
(
cvt_i64_sf
, 
F_SIZE
)(

180 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
)

181 | 
	gF_HIGH
;

184 
i
->
buf„r
 = 
simglue
(
cvt_u64_sf
, 
F_SIZE
)(

185 
	gi
->
	grs1_vÆ
, (
	gRoundögModeEnum
)
	grm
, 
	gfÊags
)

186 | 
	gF_HIGH
;

192 (0x08 << 2Ë| 
	gOPID
:

193 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_CVT
;

194 
	gi
->
	grs2
)

196 #i‡
F_SIZE
 =32 && 
FLEN
 >= 64

198 
i
->
buf„r
 = 
cvt_sf64_sf32
(i->
rs1_vÆ
, (
RoundögModeEnum
)
rm
, 
fÊags
)

199 | 
	gF32_HIGH
;

202 #i‡
F_SIZE
 == 64

204 
i
->
buf„r
 = 
cvt_sf32_sf64
(i->
rs1_vÆ
, 
fÊags
Ë| 
	gF64_HIGH
;

210 (0x1¯<< 2Ë| 
	gOPID
:

211 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FMV
;

212 
rm
)

214 #i‡
F_SIZE
 <
BIT_SIZE


216 #i‡
F_SIZE
 == 32

217 
i
->
buf„r
 = (
öt32_t
)i->
rs1_vÆ
;

218 #ñi‡
F_SIZE
 == 64

219 
i
->
buf„r
 = (
öt64_t
)i->
rs1_vÆ
;

221 
i
->
buf„r
 = (
öt128_t
)i->
rs1_vÆ
;

226 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FCLASS
;

227 
i
->
buf„r
 = 
	`simglue
(
f˛ass_sf
, 
F_SIZE
)(i->
rs1_vÆ
);

229 
	}
}

232 #i‡
F_SIZE
 <
BIT_SIZE


233 (0x1ê<< 2Ë| 
	gOPID
:

234 
i
->
Âu_Æu_ty≥
 = 
FU_FPU_ALU_FMV
;

235 #i‡
F_SIZE
 == 32

236 
	gi
->
	gbuf„r
 = (
öt32_t
)
i
->
rs1_vÆ
;

237 #ñi‡
F_SIZE
 == 64

238 
	gi
->
	gbuf„r
 = (
öt64_t
)
i
->
rs1_vÆ
;

240 
	gi
->
	gbuf„r
 = (
öt128_t
)
i
->
rs1_vÆ
;

245 #unde‡
F_SIZE


246 #unde‡
F_HIGH


247 #unde‡
OPID


248 #unde‡
FSIGN_MASK


	@riscvsim/fpa_str_creator_template.h

30 #i‡
F_SIZE
 == 32

31 
	#OPID
 0

	)

32 
	#F_HIGH
 
F32_HIGH


	)

33 #ñi‡
F_SIZE
 == 64

34 
	#OPID
 1

	)

35 
	#F_HIGH
 
F64_HIGH


	)

36 #ñi‡
F_SIZE
 == 128

37 
	#OPID
 3

	)

38 
	#F_HIGH
 0

	)

40 #îr‹ 
unsuµ‹ãd
 
F_SIZE


43 (0x00 << 2Ë| 
	gOPID
:

45 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fadd%s %s,%s,%s",

46 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
],

47 
Â_ªg
[
i
->
rs2
]);

51 (0x01 << 2Ë| 
	gOPID
:

53 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsub%s %s,%s,%s",

54 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
],

55 
Â_ªg
[
i
->
rs2
]);

59 (0x02 << 2Ë| 
	gOPID
:

61 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmul%s %s,%s,%s",

62 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
],

63 
Â_ªg
[
i
->
rs2
]);

67 (0x03 << 2Ë| 
	gOPID
:

69 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fdiv%s %s,%s,%s",

70 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
],

71 
Â_ªg
[
i
->
rs2
]);

75 (0x0b << 2Ë| 
	gOPID
:

77 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsqrt%s %s,%s",

78 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
]);

82 (0x04 << 2Ë| 
	gOPID
:

84 
rm
)

88 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsgnj%s %s,%s,%s",

89 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

90 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
]);

95 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsgnjn%s %s,%s,%s",

96 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

97 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
]);

102 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsgnjx%s %s,%s,%s",

103 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

104 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
]);

111 (0x05 << 2Ë| 
	gOPID
:

113 
rm
)

117 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmin%s %s,%s,%s",

118 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

119 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
]);

124 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmax%s %s,%s,%s",

125 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

126 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
]);

133 (0x18 << 2Ë| 
	gOPID
:

135 
i
->
rs2
)

139 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt.w%s %s,%s",

140 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
],

141 
Â_ªg
[
i
->
rs1
]);

146 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt.wu%s %s,%s",

147 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
],

148 
Â_ªg
[
i
->
rs1
]);

151 #i‡
BIT_SIZE
 >= 64

154 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt.l%s %s,%s",

155 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
],

156 
Â_ªg
[
i
->
rs1
]);

161 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt.lu%s %s,%s",

162 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
],

163 
Â_ªg
[
i
->
rs1
]);

171 (0x14 << 2Ë| 
	gOPID
:

173 
rm
)

177 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fle%s %s,%s,%s",

178 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
], 
Â_ªg
[i->
rs1
],

179 
Â_ªg
[
i
->
rs2
]);

184 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "flt%s %s,%s,%s",

185 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
], 
Â_ªg
[i->
rs1
],

186 
Â_ªg
[
i
->
rs2
]);

191 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "feq%s %s,%s,%s",

192 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
ªg
[
i
->
rd
], 
Â_ªg
[i->
rs1
],

193 
Â_ªg
[
i
->
rs2
]);

200 (0x1®<< 2Ë| 
	gOPID
:

202 
i
->
rs2
)

206 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt%s.w %s,%s",

207 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

208 
ªg
[
i
->
rs1
]);

213 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt%s.wu %s,%s",

214 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

215 
ªg
[
i
->
rs1
]);

218 #i‡
BIT_SIZE
 >= 64

221 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt%s.l %s,%s",

222 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

223 
ªg
[
i
->
rs1
]);

228 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fcvt%s.lu %s,%s",

229 
gë_Êí_suffix
[(
F_SIZE
 / 32)], 
Â_ªg
[
i
->
rd
],

230 
ªg
[
i
->
rs1
]);

238 (0x08 << 2Ë| 
	gOPID
:

240 
i
->
rs2
)

242 #i‡
F_SIZE
 =32 && 
FLEN
 >= 64

245 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "cvt.s.d %s,%s",

246 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
]);

250 #i‡
F_SIZE
 == 64

253 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "cvt.d.s %s,%s",

254 
Â_ªg
[
i
->
rd
], fp_ªg[i->
rs1
]);

262 (0x1¯<< 2Ë| 
	gOPID
:

264 
rm
)

266 #i‡
F_SIZE
 <
BIT_SIZE


269 #i‡
F_SIZE
 == 32

270 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmv.x.s %s,%s",

271 
ªg
[
i
->
rd
], 
Â_ªg
[i->
rs1
]);

272 #ñi‡
F_SIZE
 == 64

273 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmv.x.d %s,%s",

274 
ªg
[
i
->
rd
], 
Â_ªg
[i->
rs1
]);

276 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmv.x.q %s,%s",

277 
ªg
[
i
->
rd
], 
Â_ªg
[i->
rs1
]);

284 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fclass%s %s,%s",

285 
gë_Êí_suffix
[(
F_SIZE
Ë/ 32], 
ªg
[
i
->
rd
],

286 
Â_ªg
[
i
->
rs1
]);

293 #i‡
F_SIZE
 <
BIT_SIZE


294 (0x1ê<< 2Ë| 
	gOPID
:

296 #i‡
F_SIZE
 == 32

297 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmv.s.x %s,%s", 
Â_ªg
[i->
rd
],

298 
ªg
[
i
->
rs1
]);

299 #ñi‡
F_SIZE
 == 64

300 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmv.s.x %s,%s", 
Â_ªg
[i->
rd
],

301 
ªg
[
i
->
rs1
]);

303 
¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fmv.s.x %s,%s", 
Â_ªg
[i->
rd
],

304 
ªg
[
i
->
rs1
]);

310 #unde‡
F_SIZE


311 #unde‡
F_HIGH


312 #unde‡
OPID


313 #unde‡
FSIGN_MASK


	@riscvsim/inorder.c

30 
	~<as£π.h
>

31 
	~<°dio.h
>

32 
	~<°dlib.h
>

33 
	~<°rög.h
>

34 
	~<sys/time.h
>

36 
	~"../cutûs.h
"

37 
	~"../riscv_˝u_¥iv.h
"

38 
	~"cúcuœr_queue.h
"

39 
	~"ö‹dî.h
"

40 
	~"riscv_sim_˝u.h
"

42 
INC‹e
 *

43 
	$ö_c‹e_öô
(c⁄° 
SimP¨ams
 *
p
, 
RISCVSIMCPUSèã
 *
sim˝u
)

45 
INC‹e
 *
c‹e
;

47 
c‹e
 = 
	`ˇŒoc
(1, (
INC‹e
));

48 
	`as£π
(
c‹e
);

51 
c‹e
->
ülu
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_Æu_°ages
, (CPUStage));

52 
	`as£π
(
c‹e
->
ülu
);

54 
c‹e
->
imul
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_mul_°ages
, (CPUStage));

55 
	`as£π
(
c‹e
->
imul
);

57 
c‹e
->
idiv
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_div_°ages
, (CPUStage));

58 
	`as£π
(
c‹e
->
idiv
);

60 
c‹e
->
Âu_fma
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_Âu_fma_°ages
, (CPUStage));

61 
	`as£π
(
c‹e
->
Âu_fma
);

64 
	`cq_öô
(&
c‹e
->
ös_di•©ch_queue
.
cq
, 
INCORE_NUM_INS_DISPATCH_QUEUE_ENTRY
);

65 
	`mem£t
((*)
c‹e
->
ös_di•©ch_queue
.
d©a
, 0,

66 (
uöt64_t
Ë* 
INCORE_NUM_INS_DISPATCH_QUEUE_ENTRY
);

69 
p
->
num_˝u_°ages
)

73 
c‹e
->
p‚_öc‹e_run_öã∫Æ
 = &
ö_c‹e_run_5_°age
;

78 
c‹e
->
p‚_öc‹e_run_öã∫Æ
 = &
ö_c‹e_run_6_°age
;

83 
c‹e
->
sim˝u
 = simcpu;

84  
c‹e
;

85 
	}
}

88 
	$ö_c‹e_ª£t
(*
c‹e_ty≥
)

90 
i
;

91 
INC‹e
 *
c‹e
;

93 
c‹e
 = (
INC‹e
 *)
c‹e_ty≥
;

96 
	`˝u_°age_Êush
(&
c‹e
->
pcgí
);

97 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

98 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

99 
	`˝u_°age_Êush
(&
c‹e
->
mem‹y
);

100 
	`˝u_°age_Êush
(&
c‹e
->
commô
);

103 
c‹e
->
pcgí
.
has_d©a
 = 
TRUE
;

106 
i
 = 0; i < 
NUM_INT_REG
; ++i)

108 
c‹e
->
öt_ªg_°©us
[
i
] = 
TRUE
;

111 
i
 = 0; i < 
NUM_FP_REG
; ++i)

113 
c‹e
->
Â_ªg_°©us
[
i
] = 
TRUE
;

117 
	`exec_unô_Êush
(
c‹e
->
ülu
, c‹e->
sim˝u
->
∑øms
->
num_Æu_°ages
);

118 
	`exec_unô_Êush
(
c‹e
->
imul
, c‹e->
sim˝u
->
∑øms
->
num_mul_°ages
);

119 
	`exec_unô_Êush
(
c‹e
->
idiv
, c‹e->
sim˝u
->
∑øms
->
num_div_°ages
);

120 
	`exec_unô_Êush
(
c‹e
->
Âu_fma
, c‹e->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
);

121 
	`˝u_°age_Êush
(&
c‹e
->
Âu_Æu
);

124 
c‹e
->
ös_di•©ch_id
 = 0;

125 
	`cq_ª£t
(&
c‹e
->
ös_di•©ch_queue
.
cq
);

128 
	`mem£t
((*)
c‹e
->
fwd_œtch
, 0, (
D©aFWDL©ch
Ë* 
NUM_FWD_BUS
);

129 
	}
}

132 
	$ö_c‹e_‰ì
(*
c‹e_ty≥
)

134 
INC‹e
 *
c‹e
;

136 
c‹e
 = (
INC‹e
 *)(*(INC‹ê**)
c‹e_ty≥
);

137 
	`‰ì
(
c‹e
->
Âu_fma
);

138 
c‹e
->
Âu_fma
 = 
NULL
;

139 
	`‰ì
(
c‹e
->
idiv
);

140 
c‹e
->
idiv
 = 
NULL
;

141 
	`‰ì
(
c‹e
->
imul
);

142 
c‹e
->
imul
 = 
NULL
;

143 
	`‰ì
(
c‹e
->
ülu
);

144 
c‹e
->
ülu
 = 
NULL
;

145 
	`‰ì
(
c‹e
);

146 
	}
}

149 
	$ö_c‹e_pùñöe_døöed
(
INC‹e
 *
c‹e
)

151 
i
;

152 
RISCVSIMCPUSèã
 *
sim˝u
 = 
c‹e
->simcpu;

154 i‡(
c‹e
->
pcgí
.
has_d©a
 || c‹e->
„tch
.has_d©®|| c‹e->
decode
.has_data

155 || 
c‹e
->
Âu_Æu
.
has_d©a
 || c‹e->
mem‹y
.has_d©®|| c‹e->
commô
.has_data)

157  
PIPELINE_NOT_DRAINED
;

160 
i
 = 0; i < 
sim˝u
->
∑øms
->
num_Æu_°ages
; ++i)

162 i‡(
c‹e
->
ülu
[
i
].
has_d©a
)

164  
PIPELINE_NOT_DRAINED
;

168 
i
 = 0; i < 
sim˝u
->
∑øms
->
num_mul_°ages
; ++i)

170 i‡(
c‹e
->
imul
[
i
].
has_d©a
)

172  
PIPELINE_NOT_DRAINED
;

176 
i
 = 0; i < 
sim˝u
->
∑øms
->
num_div_°ages
; ++i)

178 i‡(
c‹e
->
idiv
[
i
].
has_d©a
)

180  
PIPELINE_NOT_DRAINED
;

184 
i
 = 0; i < 
sim˝u
->
∑øms
->
num_Âu_fma_°ages
; ++i)

186 i‡(
c‹e
->
Âu_fma
[
i
].
has_d©a
)

188  
PIPELINE_NOT_DRAINED
;

192  
PIPELINE_DRAINED
;

193 
	}
}

196 
	$ö_c‹e_run
(*
c‹e_ty≥
)

198 
INC‹e
 *
c‹e
 = (INC‹ê*)
c‹e_ty≥
;

199 
RISCVCPUSèã
 *
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

204 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
	`mem_c⁄åﬁÀr_upd©e_öã∫Æ
(

205 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
);

209 i‡(
c‹e
->
	`p‚_öc‹e_run_öã∫Æ
(core))

211  
s
->
sim_ex˚±i⁄_ˇu£
;

216 i‡(
s
->
sim_ex˚±i⁄
 && 
	`ö_c‹e_pùñöe_døöed
(
c‹e
))

218  
s
->
sim_ex˚±i⁄_ˇu£
;

222 ++
s
->
sim˝u
->
˛ock
;

223 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
cy˛es
;

225 
	}
}

228 
	$ö_c‹e_run_6_°age
(
INC‹e
 *
c‹e
)

230 i‡(
	`ö_c‹e_commô
(
c‹e
))

236 
	`ö_c‹e_mem‹y
(
c‹e
);

237 
	`ö_c‹e_execuã_Æl
(
c‹e
);

238 
	`ö_c‹e_decode
(
c‹e
);

243 
	`mem£t
((*)
c‹e
->
fwd_œtch
, 0, (
D©aFWDL©ch
Ë* 
NUM_FWD_BUS
);

244 
	`ö_c‹e_„tch
(
c‹e
);

245 
	`ö_c‹e_pcgí
(
c‹e
);

247 
	}
}

250 
	$ö_c‹e_run_5_°age
(
INC‹e
 *
c‹e
)

252 i‡(
	`ö_c‹e_commô
(
c‹e
))

258 
	`ö_c‹e_mem‹y
(
c‹e
);

259 
	`ö_c‹e_execuã_Æl
(
c‹e
);

260 
	`ö_c‹e_decode
(
c‹e
);

265 
	`mem£t
((*)
c‹e
->
fwd_œtch
, 0, (
D©aFWDL©ch
Ë* 
NUM_FWD_BUS
);

266 
	`ö_c‹e_pcgí
(
c‹e
);

267 
	`ö_c‹e_„tch
(
c‹e
);

269 
	}
}

	@riscvsim/inorder.h

30 #i‚de‡
_INORDER_H_


31 
	#_INORDER_H_


	)

33 
	~"sim_∑øms_°©s.h
"

34 
	~"bpu.h
"

35 
	~"cúcuœr_queue.h
"

36 
	~"comm⁄_c‹e_utûs.h
"

39 
	gRISCVSIMCPUSèã
;

41 
	sInsDi•©chQueue


43 
CQ
 
	mcq
;

44 
uöt64_t
 
	md©a
[
INCORE_NUM_INS_DISPATCH_QUEUE_ENTRY
];

45 } 
	tInsDi•©chQueue
;

47 
	sINC‹e


50 
CPUSège
 
	mpcgí
;

51 
CPUSège
 
	m„tch
;

52 
CPUSège
 
	mdecode
;

53 
CPUSège
 
	mmem‹y
;

54 
CPUSège
 
	mcommô
;

57 
uöt32_t
 
	möt_ªg_°©us
[
NUM_INT_REG
];

58 
uöt32_t
 
	mÂ_ªg_°©us
[
NUM_FP_REG
];

61 
D©aFWDL©ch
 
	mfwd_œtch
[
NUM_FWD_BUS
];

64 
InsDi•©chQueue
 
	mös_di•©ch_queue
;

67 
CPUSège
 *
	mülu
;

68 
CPUSège
 *
	mimul
;

69 
CPUSège
 *
	midiv
;

70 
CPUSège
 *
	mÂu_fma
;

71 
CPUSège
 
	mÂu_Æu
;

74 (*
	mp‚_öc‹e_run_öã∫Æ
)(
INC‹e
 *
	mc‹e
);

81 
uöt64_t
 
	mös_di•©ch_id
;

83 
RISCVSIMCPUSèã
 *
	msim˝u
;

84 } 
	tINC‹e
;

87 
INC‹e
 *
ö_c‹e_öô
(c⁄° 
SimP¨ams
 *
p
, 
RISCVSIMCPUSèã
 *
sim˝u
);

88 
ö_c‹e_ª£t
(*
c‹e_ty≥
);

89 
ö_c‹e_‰ì
(*
c‹e_ty≥
);

90 
ö_c‹e_run
(*
c‹e_ty≥
);

93 
ö_c‹e_pcgí
(
INC‹e
 *
c‹e
);

94 
ö_c‹e_„tch
(
INC‹e
 *
c‹e
);

95 
ö_c‹e_decode
(
INC‹e
 *
c‹e
);

96 
ö_c‹e_execuã_Æl
(
INC‹e
 *
c‹e
);

97 
ö_c‹e_mem‹y
(
INC‹e
 *
c‹e
);

98 
ö_c‹e_commô
(
INC‹e
 *
c‹e
);

99 
ö_c‹e_run_5_°age
(
INC‹e
 *
c‹e
);

100 
ö_c‹e_run_6_°age
(
INC‹e
 *
c‹e
);

	@riscvsim/inorder_backend.c

32 
	~<°dio.h
>

33 
	~<°dlib.h
>

34 
	~<°rög.h
>

36 
	~"cúcuœr_queue.h
"

37 
	~"ö‹dî.h
"

38 
	~"mem‹y_c⁄åﬁÀr.h
"

39 
	~"riscv_ös_execuã_lib.h
"

40 
	~"../riscv_˝u_¥iv.h
"

41 
	~"riscv_sim_˝u.h
"

47 
CPUSège
 *

48 
	$gë_√xt_exec_°age
(
INC‹e
 *
c‹e
, 
cur_°age_id
, 
fu_ty≥
)

50 
CPUSège
 *
°age
 = 
NULL
;

52 
fu_ty≥
)

54 
FU_ALU
:

56 
°age
 = &
c‹e
->
ülu
[
cur_°age_id
 + 1];

59 
FU_MUL
:

61 
°age
 = &
c‹e
->
imul
[
cur_°age_id
 + 1];

64 
FU_DIV
:

66 
°age
 = &
c‹e
->
idiv
[
cur_°age_id
 + 1];

69 
FU_FPU_FMA
:

71 
°age
 = &
c‹e
->
Âu_fma
[
cur_°age_id
 + 1];

75  
°age
;

76 
	}
}

79 
	$do_exec_ö¢
(
RISCVCPUSèã
 *
s
, 
INC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
fu_ty≥
)

81 i‡(
e
->
ös
.
has_de°
)

83 i‡(
e
->
ös
.
rd
 != 0)

85 
c‹e
->
öt_ªg_°©us
[
e
->
ös
.
rd
] = 
FALSE
;

88 i‡(
e
->
ös
.
has_Â_de°
)

90 
c‹e
->
Â_ªg_°©us
[
e
->
ös
.
rd
] = 
FALSE
;

93 
e
->
cuºít_œãncy
 = 1;

94 
	`execuã_riscv_ö°ru˘i⁄
(&
e
->
ös
, &
s
->
fÊags
);

95 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
fu_ac˚ss
[
fu_ty≥
];

96 
	}
}

99 
	$do_fwd_d©a_‰om_ex_to_drf
(
INC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
fu_ty≥
)

101 i‡(!
e
->
d©a_fwd_d⁄e


102 && !(
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
)

103 && !
e
->
kìp_de°_busy


104 && ((
e
->
ös
.
has_de°
 &&É->ös.
rd
 !0Ë||É->ös.
has_Â_de°
))

106 
c‹e
->
fwd_œtch
[
fu_ty≥
].
rd
 = 
e
->
ös
.rd;

107 
c‹e
->
fwd_œtch
[
fu_ty≥
].
buf„r
 = 
e
->
ös
.buffer;

108 
c‹e
->
fwd_œtch
[
fu_ty≥
].
öt_de°
 = 
e
->
ös
.
has_de°
;

109 
c‹e
->
fwd_œtch
[
fu_ty≥
].
Â_de°
 = 
e
->
ös
.
has_Â_de°
;

110 
c‹e
->
fwd_œtch
[
fu_ty≥
].
vÆid
 = 
TRUE
;

111 
e
->
d©a_fwd_d⁄e
 = 
TRUE
;

113 
	}
}

116 
	$push_ö¢_‰om_ex_to_mem
(
INC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
CPUSège
 *
°age
)

118 i‡(
c‹e
->
ös_di•©ch_queue
.
d©a
[
	`cq_‰⁄t
(&c‹e->ös_di•©ch_queue.
cq
)]

119 =
e
->
ös_di•©ch_id
)

121 i‡(!
c‹e
->
mem‹y
.
has_d©a
)

123 
	`cq_dequeue
(&
c‹e
->
ös_di•©ch_queue
.
cq
);

124 
e
->
cuºít_œãncy
 = 0;

125 
e
->
d©a_fwd_d⁄e
 = 
FALSE
;

126 
°age
->
°age_exec_d⁄e
 = 
FALSE
;

127 
c‹e
->
mem‹y
 = *
°age
;

128 
	`˝u_°age_Êush
(
°age
);

131 
	}
}

134 
	$ö_c‹e_execuã_n⁄_pùe
(
INC‹e
 *
c‹e
, 
fu_ty≥
, 
CPUSège
 *
°age
)

136 
IM≠E¡ry
 *
e
;

137 
RISCVCPUSèã
 *
s
;

139 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

140 i‡(
°age
->
has_d©a
)

142 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
°age
->
im≠_ödex
);

143 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
exec_unô_dñay
;

144 i‡(!
°age
->
°age_exec_d⁄e
)

146 
	`do_exec_ö¢
(
s
, 
c‹e
, 
e
, 
fu_ty≥
);

147 
e
->
max_œãncy
 = 
	`£t_max_œãncy_f‹_n⁄_pùe_fu
(
s
, 
fu_ty≥
,É);

148 
	`as£π
(
e
->
max_œãncy
);

149 
°age
->
°age_exec_d⁄e
 = 
TRUE
;

152 i‡(
e
->
cuºít_œãncy
 =e->
max_œãncy
)

154 
	`do_fwd_d©a_‰om_ex_to_drf
(
c‹e
, 
e
, 
fu_ty≥
);

155 
	`push_ö¢_‰om_ex_to_mem
(
c‹e
, 
e
, 
°age
);

159 
e
->
cuºít_œãncy
++;

162 
	}
}

165 
	$ö_c‹e_execuã_pùe
(
INC‹e
 *
c‹e
, 
cur_°age_id
, 
fu_ty≥
, 
CPUSège
 *
°age
,

166 
max_œãncy
, 
max_°age_id
)

168 
IM≠E¡ry
 *
e
;

169 
CPUSège
 *
√xt
;

170 
RISCVCPUSèã
 *
s
;

172 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

173 i‡(
°age
->
has_d©a
)

175 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
°age
->
im≠_ödex
);

176 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
exec_unô_dñay
;

177 i‡(!
°age
->
°age_exec_d⁄e
)

179 
	`do_exec_ö¢
(
s
, 
c‹e
, 
e
, 
fu_ty≥
);

180 
°age
->
°age_exec_d⁄e
 = 
TRUE
;

183 i‡(
e
->
cuºít_œãncy
 =
max_œãncy
)

186 i‡(
cur_°age_id
 =
max_°age_id
)

188 
	`do_fwd_d©a_‰om_ex_to_drf
(
c‹e
, 
e
, 
fu_ty≥
);

189 
	`push_ö¢_‰om_ex_to_mem
(
c‹e
, 
e
, 
°age
);

194 
√xt
 = 
	`gë_√xt_exec_°age
(
c‹e
, 
cur_°age_id
, 
fu_ty≥
);

195 i‡(!
√xt
->
has_d©a
)

197 
e
->
cuºít_œãncy
 = 1;

198 *
√xt
 = *
°age
;

199 
	`˝u_°age_Êush
(
°age
);

205 
e
->
cuºít_œãncy
++;

208 
	}
}

211 
	$ö_c‹e_execuã_Æl
(
INC‹e
 *
c‹e
)

213 
i
;

215 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
 - 1; i >= 0; i--)

217 
	`ö_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_FPU_FMA
, &c‹e->
Âu_fma
[i],

218 
c‹e
->
sim˝u
->
∑øms
->
Âu_fma_°age_œãncy
[
i
],

219 
c‹e
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
 - 1);

221 
	`ö_c‹e_execuã_n⁄_pùe
(
c‹e
, 
FU_FPU_ALU
, &c‹e->
Âu_Æu
);

222 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_div_°ages
 - 1; i >= 0; i--)

224 
	`ö_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_DIV
, &c‹e->
idiv
[i],

225 
c‹e
->
sim˝u
->
∑øms
->
div_°age_œãncy
[
i
],

226 
c‹e
->
sim˝u
->
∑øms
->
num_div_°ages
 - 1);

228 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_mul_°ages
 - 1; i >= 0; i--)

230 
	`ö_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_MUL
, &c‹e->
imul
[i],

231 
c‹e
->
sim˝u
->
∑øms
->
mul_°age_œãncy
[
i
],

232 
c‹e
->
sim˝u
->
∑øms
->
num_mul_°ages
 - 1);

234 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_Æu_°ages
 - 1; i >= 0; i--)

236 
	`ö_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_ALU
, &c‹e->
ülu
[i],

237 
c‹e
->
sim˝u
->
∑øms
->
Æu_°age_œãncy
[
i
],

238 
c‹e
->
sim˝u
->
∑øms
->
num_Æu_°ages
 - 1);

240 
	}
}

248 
	$Êush_fu_°age
(
INC‹e
 *
c‹e
, 
CPUSège
 *
fu
, 
°ages
)

250 
i
;

251 
IM≠E¡ry
 *
e
;

253 
i
 = 0; i < 
°ages
; ++i)

255 i‡(
fu
[
i
].
has_d©a
)

259 
e
 = 
	`gë_im≠_íåy
(
c‹e
->
sim˝u
->
im≠
, 
fu
[
i
].
im≠_ödex
);

261 i‡(
e
->
ös
.
has_de°
)

263 
c‹e
->
öt_ªg_°©us
[
e
->
ös
.
rd
] = 
TRUE
;

265 i‡(
e
->
ös
.
has_Â_de°
)

267 
c‹e
->
Â_ªg_°©us
[
e
->
ös
.
rd
] = 
TRUE
;

270 
	`˝u_°age_Êush
(&
fu
[
i
]);

272 
	}
}

275 
	$Êush_•ecuœãd_˝u_°©e
(
INC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

277 
i
;

278 
RISCVCPUSèã
 *
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

281 
s
->
code_±r
 = 
NULL
;

282 
s
->
code_íd
 = 
NULL
;

283 
s
->
code_to_pc_addíd
 = 
e
->
bønch_èrgë
;

287 
e
->
is_bønch_èkí
 = 
TRUE
;

288 
e
->
bønch_èrgë
 =É->branch_target;

291 
	`˝u_°age_Êush
(&
c‹e
->
pcgí
);

292 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

293 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

294 
	`Êush_fu_°age
(
c‹e
, c‹e->
ülu
, 
s
->
sim˝u
->
∑øms
->
num_Æu_°ages
);

295 
	`Êush_fu_°age
(
c‹e
, c‹e->
imul
, 
s
->
sim˝u
->
∑øms
->
num_mul_°ages
);

296 
	`Êush_fu_°age
(
c‹e
, c‹e->
idiv
, 
s
->
sim˝u
->
∑øms
->
num_div_°ages
);

297 
	`Êush_fu_°age
(
c‹e
, &c‹e->
Âu_Æu
, 1);

298 
	`Êush_fu_°age
(
c‹e
, c‹e->
Âu_fma
, 
s
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
);

301 
	`cq_ª£t
(&
c‹e
->
ös_di•©ch_queue
.
cq
);

304 
	`mem£t
((*)
c‹e
->
fwd_œtch
, 0, (
D©aFWDL©ch
Ë* 
NUM_FWD_BUS
);

307 
	`mem_c⁄åﬁÀr_ª£t
(
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
);

310 
c‹e
->
pcgí
.
has_d©a
 = 
TRUE
;

313 
s
->
sim_ex˚±i⁄
 = 
FALSE
;

316 
i
 = 0; i < 
NUM_IMAP_ENTRY
; ++i)

318 i‡((
i
 !
c‹e
->
mem‹y
.
im≠_ödex
Ë&& (ò!c‹e->
commô
.imap_index))

320 
s
->
sim˝u
->
im≠
[
i
].
°©us
 = 
IMAP_ENTRY_STATUS_FREE
;

323 
	}
}

326 
	$ö_c‹e_mem‹y
(
INC‹e
 *
c‹e
)

328 
IM≠E¡ry
 *
e
;

329 
RISCVCPUSèã
 *
s
;

331 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

332 i‡(
c‹e
->
mem‹y
.
has_d©a
)

334 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
mem‹y
.
im≠_ödex
);

335 i‡(!
c‹e
->
mem‹y
.
°age_exec_d⁄e
)

337 
s
->
hw_pg_tb_wlk_œãncy
 = 1;

338 
s
->
hw_pg_tb_wlk_°age_id
 = 
MEMORY
;

342 
e
->
cuºít_œãncy
 = 1;

347 
e
->
max_œãncy
 = 1;

349 i‡(
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
)

351 i‡(
	`execuã_lﬂd_°‹e
(
s
, 
e
))

355 
e
->
ös
.
ex˚±i⁄
 = 
TRUE
;

356 
e
->
ös
.
ex˚±i⁄_ˇu£
 = 
SIM_MMU_EXCEPTION
;

360 
e
->
max_œãncy
 = 
s
->
hw_pg_tb_wlk_œãncy
;

363 
	`as£π
(
e
->
max_œãncy
);

370 
e
->
max_œãncy
 = 
s
->
hw_pg_tb_wlk_œãncy


371 + 
	`gë_d©a_mem_ac˚ss_œãncy
(
s
, 
e
);

373 i‡(
s
->
sim_∑øms
->
íabÀ_l1_ˇches
)

376 i‡(
e
->
ös
.
is_lﬂd
)

378 
e
->
max_œãncy


379 -
	`mö_öt
(
s
->
hw_pg_tb_wlk_œãncy
,

380 
s
->
sim˝u
->
mmu
->
dˇche
->
ªad_œãncy
);

382 i‡(
e
->
ös
.
is_°‹e
)

384 
e
->
max_œãncy


385 -
	`mö_öt
(
s
->
hw_pg_tb_wlk_œãncy
,

386 
s
->
sim˝u
->
mmu
->
dˇche
->
wrôe_œãncy
);

388 i‡(
e
->
ös
.
is_©omic
)

390 
e
->
max_œãncy
 -
	`mö_öt
(

391 
s
->
hw_pg_tb_wlk_œãncy
,

392 
	`mö_öt
(
s
->
sim˝u
->
mmu
->
dˇche
->
ªad_œãncy
,

393 
s
->
sim˝u
->
mmu
->
dˇche
->
wrôe_œãncy
));

398 i‡(
e
->
ös
.
is_bønch
)

400 i‡(
s
->
sim˝u
->
	`p‚_bønch_h™dÀr
(s, 
e
))

402 
	`Êush_•ecuœãd_˝u_°©e
(
c‹e
, 
e
);

406 
c‹e
->
mem‹y
.
°age_exec_d⁄e
 = 
TRUE
;

409 i‡(
e
->
cuºít_œãncy
 =e->
max_œãncy
)

416 i‡((
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
))

418 i‡(
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
backíd_mem_ac˚ss_queue


419 .
cur_size
)

421 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
d©a_mem_dñay
;

427 i‡(
e
->
ös
.
ex˚±i⁄
)

429 
	`£t_ex˚±i⁄_°©e
(
s
, 
e
);

430 
	`˝u_°age_Êush
(&
c‹e
->
pcgí
);

431 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

432 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

433 
	`˝u_°age_Êush
(&
c‹e
->
mem‹y
);

434 
	`exec_unô_Êush
(
c‹e
->
ülu
,

435 
s
->
sim˝u
->
∑øms
->
num_Æu_°ages
);

436 
	`exec_unô_Êush
(
c‹e
->
imul
,

437 
s
->
sim˝u
->
∑øms
->
num_mul_°ages
);

438 
	`exec_unô_Êush
(
c‹e
->
idiv
,

439 
s
->
sim˝u
->
∑øms
->
num_div_°ages
);

440 
	`exec_unô_Êush
(&
c‹e
->
Âu_Æu
, 1);

441 
	`exec_unô_Êush
(
c‹e
->
Âu_fma
,

442 
s
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
);

447 i‡(!
e
->
ös
.
ex˚±i⁄
 && !e->
d©a_fwd_d⁄e
 && !e->
kìp_de°_busy


448 && ((
e
->
ös
.
has_de°
 &&É->ös.
rd
 !0Ë||É->ös.
has_Â_de°
))

450 
c‹e
->
fwd_œtch
[
NUM_FWD_BUS
-1].
rd
 = 
e
->
ös
.rd;

451 
c‹e
->
fwd_œtch
[
NUM_FWD_BUS
-1].
buf„r
 = 
e
->
ös
.buffer;

452 
c‹e
->
fwd_œtch
[
NUM_FWD_BUS
-1].
öt_de°
 = 
e
->
ös
.
has_de°
;

453 
c‹e
->
fwd_œtch
[
NUM_FWD_BUS
-1].
Â_de°
 = 
e
->
ös
.
has_Â_de°
;

454 
c‹e
->
fwd_œtch
[
NUM_FWD_BUS
-1].
vÆid
 = 
TRUE
;

455 
e
->
d©a_fwd_d⁄e
 = 
TRUE
;

460 i‡(!
c‹e
->
commô
.
has_d©a
)

462 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
backíd_mem_ac˚ss_queue
.
cur_idx
 = 0;

463 
c‹e
->
mem‹y
.
°age_exec_d⁄e
 = 
FALSE
;

464 
e
->
max_œãncy
 = 0;

465 
e
->
cuºít_œãncy
 = 0;

466 
e
->
d©a_fwd_d⁄e
 = 
FALSE
;

467 
c‹e
->
commô
 = c‹e->
mem‹y
;

468 
	`˝u_°age_Êush
(&
c‹e
->
mem‹y
);

473 
e
->
cuºít_œãncy
++;

476 
	}
}

485 
	$ö_c‹e_commô
(
INC‹e
 *
c‹e
)

487 
IM≠E¡ry
 *
e
;

488 
RISCVCPUSèã
 *
s
;

490 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

491 i‡(
c‹e
->
commô
.
has_d©a
)

493 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
commô
.
im≠_ödex
);

495 i‡(
e
->
ös
.
has_de°
)

498 i‡(
e
->
ös
.
rd
)

500 
	`upd©e_¨ch_ªg_öt
(
s
, 
e
);

501 i‡(!
e
->
kìp_de°_busy
)

503 
c‹e
->
öt_ªg_°©us
[
e
->
ös
.
rd
] = 
TRUE
;

507 i‡(
e
->
ös
.
has_Â_de°
)

509 
	`upd©e_¨ch_ªg_Â
(
s
, 
e
);

510 i‡(!
e
->
kìp_de°_busy
)

512 
c‹e
->
Â_ªg_°©us
[
e
->
ös
.
rd
] = 
TRUE
;

516 
	`upd©e_ö¢_commô_°©s
(
s
, 
e
);

519 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

521 
	`£tup_sim_åa˚_pkt
(
s
, 
e
);

524 i‡(
s
->
sim_∑øms
->
íabÀ_°©s_di•œy
)

526 
	`wrôe_°©s_to_°©s_di•œy_shm
(
s
);

530 
e
->
°©us
 = 
IMAP_ENTRY_STATUS_FREE
;

531 
	`˝u_°age_Êush
(&
c‹e
->
commô
);

534 i‡((--
s
->
sim_n_cy˛es
) == 0)

536 
	`£t_timî_ex˚±i⁄_°©e
(
s
, 
e
);

541 
	}
}

	@riscvsim/inorder_frontend.c

32 
	~"ö‹dî.h
"

33 
	~"../riscv_˝u_¥iv.h
"

34 
	~"bpu.h
"

35 
	~"cúcuœr_queue.h
"

36 
	~"riscv_sim_˝u.h
"

43 
	$ö_c‹e_pcgí
(
INC‹e
 *
c‹e
)

45 
IM≠E¡ry
 *
e
;

46 
RISCVCPUSèã
 *
s
;

48 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

49 i‡(
c‹e
->
pcgí
.
has_d©a
)

51 i‡(!
c‹e
->
pcgí
.
°age_exec_d⁄e
)

54 
s
->
sim˝u
->
pc


55 (
èrgë_ul⁄g
)((
uöçå_t
)
s
->
code_±r
 + s->
code_to_pc_addíd
);

58 
e
 = 
	`Æloˇã_im≠_íåy
(
s
->
sim˝u
->
im≠
);

61 
e
->
ös_di•©ch_id
 = 
c‹e
->ins_dispatch_id++;

62 
e
->
ös
.
pc
 = 
s
->
sim˝u
->pc;

63 
e
->
ös
.
¸óã_°r
 = 
s
->
sim_∑øms
->
¸óã_ös_°r
;

69 
c‹e
->
pcgí
.
im≠_ödex
 = 
e
->imap_index;

70 
c‹e
->
pcgí
.
°age_exec_d⁄e
 = 
TRUE
;

75 i‡(!
c‹e
->
„tch
.
has_d©a
)

77 
c‹e
->
pcgí
.
°age_exec_d⁄e
 = 
FALSE
;

78 
c‹e
->
„tch
 = c‹e->
pcgí
;

79 
c‹e
->
pcgí
.
im≠_ödex
 = -1;

82 
	}
}

91 
	$ö_c‹e_„tch
(
INC‹e
 *
c‹e
)

93 
IM≠E¡ry
 *
e
;

94 
RISCVCPUSèã
 *
s
;

96 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

97 i‡(
c‹e
->
„tch
.
has_d©a
)

99 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
„tch
.
im≠_ödex
);

100 i‡(!
c‹e
->
„tch
.
°age_exec_d⁄e
)

102 
	`do_„tch_°age_exec
(
s
,
e
);

103 i‡(
e
->
ös
.
ex˚±i⁄
)

106 
	`˝u_°age_Êush
(&
c‹e
->
pcgí
);

107 
	`£t_ex˚±i⁄_°©e
(
s
, 
e
);

109 
c‹e
->
„tch
.
°age_exec_d⁄e
 = 
TRUE
;

113 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
„tch
.
im≠_ödex
);

116 i‡(
e
->
cuºít_œãncy
 =e->
max_œãncy
)

123 i‡(!
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue


124 .
cur_size
)

127 i‡(
e
->
ös
.
ex˚±i⁄
)

129 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

135 i‡(!
c‹e
->
decode
.
has_d©a
)

137 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue


138 .
cur_idx


141 
c‹e
->
„tch
.
°age_exec_d⁄e
 = 
FALSE
;

142 
e
->
max_œãncy
 = 0;

143 
e
->
cuºít_œãncy
 = 0;

144 
c‹e
->
decode
 = c‹e->
„tch
;

145 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

151 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ö¢_mem_dñay
;

156 
e
->
cuºít_œãncy
++;

159 
	}
}

168 
	$ªad_öt_›î™d
(
INC‹e
 *
c‹e
, 
has_§c
, *
ªad_rs
, 
rs
,

169 
uöt64_t
 *
buf„r
, *
ªg_fûe_ªad_d⁄e
)

171 
i
;

173 i‡(
has_§c
 && !(*
ªad_rs
))

175 i‡(!
c‹e
->
öt_ªg_°©us
[
rs
])

177 
i
 = 0; i < 
NUM_FWD_BUS
; ++i)

179 i‡(
c‹e
->
fwd_œtch
[
i
].
vÆid
 && c‹e->fwd_œtch[i].
öt_de°


180 && (
c‹e
->
fwd_œtch
[
i
].
rd
 =
rs
))

182 *
buf„r
 = (
èrgë_ul⁄g
)
c‹e
->
fwd_œtch
[
i
].buffer;

183 *
ªad_rs
 = 
TRUE
;

190 *
buf„r
 = (
èrgë_ul⁄g
)
c‹e
->
sim˝u
->
emu_˝u_°©e
->
ªg
[
rs
];

191 *
ªad_rs
 = 
TRUE
;

192 *
ªg_fûe_ªad_d⁄e
 = 
TRUE
;

195 
	}
}

198 
	$ªad_Â_›î™d
(
INC‹e
 *
c‹e
, 
has_§c
, *
ªad_rs
, 
rs
,

199 
uöt64_t
 *
buf„r
, *
ªg_fûe_ªad_d⁄e
)

201 
i
;

203 i‡(
has_§c
 && !(*
ªad_rs
))

205 i‡(!
c‹e
->
Â_ªg_°©us
[
rs
])

208 
i
 = 3; i < 
NUM_FWD_BUS
; ++i)

210 i‡(
c‹e
->
fwd_œtch
[
i
].
vÆid
 && c‹e->fwd_œtch[i].
Â_de°


211 && (
c‹e
->
fwd_œtch
[
i
].
rd
 =
rs
))

213 *
buf„r
 = 
c‹e
->
fwd_œtch
[
i
].buffer;

214 *
ªad_rs
 = 
TRUE
;

221 *
buf„r
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
Â_ªg
[
rs
];

222 *
ªad_rs
 = 
TRUE
;

223 *
ªg_fûe_ªad_d⁄e
 = 
TRUE
;

226 
	}
}

229 
	$£t_waw_lock_öt_de°
(
RISCVCPUSèã
 *
s
, 
CPUSège
 *
°age
, 
rd
)

231 
IM≠E¡ry
 *
e
;

233 i‡(
°age
->
has_d©a
)

235 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
°age
->
im≠_ödex
);

236 i‡(
e
->
ös
.
has_de°
 && (e->ös.
rd
 ==Ñd))

238 
e
->
kìp_de°_busy
 = 
TRUE
;

241 
	}
}

244 
	$£t_waw_lock_Â_de°
(
RISCVCPUSèã
 *
s
, 
CPUSège
 *
°age
, 
rd
)

246 
IM≠E¡ry
 *
e
;

248 i‡(
°age
->
has_d©a
)

250 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
°age
->
im≠_ödex
);

251 i‡(
e
->
ös
.
has_Â_de°
 && (e->ös.
rd
 ==Ñd))

253 
e
->
kìp_de°_busy
 = 
TRUE
;

256 
	}
}

259 
	$execuã_°age_busy
(
INC‹e
 *
c‹e
, * 
busy_°age_id
)

261 
i
;

263 
i
 = 0; i < 
c‹e
->
sim˝u
->
∑øms
->
num_Æu_°ages
; ++i)

265 i‡(
c‹e
->
ülu
[
i
].
has_d©a
)

267 *
busy_°age_id
 = 
FU_ALU
;

268  
TRUE
;

272 
i
 = 0; i < 
c‹e
->
sim˝u
->
∑øms
->
num_mul_°ages
; ++i)

274 i‡(
c‹e
->
imul
[
i
].
has_d©a
)

276 *
busy_°age_id
 = 
FU_MUL
;

277  
TRUE
;

281 
i
 = 0; i < 
c‹e
->
sim˝u
->
∑øms
->
num_div_°ages
; ++i)

283 i‡(
c‹e
->
idiv
[
i
].
has_d©a
)

285 *
busy_°age_id
 = 
FU_DIV
;

286  
TRUE
;

290 
i
 = 0; i < 
c‹e
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
; ++i)

292 i‡(
c‹e
->
Âu_fma
[
i
].
has_d©a
)

294 *
busy_°age_id
 = 
FU_FPU_FMA
;

295  
TRUE
;

299 i‡(
c‹e
->
Âu_Æu
.
has_d©a
)

301 *
busy_°age_id
 = 
FU_FPU_ALU
;

302  
TRUE
;

306  
FALSE
;

307 
	}
}

310 
	$èrgë_fu_pùñöed
(
INC‹e
 *
c‹e
, 
fu_ty≥
)

312 
num_°ages
 = 1;

314 
fu_ty≥
)

316 
FU_ALU
:

318 
num_°ages
 = 
c‹e
->
sim˝u
->
∑øms
->
num_Æu_°ages
;

321 
FU_MUL
:

323 
num_°ages
 = 
c‹e
->
sim˝u
->
∑øms
->
num_mul_°ages
;

326 
FU_DIV
:

328 
num_°ages
 = 
c‹e
->
sim˝u
->
∑øms
->
num_div_°ages
;

331 
FU_FPU_ALU
:

335 
FU_FPU_FMA
:

337 
num_°ages
 = 
c‹e
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
;

342 i‡(
num_°ages
 > 1)

344  
TRUE
;

347  
FALSE
;

348 
	}
}

351 
	$ö_c‹e_decode
(
INC‹e
 *
c‹e
)

353 
i
;

354 
IM≠E¡ry
 *
e
;

355 
RISCVCPUSèã
 *
s
;

356 
ös_issue_ödex
;

357 
busy_°age_id
 = -1;

358 
ªad_öt_rf
 = 0;

359 
ªad_Â_rf
 = 0;

361 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

362 i‡(
c‹e
->
decode
.
has_d©a
)

364 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
decode
.
im≠_ödex
);

365 i‡(!
c‹e
->
decode
.
°age_exec_d⁄e
)

367 i‡(!
e
->
is_decoded
)

369 
	`do_decode_°age_exec
(
s
, 
e
);

370 i‡(
s
->
sim˝u
->
	`p‚_bønch_‰⁄ãnd_decode_h™dÀr
(s, 
e
))

373 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
„tch
,

374 
s
->
sim˝u
->
im≠
);

375 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
pcgí
,

376 
s
->
sim˝u
->
im≠
);

377 
c‹e
->
pcgí
.
has_d©a
 = 
TRUE
;

379 
e
->
is_decoded
 = 
TRUE
;

383 i‡(
	`u∆ikñy
(
e
->
ös
.
ex˚±i⁄
))

385 
	`£t_ex˚±i⁄_°©e
(
s
, 
e
);

386 
	`˝u_°age_Êush
(&
c‹e
->
pcgí
);

387 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

388 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

393 
	`ªad_öt_›î™d
(
c‹e
, 
e
->
ös
.
has_§c1
, &e->
ªad_rs1
,É->ös.
rs1
,

394 &
e
->
ös
.
rs1_vÆ
, &
ªad_öt_rf
);

395 
	`ªad_öt_›î™d
(
c‹e
, 
e
->
ös
.
has_§c2
, &e->
ªad_rs2
,É->ös.
rs2
,

396 &
e
->
ös
.
rs2_vÆ
, &
ªad_öt_rf
);

399 
	`ªad_Â_›î™d
(
c‹e
, 
e
->
ös
.
has_Â_§c1
, &e->
ªad_rs1
,É->ös.
rs1
,

400 &
e
->
ös
.
rs1_vÆ
, &
ªad_Â_rf
);

401 
	`ªad_Â_›î™d
(
c‹e
, 
e
->
ös
.
has_Â_§c2
, &e->
ªad_rs2
,É->ös.
rs2
,

402 &
e
->
ös
.
rs2_vÆ
, &
ªad_Â_rf
);

403 
	`ªad_Â_›î™d
(
c‹e
, 
e
->
ös
.
has_Â_§c3
, &e->
ªad_rs3
,É->ös.
rs3
,

404 &
e
->
ös
.
rs3_vÆ
, &
ªad_Â_rf
);

407 i‡(((
e
->
ös
.
has_§c1
 ||É->ös.
has_Â_§c1
Ë&& !e->
ªad_rs1
)

408 || ((
e
->
ös
.
has_§c2
 ||É->ös.
has_Â_§c2
Ë&& !e->
ªad_rs2
)

409 || (
e
->
ös
.
has_Â_§c3
 && !e->
ªad_rs3
))

411 
exô_decode
;

419 i‡(
e
->
ös
.
has_de°
)

421 i‡(!
c‹e
->
öt_ªg_°©us
[
e
->
ös
.
rd
])

423 
	`£t_waw_lock_öt_de°
(
s
, &
c‹e
->
commô
, 
e
->
ös
.
rd
);

424 
	`£t_waw_lock_öt_de°
(
s
, &
c‹e
->
mem‹y
, 
e
->
ös
.
rd
);

425 
	`£t_waw_lock_öt_de°
(
s
, &
c‹e
->
Âu_Æu
, 
e
->
ös
.
rd
);

426 
i
 = 
s
->
sim˝u
->
∑øms
->
num_div_°ages
 - 1; i >= 0;

427 
i
--)

429 
	`£t_waw_lock_öt_de°
(
s
, &
c‹e
->
idiv
[
i
], 
e
->
ös
.
rd
);

431 
i
 = 
s
->
sim˝u
->
∑øms
->
num_mul_°ages
 - 1; i >= 0;

432 
i
--)

434 
	`£t_waw_lock_öt_de°
(
s
, &
c‹e
->
imul
[
i
], 
e
->
ös
.
rd
);

436 
i
 = 
s
->
sim˝u
->
∑øms
->
num_Æu_°ages
 - 1; i >= 0;

437 
i
--)

439 
	`£t_waw_lock_öt_de°
(
s
, &
c‹e
->
ülu
[
i
], 
e
->
ös
.
rd
);

444 i‡(
e
->
ös
.
has_Â_de°
)

446 i‡(!
c‹e
->
Â_ªg_°©us
[
e
->
ös
.
rd
])

448 
	`£t_waw_lock_Â_de°
(
s
, &
c‹e
->
commô
, 
e
->
ös
.
rd
);

449 
	`£t_waw_lock_Â_de°
(
s
, &
c‹e
->
mem‹y
, 
e
->
ös
.
rd
);

450 
i
 = 
s
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
 - 1;

451 
i
 >= 0; i--)

453 
	`£t_waw_lock_Â_de°
(
s
, &
c‹e
->
Âu_fma
[
i
], 
e
->
ös
.
rd
);

455 
	`£t_waw_lock_Â_de°
(
s
, &
c‹e
->
Âu_Æu
, 
e
->
ös
.
rd
);

459 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
TRUE
;

462 i‡(!
c‹e
->
sim˝u
->
∑øms
->
íabÀ_∑øŒñ_fu


463 && 
	`execuã_°age_busy
(
c‹e
, &
busy_°age_id
))

465 i‡(!(
	`èrgë_fu_pùñöed
(
c‹e
, 
e
->
ös
.
fu_ty≥
)

466 && (
e
->
ös
.
fu_ty≥
 =
busy_°age_id
)))

468 
exô_decode
;

475 
e
->
ös
.
fu_ty≥
)

477 
FU_ALU
:

478 i‡(!
c‹e
->
ülu
[0].
has_d©a
)

480 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
FALSE
;

481 
c‹e
->
ülu
[0] = c‹e->
decode
;

485 
exô_decode
;

488 
FU_MUL
:

489 i‡(!
c‹e
->
imul
[0].
has_d©a
)

491 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
FALSE
;

492 
c‹e
->
imul
[0] = c‹e->
decode
;

496 
exô_decode
;

499 
FU_DIV
:

500 i‡(!
c‹e
->
idiv
[0].
has_d©a
)

502 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
FALSE
;

503 
c‹e
->
idiv
[0] = c‹e->
decode
;

507 
exô_decode
;

510 
FU_FPU_ALU
:

511 i‡(!
c‹e
->
Âu_Æu
.
has_d©a
)

513 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
FALSE
;

514 
c‹e
->
Âu_Æu
 = c‹e->
decode
;

518 
exô_decode
;

521 
FU_FPU_FMA
:

522 i‡(!
c‹e
->
Âu_fma
[0].
has_d©a
)

524 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
FALSE
;

525 
c‹e
->
Âu_fma
[0] = c‹e->
decode
;

529 
exô_decode
;

535 
ös_issue_ödex
 = 
	`cq_íqueue
(&
c‹e
->
ös_di•©ch_queue
.
cq
);

536 
	`as£π
(
ös_issue_ödex
 != -1);

537 
c‹e
->
ös_di•©ch_queue
.
d©a
[
ös_issue_ödex
] = 
e
->
ös_di•©ch_id
;

538 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

540 
exô_decode
:

541 i‡(
ªad_öt_rf
)

543 
s
->
sim˝u
->
°©s
[s->
¥iv
].
öt_ªgfûe_ªads
++;

546 i‡(
ªad_Â_rf
)

548 
s
->
sim˝u
->
°©s
[s->
¥iv
].
Â_ªgfûe_ªads
++;

550 
	}
}

	@riscvsim/memory_controller.c

30 
	~<as£π.h
>

31 
	~<°dlib.h
>

32 
	~<°rög.h
>

33 
	~<°dio.h
>

35 
	~"cúcuœr_queue.h
"

36 
	~"mem‹y_c⁄åﬁÀr.h
"

37 
	~"dømsim_wøµî_c_c⁄√˘‹.h
"

39 
Mem‹yC⁄åﬁÀr
 *

40 
	$mem_c⁄åﬁÀr_öô
(c⁄° 
SimP¨ams
 *
p
)

42 
Mem‹yC⁄åﬁÀr
 *
m
;

44 
m
 = (
Mem‹yC⁄åﬁÀr
 *)
	`ˇŒoc
(1, (MemoryController));

45 
	`as£π
(
m
);

46 
m
->
døm_bur°_size
 = 
p
->dram_burst_size;

47 
m
->
mem_modñ_ty≥
 = 
p
->mem_model_type;

48 
m
->
mem_ac˚ss_œãncy
 = 
p
->mem_access_latency;

49 
m
->
±e_rw_œãncy
 = 
p
->pte_rw_latency;

51 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
max_size
 = 
FRONTEND_MEM_ACCESS_QUEUE_SIZE
;

52 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
 = (
PídögMemAc˚ssE¡ry
 *)
	`ˇŒoc
(

53 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
max_size
, (
PídögMemAc˚ssE¡ry
));

54 
	`as£π
(
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
);

56 
m
->
backíd_mem_ac˚ss_queue
.
max_size
 = 
BACKEND_MEM_ACCESS_QUEUE_SIZE
;

57 
m
->
backíd_mem_ac˚ss_queue
.
íåy
 = (
PídögMemAc˚ssE¡ry
 *)
	`ˇŒoc
(

58 
m
->
backíd_mem_ac˚ss_queue
.
max_size
, (
PídögMemAc˚ssE¡ry
));

59 
	`as£π
(
m
->
backíd_mem_ac˚ss_queue
.
íåy
);

61 
	`cq_öô
(&
m
->
mem_ªque°_queue
.
cq
, 
MEM_REQUEST_QUEUE_SIZE
);

62 
	`mem£t
((*)
m
->
mem_ªque°_queue
.
íåy
, 0,

63 (
PídögMemAc˚ssE¡ry
Ë* 
MEM_REQUEST_QUEUE_SIZE
);

65 
	`PRINT_INIT_MSG
("Setting up dram");

67 
m
->
mem_modñ_ty≥
)

69 
MEM_MODEL_BASE
:

71 
	`PRINT_INIT_MSG
("Setting up base dram model");

72 
m
->
mem_c⁄åﬁÀr_upd©e_öã∫Æ
 = &
mem_c⁄åﬁÀr_upd©e_ba£
;

73 
	`mem_c⁄åﬁÀr_£t_døm_bur°_size
(
m
, 
p
->
døm_bur°_size
);

76 
MEM_MODEL_DRAMSIM
:

78 
	`PRINT_INIT_MSG
("Setting up DRAMSim2");

79 
	`dømsim_wøµî_öô
(

80 
p
->
dømsim_öi_fûe
,Ö->
dømsim_sy°em_öi_fûe
,

81 
p
->
dømsim_°©s_dú
,Ö->
c‹e_«me
,Ö->
gue°_øm_size
,

82 &
m
->
‰⁄ãnd_mem_ac˚ss_queue
, &m->
backíd_mem_ac˚ss_queue
);

84 
m
->
mem_c⁄åﬁÀr_upd©e_öã∫Æ
 = &
mem_c⁄åﬁÀr_upd©e_dømsim
;

85 
	`mem_c⁄åﬁÀr_£t_døm_bur°_size
(
m
, 
	`dømsim_gë_bur°_size
());

88 i‡((
p
->
w‹ds_≥r_ˇche_löe
 * (
èrgë_ul⁄g
))

89 !
	`dømsim_gë_bur°_size
())

91 
	`Ârötf
(
°dîr
, "error: cacheÜine sizeánd dramsim burst size "

93 
	`exô
(1);

99 
	`Ârötf
(
°dîr
, "error: invalid memory model\n");

100 
	`exô
(1);

104  
m
;

105 
	}
}

108 
	$mem_c⁄åﬁÀr_‰ì
(
Mem‹yC⁄åﬁÀr
 **
m
)

110 (*
m
)->
mem_modñ_ty≥
)

112 
MEM_MODEL_BASE
:

116 
MEM_MODEL_DRAMSIM
:

118 
	`dømsim_wøµî_de°roy
();

123 
	`Ârötf
(
°dîr
, "error: invalid memory model\n");

124 
	`exô
(1);

127 
	`‰ì
((*
m
)->
backíd_mem_ac˚ss_queue
.
íåy
);

128 (*
m
)->
backíd_mem_ac˚ss_queue
.
íåy
 = 
NULL
;

129 
	`‰ì
((*
m
)->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
);

130 (*
m
)->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
 = 
NULL
;

131 
	`‰ì
(*
m
);

132 *
m
 = 
NULL
;

133 
	}
}

136 
	$mem_c⁄åﬁÀr_ª£t
(
Mem‹yC⁄åﬁÀr
 *
m
)

138 
m
->
cuºít_œãncy
 = 0;

139 
m
->
max_œãncy
 = 0;

140 
m
->
mem_ac˚ss_a˘ive
 = 0;

141 
m
->
œ°_ac˚s£d_∑ge_num
 = 0;

143 
	`mem_c⁄åﬁÀr_Êush_°age_mem_ac˚ss_queue
(&
m
->
‰⁄ãnd_mem_ac˚ss_queue
);

144 
	`mem_c⁄åﬁÀr_Êush_°age_mem_ac˚ss_queue
(&
m
->
backíd_mem_ac˚ss_queue
);

146 
	`cq_ª£t
(&
m
->
mem_ªque°_queue
.
cq
);

147 
	}
}

150 
	$mem_c⁄åﬁÀr_£t_døm_bur°_size
(
Mem‹yC⁄åﬁÀr
 *
m
, 
døm_bur°_size
)

152 
m
->
døm_bur°_size
 = dram_burst_size;

153 
	}
}

156 
	$mem_c⁄åﬁÀr_ac˚ss_døm
(
Mem‹yC⁄åﬁÀr
 *
m
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ac˚ss
,

157 
MemAc˚ssTy≥
 
ty≥
, *
p_mem_ac˚ss_öfo
)

159 
ödex
, 
°age
;

160 
èrgë_ul⁄g
 
°¨t_off£t
;

163 
°age
 = *(*)
p_mem_ac˚ss_öfo
;

166 
°¨t_off£t
 = 
∑ddr
 % 
m
->
døm_bur°_size
;

167 i‡(0 !
°¨t_off£t
)

169 
byãs_to_ac˚ss
 +
°¨t_off£t
;

170 
∑ddr
 -
°¨t_off£t
;

174 
byãs_to_ac˚ss
 > 0)

178 i‡(
°age
 =
FETCH
)

180 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[m->‰⁄ãnd_mem_ac˚ss_queue.
cur_idx
].
addr
 = 
∑ddr
;

181 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[m->‰⁄ãnd_mem_ac˚ss_queue.
cur_idx
].
ty≥
 =Åype;

182 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[m->‰⁄ãnd_mem_ac˚ss_queue.
cur_idx
].
vÆid
 = 1;

183 ++
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_idx
;

184 ++
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_size
;

186 i‡(
°age
 =
MEMORY
)

188 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[m->backíd_mem_ac˚ss_queue.
cur_idx
].
addr
 = 
∑ddr
;

189 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[m->backíd_mem_ac˚ss_queue.
cur_idx
].
ty≥
 =Åype;

190 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[m->backíd_mem_ac˚ss_queue.
cur_idx
].
vÆid
 = 1;

191 ++
m
->
backíd_mem_ac˚ss_queue
.
cur_idx
;

192 ++
m
->
backíd_mem_ac˚ss_queue
.
cur_size
;

197 
	`as£π
(0);

201 
ödex
 = 
	`cq_íqueue
(&
m
->
mem_ªque°_queue
.
cq
);

203 
	`as£π
(
ödex
 != -1);

204 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
addr
 = 
∑ddr
;

205 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
ty≥
 =Åype;

206 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
byãs_to_ac˚ss
 = m->
døm_bur°_size
;

207 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
vÆid
 = 1;

208 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
ªq_±e
 = 0;

211 
byãs_to_ac˚ss
 -
m
->
døm_bur°_size
;

212 
∑ddr
 +
m
->
døm_bur°_size
;

216 
	}
}

219 
	$mem_c⁄åﬁÀr_add_±e_to_døm_queue
(
Mem‹yC⁄åﬁÀr
 *
m
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ac˚ss
,

220 
MemAc˚ssTy≥
 
ty≥
, *
p_mem_ac˚ss_öfo
)

222 
ödex
, 
°age
;

225 
°age
 = *(*)
p_mem_ac˚ss_öfo
;

229 i‡(
°age
 =
FETCH
)

231 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[m->‰⁄ãnd_mem_ac˚ss_queue.
cur_idx
].
addr
 = 
∑ddr
;

232 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[m->‰⁄ãnd_mem_ac˚ss_queue.
cur_idx
].
ty≥
 =Åype;

233 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[m->‰⁄ãnd_mem_ac˚ss_queue.
cur_idx
].
vÆid
 = 1;

234 ++
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_idx
;

235 ++
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_size
;

237 i‡(
°age
 =
MEMORY
)

239 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[m->backíd_mem_ac˚ss_queue.
cur_idx
].
addr
 = 
∑ddr
;

240 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[m->backíd_mem_ac˚ss_queue.
cur_idx
].
ty≥
 =Åype;

241 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[m->backíd_mem_ac˚ss_queue.
cur_idx
].
vÆid
 = 1;

242 ++
m
->
backíd_mem_ac˚ss_queue
.
cur_idx
;

243 ++
m
->
backíd_mem_ac˚ss_queue
.
cur_size
;

248 
	`as£π
(0);

252 
ödex
 = 
	`cq_íqueue
(&
m
->
mem_ªque°_queue
.
cq
);

254 
	`as£π
(
ödex
 != -1);

255 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
addr
 = 
∑ddr
;

256 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
ty≥
 =Åype;

257 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
byãs_to_ac˚ss
 = m->
døm_bur°_size
;

258 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
vÆid
 = 1;

259 
m
->
mem_ªque°_queue
.
íåy
[
ödex
].
ªq_±e
 = 1;

262 
	}
}

266 
	$ªad_com∂ëe
(
Mem‹yC⁄åﬁÀr
 *
m
, 
èrgë_ul⁄g
 
addr
)

268 
i
;

270 
i
 = 0; i < 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_idx
; ++i)

272 i‡((
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
)

273 && (
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
addr
 ==áddr)

274 && (
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
ty≥
 =
Ród
))

276 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
 = 0;

277 --
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_size
;

282 
i
 = 0; i < 
m
->
backíd_mem_ac˚ss_queue
.
cur_idx
; ++i)

284 i‡((
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
)

285 && (
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
addr
 ==áddr)

286 && (
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
ty≥
 =
Ród
))

288 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
 = 0;

289 --
m
->
backíd_mem_ac˚ss_queue
.
cur_size
;

293 
	}
}

297 
	$wrôe_com∂ëe
(
Mem‹yC⁄åﬁÀr
 *
m
, 
èrgë_ul⁄g
 
addr
)

299 
i
;

301 
i
 = 0; i < 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_idx
; ++i)

303 i‡((
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
)

304 && (
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
addr
 ==áddr)

305 && (
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
ty≥
 =
Wrôe
))

307 
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
 = 0;

308 --
m
->
‰⁄ãnd_mem_ac˚ss_queue
.
cur_size
;

313 
i
 = 0; i < 
m
->
backíd_mem_ac˚ss_queue
.
cur_idx
; ++i)

315 i‡((
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
)

316 && (
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
addr
 ==áddr)

317 && (
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
ty≥
 =
Wrôe
))

319 
m
->
backíd_mem_ac˚ss_queue
.
íåy
[
i
].
vÆid
 = 0;

320 --
m
->
backíd_mem_ac˚ss_queue
.
cur_size
;

324 
	}
}

327 
	$mem_c⁄åﬁÀr_upd©e_ba£
(
Mem‹yC⁄åﬁÀr
 *
m
)

329 
uöt64_t
 
cuºít_∑ge_num
;

330 
PídögMemAc˚ssE¡ry
 *
e
;

332 i‡(!
m
->
mem_ac˚ss_a˘ive
)

334 i‡(!
	`cq_em±y
(&
m
->
mem_ªque°_queue
.
cq
))

336 
e
 = &
m
->
mem_ªque°_queue


337 .
íåy
[
	`cq_‰⁄t
(&
m
->
mem_ªque°_queue
.
cq
)];

339 i‡(
e
->
ªq_±e
)

342 
m
->
max_œãncy
 = m->
±e_rw_œãncy
;

346 
m
->
max_œãncy
 = m->
mem_ac˚ss_œãncy
;

350 
cuºít_∑ge_num
 = 
e
->
addr
 >> 12;

352 i‡(
m
->
œ°_ac˚s£d_∑ge_num
 =
cuºít_∑ge_num
)

355 
m
->
max_œãncy
 = m->max_latency * 0.6;

360 
m
->
œ°_ac˚s£d_∑ge_num
 = 
cuºít_∑ge_num
;

367 i‡(
e
->
ty≥
 =
Wrôe
)

369 
	`wrôe_com∂ëe
(
m
, 
e
->
addr
);

372 
m
->
mem_ac˚ss_a˘ive
 = 1;

373 
m
->
cuºít_œãncy
 = 1;

377 i‡(
m
->
mem_ac˚ss_a˘ive
)

379 
e
 = &
m
->
mem_ªque°_queue
.
íåy
[
	`cq_‰⁄t
(&m->mem_ªque°_queue.
cq
)];

381 i‡(
m
->
cuºít_œãncy
 =m->
max_œãncy
)

383 
m
->
mem_ac˚ss_a˘ive
 = 0;

384 
m
->
max_œãncy
 = 0;

385 
m
->
cuºít_œãncy
 = 0;

387 i‡(
e
->
ty≥
 =
Ród
)

389 
	`ªad_com∂ëe
(
m
, 
e
->
addr
);

393 
e
->
vÆid
 = 0;

394 
	`cq_dequeue
(&
m
->
mem_ªque°_queue
.
cq
);

398 
m
->
cuºít_œãncy
++;

401 
	}
}

404 
	$mem_c⁄åﬁÀr_upd©e_dømsim
(
Mem‹yC⁄åﬁÀr
 *
m
)

406 
PídögMemAc˚ssE¡ry
 *
e
;

408 !
	`cq_em±y
(&
m
->
mem_ªque°_queue
.
cq
))

410 
e
 = &
m
->
mem_ªque°_queue
.
íåy
[
	`cq_‰⁄t
(&m->mem_ªque°_queue.
cq
)];

411 i‡(
	`dømsim_wøµî_ˇn_add_å™ß˘i⁄
(
e
->
addr
))

413 
	`dømsim_wøµî_add_å™ß˘i⁄
(
e
->
addr
,É->
ty≥
);

414 
	`cq_dequeue
(&
m
->
mem_ªque°_queue
.
cq
);

422 
	`dømsim_wøµî_upd©e
();

423 
	}
}

426 
	$mem_c⁄åﬁÀr_Êush_°age_mem_ac˚ss_queue
(
SègeMemAc˚ssQueue
 *
q
)

428 
q
->
cur_idx
 = 0;

429 
q
->
cur_size
 = 0;

430 
	}
}

433 
	$mem_c⁄åﬁÀr_Êush_døm_queue
(
Mem‹yC⁄åﬁÀr
 *
m
)

435 
	`cq_ª£t
(&
m
->
mem_ªque°_queue
.
cq
);

436 
	}
}

	@riscvsim/memory_controller.h

30 #i‚de‡
_MEMORY_CONTROLLER_H_


31 
	#_MEMORY_CONTROLLER_H_


	)

33 
	~<m©h.h
>

35 
	~"sim_∑øms_°©s.h
"

36 
	~"cúcuœr_queue.h
"

37 
	~"mem‹y_c⁄åﬁÀr_utûs.h
"

38 
	~"riscv_sim_ty≥defs.h
"

39 
	~"../cutûs.h
"

41 
	#FRONTEND_MEM_ACCESS_QUEUE_SIZE
 64

	)

42 
	#BACKEND_MEM_ACCESS_QUEUE_SIZE
 64

	)

43 
	#MEM_REQUEST_QUEUE_SIZE
 64

	)

45 
	sMemReque°Queue


47 
CQ
 
	mcq
;

48 
PídögMemAc˚ssE¡ry
 
	míåy
[
MEM_REQUEST_QUEUE_SIZE
];

49 } 
	tMemReque°Queue
;

51 
	sMem‹yC⁄åﬁÀr


53 
	mmem_modñ_ty≥
;

54 
	mcuºít_œãncy
;

55 
	mmax_œãncy
;

56 
	mmem_ac˚ss_œãncy
;

57 
	m±e_rw_œãncy
;

58 
	mmem_ac˚ss_a˘ive
;

59 
uöt32_t
 
	mdøm_bur°_size
;

60 
uöt64_t
 
	mœ°_ac˚s£d_∑ge_num
;

61 (*
	mmem_c⁄åﬁÀr_upd©e_öã∫Æ
)(
	mMem‹yC⁄åﬁÀr
 *);

62 
SègeMemAc˚ssQueue
 
	m‰⁄ãnd_mem_ac˚ss_queue
;

63 
SègeMemAc˚ssQueue
 
	mbackíd_mem_ac˚ss_queue
;

64 
MemReque°Queue
 
	mmem_ªque°_queue
;

65 } 
	tMem‹yC⁄åﬁÀr
;

67 
Mem‹yC⁄åﬁÀr
 *
mem_c⁄åﬁÀr_öô
(c⁄° 
SimP¨ams
 *
p
);

68 
mem_c⁄åﬁÀr_‰ì
(
Mem‹yC⁄åﬁÀr
 **
m
);

69 
mem_c⁄åﬁÀr_ª£t
(
Mem‹yC⁄åﬁÀr
 *
m
);

70 
mem_c⁄åﬁÀr_upd©e_ba£
(
Mem‹yC⁄åﬁÀr
 *
m
);

71 
mem_c⁄åﬁÀr_upd©e_dømsim
(
Mem‹yC⁄åﬁÀr
 *
m
);

72 
mem_c⁄åﬁÀr_upd©e
(
Mem‹yC⁄åﬁÀr
 *
m
);

73 
mem_c⁄åﬁÀr_£t_døm_bur°_size
(
Mem‹yC⁄åﬁÀr
 *
m
,

74 
døm_bur°_size
);

75 
mem_c⁄åﬁÀr_Êush_°age_mem_ac˚ss_queue
(
SègeMemAc˚ssQueue
 *
q
);

76 
mem_c⁄åﬁÀr_ac˚ss_døm
(
Mem‹yC⁄åﬁÀr
 *
m
, 
èrgë_ul⁄g
 
∑ddr
,

77 
byãs_to_ac˚ss
, 
MemAc˚ssTy≥
 
›_ty≥
,

78 *
p_mem_ac˚ss_öfo
);

79 
mem_c⁄åﬁÀr_add_±e_to_døm_queue
(
Mem‹yC⁄åﬁÀr
 *
m
,

80 
èrgë_ul⁄g
 
∑ddr
,

81 
byãs_to_ac˚ss
,

82 
MemAc˚ssTy≥
 
ty≥
,

83 *
p_mem_ac˚ss_öfo
);

84 
mem_c⁄åﬁÀr_Êush_døm_queue
(
Mem‹yC⁄åﬁÀr
 *
m
);

	@riscvsim/memory_controller_utils.h

27 #i‚de‡
_MEM_CONTROLLER_UTILS_H_


28 
	#_MEM_CONTROLLER_UTILS_H_


	)

30 
	~"riscv_sim_ty≥defs.h
"

33 
	eMemAc˚ssTy≥


35 
	mRód
 = 0x0,

36 
	mWrôe
 = 0x1,

37 } 
	tMemAc˚ssTy≥
;

39 
	sPídögMemAc˚ssE¡ry


41 
	mvÆid
;

42 
	mbyãs_to_ac˚ss
;

43 
	mmax_byãs_to_ac˚ss
;

44 
èrgë_ul⁄g
 
	maddr
;

45 
èrgë_ul⁄g
 
	mªq_addr
;

46 
èrgë_ul⁄g
 
	mªq_±e
;

47 
	m°age_queue_ödex
;

48 
	m°age_queue_ty≥
;

49 
MemAc˚ssTy≥
 
	mty≥
;

50 } 
	tPídögMemAc˚ssE¡ry
;

52 
	sSègeMemAc˚ssQueue


54 
	mcur_idx
;

55 
	mmax_size
;

56 
	mcur_size
;

57 
PídögMemAc˚ssE¡ry
 *
	míåy
;

58 } 
	tSègeMemAc˚ssQueue
;

	@riscvsim/mmu.c

30 
	~<as£π.h
>

31 
	~<°dlib.h
>

32 
	~<°dio.h
>

34 
	~"mmu.h
"

41 
	$gë_num_ˇche_blks_‰om_ˇche_size_kb
(
size_kb
, 
num_w‹ds_≥r_löe
)

43  ()((
size_kb
 * 1024)

44 / (
num_w‹ds_≥r_löe
 * (
èrgë_ul⁄g
)));

45 
	}
}

47 
MMU
 *

48 
	$mmu_öô
(c⁄° 
SimP¨ams
 *
p
)

50 
MMU
 *
mmu
;

52 
mmu
 = (
MMU
 *)
	`ˇŒoc
(1, (MMU));

53 
	`as£π
(
mmu
);

56 
	`PRINT_INIT_MSG
("Setting up memory controller");

57 
mmu
->
mem_c⁄åﬁÀr
 = 
	`mem_c⁄åﬁÀr_öô
(
p
);

59 
mmu
->
ˇches_íabÀd
 = 
p
->
íabÀ_l1_ˇches
;

62 i‡(
p
->
íabÀ_l1_ˇches
)

66 
	`mem_c⁄åﬁÀr_£t_døm_bur°_size
(
mmu
->
mem_c⁄åﬁÀr
,

67 
p
->
w‹ds_≥r_ˇche_löe


68 * (
èrgë_ul⁄g
));

70 i‡(
p
->
íabÀ_l2_ˇche
)

72 
	`PRINT_INIT_MSG
("Setting upÜ2-shared cache");

73 
mmu
->
l2_ˇche
 = 
	`¸óã_ˇche
(

74 
Sh¨edCache
, 
L2
,

75 
	`gë_num_ˇche_blks_‰om_ˇche_size_kb
(
p
->
l2_sh¨ed_ˇche_size
,

76 
p
->
w‹ds_≥r_ˇche_löe
),

77 
p
->
l2_sh¨ed_ˇche_ways
,Ö->
l2_sh¨ed_ˇche_ªad_œãncy
,

78 
p
->
l2_sh¨ed_ˇche_wrôe_œãncy
, 
NULL
,Ö->
w‹ds_≥r_ˇche_löe
,

79 (
CacheEvi˘i⁄Pﬁicy
)
p
->
l2_sh¨ed_ˇche_evi˘
,

80 (
CacheWrôePﬁicy
)
p
->
ˇche_wrôe_pﬁicy
,

81 (
CacheRódAŒocPﬁicy
)
p
->
ˇche_ªad_Æloˇã_pﬁicy
,

82 (
CacheWrôeAŒocPﬁicy
)
p
->
ˇche_wrôe_Æloˇã_pﬁicy
,

83 
mmu
->
mem_c⁄åﬁÀr
);

86 
	`PRINT_INIT_MSG
("Setting upÜ1-instruction cache");

87 
mmu
->
iˇche
 = 
	`¸óã_ˇche
(

88 
In°ru˘i⁄Cache
, 
L1
,

89 
	`gë_num_ˇche_blks_‰om_ˇche_size_kb
(
p
->
l1_code_ˇche_size
,

90 
p
->
w‹ds_≥r_ˇche_löe
),

91 
p
->
l1_code_ˇche_ways
,Ö->
l1_code_ˇche_ªad_œãncy
,1,

92 
mmu
->
l2_ˇche
, 
p
->
w‹ds_≥r_ˇche_löe
,

93 (
CacheEvi˘i⁄Pﬁicy
)
p
->
l1_code_ˇche_evi˘
,

94 (
CacheWrôePﬁicy
)
p
->
ˇche_wrôe_pﬁicy
,

95 (
CacheRódAŒocPﬁicy
)
p
->
ˇche_ªad_Æloˇã_pﬁicy
,

96 (
CacheWrôeAŒocPﬁicy
)
p
->
ˇche_wrôe_Æloˇã_pﬁicy
,

97 
mmu
->
mem_c⁄åﬁÀr
);

99 
	`PRINT_INIT_MSG
("Setting upÜ1-data cache");

100 
mmu
->
dˇche
 = 
	`¸óã_ˇche
(

101 
D©aCache
, 
L1
, 
	`gë_num_ˇche_blks_‰om_ˇche_size_kb
(

102 
p
->
l1_d©a_ˇche_size
,Ö->
w‹ds_≥r_ˇche_löe
),

103 
p
->
l1_d©a_ˇche_ways
,Ö->
l1_d©a_ˇche_ªad_œãncy
,

104 
p
->
l1_d©a_ˇche_wrôe_œãncy
, 
mmu
->
l2_ˇche
,

105 
p
->
w‹ds_≥r_ˇche_löe
,

106 (
CacheEvi˘i⁄Pﬁicy
)
p
->
l1_d©a_ˇche_evi˘
,

107 (
CacheWrôePﬁicy
)
p
->
ˇche_wrôe_pﬁicy
,

108 (
CacheRódAŒocPﬁicy
)
p
->
ˇche_ªad_Æloˇã_pﬁicy
,

109 (
CacheWrôeAŒocPﬁicy
)
p
->
ˇche_wrôe_Æloˇã_pﬁicy
,

110 
mmu
->
mem_c⁄åﬁÀr
);

113  
mmu
;

114 
	}
}

128 
	$mmu_ö¢_ªad
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
, 
°age_id
, 
¥iv
)

130 i‡(
mmu
->
ˇches_íabÀd
)

132  
	`ˇche_ªad
(
mmu
->
iˇche
, 
∑ddr
, 
byãs_to_ªad
, (*)&
°age_id
, 
¥iv
);

135 
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
mmu
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_ªad
,

136 
Ród
, (*)&
°age_id
);

138 
	}
}

141 
	$mmu_d©a_ªad
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
, 
°age_id
, 
¥iv
)

143 i‡(
mmu
->
ˇches_íabÀd
)

145  
	`ˇche_ªad
(
mmu
->
dˇche
, 
∑ddr
, 
byãs_to_ªad
, (*)&
°age_id
, 
¥iv
);

148 
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
mmu
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_ªad
,

149 
Ród
, (*)&
°age_id
);

151 
	}
}

154 
	$mmu_d©a_wrôe
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
, 
°age_id
, 
¥iv
)

156 i‡(
mmu
->
ˇches_íabÀd
)

158  
	`ˇche_wrôe
(
mmu
->
dˇche
, 
∑ddr
, 
byãs_to_wrôe
,

159 (*)&
°age_id
, 
¥iv
);

162 
	`mem_c⁄åﬁÀr_ac˚ss_døm
(
mmu
->
mem_c⁄åﬁÀr
, 
∑ddr
,

163 
byãs_to_wrôe
, 
Wrôe
, (*)&
°age_id
);

165 
	}
}

172 
	$mmu_±e_ªad
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
, 
°age_id
,

173 
¥iv
)

175  
	`mem_c⁄åﬁÀr_add_±e_to_døm_queue
(

176 
mmu
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_ªad
, 
Ród
, (*)&
°age_id
);

177 
	}
}

184 
	$mmu_±e_wrôe
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
, 
°age_id
,

185 
¥iv
)

187  
	`mem_c⁄åﬁÀr_add_±e_to_døm_queue
(

188 
mmu
->
mem_c⁄åﬁÀr
, 
∑ddr
, 
byãs_to_wrôe
, 
Wrôe
, (*)&
°age_id
);

189 
	}
}

192 
	$mmu_‰ì
(
MMU
 **
mmu
)

194 i‡((*
mmu
)->
ˇches_íabÀd
)

196 i‡((*
mmu
)->
l2_ˇche
)

198 
	`dñëe_ˇche
(&(*
mmu
)->
l2_ˇche
);

200 
	`dñëe_ˇche
(&(*
mmu
)->
dˇche
);

201 
	`dñëe_ˇche
(&(*
mmu
)->
iˇche
);

204 
	`mem_c⁄åﬁÀr_‰ì
(&(*
mmu
)->
mem_c⁄åﬁÀr
);

206 
	`‰ì
(*
mmu
);

207 *
mmu
 = 
NULL
;

208 
	}
}

	@riscvsim/mmu.h

30 #i‚de‡
_MMU_H_


31 
	#_MMU_H_


	)

33 
	~"sim_∑øms_°©s.h
"

34 
	~"ˇche.h
"

35 
	~"mem‹y_c⁄åﬁÀr.h
"

36 
	~"riscv_sim_ty≥defs.h
"

38 
	sMem‹yM™agemítUnô


40 
Mem‹yC⁄åﬁÀr
 *
	mmem_c⁄åﬁÀr
;

41 
Cache
 *
	miˇche
;

42 
Cache
 *
	mdˇche
;

43 
Cache
 *
	ml2_ˇche
;

44 
	mˇches_íabÀd
;

45 } 
	tMMU
;

47 
MMU
 *
mmu_öô
(c⁄° 
SimP¨ams
 *
p
);

48 
mmu_ö¢_ªad
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

49 
°age_id
, 
¥iv
);

50 
mmu_d©a_ªad
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
,

51 
°age_id
, 
¥iv
);

52 
mmu_d©a_wrôe
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
,

53 
°age_id
, 
¥iv
);

54 
mmu_±e_ªad
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_ªad
, 
°age_id
, 
¥iv
);

55 
mmu_±e_wrôe
(
MMU
 *
mmu
, 
èrgë_ul⁄g
 
∑ddr
, 
byãs_to_wrôe
,

56 
°age_id
, 
¥iv
);

57 
mmu_‰ì
(
MMU
 **
mmu
);

	@riscvsim/ooo.c

27 
	~<°dlib.h
>

29 
	~"../cutûs.h
"

30 
	~"../riscv_˝u_¥iv.h
"

31 
	~"cúcuœr_queue.h
"

32 
	~"ooo.h
"

33 
	~"riscv_sim_˝u.h
"

35 
OOC‹e
 *

36 
	$oo_c‹e_öô
(c⁄° 
SimP¨ams
 *
p
, 
RISCVSIMCPUSèã
 *
sim˝u
)

38 
OOC‹e
 *
c‹e
;

40 
c‹e
 = 
	`ˇŒoc
(1, (
OOC‹e
));

41 
	`as£π
(
c‹e
);

44 
	`cq_öô
(&
c‹e
->
rob
.
cq
, 
p
->
rob_size
);

45 
c‹e
->
rob
.
íåõs
 = (
ROBE¡ry
 *)
	`ˇŒoc
(
p
->
rob_size
, (ROBEntry));

46 
	`as£π
(
c‹e
->
rob
.
íåõs
);

49 
	`cq_öô
(&
c‹e
->
lsq
.
cq
, 
p
->
lsq_size
);

50 
c‹e
->
lsq
.
íåõs
 = (
LSQE¡ry
 *)
	`ˇŒoc
(
p
->
lsq_size
, (LSQEntry));

51 
	`as£π
(
c‹e
->
lsq
.
íåõs
);

54 
c‹e
->
öt_øt


55 (
RíameTabÀE¡ry
 *)
	`ˇŒoc
(
NUM_INT_REG
, (RenameTableEntry));

56 
c‹e
->
Â_øt


57 (
RíameTabÀE¡ry
 *)
	`ˇŒoc
(
NUM_FP_REG
, (RenameTableEntry));

60 
c‹e
->
iq


61 (
IssueQueueE¡ry
 *)
	`ˇŒoc
(
p
->
iq_size
, (IssueQueueEntry));

64 
c‹e
->
ülu
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_Æu_°ages
, (CPUStage));

65 
	`as£π
(
c‹e
->
ülu
);

67 
c‹e
->
imul
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_mul_°ages
, (CPUStage));

68 
	`as£π
(
c‹e
->
imul
);

70 
c‹e
->
idiv
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_div_°ages
, (CPUStage));

71 
	`as£π
(
c‹e
->
idiv
);

73 
c‹e
->
Âu_fma
 = (
CPUSège
 *)
	`ˇŒoc
(
p
->
num_Âu_fma_°ages
, (CPUStage));

74 
	`as£π
(
c‹e
->
Âu_fma
);

76 
c‹e
->
sim˝u
 = simcpu;

77  
c‹e
;

78 
	}
}

81 
	$oo_c‹e_ª£t
(*
c‹e_ty≥
)

83 
i
;

84 
OOC‹e
 *
c‹e
;

86 
c‹e
 = (
OOC‹e
 *)
c‹e_ty≥
;

88 
c‹e
->
ös_di•©ch_id
 = 0;

91 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

92 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

93 
	`˝u_°age_Êush
(&
c‹e
->
di•©ch
);

96 
	`˝u_°age_Êush
(&
c‹e
->
lsu
);

99 
c‹e
->
„tch
.
has_d©a
 = 
TRUE
;

102 
i
 = 0; i < 
NUM_INT_REG
; ++i)

104 
c‹e
->
öt_øt
[
i
].
rob_idx
 = -1;

105 
c‹e
->
öt_øt
[
i
].
ªad_‰om_rob
 = 
FALSE
;

108 
i
 = 0; i < 
NUM_FP_REG
; ++i)

110 
c‹e
->
Â_øt
[
i
].
rob_idx
 = -1;

111 
c‹e
->
Â_øt
[
i
].
ªad_‰om_rob
 = 
FALSE
;

114 
	`cq_ª£t
(&
c‹e
->
rob
.
cq
);

115 
	`cq_ª£t
(&
c‹e
->
lsq
.
cq
);

116 
	`iq_ª£t
(
c‹e
->
iq
, c‹e->
sim˝u
->
∑øms
->
iq_size
);

119 
	`exec_unô_Êush
(
c‹e
->
ülu
, c‹e->
sim˝u
->
∑øms
->
num_Æu_°ages
);

120 
	`exec_unô_Êush
(
c‹e
->
imul
, c‹e->
sim˝u
->
∑øms
->
num_mul_°ages
);

121 
	`exec_unô_Êush
(
c‹e
->
idiv
, c‹e->
sim˝u
->
∑øms
->
num_div_°ages
);

122 
	`exec_unô_Êush
(
c‹e
->
Âu_fma
, c‹e->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
);

123 
	`˝u_°age_Êush
(&
c‹e
->
Âu_Æu
);

124 
	}
}

127 
	$iq_ª£t
(
IssueQueueE¡ry
 *
iq_íåy
, 
size
)

129 
i
;

131 
i
 = 0; i < 
size
; ++i)

133 
iq_íåy
[
i
].
vÆid
 = 
FALSE
;

134 
iq_íåy
[
i
].
ªady
 = 
FALSE
;

135 
iq_íåy
[
i
].
e
 = 
NULL
;

137 
	}
}

140 
	$iq_fuŒ
(
IssueQueueE¡ry
 *
iq
, 
size
)

142 
i
;

144 
i
 = 0; i < 
size
; ++i)

146 i‡(
iq
[
i
].
vÆid
 =
FALSE
)

148  
FALSE
;

152  
TRUE
;

153 
	}
}

156 
	$iq_gë_‰ì_íåy
(
IssueQueueE¡ry
 *
iq
, 
size
)

158 
i
;

160 
i
 = 0; i < 
size
; ++i)

162 i‡(
iq
[
i
].
vÆid
 =
FALSE
)

164  
i
;

168 
	`as£π
(0);

170 
	}
}

173 
	$oo_c‹e_‰ì
(*
c‹e_ty≥
)

175 
OOC‹e
 *
c‹e
;

177 
c‹e
 = (
OOC‹e
 *)(*((OOC‹ê**)
c‹e_ty≥
));

178 
	`‰ì
(
c‹e
->
öt_øt
);

179 
c‹e
->
öt_øt
 = 
NULL
;

180 
	`‰ì
(
c‹e
->
Â_øt
);

181 
c‹e
->
Â_øt
 = 
NULL
;

182 
	`‰ì
(
c‹e
->
rob
.
íåõs
);

183 
c‹e
->
rob
.
íåõs
 = 
NULL
;

184 
	`‰ì
(
c‹e
->
lsq
.
íåõs
);

185 
c‹e
->
lsq
.
íåõs
 = 
NULL
;

186 
	`‰ì
(
c‹e
->
iq
);

187 
c‹e
->
iq
 = 
NULL
;

188 
	`‰ì
(
c‹e
->
ülu
);

189 
c‹e
->
ülu
 = 
NULL
;

190 
	`‰ì
(
c‹e
->
imul
);

191 
c‹e
->
imul
 = 
NULL
;

192 
	`‰ì
(
c‹e
->
idiv
);

193 
c‹e
->
idiv
 = 
NULL
;

194 
	`‰ì
(
c‹e
->
Âu_fma
);

195 
c‹e
->
Âu_fma
 = 
NULL
;

196 
	`‰ì
(
c‹e
);

197 
	}
}

200 
	$oo_c‹e_run
(*
c‹e_ty≥
)

202 
OOC‹e
 *
c‹e
;

204 
c‹e
 = (
OOC‹e
 *)
c‹e_ty≥
;

208 
c‹e
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
	`mem_c⁄åﬁÀr_upd©e_öã∫Æ
(

209 
c‹e
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
);

211 i‡(
	`oo_c‹e_rob_commô
(
c‹e
))

213  
c‹e
->
sim˝u
->
emu_˝u_°©e
->
sim_ex˚±i⁄_ˇu£
;

216 
	`oo_c‹e_lsq
(
c‹e
);

217 
	`oo_c‹e_lsu
(
c‹e
);

221 
	`oo_c‹e_lsq
(
c‹e
);

223 
	`oo_c‹e_execuã_Æl
(
c‹e
);

224 
	`oo_c‹e_issue
(
c‹e
);

225 
	`oo_c‹e_di•©ch
(
c‹e
);

226 
	`oo_c‹e_decode
(
c‹e
);

227 
	`oo_c‹e_„tch
(
c‹e
);

230 ++
c‹e
->
sim˝u
->
˛ock
;

231 ++
c‹e
->
sim˝u
->
°©s
[c‹e->sim˝u->
emu_˝u_°©e
->
¥iv
].
cy˛es
;

233 
	}
}

239 
	$rob_íåy_commôãd
(
ROB
 *
rob
, 
§c_idx
, 
cuºít_idx
)

241 i‡(
rob
->
cq
.
ª¨
 >rob->cq.
‰⁄t
)

243 i‡((
§c_idx
 >
rob
->
cq
.
‰⁄t
Ë&& (§c_idx < 
cuºít_idx
))

245  
FALSE
;

250 i‡((
cuºít_idx
 >
rob
->
cq
.
‰⁄t
Ë&& (cuºít_idx <Ñob->cq.
max_size
)

251 && (
§c_idx
 >
rob
->
cq
.
‰⁄t
Ë&& (§c_idx <Ñob->cq.
max_size
Ë&& (§c_idx < 
cuºít_idx
))

253  
FALSE
;

255 i‡((
cuºít_idx
 >0Ë&& (cuºít_idx <
rob
->
cq
.
ª¨
)

256 && (((
§c_idx
 >
rob
->
cq
.
‰⁄t
Ë&& (§c_idx <Ñob->cq.
max_size
))

257 || (
§c_idx
 < 
cuºít_idx
)))

259  
FALSE
;

262  
TRUE
;

263 
	}
}

266 
	$ªad_öt_›î™d_‰om_rob_¶Ÿ
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
¨ch_§c
,

267 
§c_rob_idx
, 
cuºít_rob_idx
,

268 
uöt64_t
 *
buf„r
, *
ªad_Êag
)

270 
ROBE¡ry
 *
rbe
;

272 
	`as£π
(
§c_rob_idx
 !
cuºít_rob_idx
);

274 i‡(
	`rob_íåy_commôãd
(&
c‹e
->
rob
, 
§c_rob_idx
, 
cuºít_rob_idx
))

278 *
buf„r
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
ªg
[
¨ch_§c
];

279 *
ªad_Êag
 = 
TRUE
;

284 
rbe
 = &
c‹e
->
rob
.
íåõs
[
§c_rob_idx
];

285 i‡(
rbe
->
ªady
 && !rbe->
e
->
ös
.
ex˚±i⁄
 &&Ñbe->e->ös.
has_de°


286 && (
rbe
->
e
->
ös
.
rd
 =
¨ch_§c
))

288 *
buf„r
 = 
rbe
->
e
->
ös
.buffer;

289 *
ªad_Êag
 = 
TRUE
;

292 
	}
}

295 
	$ªad_Â_›î™d_‰om_rob_¶Ÿ
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
¨ch_§c
,

296 
§c_rob_idx
, 
cuºít_rob_idx
,

297 
uöt64_t
 *
buf„r
, *
ªad_Êag
)

299 
ROBE¡ry
 *
rbe
;

301 
	`as£π
(
§c_rob_idx
 !
cuºít_rob_idx
);

303 i‡(
	`rob_íåy_commôãd
(&
c‹e
->
rob
, 
§c_rob_idx
, 
cuºít_rob_idx
))

307 *
buf„r
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
Â_ªg
[
¨ch_§c
];

308 *
ªad_Êag
 = 
TRUE
;

313 
rbe
 = &
c‹e
->
rob
.
íåõs
[
§c_rob_idx
];

314 i‡(
rbe
->
ªady
 & !rbe->
e
->
ös
.
ex˚±i⁄
 &&Ñbe->e->ös.
has_Â_de°


315 && (
rbe
->
e
->
ös
.
rd
 =
¨ch_§c
))

317 *
buf„r
 = 
rbe
->
e
->
ös
.buffer;

318 *
ªad_Êag
 = 
TRUE
;

321 
	}
}

	@riscvsim/ooo.h

27 #i‚de‡
_OOO_H_


28 
	#_OOO_H_


	)

30 
	~"sim_∑øms_°©s.h
"

31 
	~"comm⁄_c‹e_utûs.h
"

32 
	~"cúcuœr_queue.h
"

35 
	gRISCVSIMCPUSèã
;

37 
	sIssueQueueE¡ry


39 
	mvÆid
;

40 
	mªady
;

41 
IM≠E¡ry
 *
	me
;

42 } 
	tIssueQueueE¡ry
;

44 
	sROBE¡ry


46 
	mªady
;

47 
IM≠E¡ry
 *
	me
;

48 } 
	tROBE¡ry
;

50 
	sReOrdîBuf„r


52 
CQ
 
	mcq
;

53 
ROBE¡ry
 *
	míåõs
;

54 } 
	tROB
;

56 
	sLSQE¡ry


58 
	mªady
;

59 
	mmem_ªque°_£¡
;

60 
	mmem_ªque°_com∂ëe
;

61 
IM≠E¡ry
 *
	me
;

62 } 
	tLSQE¡ry
;

64 
	sLSQ


66 
CQ
 
	mcq
;

67 
LSQE¡ry
 *
	míåõs
;

68 } 
	tLSQ
;

70 
	sRíameTabÀE¡ry


72 
	mªad_‰om_rob
;

73 
	mrob_idx
;

74 } 
	tRíameTabÀE¡ry
;

76 
	sOOC‹e


79 
CPUSège
 
	m„tch
;

80 
CPUSège
 
	mdecode
;

81 
CPUSège
 
	mdi•©ch
;

84 
RíameTabÀE¡ry
 *
	möt_øt
;

85 
RíameTabÀE¡ry
 *
	mÂ_øt
;

87 
ROB
 
	mrob
;

88 
LSQ
 
	mlsq
;

91 
IssueQueueE¡ry
 *
	miq
;

94 
CPUSège
 *
	mülu
;

95 
CPUSège
 *
	mimul
;

96 
CPUSège
 *
	midiv
;

97 
CPUSège
 *
	mÂu_fma
;

99 
CPUSège
 
	mÂu_Æu
;

102 
CPUSège
 
	mlsu
;

105 
uöt64_t
 
	mös_di•©ch_id
;

107 
RISCVSIMCPUSèã
 *
	msim˝u
;

108 } 
	tOOC‹e
;

111 
OOC‹e
 *
oo_c‹e_öô
(c⁄° 
SimP¨ams
 *
p
, 
RISCVSIMCPUSèã
 *
sim˝u
);

112 
oo_c‹e_ª£t
(*
c‹e_ty≥
);

113 
oo_c‹e_‰ì
(*
c‹e_ty≥
);

114 
oo_c‹e_run
(*
c‹e_ty≥
);

117 
oo_c‹e_rob_commô
(
OOC‹e
 *
c‹e
);

118 
oo_c‹e_lsq
(
OOC‹e
 *
c‹e
);

119 
oo_c‹e_lsu
(
OOC‹e
 *
c‹e
);

120 
oo_c‹e_execuã_Æl
(
OOC‹e
 *
c‹e
);

121 
oo_c‹e_issue
(
OOC‹e
 *
c‹e
);

122 
oo_c‹e_di•©ch
(
OOC‹e
 *
c‹e
);

123 
oo_c‹e_decode
(
OOC‹e
 *
c‹e
);

124 
oo_c‹e_„tch
(
OOC‹e
 *
c‹e
);

127 
oo_¥o˚ss_bønch
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
);

129 
iq_ª£t
(
IssueQueueE¡ry
 *
iq_íåy
, 
size
);

130 
iq_fuŒ
(
IssueQueueE¡ry
 *
iq
, 
size
);

131 
iq_gë_‰ì_íåy
(
IssueQueueE¡ry
 *
iq
, 
size
);

132 
ªad_öt_›î™d_‰om_rob_¶Ÿ
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
a§c
,

133 
p§c
, 
cuºít_rob_idx
,

134 
uöt64_t
 *
buf„r
, *
ªad_Êag
);

135 
ªad_Â_›î™d_‰om_rob_¶Ÿ
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
a§c
,

136 
p§c
, 
cuºít_rob_idx
,

137 
uöt64_t
 *
buf„r
, *
ªad_Êag
);

138 
rob_íåy_commôãd
(
ROB
 *
rob
, 
§c_idx
, 
cuºít_idx
);

	@riscvsim/ooo_backend.c

27 
	~<°dio.h
>

29 
	~"../riscv_˝u_¥iv.h
"

30 
	~"cúcuœr_queue.h
"

31 
	~"ooo.h
"

32 
	~"riscv_ös_execuã_lib.h
"

33 
	~"riscv_sim_˝u.h
"

40 
	$issue_ös_to_exec_unô
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

42 
CPUSège
 *
fu
;

44 
e
->
ös
.
fu_ty≥
)

46 
FU_ALU
:

48 
fu
 = &
c‹e
->
ülu
[0];

51 
FU_MUL
:

53 
fu
 = &
c‹e
->
imul
[0];

56 
FU_DIV
:

58 
fu
 = &
c‹e
->
idiv
[0];

61 
FU_FPU_ALU
:

63 
fu
 = &
c‹e
->
Âu_Æu
;

66 
FU_FPU_FMA
:

68 
fu
 = &
c‹e
->
Âu_fma
[0];

73 
	`as£π
(0);

77 i‡(!
fu
->
has_d©a
)

79 
fu
->
has_d©a
 = 
TRUE
;

80 
fu
->
°age_exec_d⁄e
 = 
FALSE
;

81 
fu
->
im≠_ödex
 = 
e
->imap_index;

87 
	}
}

90 
	$ªad_öt_›î™d
(
OOC‹e
 *
c‹e
, 
has_§c
, *
ªad_§c
, 
¨ch_§c
,

91 
phy_§c
, 
cuºít_rob_idx
, 
uöt64_t
 *
buf„r
,

92 
IM≠E¡ry
 *
e
)

94 i‡(
has_§c
 && !(*
ªad_§c
))

96 
	`ªad_öt_›î™d_‰om_rob_¶Ÿ
(
c‹e
, 
e
, 
¨ch_§c
, 
phy_§c
,

97 
cuºít_rob_idx
, 
buf„r
, 
ªad_§c
);

99 
	}
}

102 
	$ªad_Â_›î™d
(
OOC‹e
 *
c‹e
, 
has_§c
, *
ªad_§c
, 
¨ch_§c
,

103 
phy_§c
, 
cuºít_rob_idx
, 
uöt64_t
 *
buf„r
,

104 
IM≠E¡ry
 *
e
)

106 i‡(
has_§c
 && !(*
ªad_§c
))

108 
	`ªad_Â_›î™d_‰om_rob_¶Ÿ
(
c‹e
, 
e
, 
¨ch_§c
, 
phy_§c
,

109 
cuºít_rob_idx
, 
buf„r
, 
ªad_§c
);

111 
	}
}

114 
	$issue_ö°ru˘i⁄
(
OOC‹e
 *
c‹e
, 
IssueQueueE¡ry
 *
iqe
, 
IM≠E¡ry
 *
e
)

116 i‡(!
	`issue_ös_to_exec_unô
(
c‹e
, 
e
))

119 
iqe
->
vÆid
 = 
FALSE
;

120 
iqe
->
ªady
 = 
FALSE
;

121 
iqe
->
e
 = 
NULL
;

123  
TRUE
;

127  
FALSE
;

128 
	}
}

131 
	$¥o˚ss_iq
(
OOC‹e
 *
c‹e
, 
IssueQueueE¡ry
 *
iq
, 
iq_size
, 
max_issue_p‹ts
)

133 
i
;

134 
IM≠E¡ry
 *
e
;

135 
IssueQueueE¡ry
 *
iqe
;

136 
cuºít_issue_cou¡
 = 0;

138 
i
 = 0; (ò< 
iq_size
Ë&& (
cuºít_issue_cou¡
 < 
max_issue_p‹ts
); ++i)

140 
iqe
 = &
iq
[
i
];

141 
e
 = 
iqe
->e;

143 i‡(
iqe
->
vÆid
 =
TRUE
)

146 i‡(
iqe
->
ªady
)

148 i‡(
	`issue_ö°ru˘i⁄
(
c‹e
, 
iqe
, 
e
))

150 
cuºít_issue_cou¡
++;

157 
	`ªad_öt_›î™d
(
c‹e
, 
e
->
ös
.
has_§c1
, &e->
ªad_rs1
,

158 
e
->
ös
.
rs1
,É->ös.
¥s1
,É->
rob_idx
,

159 &
e
->
ös
.
rs1_vÆ
,É);

160 
	`ªad_öt_›î™d
(
c‹e
, 
e
->
ös
.
has_§c2
, &e->
ªad_rs2
,

161 
e
->
ös
.
rs2
,É->ös.
¥s2
,É->
rob_idx
,

162 &
e
->
ös
.
rs2_vÆ
,É);

163 
	`ªad_Â_›î™d
(
c‹e
, 
e
->
ös
.
has_Â_§c1
, &e->
ªad_rs1
,

164 
e
->
ös
.
rs1
,É->ös.
¥s1
,É->
rob_idx
,

165 &
e
->
ös
.
rs1_vÆ
,É);

166 
	`ªad_Â_›î™d
(
c‹e
, 
e
->
ös
.
has_Â_§c2
, &e->
ªad_rs2
,

167 
e
->
ös
.
rs2
,É->ös.
¥s2
,É->
rob_idx
,

168 &
e
->
ös
.
rs2_vÆ
,É);

169 
	`ªad_Â_›î™d
(
c‹e
, 
e
->
ös
.
has_Â_§c3
, &e->
ªad_rs3
,

170 
e
->
ös
.
rs3
,É->ös.
¥s3
,É->
rob_idx
,

171 &
e
->
ös
.
rs3_vÆ
,É);

173 i‡(
e
->
ªad_rs1
 &&É->
ªad_rs2
 &&É->
ªad_rs3
)

175 
iqe
->
ªady
 = 
TRUE
;

180 i‡(
iqe
->
ªady
)

182 i‡(
	`issue_ö°ru˘i⁄
(
c‹e
, 
iqe
, 
e
))

184 
cuºít_issue_cou¡
++;

190 
	}
}

193 
	$oo_c‹e_issue
(
OOC‹e
 *
c‹e
)

195 
	`¥o˚ss_iq
(
c‹e
, c‹e->
iq
, c‹e->
sim˝u
->
∑øms
->
iq_size
,

196 
c‹e
->
sim˝u
->
∑øms
->
iq_issue_p‹ts
);

197 
	}
}

204 
CPUSège
 *

205 
	$gë_√xt_exec_°age
(
OOC‹e
 *
c‹e
, 
cur_°age_id
, 
fu_ty≥
)

207 
CPUSège
 *
°age
 = 
NULL
;

209 
fu_ty≥
)

211 
FU_ALU
:

213 
°age
 = &
c‹e
->
ülu
[
cur_°age_id
 + 1];

216 
FU_MUL
:

218 
°age
 = &
c‹e
->
imul
[
cur_°age_id
 + 1];

221 
FU_DIV
:

223 
°age
 = &
c‹e
->
idiv
[
cur_°age_id
 + 1];

226 
FU_FPU_FMA
:

228 
°age
 = &
c‹e
->
Âu_fma
[
cur_°age_id
 + 1];

232  
°age
;

233 
	}
}

236 
	$oo_c‹e_execuã_n⁄_pùe
(
OOC‹e
 *
c‹e
, 
fu_ty≥
, 
CPUSège
 *
°age
)

238 
IM≠E¡ry
 *
e
;

239 
RISCVCPUSèã
 *
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

241 i‡(
°age
->
has_d©a
)

243 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
°age
->
im≠_ödex
);

244 i‡(!
°age
->
°age_exec_d⁄e
)

246 
	`execuã_riscv_ö°ru˘i⁄
(&
e
->
ös
, &
s
->
fÊags
);

249 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
fu_ac˚ss
[
fu_ty≥
];

253 
e
->
cuºít_œãncy
 = 1;

254 
e
->
max_œãncy
 = 
	`£t_max_œãncy_f‹_n⁄_pùe_fu
(
s
, 
fu_ty≥
,É);

255 
	`as£π
(
e
->
max_œãncy
);

256 
°age
->
°age_exec_d⁄e
 = 
TRUE
;

261 i‡(
e
->
cuºít_œãncy
 =e->
max_œãncy
)

263 i‡(
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
)

266 
c‹e
->
lsq
.
íåõs
[
e
->
lsq_idx
].
ªady
 = 
TRUE
;

270 i‡(
e
->
ös
.
is_bønch
)

272 i‡(!
e
->
bønch_¥o˚s£d
)

274 
	`oo_¥o˚ss_bønch
(
c‹e
, 
e
);

278 i‡(
e
->
ös
.
has_de°
 ||É->ös.
has_Â_de°
)

280 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

285 
e
->
max_œãncy
 = 0;

286 
e
->
cuºít_œãncy
 = 0;

287 
	`˝u_°age_Êush
(
°age
);

291 
e
->
cuºít_œãncy
++;

294 
	}
}

297 
	$oo_c‹e_execuã_pùe
(
OOC‹e
 *
c‹e
, 
cur_°age_id
, 
fu_ty≥
, 
CPUSège
 *
°age
,

298 
max_œãncy
, 
max_°age_id
)

300 
IM≠E¡ry
 *
e
;

301 
CPUSège
 *
√xt
;

302 
RISCVCPUSèã
 *
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

304 i‡(
°age
->
has_d©a
)

306 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
°age
->
im≠_ödex
);

307 i‡(!
°age
->
°age_exec_d⁄e
)

309 
	`execuã_riscv_ö°ru˘i⁄
(&
e
->
ös
, &
s
->
fÊags
);

312 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
fu_ac˚ss
[
fu_ty≥
];

316 
e
->
cuºít_œãncy
 = 1;

317 
°age
->
°age_exec_d⁄e
 = 
TRUE
;

322 i‡(
e
->
cuºít_œãncy
 =
max_œãncy
)

325 i‡(
cur_°age_id
 =
max_°age_id
)

327 i‡(
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
)

330 
c‹e
->
lsq
.
íåõs
[
e
->
lsq_idx
].
ªady
 = 
TRUE
;

334 i‡(
e
->
ös
.
is_bønch
)

336 i‡(!
e
->
bønch_¥o˚s£d
)

338 
	`oo_¥o˚ss_bønch
(
c‹e
, 
e
);

342 i‡(
e
->
ös
.
has_de°
 ||É->ös.
has_Â_de°
)

344 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

349 
e
->
max_œãncy
 = 0;

350 
e
->
cuºít_œãncy
 = 0;

351 
	`˝u_°age_Êush
(
°age
);

356 
√xt
 = 
	`gë_√xt_exec_°age
(
c‹e
, 
cur_°age_id
, 
fu_ty≥
);

357 i‡(!
√xt
->
has_d©a
)

359 
e
->
cuºít_œãncy
 = 1;

360 *
√xt
 = *
°age
;

361 
	`˝u_°age_Êush
(
°age
);

367 
e
->
cuºít_œãncy
++;

370 
	}
}

373 
	$oo_c‹e_execuã_Æl
(
OOC‹e
 *
c‹e
)

375 
i
;

377 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
 - 1; i >= 0; i--)

379 
	`oo_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_FPU_FMA
, &c‹e->
Âu_fma
[i],

380 
c‹e
->
sim˝u
->
∑øms
->
Âu_fma_°age_œãncy
[
i
],

381 
c‹e
->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
 - 1);

383 
	`oo_c‹e_execuã_n⁄_pùe
(
c‹e
, 
FU_FPU_ALU
, &c‹e->
Âu_Æu
);

384 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_div_°ages
 - 1; i >= 0; i--)

386 
	`oo_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_DIV
, &c‹e->
idiv
[i],

387 
c‹e
->
sim˝u
->
∑øms
->
div_°age_œãncy
[
i
],

388 
c‹e
->
sim˝u
->
∑øms
->
num_div_°ages
 - 1);

390 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_mul_°ages
 - 1; i >= 0; i--)

392 
	`oo_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_MUL
, &c‹e->
imul
[i],

393 
c‹e
->
sim˝u
->
∑øms
->
mul_°age_œãncy
[
i
],

394 
c‹e
->
sim˝u
->
∑øms
->
num_mul_°ages
 - 1);

396 
i
 = 
c‹e
->
sim˝u
->
∑øms
->
num_Æu_°ages
 - 1; i >= 0; i--)

398 
	`oo_c‹e_execuã_pùe
(
c‹e
, 
i
, 
FU_ALU
, &c‹e->
ülu
[i],

399 
c‹e
->
sim˝u
->
∑øms
->
Æu_°age_œãncy
[
i
],

400 
c‹e
->
sim˝u
->
∑øms
->
num_Æu_°ages
 - 1);

402 
	}
}

411 
	$rob_ˇn_commô
(
ROB
 *
rob
)

413 i‡(!
	`cq_em±y
(&
rob
->
cq
Ë&& (rob->
íåõs
[
	`cq_‰⁄t
(&rob->cq)].
ªady
))

415  
TRUE
;

418  
FALSE
;

419 
	}
}

422 
	$oo_c‹e_rob_commô
(
OOC‹e
 *
c‹e
)

424 
IM≠E¡ry
 *
e
;

425 
ROBE¡ry
 *
rbe
;

426 
RISCVCPUSèã
 *
s
;

427 
commôs
 = 0;

429 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

430 
	`rob_ˇn_commô
(&
c‹e
->
rob
))

432 
rbe
 = &
c‹e
->
rob
.
íåõs
[
	`cq_‰⁄t
(&c‹e->rob.
cq
)];

433 
e
 = 
rbe
->e;

434 
	`as£π
(
rbe
->
ªady
);

435 i‡(
e
->
ös
.
ex˚±i⁄
)

437 
	`£t_ex˚±i⁄_°©e
(
s
, 
e
);

442 i‡(
e
->
ös
.
has_de°
)

444 i‡(
e
->
ös
.
rd
)

446 
	`upd©e_¨ch_ªg_öt
(
s
, 
e
);

448 i‡(
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
rob_idx
 ==É->rob_idx)

450 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
FALSE
;

451 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
rob_idx
 = -1;

455 i‡(
e
->
ös
.
has_Â_de°
)

457 
	`upd©e_¨ch_ªg_Â
(
s
, 
e
);

459 i‡(
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
rob_idx
 ==É->rob_idx)

461 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
FALSE
;

462 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
rob_idx
 = -1;

466 
	`upd©e_ö¢_commô_°©s
(
s
, 
e
);

469 i‡(
s
->
sim˝u
->
∑øms
->
do_sim_åa˚
)

471 
	`£tup_sim_åa˚_pkt
(
s
, 
e
);

474 i‡(
s
->
sim_∑øms
->
íabÀ_°©s_di•œy
)

476 
	`wrôe_°©s_to_°©s_di•œy_shm
(
s
);

480 
e
->
°©us
 = 
IMAP_ENTRY_STATUS_FREE
;

484 
rbe
->
ªady
 = 
FALSE
;

487 
	`cq_dequeue
(&
c‹e
->
rob
.
cq
);

490 i‡((--
s
->
sim_n_cy˛es
) == 0)

492 
	`£t_timî_ex˚±i⁄_°©e
(
s
, 
e
);

496 
commôs
++;

497 i‡(
commôs
 =
c‹e
->
sim˝u
->
∑øms
->
rob_commô_p‹ts
)

505 
	}
}

	@riscvsim/ooo_branch.c

27 
	~"ooo.h
"

28 
	~"../riscv_˝u_¥iv.h
"

29 
	~"cúcuœr_queue.h
"

30 
	~"riscv_ös_execuã_lib.h
"

31 
	~"riscv_sim_˝u.h
"

34 
	$ª°‹e_˝u_‰⁄ãnd
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

36 
RISCVCPUSèã
 *
s
;

38 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

41 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
„tch
, 
s
->
sim˝u
->
im≠
);

42 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
decode
, 
s
->
sim˝u
->
im≠
);

43 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
di•©ch
, 
s
->
sim˝u
->
im≠
);

46 
	`mem_c⁄åﬁÀr_Êush_°age_mem_ac˚ss_queue
(

47 &
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue
);

51 
s
->
code_±r
 = 
NULL
;

52 
s
->
code_íd
 = 
NULL
;

53 
s
->
code_to_pc_addíd
 = 
e
->
bønch_èrgë
;

54 
c‹e
->
„tch
.
has_d©a
 = 
TRUE
;

55 
	}
}

58 
	$rob_íåy_commôãd_a·î_rﬁlback
(
ROB
 *
rob
, 
§c_idx
)

60 i‡(
rob
->
cq
.
ª¨
 >rob->cq.
‰⁄t
)

62 i‡((
§c_idx
 >
rob
->
cq
.
‰⁄t
Ë&& (§c_idx <rob->cq.
ª¨
))

64  
FALSE
;

69 i‡(((
§c_idx
 >
rob
->
cq
.
‰⁄t
Ë&& (§c_idx <Ñob->cq.
max_size
))

70 || ((
§c_idx
 >0Ë&& (§c_idx <
rob
->
cq
.
ª¨
)))

72  
FALSE
;

75  
TRUE
;

76 
	}
}

79 
	$ª°‹e_rob_íåy
(
OOC‹e
 *
c‹e
, 
ROBE¡ry
 *
rbe
, 
uöt64_t
 
èg
)

81 
IM≠E¡ry
 *
e
;

83 
e
 = 
rbe
->e;

84 i‡(
e
->
ös_di•©ch_id
 > 
èg
)

86 i‡(
e
->
ös
.
has_de°
 &&É->ös.
rd
)

88 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
rob_idx
 =É->ös.
ﬁd_pde°
;

89 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
TRUE
;

90 i‡(
e
->
ös
.
ﬁd_pde°
 == -1)

92 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
FALSE
;

94 
	`as£π
(
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
rob_idx
 !=É->rob_idx);

96 i‡(
e
->
ös
.
has_Â_de°
)

98 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
rob_idx
 =É->ös.
ﬁd_pde°
;

99 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
TRUE
;

100 i‡(
e
->
ös
.
ﬁd_pde°
 == -1)

102 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
FALSE
;

104 
	`as£π
(
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
rob_idx
 !=É->rob_idx);

107 
e
->
°©us
 = 
IMAP_ENTRY_STATUS_FREE
;

109 
	}
}

113 
	$ª°‹e_rob
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
, 
uöt64_t
 
èg
)

115 
i
;

117 i‡(
c‹e
->
rob
.
cq
.
ª¨
 >c‹e->rob.cq.
‰⁄t
)

119 
i
 = 
c‹e
->
rob
.
cq
.
ª¨
; i >c‹e->rob.cq.
‰⁄t
; i--)

121 
	`ª°‹e_rob_íåy
(
c‹e
, &c‹e->
rob
.
íåõs
[
i
], 
èg
);

127 
i
 = 
c‹e
->
rob
.
cq
.
ª¨
; i >= 0; i--)

129 
	`ª°‹e_rob_íåy
(
c‹e
, &c‹e->
rob
.
íåõs
[
i
], 
èg
);

132 
i
 = 
c‹e
->
rob
.
cq
.
max_size
 - 1; i >c‹e->rob.cq.
‰⁄t
; i--)

134 
	`ª°‹e_rob_íåy
(
c‹e
, &c‹e->
rob
.
íåõs
[
i
], 
èg
);

139 
	`cq_£t_ª¨
(&
c‹e
->
rob
.
cq
, 
e
->
rob_idx
);

140 
	`as£π
(
e
 =
c‹e
->
rob
.
íåõs
[c‹e->rob.
cq
.
ª¨
].e);

141 
	}
}

144 
	$ª°‹e_iq
(
IssueQueueE¡ry
 *
iq
, 
size
, 
uöt64_t
 
èg
)

146 
i
;

148 
i
 = 0; i < 
size
; ++i)

150 i‡(
iq
[
i
].
vÆid
 && (iq[i].
e
->
ös_di•©ch_id
 > 
èg
))

152 
iq
[
i
].
vÆid
 = 
FALSE
;

155 
	}
}

158 
	$ª°‹e_fu
(
CPUSège
 *
fu
, 
°ages
, 
uöt64_t
 
èg
, 
IM≠E¡ry
 *
im≠
)

160 
i
;

161 
IM≠E¡ry
 *
e
;

163 
i
 = 0; i < 
°ages
; ++i)

165 i‡(
fu
[
i
].
has_d©a
)

167 
e
 = &
im≠
[
fu
[
i
].
im≠_ödex
];

168 i‡(
e
->
ös_di•©ch_id
 > 
èg
)

170 
	`•ecuœtive_˝u_°age_Êush
(&
fu
[
i
], 
im≠
);

174 
	}
}

177 
	$ª°‹e_lsu
(
OOC‹e
 *
c‹e
, 
uöt64_t
 
èg
)

179 
IM≠E¡ry
 *
e
;

181 i‡(
c‹e
->
lsu
.
has_d©a
)

183 
e
 = &
c‹e
->
sim˝u
->
im≠
[c‹e->
lsu
.
im≠_ödex
];

184 i‡(
e
->
ös_di•©ch_id
 > 
èg
)

186 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
lsu
, c‹e->
sim˝u
->
im≠
);

189 
	`mem_c⁄åﬁÀr_ª£t
(
c‹e
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
);

192 
	}
}

195 
	$is_lsq_íåy_•ecuœãd
(
LSQE¡ry
 *
lsqe
, 
uöt64_t
 
èg
)

197 i‡(
lsqe
->
e
->
ös_di•©ch_id
 > 
èg
)

199  
TRUE
;

201  
FALSE
;

202 
	}
}

205 
	$ª°‹e_lsq
(
OOC‹e
 *
c‹e
, 
uöt64_t
 
èg
)

207 
i
;

208 
LSQE¡ry
 *
lsqe
;

210 i‡(!
	`cq_em±y
(&
c‹e
->
lsq
.
cq
))

212 
lsqe
 = &
c‹e
->
lsq
.
íåõs
[
	`cq_‰⁄t
(&c‹e->lsq.
cq
)];

215 i‡(
lsqe
->
e
->
ös_di•©ch_id
 > 
èg
)

219 
	`cq_ª£t
(&
c‹e
->
lsq
.
cq
);

223 i‡(
c‹e
->
lsq
.
cq
.
ª¨
 >c‹e->lsq.cq.
‰⁄t
)

225 
i
 = 
c‹e
->
lsq
.
cq
.
‰⁄t
; i <c‹e->lsq.cq.
ª¨
; i++)

227 i‡(
	`is_lsq_íåy_•ecuœãd
(&
c‹e
->
lsq
.
íåõs
[
i
], 
èg
))

229 
	`cq_£t_ª¨
(&
c‹e
->
lsq
.
cq
, 
i
 - 1);

237 
i
 = 
c‹e
->
lsq
.
cq
.
‰⁄t
; i < c‹e->lsq.cq.
max_size
; i++)

239 i‡(
	`is_lsq_íåy_•ecuœãd
(&
c‹e
->
lsq
.
íåõs
[
i
], 
èg
))

241 
	`cq_£t_ª¨
(&
c‹e
->
lsq
.
cq
, 
i
 - 1);

246 
i
 = 0; i <
c‹e
->
lsq
.
cq
.
ª¨
; i++)

248 i‡(
	`is_lsq_íåy_•ecuœãd
(&
c‹e
->
lsq
.
íåõs
[
i
], 
èg
))

250 i‡(
i
 == 0)

252 
	`cq_£t_ª¨
(&
c‹e
->
lsq
.
cq
,

253 
c‹e
->
lsq
.
cq
.
max_size
 - 1);

257 
	`cq_£t_ª¨
(&
c‹e
->
lsq
.
cq
, 
i
 - 1);

265 
	}
}

270 
	$fix_ª«me_èbÀs
(
OOC‹e
 *
c‹e
, 
RíameTabÀE¡ry
 *
øt
, 
num_ªgs
)

272 
i
;

274 
i
 = 0; i < 
num_ªgs
; ++i)

276 i‡(
øt
[
i
].
ªad_‰om_rob
)

278 
	`as£π
(
øt
[
i
].
rob_idx
 != -1);

279 i‡(
	`rob_íåy_commôãd_a·î_rﬁlback
(&
c‹e
->
rob
, 
øt
[
i
].
rob_idx
))

281 
øt
[
i
].
rob_idx
 = -1;

282 
øt
[
i
].
ªad_‰om_rob
 = 
FALSE
;

286 
	}
}

289 
	$ªÆloˇã_a˘ive_im≠_íåõs
(
OOC‹e
 *
c‹e
)

291 
i
;

294 i‡(
c‹e
->
rob
.
cq
.
ª¨
 >c‹e->rob.cq.
‰⁄t
)

296 
i
 = 
c‹e
->
rob
.
cq
.
‰⁄t
; i <c‹e->rob.cq.
ª¨
; ++i)

298 
c‹e
->
rob
.
íåõs
[
i
].
e
->
°©us
 = 
IMAP_ENTRY_STATUS_ALLOCATED
;

303 
i
 = 
c‹e
->
rob
.
cq
.
‰⁄t
; i < c‹e->rob.cq.
max_size
; ++i)

305 
c‹e
->
rob
.
íåõs
[
i
].
e
->
°©us
 = 
IMAP_ENTRY_STATUS_ALLOCATED
;

307 
i
 = 0; i <
c‹e
->
rob
.
cq
.
ª¨
; ++i)

309 
c‹e
->
rob
.
íåõs
[
i
].
e
->
°©us
 = 
IMAP_ENTRY_STATUS_ALLOCATED
;

312 
	}
}

315 
	$rﬁlback_•ecuœãd_˝u_°©e
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

317 
	`ª°‹e_˝u_‰⁄ãnd
(
c‹e
, 
e
);

318 
	`ª°‹e_rob
(
c‹e
, 
e
,É->
ös_di•©ch_id
);

319 
	`ª°‹e_iq
(
c‹e
->
iq
, c‹e->
sim˝u
->
∑øms
->
iq_size
, 
e
->
ös_di•©ch_id
);

320 
	`ª°‹e_fu
(
c‹e
->
ülu
, c‹e->
sim˝u
->
∑øms
->
num_Æu_°ages
,

321 
e
->
ös_di•©ch_id
, 
c‹e
->
sim˝u
->
im≠
);

322 
	`ª°‹e_fu
(
c‹e
->
imul
, c‹e->
sim˝u
->
∑øms
->
num_mul_°ages
,

323 
e
->
ös_di•©ch_id
, 
c‹e
->
sim˝u
->
im≠
);

324 
	`ª°‹e_fu
(
c‹e
->
idiv
, c‹e->
sim˝u
->
∑øms
->
num_div_°ages
,

325 
e
->
ös_di•©ch_id
, 
c‹e
->
sim˝u
->
im≠
);

326 
	`ª°‹e_fu
(&
c‹e
->
Âu_Æu
, 1, 
e
->
ös_di•©ch_id
, c‹e->
sim˝u
->
im≠
);

327 
	`ª°‹e_fu
(
c‹e
->
Âu_fma
, c‹e->
sim˝u
->
∑øms
->
num_Âu_fma_°ages
,

328 
e
->
ös_di•©ch_id
, 
c‹e
->
sim˝u
->
im≠
);

329 
	`ª°‹e_lsq
(
c‹e
, 
e
->
ös_di•©ch_id
);

330 
	`ª°‹e_lsu
(
c‹e
, 
e
->
ös_di•©ch_id
);

331 
	`fix_ª«me_èbÀs
(
c‹e
, c‹e->
öt_øt
, 
NUM_INT_REG
);

332 
	`fix_ª«me_èbÀs
(
c‹e
, c‹e->
Â_øt
, 
NUM_FP_REG
);

333 
	`ª£t_im≠
(
c‹e
->
sim˝u
->
im≠
);

334 
	`ªÆloˇã_a˘ive_im≠_íåõs
(
c‹e
);

335 
	}
}

338 
	$oo_¥o˚ss_bønch
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

340 
e
->
mi•ªdi˘


341 
c‹e
->
sim˝u
->
	`p‚_bønch_h™dÀr
(c‹e->sim˝u->
emu_˝u_°©e
, 
e
);

343 i‡(
e
->
mi•ªdi˘
)

345 
	`rﬁlback_•ecuœãd_˝u_°©e
(
c‹e
, 
e
);

348 
e
->
ös
.
bønch_ty≥
)

350 
BRANCH_COND
:

352 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

355 
BRANCH_UNCOND
:

357 i‡(!
e
->
ös
.
has_de°
)

359 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

365 
e
->
bønch_¥o˚s£d
 = 
TRUE
;

366 
	}
}

	@riscvsim/ooo_frontend.c

27 
	~"ooo.h
"

28 
	~"../riscv_˝u_¥iv.h
"

29 
	~"cúcuœr_queue.h
"

30 
	~"riscv_iß_decodî_lib.h
"

31 
	~"riscv_sim_˝u.h
"

38 
	$oo_c‹e_„tch
(
OOC‹e
 *
c‹e
)

40 
IM≠E¡ry
 *
e
;

41 
RISCVCPUSèã
 *
s
;

43 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

44 i‡(
c‹e
->
„tch
.
has_d©a
)

46 i‡(!
c‹e
->
„tch
.
°age_exec_d⁄e
)

49 
s
->
sim˝u
->
pc


50 (
èrgë_ul⁄g
)((
uöçå_t
)
s
->
code_±r
 + s->
code_to_pc_addíd
);

52 
e
 = 
	`Æloˇã_im≠_íåy
(
s
->
sim˝u
->
im≠
);

55 
e
->
ös
.
pc
 = 
s
->
sim˝u
->pc;

56 
e
->
ös
.
¸óã_°r
 = 
s
->
sim_∑øms
->
¸óã_ös_°r
;

61 
c‹e
->
„tch
.
im≠_ödex
 = 
e
->imap_index;

63 
	`do_„tch_°age_exec
(
s
, 
e
);

64 
c‹e
->
„tch
.
°age_exec_d⁄e
 = 
TRUE
;

68 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
„tch
.
im≠_ödex
);

71 i‡(
e
->
cuºít_œãncy
 =e->
max_œãncy
)

78 i‡(!
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue


79 .
cur_size
)

83 i‡(!
c‹e
->
decode
.
has_d©a
)

85 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
‰⁄ãnd_mem_ac˚ss_queue


86 .
cur_idx


89 
c‹e
->
„tch
.
°age_exec_d⁄e
 = 
FALSE
;

90 
e
->
max_œãncy
 = 0;

91 
e
->
cuºít_œãncy
 = 0;

92 
c‹e
->
decode
 = c‹e->
„tch
;

93 
c‹e
->
„tch
.
im≠_ödex
 = -1;

96 i‡(
e
->
ös
.
ex˚±i⁄
)

98 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

104 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
ö¢_mem_dñay
;

109 
e
->
cuºít_œãncy
++;

112 
	}
}

121 
	$oo_c‹e_decode
(
OOC‹e
 *
c‹e
)

123 
IM≠E¡ry
 *
e
;

124 
RISCVCPUSèã
 *
s
;

126 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

127 i‡(
c‹e
->
decode
.
has_d©a
)

129 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
decode
.
im≠_ödex
);

131 i‡(!
c‹e
->
decode
.
°age_exec_d⁄e
)

133 i‡(!
e
->
ös
.
ex˚±i⁄
 && !e->
is_decoded
)

135 
	`do_decode_°age_exec
(
s
, 
e
);

136 i‡(
s
->
sim˝u
->
	`p‚_bønch_‰⁄ãnd_decode_h™dÀr
(s, 
e
))

138 
	`•ecuœtive_˝u_°age_Êush
(&
c‹e
->
„tch
, 
s
->
sim˝u
->
im≠
);

139 
c‹e
->
„tch
.
has_d©a
 = 
TRUE
;

141 
e
->
is_decoded
 = 
TRUE
;

145 i‡(
	`u∆ikñy
(
e
->
ös
.
ex˚±i⁄
))

147 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

150 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
TRUE
;

153 i‡(!
c‹e
->
di•©ch
.
has_d©a
)

155 
c‹e
->
decode
.
°age_exec_d⁄e
 = 
FALSE
;

156 
c‹e
->
di•©ch
 = c‹e->
decode
;

157 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

160 
	}
}

169 
	$rob_íåy_¸óã
(
ROB
 *
rob
, 
IM≠E¡ry
 *
e
, 
rob_íåy_°©us
)

171 
rob_idx
;

173 
rob_idx
 = 
	`cq_íqueue
(&
rob
->
cq
);

174 
e
->
rob_idx
 =Ñob_idx;

175 
rob
->
íåõs
[
rob_idx
].
ªady
 = 
rob_íåy_°©us
;

176 
rob
->
íåõs
[
rob_idx
].
e
 =É;

177 
	}
}

180 
	$iq_íåy_¸óã
(
IssueQueueE¡ry
 *
iq
, 
iq_size
, 
IM≠E¡ry
 *
e
)

182 
iq_idx
;

184 
iq_idx
 = 
	`iq_gë_‰ì_íåy
(
iq
, 
iq_size
);

185 
e
->
iq_idx
 = iq_idx;

186 
iq
[
iq_idx
].
vÆid
 = 
TRUE
;

187 
iq
[
iq_idx
].
ªady
 = 
FALSE
;

188 
iq
[
iq_idx
].
e
 =É;

189 
	}
}

192 
	$lsq_íåy_¸óã
(
LSQ
 *
lsq
, 
IM≠E¡ry
 *
e
)

194 
lsq_idx
;

196 
lsq_idx
 = 
	`cq_íqueue
(&
lsq
->
cq
);

197 
e
->
lsq_idx
 =Üsq_idx;

198 
lsq
->
íåõs
[
lsq_idx
].
ªady
 = 
FALSE
;

199 
lsq
->
íåõs
[
lsq_idx
].
mem_ªque°_£¡
 = 
FALSE
;

200 
lsq
->
íåõs
[
lsq_idx
].
mem_ªque°_com∂ëe
 = 
FALSE
;

201 
lsq
->
íåõs
[
lsq_idx
].
e
 =É;

202 
	}
}

205 
	$upd©e_rd_øt_m≠pög
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

208 i‡(
e
->
ös
.
has_de°
)

210 i‡(
e
->
ös
.
rd
)

212 
e
->
ös
.
ﬁd_pde°
 = 
c‹e
->
öt_øt
[e->ös.
rd
].
rob_idx
;

213 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
TRUE
;

214 
c‹e
->
öt_øt
[
e
->
ös
.
rd
].
rob_idx
 =É->rob_idx;

215 
	`as£π
(
e
->
ös
.
ﬁd_pde°
 !
c‹e
->
öt_øt
[e->ös.
rd
].
rob_idx
);

218 i‡(
e
->
ös
.
has_Â_de°
)

220 
e
->
ös
.
ﬁd_pde°
 = 
c‹e
->
Â_øt
[e->ös.
rd
].
rob_idx
;

221 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
ªad_‰om_rob
 = 
TRUE
;

222 
c‹e
->
Â_øt
[
e
->
ös
.
rd
].
rob_idx
 =É->rob_idx;

223 
	`as£π
(
e
->
ös
.
ﬁd_pde°
 !
c‹e
->
Â_øt
[e->ös.
rd
].
rob_idx
);

225 
	}
}

228 
	$°Æl_ö¢_di•©ch
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

232 i‡(
e
->
ös
.
is_©omic
 && !
	`cq_em±y
(&
c‹e
->
rob
.
cq
))

234  
TRUE
;

237 i‡(
	`cq_fuŒ
(&
c‹e
->
rob
.
cq
Ë|| 
	`iq_fuŒ
(c‹e->
iq
, c‹e->
sim˝u
->
∑øms
->
iq_size
)

238 || ((
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
)

239 && 
	`cq_fuŒ
(&
c‹e
->
lsq
.
cq
)))

241  
TRUE
;

245  
FALSE
;

246 
	}
}

249 
	$do_ö¢_ª«me_™d_ªad_ªg_fûe
(
OOC‹e
 *
c‹e
, 
IM≠E¡ry
 *
e
)

251 i‡(
e
->
ös
.
has_§c1
)

253 i‡(
c‹e
->
öt_øt
[
e
->
ös
.
rs1
].
ªad_‰om_rob
)

255 
e
->
ös
.
¥s1
 = 
c‹e
->
öt_øt
[e->ös.
rs1
].
rob_idx
;

256 
	`as£π
(
e
->
ös
.
¥s1
 != -1);

260 
e
->
ös
.
rs1_vÆ
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
ªg
[e->ös.
rs1
];

261 
e
->
ªad_rs1
 = 
TRUE
;

264 i‡(
e
->
ös
.
has_Â_§c1
)

266 i‡(
c‹e
->
Â_øt
[
e
->
ös
.
rs1
].
ªad_‰om_rob
)

268 
e
->
ös
.
¥s1
 = 
c‹e
->
Â_øt
[e->ös.
rs1
].
rob_idx
;

269 
	`as£π
(
e
->
ös
.
¥s1
 != -1);

273 
e
->
ös
.
rs1_vÆ
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
Â_ªg
[e->ös.
rs1
];

274 
e
->
ªad_rs1
 = 
TRUE
;

281 
e
->
ªad_rs1
 = 
TRUE
;

284 i‡(
e
->
ös
.
has_§c2
)

286 i‡(
c‹e
->
öt_øt
[
e
->
ös
.
rs2
].
ªad_‰om_rob
)

288 
e
->
ös
.
¥s2
 = 
c‹e
->
öt_øt
[e->ös.
rs2
].
rob_idx
;

289 
	`as£π
(
e
->
ös
.
¥s2
 != -1);

293 
e
->
ös
.
rs2_vÆ
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
ªg
[e->ös.
rs2
];

294 
e
->
ªad_rs2
 = 
TRUE
;

297 i‡(
e
->
ös
.
has_Â_§c2
)

299 i‡(
c‹e
->
Â_øt
[
e
->
ös
.
rs2
].
ªad_‰om_rob
)

301 
e
->
ös
.
¥s2
 = 
c‹e
->
Â_øt
[e->ös.
rs2
].
rob_idx
;

302 
	`as£π
(
e
->
ös
.
¥s2
 != -1);

306 
e
->
ös
.
rs2_vÆ
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
Â_ªg
[e->ös.
rs2
];

307 
e
->
ªad_rs2
 = 
TRUE
;

312 
e
->
ªad_rs2
 = 
TRUE
;

316 i‡(
e
->
ös
.
has_Â_§c3
)

318 i‡(
c‹e
->
Â_øt
[
e
->
ös
.
rs3
].
ªad_‰om_rob
)

320 
e
->
ös
.
¥s3
 = 
c‹e
->
Â_øt
[e->ös.
rs3
].
rob_idx
;

321 
	`as£π
(
e
->
ös
.
¥s3
 != -1);

325 
e
->
ös
.
rs3_vÆ
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
->
Â_ªg
[e->ös.
rs3
];

326 
e
->
ªad_rs3
 = 
TRUE
;

331 
e
->
ªad_rs3
 = 
TRUE
;

333 
	}
}

336 
	$oo_c‹e_di•©ch
(
OOC‹e
 *
c‹e
)

338 
IM≠E¡ry
 *
e
;

339 
RISCVCPUSèã
 *
s
;

341 
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

342 i‡(
c‹e
->
di•©ch
.
has_d©a
)

344 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
di•©ch
.
im≠_ödex
);

345 i‡(!
c‹e
->
di•©ch
.
°age_exec_d⁄e
)

349 i‡(
e
->
ös
.
ex˚±i⁄
)

351 i‡(
	`cq_fuŒ
(&
c‹e
->
rob
.
cq
))

359 
	`rob_íåy_¸óã
(&
c‹e
->
rob
, 
e
, 
TRUE
);

363 i‡(
	`°Æl_ö¢_di•©ch
(
c‹e
, 
e
))

367 
	`do_ö¢_ª«me_™d_ªad_ªg_fûe
(
c‹e
, 
e
);

368 
	`rob_íåy_¸óã
(&
c‹e
->
rob
, 
e
, 
FALSE
);

369 
	`iq_íåy_¸óã
(
c‹e
->
iq
, 
s
->
sim˝u
->
∑øms
->
iq_size
, 
e
);

370 i‡(
e
->
ös
.
is_lﬂd
 ||É->ös.
is_°‹e
 ||É->ös.
is_©omic
)

372 
	`lsq_íåy_¸óã
(&
c‹e
->
lsq
, 
e
);

374 
	`upd©e_rd_øt_m≠pög
(
c‹e
, 
e
);

376 
e
->
ös_di•©ch_id
 = 
c‹e
->ins_dispatch_id++;

377 
	`˝u_°age_Êush
(&
c‹e
->
di•©ch
);

380 
	}
}

	@riscvsim/ooo_lsu.c

27 
	~"ooo.h
"

28 
	~"../riscv_˝u_¥iv.h
"

29 
	~"cúcuœr_queue.h
"

30 
	~"comm⁄_c‹e_utûs.h
"

31 
	~"riscv_sim_˝u.h
"

34 
	$oo_c‹e_lsu
(
OOC‹e
 *
c‹e
)

36 
IM≠E¡ry
 *
e
;

37 
RISCVCPUSèã
 *
s
 = 
c‹e
->
sim˝u
->
emu_˝u_°©e
;

39 i‡(
c‹e
->
lsu
.
has_d©a
)

41 
e
 = 
	`gë_im≠_íåy
(
s
->
sim˝u
->
im≠
, 
c‹e
->
lsu
.
im≠_ödex
);

42 i‡(!
c‹e
->
lsu
.
°age_exec_d⁄e
)

44 
s
->
hw_pg_tb_wlk_œãncy
 = 1;

45 
s
->
hw_pg_tb_wlk_°age_id
 = 
MEMORY
;

49 
e
->
cuºít_œãncy
 = 1;

51 i‡(
	`execuã_lﬂd_°‹e
(
s
, 
e
))

55 
e
->
ös
.
ex˚±i⁄
 = 
TRUE
;

56 
e
->
ös
.
ex˚±i⁄_ˇu£
 = 
SIM_MMU_EXCEPTION
;

60 
e
->
max_œãncy
 = 
s
->
hw_pg_tb_wlk_œãncy
;

66 
e
->
max_œãncy
 = 
s
->
hw_pg_tb_wlk_œãncy


67 + 
	`gë_d©a_mem_ac˚ss_œãncy
(
s
, 
e
);

69 i‡(
s
->
sim_∑øms
->
íabÀ_l1_ˇches
)

72 i‡(
e
->
ös
.
is_lﬂd
)

74 
e
->
max_œãncy


75 -
	`mö_öt
(
s
->
hw_pg_tb_wlk_œãncy
,

76 
s
->
sim˝u
->
mmu
->
dˇche
->
ªad_œãncy
);

78 i‡(
e
->
ös
.
is_°‹e
)

80 
e
->
max_œãncy


81 -
	`mö_öt
(
s
->
hw_pg_tb_wlk_œãncy
,

82 
s
->
sim˝u
->
mmu
->
dˇche
->
wrôe_œãncy
);

84 i‡(
e
->
ös
.
is_©omic
)

86 
e
->
max_œãncy
 -
	`mö_öt
(

87 
s
->
hw_pg_tb_wlk_œãncy
,

88 
	`mö_öt
(
s
->
sim˝u
->
mmu
->
dˇche
->
ªad_œãncy
,

89 
s
->
sim˝u
->
mmu
->
dˇche
->
wrôe_œãncy
));

93 
c‹e
->
lsu
.
°age_exec_d⁄e
 = 
TRUE
;

96 i‡(
e
->
cuºít_œãncy
 =e->
max_œãncy
)

100 i‡(!
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
backíd_mem_ac˚ss_queue
.
cur_size
)

102 
s
->
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
->
backíd_mem_ac˚ss_queue
.
cur_idx


104 
c‹e
->
lsq
.
íåõs
[
e
->
lsq_idx
].
mem_ªque°_com∂ëe
 = 
TRUE
;

105 
	`˝u_°age_Êush
(&
c‹e
->
lsu
);

109 ++
s
->
sim˝u
->
°©s
[s->
¥iv
].
d©a_mem_dñay
;

114 
e
->
cuºít_œãncy
++;

117 
	}
}

120 
	$¥o˚ss_lsq_íåy_lﬂd
(
OOC‹e
 *
c‹e
, 
LSQE¡ry
 *
lsqe
)

122 
IM≠E¡ry
 *
e
;

124 
e
 = 
lsqe
->e;

125 i‡(!
lsqe
->
mem_ªque°_£¡
)

127 i‡(!
c‹e
->
lsu
.
has_d©a
)

130 
c‹e
->
lsu
.
has_d©a
 = 
TRUE
;

131 
c‹e
->
lsu
.
°age_exec_d⁄e
 = 
FALSE
;

132 
c‹e
->
lsu
.
im≠_ödex
 = 
e
->imap_index;

133 
lsqe
->
mem_ªque°_£¡
 = 
TRUE
;

139 i‡(
lsqe
->
mem_ªque°_com∂ëe
)

141 i‡(
e
->
ös
.
ex˚±i⁄
)

144 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

147 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

148 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

149 
	`˝u_°age_Êush
(&
c‹e
->
di•©ch
);

153 i‡(
e
->
ös
.
has_de°
 ||É->ös.
has_Â_de°
)

155 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

158 
	`cq_dequeue
(&
c‹e
->
lsq
.
cq
);

161 
	}
}

164 
	$¥o˚ss_lsq_íåy_°‹e
(
OOC‹e
 *
c‹e
, 
LSQE¡ry
 *
lsqe
)

166 
IM≠E¡ry
 *
e
;

167 
ROBE¡ry
 *
rbe
;

169 
e
 = 
lsqe
->e;

172 
rbe
 = &
c‹e
->
rob
.
íåõs
[
	`cq_‰⁄t
(&c‹e->rob.
cq
)];

174 i‡(
rbe
->
e
->
ös
.
pc
 =
lsqe
->e->ins.pc)

176 i‡(!
lsqe
->
mem_ªque°_£¡
)

178 i‡(!
c‹e
->
lsu
.
has_d©a
)

181 
c‹e
->
lsu
.
has_d©a
 = 
TRUE
;

182 
c‹e
->
lsu
.
°age_exec_d⁄e
 = 
FALSE
;

183 
c‹e
->
lsu
.
im≠_ödex
 = 
e
->imap_index;

184 
lsqe
->
mem_ªque°_£¡
 = 
TRUE
;

191 i‡(
lsqe
->
mem_ªque°_com∂ëe
)

193 i‡(
e
->
ös
.
ex˚±i⁄
)

196 
	`˝u_°age_Êush
(&
c‹e
->
„tch
);

197 
	`˝u_°age_Êush
(&
c‹e
->
decode
);

198 
	`˝u_°age_Êush
(&
c‹e
->
di•©ch
);

202 
	`cq_dequeue
(&
c‹e
->
lsq
.
cq
);

205 
c‹e
->
rob
.
íåõs
[
e
->
rob_idx
].
ªady
 = 
TRUE
;

209 
	}
}

212 
	$oo_c‹e_lsq
(
OOC‹e
 *
c‹e
)

214 
IM≠E¡ry
 *
e
;

215 
LSQE¡ry
 *
lsqe
;

217 i‡(!
	`cq_em±y
(&
c‹e
->
lsq
.
cq
))

219 
lsqe
 = &
c‹e
->
lsq
.
íåõs
[
	`cq_‰⁄t
(&c‹e->lsq.
cq
)];

220 
e
 = 
lsqe
->e;

222 i‡(
lsqe
->
ªady
 =
TRUE
)

224 i‡(
e
->
ös
.
is_lﬂd
 ||É->ös.
is_©omic
)

226 
	`¥o˚ss_lsq_íåy_lﬂd
(
c‹e
, 
lsqe
);

228 i‡(
e
->
ös
.
is_°‹e
)

230 
	`¥o˚ss_lsq_íåy_°‹e
(
c‹e
, 
lsqe
);

234 
	}
}

	@riscvsim/ras.c

27 
	~<as£π.h
>

28 
	~<°dlib.h
>

30 
	~"øs.h
"

32 
Ras
 *

33 
	$øs_öô
(c⁄° 
SimP¨ams
 *
p
)

35 
Ras
 *
r
;

37 
r
 = 
	`ˇŒoc
(1, (
Ras
));

38 
	`as£π
(
r
);

40 
r
->
íåy
 = 
	`ˇŒoc
(
p
->
øs_size
, (
èrgë_ul⁄g
));

41 
	`as£π
(
r
->
íåy
);

43 
r
->
max_size
 = 
p
->
øs_size
;

44 
	`øs_Êush
(
r
);

45  
r
;

46 
	}
}

49 
	$øs_‰ì
(
Ras
 **
øs
)

51 
	`‰ì
((*
øs
)->
íåy
);

52 (*
øs
)->
íåy
 = 
NULL
;

54 
	`‰ì
(*
øs
);

55 *
øs
 = 
NULL
;

56 
	}
}

59 
	$øs_Êush
(
Ras
 *
øs
)

61 
øs
->
cur_size
 = 0;

62 
øs
->
•t›
 =Ñas->
max_size
 - 1;

63 
øs
->
•fûl
 = 0;

64 
øs
->
em±y_ªg
 = 0;

65 
	}
}

68 
	$øs_em±y
(
Ras
 *
øs
)

70  (!
øs
->
cur_size
);

71 
	}
}

74 
	$øs_push
(
Ras
 *
øs
, 
èrgë_ul⁄g
 
pc
)

76 
øs
->
íåy
[øs->
•fûl
] = 
pc
;

77 
øs
->
•t›
 =Ñas->
•fûl
;

78 
øs
->
•fûl
++;

79 
øs
->
cur_size
++;

82 i‡(
øs
->
•fûl
 >øs->
max_size
)

84 
øs
->
•fûl
 = 0;

86 
	}
}

88 
èrgë_ul⁄g


89 
	$øs_p›
(
Ras
 *
øs
)

91 
èrgë_ul⁄g
 
ªt_addr
;

93 i‡(
	`øs_em±y
(
øs
))

96  
øs
->
em±y_ªg
;

99 
ªt_addr
 = 
øs
->
íåy
[øs->
•t›
];

100 
øs
->
•fûl
 =Ñas->
•t›
;

101 
øs
->
•t›
--;

102 
øs
->
cur_size
--;

105 i‡(
øs
->
•t›
 < 0)

107 
øs
->
•t›
 =Ñas->
max_size
 - 1;

111 
øs
->
em±y_ªg
 = 
ªt_addr
;

112  
ªt_addr
;

113 
	}
}

	@riscvsim/ras.h

27 
	~"riscv_sim_ma¸os.h
"

28 
	~"riscv_sim_ty≥defs.h
"

29 
	~"sim_∑øms_°©s.h
"

31 
	sRas


33 
èrgë_ul⁄g
 *
	míåy
;

34 
	m•t›
;

35 
	m•fûl
;

36 
	mcur_size
;

37 
	mmax_size
;

38 
èrgë_ul⁄g
 
	mem±y_ªg
;

39 } 
	tRas
;

41 
Ras
 *
øs_öô
(c⁄° 
SimP¨ams
 *
p
);

42 
øs_push
(
Ras
 *
øs
, 
èrgë_ul⁄g
 
pc
);

43 
øs_Êush
(
Ras
 *
øs
);

44 
øs_‰ì
(
Ras
 **
øs
);

45 
èrgë_ul⁄g
 
øs_p›
(
Ras
 *
øs
);

46 
øs_em±y
(
Ras
 *
øs
);

	@riscvsim/riscv_ins_execute.c

32 
	~<°dio.h
>

33 
	~<°dlib.h
>

34 
	~<°rög.h
>

36 
	~"riscv_sim_ty≥defs.h
"

37 
	~"riscv_ö°ru˘i⁄.h
"

38 
	~"../riscv_˝u_¥iv.h
"

39 
	~"../so·Â.h
"

43 
	#xsimglue
(
x
, 
y
Ëx##
	)
y

44 
	#simglue
(
x
, 
y
Ë
	`xsimglue
(x, y)

	)

46 
ölöe
 
èrgë_l⁄g


47 
	$simglue
(
div
, 
BIT_SIZE
)(
èrgë_l⁄g
 
a
,Å¨gë_l⁄g 
b
)

49 i‡(
b
 == 0)

53 i‡(
a
 =((
èrgë_l⁄g
)1 << (
BIT_SIZE
 - 1)Ë&& 
b
 == -1)

55  
a
;

59  
a
 / 
b
;

61 
	}
}

63 
ölöe
 
èrgë_ul⁄g


64 
	$simglue
(
divu
, 
BIT_SIZE
)(
èrgë_ul⁄g
 
a
,Å¨gë_ul⁄g 
b
)

66 i‡(
b
 == 0)

72  
a
 / 
b
;

74 
	}
}

76 
ölöe
 
èrgë_l⁄g


77 
	$simglue
(
ªm
, 
BIT_SIZE
)(
èrgë_l⁄g
 
a
,Å¨gë_l⁄g 
b
)

79 i‡(
b
 == 0)

81  
a
;

83 i‡(
a
 =((
èrgë_l⁄g
)1 << (
BIT_SIZE
 - 1)Ë&& 
b
 == -1)

89  
a
 % 
b
;

91 
	}
}

93 
ölöe
 
èrgë_ul⁄g


94 
	$simglue
(
ªmu
, 
BIT_SIZE
)(
èrgë_ul⁄g
 
a
,Å¨gë_ul⁄g 
b
)

96 i‡(
b
 == 0)

98  
a
;

102  
a
 % 
b
;

104 
	}
}

106 #i‡
BIT_SIZE
 == 32

108 
ölöe
 
uöt32_t


109 
	$mulh32
(
öt32_t
 
a
, i¡32_à
b
)

111  ((
öt64_t
)
a
 * (öt64_t)
b
) >> 32;

112 
	}
}

114 
ölöe
 
uöt32_t


115 
	$mulhsu32
(
öt32_t
 
a
, 
uöt32_t
 
b
)

117  ((
öt64_t
)
a
 * (öt64_t)
b
) >> 32;

118 
	}
}

120 
ölöe
 
uöt32_t


121 
	$mulhu32
(
uöt32_t
 
a
, uöt32_à
b
)

123  ((
öt64_t
)
a
 * (öt64_t)
b
) >> 32;

124 
	}
}

126 #ñi‡
BIT_SIZE
 =64 && 
deföed
(
HAVE_INT128
)

128 
ölöe
 
uöt64_t


129 
	$mulh64
(
öt64_t
 
a
, i¡64_à
b
)

131  ((
öt128_t
)
a
 * (öt128_t)
b
) >> 64;

132 
	}
}

134 
ölöe
 
uöt64_t


135 
	$mulhsu64
(
öt64_t
 
a
, 
uöt64_t
 
b
)

137  ((
öt128_t
)
a
 * (öt128_t)
b
) >> 64;

138 
	}
}

140 
ölöe
 
uöt64_t


141 
	$mulhu64
(
uöt64_t
 
a
, uöt64_à
b
)

143  ((
öt128_t
)
a
 * (öt128_t)
b
) >> 64;

144 
	}
}

148 #i‡
BIT_SIZE
 == 64

149 
	#UHALF
 
uöt32_t


	)

150 
	#UHALF_LEN
 32

	)

151 #ñi‡
BIT_SIZE
 == 128

152 
	#UHALF
 
uöt64_t


	)

153 
	#UHALF_LEN
 64

	)

155 #îr‹ 
unsuµ‹ãd
 
BIT_SIZE


158 
èrgë_ul⁄g


159 
	$simglue
(
mulhu
, 
BIT_SIZE
)(
èrgë_ul⁄g
 
a
,Å¨gë_ul⁄g 
b
)

161 
UHALF
 
a0
, 
a1
, 
b0
, 
b1
, 
r2
, 
r3
;

162 
èrgë_ul⁄g
 
r00
, 
r01
, 
r10
, 
r11
, 
c
;

163 
a0
 = 
a
;

164 
a1
 = 
a
 >> 
UHALF_LEN
;

165 
b0
 = 
b
;

166 
b1
 = 
b
 >> 
UHALF_LEN
;

168 
r00
 = (
èrgë_ul⁄g
)
a0
 * (èrgë_ul⁄g)
b0
;

169 
r01
 = (
èrgë_ul⁄g
)
a0
 * (èrgë_ul⁄g)
b1
;

170 
r10
 = (
èrgë_ul⁄g
)
a1
 * (èrgë_ul⁄g)
b0
;

171 
r11
 = (
èrgë_ul⁄g
)
a1
 * (èrgë_ul⁄g)
b1
;

174 
c
 = (
r00
 >> 
UHALF_LEN
Ë+ (
UHALF
)
r01
 + (UHALF)
r10
;

176 
c
 = (¯>> 
UHALF_LEN
Ë+ (
r01
 >> UHALF_LENË+ (
r10
 >> UHALF_LENË+ (
UHALF
)
r11
;

177 
r2
 = 
c
;

178 
r3
 = (
c
 >> 
UHALF_LEN
Ë+ (
r11
 >> UHALF_LEN);

181  ((
èrgë_ul⁄g
)
r3
 << 
UHALF_LEN
Ë| 
r2
;

182 
	}
}

184 #unde‡
UHALF


186 
ölöe
 
èrgë_ul⁄g


187 
	$simglue
(
mulh
, 
BIT_SIZE
)(
èrgë_l⁄g
 
a
,Å¨gë_l⁄g 
b
)

189 
èrgë_ul⁄g
 
r1
;

190 
r1
 = 
	`simglue
(
mulhu
, 
BIT_SIZE
)(
a
, 
b
);

191 i‡(
a
 < 0)

192 
r1
 -
a
;

193 i‡(
b
 < 0)

194 
r1
 -
b
;

195  
r1
;

196 
	}
}

198 
ölöe
 
èrgë_ul⁄g


199 
	$simglue
(
mulhsu
, 
BIT_SIZE
)(
èrgë_l⁄g
 
a
, 
èrgë_ul⁄g
 
b
)

201 
èrgë_ul⁄g
 
r1
;

202 
r1
 = 
	`simglue
(
mulhu
, 
BIT_SIZE
)(
a
, 
b
);

203 i‡(
a
 < 0)

204 
r1
 -
a
;

205  
r1
;

206 
	}
}

210 
	$execuã_›_imm
(
RVIn°ru˘i⁄
 *
i
)

212 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

213 
uöt32_t
 
fun˘3
 = (
ö¢
 >> 12) & 7;

215 
fun˘3
)

218 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

221 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 << (i->
imm
 & (
BIT_SIZE
 - 1)));

224 
i
->
buf„r
 = (
èrgë_l⁄g
)i->
rs1_vÆ
 < (èrgë_l⁄g)i->
imm
;

227 
i
->
buf„r
 = i->
rs1_vÆ
 < (
èrgë_ul⁄g
)i->
imm
;

230 
i
->
buf„r
 = i->
rs1_vÆ
 ^ i->
imm
;

233 i‡(
i
->
imm
 & 0x400)

234 
i
->
buf„r


235 (
èrgë_l⁄g
)
i
->
rs1_vÆ
 >> (i->
imm
 & (
BIT_SIZE
 - 1));

237 
i
->
buf„r
 = (
èrgë_l⁄g
)((
èrgë_ul⁄g
)i->
rs1_vÆ


238 >> (
i
->
imm
 & (
BIT_SIZE
 - 1)));

241 
i
->
buf„r
 = i->
rs1_vÆ
 | i->
imm
;

244 
i
->
buf„r
 = i->
rs1_vÆ
 & i->
imm
;

248 
	}
}

251 
	$execuã_›_imm_32
(
RVIn°ru˘i⁄
 *
i
)

253 
uöt32_t
 
fun˘3
 = (
i
->
bö¨y
 >> 12) & 7;

255 
fun˘3
)

258 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 + i->
imm
);

261 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 << (i->
imm
 & 31));

264 i‡(
i
->
imm
 & 0x400)

265 
i
->
buf„r
 = (
öt32_t
)i->
rs1_vÆ
 >> (i->
imm
 & 31);

267 
i
->
buf„r
 = (
öt32_t
)((
uöt32_t
)i->
rs1_vÆ
 >> (i->
imm
 & 31));

271 
	}
}

274 
	$execuã_›
(
RVIn°ru˘i⁄
 *
i
)

276 
uöt32_t
 
fun˘3
;

277 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

278 
öt32_t
 
imm
 = 
ö¢
 >> 25;

280 i‡(
imm
 == 1)

282 
fun˘3
 = (
ö¢
 >> 12) & 7;

283 
fun˘3
)

286 
i
->
buf„r
 = (
èrgë_l⁄g
)(—¨gë_l⁄g)i->
rs1_vÆ


287 * (
èrgë_l⁄g
)
i
->
rs2_vÆ
);

290 
i
->
buf„r
 = (
èrgë_l⁄g
)
	`simglue
(
mulh
, 
BIT_SIZE
)(i->
rs1_vÆ
,

291 
i
->
rs2_vÆ
);

294 
i
->
buf„r
 = (
èrgë_l⁄g
)
	`simglue
(
mulhsu
, 
BIT_SIZE
)(i->
rs1_vÆ
,

295 
i
->
rs2_vÆ
);

298 
i
->
buf„r
 = (
èrgë_l⁄g
)
	`simglue
(
mulhu
, 
BIT_SIZE
)(i->
rs1_vÆ
,

299 
i
->
rs2_vÆ
);

302 
i
->
buf„r
 = 
	`simglue
(
div
, 
BIT_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
);

305 
i
->
buf„r
 = (
èrgë_l⁄g
)
	`simglue
(
divu
, 
BIT_SIZE
)(i->
rs1_vÆ
,

306 
i
->
rs2_vÆ
);

309 
i
->
buf„r
 = 
	`simglue
(
ªm
, 
BIT_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
);

312 
i
->
buf„r
 = (
èrgë_l⁄g
)
	`simglue
(
ªmu
, 
BIT_SIZE
)(i->
rs1_vÆ
,

313 
i
->
rs2_vÆ
);

319 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

320 
fun˘3
)

323 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
rs2_vÆ
);

326 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 - i->
rs2_vÆ
);

329 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ


330 << (
i
->
rs2_vÆ
 & (
BIT_SIZE
 - 1)));

333 
i
->
buf„r
 = (
èrgë_l⁄g
)i->
rs1_vÆ
 < (èrgë_l⁄g)i->
rs2_vÆ
;

336 
i
->
buf„r
 = i->
rs1_vÆ
 < i->
rs2_vÆ
;

339 
i
->
buf„r
 = i->
rs1_vÆ
 ^ i->
rs2_vÆ
;

342 
i
->
buf„r
 = (
èrgë_l⁄g
)((
èrgë_ul⁄g
)i->
rs1_vÆ


343 >> (
i
->
rs2_vÆ
 & (
BIT_SIZE
 - 1)));

346 
i
->
buf„r


347 (
èrgë_l⁄g
)
i
->
rs1_vÆ
 >> (i->
rs2_vÆ
 & (
BIT_SIZE
 - 1));

350 
i
->
buf„r
 = i->
rs1_vÆ
 | i->
rs2_vÆ
;

353 
i
->
buf„r
 = i->
rs1_vÆ
 & i->
rs2_vÆ
;

358 
	}
}

361 
	$execuã_›_32
(
RVIn°ru˘i⁄
 *
i
)

363 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

364 
öt32_t
 
imm
 = 
ö¢
 >> 25;

365 
uöt32_t
 
fun˘3
;

367 i‡(
imm
 == 1)

369 
fun˘3
 = (
ö¢
 >> 12) & 7;

370 
fun˘3
)

373 
i
->
buf„r


374 (
öt32_t
)((öt32_t)
i
->
rs1_vÆ
 * (öt32_t)i->
rs2_vÆ
);

377 
i
->
buf„r
 = 
	`simglue
(
div
, 
BIT_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
);

380 
i
->
buf„r


381 (
öt32_t
)
	`simglue
(
divu
, 
BIT_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
);

384 
i
->
buf„r
 = 
	`simglue
(
ªm
, 
BIT_SIZE
)(i->
rs1_vÆ
, i->
rs2_vÆ
);

387 
i
->
buf„r


388 (
öt32_t
)
	`simglue
(
ªmu
, 
BIT_SIZE
)(
i
->
rs1_vÆ
, i->
rs2_vÆ
);

394 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

395 
fun˘3
)

398 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 + i->
rs2_vÆ
);

401 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 - i->
rs2_vÆ
);

404 
i
->
buf„r


405 (
öt32_t
)((
uöt32_t
)
i
->
rs1_vÆ
 << (i->
rs2_vÆ
 & 31));

408 
i
->
buf„r


409 (
öt32_t
)((
uöt32_t
)
i
->
rs1_vÆ
 >> (i->
rs2_vÆ
 & 31));

412 
i
->
buf„r
 = (
öt32_t
)i->
rs1_vÆ
 >> (i->
rs2_vÆ
 & 31);

417 
	}
}

420 
	$execuã_ty≥_b
(
RVIn°ru˘i⁄
 *
i
)

422 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

423 
uöt32_t
 
fun˘3
 = (
ö¢
 >> 12) & 7;

424 
öt32_t
 
c⁄d
 = -1;

426 
fun˘3
 >> 1)

429 
c⁄d
 = (
i
->
rs1_vÆ
 =i->
rs2_vÆ
);

432 
c⁄d
 = ((
èrgë_l⁄g
)
i
->
rs1_vÆ
 < (èrgë_l⁄g)i->
rs2_vÆ
);

435 
c⁄d
 = (
i
->
rs1_vÆ
 < i->
rs2_vÆ
);

438 
c⁄d
 ^(
fun˘3
 & 1);

439 
i
->
c⁄d
 = cond;

440 
i
->
èrgë
 = i->
pc
 + i->
imm
;

442 
	}
}

445 
	$execuã_ext_c_q0
(
RVIn°ru˘i⁄
 *
i
)

447 
i
->
fun˘3
)

451 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

454 #i‡
SIM_FLEN
 >= 64

457 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

463 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

466 #i‡
	`deföed
(
RV64
)

469 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

472 #ñi‡
SIM_FLEN
 >= 32

475 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

479 #i‡
SIM_FLEN
 >= 64

481 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

485 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

487 #i‡
	`deföed
(
RV64
)

489 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

491 #ñi‡
SIM_FLEN
 >= 32

493 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

498 
	}
}

501 
	$execuã_ext_c_q1
(
RVIn°ru˘i⁄
 *
i
)

503 
i
->
fun˘3
)

506 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

508 #i‡
	`deföed
(
RV32
)

510 
i
->
buf„r
 = (
èrgë_ul⁄g
)(i->
pc
 + 2);

511 
i
->
èrgë
 = (
èrgë_l⁄g
)(i->
pc
 + i->
imm
);

513 #ñi‡
	`deföed
(
RV64
)

515 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 + i->
imm
);

519 
i
->
buf„r
 = i->
imm
;

522 i‡(
i
->
rd
 == 2)

525 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

527 i‡(
i
->
rd
 != 0)

530 
i
->
buf„r
 = i->
imm
;

534 
i
->
fun˘4
)

538 i‡(
i
->
fun˘4
 == 0)

540 
i
->
buf„r


541 (
èrgë_l⁄g
)((
èrgë_ul⁄g
)
i
->
rs1_vÆ
 >> i->
imm
);

545 
i
->
buf„r
 = (
èrgë_l⁄g
)i->
rs1_vÆ
 >> i->
imm
;

549 
i
->
buf„r
 = (
èrgë_l⁄g
)i->
rs1_vÆ
 & i->
imm
;

552 
i
->
fun˘5
)

555 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 - i->
rs2_vÆ
);

558 
i
->
buf„r
 = (i->
rs1_vÆ
 ^ i->
rs2_vÆ
);

561 
i
->
buf„r
 = (i->
rs1_vÆ
 | i->
rs2_vÆ
);

564 
i
->
buf„r
 = (i->
rs1_vÆ
 & i->
rs2_vÆ
);

566 #i‡
	`deföed
(
RV64
)

568 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 - i->
rs2_vÆ
);

571 
i
->
buf„r
 = (
öt32_t
)(i->
rs1_vÆ
 + i->
rs2_vÆ
);

580 
i
->
èrgë
 = (
èrgë_ul⁄g
)(i->
pc
 + i->
imm
);

585 
i
->
c⁄d
 = (i->
rs1_vÆ
 == 0);

586 
i
->
èrgë
 = (
èrgë_ul⁄g
)(i->
pc
 + i->
imm
);

591 
i
->
c⁄d
 = (i->
rs1_vÆ
 != 0);

592 
i
->
èrgë
 = (
èrgë_ul⁄g
)(i->
pc
 + i->
imm
);

597 
	}
}

600 
	$execuã_ext_c_q2
(
RVIn°ru˘i⁄
 *
i
)

602 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

604 
i
->
fun˘3
)

607 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 << i->
imm
);

609 #i‡
SIM_FLEN
 >= 64

612 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

618 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

621 #i‡
	`deföed
(
RV64
)

624 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

627 #ñi‡
SIM_FLEN
 >= 32

630 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

635 i‡(((
ö¢
 >> 12) & 1) == 0)

637 i‡(
i
->
rs2
 == 0)

640 
i
->
èrgë
 = (i->
rs1_vÆ
 & ~1);

645 
i
->
buf„r
 = i->
rs2_vÆ
;

650 i‡(
i
->
rs2
 == 0)

652 i‡(
i
->
rd
 == 0)

659 
i
->
buf„r
 = i->
pc
 + 2;

660 
i
->
èrgë
 = i->
rs1_vÆ
 & ~1;

666 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
rs2_vÆ
);

670 #i‡
SIM_FLEN
 >= 64

672 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

676 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

678 #i‡
	`deföed
(
RV64
)

680 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

682 #ñi‡
SIM_FLEN
 >= 32

684 
i
->
mem_addr
 = (
èrgë_l⁄g
)(i->
rs1_vÆ
 + i->
imm
);

689 
	}
}

692 
	$execuã_ext_c_∑th
(
RVIn°ru˘i⁄
 *
i
)

694 
i
->
quad
)

698 
	`execuã_ext_c_q0
(
i
);

703 
	`execuã_ext_c_q1
(
i
);

708 
	`execuã_ext_c_q2
(
i
);

712 
	}
}

715 
	$execuã_riscv_ö°ru˘i⁄
(
RVIn°ru˘i⁄
 *
i
, 
uöt32_t
 *
fÊags
)

717 
öt32_t
 
rm
;

720 i‡((
i
->
bö¨y
 & 3) != 3)

722 
	`execuã_ext_c_∑th
(
i
);

727 
i
->
maj‹_›code
)

730 
OP_IMM_MASK
:

732 
	`execuã_›_imm
(
i
);

736 
OP_IMM_32_MASK
:

738 
	`execuã_›_imm_32
(
i
);

742 
OP_MASK
:

744 
	`execuã_›
(
i
);

748 
OP_MASK_32
:

750 
	`execuã_›_32
(
i
);

754 
LUI_MASK
:

756 
i
->
buf„r
 = i->
imm
;

760 
AUIPC_MASK
:

762 
i
->
buf„r
 = (
èrgë_l⁄g
)(i->
pc
 + i->
imm
);

766 
LOAD_MASK
:

768 
i
->
mem_addr
 = i->
rs1_vÆ
 + i->
imm
;

771 
STORE_MASK
:

773 
i
->
mem_addr
 = i->
rs1_vÆ
 + i->
imm
;

777 
JAL_MASK
:

779 
i
->
buf„r
 = i->
pc
 + 4;

780 
i
->
èrgë
 = i->
pc
 + i->
imm
;

784 
JALR_MASK
:

786 
i
->
buf„r
 = i->
pc
 + 4;

787 
i
->
èrgë
 = i->
rs1_vÆ
 + i->
imm
;

791 
BRANCH_MASK
:

793 
	`execuã_ty≥_b
(
i
);

797 
ATOMIC_MASK
:

799 
i
->
mem_addr
 = i->
rs1_vÆ
;

803 
FLOAD_MASK
:

805 
i
->
mem_addr
 = i->
rs1_vÆ
 + i->
imm
;

809 
FSTORE_MASK
:

811 
i
->
mem_addr
 = i->
rs1_vÆ
 + i->
imm
;

817 
rm
 = 
i
->rm;

818 
i
->
fun˘3
)

822 
i
->
buf„r
 = 
	`fma_sf32
(i->
rs1_vÆ
, i->
rs2_vÆ
, i->
rs3_vÆ
,

823 (
RoundögModeEnum
)
rm
, 
fÊags
)

824 | 
F32_HIGH
;

829 
i
->
buf„r
 = 
	`fma_sf64
(i->
rs1_vÆ
, i->
rs2_vÆ
, i->
rs3_vÆ
,

830 (
RoundögModeEnum
)
rm
, 
fÊags
)

831 | 
F64_HIGH
;

840 
rm
 = 
i
->rm;

841 
i
->
fun˘3
)

845 
i
->
buf„r
 = 
	`fma_sf32
(i->
rs1_vÆ
, i->
rs2_vÆ
,

846 
i
->
rs3_vÆ
 ^ 
FSIGN_MASK32
,

847 (
RoundögModeEnum
)
rm
, 
fÊags
)

848 | 
F32_HIGH
;

853 
i
->
buf„r
 = 
	`fma_sf64
(i->
rs1_vÆ
, i->
rs2_vÆ
,

854 
i
->
rs3_vÆ
 ^ 
FSIGN_MASK64
,

855 (
RoundögModeEnum
)
rm
, 
fÊags
)

856 | 
F64_HIGH
;

865 
rm
 = 
i
->rm;

866 
i
->
fun˘3
)

870 
i
->
buf„r


871 
	`fma_sf32
(
i
->
rs1_vÆ
 ^ 
FSIGN_MASK32
, i->
rs2_vÆ
,

872 
i
->
rs3_vÆ
, (
RoundögModeEnum
)
rm
, 
fÊags
)

873 | 
F32_HIGH
;

879 
i
->
buf„r


880 
	`fma_sf64
(
i
->
rs1_vÆ
 ^ 
FSIGN_MASK64
, i->
rs2_vÆ
,

881 
i
->
rs3_vÆ
, (
RoundögModeEnum
)
rm
, 
fÊags
)

882 | 
F64_HIGH
;

891 
rm
 = 
i
->rm;

892 
i
->
fun˘3
)

896 
i
->
buf„r
 = 
	`fma_sf32
(i->
rs1_vÆ
 ^ 
FSIGN_MASK32
, i->
rs2_vÆ
,

897 
i
->
rs3_vÆ
 ^ 
FSIGN_MASK32
,

898 (
RoundögModeEnum
)
rm
, 
fÊags
)

899 | 
F32_HIGH
;

904 
i
->
buf„r
 = 
	`fma_sf64
(i->
rs1_vÆ
 ^ 
FSIGN_MASK64
, i->
rs2_vÆ
,

905 
i
->
rs3_vÆ
 ^ 
FSIGN_MASK64
,

906 (
RoundögModeEnum
)
rm
, 
fÊags
)

907 | 
F64_HIGH
;

914 
F_ARITHMETIC_MASK
:

916 
rm
 = 
i
->rm;

917 
i
->
fun˘7
)

919 
	#F_SIZE
 32

	)

920 
	~"execuã_Âa_ãm∂©e.h
"

921 #i‡
SIM_FLEN
 >= 64

922 
	#F_SIZE
 64

	)

923 
	~"execuã_Âa_ãm∂©e.h
"

929 
	}
}

	@riscvsim/riscv_ins_execute_lib.h

30 #i‚de‡
_RISCV_ISA_EXECUTE_LIB_H_


31 
	#_RISCV_ISA_EXECUTE_LIB_H_


	)

33 
	~<öây≥s.h
>

35 
	~"riscv_ö°ru˘i⁄.h
"

37 
execuã_riscv_ö°ru˘i⁄
(
RVIn°ru˘i⁄
 *
i
, 
uöt32_t
 *
fÊags
);

	@riscvsim/riscv_ins_str_creator.c

32 
	~<°dio.h
>

33 
	~<°dlib.h
>

34 
	~<°rög.h
>

36 
	~"riscv_ö°ru˘i⁄.h
"

38 c⁄° 
	gªg
[][6] = {

73 c⁄° 
	gÂ_ªg
[][6] = {

108 
	sC§Name
 {

109 
	mi
;

110 c⁄° *
	m«me
;

111 
	mn
;

112 } 
	tC§Name
;

114 c⁄° 
C§Name
 
	gc§_«mes
[] = {

152 c⁄° 
	gsize_suffix
[8][3] = {"b", "h", "w", "d", "q", "5", "6", "7"};

153 c⁄° * c⁄° 
	gaqæ_suffix
[4] = {"", ".rl", ".aq", ".aqrl"};

154 c⁄° 
	ggë_Êí_suffix
[][3] = {"", ".s", ".d"};

157 
	$£t_›_imm_°r
(
RVIn°ru˘i⁄
 *
i
)

159 
i
->
fun˘3
)

163 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "addi %s,%s,%d",

164 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

169 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "slli %s,%s,%d",

170 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

175 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "slti %s,%s,%d",

176 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

181 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sltiu %s,%s,%d",

182 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

187 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "xori %s,%s,%d",

188 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

193 i‡(
i
->
imm
 & 0x400)

195 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "srai %s,%s,%d",

196 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

200 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "srli %s,%s,%d",

201 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

207 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "ori %s,%s,%d",

208 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

213 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "andi %s,%s,%d",

214 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

218 
	}
}

221 
	$£t_›_imm_32_°r
(
RVIn°ru˘i⁄
 *
i
)

223 
i
->
fun˘3
)

227 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "addiw %s,%s,%d",

228 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

233 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "slliw %s,%s,%d",

234 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

239 i‡(
i
->
imm
 & 0x400)

241 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sraiw %s,%s,%d",

242 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

246 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "srliw %s,%s,%d",

247 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

252 
	}
}

255 
	$£t_›_°r
(
RVIn°ru˘i⁄
 *
i
)

257 
uöt32_t
 
fun˘3
;

258 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

259 
öt32_t
 
imm
 = 
ö¢
 >> 25;

261 i‡(
imm
 == 1)

263 
fun˘3
 = (
ö¢
 >> 12) & 7;

264 
fun˘3
)

268 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "mul %s,%s,%s",

269 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

274 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "mulh %s,%s,%s",

275 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

280 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "mulhsu %s,%s,%s",

281 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

286 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "mulhu %s,%s,%s",

287 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

292 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "div %s,%s,%s",

293 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

298 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "divu %s,%s,%s",

299 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

304 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "rem %s,%s,%s",

305 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

310 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "remu %s,%s,%s",

311 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

318 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

319 
fun˘3
)

323 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "add %s,%s,%s",

324 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

329 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sub %s,%s,%s",

330 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

335 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sll %s,%s,%s",

336 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

341 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "slt %s,%s,%s",

342 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

347 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sltu %s,%s,%s",

348 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

353 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "xor %s,%s,%s",

354 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

359 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "srl %s,%s,%s",

360 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

365 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sra %s,%s,%s",

366 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

371 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "or %s,%s,%s",

372 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

377 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "and %s,%s,%s",

378 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

383 
	}
}

386 
	$£t_›_32_°r
(
RVIn°ru˘i⁄
 *
i
)

388 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

389 
öt32_t
 
imm
 = 
ö¢
 >> 25;

390 
uöt32_t
 
fun˘3
;

392 i‡(
imm
 == 1)

394 
fun˘3
 = (
ö¢
 >> 12) & 7;

395 
fun˘3
)

399 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "mulw %s,%s,%s",

400 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

405 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "divw %s,%s,%s",

406 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

411 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "divuw %s,%s,%s",

412 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

417 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "remw %s,%s,%s",

418 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

423 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "remuw %s,%s,%s",

424 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

431 
fun˘3
 = ((
ö¢
 >> 12) & 7) | ((insn >> (30 - 3)) & (1 << 3));

432 
fun˘3
)

436 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "addw %s,%s,%s",

437 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

442 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "subw %s,%s,%s",

443 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

448 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sllw %s,%s,%s",

449 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

454 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "srlw %s,%s,%s",

455 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

460 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sraw %s,%s,%s",

461 
ªg
[
i
->
rd
],Ñeg[i->
rs1
],Ñeg[i->
rs2
]);

466 
	}
}

469 
	$£t_bønch_°r
(
RVIn°ru˘i⁄
 *
i
)

471 c⁄° * c⁄° 
bønches
[8] = {"beq", "bne", 0, 0, "blt", "bge", "bltu", "bgeu"};

472 c⁄° *
s
;

474 i‡(
i
->
fun˘3
 < 8)

476 
s
 = 
bønches
[
i
->
fun˘3
];

477 i‡(
s
 != 0)

479 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "%s %s,%s,%d",

480 
s
, 
ªg
[
i
->
rs1
],Ñeg[i->
rs2
], i->
imm
);

483 
	}
}

486 
	$£t_ext_c_q0_°r
(
RVIn°ru˘i⁄
 *
i
)

488 
i
->
fun˘3
)

492 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.addi4spn %s,%s,%d",

493 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

496 #i‡
SIM_FLEN
 >= 64

499 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.fld %s,%d(%s)",

500 
Â_ªg
[
i
->
rd
], i->
imm
, 
ªg
[i->
rs1
]);

506 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.lw %s,%d(%s)",

507 
ªg
[
i
->
rd
], i->
imm
,Ñeg[i->
rs1
]);

510 #i‡
	`deföed
(
RV64
)

513 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.ld %s,%d(%s)",

514 
ªg
[
i
->
rd
], i->
imm
,Ñeg[i->
rs1
]);

517 #ñi‡
SIM_FLEN
 >= 32

520 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.flw %s,%d(%s)",

521 
Â_ªg
[
i
->
rd
], i->
imm
, 
ªg
[i->
rs1
]);

525 #i‡
SIM_FLEN
 >= 64

528 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.fsd %s,%d(%s)",

529 
Â_ªg
[
i
->
rs2
], i->
imm
, 
ªg
[i->
rs1
]);

535 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.sw %s,%d(%s)",

536 
ªg
[
i
->
rs2
], i->
imm
,Ñeg[i->
rs1
]);

539 #i‡
	`deföed
(
RV64
)

542 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.sd %s,%d(%s)",

543 
ªg
[
i
->
rs2
], i->
imm
,Ñeg[i->
rs1
]);

546 #ñi‡
SIM_FLEN
 >= 32

549 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.fsw %s,%d(%s)",

550 
Â_ªg
[
i
->
rs2
], i->
imm
, 
ªg
[i->
rs1
]);

555 
	}
}

558 
	$£t_ext_c_q1_°r
(
RVIn°ru˘i⁄
 *
i
)

560 
i
->
fun˘3
)

564 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.addi %s,%d",

565 
ªg
[
i
->
rd
], i->
imm
);

568 #i‡
	`deföed
(
RV32
)

571 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.jÆ %d", i->
imm
);

574 #ñi‡
	`deföed
(
RV64
)

577 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.addiw %s,%d",

578 
ªg
[
i
->
rd
], i->
imm
);

584 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.lò%s,%d", 
ªg
[i->
rd
],

585 
i
->
imm
);

590 i‡(
i
->
rd
 == 2)

593 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.addi16sp %s,%d",

594 
ªg
[
i
->
rd
], i->
imm
);

596 i‡(
i
->
rd
 != 0)

599 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.lui %s,%d",

600 
ªg
[
i
->
rd
], i->
imm
);

606 
i
->
fun˘4
)

611 i‡(
i
->
fun˘4
 == 0)

613 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

614 "c.§lò%s,%d", 
ªg
[
i
->
rd
], i->
imm
);

618 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

619 "c.§aò%s,%d", 
ªg
[
i
->
rd
], i->
imm
);

625 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.andi %s,%d",

626 
ªg
[
i
->
rd
], i->
imm
);

631 
i
->
fun˘5
)

635 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

636 "c.sub %s,%s", 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

641 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

642 "c.x‹ %s,%s", 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

647 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

648 "c.‹ %s,%s", 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

653 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

654 "c.™d %s,%s", 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

657 #i‡
	`deföed
(
RV64
)

660 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

661 "c.subw %s,%s", 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

666 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

667 "c.addw %s,%s", 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

679 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.j %d", i->
imm
);

684 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.beqz %s,%d",

685 
ªg
[
i
->
rs1
], i->
imm
);

690 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.bnez %s,%d",

691 
ªg
[
i
->
rs1
], i->
imm
);

695 
	}
}

698 
	$£t_ext_c_q2_°r
(
RVIn°ru˘i⁄
 *
i
)

700 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

702 
i
->
fun˘3
)

706 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.slli %s,%d",

707 
ªg
[
i
->
rd
], i->
imm
);

710 #i‡
SIM_FLEN
 >= 64

713 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.fldsp %s,%d(sp)",

714 
Â_ªg
[
i
->
rd
],i->
imm
);

720 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.lwsp %s,%d(sp)",

721 
ªg
[
i
->
rd
], i->
imm
);

724 #i‡
	`deföed
(
RV64
)

727 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.ldsp %s,%d(sp)",

728 
ªg
[
i
->
rd
], i->
imm
);

731 #ñi‡
SIM_FLEN
 >= 32

734 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.flwsp %s,%d(sp)",

735 
Â_ªg
[
i
->
rd
], i->
imm
);

741 i‡(((
ö¢
 >> 12) & 1) == 0)

743 i‡(
i
->
rs2
 == 0)

746 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.jr %s",

747 
ªg
[
i
->
rs1
]);

752 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.mv %s,%s",

753 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

758 i‡(
i
->
rs2
 == 0)

760 i‡(
i
->
rd
 == 0)

763 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.break");

768 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.jalr %s",

769 
ªg
[
i
->
rs1
]);

775 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.add %s,%s",

776 
ªg
[
i
->
rd
],Ñeg[i->
rs2
]);

781 #i‡
SIM_FLEN
 >= 64

784 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.fsdsp %s,%d(sp)",

785 
Â_ªg
[
i
->
rs2
], i->
imm
);

791 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.swsp %s,%d(sp)",

792 
ªg
[
i
->
rs2
], i->
imm
);

795 #i‡
	`deföed
(
RV64
)

798 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.sdsp %s,%d(sp)",

799 
ªg
[
i
->
rs2
], i->
imm
);

802 #ñi‡
SIM_FLEN
 >= 32

805 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "c.fswsp %s,%d(sp)",

806 
Â_ªg
[
i
->
rs2
], i->
imm
);

811 
	}
}

814 
	$£t_ext_c_°r
(
RVIn°ru˘i⁄
 *
i
)

816 
i
->
quad
)

820 
	`£t_ext_c_q0_°r
(
i
);

825 
	`£t_ext_c_q1_°r
(
i
);

830 
	`£t_ext_c_q2_°r
(
i
);

834 
	}
}

837 
	$£t_lﬂd_°r
(
RVIn°ru˘i⁄
 *
i
)

839 c⁄° *
«me
;

841 
i
->
byãs_to_rw
)

845 
«me
 = "lb";

850 
«me
 = "lh";

855 
«me
 = "lw";

860 
«me
 = "ld";

869 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "%s%†%s,%d(%s)", 
«me
,

870 (
i
->
is_unsig√d
 ? "u" : ""), 
ªg
[i->
rd
], i->
imm
,Ñeg[i->
rs1
]);

871 
	}
}

874 
	$£t_°‹e_°r
(
RVIn°ru˘i⁄
 *
i
)

876 c⁄° *
«me
;

878 
i
->
byãs_to_rw
)

882 
«me
 = "sb";

887 
«me
 = "sh";

892 
«me
 = "sw";

897 
«me
 = "sd";

903 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "%s %s,%d(%s)",

904 
«me
, 
ªg
[
i
->
rs2
], i->
imm
,Ñeg[i->
rs1
]);

905 
	}
}

908 
	$£t_c§_°r
(
RVIn°ru˘i⁄
 *
i
)

910 c⁄° 
C§Name
 *
c§
;

911 c⁄° *
«me
;

912 
˙ame
[20];

913 
öt32_t
 
imm
;

914 
uöt32_t
 
fun˘3
;

915 
has_imm
;

917 
fun˘3
 = (
i
->
bö¨y
 >> 12) & 7;

918 
imm
 = 
i
->
bö¨y
 >> 20;

919 
has_imm
 = (
fun˘3
 & 4);

920 
fun˘3
 &= 3;

922 
fun˘3
)

926 
«me
 = "csrrw";

931 
«me
 = "csrrs";

936 
«me
 = "csrrc";

941 
imm
)

945 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "ecall");

950 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "ebreak");

955 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sret");

960 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "mret");

965 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "wfi");

969 i‡((
imm
 >> 5) == 0x09)

972 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "sfence.vma");

981 
c§
 = 
c§_«mes
; c§->
i
 !0 || c§->
«me
 != 0; csr++)

983 i‡((
imm
 & ~
c§
->
n
Ë=c§->
i
) ;

986 i‡(
c§
->
«me
 != 0)

988 
	`¢¥ötf
(
˙ame
, (˙ame), 
c§
->
«me
, (
imm
 & c§->
n
));

989 i‡(
has_imm
)

991 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "%si %s,%s,%d",

992 
«me
, 
ªg
[
i
->
rd
], 
˙ame
, i->
rs1
);

996 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "%s %s,%s,%s",

997 
«me
, 
ªg
[
i
->
rd
], 
˙ame
,Ñeg[i->
rs1
]);

1000 
	}
}

1003 
	$£t_„n˚_°r
(
RVIn°ru˘i⁄
 *
i
)

1005 
i
->
fun˘3
)

1009 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fence");

1014 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fence.i");

1018 
	}
}

1021 
	$gë_riscv_ös_°r
(
RVIn°ru˘i⁄
 *
i
)

1023 
öt32_t
 
rm
;

1026 i‡((
i
->
bö¨y
 & 3) != 3)

1028 
	`£t_ext_c_°r
(
i
);

1033 
i
->
maj‹_›code
)

1036 
OP_IMM_MASK
:

1038 
	`£t_›_imm_°r
(
i
);

1042 
OP_IMM_32_MASK
:

1044 
	`£t_›_imm_32_°r
(
i
);

1048 
OP_MASK
:

1050 
	`£t_›_°r
(
i
);

1054 
OP_MASK_32
:

1056 
	`£t_›_32_°r
(
i
);

1060 
LUI_MASK
:

1062 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "luò%s,0x%x", 
ªg
[i->
rd
],

1063 
i
->
imm
);

1067 
AUIPC_MASK
:

1069 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "auipc %s,%d",

1070 
ªg
[
i
->
rd
], i->
imm
);

1074 
LOAD_MASK
:

1076 
	`£t_lﬂd_°r
(
i
);

1079 
STORE_MASK
:

1081 
	`£t_°‹e_°r
(
i
);

1085 
JAL_MASK
:

1087 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "jÆ %s,%d", 
ªg
[i->
rd
],

1088 
i
->
imm
);

1092 
JALR_MASK
:

1094 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "jalr %s,%s,%d",

1095 
ªg
[
i
->
rd
],Ñeg[i->
rs1
], i->
imm
);

1099 
BRANCH_MASK
:

1101 
	`£t_bønch_°r
(
i
);

1105 
ATOMIC_MASK
:

1107 
uöt32_t
 
fun˘7
 = (
i
->
bö¨y
 >> 27) & 0x1F;

1108 c⁄° *
size
 = 
size_suffix
[(
i
->
bö¨y
 >> 12) & 7];

1109 c⁄° *
aqæ
 = 
aqæ_suffix
[(
i
->
bö¨y
 >> 25) & 3];

1110 i‡(
fun˘7
 == 2)

1112 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "lr.%s%s %s,(%s)",

1113 
size
, 
aqæ
, 
ªg
[
i
->
rd
],Ñeg[i->
rs1
]);

1117 c⁄° * c⁄° 
«mes
[32] = {"amoadd", "amoswap", 0, "sc",

1120 c⁄° *
«me
 = 
«mes
[
fun˘7
];

1121 i‡(
«me
 != 0)

1123 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "%s.%s%s %s,%s,(%s)",

1124 
«me
, 
size
, 
aqæ
, 
ªg
[
i
->
rd
],Ñeg[i->
rs2
],Ñeg[i->
rs1
]);

1130 
CSR_MASK
:

1132 
	`£t_c§_°r
(
i
);

1136 
FENCE_MASK
:

1138 
	`£t_„n˚_°r
(
i
);

1142 
FLOAD_MASK
:

1144 
i
->
fun˘3
)

1148 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "flw %s,%d(%s)",

1149 
Â_ªg
[
i
->
rd
], i->
imm
, 
ªg
[i->
rs1
]);

1152 #i‡
SIM_FLEN
 >= 64

1155 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fld %s,%d(%s)",

1156 
Â_ªg
[
i
->
rd
], i->
imm
, 
ªg
[i->
rs1
]);

1164 
FSTORE_MASK
:

1166 
i
->
fun˘3
)

1170 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsw %s,%d(%s)",

1171 
Â_ªg
[
i
->
rs2
], i->
imm
, 
ªg
[i->
rs1
]);

1174 #i‡
SIM_FLEN
 >= 64

1178 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
, "fsd %s,%d(%s)",

1179 
Â_ªg
[
i
->
rs2
], i->
imm
, 
ªg
[i->
rs1
]);

1188 
rm
 = 
i
->rm;

1189 
i
->
fun˘3
)

1193 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1194 "fmadd.†%s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1195 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1200 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1201 "fmadd.d %s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1202 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1211 
rm
 = 
i
->rm;

1212 
i
->
fun˘3
)

1216 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1217 "fmsub.†%s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1218 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1223 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1224 "fmsub.d %s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1225 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1234 
rm
 = 
i
->rm;

1235 
i
->
fun˘3
)

1239 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1240 "‚msub.†%s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1241 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1247 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1248 "‚msub.d %s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1249 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1258 
rm
 = 
i
->rm;

1259 
i
->
fun˘3
)

1263 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1264 "‚madd.†%s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1265 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1270 
	`¢¥ötf
(
i
->
°r
, 
RISCV_INS_STR_MAX_LENGTH
,

1271 "‚madd.d %s,%s,%s,%s", 
Â_ªg
[
i
->
rd
],

1272 
Â_ªg
[
i
->
rs1
], fp_ªg[i->
rs2
], fp_ªg[i->
rs3
]);

1279 
F_ARITHMETIC_MASK
:

1281 
rm
 = 
i
->rm;

1282 
i
->
fun˘7
)

1284 
	#F_SIZE
 32

	)

1285 
	~"Âa_°r_¸ót‹_ãm∂©e.h
"

1286 #i‡
SIM_FLEN
 >= 64

1287 
	#F_SIZE
 64

	)

1288 
	~"Âa_°r_¸ót‹_ãm∂©e.h
"

1294 
	}
}

	@riscvsim/riscv_ins_str_creator.h

30 #i‚de‡
_RISCV_INS_STR_CREATOR_H_


31 
	#_RISCV_INS_STR_CREATOR_H_


	)

33 
	~"riscv_ö°ru˘i⁄.h
"

34 
gë_riscv_ös_°r
(
RVIn°ru˘i⁄
 *
i
);

	@riscvsim/riscv_instruction.h

30 #i‚de‡
_RISCV_INSTRUCTION_H_


31 
	#_RISCV_INSTRUCTION_H_


	)

33 
	~<öây≥s.h
>

34 
	~"riscv_sim_ty≥defs.h
"

36 
	sRVIn°ru˘i⁄


38 
èrgë_ul⁄g
 
	mpc
;

41 
uöt32_t
 
	mbö¨y
;

44 
uöt32_t
 
	mquad
;

47 
öt32_t
 
	mmaj‹_›code
;

48 
öt32_t
 
	mfun˘3
;

49 
öt32_t
 
	mfun˘4
;

50 
öt32_t
 
	mfun˘5
;

51 
öt32_t
 
	mfun˘7
;

54 
uöt32_t
 
	mrd
;

55 
uöt32_t
 
	mrs1
;

56 
uöt32_t
 
	mrs2
;

57 
uöt32_t
 
	mrs3
;

60 
	mﬁd_pde°
;

61 
	mpde°
;

62 
	m¥s1
;

63 
	m¥s2
;

64 
	m¥s3
;

67 
öt32_t
 
	mimm
;

70 
uöt32_t
 
	mrm
;

73 
	m°r
[
RISCV_INS_STR_MAX_LENGTH
];

74 
	m¸óã_°r
;

76 
	mhas_§c1
;

77 
	mhas_§c2
;

78 
	mhas_de°
;

80 
	mhas_Â_de°
;

81 
	mhas_Â_§c1
;

82 
	mhas_Â_§c2
;

83 
	mhas_Â_§c3
;

84 
	mf32_mask
;

85 
	mf64_mask
;

86 
	m£t_fs
;

87 
	mcuºít_fs
;

89 
	mis_©omic
;

90 
	mis_©omic_lﬂd
;

91 
	mis_©omic_°‹e
;

92 
	mis_©omic_›î©e
;

94 
	mis_lﬂd
;

95 
	mis_°‹e
;

96 
	mbyãs_to_rw
;

97 
	mis_unsig√d
;

98 
èrgë_ul⁄g
 
	mmem_addr
;

100 
	mis_bønch
;

101 
	mbønch_ty≥
;

102 
öt32_t
 
	mc⁄d
;

103 
èrgë_ul⁄g
 
	mèrgë
;

105 
	mfu_ty≥
;

106 
	mÂu_Æu_ty≥
;

107 
	mis_sy°em
;

108 
	mis_func_ˇŒ
;

109 
	mis_func_ªt
;

111 
uöt64_t
 
	mbuf„r
;

112 
uöt64_t
 
	mrs1_vÆ
;

113 
uöt64_t
 
	mrs2_vÆ
;

114 
uöt64_t
 
	mrs3_vÆ
;

116 
	mex˚±i⁄
;

117 
	mex˚±i⁄_ˇu£
;

120 
	mty≥
;

121 
	md©a_˛ass
;

122 } 
	tRVIn°ru˘i⁄
;

	@riscvsim/riscv_isa_decoder.c

32 
	~<as£π.h
>

33 
	~<°dio.h
>

34 
	~<°dlib.h
>

35 
	~<°rög.h
>

37 
	~"riscv_ös_°r_¸ót‹.h
"

38 
	~"riscv_ö°ru˘i⁄.h
"

39 
	~"riscv_sim_ty≥defs.h
"

41 
ölöe
 
öt32_t


42 
	$£xtc
(
öt32_t
 
vÆ
, 
n
)

44  (
vÆ
 << (32 - 
n
)) >> (32 -Ç);

45 
	}
}

47 
ölöe
 
uöt32_t


48 
	$cgë_fõld1
(
uöt32_t
 
vÆ
, 
§c_pos
, 
d°_pos
, 
d°_pos_max
)

50 
mask
;

51 
	`as£π
(
d°_pos_max
 >
d°_pos
);

52 
mask
 = ((1 << (
d°_pos_max
 - 
d°_pos
 + 1)) - 1) << dst_pos;

53 i‡(
d°_pos
 >
§c_pos
)

54  (
vÆ
 << (
d°_pos
 - 
§c_pos
)Ë& 
mask
;

56  (
vÆ
 >> (
§c_pos
 - 
d°_pos
)Ë& 
mask
;

57 
	}
}

60 
	$decode_com¥es£d_q0
(
RVIn°ru˘i⁄
 *
ös
)

62 
uöt32_t
 
ö¢
, 
rd
, 
rs1
, 
rs2
, 
fun˘3
, 
quad
;

63 
öt32_t
 
imm
;

65 
ö¢
 = 
ös
->
bö¨y
;

66 
fun˘3
 = (
ö¢
 >> 13) & 7;

67 
rd
 = ((
ö¢
 >> 2) & 7) | 8;

68 
rs2
 = 
rd
;

69 
quad
 = 
C_QUADRANT0
;

70 
fun˘3
)

73 
ös
->
has_de°
 = 1;

74 
ös
->
has_§c1
 = 1;

75 
rs1
 = 2;

76 
imm
 = 
	`cgë_fõld1
(
ö¢
, 11, 4, 5) | cget_field1(insn, 7, 6, 9)

77 | 
	`cgë_fõld1
(
ö¢
, 6, 2, 2) | cget_field1(insn, 5, 3, 3);

78 i‡(
imm
 == 0)

79 
ûÀgÆ_ö¢
;

81 #i‡
SIM_FLEN
 >= 64

84 i‡(
ös
->
cuºít_fs
 == 0)

85 
ûÀgÆ_ö¢
;

86 
ös
->
is_lﬂd
 = 1;

87 
ös
->
has_Â_de°
 = 1;

88 
ös
->
has_§c1
 = 1;

89 
ös
->
byãs_to_rw
 = 8;

90 
ös
->
f64_mask
 = 1;

91 
ös
->
£t_fs
 = 1;

92 
ös
->
ty≥
 = 
INS_TYPE_FP_LOAD
;

93 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 5, 6, 7);

94 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

100 
ös
->
is_lﬂd
 = 1;

101 
ös
->
has_de°
 = 1;

102 
ös
->
has_§c1
 = 1;

103 
ös
->
byãs_to_rw
 = 4;

104 
ös
->
ty≥
 = 
INS_TYPE_LOAD
;

105 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 6, 2, 2)

106 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 6);

107 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

110 #i‡
	`deföed
(
RV64
)

113 
ös
->
is_lﬂd
 = 1;

114 
ös
->
has_de°
 = 1;

115 
ös
->
has_§c1
 = 1;

116 
ös
->
byãs_to_rw
 = 8;

117 
ös
->
ty≥
 = 
INS_TYPE_LOAD
;

118 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 5, 6, 7);

119 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

122 #ñi‡
SIM_FLEN
 >= 32

125 
ös
->
is_lﬂd
 = 1;

126 
ös
->
has_Â_de°
 = 1;

127 
ös
->
has_§c1
 = 1;

128 
ös
->
byãs_to_rw
 = 4;

129 
ös
->
f32_mask
 = 1;

130 
ös
->
£t_fs
 = 1;

131 
ös
->
ty≥
 = 
INS_TYPE_FP_LOAD
;

132 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 6, 2, 2)

133 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 6);

134 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

138 #i‡
SIM_FLEN
 >= 64

140 
ös
->
is_°‹e
 = 1;

141 
ös
->
has_§c1
 = 1;

142 
ös
->
has_Â_§c2
 = 1;

143 
ös
->
byãs_to_rw
 = 8;

144 
ös
->
ty≥
 = 
INS_TYPE_FP_STORE
;

145 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 5, 6, 7);

146 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

150 
ös
->
is_°‹e
 = 1;

151 
ös
->
has_§c1
 = 1;

152 
ös
->
has_§c2
 = 1;

153 
ös
->
byãs_to_rw
 = 4;

154 
ös
->
ty≥
 = 
INS_TYPE_STORE
;

155 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 6, 2, 2)

156 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 6);

157 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

159 #i‡
	`deföed
(
RV64
)

161 
ös
->
is_°‹e
 = 1;

162 
ös
->
has_§c1
 = 1;

163 
ös
->
has_§c2
 = 1;

164 
ös
->
byãs_to_rw
 = 8;

165 
ös
->
ty≥
 = 
INS_TYPE_STORE
;

166 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 5, 6, 7);

167 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

169 #ñi‡
SIM_FLEN
 >= 32

171 
ös
->
is_°‹e
 = 1;

172 
ös
->
has_§c1
 = 1;

173 
ös
->
has_Â_§c2
 = 1;

174 
ös
->
byãs_to_rw
 = 4;

175 
ös
->
ty≥
 = 
INS_TYPE_FP_STORE
;

176 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 6, 2, 2)

177 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 6);

178 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

182 
ûÀgÆ_ö¢
;

184 
ös
->
rd
 =Ñd;

185 
ös
->
rs1
 =Ñs1;

186 
ös
->
rs2
 =Ñs2;

187 
ös
->
fun˘3
 = funct3;

188 
ös
->
imm
 = imm;

189 
ös
->
quad
 = quad;

191 
ûÀgÆ_ö¢
:

192 
ös
->
ex˚±i⁄
 = 1;

193 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_ILLEGAL_OPCODE
;

194 
	}
}

197 
	$decode_com¥es£d_q1
(
RVIn°ru˘i⁄
 *
ös
)

199 
uöt32_t
 
ö¢
, 
rd
, 
rs1
, 
rs2
 = 0, 
fun˘3
, 
fun˘4
 = 0, 
fun˘5
 = 0, 
quad
;

200 
öt32_t
 
imm
 = 0;

202 
ö¢
 = 
ös
->
bö¨y
;

203 
fun˘3
 = (
ö¢
 >> 13) & 7;

204 
rd
 = (
ö¢
 >> 7) & 0x1f;

205 
rs1
 = 
rd
;

206 
quad
 = 
C_QUADRANT1
;

207 
fun˘3
)

210 
ös
->
has_de°
 = 1;

211 
ös
->
has_§c1
 = 1;

212 
imm
 = 
	`£xtc
(

213 
	`cgë_fõld1
(
ö¢
, 12, 5, 5) | cget_field1(insn, 2, 0, 4), 6);

215 #i‡
	`deföed
(
RV32
)

217 
ös
->
has_de°
 = 1;

218 
ös
->
is_bønch
 = 1;

219 
ös
->
bønch_ty≥
 = 
BRANCH_UNCOND
;

220 
ös
->
ty≥
 = 
INS_TYPE_JAL
;

221 
rd
 = 1;

222 
imm
 = 
	`£xtc
(

223 
	`cgë_fõld1
(
ö¢
, 12, 11, 11) | cget_field1(insn, 11, 4, 4)

224 | 
	`cgë_fõld1
(
ö¢
, 9, 8, 9) | cget_field1(insn, 8, 10, 10)

225 | 
	`cgë_fõld1
(
ö¢
, 7, 6, 6) | cget_field1(insn, 6, 7, 7)

226 | 
	`cgë_fõld1
(
ö¢
, 3, 1, 3) | cget_field1(insn, 2, 5, 5),

228 
ös
->
is_func_ˇŒ
 = 1;

230 #ñi‡
	`deföed
(
RV64
)

232 
ös
->
has_de°
 = 1;

233 
ös
->
has_§c1
 = 1;

234 
imm
 = 
	`£xtc
(

235 
	`cgë_fõld1
(
ö¢
, 12, 5, 5) | cget_field1(insn, 2, 0, 4), 6);

239 
ös
->
has_de°
 = 1;

240 
imm
 = 
	`£xtc
(

241 
	`cgë_fõld1
(
ö¢
, 12, 5, 5) | cget_field1(insn, 2, 0, 4), 6);

244 i‡(
rd
 == 2)

247 
ös
->
has_de°
 = 1;

248 
ös
->
has_§c1
 = 1;

249 
rd
 = 2;

250 
rs1
 = 
rd
;

251 
imm
 = 
	`£xtc
(
	`cgë_fõld1
(
ö¢
, 12, 9, 9)

252 | 
	`cgë_fõld1
(
ö¢
, 6, 4, 4)

253 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 6)

254 | 
	`cgë_fõld1
(
ö¢
, 3, 7, 8)

255 | 
	`cgë_fõld1
(
ö¢
, 2, 5, 5),

257 i‡(
imm
 == 0)

258 
ûÀgÆ_ö¢
;

260 i‡(
rd
 != 0)

263 
ös
->
has_de°
 = 1;

264 
imm
 = 
	`£xtc
(
	`cgë_fõld1
(
ö¢
, 12, 17, 17)

265 | 
	`cgë_fõld1
(
ö¢
, 2, 12, 16),

270 
ös
->
has_de°
 = 1;

271 
ös
->
has_§c1
 = 1;

272 
fun˘4
 = (
ö¢
 >> 10) & 3;

273 
rd
 = ((
ö¢
 >> 7) & 7) | 8;

274 
rs1
 = 
rd
;

275 
fun˘4
)

279 
imm
 = 
	`cgë_fõld1
(
ö¢
, 12, 5, 5)

280 | 
	`cgë_fõld1
(
ö¢
, 2, 0, 4);

281 #i‡
	`deföed
(
RV32
)

282 i‡(
imm
 & 0x20)

283 
ûÀgÆ_ö¢
;

287 
imm
 = 
	`£xtc
(
	`cgë_fõld1
(
ö¢
, 12, 5, 5)

288 | 
	`cgë_fõld1
(
ö¢
, 2, 0, 4),

292 
rs2
 = ((
ö¢
 >> 2) & 7) | 8;

293 
ös
->
has_§c2
 = 1;

294 
fun˘5
 = ((
ö¢
 >> 5) & 3) | ((insn >> (12 - 2)) & 4);

295 
fun˘5
)

301 #i‡
	`deföed
(
RV64
)

307 
ûÀgÆ_ö¢
;

313 
ös
->
is_bønch
 = 1;

314 
ös
->
bønch_ty≥
 = 
BRANCH_UNCOND
;

315 
ös
->
ty≥
 = 
INS_TYPE_JAL
;

316 
imm
 = 
	`£xtc
(

317 
	`cgë_fõld1
(
ö¢
, 12, 11, 11) | cget_field1(insn, 11, 4, 4)

318 | 
	`cgë_fõld1
(
ö¢
, 9, 8, 9) | cget_field1(insn, 8, 10, 10)

319 | 
	`cgë_fõld1
(
ö¢
, 7, 6, 6) | cget_field1(insn, 6, 7, 7)

320 | 
	`cgë_fõld1
(
ö¢
, 3, 1, 3) | cget_field1(insn, 2, 5, 5),

324 
ös
->
is_bønch
 = 1;

325 
ös
->
bønch_ty≥
 = 
BRANCH_COND
;

326 
ös
->
ty≥
 = 
INS_TYPE_COND_BRANCH
;

327 
ös
->
has_§c1
 = 1;

328 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

329 
rs2
 = 0;

330 
imm
 = 
	`£xtc
(

331 
	`cgë_fõld1
(
ö¢
, 12, 8, 8) | cget_field1(insn, 10, 3, 4)

332 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 7) | cget_field1(insn, 3, 1, 2)

333 | 
	`cgë_fõld1
(
ö¢
, 2, 5, 5),

337 
ös
->
is_bønch
 = 1;

338 
ös
->
bønch_ty≥
 = 
BRANCH_COND
;

339 
ös
->
ty≥
 = 
INS_TYPE_COND_BRANCH
;

340 
ös
->
has_§c1
 = 1;

341 
rs1
 = ((
ö¢
 >> 7) & 7) | 8;

342 
rs2
 = 0;

343 
imm
 = 
	`£xtc
(

344 
	`cgë_fõld1
(
ö¢
, 12, 8, 8) | cget_field1(insn, 10, 3, 4)

345 | 
	`cgë_fõld1
(
ö¢
, 5, 6, 7) | cget_field1(insn, 3, 1, 2)

346 | 
	`cgë_fõld1
(
ö¢
, 2, 5, 5),

350 
ûÀgÆ_ö¢
;

352 
ös
->
rd
 =Ñd;

353 
ös
->
rs1
 =Ñs1;

354 
ös
->
rs2
 =Ñs2;

355 
ös
->
imm
 = imm;

356 
ös
->
quad
 = quad;

357 
ös
->
fun˘3
 = funct3;

358 
ös
->
fun˘4
 = funct4;

359 
ös
->
fun˘5
 = funct5;

361 
ûÀgÆ_ö¢
:

362 
ös
->
ex˚±i⁄
 = 1;

363 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_ILLEGAL_OPCODE
;

364 
	}
}

367 
	$decode_com¥es£d_q2
(
RVIn°ru˘i⁄
 *
ös
)

369 
uöt32_t
 
ö¢
, 
rd
, 
rs1
, 
rs2
, 
fun˘3
, 
quad
;

370 
öt32_t
 
imm
 = 0;

372 
ö¢
 = 
ös
->
bö¨y
;

373 
quad
 = 
C_QUADRANT2
;

374 
fun˘3
 = (
ö¢
 >> 13) & 7;

375 
rd
 = (
ö¢
 >> 7) & 0x1f;

376 
rs1
 = 
rd
;

377 
rs2
 = (
ö¢
 >> 2) & 0x1f;

378 
fun˘3
)

381 
ös
->
has_de°
 = 1;

382 
ös
->
has_§c1
 = 1;

383 
rs1
 = 
rd
;

384 
imm
 = 
	`cgë_fõld1
(
ö¢
, 12, 5, 5Ë| 
rs2
;

385 #i‡
XLEN
 == 32

386 i‡(
imm
 & 0x20)

387 
ûÀgÆ_ö¢
;

390 #i‡
SIM_FLEN
 >= 64

393 
ös
->
is_lﬂd
 = 1;

394 
ös
->
has_Â_de°
 = 1;

395 
ös
->
has_§c1
 = 1;

396 
ös
->
byãs_to_rw
 = 8;

397 
ös
->
f64_mask
 = 1;

398 
ös
->
£t_fs
 = 1;

399 
ös
->
ty≥
 = 
INS_TYPE_FP_LOAD
;

400 
rs1
 = 2;

401 
imm
 = 
	`cgë_fõld1
(
ö¢
, 12, 5, 5Ë| (
rs2
 & (3 << 3))

402 | 
	`cgë_fõld1
(
ö¢
, 2, 6, 8);

408 
ös
->
is_lﬂd
 = 1;

409 
ös
->
byãs_to_rw
 = 4;

410 
ös
->
has_de°
 = 1;

411 
ös
->
has_§c1
 = 1;

412 
ös
->
ty≥
 = 
INS_TYPE_LOAD
;

413 
rs1
 = 2;

414 
imm
 = 
	`cgë_fõld1
(
ö¢
, 12, 5, 5Ë| (
rs2
 & (7 << 2))

415 | 
	`cgë_fõld1
(
ö¢
, 2, 6, 7);

418 #i‡
	`deföed
(
RV64
)

421 
ös
->
is_lﬂd
 = 1;

422 
ös
->
byãs_to_rw
 = 8;

423 
ös
->
has_de°
 = 1;

424 
ös
->
has_§c1
 = 1;

425 
ös
->
ty≥
 = 
INS_TYPE_LOAD
;

426 
rs1
 = 2;

427 
imm
 = 
	`cgë_fõld1
(
ö¢
, 12, 5, 5Ë| (
rs2
 & (3 << 3))

428 | 
	`cgë_fõld1
(
ö¢
, 2, 6, 8);

431 #ñi‡
SIM_FLEN
 >= 32

434 
ös
->
is_lﬂd
 = 1;

435 
ös
->
has_Â_de°
 = 1;

436 
ös
->
has_§c1
 = 1;

437 
ös
->
byãs_to_rw
 = 4;

438 
ös
->
f32_mask
 = 1;

439 
ös
->
£t_fs
 = 1;

440 
ös
->
ty≥
 = 
INS_TYPE_FP_LOAD
;

441 
rs1
 = 2;

442 
imm
 = 
	`cgë_fõld1
(
ö¢
, 12, 5, 5Ë| (
rs2
 & (7 << 2))

443 | 
	`cgë_fõld1
(
ö¢
, 2, 6, 7);

448 i‡(((
ö¢
 >> 12) & 1) == 0)

450 i‡(
rs2
 == 0)

453 
ös
->
is_bønch
 = 1;

454 
ös
->
bønch_ty≥
 = 
BRANCH_UNCOND
;

455 
ös
->
ty≥
 = 
INS_TYPE_JALR
;

456 
ös
->
has_§c1
 = 1;

457 i‡(
rd
 == 0)

458 
ûÀgÆ_ö¢
;

459 i‡(
rs1
 == 1)

461 
ös
->
is_func_ªt
 = 1;

467 
ös
->
has_de°
 = 1;

468 
ös
->
has_§c2
 = 1;

473 i‡(
rs2
 == 0)

475 i‡(
rd
 == 0)

478 
ös
->
ex˚±i⁄
 = 1;

479 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_COMPLEX_OPCODE
;

480 
ös
->
ty≥
 = 
INS_TYPE_SYSTEM
;

485 
ös
->
is_bønch
 = 1;

486 
ös
->
bønch_ty≥
 = 
BRANCH_UNCOND
;

487 
ös
->
ty≥
 = 
INS_TYPE_JALR
;

488 
ös
->
has_de°
 = 1;

489 
ös
->
has_§c1
 = 1;

490 
rd
 = 1;

491 
ös
->
is_func_ˇŒ
 = 1;

497 
ös
->
has_de°
 = 1;

498 
ös
->
has_§c1
 = 1;

499 
ös
->
has_§c2
 = 1;

503 #i‡
SIM_FLEN
 >= 64

505 
ös
->
is_°‹e
 = 1;

506 
ös
->
has_§c1
 = 1;

507 
ös
->
has_Â_§c2
 = 1;

508 
ös
->
byãs_to_rw
 = 8;

509 
ös
->
ty≥
 = 
INS_TYPE_FP_STORE
;

510 
rs1
 = 2;

511 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 7, 6, 8);

515 
ös
->
is_°‹e
 = 1;

516 
ös
->
byãs_to_rw
 = 4;

517 
ös
->
has_§c1
 = 1;

518 
ös
->
has_§c2
 = 1;

519 
ös
->
ty≥
 = 
INS_TYPE_STORE
;

520 
rs1
 = 2;

521 
imm
 = 
	`cgë_fõld1
(
ö¢
, 9, 2, 5) | cget_field1(insn, 7, 6, 7);

523 #i‡
	`deföed
(
RV64
)

525 
ös
->
is_°‹e
 = 1;

526 
ös
->
byãs_to_rw
 = 8;

527 
ös
->
has_§c1
 = 1;

528 
ös
->
has_§c2
 = 1;

529 
ös
->
ty≥
 = 
INS_TYPE_STORE
;

530 
rs1
 = 2;

531 
imm
 = 
	`cgë_fõld1
(
ö¢
, 10, 3, 5) | cget_field1(insn, 7, 6, 8);

533 #ñi‡
SIM_FLEN
 >= 32

535 
ös
->
is_°‹e
 = 1;

536 
ös
->
has_§c1
 = 1;

537 
ös
->
has_Â_§c2
 = 1;

538 
ös
->
byãs_to_rw
 = 4;

539 
ös
->
ty≥
 = 
INS_TYPE_FP_STORE
;

540 
rs1
 = 2;

541 
imm
 = 
	`cgë_fõld1
(
ö¢
, 9, 2, 5) | cget_field1(insn, 7, 6, 7);

545 
ûÀgÆ_ö¢
;

547 
ös
->
rd
 =Ñd;

548 
ös
->
rs1
 =Ñs1;

549 
ös
->
rs2
 =Ñs2;

550 
ös
->
imm
 = imm;

551 
ös
->
quad
 = quad;

552 
ös
->
fun˘3
 = funct3;

554 
ûÀgÆ_ö¢
:

555 
ös
->
ex˚±i⁄
 = 1;

556 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_ILLEGAL_OPCODE
;

557 
	}
}

560 
	$decode_com¥es£d_ty≥
(
RVIn°ru˘i⁄
 *
ös
)

562 
quad
 = 
ös
->
bö¨y
 & 3;

563 
quad
)

567 
	`decode_com¥es£d_q0
(
ös
);

572 
	`decode_com¥es£d_q1
(
ös
);

577 
	`decode_com¥es£d_q2
(
ös
);

582 
	`exô
(1);

585 
	}
}

588 
	$£t_›_fu
(
RVIn°ru˘i⁄
 *
i
)

590 
uöt32_t
 
fun˘3
;

591 
uöt32_t
 
ö¢
 = 
i
->
bö¨y
;

592 
öt32_t
 
imm
 = 
ö¢
 >> 25;

593 i‡(
imm
 == 1)

595 
fun˘3
 = (
ö¢
 >> 12) & 7;

596 
fun˘3
)

602 
i
->
fu_ty≥
 = 
FU_MUL
;

603 
i
->
ty≥
 = 
INS_TYPE_INT_MUL
;

609 
i
->
fu_ty≥
 = 
FU_DIV
;

610 
i
->
ty≥
 = 
INS_TYPE_INT_DIV
;

614 
	}
}

617 
	$chk_›_imm_ex˚±i⁄s
(
RVIn°ru˘i⁄
 *
i
, 
uöt32_t
 
bô_size
)

619 
uöt32_t
 
fun˘3
 = (
i
->
bö¨y
 >> 12) & 7;

621 
fun˘3
)

624 i‡((
i
->
imm
 & ~(
bô_size
 - 1)) != 0)

630 i‡((
i
->
imm
 & ~((
bô_size
 - 1) | 0x400)) != 0)

636 
	}
}

639 
	$chk_›_ex˚±i⁄s
(
RVIn°ru˘i⁄
 *
i
)

641 
öt32_t
 
imm
 = 
i
->
bö¨y
 >> 25;

643 i‡(
imm
 != 1)

645 i‡(
imm
 & ~0x20)

651 
	}
}

658 
	$decode_riscv_bö¨y
(
RVIn°ru˘i⁄
 *
ös
, 
uöt32_t
 
ö¢
)

660 
ös
->
bö¨y
 = 
ö¢
;

661 
ös
->
fu_ty≥
 = 
FU_ALU
;

662 
ös
->
d©a_˛ass
 = 
INS_CLASS_INT
;

663 
ös
->
ty≥
 = 
INS_TYPE_ARITMETIC
;

664 i‡((
ös
->
bö¨y
 & 3) != 3)

667 
	`decode_com¥es£d_ty≥
(
ös
);

672 
ös
->
maj‹_›code
 = 
ö¢
 & 0x7f;

673 
ös
->
fun˘3
 = (
ö¢
 >> 12) & 7;

674 
ös
->
fun˘7
 = (ös->
bö¨y
 & 0xfe000000) >> 25;

675 
ös
->
rd
 = (
ö¢
 >> 7) & 0x1f;

676 
ös
->
rs1
 = (
ö¢
 >> 15) & 0x1f;

677 
ös
->
rs2
 = (
ö¢
 >> 20) & 0x1f;

678 
ös
->
maj‹_›code
)

680 
LOAD_MASK
:

682 
ös
->
is_lﬂd
 = 1;

683 
ös
->
has_§c1
 = 1;

684 
ös
->
has_de°
 = 1;

685 
ös
->
imm
 = (
öt32_t
)
ö¢
 >> 20;

686 
ös
->
ty≥
 = 
INS_TYPE_LOAD
;

687 
ös
->
fun˘3
)

691 
ös
->
byãs_to_rw
 = 1;

696 
ös
->
byãs_to_rw
 = 2;

701 
ös
->
byãs_to_rw
 = 4;

704 #i‡
	`deföed
(
RV64
)

707 
ös
->
byãs_to_rw
 = 8;

713 
ös
->
byãs_to_rw
 = 1;

714 
ös
->
is_unsig√d
 = 1;

719 
ös
->
byãs_to_rw
 = 2;

720 
ös
->
is_unsig√d
 = 1;

725 
ös
->
byãs_to_rw
 = 4;

726 
ös
->
is_unsig√d
 = 1;

732 
OP_IMM_MASK
:

733 
OP_IMM_32_MASK
:

735 i‡(
ös
->
maj‹_›code
 =
OP_IMM_MASK
)

737 i‡(
	`chk_›_imm_ex˚±i⁄s
(
ös
, 
BIT_SIZE
))

739 
ex˚±i⁄
;

744 i‡(
	`chk_›_imm_ex˚±i⁄s
(
ös
, 32))

746 
ex˚±i⁄
;

750 
ös
->
has_§c1
 = 1;

751 
ös
->
has_de°
 = 1;

752 
ös
->
imm
 = (
öt32_t
)
ö¢
 >> 20;

755 
OP_MASK
:

756 
OP_MASK_32
:

758 i‡(
	`chk_›_ex˚±i⁄s
(
ös
))

760 
ex˚±i⁄
;

763 
ös
->
has_§c1
 = 1;

764 
ös
->
has_§c2
 = 1;

765 
ös
->
has_de°
 = 1;

767 
	`£t_›_fu
(
ös
);

770 
LUI_MASK
:

771 
AUIPC_MASK
:

773 
ös
->
has_de°
 = 1;

774 
ös
->
imm
 = (
öt32_t
)(
ö¢
 & 0xfffff000);

777 
STORE_MASK
:

779 
ös
->
is_°‹e
 = 1;

780 
ös
->
has_§c1
 = 1;

781 
ös
->
has_§c2
 = 1;

782 
ös
->
imm
 = ins->
rd
 | ((
ö¢
 >> (25 - 5)) & 0xfe0);

783 
ös
->
imm
 = (ins->imm << 20) >> 20;

784 
ös
->
ty≥
 = 
INS_TYPE_STORE
;

785 
ös
->
fun˘3
)

789 
ös
->
byãs_to_rw
 = 1;

794 
ös
->
byãs_to_rw
 = 2;

799 
ös
->
byãs_to_rw
 = 4;

802 #i‡
	`deföed
(
RV64
)

805 
ös
->
byãs_to_rw
 = 8;

812 
CSR_MASK
:

814 
ös
->
is_sy°em
 = 1;

815 
ös
->
ex˚±i⁄
 = 1;

816 
ös
->
ty≥
 = 
INS_TYPE_SYSTEM
;

819 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_COMPLEX_OPCODE
;

822 
FENCE_MASK
:

824 
ös
->
is_sy°em
 = 1;

825 
ös
->
ex˚±i⁄
 = 1;

826 
ös
->
ty≥
 = 
INS_TYPE_SYSTEM
;

829 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_COMPLEX_OPCODE
;

833 
JAL_MASK
:

835 
ös
->
is_bønch
 = 1;

836 
ös
->
bønch_ty≥
 = 
BRANCH_UNCOND
;

837 
ös
->
has_de°
 = 1;

838 
ös
->
imm
 = ((
ö¢
 >> (31 - 20)) & (1 << 20))

839 | ((
ö¢
 >> (21 - 1)) & 0x7fe)

840 | ((
ö¢
 >> (20 - 11)) & (1 << 11))

841 | (
ö¢
 & 0xff000);

842 
ös
->
imm
 = (ins->imm << 11) >> 11;

843 
ös
->
ty≥
 = 
INS_TYPE_JAL
;

844 i‡(
ös
->
rd
 == 1)

846 
ös
->
is_func_ˇŒ
 = 1;

850 
JALR_MASK
:

852 
ös
->
is_bønch
 = 1;

853 
ös
->
bønch_ty≥
 = 
BRANCH_UNCOND
;

854 
ös
->
has_§c1
 = 1;

855 
ös
->
has_de°
 = 1;

856 
ös
->
imm
 = (
öt32_t
)
ö¢
 >> 20;

857 
ös
->
ty≥
 = 
INS_TYPE_JALR
;

858 i‡(
ös
->
rd
 == 1)

860 
ös
->
is_func_ˇŒ
 = 1;

862 i‡(
ös
->
rs1
 == 1)

864 
ös
->
is_func_ªt
 = 1;

868 
BRANCH_MASK
:

870 
ös
->
is_bønch
 = 1;

871 
ös
->
bønch_ty≥
 = 
BRANCH_COND
;

872 
ös
->
has_§c1
 = 1;

873 
ös
->
has_§c2
 = 1;

874 
ös
->
imm
 = ((
ö¢
 >> (31 - 12)) & (1 << 12))

875 | ((
ö¢
 >> (25 - 5)) & 0x7e0)

876 | ((
ö¢
 >> (8 - 1)) & 0x1e)

877 | ((
ö¢
 << (11 - 7)) & (1 << 11));

878 
ös
->
imm
 = (ins->imm << 19) >> 19;

879 
ös
->
ty≥
 = 
INS_TYPE_COND_BRANCH
;

882 
ATOMIC_MASK
:

884 
uöt32_t
 
fun˘3
;

886 
ös
->
is_©omic
 = 1;

887 
ös
->
has_de°
 = 1;

888 
ös
->
ty≥
 = 
INS_TYPE_ATOMIC
;

889 
fun˘3
 = (
ö¢
 >> 12) & 7;

890 
fun˘3
)

893 #i‡
BIT_SIZE
 >= 64

897 
fun˘3
 = 
ös
->
bö¨y
 >> 27;

898 
fun˘3
)

902 i‡(
ös
->
rs2
 != 0)

903 
ex˚±i⁄
;

904 
ös
->
has_§c1
 = 1;

905 
ös
->
is_©omic_lﬂd
 = 1;

906 
ös
->
byãs_to_rw
 = (
èrgë_ul⁄g
);

911 
ös
->
has_§c1
 = 1;

912 
ös
->
has_§c2
 = 1;

913 
ös
->
is_©omic_°‹e
 = 1;

914 
ös
->
byãs_to_rw
 = (
èrgë_ul⁄g
);

927 
ös
->
has_§c1
 = 1;

928 
ös
->
has_§c2
 = 1;

929 
ös
->
is_©omic_›î©e
 = 1;

930 
ös
->
is_©omic_lﬂd
 = 1;

931 
ös
->
is_©omic_°‹e
 = 1;

932 
ös
->
byãs_to_rw
 = (
èrgë_ul⁄g
);

936 
ex˚±i⁄
;

941 
ex˚±i⁄
;

945 
FLOAD_MASK
:

947 i‡(
ös
->
cuºít_fs
 == 0)

949 
ex˚±i⁄
;

951 
ös
->
is_lﬂd
 = 1;

952 
ös
->
has_Â_de°
 = 1;

953 
ös
->
has_§c1
 = 1;

954 
ös
->
£t_fs
 = 1;

955 
ös
->
imm
 = (
öt32_t
)
ö¢
 >> 20;

956 
ös
->
ty≥
 = 
INS_TYPE_FP_LOAD
;

957 
ös
->
fun˘3
)

961 
ös
->
byãs_to_rw
 = 4;

962 
ös
->
f32_mask
 = 1;

965 #i‡
SIM_FLEN
 >= 64

968 
ös
->
byãs_to_rw
 = 8;

969 
ös
->
f64_mask
 = 1;

976 
FSTORE_MASK
:

978 i‡(
ös
->
cuºít_fs
 == 0)

980 
ex˚±i⁄
;

982 
ös
->
is_°‹e
 = 1;

983 
ös
->
has_§c1
 = 1;

984 
ös
->
has_Â_§c2
 = 1;

985 
ös
->
imm
 = ins->
rd
 | ((
ö¢
 >> (25 - 5)) & 0xfe0);

986 
ös
->
imm
 = (ins->imm << 20) >> 20;

987 
ös
->
ty≥
 = 
INS_TYPE_FP_STORE
;

988 
ös
->
fun˘3
)

991 
ös
->
byãs_to_rw
 = 4;

993 #i‡
SIM_FLEN
 >= 64

996 
ös
->
byãs_to_rw
 = 8;

1001 
FMADD_MASK
:

1003 i‡((
ös
->
cuºít_fs
 =0Ë|| (ös->
rm
 < 0))

1005 
ex˚±i⁄
;

1007 
ös
->
d©a_˛ass
 = 
INS_CLASS_FP
;

1008 
ös
->
fu_ty≥
 = 
FU_FPU_FMA
;

1009 
ös
->
ty≥
 = 
INS_TYPE_FP_FMA
;

1010 
ös
->
has_Â_de°
 = 1;

1011 
ös
->
has_Â_§c1
 = 1;

1012 
ös
->
has_Â_§c2
 = 1;

1013 
ös
->
has_Â_§c3
 = 1;

1014 
ös
->
£t_fs
 = 1;

1015 
ös
->
fun˘3
 = (ös->
bö¨y
 >> 25) & 3;

1016 
ös
->
rs3
 = ins->
bö¨y
 >> 27;

1019 
FMSUB_MASK
:

1021 i‡((
ös
->
cuºít_fs
 =0Ë|| (ös->
rm
 < 0))

1023 
ex˚±i⁄
;

1025 
ös
->
d©a_˛ass
 = 
INS_CLASS_FP
;

1026 
ös
->
fu_ty≥
 = 
FU_FPU_FMA
;

1027 
ös
->
ty≥
 = 
INS_TYPE_FP_FMA
;

1028 
ös
->
has_Â_de°
 = 1;

1029 
ös
->
has_Â_§c1
 = 1;

1030 
ös
->
has_Â_§c2
 = 1;

1031 
ös
->
has_Â_§c3
 = 1;

1032 
ös
->
£t_fs
 = 1;

1033 
ös
->
fun˘3
 = (ös->
bö¨y
 >> 25) & 3;

1034 
ös
->
rs3
 = ins->
bö¨y
 >> 27;

1037 
FNMSUB_MASK
:

1039 i‡((
ös
->
cuºít_fs
 =0Ë|| (ös->
rm
 < 0))

1041 
ex˚±i⁄
;

1043 
ös
->
d©a_˛ass
 = 
INS_CLASS_FP
;

1044 
ös
->
fu_ty≥
 = 
FU_FPU_FMA
;

1045 
ös
->
ty≥
 = 
INS_TYPE_FP_FMA
;

1046 
ös
->
has_Â_de°
 = 1;

1047 
ös
->
has_Â_§c1
 = 1;

1048 
ös
->
has_Â_§c2
 = 1;

1049 
ös
->
has_Â_§c3
 = 1;

1050 
ös
->
£t_fs
 = 1;

1051 
ös
->
fun˘3
 = (ös->
bö¨y
 >> 25) & 3;

1052 
ös
->
rs3
 = ins->
bö¨y
 >> 27;

1055 
FNMADD_MASK
:

1057 i‡((
ös
->
cuºít_fs
 =0Ë|| (ös->
rm
 < 0))

1059 
ex˚±i⁄
;

1061 
ös
->
d©a_˛ass
 = 
INS_CLASS_FP
;

1062 
ös
->
fu_ty≥
 = 
FU_FPU_FMA
;

1063 
ös
->
ty≥
 = 
INS_TYPE_FP_FMA
;

1064 
ös
->
has_Â_de°
 = 1;

1065 
ös
->
has_Â_§c1
 = 1;

1066 
ös
->
has_Â_§c2
 = 1;

1067 
ös
->
has_Â_§c3
 = 1;

1068 
ös
->
£t_fs
 = 1;

1069 
ös
->
fun˘3
 = (ös->
bö¨y
 >> 25) & 3;

1070 
ös
->
rs3
 = ins->
bö¨y
 >> 27;

1073 
F_ARITHMETIC_MASK
:

1075 i‡(
ös
->
cuºít_fs
 == 0)

1077 
ex˚±i⁄
;

1079 
ös
->
d©a_˛ass
 = 
INS_CLASS_FP
;

1080 
ös
->
fu_ty≥
 = 
FU_FPU_ALU
;

1081 
ös
->
rm
 = ins->
fun˘3
;

1082 
ös
->
ty≥
 = 
INS_TYPE_FP_MISC
;

1083 
ös
->
fun˘7
)

1085 
	#F_SIZE
 32

	)

1086 
	~"decode_Âa_ãm∂©e.h
"

1087 #i‡
SIM_FLEN
 >= 64

1088 
	#F_SIZE
 64

	)

1089 
	~"decode_Âa_ãm∂©e.h
"

1092 
ex˚±i⁄
;

1098 
ex˚±i⁄
;

1104 i‡(
ös
->
¸óã_°r
)

1106 
	`gë_riscv_ös_°r
(
ös
);

1109 
ex˚±i⁄
:

1110 
ös
->
ex˚±i⁄
 = 1;

1111 
ös
->
ex˚±i⁄_ˇu£
 = 
SIM_ILLEGAL_OPCODE
;

1112 
	}
}

	@riscvsim/riscv_isa_decoder_lib.h

30 #i‚de‡
_RISCV_ISA_DECODER_LIB_H_


31 
	#_RISCV_ISA_DECODER_LIB_H_


	)

33 
	~<öây≥s.h
>

35 
	~"riscv_ö°ru˘i⁄.h
"

37 
decode_riscv_bö¨y
(
RVIn°ru˘i⁄
 *, 
uöt32_t
);

	@riscvsim/riscv_sim_cpu.c

30 
	~<time.h
>

32 
	~"riscv_sim_˝u.h
"

33 
	~"ö‹dî.h
"

34 
	~"ooo.h
"

36 
RISCVSIMCPUSèã
 *

37 
	$riscv_sim_˝u_öô
(c⁄° 
SimP¨ams
 *
p
, 
RISCVCPUSèã
 *
s
)

39 
RISCVSIMCPUSèã
 *
sim˝u
;

41 
sim˝u
 = 
	`ˇŒoc
(1, (
RISCVSIMCPUSèã
));

42 
	`as£π
(
sim˝u
);

44 
sim˝u
->
emu_˝u_°©e
 = 
s
;

45 
sim˝u
->
pc
 = 0x1000;

46 
sim˝u
->
˛ock
 = 0;

47 
sim˝u
->
∑øms
 = (
SimP¨ams
 *)
p
;

49 
sim˝u
->
°©s
 = (
SimSèts
 *)
	`ˇŒoc
(
NUM_MAX_PRV_LEVELS
, (SimStats));

50 
	`as£π
(
sim˝u
->
°©s
 !
NULL
);

52 
sim˝u
->
im≠
 = (
IM≠E¡ry
 *)
	`ˇŒoc
(
NUM_IMAP_ENTRY
, (IMapEntry));

53 
	`as£π
(
sim˝u
->
im≠
);

55 
	`PRINT_PROG_TITLE_MSG
("MARSS-RISCV: Micro-Architectural System Simulator for RISC-V");

56 
sim˝u
->
mmu
 = 
	`mmu_öô
(sim˝u->
∑øms
);

59 
	`§™d
(
	`time
(
NULL
));

61 
sim˝u
->
p‚_bønch_h™dÀr
 = 
NULL
;

62 
sim˝u
->
p‚_bønch_‰⁄ãnd_¥obe_h™dÀr
 = 
NULL
;

64 i‡(
p
->
íabÀ_bpu
)

66 
	`PRINT_INIT_MSG
("Setting up branchÖrediction unit");

67 
sim˝u
->
bpu
 = 
	`bpu_öô
(
p
, sim˝u->
°©s
);

68 
sim˝u
->
p‚_bønch_h™dÀr
 = &
h™dÀ_bønch_wôh_bpu
;

69 
sim˝u
->
p‚_bønch_‰⁄ãnd_¥obe_h™dÀr
 = &
h™dÀ_bpu_‰⁄ãnd_¥obe
;

70 
sim˝u
->
p‚_bønch_‰⁄ãnd_decode_h™dÀr


71 &
h™dÀ_bønch_decode_wôh_bpu
;

75 
sim˝u
->
p‚_bønch_h™dÀr
 = &
h™dÀ_bønch_no_bpu
;

76 
sim˝u
->
p‚_bønch_‰⁄ãnd_¥obe_h™dÀr


77 &
h™dÀ_no_bpu_‰⁄ãnd_¥obe
;

78 
sim˝u
->
p‚_bønch_‰⁄ãnd_decode_h™dÀr


79 &
h™dÀ_bønch_decode_no_bpu
;

82 
p
->
c‹e_ty≥
)

84 
CORE_TYPE_INCORE
:

86 
	`PRINT_INIT_MSG
("Setting up in-order core");

87 
sim˝u
->
c‹e
 = (*)
	`ö_c‹e_öô
(sim˝u->
∑øms
, simcpu);

88 
sim˝u
->
p‚_c‹e_ª£t
 = 
ö_c‹e_ª£t
;

89 
sim˝u
->
p‚_c‹e_run
 = 
ö_c‹e_run
;

90 
sim˝u
->
p‚_c‹e_‰ì
 = 
ö_c‹e_‰ì
;

93 
CORE_TYPE_OOCORE
:

95 
	`PRINT_INIT_MSG
("Setting up out-of-order core");

96 
sim˝u
->
c‹e
 = (*)
	`oo_c‹e_öô
(sim˝u->
∑øms
, simcpu);

97 
sim˝u
->
p‚_c‹e_ª£t
 = 
oo_c‹e_ª£t
;

98 
sim˝u
->
p‚_c‹e_run
 = 
oo_c‹e_run
;

99 
sim˝u
->
p‚_c‹e_‰ì
 = 
oo_c‹e_‰ì
;

104 
	`sim_∑øms_¥öt
(
p
);

105  
sim˝u
;

106 
	}
}

109 
	$riscv_sim_˝u_ª£t
(
RISCVSIMCPUSèã
 *
sim˝u
)

111 
	`ª£t_im≠
(
sim˝u
->
im≠
);

112 
	`mem_c⁄åﬁÀr_ª£t
(
sim˝u
->
mmu
->
mem_c⁄åﬁÀr
);

113 
sim˝u
->
	`p‚_c‹e_ª£t
(sim˝u->
c‹e
);

114 
	}
}

117 
	$riscv_sim_˝u_run
(
RISCVSIMCPUSèã
 *
sim˝u
)

119  
sim˝u
->
	`p‚_c‹e_run
(sim˝u->
c‹e
);;

120 
	}
}

123 
	$riscv_sim_˝u_‰ì
(
RISCVSIMCPUSèã
 **
sim˝u
)

125 
	`‰ì
((*
sim˝u
)->
°©s
);

126 (*
sim˝u
)->
°©s
 = 
NULL
;

128 
	`‰ì
((*
sim˝u
)->
im≠
);

129 (*
sim˝u
)->
im≠
 = 
NULL
;

131 
	`mmu_‰ì
(&((*
sim˝u
)->
mmu
));

133 i‡((*
sim˝u
)->
∑øms
->
íabÀ_bpu
)

135 
	`bpu_‰ì
(&((*
sim˝u
)->
bpu
));

138 (*
sim˝u
)->
	`p‚_c‹e_‰ì
(&(*sim˝u)->
c‹e
);

140 
	`‰ì
(*
sim˝u
);

141 
	}
}

	@riscvsim/riscv_sim_cpu.h

30 #i‚de‡
_RISCV_SIM_CPU_H_


31 
	#_RISCV_SIM_CPU_H_


	)

33 
	~"sim_∑øms_°©s.h
"

34 
	~"bpu.h
"

35 
	~"mmu.h
"

36 
	~"riscv_sim_ty≥defs.h
"

37 
	~"comm⁄_c‹e_utûs.h
"

40 
	gRISCVCPUSèã
;

42 
	sRISCVSIMCPUSèã


45 
èrgë_ul⁄g
 
	mpc
;

46 
uöt64_t
 
	m˛ock
;

47 
IM≠E¡ry
 *
	mim≠
;

48 
SimSèts
 *
	m°©s
;

49 
SimP¨ams
 *
	m∑øms
;

50 
BønchPªdUnô
 *
	mbpu
;

51 (*
	mp‚_bønch_h™dÀr
)(
	mRISCVCPUSèã
 *, 
	mIM≠E¡ry
 *);

52 (*
	mp‚_bønch_‰⁄ãnd_¥obe_h™dÀr
)(
	mRISCVCPUSèã
 *,
	mIM≠E¡ry
 *);

53 (*
	mp‚_bønch_‰⁄ãnd_decode_h™dÀr
)(
	mRISCVCPUSèã
 *, 
	mIM≠E¡ry
 *);

55 
MMU
 *
	mmmu
;

57 
SimTø˚Packë
 
	msim_åa˚_pkt
;

60 * 
	mc‹e
;

61 (*
	mp‚_c‹e_ª£t
)(*
	mc‹e
);

62 (*
	mp‚_c‹e_run
)(*
	mc‹e
);

63 (*
	mp‚_c‹e_‰ì
)(*
	mc‹e
);

65 
RISCVCPUSèã
 *
	memu_˝u_°©e
;

66 } 
	tRISCVSIMCPUSèã
;

68 
RISCVSIMCPUSèã
 *
riscv_sim_˝u_öô
(c⁄° 
SimP¨ams
 *
p
, 
RISCVCPUSèã
 *
s
);

69 
riscv_sim_˝u_ª£t
(
RISCVSIMCPUSèã
 *
sim˝u
);

70 
riscv_sim_˝u_run
(
RISCVSIMCPUSèã
 *
sim˝u
);

71 
riscv_sim_˝u_‰ì
(
RISCVSIMCPUSèã
 **
sim˝u
);

	@riscvsim/riscv_sim_macros.h

32 #i‚de‡
_RISCV_SIM_MACROS_H_


33 
	#_RISCV_SIM_MACROS_H_


	)

36 
	#FU_ALU
 0x0

	)

37 
	#FU_MUL
 0x1

	)

38 
	#FU_DIV
 0x2

	)

39 
	#FU_FPU_ALU
 0x3

	)

40 
	#FU_FPU_FMA
 0x4

	)

41 
	#NUM_MAX_FU
 5

	)

44 
	#BRANCH_UNCOND
 0x0

	)

45 
	#BRANCH_COND
 0x1

	)

46 
	#BRANCH_FUNC_CALL
 0x2

	)

47 
	#BRANCH_FUNC_RET
 0x3

	)

50 
	#C_QUADRANT0
 0

	)

51 
	#C_QUADRANT1
 1

	)

52 
	#C_QUADRANT2
 2

	)

55 
	#OP_IMM_MASK
 0x13

	)

56 
	#OP_IMM_32_MASK
 0x1b

	)

57 
	#OP_MASK
 0x33

	)

58 
	#OP_MASK_32
 0x3b

	)

59 
	#LUI_MASK
 0x37

	)

60 
	#AUIPC_MASK
 0x17

	)

61 
	#JAL_MASK
 0x6f

	)

62 
	#JALR_MASK
 0x67

	)

63 
	#BRANCH_MASK
 0x63

	)

64 
	#LOAD_MASK
 0x3

	)

65 
	#STORE_MASK
 0x23

	)

66 
	#FENCE_MASK
 0xf

	)

67 
	#CSR_MASK
 0x73

	)

68 
	#ATOMIC_MASK
 0x2F

	)

71 
	#FLOAD_MASK
 0x07

	)

72 
	#FSTORE_MASK
 0x27

	)

73 
	#FMADD_MASK
 0x43

	)

74 
	#FMSUB_MASK
 0x47

	)

75 
	#FNMSUB_MASK
 0x4B

	)

76 
	#FNMADD_MASK
 0x4F

	)

77 
	#F_ARITHMETIC_MASK
 0x53

	)

80 
	#PCGEN
 0x0

	)

81 
	#FETCH
 0x1

	)

82 
	#DECODE
 0x2

	)

83 
	#MEMORY
 0x3

	)

84 
	#COMMIT
 0x4

	)

86 
	#NUM_CPU_STAGES
 5

	)

87 
	#NUM_INT_REG
 32

	)

88 
	#NUM_FP_REG
 32

	)

89 
	#NUM_FU
 5

	)

90 
	#NUM_FWD_BUS
 6

	)

91 
	#INCORE_NUM_INS_DISPATCH_QUEUE_ENTRY
 16

	)

92 
	#SPEC_REG_STATE_ENTRY
 128

	)

94 
	#RISCV_INS_STR_MAX_LENGTH
 64

	)

97 
	#NUM_IMAP_ENTRY
 128

	)

98 
	#IMAP_ENTRY_STATUS_FREE
 0

	)

99 
	#IMAP_ENTRY_STATUS_ALLOCATED
 1

	)

102 
	#PIPELINE_NOT_DRAINED
 0

	)

103 
	#PIPELINE_DRAINED
 1

	)

105 
	#NUM_MAX_PRV_LEVELS
 4

	)

109 
	#NUM_MAX_INS_TYPES
 17

	)

110 
	#INS_TYPE_LOAD
 0x0

	)

111 
	#INS_TYPE_STORE
 0x1

	)

112 
	#INS_TYPE_ATOMIC
 0x2

	)

113 
	#INS_TYPE_SYSTEM
 0x3

	)

114 
	#INS_TYPE_ARITMETIC
 0x4

	)

115 
	#INS_TYPE_COND_BRANCH
 0x5

	)

116 
	#INS_TYPE_JAL
 0x6

	)

117 
	#INS_TYPE_JALR
 0x7

	)

118 
	#INS_TYPE_INT_MUL
 0x8

	)

119 
	#INS_TYPE_INT_DIV
 0x9

	)

120 
	#INS_TYPE_FP_LOAD
 0xa

	)

121 
	#INS_TYPE_FP_STORE
 0xb

	)

122 
	#INS_TYPE_FP_ADD
 0xc

	)

123 
	#INS_TYPE_FP_MUL
 0xd

	)

124 
	#INS_TYPE_FP_FMA
 0xe

	)

125 
	#INS_TYPE_FP_DIV_SQRT
 0xf

	)

126 
	#INS_TYPE_FP_MISC
 0x10

	)

128 
	#INS_CLASS_INT
 0x11

	)

129 
	#INS_CLASS_FP
 0x12

	)

132 
	#BPU_MISS
 0x0

	)

133 
	#BPU_HIT
 0x1

	)

135 
	#GET_NUM_BITS
(
x
Ë
	`˚û
(
	`log2
((x)))

	)

136 
	#GET_INDEX
(
x
, 
bôs
Ë((xË& ((1 << (bôs)Ë- 1))

	)

137 
	#PRINT_INIT_MSG
(
°r
Ë
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m " så "...\n")

	)

138 
	#PRINT_PROG_TITLE_MSG
(
°r
Ë
	`Ârötf
(
°dîr
, "\x1B[32m\x1B[0m " så "\n\n")

	)

141 
	#SIM_ILLEGAL_OPCODE
 0x1

	)

142 
	#SIM_COMPLEX_OPCODE
 0x2

	)

143 
	#SIM_TIMEOUT_EXCEPTION
 0x3

	)

144 
	#SIM_MMU_EXCEPTION
 0x4

	)

146 
	#REALTIME_STATS_CLOCK_CYCLES_INTERVAL
 500000

	)

149 
	#FU_FPU_ALU_FADD
 0x0

	)

150 
	#FU_FPU_ALU_FSUB
 0x1

	)

151 
	#FU_FPU_ALU_FMUL
 0x2

	)

152 
	#FU_FPU_ALU_FDIV
 0x3

	)

153 
	#FU_FPU_ALU_FSQRT
 0x4

	)

154 
	#FU_FPU_ALU_FSGNJ
 0x5

	)

155 
	#FU_FPU_ALU_FMIN
 0x6

	)

156 
	#FU_FPU_ALU_FMAX
 0x7

	)

157 
	#FU_FPU_ALU_FEQ
 0x8

	)

158 
	#FU_FPU_ALU_FLT
 0x9

	)

159 
	#FU_FPU_ALU_FLE
 0xa

	)

160 
	#FU_FPU_ALU_FCVT
 0xb

	)

161 
	#FU_FPU_ALU_CVT
 0xc

	)

162 
	#FU_FPU_ALU_FMV
 0xd

	)

163 
	#FU_FPU_ALU_FCLASS
 0xe

	)

164 
	#MAX_FU_FPU_ALU_TYPES
 15

	)

	@riscvsim/riscv_sim_typedefs.h

32 #i‚de‡
_RISCV_SIM_TYPEDEFS_H_


33 
	#_RISCV_SIM_TYPEDEFS_H_


	)

35 
	~<öây≥s.h
>

37 #i‡
MAX_XLEN
 == 32

38 
	#RV32


	)

39 
	#BIT_SIZE
 32

	)

40 #ñi‡
MAX_XLEN
 == 64

41 
	#RV64


	)

42 
	#BIT_SIZE
 64

	)

45 
	#SIM_FLEN
 64

	)

47 #i‡
BIT_SIZE
 == 32

48 
öt32_t
 
	tèrgë_l⁄g
;

49 
uöt32_t
 
	tèrgë_ul⁄g
;

50 
	#TARGET_ULONG_FMT
 
PRIu32


	)

51 
	#TARGET_LONG_FMT
 
PRId32


	)

52 
	#TARGET_ULONG_SCN
 
SCNu32


	)

53 
	#TARGET_LONG_SCN
 
SCNd32


	)

54 
	#TARGET_ULONG_HEX
 
PRIx32


	)

56 #ñi‡
BIT_SIZE
 == 64

57 
öt64_t
 
	tèrgë_l⁄g
;

58 
uöt64_t
 
	tèrgë_ul⁄g
;

59 
	#TARGET_ULONG_FMT
 
PRIu64


	)

60 
	#TARGET_LONG_FMT
 
PRId64


	)

61 
	#TARGET_ULONG_SCN
 
SCNu64


	)

62 
	#TARGET_LONG_SCN
 
SCNd64


	)

63 
	#TARGET_ULONG_HEX
 
PRIx64


	)

67 
	~"riscv_sim_ma¸os.h
"

	@riscvsim/sim_params_stats.c

30 
	~"sim_∑øms_°©s.h
"

32 
	~<as£π.h
>

33 
	~<°dio.h
>

34 
	~<°dlib.h
>

35 
	~<°rög.h
>

36 
	~<time.h
>

38 c⁄° *
	gc‹e_ty≥_°r
[] = {"in-order", "out-of-order"};

39 c⁄° *
	gsim_∑øm_°©us
[] = {"false", "true"};

40 c⁄° *
	gˇche_evi˘_°r
[] = {"random", "lru"};

41 c⁄° *
	gˇche_ø_°r
[] = {"true", "false"};

42 c⁄° *
	gˇche_wa_°r
[] = {"true", "false"};

43 c⁄° *
	gˇche_wp_°r
[] = {"writeback", "writethrough"};

44 c⁄° *
	gbpu_ty≥_°r
[] = {"bimodal", "adaptive"};

45 c⁄° *
	gbtb_evi˘_°r
[] = {"random", "lru"};

46 c⁄° *
	gbpu_Æüsög_func_ty≥_°r
[] = {"xor", "and", "none"};

47 c⁄° *
	gmem_modñ_ty≥_°r
[] = {"base", "dramsim2"};

49 
SimP¨ams
 *

50 
	$sim_∑øms_öô
()

52 
SimP¨ams
 *
p
;

54 
p
 = 
	`ˇŒoc
(1, (
SimP¨ams
));

55 
	`as£π
(
p
);

57 
i
;

59 
p
->
c‹e_«me
 = 
	`°rdup
(
DEF_CORE_NAME
);

60 
	`as£π
(
p
->
c‹e_«me
);

62 
p
->
c‹e_ty≥
 = 
DEF_CORE_TYPE
;

64 
p
->
sim_°©s_∑th
 = 
	`°rdup
(
DEF_SIM_STATS_PATH
);

65 
	`as£π
(
p
->
sim_°©s_∑th
);

67 
p
->
sim_åa˚_fûe
 = 
	`°rdup
(
DEF_SIM_TRACE_FILE
);

68 
	`as£π
(
p
->
sim_åa˚_fûe
);

70 
p
->
num_˝u_°ages
 = 
DEF_NUM_STAGES
;

71 
p
->
íabÀ_∑øŒñ_fu
 = 
DEF_ENABLE_PARALLEL_FU
;

72 
p
->
°¨t_ö_sim
 = 
DEF_START_SIM
;

73 
p
->
íabÀ_°©s_di•œy
 = 
DEF_STATS_DISPLAY
;

74 
p
->
¸óã_ös_°r
 = 
DEF_CREATE_INS_STR
;

76 
p
->
éb_size
 = 
DEF_TLB_SIZE
;

77 
p
->
±e_rw_œãncy
 = 
DEF_PTE_RW_LATENCY
;

80 
p
->
num_Æu_°ages
 = 
DEF_NUM_ALU_STAGES
;

81 
p
->
Æu_°age_œãncy
 = (*)
	`mÆloc
((Ë*Ö->
num_Æu_°ages
);

82 
	`as£π
(
p
->
Æu_°age_œãncy
);

83 
i
 = 0; i < 
p
->
num_Æu_°ages
; ++i)

85 
p
->
Æu_°age_œãncy
[
i
] = 
DEF_STAGE_LATENCY
;

88 
p
->
num_mul_°ages
 = 
DEF_NUM_MUL_STAGES
;

89 
p
->
mul_°age_œãncy
 = (*)
	`mÆloc
((Ë*Ö->
num_mul_°ages
);

90 
	`as£π
(
p
->
mul_°age_œãncy
);

91 
i
 = 0; i < 
p
->
num_mul_°ages
; ++i)

93 
p
->
mul_°age_œãncy
[
i
] = 
DEF_STAGE_LATENCY
;

96 
p
->
num_div_°ages
 = 
DEF_NUM_DIV_STAGES
;

97 
p
->
div_°age_œãncy
 = (*)
	`mÆloc
((Ë*Ö->
num_div_°ages
);

98 
	`as£π
(
p
->
div_°age_œãncy
);

99 
i
 = 0; i < 
p
->
num_div_°ages
; ++i)

101 
p
->
div_°age_œãncy
[
i
] = 
DEF_STAGE_LATENCY
;

104 
p
->
num_Âu_Æu_°ages
 = 
DEF_NUM_FPU_ALU_STAGES
;

106 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FADD
] = 
DEF_STAGE_LATENCY
;

107 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSUB
] = 
DEF_STAGE_LATENCY
;

108 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMUL
] = 
DEF_STAGE_LATENCY
;

109 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FDIV
] = 
DEF_STAGE_LATENCY
;

110 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSQRT
] = 
DEF_STAGE_LATENCY
;

111 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSGNJ
] = 
DEF_STAGE_LATENCY
;

112 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMIN
] = 
DEF_STAGE_LATENCY
;

113 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMAX
] = 
DEF_STAGE_LATENCY
;

114 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FEQ
] = 
DEF_STAGE_LATENCY
;

115 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLT
] = 
DEF_STAGE_LATENCY
;

116 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLE
] = 
DEF_STAGE_LATENCY
;

117 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCVT
] = 
DEF_STAGE_LATENCY
;

118 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_CVT
] = 
DEF_STAGE_LATENCY
;

119 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMV
] = 
DEF_STAGE_LATENCY
;

120 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCLASS
] = 
DEF_STAGE_LATENCY
;

122 
p
->
num_Âu_fma_°ages
 = 
DEF_NUM_FPU_FMA_STAGES
;

123 
p
->
Âu_fma_°age_œãncy


124 (*)
	`mÆloc
((Ë* 
p
->
num_Âu_fma_°ages
);

125 
	`as£π
(
p
->
Âu_fma_°age_œãncy
);

126 
i
 = 0; i < 
p
->
num_Âu_fma_°ages
; ++i)

128 
p
->
Âu_fma_°age_œãncy
[
i
] = 
DEF_STAGE_LATENCY
;

132 
p
->
íabÀ_bpu
 = 
DEF_ENABLE_BPU
;

133 
p
->
btb_size
 = 
DEF_BTB_SIZE
;

134 
p
->
btb_ways
 = 
DEF_BTB_WAYS
;

135 
p
->
bht_size
 = 
DEF_BHT_SIZE
;

136 
p
->
øs_size
 = 
DEF_RAS_SIZE
;

137 
p
->
bpu_ty≥
 = 
DEF_BPU_TYPE
;

139 
p
->
bpu_ght_size
 = 
DEF_GHT_SIZE
;

140 
p
->
bpu_pht_size
 = 
DEF_PHT_SIZE
;

141 
p
->
bpu_hi°‹y_bôs
 = 
DEF_HISTORY_BITS
;

142 
p
->
bpu_Æüsög_func_ty≥
 = 
DEF_BPU_ALIAS_FUNC
;

143 
p
->
btb_evi˘i⁄_pﬁicy
 = 
DEF_BTB_EVICT_POLICY
;

146 
p
->
íabÀ_l1_ˇches
 = 
DEF_ENABLE_L1_CACHE
;

148 
p
->
l1_code_ˇche_ªad_œãncy
 = 
DEF_L1_CODE_CACHE_READ_LATENCY
;

149 
p
->
l1_code_ˇche_size
 = 
DEF_L1_CODE_CACHE_SIZE
;

150 
p
->
l1_code_ˇche_ways
 = 
DEF_L1_CODE_CACHE_WAYS
;

151 
p
->
l1_code_ˇche_evi˘
 = 
DEF_L1_CODE_CACHE_EVICT
;

153 
p
->
l1_d©a_ˇche_ªad_œãncy
 = 
DEF_L1_DATA_CACHE_READ_LATENCY
;

154 
p
->
l1_d©a_ˇche_wrôe_œãncy
 = 
DEF_L1_DATA_CACHE_WRITE_LATENCY
;

155 
p
->
l1_d©a_ˇche_size
 = 
DEF_L1_DATA_CACHE_SIZE
;

156 
p
->
l1_d©a_ˇche_ways
 = 
DEF_L1_DATA_CACHE_WAYS
;

157 
p
->
l1_d©a_ˇche_evi˘
 = 
DEF_L1_DATA_CACHE_EVICT
;

160 
p
->
íabÀ_l2_ˇche
 = 
DEF_ENABLE_L2_CACHE
;

161 
p
->
l2_sh¨ed_ˇche_ªad_œãncy
 = 
DEF_L2_CACHE_READ_LATENCY
;

162 
p
->
l2_sh¨ed_ˇche_wrôe_œãncy
 = 
DEF_L2_CACHE_WRITE_LATENCY
;

163 
p
->
l2_sh¨ed_ˇche_size
 = 
DEF_L2_CACHE_SIZE
;

164 
p
->
l2_sh¨ed_ˇche_ways
 = 
DEF_L2_CACHE_WAYS
;

165 
p
->
l2_sh¨ed_ˇche_evi˘
 = 
DEF_L2_CACHE_EVICT
;

168 
p
->
w‹ds_≥r_ˇche_löe
 = 
DEF_WORDS_PER_CACHE_LINE
;

169 
p
->
ˇche_ªad_Æloˇã_pﬁicy
 = 
DEF_CACHE_READ_ALLOC_POLICY
;

170 
p
->
ˇche_wrôe_Æloˇã_pﬁicy
 = 
DEF_CACHE_WRITE_ALLOC_POLICY
;

171 
p
->
ˇche_wrôe_pﬁicy
 = 
DEF_CACHE_WRITE_POLICY
;

174 
p
->
døm_bur°_size
 = 
DEF_DRAM_BURST_SIZE
;

175 
p
->
mem_ac˚ss_œãncy
 = 
DEF_MEM_ACCESS_LATENCY
;

177 
p
->
iq_size
 = 
DEF_IQ_SIZE
;

178 
p
->
iq_issue_p‹ts
 = 
DEF_IQ_ISSUE_PORTS
;

179 
p
->
rob_size
 = 
DEF_ROB_SIZE
;

180 
p
->
lsq_size
 = 
DEF_LSQ_SIZE
;

182 
p
->
mem_modñ_ty≥
 = 
DEF_MEM_MODEL
;

183 
p
->
dømsim_öi_fûe
 = 
	`°rdup
(
DEF_DRAMSIM_INI_FILE
);

184 
	`as£π
(
p
->
dømsim_öi_fûe
);

185 
p
->
dømsim_sy°em_öi_fûe
 = 
	`°rdup
(
DEF_DRAMSIM_SYSTEM_INI_FILE
);

186 
	`as£π
(
p
->
dømsim_sy°em_öi_fûe
);

187 
p
->
dømsim_°©s_dú
 = 
	`°rdup
(
DEF_DRAMSIM_STATS_DIR
);

188 
	`as£π
(
p
->
dømsim_°©s_dú
);

190 
p
->
Êush_sim_mem
 = 
DEF_FLUSH_SIM_MEM
;

191  
p
;

192 
	}
}

195 
	$¥öt_fu_c⁄fig
(c⁄° *
fu_num_°age_∑øm_«me
,

196 c⁄° *
fu_°age_œãncy_«me
, 
num_°ages
,

197 *
œãncõs
)

199 
i
;

201 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30†: %d\n", 
fu_num_°age_∑øm_«me
,

202 
num_°ages
);

204 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30†: ", 
fu_°age_œãncy_«me
);

205 
i
 = 0; i < 
num_°ages
; ++i)

207 
	`Ârötf
(
°dîr
, "%d", 
œãncõs
[
i
]);

208 i‡(
i
 =(
num_°ages
 - 1))

210 
	`Ârötf
(
°dîr
, "\n");

214 
	`Ârötf
(
°dîr
, ", ");

217 
	}
}

220 
	$sim_∑øms_¥öt
(c⁄° 
SimP¨ams
 *
p
)

222 
	`Ârötf
(
°dîr
, "\x1B[35m Simulation Parameters:\x1B[0m\n");

223 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "core_name",

224 
p
->
c‹e_«me
);

226 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "core_type",

227 
c‹e_ty≥_°r
[
p
->
c‹e_ty≥
]);

228 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "sim_trace",

229 
sim_∑øm_°©us
[
p
->
do_sim_åa˚
]);

230 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "sim_trace_file",

231 
p
->
sim_åa˚_fûe
);

232 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "sim_stats_path",

233 
p
->
sim_°©s_∑th
);

234 
	`Ârötf
(
°dîr
, "\n");

236 i‡(
p
->
c‹e_ty≥
 =
CORE_TYPE_INCORE
)

238 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "num_cpu_stages",

239 
p
->
num_˝u_°ages
);

240 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "enable_parallel_fu",

241 
sim_∑øm_°©us
[
p
->
íabÀ_∑øŒñ_fu
]);

243 i‡(
p
->
c‹e_ty≥
 =
CORE_TYPE_OOCORE
)

245 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "iq_size",

246 
p
->
iq_size
);

247 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "iq_issue_ports",

248 
p
->
iq_issue_p‹ts
);

249 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "rob_size",

250 
p
->
rob_size
);

251 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "rob_commit_ports",

252 
p
->
rob_commô_p‹ts
);

253 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "lsq_size",

254 
p
->
lsq_size
);

256 
	`Ârötf
(
°dîr
, "\n");

258 
	`¥öt_fu_c⁄fig
("num_Æu_°ages", "Æu_°age_œãncõs", 
p
->
num_Æu_°ages
,

259 
p
->
Æu_°age_œãncy
);

260 
	`¥öt_fu_c⁄fig
("num_mul_°ages", "mul_°age_œãncõs", 
p
->
num_mul_°ages
,

261 
p
->
mul_°age_œãncy
);

262 
	`¥öt_fu_c⁄fig
("num_div_°ages", "div_°age_œãncõs", 
p
->
num_div_°ages
,

263 
p
->
div_°age_œãncy
);

264 
	`¥öt_fu_c⁄fig
("num_fpu_fma_stages", "fpu_fma_stage_latencies",

265 
p
->
num_Âu_fma_°ages
,Ö->
Âu_fma_°age_œãncy
);

266 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "num_fpu_alu_stages", 1);

267 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fadd",

268 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FADD
]);

269 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fsub",

270 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSUB
]);

271 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fmul",

272 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMUL
]);

273 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fdiv",

274 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FDIV
]);

275 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fsqrt",

276 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSQRT
]);

277 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fsgnj",

278 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSGNJ
]);

279 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fmin",

280 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMIN
]);

281 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fmax",

282 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMAX
]);

283 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "feq",

284 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FEQ
]);

285 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "flt",

286 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLT
]);

287 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fle",

288 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLE
]);

289 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fcvt",

290 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCVT
]);

291 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "cvt",

292 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_CVT
]);

293 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fmv",

294 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMV
]);

295 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "fclass",

296 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCLASS
]);

298 
	`Ârötf
(
°dîr
, "\n");

300 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "enable_bpu",

301 
sim_∑øm_°©us
[
p
->
íabÀ_bpu
]);

302 i‡(
p
->
íabÀ_bpu
)

304 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "btb_size",

305 
p
->
btb_size
);

306 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "btb_ways",

307 
p
->
btb_ways
);

308 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "btb_eviction_policy",

309 
btb_evi˘_°r
[
p
->
btb_evi˘i⁄_pﬁicy
]);

310 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "bpu_type",

311 
bpu_ty≥_°r
[
p
->
bpu_ty≥
]);

313 
p
->
bpu_ty≥
)

315 
BPU_TYPE_BIMODAL
:

317 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "bht_size",

318 
p
->
bht_size
);

322 
BPU_TYPE_ADAPTIVE
:

324 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

325 "bpu_ght_size", 
p
->
bpu_ght_size
);

326 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

327 "bpu_pht_size", 
p
->
bpu_pht_size
);

328 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

329 "bpu_hi°‹y_bôs", 
p
->
bpu_hi°‹y_bôs
);

330 i‡((
p
->
bpu_ght_size
 =1Ë&& (p->
bpu_pht_size
 == 1))

332 
	`Ârötf
(

333 
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

335 
bpu_Æüsög_func_ty≥_°r
[
p
->
bpu_Æüsög_func_ty≥
]);

341 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "ras_size",

342 
p
->
øs_size
);

344 
	`Ârötf
(
°dîr
, "\n");

347 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "enable_l1_caches",

348 
sim_∑øm_°©us
[
p
->
íabÀ_l1_ˇches
]);

349 i‡(
p
->
íabÀ_l1_ˇches
)

351 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

352 "l1_code_ˇche_ªad_œãncy", 
p
->
l1_code_ˇche_ªad_œãncy
);

353 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d KB\n",

354 "l1_code_ˇche_size", 
p
->
l1_code_ˇche_size
);

355 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "l1_code_cache_ways",

356 
p
->
l1_code_ˇche_ways
);

357 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "l1_code_cache_evict",

358 
ˇche_evi˘_°r
[
p
->
l1_code_ˇche_evi˘
]);

361 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

362 "l1_d©a_ˇche_ªad_œãncy", 
p
->
l1_d©a_ˇche_ªad_œãncy
);

363 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

364 "l1_d©a_ˇche_wrôe_œãncy", 
p
->
l1_d©a_ˇche_wrôe_œãncy
);

365 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d KB\n",

366 "l1_d©a_ˇche_size", 
p
->
l1_d©a_ˇche_size
);

367 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "l1_data_cache_ways",

368 
p
->
l1_d©a_ˇche_ways
);

369 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "l1_data_cache_evict",

370 
ˇche_evi˘_°r
[
p
->
l1_d©a_ˇche_evi˘
]);

373 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "enable_l2_cache",

374 
sim_∑øm_°©us
[
p
->
íabÀ_l2_ˇche
]);

376 i‡(
p
->
íabÀ_l2_ˇche
)

378 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

379 "l2_sh¨ed_ˇche_ªad_œãncy", 
p
->
l2_sh¨ed_ˇche_ªad_œãncy
);

380 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

381 "l2_sh¨ed_ˇche_wrôe_œãncy", 
p
->
l2_sh¨ed_ˇche_wrôe_œãncy
);

382 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d KB\n",

383 "l2_sh¨ed_ˇche_size", 
p
->
l2_sh¨ed_ˇche_size
);

384 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

385 "l2_sh¨ed_ˇche_ways", 
p
->
l2_sh¨ed_ˇche_ways
);

386 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

388 
ˇche_evi˘_°r
[
p
->
l2_sh¨ed_ˇche_evi˘
]);

392 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n",

393 "w‹ds_≥r_ˇche_löe", 
p
->
w‹ds_≥r_ˇche_löe
);

394 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

396 
ˇche_ø_°r
[
p
->
ˇche_ªad_Æloˇã_pﬁicy
]);

397 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

399 
ˇche_wa_°r
[
p
->
ˇche_wrôe_Æloˇã_pﬁicy
]);

400 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "cache_write_policy",

401 
ˇche_wp_°r
[
p
->
ˇche_wrôe_pﬁicy
]);

403 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "flush_sim_mem",

404 
sim_∑øm_°©us
[
p
->
Êush_sim_mem
]);

407 
	`Ârötf
(
°dîr
, "\n");

408 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30†: %d\n", "éb_size", 
p
->
éb_size
);

409 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30†: %lu MB\n", "gue°_øm_size", 
p
->
gue°_øm_size
);

410 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n", "mem_model_type",

411 
mem_modñ_ty≥_°r
[
p
->
mem_modñ_ty≥
]);

413 
p
->
mem_modñ_ty≥
)

415 
MEM_MODEL_BASE
:

417 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %u\n",

419 
p
->
mem_ac˚ss_œãncy
);

420 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %d\n", "pte_rw_latency",

421 
p
->
±e_rw_œãncy
);

424 
MEM_MODEL_DRAMSIM
:

426 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

427 "dømsim_öi_fûe", 
p
->
dømsim_öi_fûe
);

428 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

429 "dømsim_sy°em_öi_fûe", 
p
->
dømsim_sy°em_öi_fûe
);

430 
	`Ârötf
(
°dîr
, " \x1B[32m*\x1B[0m %-30s : %s\n",

431 "dømsim_°©s_dú", 
p
->
dømsim_°©s_dú
);

436 
	`Ârötf
(
°dîr
, "error: invalid memory model\n");

437 
	`exô
(1);

440 
	`Ârötf
(
°dîr
, "\n");

441 
	}
}

444 
	$sim_∑øms_‰ì
(
SimP¨ams
 *
p
)

446 
	`‰ì
(
p
->
Æu_°age_œãncy
);

447 
p
->
Æu_°age_œãncy
 = 
NULL
;

448 
	`‰ì
(
p
->
mul_°age_œãncy
);

449 
p
->
mul_°age_œãncy
 = 
NULL
;

450 
	`‰ì
(
p
->
div_°age_œãncy
);

451 
p
->
div_°age_œãncy
 = 
NULL
;

452 
	`‰ì
(
p
->
Âu_fma_°age_œãncy
);

453 
p
->
Âu_fma_°age_œãncy
 = 
NULL
;

455 
	`‰ì
(
p
->
sim_åa˚_fûe
);

456 
p
->
sim_åa˚_fûe
 = 
NULL
;

458 
	`‰ì
(
p
->
sim_°©s_∑th
);

459 
p
->
sim_°©s_∑th
 = 
NULL
;

461 
	`‰ì
(
p
->
c‹e_«me
);

462 
p
->
c‹e_«me
 = 
NULL
;

464 
	`‰ì
(
p
->
dømsim_öi_fûe
);

465 
p
->
dømsim_öi_fûe
 = 
NULL
;

466 
	`‰ì
(
p
->
dømsim_sy°em_öi_fûe
);

467 
p
->
dømsim_sy°em_öi_fûe
 = 
NULL
;

468 
	`‰ì
(
p
->
dømsim_°©s_dú
);

469 
p
->
dømsim_°©s_dú
 = 
NULL
;

471 
	`‰ì
(
p
);

472 
	}
}

475 
	$vÆid©e_∑øm
(c⁄° *
∑øm_«me
, 
has_ønge
, 
mö
, 
max
,

476 
cuºít
)

478 i‡(
has_ønge
)

480 i‡(!(
cuºít
 >
mö
 && cuºíà<
max
))

482 
	`Ârötf
(
°dîr
,

484 
∑øm_«me
, 
mö
, 
max
);

485 
	`ab‹t
();

490 i‡(!(
cuºít
 >
mö
))

492 
	`Ârötf
(

493 
°dîr
,

495 
∑øm_«me
, 
mö
);

496 
	`ab‹t
();

499 
	}
}

502 
	$is_powî_of_two
(
vÆue
)

504  ((
vÆue
 > 0) && ((value & (value - 1)) == 0));

505 
	}
}

508 
	$sim_∑øms_vÆid©e
(c⁄° 
SimP¨ams
 *
p
)

510 
i
;

513 
	`vÆid©e_∑øm
("°¨t_ö_sim", 1, 0, 1, 
p
->
°¨t_ö_sim
);

514 
	`vÆid©e_∑øm
("íabÀ_°©s_di•œy", 1, 0, 1, 
p
->
íabÀ_°©s_di•œy
);

515 
	`vÆid©e_∑øm
("éb_size", 0, 1, 2048, 
p
->
éb_size
);

516 
	`vÆid©e_∑øm
("±e_rw_œãncy", 0, 1, 2048, 
p
->
±e_rw_œãncy
);

518 i‡(
	`°rcmp
(
p
->
c‹e_«me
, "incore") == 0)

520 i‡(!(
p
->
num_˝u_°ages
 == 5 ||Ö->num_cpu_stages == 6))

522 
	`Ârötf
(
°dîr
,

524 
	`ab‹t
();

526 
	`vÆid©e_∑øm
("íabÀ_∑øŒñ_fu", 1, 0, 1, 
p
->
íabÀ_∑øŒñ_fu
);

528 i‡(
	`°rcmp
(
p
->
c‹e_«me
, "oocore") == 0)

530 
	`vÆid©e_∑øm
("iq_size", 0, 1, 2048, 
p
->
iq_size
);

531 
	`vÆid©e_∑øm
("iq_issue_p‹ts", 0, 1, 2048, 
p
->
iq_issue_p‹ts
);

532 
	`vÆid©e_∑øm
("rob_size", 0, 1, 2048, 
p
->
rob_size
);

533 
	`vÆid©e_∑øm
("lsq_size", 0, 1, 2048, 
p
->
lsq_size
);

537 
	`vÆid©e_∑øm
("num_Æu_°ages", 0, 1, 2048, 
p
->
num_Æu_°ages
);

539 
i
 = 0; i < 
p
->
num_Æu_°ages
; ++i)

541 
	`vÆid©e_∑øm
("alu_stage_latency", 0, 1, 2048,

542 
p
->
Æu_°age_œãncy
[
i
]);

545 
	`vÆid©e_∑øm
("num_mul_°ages", 0, 1, 2048, 
p
->
num_mul_°ages
);

546 
i
 = 0; i < 
p
->
num_mul_°ages
; ++i)

548 
	`vÆid©e_∑øm
("mul_stage_latency", 0, 1, 2048,

549 
p
->
mul_°age_œãncy
[
i
]);

552 
	`vÆid©e_∑øm
("num_div_°ages", 0, 1, 2048, 
p
->
num_div_°ages
);

553 
i
 = 0; i < 
p
->
num_div_°ages
; ++i)

555 
	`vÆid©e_∑øm
("div_stage_latency", 0, 1, 2048,

556 
p
->
div_°age_œãncy
[
i
]);

559 
	`vÆid©e_∑øm
("num_Âu_Æu_°ages", 0, 1, 2048, 
p
->
num_Âu_Æu_°ages
);

560 
	`vÆid©e_∑øm
("Ádd", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FADD
]);

561 
	`vÆid©e_∑øm
("fsub", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSUB
]);

562 
	`vÆid©e_∑øm
("fmul", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMUL
]);

563 
	`vÆid©e_∑øm
("fdiv", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FDIV
]);

564 
	`vÆid©e_∑øm
("fsqπ", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSQRT
]);

565 
	`vÆid©e_∑øm
("fsgnj", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FSGNJ
]);

566 
	`vÆid©e_∑øm
("fmö", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMIN
]);

567 
	`vÆid©e_∑øm
("fmax", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMAX
]);

568 
	`vÆid©e_∑øm
("„q", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FEQ
]);

569 
	`vÆid©e_∑øm
("Êt", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLT
]);

570 
	`vÆid©e_∑øm
("Êe", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FLE
]);

571 
	`vÆid©e_∑øm
("fcvt", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCVT
]);

572 
	`vÆid©e_∑øm
("cvt", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_CVT
]);

573 
	`vÆid©e_∑øm
("fmv", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FMV
]);

574 
	`vÆid©e_∑øm
("f˛ass", 0, 1, 2048, 
p
->
Âu_Æu_œãncy
[
FU_FPU_ALU_FCLASS
]);

576 
	`vÆid©e_∑øm
("num_Âu_fma_°ages", 0, 1, 2048, 
p
->
num_Âu_fma_°ages
);

577 
i
 = 0; i < 
p
->
num_Âu_fma_°ages
; ++i)

579 
	`vÆid©e_∑øm
("fpu_fma_stage_latency", 0, 1, 2048,

580 
p
->
Âu_fma_°age_œãncy
[
i
]);

584 
	`vÆid©e_∑øm
("íabÀ_bpu", 1, 0, 1, 
p
->
íabÀ_bpu
);

585 i‡(
p
->
íabÀ_bpu
)

587 i‡(!
	`is_powî_of_two
(
p
->
btb_size
))

589 
	`Ârötf
(
°dîr
, "(marss): configÉrror - %s must beáÖower of 2\n",

591 
	`ab‹t
();

594 
	`vÆid©e_∑øm
("btb_ways", 0, 1, 2048, 
p
->
btb_ways
);

595 
	`vÆid©e_∑øm
("bpu_ty≥", 1, 0, 1, 
p
->
bpu_ty≥
);

597 
p
->
bpu_ty≥
)

599 
BPU_TYPE_BIMODAL
:

601 i‡(!
	`is_powî_of_two
(
p
->
bht_size
))

603 
	`Ârötf
(
°dîr
,

606 
	`ab‹t
();

611 
BPU_TYPE_ADAPTIVE
:

613 i‡(!
	`is_powî_of_two
(
p
->
bpu_ght_size
))

615 
	`Ârötf
(
°dîr
,

618 
	`ab‹t
();

620 i‡(!
	`is_powî_of_two
(
p
->
bpu_pht_size
))

622 
	`Ârötf
(
°dîr
,

625 
	`ab‹t
();

627 
	`vÆid©e_∑øm
("bpu_history_bits", 0, 1, 2048,

628 
p
->
bpu_hi°‹y_bôs
);

635 
	`vÆid©e_∑øm
("íabÀ_l1_ˇches", 1, 0, 1, 
p
->
íabÀ_l1_ˇches
);

637 i‡(
p
->
íabÀ_l1_ˇches
)

639 
	`vÆid©e_∑øm
("l1_code_cache_read_latency", 0, 1, 2048,

640 
p
->
l1_code_ˇche_ªad_œãncy
);

641 
	`vÆid©e_∑øm
("l1_code_ˇche_size", 0, 1, 2048, 
p
->
l1_code_ˇche_size
);

642 
	`vÆid©e_∑øm
("l1_code_ˇche_ways", 0, 1, 2048, 
p
->
l1_code_ˇche_ways
);

643 
	`vÆid©e_∑øm
("l1_code_ˇche_evi˘", 1, 0, 1, 
p
->
l1_code_ˇche_evi˘
);

645 
	`vÆid©e_∑øm
("l1_data_cache_read_latency", 0, 1, 2048,

646 
p
->
l1_d©a_ˇche_ªad_œãncy
);

647 
	`vÆid©e_∑øm
("l1_data_cache_write_latency", 0, 1, 2048,

648 
p
->
l1_d©a_ˇche_wrôe_œãncy
);

649 
	`vÆid©e_∑øm
("l1_d©a_ˇche_size", 0, 1, 2048, 
p
->
l1_d©a_ˇche_size
);

650 
	`vÆid©e_∑øm
("l1_d©a_ˇche_ways", 0, 1, 2048, 
p
->
l1_d©a_ˇche_ways
);

651 
	`vÆid©e_∑øm
("l1_d©a_ˇche_evi˘", 1, 0, 1, 
p
->
l1_d©a_ˇche_evi˘
);

654 
	`vÆid©e_∑øm
("words_per_cache_line", 0, 1, 2048,

655 
p
->
w‹ds_≥r_ˇche_löe
);

656 
	`vÆid©e_∑øm
("cache_read_allocate_policy", 1, 0, 1,

657 
p
->
ˇche_ªad_Æloˇã_pﬁicy
);

658 
	`vÆid©e_∑øm
("cache_write_allocate_policy", 1, 0, 1,

659 
p
->
ˇche_wrôe_Æloˇã_pﬁicy
);

660 
	`vÆid©e_∑øm
("ˇche_wrôe_pﬁicy", 1, 0, 1, 
p
->
ˇche_wrôe_pﬁicy
);

662 
	`vÆid©e_∑øm
("íabÀ_l2_ˇche", 1, 0, 1, 
p
->
íabÀ_l2_ˇche
);

664 i‡(
p
->
íabÀ_l2_ˇche
)

666 
	`vÆid©e_∑øm
("l2_shared_cache_read_latency", 0, 1, 2048,

667 
p
->
l2_sh¨ed_ˇche_ªad_œãncy
);

668 
	`vÆid©e_∑øm
("l2_shared_cache_write_latency", 0, 1, 2048,

669 
p
->
l2_sh¨ed_ˇche_wrôe_œãncy
);

670 
	`vÆid©e_∑øm
("l2_shared_cache_size", 0, 1, 2048,

671 
p
->
l2_sh¨ed_ˇche_size
);

672 
	`vÆid©e_∑øm
("l2_shared_cache_ways", 0, 1, 2048,

673 
p
->
l2_sh¨ed_ˇche_ways
);

674 
	`vÆid©e_∑øm
("l2_shared_cache_evict", 1, 0, 1,

675 
p
->
l2_sh¨ed_ˇche_evi˘
);

680 
	`vÆid©e_∑øm
("døm_bur°_size", 0, 1, 2048, ()
p
->
døm_bur°_size
);

681 
	`vÆid©e_∑øm
("mem_access_latency", 0, 1, 2048,

682 
p
->
mem_ac˚ss_œãncy
);

683 
	}
}

686 
	$sim_°©s_¥öt
(
SimSèts
 *
s
, c⁄° *
∑th«me
)

688 
FILE
 *
Â
;

689 *
fûíame
, *
p
;

690 
time_t
 
øwtime
;

691 
buf„r
[256];

693 
	`time
(&
øwtime
);

694 
	`•rötf
(
buf„r
, "sim°©s_%s.txt", 
	`˘ime
(&
øwtime
));

696 
p
 = 
buf„r
;

697 ; *
p
; ++p)

699 i‡(*
p
 == ' ')

700 *
p
 = '_';

702 i‡(*
p
 == '\n')

703 *
p
 = '_';

706 
fûíame
 = (*)
	`mÆloc
(
	`°æí
(
∑th«me
Ë+ såÀn(
buf„r
) + 2);

707 
	`as£π
(
fûíame
);

709 
	`°r˝y
(
fûíame
, 
∑th«me
);

710 
	`°rˇt
(
fûíame
, "/");

711 
	`°rˇt
(
fûíame
, 
buf„r
);

713 
Â
 = 
	`f›í
(
fûíame
, "w");

714 
	`as£π
(
Â
);

716 
	`PRINT_SIM_STAT_HEADER
(
Â
);

718 
	`PRINT_SIM_STAT
(
Â
, 
s
, "cy˛es", 
cy˛es
);

719 
	`PRINT_SIM_STAT
(
Â
, 
s
, "commôs", 
ös_simuœãd
);

720 
	`PRINT_SIM_STAT
(
Â
, 
s
, "ös_„tch", 
ös_„tch
);

722 
	`PRINT_SIM_STAT
(
Â
, 
s
, "ö¢_mem_dñay", 
ö¢_mem_dñay
);

723 
	`PRINT_SIM_STAT
(
Â
, 
s
, "d©a_mem_dñay", 
d©a_mem_dñay
);

724 
	`PRINT_SIM_STAT
(
Â
, 
s
, "exec_unô_dñay", 
exec_unô_dñay
);

726 
	`PRINT_SIM_STAT
(
Â
, 
s
, "lﬂd_ö¢", 
ös_ty≥
[
INS_TYPE_LOAD
]);

727 
	`PRINT_SIM_STAT
(
Â
, 
s
, "°‹e_ö¢", 
ös_ty≥
[
INS_TYPE_STORE
]);

728 
	`PRINT_SIM_STAT
(
Â
, 
s
, "©omic_ö¢", 
ös_ty≥
[
INS_TYPE_ATOMIC
]);

729 
	`PRINT_SIM_STAT
(
Â
, 
s
, "sy°em_ö¢", 
ös_emuœãd
);

730 
	`PRINT_SIM_STAT
(
Â
, 
s
, "¨ômëic_ö¢", 
ös_ty≥
[
INS_TYPE_ARITMETIC
]);

731 
	`PRINT_SIM_STAT
(
Â
, 
s
, "c⁄d_bønches", 
ös_ty≥
[
INS_TYPE_COND_BRANCH
]);

732 
	`PRINT_SIM_STAT
(
Â
, 
s
, "jÆ_ö¢", 
ös_ty≥
[
INS_TYPE_JAL
]);

733 
	`PRINT_SIM_STAT
(
Â
, 
s
, "jÆr_ö¢", 
ös_ty≥
[
INS_TYPE_JALR
]);

734 
	`PRINT_SIM_STAT
(
Â
, 
s
, "öt_mul_ö¢", 
ös_ty≥
[
INS_TYPE_INT_MUL
]);

735 
	`PRINT_SIM_STAT
(
Â
, 
s
, "öt_div_ö¢", 
ös_ty≥
[
INS_TYPE_INT_DIV
]);

736 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_lﬂd_ö¢", 
ös_ty≥
[
INS_TYPE_FP_LOAD
]);

737 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_°‹e_ö¢", 
ös_ty≥
[
INS_TYPE_FP_STORE
]);

738 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_add_ö¢", 
ös_ty≥
[
INS_TYPE_FP_ADD
]);

739 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_mul_ö¢", 
ös_ty≥
[
INS_TYPE_FP_MUL
]);

740 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_fma_ö¢", 
ös_ty≥
[
INS_TYPE_FP_FMA
]);

741 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_div_sqπ_ö¢", 
ös_ty≥
[
INS_TYPE_FP_DIV_SQRT
]);

742 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_misc_ö¢", 
ös_ty≥
[
INS_TYPE_FP_MISC
]);

744 
	`PRINT_SIM_STAT
(
Â
, 
s
, "ôlb_ªads", 
code_éb_lookups
);

745 
	`PRINT_SIM_STAT
(
Â
, 
s
, "ôlb_hôs", 
code_éb_hôs
);

746 
	`PRINT_SIM_STAT
(
Â
, 
s
, "lﬂd_éb_ªads", 
lﬂd_éb_lookups
);

747 
	`PRINT_SIM_STAT
(
Â
, 
s
, "lﬂd_éb_hôs", 
lﬂd_éb_hôs
);

748 
	`PRINT_SIM_STAT
(
Â
, 
s
, "°‹e_éb_ªads", 
°‹e_éb_lookups
);

749 
	`PRINT_SIM_STAT
(
Â
, 
s
, "°‹e_éb_hôs", 
°‹e_éb_hôs
);

751 
	`PRINT_SIM_STAT
(
Â
, 
s
, "c⁄d_bønches_èkí", 
ös_c⁄d_bønch_èkí
);

752 
	`PRINT_SIM_STAT
(
Â
, 
s
, "c⁄d_bønches_¥ed_c‹ª˘", 
bpu_c⁄d_c‹ª˘
);

753 
	`PRINT_SIM_STAT
(
Â
, 
s
, "c⁄d_bønches_¥ed_öc‹ª˘", 
bpu_c⁄d_öc‹ª˘
);

754 
	`PRINT_SIM_STAT
(
Â
, 
s
, "unc⁄d_bønches_¥ed_c‹ª˘", 
bpu_unc⁄d_c‹ª˘
);

755 
	`PRINT_SIM_STAT
(
Â
, 
s
, "unc⁄d_bønches_¥ed_öc‹ª˘",
bpu_unc⁄d_öc‹ª˘
);

757 
	`PRINT_SIM_STAT
(
Â
, 
s
, "btb_ªads", 
btb_¥obes
);

758 
	`PRINT_SIM_STAT
(
Â
, 
s
, "btb_hôs", 
btb_hôs
);

759 
	`PRINT_SIM_STAT
(
Â
, 
s
, "btb_ö£πs", 
btb_ö£πs
);

760 
	`PRINT_SIM_STAT
(
Â
, 
s
, "btb_upd©es", 
btb_upd©es
);

762 
	`PRINT_SIM_STAT
(
Â
, 
s
, "öt_ªgfûe_ªads", 
öt_ªgfûe_ªads
);

763 
	`PRINT_SIM_STAT
(
Â
, 
s
, "öt_ªgfûe_wrôes", 
öt_ªgfûe_wrôes
);

764 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_ªgfûe_ªads", 
Â_ªgfûe_ªads
);

765 
	`PRINT_SIM_STAT
(
Â
, 
s
, "Â_ªgfûe_wrôes", 
Â_ªgfûe_wrôes
);

766 
	`PRINT_SIM_STAT
(
Â
, 
s
, "c§_ªads", 
c§_ªads
);

767 
	`PRINT_SIM_STAT
(
Â
, 
s
, "c§_wrôes", 
c§_wrôes
);

769 
	`PRINT_SIM_STAT
(
Â
, 
s
, "fu_Æu_ac˚s£s", 
fu_ac˚ss
[
FU_ALU
]);

770 
	`PRINT_SIM_STAT
(
Â
, 
s
, "fu_mul_ac˚s£s", 
fu_ac˚ss
[
FU_MUL
]);

771 
	`PRINT_SIM_STAT
(
Â
, 
s
, "fu_div_ac˚s£s", 
fu_ac˚ss
[
FU_DIV
]);

772 
	`PRINT_SIM_STAT
(
Â
, 
s
, "fu_Âu_Æu_ac˚s£s", 
fu_ac˚ss
[
FU_FPU_ALU
]);

773 
	`PRINT_SIM_STAT
(
Â
, 
s
, "fu_Âu_fma_ac˚s£s", 
fu_ac˚ss
[
FU_FPU_FMA
]);

775 
	`PRINT_SIM_STAT
(
Â
, 
s
, "eˇŒ", 
eˇŒ
);

776 
	`PRINT_SIM_STAT
(
Â
, 
s
, "öãºu±s", 
öãºu±s
);

777 
	`PRINT_SIM_STAT
(
Â
, 
s
, "ös_∑ge_wÆks", 
ös_∑ge_wÆks
);

778 
	`PRINT_SIM_STAT
(
Â
, 
s
, "lﬂd_∑ge_wÆks", 
lﬂd_∑ge_wÆks
);

779 
	`PRINT_SIM_STAT
(
Â
, 
s
, "°‹e_∑ge_wÆks", 
°‹e_∑ge_wÆks
);

780 
	`PRINT_SIM_STAT
(
Â
, 
s
, "ös_∑ge_Áu…s", 
ös_∑ge_Áu…s
);

781 
	`PRINT_SIM_STAT
(
Â
, 
s
, "lﬂd_∑ge_Áu…s", 
lﬂd_∑ge_Áu…s
);

782 
	`PRINT_SIM_STAT
(
Â
, 
s
, "°‹e_∑ge_Áu…s", 
°‹e_∑ge_Áu…s
);

784 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L1_iˇche_ªads", 
iˇche_ªad
);

785 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L1_iˇche_ªad_mis£s", 
iˇche_ªad_miss
);

787 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L1_dˇche_ªads", 
dˇche_ªad
);

788 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L1_dˇche_ªad_mis£s", 
dˇche_ªad_miss
);

789 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L1_dˇche_wrôes", 
dˇche_wrôe
);

790 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L1_dˇche_wrôe_mis£s", 
dˇche_wrôe_miss
);

792 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L2_ˇche_ªads", 
l2_ˇche_ªad
);

793 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L2_ˇche_ªad_mis£s", 
l2_ˇche_ªad_miss
);

794 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L2_ˇche_wrôes", 
l2_ˇche_wrôe
);

795 
	`PRINT_SIM_STAT
(
Â
, 
s
, "L2_ˇche_wrôe_mis£s", 
l2_ˇche_wrôe_miss
);

797 
	`f˛o£
(
Â
);

798 
	`Ârötf
(
°dîr
, "(m¨ss-riscv): Saved sèt†ö %s\n", 
fûíame
);

799 
	`‰ì
(
fûíame
);

800 
	}
}

803 
	$sim_°©s_ª£t
(
SimSèts
 *
s
)

805 
	`mem£t
((*)
s
, 0, 
NUM_MAX_PRV_LEVELS
 * (
SimSèts
));

806 
	}
}

	@riscvsim/sim_params_stats.h

30 #i‚de‡
_SIM_PARAMS_STATS_H_


31 
	#_SIM_PARAMS_STATS_H_


	)

33 
	~<f˙é.h
>

34 
	~<öây≥s.h
>

35 
	~<löux/limôs.h
>

36 
	~<sys/°©.h
>

37 
	~<sys/ty≥s.h
>

39 
	~"riscv_sim_ma¸os.h
"

42 
	#POSIX_IPC_NAME_PREFIX
 "/u£r-"

	)

43 
	#MARSS_STATS_SHM_NAME
 
POSIX_IPC_NAME_PREFIX
 "m¨ss-°©s-shm"

	)

44 
	#ALL_RW_PERMS
 (
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
 | 
S_IROTH
 | S_IWGRP)

	)

46 
	eSIM_PARAM_STATUS


48 
	mDISABLE
,

49 
	mENABLE


52 
	eCORE_TYPE


54 
	mCORE_TYPE_INCORE
,

55 
	mCORE_TYPE_OOCORE


58 
	eBPU_TYPE


60 
	mBPU_TYPE_BIMODAL
,

61 
	mBPU_TYPE_ADAPTIVE


64 
	eBTB_EVICT_POLICY


66 
	mBTB_RANDOM_EVICT
,

67 
	mBTB_LRU_EVICT


70 
	eCACHE_READ_ALLOC_POLICY


72 
	mCACHE_READ_ALLOC
,

73 
	mCACHE_READ_NO_ALLOC


76 
	eCACHE_WRITE_ALLOC_POLICY


78 
	mCACHE_WRITE_ALLOC
,

79 
	mCACHE_WRITE_NO_ALLOC


82 
	eCACHE_WRITE_POLICY


84 
	mCACHE_WRITEBACK
,

85 
	mCACHE_WRITETHROUGH
,

88 
	eCACHE_EVICT_POLICY


90 
	mCACHE_RANDOM_EVICT
,

91 
	mCACHE_LRU_EVICT


94 
	eBPU_ALIAS_FUNC


96 
	mBPU_ALIAS_FUNC_XOR
,

97 
	mBPU_ALIAS_FUNC_AND
,

98 
	mBPU_ALIAS_FUNC_NONE


101 
	eMEM_MODEL_TYPE


103 
	mMEM_MODEL_BASE
,

104 
	mMEM_MODEL_DRAMSIM
,

108 
	#DEF_CORE_NAME
 "deÁu…-riscv-c‹e"

	)

109 
	#DEF_CORE_TYPE
 
CORE_TYPE_INCORE


	)

110 
	#DEF_NUM_STAGES
 6

	)

111 
	#DEF_ENABLE_PARALLEL_FU
 
DISABLE


	)

112 
	#DEF_START_SIM
 0

	)

113 
	#DEF_STATS_DISPLAY
 0

	)

114 
	#DEF_DO_SIM_TRACE
 
DISABLE


	)

115 
	#DEF_CREATE_INS_STR
 0

	)

116 
	#DEF_SIM_TRACE_FILE
 "simåa˚.txt"

	)

117 
	#DEF_SIM_STATS_PATH
 "."

	)

118 
	#DEF_NUM_ALU_STAGES
 1

	)

119 
	#DEF_NUM_MUL_STAGES
 1

	)

120 
	#DEF_NUM_DIV_STAGES
 1

	)

121 
	#DEF_NUM_FPU_ALU_STAGES
 1

	)

122 
	#DEF_NUM_FPU_FMA_STAGES
 1

	)

123 
	#DEF_STAGE_LATENCY
 1

	)

125 
	#DEF_ENABLE_BPU
 
ENABLE


	)

126 
	#DEF_BTB_SIZE
 512

	)

127 
	#DEF_BTB_WAYS
 2

	)

128 
	#DEF_BHT_SIZE
 256

	)

129 
	#DEF_RAS_SIZE
 6

	)

130 
	#DEF_GHT_SIZE
 1

	)

131 
	#DEF_PHT_SIZE
 1

	)

132 
	#DEF_HISTORY_BITS
 2

	)

133 
	#DEF_BPU_ALIAS_FUNC
 
BPU_ALIAS_FUNC_NONE


	)

134 
	#DEF_BTB_EVICT_POLICY
 
BTB_RANDOM_EVICT


	)

135 
	#DEF_BPU_TYPE
 
BPU_TYPE_BIMODAL


	)

137 
	#DEF_ENABLE_L1_CACHE
 
ENABLE


	)

138 
	#DEF_L1_CODE_CACHE_READ_LATENCY
 1

	)

139 
	#DEF_L1_CODE_CACHE_SIZE
 32

	)

140 
	#DEF_L1_CODE_CACHE_WAYS
 4

	)

141 
	#DEF_L1_CODE_CACHE_EVICT
 
CACHE_LRU_EVICT


	)

143 
	#DEF_L1_DATA_CACHE_PROBE_LATENCY
 1

	)

144 
	#DEF_L1_DATA_CACHE_READ_LATENCY
 1

	)

145 
	#DEF_L1_DATA_CACHE_WRITE_LATENCY
 1

	)

146 
	#DEF_L1_DATA_CACHE_SIZE
 32

	)

147 
	#DEF_L1_DATA_CACHE_WAYS
 4

	)

148 
	#DEF_L1_DATA_CACHE_EVICT
 
CACHE_LRU_EVICT


	)

150 
	#DEF_ENABLE_L2_CACHE
 
ENABLE


	)

151 
	#DEF_L2_CACHE_PROBE_LATENCY
 1

	)

152 
	#DEF_L2_CACHE_READ_LATENCY
 1

	)

153 
	#DEF_L2_CACHE_WRITE_LATENCY
 1

	)

154 
	#DEF_L2_CACHE_SIZE
 256

	)

155 
	#DEF_L2_CACHE_WAYS
 16

	)

156 
	#DEF_L2_CACHE_EVICT
 
CACHE_LRU_EVICT


	)

158 
	#DEF_CACHE_READ_ALLOC_POLICY
 
CACHE_READ_ALLOC


	)

159 
	#DEF_CACHE_WRITE_ALLOC_POLICY
 
CACHE_WRITE_ALLOC


	)

160 
	#DEF_CACHE_WRITE_POLICY
 
CACHE_WRITEBACK


	)

161 
	#DEF_WORDS_PER_CACHE_LINE
 8

	)

163 
	#DEF_TLB_SIZE
 32

	)

164 
	#DEF_PTE_RW_LATENCY
 10

	)

165 
	#DEF_DRAM_BURST_SIZE
 32

	)

166 
	#DEF_MEM_ACCESS_LATENCY
 1

	)

168 
	#DEF_IQ_SIZE
 16

	)

169 
	#DEF_IQ_ISSUE_PORTS
 2

	)

170 
	#DEF_ROB_SIZE
 64

	)

171 
	#DEF_ROB_COMMIT_PORTS
 1

	)

172 
	#DEF_LSQ_SIZE
 16

	)

174 
	#DEF_MEM_MODEL
 
MEM_MODEL_BASE


	)

175 
	#DEF_DRAMSIM_INI_FILE
 "DRAMSim2/öi/DDR2_mi¸⁄_16M_8b_x8_sg3E.öi"

	)

176 
	#DEF_DRAMSIM_SYSTEM_INI_FILE
 "DRAMSim2/sy°em.öi.exam∂e"

	)

177 
	#DEF_DRAMSIM_STATS_DIR
 "."

	)

179 
	#DEF_FLUSH_SIM_MEM
 
DISABLE


	)

181 
	#PRINT_SIM_STAT_HEADER
(
Â
) \

183 
	`Ârötf
(
Â
, "%s,%s,%s,%s,%s,%s\n", "stat-name", "user", "supervisor", \

185 } 0)

	)

187 
	#PRINT_SIM_STAT
(
Â
, 
°©s
, 
«me
, 
©å
) \

189 
	`Ârötf
(
Â
, "%s,%lu,%lu,%lu,%lu,%lu\n", 
«me
, 
°©s
[0].
©å
, \

190 
°©s
[1].
©å
, stats[2].attr, stats[3].attr, \

191 (
°©s
[0].
©å
 + stats[1].attr + stats[2].attr + stats[3].attr)); \

192 } 0)

	)

194 
	#PRINT_SIM_STAT_HEADER_TO_TERMINAL
(
Â
) \

196 
	`Ârötf
(
Â
, "%-30s %-18s %-18s %-18s %-18s %-18s\n", "stat-name", "user", \

198 } 0)

	)

200 
	#PRINT_SIM_STAT_TO_TERMINAL
(
Â
, 
°©s
, 
«me
, 
©å
) \

202 
	`Ârötf
(
Â
, "%-30†%-18lu %-18lu %-18lu %-18lu %-18lu\n", 
«me
, \

203 
°©s
[0].
©å
, stats[1].attr, stats[2].attr, stats[3].attr, \

204 (
°©s
[0].
©å
 + stats[1].attr + stats[2].attr + stats[3].attr)); \

205 } 0)

	)

207 c⁄° *
c‹e_ty≥_°r
[];

208 c⁄° *
sim_∑øm_°©us
[];

209 c⁄° *
ˇche_evi˘_°r
[];

210 c⁄° *
ˇche_ø_°r
[];

211 c⁄° *
ˇche_wa_°r
[];

212 c⁄° *
ˇche_wp_°r
[];

213 c⁄° *
bpu_ty≥_°r
[];

214 c⁄° *
btb_evi˘_°r
[];

215 c⁄° *
bpu_Æüsög_func_ty≥_°r
[];

216 c⁄° *
mem_modñ_ty≥_°r
[];

218 
	sSimP¨ams


221 *
	mc‹e_«me
;

222 
	mc‹e_ty≥
;

223 
	m°¨t_ö_sim
;

224 
	míabÀ_°©s_di•œy
;

225 
	m¸óã_ös_°r
;

226 
	mdo_sim_åa˚
;

227 *
	msim_åa˚_fûe
;

228 *
	msim_°©s_∑th
;

231 
	mnum_˝u_°ages
;

232 
	míabÀ_∑øŒñ_fu
;

235 
	miq_size
;

236 
	miq_issue_p‹ts
;

237 
	mrob_size
;

238 
	mrob_commô_p‹ts
;

239 
	mlsq_size
;

242 
	mnum_Æu_°ages
;

243 *
	mÆu_°age_œãncy
;

245 
	mnum_mul_°ages
;

246 *
	mmul_°age_œãncy
;

248 
	mnum_div_°ages
;

249 *
	mdiv_°age_œãncy
;

251 
	mnum_Âu_Æu_°ages
;

252 
	mÂu_Æu_œãncy
[
MAX_FU_FPU_ALU_TYPES
];

254 
	mnum_Âu_fma_°ages
;

255 *
	mÂu_fma_°age_œãncy
;

258 
	míabÀ_bpu
;

259 
	mbtb_size
;

260 
	mbtb_ways
;

261 
	mbht_size
;

262 
	møs_size
;

263 
	mbpu_ty≥
;

264 
	mbpu_ght_size
;

265 
	mbpu_pht_size
;

266 
	mbpu_hi°‹y_bôs
;

267 
	mbpu_Æüsög_func_ty≥
;

268 
	mbtb_evi˘i⁄_pﬁicy
;

271 
	míabÀ_l1_ˇches
;

272 
	ml1_code_ˇche_ªad_œãncy
;

273 
	ml1_code_ˇche_size
;

274 
	ml1_code_ˇche_ways
;

275 
	ml1_code_ˇche_evi˘
;

276 
	ml1_d©a_ˇche_ªad_œãncy
;

277 
	ml1_d©a_ˇche_wrôe_œãncy
;

278 
	ml1_d©a_ˇche_size
;

279 
	ml1_d©a_ˇche_ways
;

280 
	ml1_d©a_ˇche_evi˘
;

283 
	míabÀ_l2_ˇche
;

284 
	ml2_sh¨ed_ˇche_ªad_œãncy
;

285 
	ml2_sh¨ed_ˇche_wrôe_œãncy
;

286 
	ml2_sh¨ed_ˇche_size
;

287 
	ml2_sh¨ed_ˇche_ways
;

288 
	ml2_sh¨ed_ˇche_evi˘
;

291 
	mw‹ds_≥r_ˇche_löe
;

292 
	mˇche_ªad_Æloˇã_pﬁicy
;

293 
	mˇche_wrôe_Æloˇã_pﬁicy
;

294 
	mˇche_wrôe_pﬁicy
;

297 
uöt64_t
 
	mgue°_øm_size
;

298 
	méb_size
;

299 
	m±e_rw_œãncy
;

300 
uöt32_t
 
	mdøm_bur°_size
;

301 
	mmem_ac˚ss_œãncy
;

304 
	mmem_modñ_ty≥
;

305 *
	mdømsim_öi_fûe
;

306 *
	mdømsim_sy°em_öi_fûe
;

307 *
	mdømsim_°©s_dú
;

310 
	mÊush_sim_mem
;

311 } 
	tSimP¨ams
;

313 
	sSimSèts


316 
uöt64_t
 
	mcy˛es
;

317 
uöt64_t
 
	mö¢_mem_dñay
;

318 
uöt64_t
 
	md©a_mem_dñay
;

319 
uöt64_t
 
	mexec_unô_dñay
;

322 
uöt64_t
 
	mös_„tch
;

323 
uöt64_t
 
	mös_simuœãd
;

324 
uöt64_t
 
	mös_emuœãd
;

326 
uöt64_t
 
	mös_ty≥
[
NUM_MAX_INS_TYPES
];

327 
uöt64_t
 
	mös_c⁄d_bønch_èkí
;

330 
uöt64_t
 
	mc§_ªads
;

331 
uöt64_t
 
	mc§_wrôes
;

332 
uöt64_t
 
	mÂ_ªgfûe_ªads
;

333 
uöt64_t
 
	mÂ_ªgfûe_wrôes
;

334 
uöt64_t
 
	möt_ªgfûe_ªads
;

335 
uöt64_t
 
	möt_ªgfûe_wrôes
;

338 
uöt64_t
 
	mfu_ac˚ss
[
NUM_MAX_FU
];

341 
uöt64_t
 
	mbtb_¥obes
;

342 
uöt64_t
 
	mbtb_hôs
;

343 
uöt64_t
 
	mbtb_upd©es
;

344 
uöt64_t
 
	mbtb_ö£πs
;

346 
uöt64_t
 
	mbpu_c⁄d_c‹ª˘
;

347 
uöt64_t
 
	mbpu_c⁄d_öc‹ª˘
;

348 
uöt64_t
 
	mbpu_unc⁄d_c‹ª˘
;

349 
uöt64_t
 
	mbpu_unc⁄d_öc‹ª˘
;

352 
uöt64_t
 
	mcode_éb_lookups
;

353 
uöt64_t
 
	mcode_éb_hôs
;

355 
uöt64_t
 
	mlﬂd_éb_lookups
;

356 
uöt64_t
 
	mlﬂd_éb_hôs
;

358 
uöt64_t
 
	m°‹e_éb_lookups
;

359 
uöt64_t
 
	m°‹e_éb_hôs
;

362 
uöt64_t
 
	miˇche_ªad
;

363 
uöt64_t
 
	miˇche_ªad_miss
;

364 
uöt64_t
 
	mdˇche_ªad
;

365 
uöt64_t
 
	mdˇche_wrôe
;

366 
uöt64_t
 
	mdˇche_ªad_miss
;

367 
uöt64_t
 
	mdˇche_wrôe_miss
;

368 
uöt64_t
 
	ml2_ˇche_ªad
;

369 
uöt64_t
 
	ml2_ˇche_wrôe
;

370 
uöt64_t
 
	ml2_ˇche_ªad_miss
;

371 
uöt64_t
 
	ml2_ˇche_wrôe_miss
;

374 
uöt64_t
 
	meˇŒ
;

375 
uöt64_t
 
	möãºu±s
;

376 
uöt64_t
 
	mös_∑ge_wÆks
;

377 
uöt64_t
 
	mlﬂd_∑ge_wÆks
;

378 
uöt64_t
 
	m°‹e_∑ge_wÆks
;

379 
uöt64_t
 
	mös_∑ge_Áu…s
;

380 
uöt64_t
 
	mlﬂd_∑ge_Áu…s
;

381 
uöt64_t
 
	m°‹e_∑ge_Áu…s
;

382 } 
	tSimSèts
;

384 
SimP¨ams
 *
sim_∑øms_öô
();

385 
sim_∑øms_¥öt
(c⁄° 
SimP¨ams
 *
p
);

386 
sim_∑øms_vÆid©e
(c⁄° 
SimP¨ams
 *
p
);

387 
sim_∑øms_‰ì
(
SimP¨ams
 *
p
);

389 
sim_°©s_¥öt
(
SimSèts
 *
s
, c⁄° *
fûíame
);

390 
sim_°©s_ª£t
(
SimSèts
 *
s
);

	@sdl.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

30 
	~<f˙é.h
>

31 
	~<î∫o.h
>

33 
	~<SDL/SDL.h
>

35 
	~"cutûs.h
"

36 
	~"vútio.h
"

37 
	~"machöe.h
"

39 
	#KEYCODE_MAX
 127

	)

41 
SDL_SurÁ˚
 *
	gs¸ìn
;

42 
SDL_SurÁ˚
 *
	gfb_surÁ˚
;

43 
	gs¸ìn_width
, 
	gs¸ìn_height
, 
	gfb_width
, 
	gfb_height
, 
	gfb_°ride
;

44 
SDL_Curs‹
 *
	gsdl_curs‹_hiddí
;

45 
uöt8_t
 
	gkey_¥es£d
[
KEYCODE_MAX
 + 1];

47 
	$sdl_upd©e_fb_surÁ˚
(
FBDevi˚
 *
fb_dev
)

49 i‡(!
fb_surÁ˚
)

50 
f‹˚_Æloc
;

51 i‡(
fb_width
 !
fb_dev
->
width
 ||

52 
fb_height
 !
fb_dev
->
height
 ||

53 
fb_°ride
 !
fb_dev
->
°ride
) {

54 
f‹˚_Æloc
:

55 i‡(
fb_surÁ˚
 !
NULL
)

56 
	`SDL_FªeSurÁ˚
(
fb_surÁ˚
);

57 
fb_width
 = 
fb_dev
->
width
;

58 
fb_height
 = 
fb_dev
->
height
;

59 
fb_°ride
 = 
fb_dev
->
°ride
;

60 
fb_surÁ˚
 = 
	`SDL_Cª©eRGBSurÁ˚From
(
fb_dev
->
fb_d©a
,

61 
fb_dev
->
width
, fb_dev->
height
,

62 32, 
fb_dev
->
°ride
,

67 i‡(!
fb_surÁ˚
) {

68 
	`Ârötf
(
°dîr
, "CouldÇot create SDL framebuffer surface\n");

69 
	`exô
(1);

72 
	}
}

74 
	$sdl_upd©e
(
FBDevi˚
 *
fb_dev
, *
›aque
,

75 
x
, 
y
, 
w
, 
h
)

77 
SDL_Re˘
 
r
;

79 
r
.
x
 = x;

80 
r
.
y
 = y;

81 
r
.
w
 = w;

82 
r
.
h
 = h;

83 
	`SDL_BlôSurÁ˚
(
fb_surÁ˚
, &
r
, 
s¸ìn
, &r);

84 
	`SDL_Upd©eRe˘
(
s¸ìn
, 
r
.
x
,Ñ.
y
,Ñ.
w
,Ñ.
h
);

85 
	}
}

87 #i‡
deföed
(
_WIN32
)

89 
	$sdl_gë_keycode
(c⁄° 
SDL_KeybﬂrdEvít
 *
ev
)

91  
ev
->
keysym
.
sˇncode
;

92 
	}
}

97 
	$sdl_gë_keycode
(c⁄° 
SDL_KeybﬂrdEvít
 *
ev
)

99 
keycode
;

100 
keycode
 = 
ev
->
keysym
.
sˇncode
;

101 i‡(
keycode
 < 9) {

102 
keycode
 = 0;

103 } i‡(
keycode
 < 127 + 8) {

104 
keycode
 -= 8;

106 
keycode
 = 0;

108  
keycode
;

109 
	}
}

114 
	$sdl_ª£t_keys
(
VútMachöe
 *
m
)

116 
i
;

118 
i
 = 1; i <
KEYCODE_MAX
; i++) {

119 i‡(
key_¥es£d
[
i
]) {

120 
	`vm_£nd_key_evít
(
m
, 
FALSE
, 
i
);

121 
key_¥es£d
[
i
] = 
FALSE
;

124 
	}
}

126 
	$sdl_h™dÀ_key_evít
(c⁄° 
SDL_KeybﬂrdEvít
 *
ev
, 
VútMachöe
 *
m
)

128 
keycode
, 
key¥ess
;

130 
keycode
 = 
	`sdl_gë_keycode
(
ev
);

131 i‡(
keycode
) {

132 i‡(
keycode
 == 0x3a || keycode ==0x45) {

134 
	`vm_£nd_key_evít
(
m
, 
TRUE
, 
keycode
);

135 
	`vm_£nd_key_evít
(
m
, 
FALSE
, 
keycode
);

137 
key¥ess
 = (
ev
->
ty≥
 =
SDL_KEYDOWN
);

138 i‡(
keycode
 <
KEYCODE_MAX
)

139 
key_¥es£d
[
keycode
] = 
key¥ess
;

140 
	`vm_£nd_key_evít
(
m
, 
key¥ess
, 
keycode
);

142 } i‡(
ev
->
ty≥
 =
SDL_KEYUP
) {

145 
	`sdl_ª£t_keys
(
m
);

147 
	}
}

149 
	$sdl_£nd_mou£_evít
(
VútMachöe
 *
m
, 
x1
, 
y1
,

150 
dz
, 
°©e
, 
BOOL
 
is_absﬁuã
)

152 
buâ⁄s
, 
x
, 
y
;

154 
buâ⁄s
 = 0;

155 i‡(
°©e
 & 
	`SDL_BUTTON
(
SDL_BUTTON_LEFT
))

156 
buâ⁄s
 |= (1 << 0);

157 i‡(
°©e
 & 
	`SDL_BUTTON
(
SDL_BUTTON_RIGHT
))

158 
buâ⁄s
 |= (1 << 1);

159 i‡(
°©e
 & 
	`SDL_BUTTON
(
SDL_BUTTON_MIDDLE
))

160 
buâ⁄s
 |= (1 << 2);

161 i‡(
is_absﬁuã
) {

162 
x
 = (
x1
 * 32768Ë/ 
s¸ìn_width
;

163 
y
 = (
y1
 * 32768Ë/ 
s¸ìn_height
;

165 
x
 = 
x1
;

166 
y
 = 
y1
;

168 
	`vm_£nd_mou£_evít
(
m
, 
x
, 
y
, 
dz
, 
buâ⁄s
);

169 
	}
}

171 
	$sdl_h™dÀ_mou£_mŸi⁄_evít
(c⁄° 
SDL_Evít
 *
ev
, 
VútMachöe
 *
m
)

173 
BOOL
 
is_absﬁuã
 = 
	`vm_mou£_is_absﬁuã
(
m
);

174 
x
, 
y
;

175 i‡(
is_absﬁuã
) {

176 
x
 = 
ev
->
mŸi⁄
.x;

177 
y
 = 
ev
->
mŸi⁄
.y;

179 
x
 = 
ev
->
mŸi⁄
.
xªl
;

180 
y
 = 
ev
->
mŸi⁄
.
yªl
;

182 
	`sdl_£nd_mou£_evít
(
m
, 
x
, 
y
, 0, 
ev
->
mŸi⁄
.
°©e
, 
is_absﬁuã
);

183 
	}
}

185 
	$sdl_h™dÀ_mou£_buâ⁄_evít
(c⁄° 
SDL_Evít
 *
ev
, 
VútMachöe
 *
m
)

187 
BOOL
 
is_absﬁuã
 = 
	`vm_mou£_is_absﬁuã
(
m
);

188 
°©e
, 
dz
;

190 
dz
 = 0;

191 i‡(
ev
->
ty≥
 =
SDL_MOUSEBUTTONDOWN
) {

192 i‡(
ev
->
buâ⁄
.buâ⁄ =
SDL_BUTTON_WHEELUP
) {

193 
dz
 = 1;

194 } i‡(
ev
->
buâ⁄
.buâ⁄ =
SDL_BUTTON_WHEELDOWN
) {

195 
dz
 = -1;

199 
°©e
 = 
	`SDL_GëMou£Sèã
(
NULL
, NULL);

201 i‡(
ev
->
ty≥
 =
SDL_MOUSEBUTTONDOWN
)

202 
°©e
 |
	`SDL_BUTTON
(
ev
->
buâ⁄
.button);

204 
°©e
 &~
	`SDL_BUTTON
(
ev
->
buâ⁄
.button);

206 i‡(
is_absﬁuã
) {

207 
	`sdl_£nd_mou£_evít
(
m
, 
ev
->
buâ⁄
.
x
,Év->buâ⁄.
y
,

208 
dz
, 
°©e
, 
is_absﬁuã
);

210 
	`sdl_£nd_mou£_evít
(
m
, 0, 0, 
dz
, 
°©e
, 
is_absﬁuã
);

212 
	}
}

214 
	$sdl_ª‰esh
(
VútMachöe
 *
m
)

216 
SDL_Evít
 
ev_s
, *
ev
 = &ev_s;

218 i‡(!
m
->
fb_dev
)

221 
	`sdl_upd©e_fb_surÁ˚
(
m
->
fb_dev
);

223 
m
->
fb_dev
->
	`ª‰esh
(m->fb_dev, 
sdl_upd©e
, 
NULL
);

225 
	`SDL_PﬁlEvít
(
ev
)) {

226 
ev
->
ty≥
) {

227 
SDL_KEYDOWN
:

228 
SDL_KEYUP
:

229 
	`sdl_h™dÀ_key_evít
(&
ev
->
key
, 
m
);

231 
SDL_MOUSEMOTION
:

232 
	`sdl_h™dÀ_mou£_mŸi⁄_evít
(
ev
, 
m
);

234 
SDL_MOUSEBUTTONDOWN
:

235 
SDL_MOUSEBUTTONUP
:

236 
	`sdl_h™dÀ_mou£_buâ⁄_evít
(
ev
, 
m
);

238 
SDL_QUIT
:

239 
	`exô
(0);

242 
	}
}

244 
	$sdl_hide_curs‹
()

246 
uöt8_t
 
d©a
 = 0;

247 
sdl_curs‹_hiddí
 = 
	`SDL_Cª©eCurs‹
(&
d©a
, &data, 8, 1, 0, 0);

248 
	`SDL_ShowCurs‹
(1);

249 
	`SDL_SëCurs‹
(
sdl_curs‹_hiddí
);

250 
	}
}

252 
	$sdl_öô
(
width
, 
height
)

254 
Êags
;

256 
s¸ìn_width
 = 
width
;

257 
s¸ìn_height
 = 
height
;

259 i‡(
	`SDL_Inô
 (
SDL_INIT_VIDEO
 | 
SDL_INIT_NOPARACHUTE
)) {

260 
	`Ârötf
(
°dîr
, "CouldÇot initialize SDL -Éxiting\n");

261 
	`exô
(1);

264 
Êags
 = 
SDL_HWSURFACE
 | 
SDL_ASYNCBLIT
 | 
SDL_HWACCEL
;

265 
s¸ìn
 = 
	`SDL_SëVideoMode
(
width
, 
height
, 0, 
Êags
);

266 i‡(!
s¸ìn
 || !s¸ìn->
pixñs
) {

267 
	`Ârötf
(
°dîr
, "CouldÇot open SDL display\n");

268 
	`exô
(1);

271 
	`SDL_WM_SëC≠ti⁄
("TinyEMU", "TinyEMU");

273 
	`sdl_hide_curs‹
();

274 
	}
}

	@sha256.c

11 
	~<°dlib.h
>

12 
	~<°rög.h
>

13 
	~"cutûs.h
"

14 
	~"sha256.h
"

16 
	#LOAD32H
(
a
, 
b
Ë®
	`gë_be32
(b)

	)

17 
	#STORE32H
(
a
, 
b
Ë
	`put_be32
(b,á)

	)

18 
	#STORE64H
(
a
, 
b
Ë
	`put_be64
(b,á)

	)

19 
	#RORc
(
x
, 
y
Ë–((((
uöt32_t
)(x)&0xFFFFFFFFUL)>>(uöt32_t)((y)&31)Ë| ((uöt32_t)(x)<<(uöt32_t)(32-((y)&31)))Ë& 0xFFFFFFFFUL)

	)

21 #i‡
deföed
(
CONFIG_EMBUE
)

22 
	#LTC_SMALL_CODE


	)

30 #ifde‡
LTC_SMALL_CODE


32 c⁄° 
uöt32_t
 
	gK
[64] = {

50 
	#Ch
(
x
,
y
,
z
Ë(z ^ (x & (y ^ z)))

	)

51 
	#Maj
(
x
,
y
,
z
Ë(((x | yË& zË| (x & y))

	)

52 
	#S
(
x
, 
n
Ë
	`RORc
((x),“))

	)

53 
	#R
(
x
, 
n
Ë(((x)&0xFFFFFFFFUL)>>“))

	)

54 
	#Sigma0
(
x
Ë(
	`S
(x, 2Ë^ S(x, 13Ë^ S(x, 22))

	)

55 
	#Sigma1
(
x
Ë(
	`S
(x, 6Ë^ S(x, 11Ë^ S(x, 25))

	)

56 
	#Gamma0
(
x
Ë(
	`S
(x, 7Ë^ S(x, 18Ë^ 
	`R
(x, 3))

	)

57 
	#Gamma1
(
x
Ë(
	`S
(x, 17Ë^ S(x, 19Ë^ 
	`R
(x, 10))

	)

60 
	$sha256_com¥ess
(
SHA256_CTX
 *
s
, *
buf
)

62 
uöt32_t
 
S
[8], 
W
[64], 
t0
, 
t1
;

63 #ifde‡
LTC_SMALL_CODE


64 
uöt32_t
 
t
;

66 
i
;

69 
i
 = 0; i < 8; i++) {

70 
S
[
i
] = 
s
->
°©e
[i];

74 
i
 = 0; i < 16; i++) {

75 
	`LOAD32H
(
W
[
i
], 
buf
 + (4*i));

79 
i
 = 16; i < 64; i++) {

80 
W
[
i
] = 
	`Gamma1
(W[ò- 2]Ë+ W[ò- 7] + 
	`Gamma0
(W[i - 15]) + W[i - 16];

84 #ifde‡
LTC_SMALL_CODE


85 
	#RND
(
a
,
b
,
c
,
d
,
e
,
f
,
g
,
h
,
i
) \

86 
t0
 = 
h
 + 
	`Sigma1
(
e
Ë+ 
	`Ch
”, 
f
, 
g
Ë+ 
K
[
i
] + 
W
[i]; \

87 
t1
 = 
	`Sigma0
(
a
Ë+ 
	`Maj
◊, 
b
, 
c
); \

88 
d
 +
t0
; \

89 
h
 = 
t0
 + 
t1
;

	)

91 
i
 = 0; i < 64; ++i) {

92 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],
i
);

93 
t
 = 
S
[7]; S[7] = S[6]; S[6] = S[5]; S[5] = S[4];

94 
S
[4] = S[3]; S[3] = S[2]; S[2] = S[1]; S[1] = S[0]; S[0] = 
t
;

97 
	#RND
(
a
,
b
,
c
,
d
,
e
,
f
,
g
,
h
,
i
,
ki
) \

98 
t0
 = 
h
 + 
	`Sigma1
(
e
Ë+ 
	`Ch
”, 
f
, 
g
Ë+ 
ki
 + 
W
[
i
]; \

99 
t1
 = 
	`Sigma0
(
a
Ë+ 
	`Maj
◊, 
b
, 
c
); \

100 
d
 +
t0
; \

101 
h
 = 
t0
 + 
t1
;

	)

103 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],0,0x428a2f98);

104 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],1,0x71374491);

105 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],2,0xb5c0fbcf);

106 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],3,0xe9b5dba5);

107 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],4,0x3956c25b);

108 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],5,0x59f111f1);

109 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],6,0x923f82a4);

110 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],7,0xab1c5ed5);

111 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],8,0xd807aa98);

112 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],9,0x12835b01);

113 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],10,0x243185be);

114 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],11,0x550c7dc3);

115 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],12,0x72be5d74);

116 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],13,0x80deb1fe);

117 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],14,0x9bdc06a7);

118 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],15,0xc19bf174);

119 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],16,0xe49b69c1);

120 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],17,0xefbe4786);

121 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],18,0x0fc19dc6);

122 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],19,0x240ca1cc);

123 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],20,0x2de92c6f);

124 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],21,0x4a7484aa);

125 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],22,0x5cb0a9dc);

126 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],23,0x76f988da);

127 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],24,0x983e5152);

128 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],25,0xa831c66d);

129 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],26,0xb00327c8);

130 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],27,0xbf597fc7);

131 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],28,0xc6e00bf3);

132 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],29,0xd5a79147);

133 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],30,0x06ca6351);

134 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],31,0x14292967);

135 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],32,0x27b70a85);

136 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],33,0x2e1b2138);

137 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],34,0x4d2c6dfc);

138 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],35,0x53380d13);

139 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],36,0x650a7354);

140 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],37,0x766a0abb);

141 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],38,0x81c2c92e);

142 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],39,0x92722c85);

143 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],40,0xa2bfe8a1);

144 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],41,0xa81a664b);

145 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],42,0xc24b8b70);

146 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],43,0xc76c51a3);

147 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],44,0xd192e819);

148 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],45,0xd6990624);

149 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],46,0xf40e3585);

150 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],47,0x106aa070);

151 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],48,0x19a4c116);

152 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],49,0x1e376c08);

153 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],50,0x2748774c);

154 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],51,0x34b0bcb5);

155 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],52,0x391c0cb3);

156 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],53,0x4ed8aa4a);

157 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],54,0x5b9cca4f);

158 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],55,0x682e6ff3);

159 
	`RND
(
S
[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7],56,0x748f82ee);

160 
	`RND
(
S
[7],S[0],S[1],S[2],S[3],S[4],S[5],S[6],57,0x78a5636f);

161 
	`RND
(
S
[6],S[7],S[0],S[1],S[2],S[3],S[4],S[5],58,0x84c87814);

162 
	`RND
(
S
[5],S[6],S[7],S[0],S[1],S[2],S[3],S[4],59,0x8cc70208);

163 
	`RND
(
S
[4],S[5],S[6],S[7],S[0],S[1],S[2],S[3],60,0x90befffa);

164 
	`RND
(
S
[3],S[4],S[5],S[6],S[7],S[0],S[1],S[2],61,0xa4506ceb);

165 
	`RND
(
S
[2],S[3],S[4],S[5],S[6],S[7],S[0],S[1],62,0xbef9a3f7);

166 
	`RND
(
S
[1],S[2],S[3],S[4],S[5],S[6],S[7],S[0],63,0xc67178f2);

168 #unde‡
RND


173 
i
 = 0; i < 8; i++) {

174 
s
->
°©e
[
i
] = s->°©e[i] + 
S
[i];

176 
	}
}

178 #ifde‡
LTC_CLEAN_STACK


179 
	$sha256_com¥ess
(
hash_°©e
 * 
md
, *
buf
)

181 
îr
;

182 
îr
 = 
	`_sha256_com¥ess
(
md
, 
buf
);

183 
	`bu∫_°ack
((
uöt32_t
) * 74);

184  
îr
;

185 
	}
}

193 
	$SHA256_Inô
(
SHA256_CTX
 *
s
)

195 
s
->
cuæí
 = 0;

196 
s
->
Àngth
 = 0;

197 
s
->
°©e
[0] = 0x6A09E667UL;

198 
s
->
°©e
[1] = 0xBB67AE85UL;

199 
s
->
°©e
[2] = 0x3C6EF372UL;

200 
s
->
°©e
[3] = 0xA54FF53AUL;

201 
s
->
°©e
[4] = 0x510E527FUL;

202 
s
->
°©e
[5] = 0x9B05688CUL;

203 
s
->
°©e
[6] = 0x1F83D9ABUL;

204 
s
->
°©e
[7] = 0x5BE0CD19UL;

205 
	}
}

207 
	$SHA256_Upd©e
(
SHA256_CTX
 *
s
, c⁄° 
uöt8_t
 *
ö
, 
öÀn
)

209 
n
;

211 i‡(
s
->
cuæí
 > (s->
buf
)) {

212 
	`ab‹t
();

214 i‡((
s
->
Àngth
 + 
öÀn
) < s->length) {

215 
	`ab‹t
();

217 
öÀn
 > 0) {

218 i‡(
s
->
cuæí
 =0 && 
öÀn
 >= 64) {

219 
	`sha256_com¥ess
(
s
, (*)
ö
);

220 
s
->
Àngth
 += 64 * 8;

221 
ö
 += 64;

222 
öÀn
 -= 64;

224 
n
 = 
	`mö_öt
(
öÀn
, 64 - 
s
->
cuæí
);

225 
	`mem˝y
(
s
->
buf
 + s->
cuæí
, 
ö
, (
size_t
)
n
);

226 
s
->
cuæí
 +
n
;

227 
ö
 +
n
;

228 
öÀn
 -
n
;

229 i‡(
s
->
cuæí
 == 64) {

230 
	`sha256_com¥ess
(
s
, s->
buf
);

231 
s
->
Àngth
 += 8*64;

232 
s
->
cuæí
 = 0;

235 } 
	}
}

243 
	$SHA256_FöÆ
(
uöt8_t
 *
out
, 
SHA256_CTX
 *
s
)

245 
i
;

247 i‡(
s
->
cuæí
 >(s->
buf
)) {

248 
	`ab‹t
();

253 
s
->
Àngth
 +s->
cuæí
 * 8;

256 
s
->
buf
[s->
cuæí
++] = ()0x80;

262 i‡(
s
->
cuæí
 > 56) {

263 
s
->
cuæí
 < 64) {

264 
s
->
buf
[s->
cuæí
++] = ()0;

266 
	`sha256_com¥ess
(
s
, s->
buf
);

267 
s
->
cuæí
 = 0;

271 
s
->
cuæí
 < 56) {

272 
s
->
buf
[s->
cuæí
++] = ()0;

276 
	`STORE64H
(
s
->
Àngth
, s->
buf
+56);

277 
	`sha256_com¥ess
(
s
, s->
buf
);

280 
i
 = 0; i < 8; i++) {

281 
	`STORE32H
(
s
->
°©e
[
i
], 
out
+(4*i));

283 #ifde‡
LTC_CLEAN_STACK


284 
	`zîomem
(
md
, (
hash_°©e
));

286 
	}
}

288 
	$SHA256
(c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
, uöt8_à*
out
)

290 
SHA256_CTX
 
˘x
;

292 
	`SHA256_Inô
(&
˘x
);

293 
	`SHA256_Upd©e
(&
˘x
, 
buf
, 
buf_Àn
);

294 
	`SHA256_FöÆ
(
out
, &
˘x
);

295 
	}
}

302 
	$sha256_ã°
()

304 #i‚de‡
LTC_TEST


305  
CRYPT_NOP
;

308 *
msg
;

309 
hash
[32];

310 } 
ã°s
[] = {

325 
i
;

326 
tmp
[32];

327 
hash_°©e
 
md
;

329 
i
 = 0; i < ()((
ã°s
) / (tests[0])); i++) {

330 
	`sha256_öô
(&
md
);

331 
	`sha256_¥o˚ss
(&
md
, (*)
ã°s
[
i
].
msg
, ()
	`°æí
(tests[i].msg));

332 
	`sha256_d⁄e
(&
md
, 
tmp
);

333 i‡(
	`XMEMCMP
(
tmp
, 
ã°s
[
i
].
hash
, 32) != 0) {

334  
CRYPT_FAIL_TESTVECTOR
;

337  
CRYPT_OK
;

339 
	}
}

	@sha256.h

24 #i‚de‡
SHA256_H


25 
	#SHA256_H


	)

27 
	#SHA256_DIGEST_LENGTH
 32

	)

30 
uöt64_t
 
	mÀngth
;

31 
uöt32_t
 
	m°©e
[8], 
	mcuæí
;

32 
uöt8_t
 
	mbuf
[64];

33 } 
	tSHA256_CTX
;

35 
SHA256_Inô
(
SHA256_CTX
 *
s
);

36 
SHA256_Upd©e
(
SHA256_CTX
 *
s
, c⁄° 
uöt8_t
 *
ö
, 
öÀn
);

37 
SHA256_FöÆ
(
uöt8_t
 *
out
, 
SHA256_CTX
 *
s
);

38 
SHA256
(c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
, uöt8_à*
out
);

	@share/test.c

1 
	~<°dio.h
>

2 
	#SIM_START
(Ë
	`asm
("c§†0x800,zîo")

	)

3 
	#SIM_STOP
(Ë
	`asm
("c§† 0x801,zîo")

	)

5 
	$maö
()

7 
	`¥ötf
("Hello, World!\n");

8 
a
,
b
,
c
;

9 
	`SIM_START
();

10 
a
=1;

11 
b
=2;

12 
c
=
a
+
b
;

13 
	`SIM_STOP
();

15 
	}
}

	@simplefb.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

31 
	~"cutûs.h
"

32 
	~"iomem.h
"

33 
	~"vútio.h
"

34 
	~"machöe.h
"

38 
	#FB_ALLOC_ALIGN
 65536

	)

40 
	sSim∂eFBSèã
 {

41 
FBDevi˚
 *
	mfb_dev
;

42 
	mfb_∑ge_cou¡
;

43 
PhysMem‹yR™ge
 *
	mmem_ønge
;

46 
	#MAX_MERGE_DISTANCE
 3

	)

48 
	$sim∂efb_ª‰esh
(
FBDevi˚
 *
fb_dev
,

49 
Sim∂eFBDøwFunc
 *
ªdøw_func
, *
›aque
,

50 
PhysMem‹yR™ge
 *
mem_ønge
,

51 
fb_∑ge_cou¡
)

53 c⁄° 
uöt32_t
 *
dúty_bôs
;

54 
uöt32_t
 
dúty_vÆ
;

55 
y0
, 
y1
, 
∑ge_y0
, 
∑ge_y1
, 
byã_pos
, 
∑ge_ödex
, 
bô_pos
;

57 
dúty_bôs
 = 
	`phys_mem_gë_dúty_bôs
(
mem_ønge
);

59 
∑ge_ödex
 = 0;

60 
y0
 = 
y1
 = 0;

61 
∑ge_ödex
 < 
fb_∑ge_cou¡
) {

62 
dúty_vÆ
 = 
dúty_bôs
[
∑ge_ödex
 >> 5];

63 i‡(
dúty_vÆ
 != 0) {

64 
bô_pos
 = 0;

65 
dúty_vÆ
 != 0) {

66 ((
dúty_vÆ
 >> 
bô_pos
) & 1) == 0)

67 
bô_pos
++;

68 
dúty_vÆ
 &~(1 << 
bô_pos
);

70 
byã_pos
 = (
∑ge_ödex
 + 
bô_pos
Ë* 
DEVRAM_PAGE_SIZE
;

71 
∑ge_y0
 = 
byã_pos
 / 
fb_dev
->
°ride
;

72 
∑ge_y1
 = ((
byã_pos
 + 
DEVRAM_PAGE_SIZE
 - 1Ë/ 
fb_dev
->
°ride
) + 1;

73 
∑ge_y1
 = 
	`mö_öt
’age_y1, 
fb_dev
->
height
);

74 i‡(
y0
 =
y1
) {

75 
y0
 = 
∑ge_y0
;

76 
y1
 = 
∑ge_y1
;

77 } i‡(
∑ge_y0
 <(
y1
 + 
MAX_MERGE_DISTANCE
)) {

79 
y1
 = 
∑ge_y1
;

82 
	`ªdøw_func
(
fb_dev
, 
›aque
,

83 0, 
y0
, 
fb_dev
->
width
, 
y1
 - y0);

84 
y0
 = 
∑ge_y0
;

85 
y1
 = 
∑ge_y1
;

89 
∑ge_ödex
 += 32;

92 i‡(
y0
 !
y1
) {

93 
	`ªdøw_func
(
fb_dev
, 
›aque
,

94 0, 
y0
, 
fb_dev
->
width
, 
y1
 - y0);

96 
	}
}

98 
	$sim∂efb_ª‰esh1
(
FBDevi˚
 *
fb_dev
,

99 
Sim∂eFBDøwFunc
 *
ªdøw_func
, *
›aque
)

101 
Sim∂eFBSèã
 *
s
 = 
fb_dev
->
devi˚_›aque
;

102 
	`sim∂efb_ª‰esh
(
fb_dev
, 
ªdøw_func
, 
›aque
, 
s
->
mem_ønge
,

103 
s
->
fb_∑ge_cou¡
);

104 
	}
}

106 
Sim∂eFBSèã
 *
	$sim∂efb_öô
(
PhysMem‹yM≠
 *
m≠
, 
uöt64_t
 
phys_addr
,

107 
FBDevi˚
 *
fb_dev
, 
width
, 
height
)

109 
Sim∂eFBSèã
 *
s
;

111 
s
 = 
	`mÆlocz
((*s));

112 
s
->
fb_dev
 = fb_dev;

114 
fb_dev
->
width
 = width;

115 
fb_dev
->
height
 = height;

116 
fb_dev
->
°ride
 = 
width
 * 4;

117 
fb_dev
->
fb_size
 = (
height
 * fb_dev->
°ride
 + 
FB_ALLOC_ALIGN
 - 1) & ~(FB_ALLOC_ALIGN - 1);

118 
s
->
fb_∑ge_cou¡
 = 
fb_dev
->
fb_size
 >> 
DEVRAM_PAGE_SIZE_LOG2
;

120 
s
->
mem_ønge
 = 
	`˝u_ªgi°î_øm
(
m≠
, 
phys_addr
, 
fb_dev
->
fb_size
,

121 
DEVRAM_FLAG_DIRTY_BITS
);

123 
fb_dev
->
fb_d©a
 = 
s
->
mem_ønge
->
phys_mem
;

124 
fb_dev
->
devi˚_›aque
 = 
s
;

125 
fb_dev
->
ª‰esh
 = 
sim∂efb_ª‰esh1
;

126  
s
;

127 
	}
}

	@slirp/bootp.c

24 
	~"¶úp.h
"

28 
	#LEASE_TIME
 (24 * 3600)

	)

30 c⁄° 
uöt8_t
 
	grfc1533_cookõ
[] = { 
RFC1533_COOKIE
 };

32 #ifde‡
DEBUG


33 
	#DPRINTF
(
fmt
, ...) \

34 dÿi‡(
¶úp_debug
 & 
DBG_CALL
Ë{ 
	`Ârötf
(
dfd
, 
fmt
, ## 
__VA_ARGS__
); 
	`fÊush
(dfd); } 0)

	)

36 
	#DPRINTF
(
fmt
, ...Ëdo{}0)

	)

39 
BOOTPClõ¡
 *
	$gë_√w_addr
(
Slúp
 *
¶úp
, 
ö_addr
 *
∑ddr
,

40 c⁄° 
uöt8_t
 *
maˇddr
)

42 
BOOTPClõ¡
 *
bc
;

43 
i
;

45 
i
 = 0; i < 
NB_BOOTP_CLIENTS
; i++) {

46 
bc
 = &
¶úp
->
boŸp_˛õ¡s
[
i
];

47 i‡(!
bc
->
Æloˇãd
 || !
	`memcmp
(
maˇddr
, bc->macaddr, 6))

48 
found
;

50  
NULL
;

51 
found
:

52 
bc
 = &
¶úp
->
boŸp_˛õ¡s
[
i
];

53 
bc
->
Æloˇãd
 = 1;

54 
∑ddr
->
s_addr
 = 
¶úp
->
vdh˝_°¨èddr
.s_add∏+ 
	`ht⁄l
(
i
);

55  
bc
;

56 
	}
}

58 
BOOTPClõ¡
 *
	$ªque°_addr
(
Slúp
 *
¶úp
, c⁄° 
ö_addr
 *
∑ddr
,

59 c⁄° 
uöt8_t
 *
maˇddr
)

61 
uöt32_t
 
ªq_addr
 = 
	`¡ohl
(
∑ddr
->
s_addr
);

62 
uöt32_t
 
dh˝_addr
 = 
	`¡ohl
(
¶úp
->
vdh˝_°¨èddr
.
s_addr
);

63 
BOOTPClõ¡
 *
bc
;

65 i‡(
ªq_addr
 >
dh˝_addr
 &&

66 
ªq_addr
 < (
dh˝_addr
 + 
NB_BOOTP_CLIENTS
)) {

67 
bc
 = &
¶úp
->
boŸp_˛õ¡s
[
ªq_addr
 - 
dh˝_addr
];

68 i‡(!
bc
->
Æloˇãd
 || !
	`memcmp
(
maˇddr
, bc->macaddr, 6)) {

69 
bc
->
Æloˇãd
 = 1;

70  
bc
;

73  
NULL
;

74 
	}
}

76 
BOOTPClõ¡
 *
	$föd_addr
(
Slúp
 *
¶úp
, 
ö_addr
 *
∑ddr
,

77 c⁄° 
uöt8_t
 *
maˇddr
)

79 
BOOTPClõ¡
 *
bc
;

80 
i
;

82 
i
 = 0; i < 
NB_BOOTP_CLIENTS
; i++) {

83 i‡(!
	`memcmp
(
maˇddr
, 
¶úp
->
boŸp_˛õ¡s
[
i
].macaddr, 6))

84 
found
;

86  
NULL
;

87 
found
:

88 
bc
 = &
¶úp
->
boŸp_˛õ¡s
[
i
];

89 
bc
->
Æloˇãd
 = 1;

90 
∑ddr
->
s_addr
 = 
¶úp
->
vdh˝_°¨èddr
.s_add∏+ 
	`ht⁄l
(
i
);

91  
bc
;

92 
	}
}

94 
	$dh˝_decode
(c⁄° 
boŸp_t
 *
bp
, *
pmsg_ty≥
,

95 
ö_addr
 *
¥eq_addr
)

97 c⁄° 
uöt8_t
 *
p
, *
p_íd
;

98 
Àn
, 
èg
;

100 *
pmsg_ty≥
 = 0;

101 
¥eq_addr
->
s_addr
 = 
	`ht⁄l
(0L);

103 
p
 = 
bp
->
bp_víd
;

104 
p_íd
 = 
p
 + 
DHCP_OPT_LEN
;

105 i‡(
	`memcmp
(
p
, 
rfc1533_cookõ
, 4) != 0)

107 
p
 += 4;

108 
p
 < 
p_íd
) {

109 
èg
 = 
p
[0];

110 i‡(
èg
 =
RFC1533_PAD
) {

111 
p
++;

112 } i‡(
èg
 =
RFC1533_END
) {

115 
p
++;

116 i‡(
p
 >
p_íd
)

118 
Àn
 = *
p
++;

119 
	`DPRINTF
("dh˝:Åag=%dÜí=%d\n", 
èg
, 
Àn
);

121 
èg
) {

122 
RFC2132_MSG_TYPE
:

123 i‡(
Àn
 >= 1)

124 *
pmsg_ty≥
 = 
p
[0];

126 
RFC2132_REQ_ADDR
:

127 i‡(
Àn
 >= 4) {

128 
	`mem˝y
(&(
¥eq_addr
->
s_addr
), 
p
, 4);

134 
p
 +
Àn
;

137 i‡(*
pmsg_ty≥
 =
DHCPREQUEST
 && 
¥eq_addr
->
s_addr
 =
	`ht⁄l
(0L) &&

138 
bp
->
bp_cüddr
.
s_addr
) {

139 
	`mem˝y
(&(
¥eq_addr
->
s_addr
), &
bp
->
bp_cüddr
, 4);

141 
	}
}

143 
	$boŸp_ª∂y
(
Slúp
 *
¶úp
, c⁄° 
boŸp_t
 *
bp
)

145 
BOOTPClõ¡
 *
bc
 = 
NULL
;

146 
mbuf
 *
m
;

147 
boŸp_t
 *
rbp
;

148 
sockaddr_ö
 
ßddr
, 
daddr
;

149 
ö_addr
 
¥eq_addr
;

150 
dh˝_msg_ty≥
, 
vÆ
;

151 
uöt8_t
 *
q
;

154 
	`dh˝_decode
(
bp
, &
dh˝_msg_ty≥
, &
¥eq_addr
);

155 
	`DPRINTF
("boŸ∞∑ckë op=%d msgty≥=%d", 
bp
->
bp_›
, 
dh˝_msg_ty≥
);

156 i‡(
¥eq_addr
.
s_addr
 !
	`ht⁄l
(0L))

157 
	`DPRINTF
("Ñeq_addr=%08x\n", 
	`¡ohl
(
¥eq_addr
.
s_addr
));

159 
	`DPRINTF
("\n");

161 i‡(
dh˝_msg_ty≥
 == 0)

162 
dh˝_msg_ty≥
 = 
DHCPREQUEST
;

164 i‡(
dh˝_msg_ty≥
 !
DHCPDISCOVER
 &&

165 
dh˝_msg_ty≥
 !
DHCPREQUEST
)

168 
	`mem˝y
(
¶úp
->
˛õ¡_ëhaddr
, 
bp
->
bp_hwaddr
, 6);

170 
m
 = 
	`m_gë
(
¶úp
);

171 i‡(!
m
) {

174 
m
->
m_d©a
 +
IF_MAXLINKHDR
;

175 
rbp
 = (
boŸp_t
 *)
m
->
m_d©a
;

176 
m
->
m_d©a
 +(
udpùhdr
);

177 
	`mem£t
(
rbp
, 0, (
boŸp_t
));

179 i‡(
dh˝_msg_ty≥
 =
DHCPDISCOVER
) {

180 i‡(
¥eq_addr
.
s_addr
 !
	`ht⁄l
(0L)) {

181 
bc
 = 
	`ªque°_addr
(
¶úp
, &
¥eq_addr
, slúp->
˛õ¡_ëhaddr
);

182 i‡(
bc
) {

183 
daddr
.
sö_addr
 = 
¥eq_addr
;

186 i‡(!
bc
) {

187 
√w_addr
:

188 
bc
 = 
	`gë_√w_addr
(
¶úp
, &
daddr
.
sö_addr
, slúp->
˛õ¡_ëhaddr
);

189 i‡(!
bc
) {

190 
	`DPRINTF
("noáddressÜeft\n");

194 
	`mem˝y
(
bc
->
maˇddr
, 
¶úp
->
˛õ¡_ëhaddr
, 6);

195 } i‡(
¥eq_addr
.
s_addr
 !
	`ht⁄l
(0L)) {

196 
bc
 = 
	`ªque°_addr
(
¶úp
, &
¥eq_addr
, slúp->
˛õ¡_ëhaddr
);

197 i‡(
bc
) {

198 
daddr
.
sö_addr
 = 
¥eq_addr
;

199 
	`mem˝y
(
bc
->
maˇddr
, 
¶úp
->
˛õ¡_ëhaddr
, 6);

201 
daddr
.
sö_addr
.
s_addr
 = 0;

204 
bc
 = 
	`föd_addr
(
¶úp
, &
daddr
.
sö_addr
, 
bp
->
bp_hwaddr
);

205 i‡(!
bc
) {

208 
√w_addr
;

212 
ßddr
.
sö_addr
 = 
¶úp
->
vho°_addr
;

213 
ßddr
.
sö_p‹t
 = 
	`ht⁄s
(
BOOTP_SERVER
);

215 
daddr
.
sö_p‹t
 = 
	`ht⁄s
(
BOOTP_CLIENT
);

217 
rbp
->
bp_›
 = 
BOOTP_REPLY
;

218 
rbp
->
bp_xid
 = 
bp
->bp_xid;

219 
rbp
->
bp_hty≥
 = 1;

220 
rbp
->
bp_hÀn
 = 6;

221 
	`mem˝y
(
rbp
->
bp_hwaddr
, 
bp
->bp_hwaddr, 6);

223 
rbp
->
bp_yüddr
 = 
daddr
.
sö_addr
;

224 
rbp
->
bp_süddr
 = 
ßddr
.
sö_addr
;

226 
q
 = 
rbp
->
bp_víd
;

227 
	`mem˝y
(
q
, 
rfc1533_cookõ
, 4);

228 
q
 += 4;

230 i‡(
bc
) {

231 
	`DPRINTF
("%sáddr=%08x\n",

232 (
dh˝_msg_ty≥
 =
DHCPDISCOVER
) ? "offered" : "ack'ed",

233 
	`¡ohl
(
daddr
.
sö_addr
.
s_addr
));

235 i‡(
dh˝_msg_ty≥
 =
DHCPDISCOVER
) {

236 *
q
++ = 
RFC2132_MSG_TYPE
;

237 *
q
++ = 1;

238 *
q
++ = 
DHCPOFFER
;

240 *
q
++ = 
RFC2132_MSG_TYPE
;

241 *
q
++ = 1;

242 *
q
++ = 
DHCPACK
;

245 i‡(
¶úp
->
boŸp_fûíame
)

246 
	`¢¥ötf
((*)
rbp
->
bp_fûe
, (rbp->bp_file), "%s",

247 
¶úp
->
boŸp_fûíame
);

249 *
q
++ = 
RFC2132_SRV_ID
;

250 *
q
++ = 4;

251 
	`mem˝y
(
q
, &
ßddr
.
sö_addr
, 4);

252 
q
 += 4;

254 *
q
++ = 
RFC1533_NETMASK
;

255 *
q
++ = 4;

256 
	`mem˝y
(
q
, &
¶úp
->
v√tw‹k_mask
, 4);

257 
q
 += 4;

259 i‡(!
¶úp
->
ª°ri˘ed
) {

260 *
q
++ = 
RFC1533_GATEWAY
;

261 *
q
++ = 4;

262 
	`mem˝y
(
q
, &
ßddr
.
sö_addr
, 4);

263 
q
 += 4;

265 *
q
++ = 
RFC1533_DNS
;

266 *
q
++ = 4;

267 
	`mem˝y
(
q
, &
¶úp
->
v«me£rvî_addr
, 4);

268 
q
 += 4;

271 *
q
++ = 
RFC2132_LEASE_TIME
;

272 *
q
++ = 4;

273 
vÆ
 = 
	`ht⁄l
(
LEASE_TIME
);

274 
	`mem˝y
(
q
, &
vÆ
, 4);

275 
q
 += 4;

277 i‡(*
¶úp
->
˛õ¡_ho°«me
) {

278 
vÆ
 = 
	`°æí
(
¶úp
->
˛õ¡_ho°«me
);

279 *
q
++ = 
RFC1533_HOSTNAME
;

280 *
q
++ = 
vÆ
;

281 
	`mem˝y
(
q
, 
¶úp
->
˛õ¡_ho°«me
, 
vÆ
);

282 
q
 +
vÆ
;

285 c⁄° 
«k_msg
[] = "requestedáddressÇotávailable";

287 
	`DPRINTF
("«k'edáddr=%08x\n", 
	`¡ohl
(
¥eq_addr
->
s_addr
));

289 *
q
++ = 
RFC2132_MSG_TYPE
;

290 *
q
++ = 1;

291 *
q
++ = 
DHCPNAK
;

293 *
q
++ = 
RFC2132_MESSAGE
;

294 *
q
++ = (
«k_msg
) - 1;

295 
	`mem˝y
(
q
, 
«k_msg
, (nak_msg) - 1);

296 
q
 +(
«k_msg
) - 1;

298 *
q
 = 
RFC1533_END
;

300 
daddr
.
sö_addr
.
s_addr
 = 0xffffffffu;

302 
m
->
m_Àn
 = (
boŸp_t
) -

303 (
ù
Ë- (
udphdr
);

304 
	`udp_ouçut2
(
NULL
, 
m
, &
ßddr
, &
daddr
, 
IPTOS_LOWDELAY
);

305 
	}
}

307 
	$boŸp_öput
(
mbuf
 *
m
)

309 
boŸp_t
 *
bp
 = 
	`mtod
(
m
, bootp_t *);

311 i‡(
bp
->
bp_›
 =
BOOTP_REQUEST
) {

312 
	`boŸp_ª∂y
(
m
->
¶úp
, 
bp
);

314 
	}
}

	@slirp/bootp.h

3 
	#BOOTP_SERVER
 67

	)

4 
	#BOOTP_CLIENT
 68

	)

6 
	#BOOTP_REQUEST
 1

	)

7 
	#BOOTP_REPLY
 2

	)

9 
	#RFC1533_COOKIE
 99, 130, 83, 99

	)

10 
	#RFC1533_PAD
 0

	)

11 
	#RFC1533_NETMASK
 1

	)

12 
	#RFC1533_TIMEOFFSET
 2

	)

13 
	#RFC1533_GATEWAY
 3

	)

14 
	#RFC1533_TIMESERVER
 4

	)

15 
	#RFC1533_IEN116NS
 5

	)

16 
	#RFC1533_DNS
 6

	)

17 
	#RFC1533_LOGSERVER
 7

	)

18 
	#RFC1533_COOKIESERVER
 8

	)

19 
	#RFC1533_LPRSERVER
 9

	)

20 
	#RFC1533_IMPRESSSERVER
 10

	)

21 
	#RFC1533_RESOURCESERVER
 11

	)

22 
	#RFC1533_HOSTNAME
 12

	)

23 
	#RFC1533_BOOTFILESIZE
 13

	)

24 
	#RFC1533_MERITDUMPFILE
 14

	)

25 
	#RFC1533_DOMAINNAME
 15

	)

26 
	#RFC1533_SWAPSERVER
 16

	)

27 
	#RFC1533_ROOTPATH
 17

	)

28 
	#RFC1533_EXTENSIONPATH
 18

	)

29 
	#RFC1533_IPFORWARDING
 19

	)

30 
	#RFC1533_IPSOURCEROUTING
 20

	)

31 
	#RFC1533_IPPOLICYFILTER
 21

	)

32 
	#RFC1533_IPMAXREASSEMBLY
 22

	)

33 
	#RFC1533_IPTTL
 23

	)

34 
	#RFC1533_IPMTU
 24

	)

35 
	#RFC1533_IPMTUPLATEAU
 25

	)

36 
	#RFC1533_INTMTU
 26

	)

37 
	#RFC1533_INTLOCALSUBNETS
 27

	)

38 
	#RFC1533_INTBROADCAST
 28

	)

39 
	#RFC1533_INTICMPDISCOVER
 29

	)

40 
	#RFC1533_INTICMPRESPOND
 30

	)

41 
	#RFC1533_INTROUTEDISCOVER
 31

	)

42 
	#RFC1533_INTROUTESOLICIT
 32

	)

43 
	#RFC1533_INTSTATICROUTES
 33

	)

44 
	#RFC1533_LLTRAILERENCAP
 34

	)

45 
	#RFC1533_LLARPCACHETMO
 35

	)

46 
	#RFC1533_LLETHERNETENCAP
 36

	)

47 
	#RFC1533_TCPTTL
 37

	)

48 
	#RFC1533_TCPKEEPALIVETMO
 38

	)

49 
	#RFC1533_TCPKEEPALIVEGB
 39

	)

50 
	#RFC1533_NISDOMAIN
 40

	)

51 
	#RFC1533_NISSERVER
 41

	)

52 
	#RFC1533_NTPSERVER
 42

	)

53 
	#RFC1533_VENDOR
 43

	)

54 
	#RFC1533_NBNS
 44

	)

55 
	#RFC1533_NBDD
 45

	)

56 
	#RFC1533_NBNT
 46

	)

57 
	#RFC1533_NBSCOPE
 47

	)

58 
	#RFC1533_XFS
 48

	)

59 
	#RFC1533_XDM
 49

	)

61 
	#RFC2132_REQ_ADDR
 50

	)

62 
	#RFC2132_LEASE_TIME
 51

	)

63 
	#RFC2132_MSG_TYPE
 53

	)

64 
	#RFC2132_SRV_ID
 54

	)

65 
	#RFC2132_PARAM_LIST
 55

	)

66 
	#RFC2132_MESSAGE
 56

	)

67 
	#RFC2132_MAX_SIZE
 57

	)

68 
	#RFC2132_RENEWAL_TIME
 58

	)

69 
	#RFC2132_REBIND_TIME
 59

	)

71 
	#DHCPDISCOVER
 1

	)

72 
	#DHCPOFFER
 2

	)

73 
	#DHCPREQUEST
 3

	)

74 
	#DHCPACK
 5

	)

75 
	#DHCPNAK
 6

	)

77 
	#RFC1533_VENDOR_MAJOR
 0

	)

78 
	#RFC1533_VENDOR_MINOR
 0

	)

80 
	#RFC1533_VENDOR_MAGIC
 128

	)

81 
	#RFC1533_VENDOR_ADDPARM
 129

	)

82 
	#RFC1533_VENDOR_ETHDEV
 130

	)

83 
	#RFC1533_VENDOR_HOWTO
 132

	)

84 
	#RFC1533_VENDOR_MNUOPTS
 160

	)

85 
	#RFC1533_VENDOR_SELECTION
 176

	)

86 
	#RFC1533_VENDOR_MOTD
 184

	)

87 
	#RFC1533_VENDOR_NUMOFMOTD
 8

	)

88 
	#RFC1533_VENDOR_IMG
 192

	)

89 
	#RFC1533_VENDOR_NUMOFIMG
 16

	)

91 
	#RFC1533_END
 255

	)

92 
	#BOOTP_VENDOR_LEN
 64

	)

93 
	#DHCP_OPT_LEN
 312

	)

95 
	sboŸp_t
 {

96 
ù
 
	mù
;

97 
udphdr
 
	mudp
;

98 
uöt8_t
 
	mbp_›
;

99 
uöt8_t
 
	mbp_hty≥
;

100 
uöt8_t
 
	mbp_hÀn
;

101 
uöt8_t
 
	mbp_h›s
;

102 
uöt32_t
 
	mbp_xid
;

103 
uöt16_t
 
	mbp_£cs
;

104 
uöt16_t
 
	munu£d
;

105 
ö_addr
 
	mbp_cüddr
;

106 
ö_addr
 
	mbp_yüddr
;

107 
ö_addr
 
	mbp_süddr
;

108 
ö_addr
 
	mbp_güddr
;

109 
uöt8_t
 
	mbp_hwaddr
[16];

110 
uöt8_t
 
	mbp_¢ame
[64];

111 
uöt8_t
 
	mbp_fûe
[128];

112 
uöt8_t
 
	mbp_víd
[
DHCP_OPT_LEN
];

116 
uöt16_t
 
	mÆloˇãd
;

117 
uöt8_t
 
	mmaˇddr
[6];

118 } 
	tBOOTPClõ¡
;

120 
	#NB_BOOTP_CLIENTS
 16

	)

122 
boŸp_öput
(
mbuf
 *
m
);

	@slirp/cksum.c

33 
	~"¶úp.h
"

44 
	#ADDCARRY
(
x
Ë(x > 65535 ? x -65535 : x)

	)

45 
	#REDUCE
 {
l_utû
.
l
 = 
sum
; sum =Ü_utû.
s
[0] +Ü_util.s[1]; \

46 ()
	`ADDCARRY
(
sum
);}

	)

48 
	$cksum
(
mbuf
 *
m
, 
Àn
)

50 
uöt16_t
 *
w
;

51 
sum
 = 0;

52 
mÀn
 = 0;

53 
byã_sw≠≥d
 = 0;

56 
uöt8_t
 
c
[2];

57 
uöt16_t
 
s
;

58 } 
s_utû
;

60 
uöt16_t
 
s
[2];

61 
uöt32_t
 
l
;

62 } 
l_utû
;

64 i‡(
m
->
m_Àn
 == 0)

65 
c⁄t
;

66 
w
 = 
	`mtod
(
m
, 
uöt16_t
 *);

68 
mÀn
 = 
m
->
m_Àn
;

70 i‡(
Àn
 < 
mÀn
)

71 
mÀn
 = 
Àn
;

72 #ifde‡
DEBUG


73 
Àn
 -
mÀn
;

78 i‡((1 & (Ë
w
Ë&& (
mÀn
 > 0)) {

79 
REDUCE
;

80 
sum
 <<= 8;

81 
s_utû
.
c
[0] = *(
uöt8_t
 *)
w
;

82 
w
 = (
uöt16_t
 *)((
öt8_t
 *)w + 1);

83 
mÀn
--;

84 
byã_sw≠≥d
 = 1;

90 (
mÀn
 -= 32) >= 0) {

91 
sum
 +
w
[0]; sum += w[1]; sum += w[2]; sum += w[3];

92 
sum
 +
w
[4]; sum += w[5]; sum += w[6]; sum += w[7];

93 
sum
 +
w
[8]; sum += w[9]; sum += w[10]; sum += w[11];

94 
sum
 +
w
[12]; sum += w[13]; sum += w[14]; sum += w[15];

95 
w
 += 16;

97 
mÀn
 += 32;

98 (
mÀn
 -= 8) >= 0) {

99 
sum
 +
w
[0]; sum += w[1]; sum += w[2]; sum += w[3];

100 
w
 += 4;

102 
mÀn
 += 8;

103 i‡(
mÀn
 =0 && 
byã_sw≠≥d
 == 0)

104 
c⁄t
;

105 
REDUCE
;

106 (
mÀn
 -= 2) >= 0) {

107 
sum
 +*
w
++;

110 i‡(
byã_sw≠≥d
) {

111 
REDUCE
;

112 
sum
 <<= 8;

113 i‡(
mÀn
 == -1) {

114 
s_utû
.
c
[1] = *(
uöt8_t
 *)
w
;

115 
sum
 +
s_utû
.
s
;

116 
mÀn
 = 0;

119 
mÀn
 = -1;

120 } i‡(
mÀn
 == -1)

121 
s_utû
.
c
[0] = *(
uöt8_t
 *)
w
;

123 
c⁄t
:

124 #ifde‡
DEBUG


125 i‡(
Àn
) {

126 
	`DEBUG_ERROR
((
dfd
, "cksum: out of data\n"));

127 
	`DEBUG_ERROR
((
dfd
, "Üí = %d\n", 
Àn
));

130 i‡(
mÀn
 == -1) {

134 
s_utû
.
c
[1] = 0;

135 
sum
 +
s_utû
.
s
;

137 
REDUCE
;

138  (~
sum
 & 0xffff);

139 
	}
}

	@slirp/debug.h

10 #ifde‡
DEBUG


12 
	#DBG_CALL
 0x1

	)

13 
	#DBG_MISC
 0x2

	)

14 
	#DBG_ERROR
 0x4

	)

16 
	#dfd
 
°dîr


	)

18 
¶úp_debug
;

20 
	#DEBUG_CALL
(
x
Ëi‡(
¶úp_debug
 & 
DBG_CALL
Ë{ 
	`Ârötf
(
dfd
, "%s...\n", x); 
	`fÊush
(dfd); }

	)

21 
	#DEBUG_ARG
(
x
, 
y
Ëi‡(
¶úp_debug
 & 
DBG_CALL
Ë{ 
	`Âutc
(' ', 
dfd
); 
	`Ârötf
(dfd, x, y); fputc('\n', dfd); 
	`fÊush
(dfd); }

	)

22 
	#DEBUG_ARGS
(
x
Ëi‡(
¶úp_debug
 & 
DBG_CALL
Ë{ 
Ârötf
 x ; 
	`fÊush
(
dfd
); }

	)

23 
	#DEBUG_MISC
(
x
Ëi‡(
¶úp_debug
 & 
DBG_MISC
Ë{ 
Ârötf
 x ; 
	`fÊush
(
dfd
); }

	)

24 
	#DEBUG_ERROR
(
x
Ëi‡(
¶úp_debug
 & 
DBG_ERROR
Ë{
Ârötf
 x ; 
	`fÊush
(
dfd
); }

	)

28 
	#DEBUG_CALL
(
x
)

	)

29 
	#DEBUG_ARG
(
x
, 
y
)

	)

30 
	#DEBUG_ARGS
(
x
)

	)

31 
	#DEBUG_MISC
(
x
)

	)

32 
	#DEBUG_ERROR
(
x
)

	)

	@slirp/if.c

8 
	~"¶úp.h
"

10 
	#ifs_öô
(
ifm
Ë((ifm)->
ifs_√xt
 = (ifm)->
ifs_¥ev
 = (ifm))

	)

13 
	$ifs_ösque
(
mbuf
 *
ifm
, mbu‡*
ifmhód
)

15 
ifm
->
ifs_√xt
 = 
ifmhód
->ifs_next;

16 
ifmhód
->
ifs_√xt
 = 
ifm
;

17 
ifm
->
ifs_¥ev
 = 
ifmhód
;

18 
ifm
->
ifs_√xt
->
ifs_¥ev
 = ifm;

19 
	}
}

22 
	$ifs_ªmque
(
mbuf
 *
ifm
)

24 
ifm
->
ifs_¥ev
->
ifs_√xt
 = ifm->ifs_next;

25 
ifm
->
ifs_√xt
->
ifs_¥ev
 = ifm->ifs_prev;

26 
	}
}

29 
	$if_öô
(
Slúp
 *
¶úp
)

31 
¶úp
->
if_Á°q
.
ifq_√xt
 = slúp->if_Á°q.
ifq_¥ev
 = &slirp->if_fastq;

32 
¶úp
->
if_b©chq
.
ifq_√xt
 = slúp->if_b©chq.
ifq_¥ev
 = &slirp->if_batchq;

33 
¶úp
->
√xt_m
 = &¶úp->
if_b©chq
;

34 
	}
}

50 
	$if_ouçut
(
sockë
 *
so
, 
mbuf
 *
ifm
)

52 
Slúp
 *
¶úp
 = 
ifm
->slirp;

53 
mbuf
 *
ifq
;

54 
⁄_Á°q
 = 1;

56 
	`DEBUG_CALL
("if_output");

57 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

58 
	`DEBUG_ARG
("ifm = %lx", ()
ifm
);

65 i‡(
ifm
->
m_Êags
 & 
M_USEDLIST
) {

66 
	`ªmque
(
ifm
);

67 
ifm
->
m_Êags
 &~
M_USEDLIST
;

77 
ifq
 = 
¶úp
->
if_b©chq
.
ifq_¥ev
; ifq != &slirp->if_batchq;

78 
ifq
 = ifq->
ifq_¥ev
) {

79 i‡(
so
 =
ifq
->
ifq_so
) {

81 
ifm
->
ifq_so
 = 
so
;

82 
	`ifs_ösque
(
ifm
, 
ifq
->
ifs_¥ev
);

83 
diddô
;

88 i‡(
so
 && (so->
so_ùtos
 & 
IPTOS_LOWDELAY
)) {

89 
ifq
 = 
¶úp
->
if_Á°q
.
ifq_¥ev
;

90 
⁄_Á°q
 = 1;

95 i‡(
ifq
->
ifq_so
 =
so
) {

96 
ifm
->
ifq_so
 = 
so
;

97 
	`ifs_ösque
(
ifm
, 
ifq
->
ifs_¥ev
);

98 
diddô
;

101 
ifq
 = 
¶úp
->
if_b©chq
.
ifq_¥ev
;

104 
ifm
->
ifq_so
 = 
so
;

105 
	`ifs_öô
(
ifm
);

106 
	`ösque
(
ifm
, 
ifq
);

108 
diddô
:

109 
¶úp
->
if_queued
++;

111 i‡(
so
) {

113 
so
->
so_queued
++;

114 
so
->
so_nqueued
++;

122 i‡(
⁄_Á°q
 && ((
so
->
so_nqueued
 >= 6) &&

123 (
so
->
so_nqueued
 - so->
so_queued
) >= 3)) {

126 
	`ªmque
(
ifm
->
ifs_√xt
);

129 
	`ösque
(
ifm
->
ifs_√xt
, &
¶úp
->
if_b©chq
);

133 #i‚de‡
FULL_BOLT


137 
	`if_°¨t
(
ifm
->
¶úp
);

139 
	}
}

154 
	$if_°¨t
(
Slúp
 *
¶úp
)

156 
mbuf
 *
ifm
, *
ifqt
;

158 
	`DEBUG_CALL
("if_start");

160 i‡(
¶úp
->
if_queued
 == 0)

163 
agaö
:

165 i‡(!
	`¶úp_ˇn_ouçut
(
¶úp
->
›aque
))

172 i‡(
¶úp
->
if_Á°q
.
ifq_√xt
 != &slirp->if_fastq) {

173 
ifm
 = 
¶úp
->
if_Á°q
.
ifq_√xt
;

176 i‡(
¶úp
->
√xt_m
 !&¶úp->
if_b©chq
)

177 
ifm
 = 
¶úp
->
√xt_m
;

179 
ifm
 = 
¶úp
->
if_b©chq
.
ifq_√xt
;

182 
¶úp
->
√xt_m
 = 
ifm
->
ifq_√xt
;

185 
ifqt
 = 
ifm
->
ifq_¥ev
;

186 
	`ªmque
(
ifm
);

187 
¶úp
->
if_queued
--;

190 i‡(
ifm
->
ifs_√xt
 != ifm) {

191 
	`ösque
(
ifm
->
ifs_√xt
, 
ifqt
);

192 
	`ifs_ªmque
(
ifm
);

196 i‡(
ifm
->
ifq_so
) {

197 i‡(--
ifm
->
ifq_so
->
so_queued
 == 0)

199 
ifm
->
ifq_so
->
so_nqueued
 = 0;

203 
	`if_íˇp
(
¶úp
, (
uöt8_t
 *)
ifm
->
m_d©a
, ifm->
m_Àn
);

205 
	`m_‰ì
(
ifm
);

207 i‡(
¶úp
->
if_queued
)

208 
agaö
;

209 
	}
}

	@slirp/if.h

8 #i‚de‡
_IF_H_


9 
	#_IF_H_


	)

11 
	#IF_COMPRESS
 0x01

	)

12 
	#IF_NOCOMPRESS
 0x02

	)

13 
	#IF_AUTOCOMP
 0x04

	)

14 
	#IF_NOCIDCOMP
 0x08

	)

16 
	#IF_MTU
 1500

	)

17 
	#IF_MRU
 1500

	)

18 
	#IF_COMP
 
IF_AUTOCOMP


	)

21 
	#IF_MAXLINKHDR
 (2 + 14 + 40)

	)

23 
	#ifs_öô
(
ifm
Ë((ifm)->
ifs_√xt
 = (ifm)->
ifs_¥ev
 = (ifm))

	)

	@slirp/ip.h

33 #i‚de‡
_IP_H_


34 
	#_IP_H_


	)

36 #ifde‡
HOST_WORDS_BIGENDIAN


37 #i‚de‡
NTOHL


38 
	#NTOHL
(
d
)

	)

40 #i‚de‡
NTOHS


41 
	#NTOHS
(
d
)

	)

43 #i‚de‡
HTONL


44 
	#HTONL
(
d
)

	)

46 #i‚de‡
HTONS


47 
	#HTONS
(
d
)

	)

50 #i‚de‡
NTOHL


51 
	#NTOHL
(
d
Ë((dË
	`¡ohl
((d)))

	)

53 #i‚de‡
NTOHS


54 
	#NTOHS
(
d
Ë((dË
	`¡ohs
((
uöt16_t
)(d)))

	)

56 #i‚de‡
HTONL


57 
	#HTONL
(
d
Ë((dË
	`ht⁄l
((d)))

	)

59 #i‚de‡
HTONS


60 
	#HTONS
(
d
Ë((dË
	`ht⁄s
((
uöt16_t
)(d)))

	)

64 
uöt32_t
 
	tn_l⁄g
;

70 
	#IPVERSION
 4

	)

75 
	sù
 {

76 #ifde‡
HOST_WORDS_BIGENDIAN


77 
u_öt
 
	mù_v
:4,

78 
	mù_hl
:4;

80 
u_öt
 
	mù_hl
:4,

81 
	mù_v
:4;

83 
uöt8_t
 
	mù_tos
;

84 
uöt16_t
 
	mù_Àn
;

85 
uöt16_t
 
	mù_id
;

86 
uöt16_t
 
	mù_off
;

87 
	#IP_DF
 0x4000

	)

88 
	#IP_MF
 0x2000

	)

89 
	#IP_OFFMASK
 0x1ff‡

	)

90 
uöt8_t
 
	mù_âl
;

91 
uöt8_t
 
	mù_p
;

92 
uöt16_t
 
	mù_sum
;

93 
ö_addr
 
	mù_§c
,
	mù_d°
;

94 } 
__©åibuã__
((
∑cked
));

96 
	#IP_MAXPACKET
 65535

	)

101 
	#IPTOS_LOWDELAY
 0x10

	)

102 
	#IPTOS_THROUGHPUT
 0x08

	)

103 
	#IPTOS_RELIABILITY
 0x04

	)

108 
	#IPOPT_COPIED
(
o
Ë((o)&0x80)

	)

109 
	#IPOPT_CLASS
(
o
Ë((o)&0x60)

	)

110 
	#IPOPT_NUMBER
(
o
Ë((o)&0x1f)

	)

112 
	#IPOPT_CONTROL
 0x00

	)

113 
	#IPOPT_RESERVED1
 0x20

	)

114 
	#IPOPT_DEBMEAS
 0x40

	)

115 
	#IPOPT_RESERVED2
 0x60

	)

117 
	#IPOPT_EOL
 0

	)

118 
	#IPOPT_NOP
 1

	)

120 
	#IPOPT_RR
 7

	)

121 
	#IPOPT_TS
 68

	)

122 
	#IPOPT_SECURITY
 130

	)

123 
	#IPOPT_LSRR
 131

	)

124 
	#IPOPT_SATID
 136

	)

125 
	#IPOPT_SSRR
 137

	)

130 
	#IPOPT_OPTVAL
 0

	)

131 
	#IPOPT_OLEN
 1

	)

132 
	#IPOPT_OFFSET
 2

	)

133 
	#IPOPT_MINOFF
 4

	)

138 
	sù_time°amp
 {

139 
uöt8_t
 
	mùt_code
;

140 
uöt8_t
 
	mùt_Àn
;

141 
uöt8_t
 
	mùt_±r
;

142 #ifde‡
HOST_WORDS_BIGENDIAN


143 
u_öt
 
	mùt_oÊw
:4,

144 
	mùt_Êg
:4;

146 
u_öt
 
	mùt_Êg
:4,

147 
	mùt_oÊw
:4;

149 
	uùt_time°amp
 {

150 
n_l⁄g
 
	mùt_time
[1];

151 
	sùt_è
 {

152 
ö_addr
 
	mùt_addr
;

153 
n_l⁄g
 
	mùt_time
;

154 } 
	mùt_è
[1];

155 } 
	mùt_time°amp
;

156 } 
__©åibuã__
((
∑cked
));

159 
	#IPOPT_TS_TSONLY
 0

	)

160 
	#IPOPT_TS_TSANDADDR
 1

	)

161 
	#IPOPT_TS_PRESPEC
 3

	)

164 
	#IPOPT_SECUR_UNCLASS
 0x0000

	)

165 
	#IPOPT_SECUR_CONFID
 0xf135

	)

166 
	#IPOPT_SECUR_EFTO
 0x789a

	)

167 
	#IPOPT_SECUR_MMMM
 0xbc4d

	)

168 
	#IPOPT_SECUR_RESTR
 0xaf13

	)

169 
	#IPOPT_SECUR_SECRET
 0xd788

	)

170 
	#IPOPT_SECUR_TOPSECRET
 0x6bc5

	)

175 
	#MAXTTL
 255

	)

176 
	#IPDEFTTL
 64

	)

177 
	#IPFRAGTTL
 60

	)

178 
	#IPTTLDEC
 1

	)

180 
	#IP_MSS
 576

	)

182 #i‡
SIZEOF_CHAR_P
 == 4

183 
	smbuf_±r
 {

184 
mbuf
 *
	mm±r
;

185 
uöt32_t
 
	mdummy
;

186 } 
__©åibuã__
((
∑cked
));

188 
	smbuf_±r
 {

189 
mbuf
 *
	mm±r
;

190 } 
__©åibuã__
((
∑cked
));

192 
	sqlök
 {

193 *
	m√xt
, *
	m¥ev
;

199 
	sùovly
 {

200 
mbuf_±r
 
	mih_mbuf
;

201 
uöt8_t
 
	mih_x1
;

202 
uöt8_t
 
	mih_¥
;

203 
uöt16_t
 
	mih_Àn
;

204 
ö_addr
 
	mih_§c
;

205 
ö_addr
 
	mih_d°
;

206 } 
__©åibuã__
((
∑cked
));

215 
	sùq
 {

216 
qlök
 
	m‰ag_lök
;

217 
qlök
 
	mù_lök
;

218 
uöt8_t
 
	mùq_âl
;

219 
uöt8_t
 
	mùq_p
;

220 
uöt16_t
 
	mùq_id
;

221 
ö_addr
 
	mùq_§c
,
	mùq_d°
;

222 } 
__©åibuã__
((
∑cked
));

229 
	sùas‰ag
 {

230 
qlök
 
	mùf_lök
;

231 
ù
 
	mùf_ù
;

232 } 
__©åibuã__
((
∑cked
));

234 
	#ùf_off
 
ùf_ù
.
ù_off


	)

235 
	#ùf_tos
 
ùf_ù
.
ù_tos


	)

236 
	#ùf_Àn
 
ùf_ù
.
ù_Àn


	)

237 
	#ùf_√xt
 
ùf_lök
.
√xt


	)

238 
	#ùf_¥ev
 
ùf_lök
.
¥ev


	)

246 
	#MAX_IPOPTLEN
 40

	)

248 
	sù›ti⁄
 {

249 
ö_addr
 
	mù›t_d°
;

250 
öt8_t
 
	mù›t_li°
[
MAX_IPOPTLEN
];

251 } 
__©åibuã__
((
∑cked
));

	@slirp/ip_icmp.c

33 
	~"¶úp.h
"

34 
	~"ù_icmp.h
"

38 c⁄° 
	gicmp_pög_msg
[] = "This isáÖseudo-PINGÖacket used by SlirpÅoÉmulate ICMP ECHO-REQUESTÖackets.\n";

41 c⁄° 
	gicmp_Êush
[19] = {

67 
	$icmp_öput
(
mbuf
 *
m
, 
hÀn
)

69 
icmp
 *
i˝
;

70 
ù
 *ù=
	`mtod
(
m
, ip *);

71 
icm∂í
=
ù
->
ù_Àn
;

72 
Slúp
 *
¶úp
 = 
m
->slirp;

74 
	`DEBUG_CALL
("icmp_input");

75 
	`DEBUG_ARG
("m = %lx", ()
m
);

76 
	`DEBUG_ARG
("m_À¿%d", 
m
->
m_Àn
);

82 i‡(
icm∂í
 < 
ICMP_MINLEN
) {

83 
‰ìô
:

84 
	`m_‰ìm
(
m
);

85 
íd_îr‹
;

88 
m
->
m_Àn
 -
hÀn
;

89 
m
->
m_d©a
 +
hÀn
;

90 
i˝
 = 
	`mtod
(
m
, 
icmp
 *);

91 i‡(
	`cksum
(
m
, 
icm∂í
)) {

92 
‰ìô
;

94 
m
->
m_Àn
 +
hÀn
;

95 
m
->
m_d©a
 -
hÀn
;

97 
	`DEBUG_ARG
("icmp_ty≥ = %d", 
i˝
->
icmp_ty≥
);

98 
i˝
->
icmp_ty≥
) {

99 
ICMP_ECHO
:

100 
i˝
->
icmp_ty≥
 = 
ICMP_ECHOREPLY
;

101 
ù
->
ù_Àn
 +
hÀn
;

102 i‡(
ù
->
ù_d°
.
s_addr
 =
¶úp
->
vho°_addr
.s_addr) {

103 
	`icmp_ªÊe˘
(
m
);

105 
sockë
 *
so
;

106 
sockaddr_ö
 
addr
;

107 i‡((
so
 = 
	`so¸óã
(
¶úp
)Ë=
NULL
Ë
‰ìô
;

108 if(
	`udp_©èch
(
so
) == -1) {

109 
	`DEBUG_MISC
((
dfd
,"icmp_input udp_attachÉrrno = %d-%s\n",

110 
î∫o
,
	`°ªº‹
(errno)));

111 
	`so‰ì
(
so
);

112 
	`m_‰ì
(
m
);

113 
íd_îr‹
;

115 
so
->
so_m
 = 
m
;

116 
so
->
so_Áddr
 = 
ù
->
ù_d°
;

117 
so
->
so_Â‹t
 = 
	`ht⁄s
(7);

118 
so
->
so_œddr
 = 
ù
->
ù_§c
;

119 
so
->
so_Õ‹t
 = 
	`ht⁄s
(9);

120 
so
->
so_ùtos
 = 
ù
->
ù_tos
;

121 
so
->
so_ty≥
 = 
IPPROTO_ICMP
;

122 
so
->
so_°©e
 = 
SS_ISFCONNECTED
;

125 
addr
.
sö_Ámûy
 = 
AF_INET
;

126 i‡((
so
->
so_Áddr
.
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) ==

127 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

129 i‡(
so
->
so_Áddr
.
s_addr
 =
¶úp
->
v«me£rvî_addr
.s_addr) {

130 i‡(
	`gë_dns_addr
(&
addr
.
sö_addr
) < 0)

131 
addr
.
sö_addr
 = 
lo›back_addr
;

133 
addr
.
sö_addr
 = 
lo›back_addr
;

136 
addr
.
sö_addr
 = 
so
->
so_Áddr
;

138 
addr
.
sö_p‹t
 = 
so
->
so_Â‹t
;

139 if(
	`£ndto
(
so
->
s
, 
icmp_pög_msg
, 
	`°æí
(icmp_ping_msg), 0,

140 (
sockaddr
 *)&
addr
, (addr)) == -1) {

141 
	`DEBUG_MISC
((
dfd
,"icmp_input udp sendtoÅxÉrrno = %d-%s\n",

142 
î∫o
,
	`°ªº‹
(errno)));

143 
	`icmp_îr‹
(
m
, 
ICMP_UNREACH
,
ICMP_UNREACH_NET
, 0,
	`°ªº‹
(
î∫o
));

144 
	`udp_dëach
(
so
);

148 
ICMP_UNREACH
:

150 
ICMP_TIMXCEED
:

151 
ICMP_PARAMPROB
:

152 
ICMP_SOURCEQUENCH
:

153 
ICMP_TSTAMP
:

154 
ICMP_MASKREQ
:

155 
ICMP_REDIRECT
:

156 
	`m_‰ìm
(
m
);

160 
	`m_‰ìm
(
m
);

163 
íd_îr‹
:

166 
	}
}

187 
	#ICMP_MAXDATALEN
 (
IP_MSS
-28)

	)

189 
	$icmp_îr‹
(
mbuf
 *
m§c
, 
u_ch¨
 
ty≥
, u_ch¨ 
code
, 
mösize
,

190 c⁄° *
mesßge
)

192 
hÀn
, 
shÀn
, 
s_ù_Àn
;

193 
ù
 *ip;

194 
icmp
 *
i˝
;

195 
mbuf
 *
m
;

197 
	`DEBUG_CALL
("icmp_error");

198 
	`DEBUG_ARG
("m§¯%lx", ()
m§c
);

199 
	`DEBUG_ARG
("m§c_À¿%d", 
m§c
->
m_Àn
);

201 if(
ty≥
!=
ICMP_UNREACH
 &&Åy≥!=
ICMP_TIMXCEED
Ë
íd_îr‹
;

204 if(!
m§c
Ë
íd_îr‹
;

205 
ù
 = 
	`mtod
(
m§c
, ip *);

206 #ifde‡
DEBUG


207 { 
buÁ
[20], 
bufb
[20];

208 
	`°r˝y
(
buÁ
, 
	`öë_¡ﬂ
(
ù
->
ù_§c
));

209 
	`°r˝y
(
bufb
, 
	`öë_¡ﬂ
(
ù
->
ù_d°
));

210 
	`DEBUG_MISC
((
dfd
, " %.16†tÿ%.16s\n", 
buÁ
, 
bufb
));

213 if(
ù
->
ù_off
 & 
IP_OFFMASK
Ë
íd_îr‹
;

215 
shÀn
=
ù
->
ù_hl
 << 2;

216 
s_ù_Àn
=
ù
->
ù_Àn
;

217 if(
ù
->
ù_p
 =
IPPROTO_ICMP
) {

218 
i˝
 = (
icmp
 *)((*)
ù
 + 
shÀn
);

223 if(
i˝
->
icmp_ty≥
>18 || 
icmp_Êush
[i˝->icmp_ty≥]Ë
íd_îr‹
;

227 
m
 = 
	`m_gë
(
m§c
->
¶úp
);

228 i‡(!
m
) {

229 
íd_îr‹
;

232 { 
√w_m_size
;

233 
√w_m_size
=(
ù
 )+
ICMP_MINLEN
+
m§c
->
m_Àn
+
ICMP_MAXDATALEN
;

234 if(
√w_m_size
>
m
->
m_size
Ë
	`m_öc
(m,Çew_m_size);

236 
	`mem˝y
(
m
->
m_d©a
, 
m§c
->m_d©a, m§c->
m_Àn
);

237 
m
->
m_Àn
 = 
m§c
->m_len;

240 
ù
 = 
	`mtod
(
m
, ip *);

241 
hÀn
(
ù
 );

244 
m
->
m_d©a
 +
hÀn
;

245 
m
->
m_Àn
 -
hÀn
;

247 
i˝
 = 
	`mtod
(
m
, 
icmp
 *);

249 if(
mösize
Ë
s_ù_Àn
=
shÀn
+
ICMP_MINLEN
;

250 if(
s_ù_Àn
>
ICMP_MAXDATALEN
)

251 
s_ù_Àn
=
ICMP_MAXDATALEN
;

253 
m
->
m_Àn
=
ICMP_MINLEN
+
s_ù_Àn
;

257 
i˝
->
icmp_ty≥
 = 
ty≥
;

258 
i˝
->
icmp_code
 = 
code
;

259 
i˝
->
icmp_id
 = 0;

260 
i˝
->
icmp_£q
 = 0;

262 
	`mem˝y
(&
i˝
->
icmp_ù
, 
m§c
->
m_d©a
, 
s_ù_Àn
);

263 
	`HTONS
(
i˝
->
icmp_ù
.
ù_Àn
);

264 
	`HTONS
(
i˝
->
icmp_ù
.
ù_id
);

265 
	`HTONS
(
i˝
->
icmp_ù
.
ù_off
);

267 #ifde‡
DEBUG


268 if(
mesßge
) {

269 
mesßge_Àn
;

270 *
˝¡
;

271 
mesßge_Àn
=
	`°æí
(
mesßge
);

272 if(
mesßge_Àn
>
ICMP_MAXDATALEN
) message_len=ICMP_MAXDATALEN;

273 
˝¡
=(*)
m
->
m_d©a
+m->
m_Àn
;

274 
	`mem˝y
(
˝¡
, 
mesßge
, 
mesßge_Àn
);

275 
m
->
m_Àn
+=
mesßge_Àn
;

279 
i˝
->
icmp_cksum
 = 0;

280 
i˝
->
icmp_cksum
 = 
	`cksum
(
m
, m->
m_Àn
);

282 
m
->
m_d©a
 -
hÀn
;

283 
m
->
m_Àn
 +
hÀn
;

286 
ù
->
ù_hl
 = 
hÀn
 >> 2;

287 
ù
->
ù_Àn
 = 
m
->
m_Àn
;

289 
ù
->
ù_tos
=((ip->ip_tos & 0x1E) | 0xC0);

291 
ù
->
ù_âl
 = 
MAXTTL
;

292 
ù
->
ù_p
 = 
IPPROTO_ICMP
;

293 
ù
->
ù_d°
 = ip->
ù_§c
;

294 
ù
->
ù_§c
 = 
m
->
¶úp
->
vho°_addr
;

296 (Ë
	`ù_ouçut
((
sockë
 *)
NULL
, 
m
);

298 
íd_îr‹
:

300 
	}
}

301 #unde‡
ICMP_MAXDATALEN


307 
	$icmp_ªÊe˘
(
mbuf
 *
m
)

309 
ù
 *ù = 
	`mtod
(
m
, ip *);

310 
hÀn
 = 
ù
->
ù_hl
 << 2;

311 
›éí
 = 
hÀn
 - (
ù
 );

312 
icmp
 *
i˝
;

318 
m
->
m_d©a
 +
hÀn
;

319 
m
->
m_Àn
 -
hÀn
;

320 
i˝
 = 
	`mtod
(
m
, 
icmp
 *);

322 
i˝
->
icmp_cksum
 = 0;

323 
i˝
->
icmp_cksum
 = 
	`cksum
(
m
, 
ù
->
ù_Àn
 - 
hÀn
);

325 
m
->
m_d©a
 -
hÀn
;

326 
m
->
m_Àn
 +
hÀn
;

329 i‡(
›éí
 > 0) {

334 
	`memmove
((
ˇddr_t
)(
ù
 + 1), (ˇddr_t)ù + 
hÀn
,

335 ()(
m
->
m_Àn
 - 
hÀn
));

336 
hÀn
 -
›éí
;

337 
ù
->
ù_hl
 = 
hÀn
 >> 2;

338 
ù
->
ù_Àn
 -
›éí
;

339 
m
->
m_Àn
 -
›éí
;

342 
ù
->
ù_âl
 = 
MAXTTL
;

344 
ö_addr
 
icmp_d°
;

345 
icmp_d°
 = 
ù
->
ù_d°
;

346 
ù
->
ù_d°
 = ip->
ù_§c
;

347 
ù
->
ù_§c
 = 
icmp_d°
;

350 (Ë
	`ù_ouçut
((
sockë
 *)
NULL
, 
m
);

351 
	}
}

	@slirp/ip_icmp.h

33 #i‚de‡
_NETINET_IP_ICMP_H_


34 
	#_NETINET_IP_ICMP_H_


	)

41 
uöt32_t
 
	tn_time
;

46 
	sicmp
 {

47 
u_ch¨
 
	micmp_ty≥
;

48 
u_ch¨
 
	micmp_code
;

49 
u_sh‹t
 
	micmp_cksum
;

51 
u_ch¨
 
	mih_µå
;

52 
ö_addr
 
	mih_gwaddr
;

53 
	sih_id£q
 {

54 
u_sh‹t
 
	micd_id
;

55 
u_sh‹t
 
	micd_£q
;

56 } 
	mih_id£q
;

57 
	mih_void
;

60 
	sih_pmtu
 {

61 
u_sh‹t
 
	mùm_void
;

62 
u_sh‹t
 
	mùm_√xtmtu
;

63 } 
	mih_pmtu
;

64 } 
	micmp_hun
;

65 
	#icmp_µå
 
icmp_hun
.
ih_µå


	)

66 
	#icmp_gwaddr
 
icmp_hun
.
ih_gwaddr


	)

67 
	#icmp_id
 
icmp_hun
.
ih_id£q
.
icd_id


	)

68 
	#icmp_£q
 
icmp_hun
.
ih_id£q
.
icd_£q


	)

69 
	#icmp_void
 
icmp_hun
.
ih_void


	)

70 
	#icmp_pmvoid
 
icmp_hun
.
ih_pmtu
.
ùm_void


	)

71 
	#icmp_√xtmtu
 
icmp_hun
.
ih_pmtu
.
ùm_√xtmtu


	)

73 
	sid_ts
 {

74 
n_time
 
	môs_Ÿime
;

75 
n_time
 
	môs_πime
;

76 
n_time
 
	môs_âime
;

77 } 
	mid_ts
;

78 
	sid_ù
 {

79 
ù
 
	midi_ù
;

81 } 
	mid_ù
;

82 
uöt32_t
 
	mid_mask
;

83 
	mid_d©a
[1];

84 } 
	micmp_dun
;

85 
	#icmp_Ÿime
 
icmp_dun
.
id_ts
.
ôs_Ÿime


	)

86 
	#icmp_πime
 
icmp_dun
.
id_ts
.
ôs_πime


	)

87 
	#icmp_âime
 
icmp_dun
.
id_ts
.
ôs_âime


	)

88 
	#icmp_ù
 
icmp_dun
.
id_ù
.
idi_ù


	)

89 
	#icmp_mask
 
icmp_dun
.
id_mask


	)

90 
	#icmp_d©a
 
icmp_dun
.
id_d©a


	)

101 
	#ICMP_MINLEN
 8

	)

102 
	#ICMP_TSLEN
 (8 + 3 *  (
n_time
)Ë

	)

103 
	#ICMP_MASKLEN
 12

	)

104 
	#ICMP_ADVLENMIN
 (8 +  (
ù
Ë+ 8Ë

	)

105 
	#ICMP_ADVLEN
(
p
Ë(8 + (’)->
icmp_ù
.
ù_hl
 << 2Ë+ 8)

	)

111 
	#ICMP_ECHOREPLY
 0

	)

112 
	#ICMP_UNREACH
 3

	)

113 
	#ICMP_UNREACH_NET
 0

	)

114 
	#ICMP_UNREACH_HOST
 1

	)

115 
	#ICMP_UNREACH_PROTOCOL
 2

	)

116 
	#ICMP_UNREACH_PORT
 3

	)

117 
	#ICMP_UNREACH_NEEDFRAG
 4

	)

118 
	#ICMP_UNREACH_SRCFAIL
 5

	)

119 
	#ICMP_UNREACH_NET_UNKNOWN
 6

	)

120 
	#ICMP_UNREACH_HOST_UNKNOWN
 7

	)

121 
	#ICMP_UNREACH_ISOLATED
 8

	)

122 
	#ICMP_UNREACH_NET_PROHIB
 9

	)

123 
	#ICMP_UNREACH_HOST_PROHIB
 10

	)

124 
	#ICMP_UNREACH_TOSNET
 11

	)

125 
	#ICMP_UNREACH_TOSHOST
 12

	)

126 
	#ICMP_SOURCEQUENCH
 4

	)

127 
	#ICMP_REDIRECT
 5

	)

128 
	#ICMP_REDIRECT_NET
 0

	)

129 
	#ICMP_REDIRECT_HOST
 1

	)

130 
	#ICMP_REDIRECT_TOSNET
 2

	)

131 
	#ICMP_REDIRECT_TOSHOST
 3

	)

132 
	#ICMP_ECHO
 8

	)

133 
	#ICMP_ROUTERADVERT
 9

	)

134 
	#ICMP_ROUTERSOLICIT
 10

	)

135 
	#ICMP_TIMXCEED
 11

	)

136 
	#ICMP_TIMXCEED_INTRANS
 0

	)

137 
	#ICMP_TIMXCEED_REASS
 1

	)

138 
	#ICMP_PARAMPROB
 12

	)

139 
	#ICMP_PARAMPROB_OPTABSENT
 1

	)

140 
	#ICMP_TSTAMP
 13

	)

141 
	#ICMP_TSTAMPREPLY
 14

	)

142 
	#ICMP_IREQ
 15

	)

143 
	#ICMP_IREQREPLY
 16

	)

144 
	#ICMP_MASKREQ
 17

	)

145 
	#ICMP_MASKREPLY
 18

	)

147 
	#ICMP_MAXTYPE
 18

	)

149 
	#ICMP_INFOTYPE
(
ty≥
) \

150 ((
ty≥
Ë=
ICMP_ECHOREPLY
 || (ty≥Ë=
ICMP_ECHO
 || \

151 (
ty≥
Ë=
ICMP_ROUTERADVERT
 || (ty≥Ë=
ICMP_ROUTERSOLICIT
 || \

152 (
ty≥
Ë=
ICMP_TSTAMP
 || (ty≥Ë=
ICMP_TSTAMPREPLY
 || \

153 (
ty≥
Ë=
ICMP_IREQ
 || (ty≥Ë=
ICMP_IREQREPLY
 || \

154 (
ty≥
Ë=
ICMP_MASKREQ
 || (ty≥Ë=
ICMP_MASKREPLY
)

	)

156 
icmp_öput
(
mbuf
 *, );

157 
icmp_îr‹
(
mbuf
 *
m§c
, 
u_ch¨
 
ty≥
, u_ch¨ 
code
, 
mösize
,

158 c⁄° *
mesßge
);

159 
icmp_ªÊe˘
(
mbuf
 *);

	@slirp/ip_input.c

41 
	~"¶úp.h
"

42 
	~"ù_icmp.h
"

44 
	#c⁄èöî_of
(
±r
, 
ty≥
, 
membî
) ({ \

45 c⁄° 
	`ty≥of
–((
ty≥
 *)0)->
membî
 ) *
__m±r
 = (
±r
); \

46 (
ty≥
 *)–(*)
__m±r
 - 
	`off£tof
—y≥,
membî
Ë);})

	)

48 
ù
 *
ù_ªass
(
Slúp
 *
¶úp
, ù *ù, 
ùq
 *
Â
);

49 
ù_‰ìf
(
Slúp
 *
¶úp
, 
ùq
 *
Â
);

50 
ù_íq
(
ùas‰ag
 *
p
,

51 
ùas‰ag
 *
¥ev
);

52 
ù_deq
(
ùas‰ag
 *
p
);

59 
	$ù_öô
(
Slúp
 *
¶úp
)

61 
¶úp
->
ùq
.
ù_lök
.
√xt
 = slúp->ùq.ù_lök.
¥ev
 = &slirp->ipq.ip_link;

62 
	`udp_öô
(
¶úp
);

63 
	`t˝_öô
(
¶úp
);

64 
	}
}

71 
	$ù_öput
(
mbuf
 *
m
)

73 
Slúp
 *
¶úp
 = 
m
->slirp;

74 
ù
 *ip;

75 
hÀn
;

77 
	`DEBUG_CALL
("ip_input");

78 
	`DEBUG_ARG
("m = %lx", ()
m
);

79 
	`DEBUG_ARG
("m_À¿%d", 
m
->
m_Àn
);

81 i‡(
m
->
m_Àn
 <  (
ù
)) {

85 
ù
 = 
	`mtod
(
m
, ip *);

87 i‡(
ù
->
ù_v
 !
IPVERSION
) {

88 
bad
;

91 
hÀn
 = 
ù
->
ù_hl
 << 2;

92 i‡(
hÀn
<(
ù
 ) || hÀn>
m
->
m_Àn
) {

93 
bad
;

100 if(
	`cksum
(
m
,
hÀn
)) {

101 
bad
;

107 
	`NTOHS
(
ù
->
ù_Àn
);

108 i‡(
ù
->
ù_Àn
 < 
hÀn
) {

109 
bad
;

111 
	`NTOHS
(
ù
->
ù_id
);

112 
	`NTOHS
(
ù
->
ù_off
);

120 i‡(
m
->
m_Àn
 < 
ù
->
ù_Àn
) {

121 
bad
;

124 i‡(
¶úp
->
ª°ri˘ed
) {

125 i‡((
ù
->
ù_d°
.
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) ==

126 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

127 i‡(
ù
->
ù_d°
.
s_addr
 =0xfffffff‡&& ip->
ù_p
 !
IPPROTO_UDP
)

128 
bad
;

130 
uöt32_t
 
öv_mask
 = ~
¶úp
->
v√tw‹k_mask
.
s_addr
;

131 
ex_li°
 *
ex_±r
;

133 i‡((
ù
->
ù_d°
.
s_addr
 & 
öv_mask
) == inv_mask) {

134 
bad
;

136 
ex_±r
 = 
¶úp
->
exec_li°
;Éx_±r;Éx_±∏ex_±r->
ex_√xt
)

137 i‡(
ex_±r
->
ex_addr
.
s_addr
 =
ù
->
ù_d°
.s_addr)

140 i‡(!
ex_±r
)

141 
bad
;

146 i‡(
m
->
m_Àn
 > 
ù
->
ù_Àn
)

147 
	`m_adj
(
m
, 
ù
->
ù_Àn
 - m->
m_Àn
);

150 if(
ù
->
ù_âl
==0) {

151 
	`icmp_îr‹
(
m
, 
ICMP_TIMXCEED
,
ICMP_TIMXCEED_INTRANS
, 0,"ttl");

152 
bad
;

164 i‡(
ù
->
ù_off
 &~ 
IP_DF
) {

165 
ùq
 *
Â
;

166 
qlök
 *
l
;

171 
l
 = 
¶úp
->
ùq
.
ù_lök
.
√xt
;Ü != &slirp->ipq.ip_link;

172 
l
 =Ü->
√xt
) {

173 
Â
 = 
	`c⁄èöî_of
(
l
, 
ùq
, 
ù_lök
);

174 i‡(
ù
->
ù_id
 =
Â
->
ùq_id
 &&

175 
ù
->
ù_§c
.
s_addr
 =
Â
->
ùq_§c
.s_addr &&

176 
ù
->
ù_d°
.
s_addr
 =
Â
->
ùq_d°
.s_addr &&

177 
ù
->
ù_p
 =
Â
->
ùq_p
)

178 
found
;

180 
Â
 = 
NULL
;

181 
found
:

188 
ù
->
ù_Àn
 -
hÀn
;

189 i‡(
ù
->
ù_off
 & 
IP_MF
)

190 
ù
->
ù_tos
 |= 1;

192 
ù
->
ù_tos
 &= ~1;

194 
ù
->
ù_off
 <<= 3;

201 i‡(
ù
->
ù_tos
 & 1 || ip->
ù_off
) {

202 
ù
 = 
	`ù_ªass
(
¶úp
, ip, 
Â
);

203 i‡(
ù
 =
NULL
)

205 
m
 = 
	`dtom
(
¶úp
, 
ù
);

207 i‡(
Â
)

208 
	`ù_‰ìf
(
¶úp
, 
Â
);

211 
ù
->
ù_Àn
 -
hÀn
;

216 
ù
->
ù_p
) {

217 
IPPROTO_TCP
:

218 
	`t˝_öput
(
m
, 
hÀn
, (
sockë
 *)
NULL
);

220 
IPPROTO_UDP
:

221 
	`udp_öput
(
m
, 
hÀn
);

223 
IPPROTO_ICMP
:

224 
	`icmp_öput
(
m
, 
hÀn
);

227 
	`m_‰ì
(
m
);

230 
bad
:

231 
	`m_‰ìm
(
m
);

233 
	}
}

235 
	#ùto‰ag
(
P
Ë((
ùas‰ag
 *)(((*)(P)Ë- (
qlök
)))

	)

236 
	#‰agtoù
(
P
Ë((
ù
*)(((*)(P)Ë+ (
qlök
)))

	)

243 
ù
 *

244 
	$ù_ªass
(
Slúp
 *
¶úp
, 
ù
 *ù, 
ùq
 *
Â
)

246 
mbuf
 *
m
 = 
	`dtom
(
¶úp
, 
ù
);

247 
ùas‰ag
 *
q
;

248 
hÀn
 = 
ù
->
ù_hl
 << 2;

249 
i
, 
√xt
;

251 
	`DEBUG_CALL
("ip_reass");

252 
	`DEBUG_ARG
("ù = %lx", ()
ù
);

253 
	`DEBUG_ARG
("Â = %lx", ()
Â
);

254 
	`DEBUG_ARG
("m = %lx", ()
m
);

261 
m
->
m_d©a
 +
hÀn
;

262 
m
->
m_Àn
 -
hÀn
;

267 i‡(
Â
 =
NULL
) {

268 
mbuf
 *
t
 = 
	`m_gë
(
¶úp
);

270 i‡(
t
 =
NULL
) {

271 
dr›‰ag
;

273 
Â
 = 
	`mtod
(
t
, 
ùq
 *);

274 
	`ösque
(&
Â
->
ù_lök
, &
¶úp
->
ùq
.ip_link);

275 
Â
->
ùq_âl
 = 
IPFRAGTTL
;

276 
Â
->
ùq_p
 = 
ù
->
ù_p
;

277 
Â
->
ùq_id
 = 
ù
->
ù_id
;

278 
Â
->
‰ag_lök
.
√xt
 = fp->‰ag_lök.
¥ev
 = &fp->frag_link;

279 
Â
->
ùq_§c
 = 
ù
->
ù_§c
;

280 
Â
->
ùq_d°
 = 
ù
->
ù_d°
;

281 
q
 = (
ùas‰ag
 *)
Â
;

282 
ö£π
;

288 
q
 = 
Â
->
‰ag_lök
.
√xt
; q !(
ùas‰ag
 *)&fp->frag_link;

289 
q
 = q->
ùf_√xt
)

290 i‡(
q
->
ùf_off
 > 
ù
->
ù_off
)

298 i‡(
q
->
ùf_¥ev
 !&
Â
->
‰ag_lök
) {

299 
ùas‰ag
 *
pq
 = 
q
->
ùf_¥ev
;

300 
i
 = 
pq
->
ùf_off
 +Öq->
ùf_Àn
 - 
ù
->
ù_off
;

301 i‡(
i
 > 0) {

302 i‡(
i
 >
ù
->
ù_Àn
)

303 
dr›‰ag
;

304 
	`m_adj
(
	`dtom
(
¶úp
, 
ù
), 
i
);

305 
ù
->
ù_off
 +
i
;

306 
ù
->
ù_Àn
 -
i
;

314 
q
 !(
ùas‰ag
*)&
Â
->
‰ag_lök
 &&

315 
ù
->
ù_off
 + ip->
ù_Àn
 > 
q
->
ùf_off
) {

316 
i
 = (
ù
->
ù_off
 + ip->
ù_Àn
Ë- 
q
->
ùf_off
;

317 i‡(
i
 < 
q
->
ùf_Àn
) {

318 
q
->
ùf_Àn
 -
i
;

319 
q
->
ùf_off
 +
i
;

320 
	`m_adj
(
	`dtom
(
¶úp
, 
q
), 
i
);

323 
q
 = q->
ùf_√xt
;

324 
	`m_‰ìm
(
	`dtom
(
¶úp
, 
q
->
ùf_¥ev
));

325 
	`ù_deq
(
q
->
ùf_¥ev
);

328 
ö£π
:

333 
	`ù_íq
(
	`ùto‰ag
(
ù
), 
q
->
ùf_¥ev
);

334 
√xt
 = 0;

335 
q
 = 
Â
->
‰ag_lök
.
√xt
; q !(
ùas‰ag
*)&fp->frag_link;

336 
q
 = q->
ùf_√xt
) {

337 i‡(
q
->
ùf_off
 !
√xt
)

338  
NULL
;

339 
√xt
 +
q
->
ùf_Àn
;

341 i‡(((
ùas‰ag
 *)(
q
->
ùf_¥ev
))->
ùf_tos
 & 1)

342  
NULL
;

347 
q
 = 
Â
->
‰ag_lök
.
√xt
;

348 
m
 = 
	`dtom
(
¶úp
, 
q
);

350 
q
 = (
ùas‰ag
 *Ëq->
ùf_√xt
;

351 
q
 !(
ùas‰ag
*)&
Â
->
‰ag_lök
) {

352 
mbuf
 *
t
 = 
	`dtom
(
¶úp
, 
q
);

353 
q
 = (
ùas‰ag
 *Ëq->
ùf_√xt
;

354 
	`m_ˇt
(
m
, 
t
);

363 
q
 = 
Â
->
‰ag_lök
.
√xt
;

372 i‡(
m
->
m_Êags
 & 
M_EXT
) {

373 
dñè
 = (*)
q
 - 
m
->
m_d©
;

374 
q
 = (
ùas‰ag
 *)(
m
->
m_ext
 + 
dñè
);

377 
ù
 = 
	`‰agtoù
(
q
);

378 
ù
->
ù_Àn
 = 
√xt
;

379 
ù
->
ù_tos
 &= ~1;

380 
ù
->
ù_§c
 = 
Â
->
ùq_§c
;

381 
ù
->
ù_d°
 = 
Â
->
ùq_d°
;

382 
	`ªmque
(&
Â
->
ù_lök
);

383 (Ë
	`m_‰ì
(
	`dtom
(
¶úp
, 
Â
));

384 
m
->
m_Àn
 +(
ù
->
ù_hl
 << 2);

385 
m
->
m_d©a
 -(
ù
->
ù_hl
 << 2);

387  
ù
;

389 
dr›‰ag
:

390 
	`m_‰ìm
(
m
);

391  
NULL
;

392 
	}
}

399 
	$ù_‰ìf
(
Slúp
 *
¶úp
, 
ùq
 *
Â
)

401 
ùas‰ag
 *
q
, *
p
;

403 
q
 = 
Â
->
‰ag_lök
.
√xt
; q !(
ùas‰ag
*)&Â->‰ag_lök; q = 
p
) {

404 
p
 = 
q
->
ùf_√xt
;

405 
	`ù_deq
(
q
);

406 
	`m_‰ìm
(
	`dtom
(
¶úp
, 
q
));

408 
	`ªmque
(&
Â
->
ù_lök
);

409 (Ë
	`m_‰ì
(
	`dtom
(
¶úp
, 
Â
));

410 
	}
}

417 
	$ù_íq
(
ùas‰ag
 *
p
, ùas‰ag *
¥ev
)

419 
	`DEBUG_CALL
("ip_enq");

420 
	`DEBUG_ARG
("¥ev = %lx", ()
¥ev
);

421 
p
->
ùf_¥ev
 = 
¥ev
;

422 
p
->
ùf_√xt
 = 
¥ev
->ipf_next;

423 ((
ùas‰ag
 *)(
¥ev
->
ùf_√xt
))->
ùf_¥ev
 = 
p
;

424 
¥ev
->
ùf_√xt
 = 
p
;

425 
	}
}

431 
	$ù_deq
(
ùas‰ag
 *
p
)

433 ((
ùas‰ag
 *)(
p
->
ùf_¥ev
))->
ùf_√xt
 =Ö->ipf_next;

434 ((
ùas‰ag
 *)(
p
->
ùf_√xt
))->
ùf_¥ev
 =Ö->ipf_prev;

435 
	}
}

443 
	$ù_¶owtimo
(
Slúp
 *
¶úp
)

445 
qlök
 *
l
;

447 
	`DEBUG_CALL
("ip_slowtimo");

449 
l
 = 
¶úp
->
ùq
.
ù_lök
.
√xt
;

451 i‡(
l
 =
NULL
)

454 
l
 !&
¶úp
->
ùq
.
ù_lök
) {

455 
ùq
 *
Â
 = 
	`c⁄èöî_of
(
l
, ùq, 
ù_lök
);

456 
l
 =Ü->
√xt
;

457 i‡(--
Â
->
ùq_âl
 == 0) {

458 
	`ù_‰ìf
(
¶úp
, 
Â
);

461 
	}
}

471 #ifde‡
nŸdef


474 
	$ù_do›ti⁄s
(
m
)

475 
mbuf
 *
m
;

477 
ù
 *ù = 
	`mtod
(
m
, ip *);

478 
u_ch¨
 *
˝
;

479 
ù_time°amp
 *
ùt
;

480 
ö_iÁddr
 *
ü
;

481 
›t
, 
›éí
, 
˙t
, 
off
, 
code
, 
ty≥
, 
f‹w¨d
 = 0;

482 
ö_addr
 *
sö
, 
d°
;

483 
uöt32_t
 
	tn_time
;

484 
n_time
 
¡ime
;

486 
d°
 = 
ù
->
ù_d°
;

487 
˝
 = (
u_ch¨
 *)(
ù
 + 1);

488 
˙t
 = (
ù
->
ù_hl
 << 2) -  (ip);

489 ; 
˙t
 > 0; c¡ -
›éí
, 
˝
 += optlen) {

490 
›t
 = 
˝
[
IPOPT_OPTVAL
];

491 i‡(
›t
 =
IPOPT_EOL
)

493 i‡(
›t
 =
IPOPT_NOP
)

494 
›éí
 = 1;

496 
›éí
 = 
˝
[
IPOPT_OLEN
];

497 i‡(
›éí
 <0 || o±À¿> 
˙t
) {

498 
code
 = &
˝
[
IPOPT_OLEN
] - (
u_ch¨
 *)
ù
;

499 
bad
;

502 
›t
) {

516 
IPOPT_LSRR
:

517 
IPOPT_SSRR
:

518 i‡((
off
 = 
˝
[
IPOPT_OFFSET
]Ë< 
IPOPT_MINOFF
) {

519 
code
 = &
˝
[
IPOPT_OFFSET
] - (
u_ch¨
 *)
ù
;

520 
bad
;

522 
ùaddr
.
sö_addr
 = 
ù
->
ù_d°
;

523 
ü
 = (
ö_iÁddr
 *)

524 
	`iÁ_ifwôhaddr
((
sockaddr
 *)&
ùaddr
);

525 i‡(
ü
 == 0) {

526 i‡(
›t
 =
IPOPT_SSRR
) {

527 
ty≥
 = 
ICMP_UNREACH
;

528 
code
 = 
ICMP_UNREACH_SRCFAIL
;

529 
bad
;

537 
off
--; / * 0 
‹igö
 * /

538 i‡(
off
 > 
›éí
 - (
ö_addr
)) {

542 
	`ßve_πe
(
˝
, 
ù
->
ù_§c
);

548 
	`bc›y
((
ˇddr_t
)(
˝
 + 
off
), (ˇddr_t)&
ùaddr
.
sö_addr
,

549 (
ùaddr
.
sö_addr
));

550 i‡(
›t
 =
IPOPT_SSRR
) {

551 
	#INA
 
ö_iÁddr
 *

	)

552 
	#SA
 
sockaddr
 *

	)

553 i‡((
ü
 = (
INA
)
	`iÁ_ifwôhd°addr
((
SA
)&
ùaddr
)) == 0)

554 
ü
 = (
INA
)
	`iÁ_ifwôh√t
((
SA
)&
ùaddr
);

556 
ü
 = 
	`ù_πaddr
(
ùaddr
.
sö_addr
);

557 i‡(
ü
 == 0) {

558 
ty≥
 = 
ICMP_UNREACH
;

559 
code
 = 
ICMP_UNREACH_SRCFAIL
;

560 
bad
;

562 
ù
->
ù_d°
 = 
ùaddr
.
sö_addr
;

563 
	`bc›y
((
ˇddr_t
)&(
	`IA_SIN
(
ü
)->
sö_addr
),

564 (
ˇddr_t
)(
˝
 + 
off
), (
ö_addr
));

565 
˝
[
IPOPT_OFFSET
] +(
ö_addr
);

569 
f‹w¨d
 = !
	`IN_MULTICAST
(
	`¡ohl
(
ù
->
ù_d°
.
s_addr
));

572 
IPOPT_RR
:

573 i‡((
off
 = 
˝
[
IPOPT_OFFSET
]Ë< 
IPOPT_MINOFF
) {

574 
code
 = &
˝
[
IPOPT_OFFSET
] - (
u_ch¨
 *)
ù
;

575 
bad
;

580 
off
--; * 0 
‹igö
 *

581 i‡(
off
 > 
›éí
 - (
ö_addr
))

583 
	`bc›y
((
ˇddr_t
)(&
ù
->
ù_d°
), (ˇddr_t)&
ùaddr
.
sö_addr
,

584 (
ùaddr
.
sö_addr
));

589 i‡((
ü
 = (
INA
)
	`iÁ_ifwôhaddr
((
SA
)&
ùaddr
)) == 0 &&

590 (
ü
 = 
	`ù_πaddr
(
ùaddr
.
sö_addr
)) == 0) {

591 
ty≥
 = 
ICMP_UNREACH
;

592 
code
 = 
ICMP_UNREACH_HOST
;

593 
bad
;

595 
	`bc›y
((
ˇddr_t
)&(
	`IA_SIN
(
ü
)->
sö_addr
),

596 (
ˇddr_t
)(
˝
 + 
off
), (
ö_addr
));

597 
˝
[
IPOPT_OFFSET
] +(
ö_addr
);

600 
IPOPT_TS
:

601 
code
 = 
˝
 - (
u_ch¨
 *)
ù
;

602 
ùt
 = (
ù_time°amp
 *)
˝
;

603 i‡(
ùt
->
ùt_Àn
 < 5)

604 
bad
;

605 i‡(
ùt
->
ùt_±r
 > i±->
ùt_Àn
 -  (
öt32_t
)) {

606 i‡(++
ùt
->
ùt_oÊw
 == 0)

607 
bad
;

610 
sö
 = (
ö_addr
 *)(
˝
 + 
ùt
->
ùt_±r
 - 1);

611 
ùt
->
ùt_Êg
) {

613 
IPOPT_TS_TSONLY
:

616 
IPOPT_TS_TSANDADDR
:

617 i‡(
ùt
->
ùt_±r
 + (
n_time
) +

618 (
ö_addr
Ë> 
ùt
->
ùt_Àn
)

619 
bad
;

620 
ùaddr
.
sö_addr
 = 
d°
;

621 
ü
 = (
INA
)
iÁof_
 
i
 
f
 
p
 
	`f‹addr
((
SA
)&
ùaddr
,

622 
m
->
m_pkthdr
.
rcvif
);

623 i‡(
ü
 == 0)

625 
	`bc›y
((
ˇddr_t
)&
	`IA_SIN
(
ü
)->
sö_addr
,

626 (
ˇddr_t
)
sö
, (
ö_addr
));

627 
ùt
->
ùt_±r
 +(
ö_addr
);

630 
IPOPT_TS_PRESPEC
:

631 i‡(
ùt
->
ùt_±r
 + (
n_time
) +

632 (
ö_addr
Ë> 
ùt
->
ùt_Àn
)

633 
bad
;

634 
	`bc›y
((
ˇddr_t
)
sö
, (ˇddr_t)&
ùaddr
.
sö_addr
,

635 (
ö_addr
));

636 i‡(
	`iÁ_ifwôhaddr
((
SA
)&
ùaddr
) == 0)

638 
ùt
->
ùt_±r
 +(
ö_addr
);

642 
bad
;

644 
¡ime
 = 
	`ùtime
();

645 
	`bc›y
((
ˇddr_t
)&
¡ime
, (ˇddr_t)
˝
 + 
ùt
->
ùt_±r
 - 1,

646 (
n_time
));

647 
ùt
->
ùt_±r
 +(
n_time
);

650 i‡(
f‹w¨d
) {

651 
	`ù_f‹w¨d
(
m
, 1);

655 
bad
:

656 
	`icmp_îr‹
(
m
, 
ty≥
, 
code
, 0, 0);

659 
	}
}

671 
	$ù_°rù›ti⁄s
(
mbuf
 *
m
, mbu‡*
m›t
)

673 
i
;

674 
ù
 *ù = 
	`mtod
(
m
, ip *);

675 
ˇddr_t
 
›ts
;

676 
ﬁí
;

678 
ﬁí
 = (
ù
->
ù_hl
<<2) -  (ip);

679 
›ts
 = (
ˇddr_t
)(
ù
 + 1);

680 
i
 = 
m
->
m_Àn
 - ( (
ù
Ë+ 
ﬁí
);

681 
	`mem˝y
(
›ts
, o±†+ 
ﬁí
, ()
i
);

682 
m
->
m_Àn
 -
ﬁí
;

684 
ù
->
ù_hl
 = (ip) >> 2;

685 
	}
}

	@slirp/ip_output.c

41 
	~"¶úp.h
"

45 
	#IF_THRESH
 10

	)

54 
	$ù_ouçut
(
sockë
 *
so
, 
mbuf
 *
m0
)

56 
Slúp
 *
¶úp
 = 
m0
->slirp;

57 
ù
 *ip;

58 
mbuf
 *
m
 = 
m0
;

59 
hÀn
 = (
ù
 );

60 
Àn
, 
off
, 
îr‹
 = 0;

62 
	`DEBUG_CALL
("ip_output");

63 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

64 
	`DEBUG_ARG
("m0 = %lx", ()
m0
);

66 
ù
 = 
	`mtod
(
m
, ip *);

70 
ù
->
ù_v
 = 
IPVERSION
;

71 
ù
->
ù_off
 &
IP_DF
;

72 
ù
->
ù_id
 = 
	`ht⁄s
(
¶úp
->ip_id++);

73 
ù
->
ù_hl
 = 
hÀn
 >> 2;

78 i‡((
uöt16_t
)
ù
->
ù_Àn
 <
IF_MTU
) {

79 
ù
->
ù_Àn
 = 
	`ht⁄s
((
uöt16_t
)ip->ip_len);

80 
ù
->
ù_off
 = 
	`ht⁄s
((
uöt16_t
)ip->ip_off);

81 
ù
->
ù_sum
 = 0;

82 
ù
->
ù_sum
 = 
	`cksum
(
m
, 
hÀn
);

84 
	`if_ouçut
(
so
, 
m
);

85 
d⁄e
;

92 i‡(
ù
->
ù_off
 & 
IP_DF
) {

93 
îr‹
 = -1;

94 
bad
;

97 
Àn
 = (
IF_MTU
 - 
hÀn
) &~ 7;

98 i‡(
Àn
 < 8) {

99 
îr‹
 = -1;

100 
bad
;

104 
mhÀn
, 
fú°Àn
 = 
Àn
;

105 
mbuf
 **
m√xt
 = &
m
->
m_√xçkt
;

111 
m0
 = 
m
;

112 
mhÀn
 =  (
ù
);

113 
off
 = 
hÀn
 + 
Àn
; of‡< (
uöt16_t
)
ù
->
ù_Àn
; off +=Üen) {

114 
ù
 *
mhù
;

115 
m
 = 
	`m_gë
(
¶úp
);

116 i‡(
m
 =
NULL
) {

117 
îr‹
 = -1;

118 
£nd‹‰ì
;

120 
m
->
m_d©a
 +
IF_MAXLINKHDR
;

121 
mhù
 = 
	`mtod
(
m
, 
ù
 *);

122 *
mhù
 = *
ù
;

124 
m
->
m_Àn
 = 
mhÀn
;

125 
mhù
->
ù_off
 = ((
off
 - 
hÀn
Ë>> 3Ë+ (
ù
->ù_of‡& ~
IP_MF
);

126 i‡(
ù
->
ù_off
 & 
IP_MF
)

127 
mhù
->
ù_off
 |
IP_MF
;

128 i‡(
off
 + 
Àn
 >(
uöt16_t
)
ù
->
ù_Àn
)

129 
Àn
 = (
uöt16_t
)
ù
->
ù_Àn
 - 
off
;

131 
mhù
->
ù_off
 |
IP_MF
;

132 
mhù
->
ù_Àn
 = 
	`ht⁄s
((
uöt16_t
)(
Àn
 + 
mhÀn
));

134 i‡(
	`m_c›y
(
m
, 
m0
, 
off
, 
Àn
) < 0) {

135 
îr‹
 = -1;

136 
£nd‹‰ì
;

139 
mhù
->
ù_off
 = 
	`ht⁄s
((
uöt16_t
)mhip->ip_off);

140 
mhù
->
ù_sum
 = 0;

141 
mhù
->
ù_sum
 = 
	`cksum
(
m
, 
mhÀn
);

142 *
m√xt
 = 
m
;

143 
m√xt
 = &
m
->
m_√xçkt
;

149 
m
 = 
m0
;

150 
	`m_adj
(
m
, 
hÀn
 + 
fú°Àn
 - (
uöt16_t
)
ù
->
ù_Àn
);

151 
ù
->
ù_Àn
 = 
	`ht⁄s
((
uöt16_t
)
m
->
m_Àn
);

152 
ù
->
ù_off
 = 
	`ht⁄s
((
uöt16_t
)(ù->ù_of‡| 
IP_MF
));

153 
ù
->
ù_sum
 = 0;

154 
ù
->
ù_sum
 = 
	`cksum
(
m
, 
hÀn
);

155 
£nd‹‰ì
:

156 
m
 = 
m0
; m; m = m0) {

157 
m0
 = 
m
->
m_√xçkt
;

158 
m
->
m_√xçkt
 = 
NULL
;

159 i‡(
îr‹
 == 0)

160 
	`if_ouçut
(
so
, 
m
);

162 
	`m_‰ìm
(
m
);

166 
d⁄e
:

167  (
îr‹
);

169 
bad
:

170 
	`m_‰ìm
(
m0
);

171 
d⁄e
;

172 
	}
}

	@slirp/libslirp.h

1 #i‚de‡
_LIBSLIRP_H


2 
	#_LIBSLIRP_H


	)

4 #ifde‡
CONFIG_SLIRP


6 
	~<√töë/ö.h
>

8 
	gSlúp
;

9 
Slúp
 
	tSlúp
;

11 
gë_dns_addr
(
ö_addr
 *
pdns_addr
);

13 
Slúp
 *
¶úp_öô
(
ª°ri˘ed
, 
ö_addr
 
v√tw‹k
,

14 
ö_addr
 
v√tmask
, ö_add∏
vho°
,

15 c⁄° *
vho°«me
, c⁄° *
t·p_∑th
,

16 c⁄° *
boŸfûe
, 
ö_addr
 
vdh˝_°¨t
,

17 
ö_addr
 
v«me£rvî
, *
›aque
);

18 
¶úp_˛ónup
(
Slúp
 *
¶úp
);

20 
¶úp_£À˘_fûl
(
Slúp
 *
¶úp
, *
≤fds
,

21 
fd_£t
 *
ªadfds
, fd_£à*
wrôefds
, fd_£à*
xfds
);

23 
¶úp_£À˘_pﬁl
(
Slúp
 *
¶úp
,

24 
fd_£t
 *
ªadfds
, fd_£à*
wrôefds
, fd_£à*
xfds
,

25 
£À˘_îr‹
);

27 
¶úp_öput
(
Slúp
 *
¶úp
, c⁄° 
uöt8_t
 *
pkt
, 
pkt_Àn
);

30 
¶úp_ˇn_ouçut
(*
›aque
);

31 
¶úp_ouçut
(*
›aque
, c⁄° 
uöt8_t
 *
pkt
, 
pkt_Àn
);

33 
¶úp_add_ho°fwd
(
Slúp
 *
¶úp
, 
is_udp
,

34 
ö_addr
 
ho°_addr
, 
ho°_p‹t
,

35 
ö_addr
 
gue°_addr
, 
gue°_p‹t
);

36 
¶úp_ªmove_ho°fwd
(
Slúp
 *
¶úp
, 
is_udp
,

37 
ö_addr
 
ho°_addr
, 
ho°_p‹t
);

38 
¶úp_add_exec
(
Slúp
 *
¶úp
, 
do_±y
, c⁄° *
¨gs
,

39 
ö_addr
 *
gue°_addr
, 
gue°_p‹t
);

41 
¶úp_sockë_ªcv
(
Slúp
 *
¶úp
, 
ö_addr
 
gue°_addr
,

42 
gue°_p‹t
, c⁄° 
uöt8_t
 *
buf
, 
size
);

43 
size_t
 
¶úp_sockë_ˇn_ªcv
(
Slúp
 *
¶úp
, 
ö_addr
 
gue°_addr
,

44 
gue°_p‹t
);

45 
¶úp_gë_time_ms
();

49 
ölöe
 
	$¶úp_£À˘_fûl
(*
≤fds
, 
fd_£t
 *
ªadfds
,

50 
fd_£t
 *
wrôefds
, fd_£à*
xfds
Ë{ 
	}
}

52 
ölöe
 
	$¶úp_£À˘_pﬁl
(
fd_£t
 *
ªadfds
, fd_£à*
wrôefds
,

53 
fd_£t
 *
xfds
, 
£À˘_îr‹
Ë{ 
	}
}

	@slirp/main.h

8 #ifde‡
HAVE_SYS_SELECT_H


9 
	~<sys/£À˘.h
>

12 
	#TOWRITEMAX
 512

	)

14 
¶úp_sockë
;

15 
¶úp_sockë_unô
;

16 
¶úp_sockë_p‹t
;

17 
uöt32_t
 
¶úp_sockë_addr
;

18 *
¶úp_sockë_∑sswd
;

19 
˘ty_˛o£d
;

27 
	#TIME_DIFF
(
x
,
y
Ë(x)-(yË< 0 ? ~0-(y)+(xË: (x)-(y)

	)

29 *
¶úp_ây
;

30 *
exec_shñl
;

31 
u_öt
 
cuπime
;

32 
fd_£t
 *
globÆ_ªadfds
, *
globÆ_wrôefds
, *
globÆ_xfds
;

33 
ö_addr
 
lo›back_addr
;

34 *
u£∫ame
;

35 *
sockë_∑th
;

36 
towrôe_max
;

37 
µp_exô
;

38 
t˝_kìpötvl
;

40 
	#PROTO_SLIP
 0x1

	)

41 #ifde‡
USE_PPP


42 
	#PROTO_PPP
 0x2

	)

45 
if_íˇp
(
Slúp
 *
¶úp
, c⁄° 
uöt8_t
 *
ù_d©a
, 
ù_d©a_Àn
);

46 
ssize_t
 
¶úp_£nd
(
sockë
 *
so
, c⁄° *
buf
, 
size_t
 
Àn
, 
Êags
);

	@slirp/mbuf.c

18 
	~"¶úp.h
"

20 
	#MBUF_THRESH
 30

	)

26 
	#SLIRP_MSIZE
 (
IF_MTU
 + 
IF_MAXLINKHDR
 + 
	`off£tof
(
mbuf
, 
m_d©
Ë+ 6)

	)

29 
	$m_öô
(
Slúp
 *
¶úp
)

31 
¶úp
->
m_‰ìli°
.
m_√xt
 = slúp->m_‰ìli°.
m_¥ev
 = &slirp->m_freelist;

32 
¶úp
->
m_u£dli°
.
m_√xt
 = slúp->m_u£dli°.
m_¥ev
 = &slirp->m_usedlist;

33 
	}
}

43 
mbuf
 *

44 
	$m_gë
(
Slúp
 *
¶úp
)

46 
mbuf
 *
m
;

47 
Êags
 = 0;

49 
	`DEBUG_CALL
("m_get");

51 i‡(
¶úp
->
m_‰ìli°
.
m_√xt
 == &slirp->m_freelist) {

52 
m
 = (
mbuf
 *)
	`mÆloc
(
SLIRP_MSIZE
);

53 i‡(
m
 =
NULL
Ë
íd_îr‹
;

54 
¶úp
->
mbuf_Ælo˚d
++;

55 i‡(
¶úp
->
mbuf_Ælo˚d
 > 
MBUF_THRESH
)

56 
Êags
 = 
M_DOFREE
;

57 
m
->
¶úp
 = slirp;

59 
m
 = 
¶úp
->
m_‰ìli°
.
m_√xt
;

60 
	`ªmque
(
m
);

64 
	`ösque
(
m
,&
¶úp
->
m_u£dli°
);

65 
m
->
m_Êags
 = (
Êags
 | 
M_USEDLIST
);

68 
m
->
m_size
 = 
SLIRP_MSIZE
 - 
	`off£tof
(
mbuf
, 
m_d©
);

69 
m
->
m_d©a
 = m->
m_d©
;

70 
m
->
m_Àn
 = 0;

71 
m
->
m_√xçkt
 = 
NULL
;

72 
m
->
m_¥evpkt
 = 
NULL
;

73 
íd_îr‹
:

74 
	`DEBUG_ARG
("m = %lx", ()
m
);

75  
m
;

76 
	}
}

79 
	$m_‰ì
(
mbuf
 *
m
)

82 
	`DEBUG_CALL
("m_free");

83 
	`DEBUG_ARG
("m = %lx", ()
m
);

85 if(
m
) {

87 i‡(
m
->
m_Êags
 & 
M_USEDLIST
)

88 
	`ªmque
(
m
);

91 i‡(
m
->
m_Êags
 & 
M_EXT
)

92 
	`‰ì
(
m
->
m_ext
);

97 i‡(
m
->
m_Êags
 & 
M_DOFREE
) {

98 
m
->
¶úp
->
mbuf_Ælo˚d
--;

99 
	`‰ì
(
m
);

100 } i‡((
m
->
m_Êags
 & 
M_FREELIST
) == 0) {

101 
	`ösque
(
m
,&m->
¶úp
->
m_‰ìli°
);

102 
m
->
m_Êags
 = 
M_FREELIST
;

105 
	}
}

113 
	$m_ˇt
(
mbuf
 *
m
, mbu‡*
n
)

118 i‡(
	`M_FREEROOM
(
m
Ë< 
n
->
m_Àn
)

119 
	`m_öc
(
m
,m->
m_size
+
MINCSIZE
);

121 
	`mem˝y
(
m
->
m_d©a
+m->
m_Àn
, 
n
->m_data,Ç->m_len);

122 
m
->
m_Àn
 +
n
->m_len;

124 
	`m_‰ì
(
n
);

125 
	}
}

130 
	$m_öc
(
mbuf
 *
m
, 
size
)

132 
d©asize
;

135 if(
m
->
m_size
>
size
) ;

137 i‡(
m
->
m_Êags
 & 
M_EXT
) {

138 
d©asize
 = 
m
->
m_d©a
 - m->
m_ext
;

139 
m
->
m_ext
 = (*)
	`ªÆloc
(m->m_ext,
size
);

140 
m
->
m_d©a
 = m->
m_ext
 + 
d©asize
;

142 *
d©
;

143 
d©asize
 = 
m
->
m_d©a
 - m->
m_d©
;

144 
d©
 = (*)
	`mÆloc
(
size
);

145 
	`mem˝y
(
d©
, 
m
->
m_d©
, m->
m_size
);

147 
m
->
m_ext
 = 
d©
;

148 
m
->
m_d©a
 = m->
m_ext
 + 
d©asize
;

149 
m
->
m_Êags
 |
M_EXT
;

152 
m
->
m_size
 = 
size
;

154 
	}
}

159 
	$m_adj
(
mbuf
 *
m
, 
Àn
)

161 i‡(
m
 =
NULL
)

163 i‡(
Àn
 >= 0) {

165 
m
->
m_d©a
 +
Àn
;

166 
m
->
m_Àn
 -
Àn
;

169 
Àn
 = -len;

170 
m
->
m_Àn
 -
Àn
;

172 
	}
}

179 
	$m_c›y
(
mbuf
 *
n
, mbu‡*
m
, 
off
, 
Àn
)

181 i‡(
Àn
 > 
	`M_FREEROOM
(
n
))

184 
	`mem˝y
((
n
->
m_d©a
 +Ç->
m_Àn
), (
m
->m_d©®+ 
off
), 
Àn
);

185 
n
->
m_Àn
 +
Àn
;

187 
	}
}

195 
mbuf
 *

196 
	$dtom
(
Slúp
 *
¶úp
, *
d©
)

198 
mbuf
 *
m
;

200 
	`DEBUG_CALL
("dtom");

201 
	`DEBUG_ARG
("d© = %lx", ()
d©
);

204 
m
 = 
¶úp
->
m_u£dli°
.
m_√xt
; m != &slirp->m_usedlist;

205 
m
 = m->
m_√xt
) {

206 i‡(
m
->
m_Êags
 & 
M_EXT
) {

207 if–(*)
d©
>=
m
->
m_ext
 && (*)d©<(m->m_exà+ m->
m_size
) )

208  
m
;

210 if–(*)
d©
 >
m
->
m_d©
 && (*)d©<(m->m_d© + m->
m_size
) )

211  
m
;

215 
	`DEBUG_ERROR
((
dfd
, "dtom failed"));

217  (
mbuf
 *)0;

218 
	}
}

	@slirp/mbuf.h

33 #i‚de‡
_MBUF_H_


34 
	#_MBUF_H_


	)

36 
	#m_‰ìm
 
m_‰ì


	)

39 
	#MINCSIZE
 4096

	)

45 
	#mtod
(
m
,
t
Ë(—)(m)->
m_d©a
)

	)

57 
	sm_hdr
 {

58 
mbuf
 *
	mmh_√xt
;

59 
mbuf
 *
	mmh_¥ev
;

60 
mbuf
 *
	mmh_√xçkt
;

61 
mbuf
 *
	mmh_¥evpkt
;

62 
	mmh_Êags
;

64 
	mmh_size
;

65 
sockë
 *
	mmh_so
;

67 
ˇddr_t
 
	mmh_d©a
;

68 
	mmh_Àn
;

74 
	#M_ROOM
(
m
Ë((m->
m_Êags
 & 
M_EXT
)? \

75 (((
m
)->
m_ext
 + (m)->
m_size
Ë- (m)->
m_d©a
) \

77 (((
m
)->
m_d©
 + (m)->
m_size
Ë- (m)->
m_d©a
))

	)

82 
	#M_FREEROOM
(
m
Ë(
	`M_ROOM
(mË- (m)->
m_Àn
)

	)

83 
	#M_TRAILINGSPACE
 
M_FREEROOM


	)

85 
	smbuf
 {

86 
m_hdr
 
	mm_hdr
;

87 
Slúp
 *
	m¶úp
;

88 
	uM_d©
 {

89 
	mm_d©_
[1];

90 *
	mm_ext_
;

91 } 
	mM_d©
;

94 
	#m_√xt
 
m_hdr
.
mh_√xt


	)

95 
	#m_¥ev
 
m_hdr
.
mh_¥ev


	)

96 
	#m_√xçkt
 
m_hdr
.
mh_√xçkt


	)

97 
	#m_¥evpkt
 
m_hdr
.
mh_¥evpkt


	)

98 
	#m_Êags
 
m_hdr
.
mh_Êags


	)

99 
	#m_Àn
 
m_hdr
.
mh_Àn


	)

100 
	#m_d©a
 
m_hdr
.
mh_d©a


	)

101 
	#m_size
 
m_hdr
.
mh_size


	)

102 
	#m_d©
 
M_d©
.
m_d©_


	)

103 
	#m_ext
 
M_d©
.
m_ext_


	)

104 
	#m_so
 
m_hdr
.
mh_so


	)

106 
	#ifq_¥ev
 
m_¥ev


	)

107 
	#ifq_√xt
 
m_√xt


	)

108 
	#ifs_¥ev
 
m_¥evpkt


	)

109 
	#ifs_√xt
 
m_√xçkt


	)

110 
	#ifq_so
 
m_so


	)

112 
	#M_EXT
 0x01

	)

113 
	#M_FREELIST
 0x02

	)

114 
	#M_USEDLIST
 0x04

	)

115 
	#M_DOFREE
 0x08

	)

118 
m_öô
(
Slúp
 *);

119 
mbuf
 * 
m_gë
(
Slúp
 *);

120 
m_‰ì
(
mbuf
 *);

121 
m_ˇt
(
mbuf
 *, mbuf *);

122 
m_öc
(
mbuf
 *, );

123 
m_adj
(
mbuf
 *, );

124 
m_c›y
(
mbuf
 *, mbuf *, , );

125 
mbuf
 * 
dtom
(
Slúp
 *, *);

	@slirp/misc.c

8 
	~"¶úp.h
"

10 #ifde‡
DEBUG


11 
	g¶úp_debug
 = 
DBG_CALL
|
DBG_MISC
|
DBG_ERROR
;

14 
	squehód
 {

15 
quehód
 *
	mqh_lök
;

16 
quehód
 *
	mqh_æök
;

19 
ölöe
 

20 
	$ösque
(*
a
, *
b
)

22 
quehód
 *
ñemít
 = (quehód *Ë
a
;

23 
quehód
 *
hód
 = (quehód *Ë
b
;

24 
ñemít
->
qh_lök
 = 
hód
->qh_link;

25 
hód
->
qh_lök
 = (
quehód
 *)
ñemít
;

26 
ñemít
->
qh_æök
 = (
quehód
 *)
hód
;

27 ((
quehód
 *)(
ñemít
->
qh_lök
))->
qh_æök


28 (
quehód
 *)
ñemít
;

29 
	}
}

31 
ölöe
 

32 
	$ªmque
(*
a
)

34 
quehód
 *
ñemít
 = (quehód *Ë
a
;

35 ((
quehód
 *)(
ñemít
->
qh_lök
))->
qh_æök
 =Élement->qh_rlink;

36 ((
quehód
 *)(
ñemít
->
qh_æök
))->
qh_lök
 =Élement->qh_link;

37 
ñemít
->
qh_æök
 = 
NULL
;

38 
	}
}

40 
	$add_exec
(
ex_li°
 **
ex_±r
, 
do_±y
, *
exec
,

41 
ö_addr
 
addr
, 
p‹t
)

43 
ex_li°
 *
tmp_±r
;

46 
tmp_±r
 = *
ex_±r
;Åmp_±r;Åmp_±∏tmp_±r->
ex_√xt
) {

47 i‡(
p‹t
 =
tmp_±r
->
ex_Â‹t
 &&

48 
addr
.
s_addr
 =
tmp_±r
->
ex_addr
.s_addr)

52 
tmp_±r
 = *
ex_±r
;

53 *
ex_±r
 = (
ex_li°
 *)
	`mÆloc
((ex_list));

54 (*
ex_±r
)->
ex_Â‹t
 = 
p‹t
;

55 (*
ex_±r
)->
ex_addr
 = 
addr
;

56 (*
ex_±r
)->
ex_±y
 = 
do_±y
;

57 (*
ex_±r
)->
ex_exec
 = (
do_±y
 =3Ë? 
exec
 : 
	`°rdup
(exec);

58 (*
ex_±r
)->
ex_√xt
 = 
tmp_±r
;

60 
	}
}

62 #i‚de‡
HAVE_STRERROR


68 
sys_√º
;

69 *
sys_îæi°
[];

72 
	$°ªº‹
(
îr‹
)

73 
îr‹
;

75 i‡(
îr‹
 < 
sys_√º
)

76  
sys_îæi°
[
îr‹
];

79 
	}
}

83 
	$os_sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
)

85  
	`sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
);

86 
	}
}

88 
uöt32_t
 
	$os_gë_time_ms
()

90 
time•ec
 
ts
;

92 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ts
);

93  
ts
.
tv_£c
 * 1000 +

94 (
ts
.
tv_n£c
 / 1000000);

95 
	}
}

101 
	$f‹k_exec
(
sockë
 *
so
, c⁄° *
ex
, 
do_±y
)

105 
	}
}

121 
	$f‹k_exec
(
sockë
 *
so
, c⁄° *
ex
, 
do_±y
)

123 
s
;

124 
sockaddr_ö
 
addr
;

125 
sockÀn_t
 
addæí
 = (
addr
);

126 
›t
;

127 
ma°î
 = -1;

128 c⁄° *
¨gv
[256];

130 *
b±r
;

131 c⁄° *
cuørg
;

132 
c
, 
i
, 
ªt
;

134 
	`DEBUG_CALL
("fork_exec");

135 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

136 
	`DEBUG_ARG
("ex = %lx", ()
ex
);

137 
	`DEBUG_ARG
("do_±y = %lx", ()
do_±y
);

139 i‡(
do_±y
 == 2) {

142 
addr
.
sö_Ámûy
 = 
AF_INET
;

143 
addr
.
sö_p‹t
 = 0;

144 
addr
.
sö_addr
.
s_addr
 = 
INADDR_ANY
;

146 i‡((
s
 = 
	`os_sockë
(
AF_INET
, 
SOCK_STREAM
, 0)) < 0 ||

147 
	`böd
(
s
, (
sockaddr
 *)&
addr
, 
addæí
) < 0 ||

148 
	`li°í
(
s
, 1) < 0) {

149 
	`Õröt
("Eº‹: i√àsockë: %s\n", 
	`°ªº‹
(
î∫o
));

150 
	`˛o£sockë
(
s
);

156 
	`f‹k
()) {

158 
	`Õröt
("Eº‹: f‹k faûed: %s\n", 
	`°ªº‹
(
î∫o
));

159 
	`˛o£
(
s
);

160 i‡(
do_±y
 == 2)

161 
	`˛o£
(
ma°î
);

166 i‡(
do_±y
 == 2) {

167 (Ë
	`˛o£
(
ma°î
);

168 #ifde‡
TIOCSCTTY


169 (Ë
	`£tsid
();

170 
	`io˘l
(
s
, 
TIOCSCTTY
, (*)
NULL
);

173 
	`gësock«me
(
s
, (
sockaddr
 *)&
addr
, &
addæí
);

174 
	`˛o£
(
s
);

179 
s
 = 
	`os_sockë
(
AF_INET
, 
SOCK_STREAM
, 0);

180 
addr
.
sö_addr
 = 
lo›back_addr
;

182 
ªt
 = 
	`c⁄√˘
(
s
, (
sockaddr
 *)&
addr
, 
addæí
);

183 } 
ªt
 < 0 && 
î∫o
 =
EINTR
);

186 
	`dup2
(
s
, 0);

187 
	`dup2
(
s
, 1);

188 
	`dup2
(
s
, 2);

189 
s
 = 
	`gëdèbÀsize
() - 1; s >= 3; s--)

190 
	`˛o£
(
s
);

192 
i
 = 0;

193 
b±r
 = 
	`qemu_°rdup
(
ex
);

194 i‡(
do_±y
 == 1) {

196 
¨gv
[
i
++] = "slirp.telnetd";

197 
¨gv
[
i
++] = "-x";

198 
¨gv
[
i
++] = 
b±r
;

202 
cuørg
 = 
b±r
;

203 *
b±r
 != ' ' && *bptr != ()0)

204 
b±r
++;

205 
c
 = *
b±r
;

206 *
b±r
++ = ()0;

207 
¨gv
[
i
++] = 
	`°rdup
(
cuørg
);

208 } 
c
);

210 
¨gv
[
i
] = 
NULL
;

211 
	`execvp
(
¨gv
[0], (**)argv);

214 
	`Ârötf
(
°dîr
, "Error:Éxecvp of %s failed: %s\n",

215 
¨gv
[0], 
	`°ªº‹
(
î∫o
));

216 
	`˛o£
(0); close(1); close(2);

217 
	`exô
(1);

220 i‡(
do_±y
 == 2) {

221 
	`˛o£
(
s
);

222 
so
->
s
 = 
ma°î
;

232 
so
->
s
 = 
	`ac˚±
(s, (
sockaddr
 *)&
addr
, &
addæí
);

233 } 
so
->
s
 < 0 && 
î∫o
 =
EINTR
);

234 
	`˛o£sockë
(
s
);

235 
›t
 = 1;

236 
	`£tsock›t
(
so
->
s
,
SOL_SOCKET
,
SO_REUSEADDR
,(*)&
›t
,());

237 
›t
 = 1;

238 
	`£tsock›t
(
so
->
s
,
SOL_SOCKET
,
SO_OOBINLINE
,(*)&
›t
,());

240 
	`fd_n⁄block
(
so
->
s
);

243 i‡(
so
->
so_m
 !
NULL
 && 
do_±y
 == 1) {

244 
	`sb≠≥nd
(
so
, so->
so_m
);

245 
so
->
so_m
 = 
NULL
;

250 
	}
}

253 #i‚de‡
HAVE_STRDUP


255 
	$°rdup
(
°r
)

256 c⁄° *
°r
;

258 *
b±r
;

260 
b±r
 = (*)
	`mÆloc
(
	`°æí
(
°r
)+1);

261 
	`°r˝y
(
b±r
, 
°r
);

263  
b±r
;

264 
	}
}

267 
	$Õröt
(c⁄° *
f‹m©
, ...)

269 
va_li°
 
¨gs
;

271 
	`va_°¨t
(
¨gs
, 
f‹m©
);

272 
	`v¥ötf
(
f‹m©
, 
¨gs
);

273 
	`va_íd
(
¨gs
);

274 
	}
}

281 
	$fd_n⁄block
(
fd
)

283 #ifde‡
FIONBIO


284 #ifde‡
_WIN32


285 
›t
 = 1;

287 
›t
 = 1;

290 
	`io˘lsockë
(
fd
, 
FIONBIO
, &
›t
);

292 
›t
;

294 
›t
 = 
	`f˙é
(
fd
, 
F_GETFL
, 0);

295 
›t
 |
O_NONBLOCK
;

296 
	`f˙é
(
fd
, 
F_SETFL
, 
›t
);

298 
	}
}

301 
	$fd_block
(
fd
)

303 #ifde‡
FIONBIO


304 #ifde‡
_WIN32


305 
›t
 = 0;

307 
›t
 = 0;

310 
	`io˘lsockë
(
fd
, 
FIONBIO
, &
›t
);

312 
›t
;

314 
›t
 = 
	`f˙é
(
fd
, 
F_GETFL
, 0);

315 
›t
 &~
O_NONBLOCK
;

316 
	`f˙é
(
fd
, 
F_SETFL
, 
›t
);

318 
	}
}

321 
	$¶úp_c⁄√˘i⁄_öfo
(
Slúp
 *
¶úp
, 
M⁄ô‹
 *
m⁄
)

323 c⁄° * c⁄° 
t˝°©es
[] = {

324 [
TCPS_CLOSED
] = "CLOSED",

325 [
TCPS_LISTEN
] = "LISTEN",

326 [
TCPS_SYN_SENT
] = "SYN_SENT",

327 [
TCPS_SYN_RECEIVED
] = "SYN_RCVD",

328 [
TCPS_ESTABLISHED
] = "ESTABLISHED",

329 [
TCPS_CLOSE_WAIT
] = "CLOSE_WAIT",

330 [
TCPS_FIN_WAIT_1
] = "FIN_WAIT_1",

331 [
TCPS_CLOSING
] = "CLOSING",

332 [
TCPS_LAST_ACK
] = "LAST_ACK",

333 [
TCPS_FIN_WAIT_2
] = "FIN_WAIT_2",

334 [
TCPS_TIME_WAIT
] = "TIME_WAIT",

336 
ö_addr
 
d°_addr
;

337 
sockaddr_ö
 
§c
;

338 
sockÀn_t
 
§c_Àn
;

339 
uöt16_t
 
d°_p‹t
;

340 
sockë
 *
so
;

341 c⁄° *
°©e
;

342 
buf
[20];

343 
n
;

345 
	`m⁄ô‹_¥ötf
(
m⁄
, " Protocol[State] FD Source Address Port "

348 
so
 = 
¶úp
->
tcb
.
so_√xt
; so != &slirp->tcb; so = so->so_next) {

349 i‡(
so
->
so_°©e
 & 
SS_HOSTFWD
) {

350 
°©e
 = "HOST_FORWARD";

351 } i‡(
so
->
so_t˝cb
) {

352 
°©e
 = 
t˝°©es
[
so
->
so_t˝cb
->
t_°©e
];

354 
°©e
 = "NONE";

356 i‡(
so
->
so_°©e
 & (
SS_HOSTFWD
 | 
SS_INCOMING
)) {

357 
§c_Àn
 = (
§c
);

358 
	`gësock«me
(
so
->
s
, (
sockaddr
 *)&
§c
, &
§c_Àn
);

359 
d°_addr
 = 
so
->
so_œddr
;

360 
d°_p‹t
 = 
so
->
so_Õ‹t
;

362 
§c
.
sö_addr
 = 
so
->
so_œddr
;

363 
§c
.
sö_p‹t
 = 
so
->
so_Õ‹t
;

364 
d°_addr
 = 
so
->
so_Áddr
;

365 
d°_p‹t
 = 
so
->
so_Â‹t
;

367 
n
 = 
	`¢¥ötf
(
buf
, (buf), " TCP[%s]", 
°©e
);

368 
	`mem£t
(&
buf
[
n
], ' ', 19 -Ç);

369 
buf
[19] = 0;

370 
	`m⁄ô‹_¥ötf
(
m⁄
, "%†%3d %15†%5d ", 
buf
, 
so
->
s
,

371 
§c
.
sö_addr
.
s_addr
 ? 
	`öë_¡ﬂ
(src.sin_addr) : "*",

372 
	`¡ohs
(
§c
.
sö_p‹t
));

373 
	`m⁄ô‹_¥ötf
(
m⁄
, "%15s %5d %5d %5d\n",

374 
	`öë_¡ﬂ
(
d°_addr
), 
	`¡ohs
(
d°_p‹t
),

375 
so
->
so_rcv
.
sb_cc
, so->
so_¢d
.sb_cc);

378 
so
 = 
¶úp
->
udb
.
so_√xt
; so != &slirp->udb; so = so->so_next) {

379 i‡(
so
->
so_°©e
 & 
SS_HOSTFWD
) {

380 
n
 = 
	`¢¥ötf
(
buf
, (buf), " UDP[HOST_FORWARD]");

381 
§c_Àn
 = (
§c
);

382 
	`gësock«me
(
so
->
s
, (
sockaddr
 *)&
§c
, &
§c_Àn
);

383 
d°_addr
 = 
so
->
so_œddr
;

384 
d°_p‹t
 = 
so
->
so_Õ‹t
;

386 
n
 = 
	`¢¥ötf
(
buf
, (buf), " UDP[%d sec]",

387 (
so
->
so_expúe
 - 
cuπime
) / 1000);

388 
§c
.
sö_addr
 = 
so
->
so_œddr
;

389 
§c
.
sö_p‹t
 = 
so
->
so_Õ‹t
;

390 
d°_addr
 = 
so
->
so_Áddr
;

391 
d°_p‹t
 = 
so
->
so_Â‹t
;

393 
	`mem£t
(&
buf
[
n
], ' ', 19 -Ç);

394 
buf
[19] = 0;

395 
	`m⁄ô‹_¥ötf
(
m⁄
, "%†%3d %15†%5d ", 
buf
, 
so
->
s
,

396 
§c
.
sö_addr
.
s_addr
 ? 
	`öë_¡ﬂ
(src.sin_addr) : "*",

397 
	`¡ohs
(
§c
.
sö_p‹t
));

398 
	`m⁄ô‹_¥ötf
(
m⁄
, "%15s %5d %5d %5d\n",

399 
	`öë_¡ﬂ
(
d°_addr
), 
	`¡ohs
(
d°_p‹t
),

400 
so
->
so_rcv
.
sb_cc
, so->
so_¢d
.sb_cc);

402 
	}
}

	@slirp/misc.h

8 #i‚de‡
_MISC_H_


9 
	#_MISC_H_


	)

11 
	sex_li°
 {

12 
	mex_±y
;

13 
ö_addr
 
	mex_addr
;

14 
	mex_Â‹t
;

15 c⁄° *
	mex_exec
;

16 
ex_li°
 *
	mex_√xt
;

19 #i‚de‡
HAVE_STRDUP


20 *
°rdup
(const *);

23 
do_waô
();

25 
	#EMU_NONE
 0x0

	)

28 
	#EMU_CTL
 0x1

	)

29 
	#EMU_FTP
 0x2

	)

30 
	#EMU_KSH
 0x3

	)

31 
	#EMU_IRC
 0x4

	)

32 
	#EMU_REALAUDIO
 0x5

	)

33 
	#EMU_RLOGIN
 0x6

	)

34 
	#EMU_IDENT
 0x7

	)

35 
	#EMU_RSH
 0x8

	)

37 
	#EMU_NOCONNECT
 0x10

	)

39 
	stos_t
 {

40 
uöt16_t
 
	mÕ‹t
;

41 
uöt16_t
 
	mÂ‹t
;

42 
uöt8_t
 
	mtos
;

43 
uöt8_t
 
	memu
;

46 
	semu_t
 {

47 
uöt16_t
 
	mÕ‹t
;

48 
uöt16_t
 
	mÂ‹t
;

49 
uöt8_t
 
	mtos
;

50 
uöt8_t
 
	memu
;

51 
emu_t
 *
	m√xt
;

54 
x_p‹t
, 
x_£rvî
, 
x_di•œy
;

56 
show_x
(*, 
sockë
 *);

57 
ªdú_x
(
uöt32_t
, , , );

58 
¶úp_ösque
(*, *);

59 
¶úp_ªmque
(*);

60 
add_exec
(
ex_li°
 **, , *, 
ö_addr
, );

61 
¶úp_›í±y
(*, *);

62 
f‹k_exec
(
sockë
 *
so
, c⁄° *
ex
, 
do_±y
);

63 
¢ooze_hup
();

64 
¢ooze
();

65 
ªœy
();

66 
add_emu
(*);

67 
fd_n⁄block
();

68 
fd_block
();

69 
rsh_exec
(
sockë
 *, socket *, *, *, *);

70 
os_sockë
(
domaö
, 
ty≥
, 
¥Ÿocﬁ
);

71 
uöt32_t
 
os_gë_time_ms
();

	@slirp/sbuf.c

8 
	~"¶úp.h
"

10 
sb≠≥ndsb
(
sbuf
 *
sb
, 
mbuf
 *
m
);

13 
	$sb‰ì
(
sbuf
 *
sb
)

15 
	`‰ì
(
sb
->
sb_d©a
);

16 
	}
}

19 
	$sbdr›
(
sbuf
 *
sb
, 
num
)

25 if(
num
 > 
sb
->
sb_cc
)

26 
num
 = 
sb
->
sb_cc
;

27 
sb
->
sb_cc
 -
num
;

28 
sb
->
sb_Ωå
 +
num
;

29 if(
sb
->
sb_Ωå
 >sb->
sb_d©a
 + sb->
sb_d©Æí
)

30 
sb
->
sb_Ωå
 -sb->
sb_d©Æí
;

32 
	}
}

35 
	$sbª£rve
(
sbuf
 *
sb
, 
size
)

37 i‡(
sb
->
sb_d©a
) {

39 i‡(
sb
->
sb_d©Æí
 !
size
) {

40 
sb
->
sb_w±r
 = sb->
sb_Ωå
 = sb->
sb_d©a
 = (*)
	`ªÆloc
(sb->sb_d©a, 
size
);

41 
sb
->
sb_cc
 = 0;

42 i‡(
sb
->
sb_w±r
)

43 
sb
->
sb_d©Æí
 = 
size
;

45 
sb
->
sb_d©Æí
 = 0;

48 
sb
->
sb_w±r
 = sb->
sb_Ωå
 = sb->
sb_d©a
 = (*)
	`mÆloc
(
size
);

49 
sb
->
sb_cc
 = 0;

50 i‡(
sb
->
sb_w±r
)

51 
sb
->
sb_d©Æí
 = 
size
;

53 
sb
->
sb_d©Æí
 = 0;

55 
	}
}

64 
	$sb≠≥nd
(
sockë
 *
so
, 
mbuf
 *
m
)

66 
ªt
 = 0;

68 
	`DEBUG_CALL
("sbappend");

69 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

70 
	`DEBUG_ARG
("m = %lx", ()
m
);

71 
	`DEBUG_ARG
("m->m_À¿%d", 
m
->
m_Àn
);

74 i‡(
m
->
m_Àn
 <= 0) {

75 
	`m_‰ì
(
m
);

84 i‡(
so
->
so_urgc
) {

85 
	`sb≠≥ndsb
(&
so
->
so_rcv
, 
m
);

86 
	`m_‰ì
(
m
);

87 
	`so£ndoob
(
so
);

95 i‡(!
so
->
so_rcv
.
sb_cc
)

96 
ªt
 = 
	`¶úp_£nd
(
so
, 
m
->
m_d©a
, m->
m_Àn
, 0);

98 i‡(
ªt
 <= 0) {

105 
	`sb≠≥ndsb
(&
so
->
so_rcv
, 
m
);

106 } i‡(
ªt
 !
m
->
m_Àn
) {

111 
m
->
m_Àn
 -
ªt
;

112 
m
->
m_d©a
 +
ªt
;

113 
	`sb≠≥ndsb
(&
so
->
so_rcv
, 
m
);

116 
	`m_‰ì
(
m
);

117 
	}
}

124 
	$sb≠≥ndsb
(
sbuf
 *
sb
, 
mbuf
 *
m
)

126 
Àn
, 
n
, 
¬
;

128 
Àn
 = 
m
->
m_Àn
;

130 i‡(
sb
->
sb_w±r
 < sb->
sb_Ωå
) {

131 
n
 = 
sb
->
sb_Ωå
 - sb->
sb_w±r
;

132 i‡(
n
 > 
Àn
)Ç =Üen;

133 
	`mem˝y
(
sb
->
sb_w±r
, 
m
->
m_d©a
, 
n
);

136 
n
 = 
sb
->
sb_d©a
 + sb->
sb_d©Æí
 - sb->
sb_w±r
;

137 i‡(
n
 > 
Àn
)Ç =Üen;

138 
	`mem˝y
(
sb
->
sb_w±r
, 
m
->
m_d©a
, 
n
);

139 
Àn
 -
n
;

140 i‡(
Àn
) {

142 
¬
 = 
sb
->
sb_Ωå
 - sb->
sb_d©a
;

143 i‡(
¬
 > 
Àn
)Çn =Üen;

144 
	`mem˝y
(
sb
->
sb_d©a
,
m
->
m_d©a
+
n
,
¬
);

145 
n
 +
¬
;

149 
sb
->
sb_cc
 +
n
;

150 
sb
->
sb_w±r
 +
n
;

151 i‡(
sb
->
sb_w±r
 >sb->
sb_d©a
 + sb->
sb_d©Æí
)

152 
sb
->
sb_w±r
 -sb->
sb_d©Æí
;

153 
	}
}

161 
	$sbc›y
(
sbuf
 *
sb
, 
off
, 
Àn
, *
to
)

163 *
‰om
;

165 
‰om
 = 
sb
->
sb_Ωå
 + 
off
;

166 i‡(
‰om
 >
sb
->
sb_d©a
 + sb->
sb_d©Æí
)

167 
‰om
 -
sb
->
sb_d©Æí
;

169 i‡(
‰om
 < 
sb
->
sb_w±r
) {

170 i‡(
Àn
 > 
sb
->
sb_cc
)Üen = sb->sb_cc;

171 
	`mem˝y
(
to
,
‰om
,
Àn
);

174 
off
 = (
sb
->
sb_d©a
 + sb->
sb_d©Æí
Ë- 
‰om
;

175 i‡(
off
 > 
Àn
) off =Üen;

176 
	`mem˝y
(
to
,
‰om
,
off
);

177 
Àn
 -
off
;

178 i‡(
Àn
)

179 
	`mem˝y
(
to
+
off
,
sb
->
sb_d©a
,
Àn
);

181 
	}
}

	@slirp/sbuf.h

8 #i‚de‡
_SBUF_H_


9 
	#_SBUF_H_


	)

11 
	#sbÊush
(
sb
Ë
	`sbdr›
((sb),(sb)->
sb_cc
)

	)

12 
	#sb•a˚
(
sb
Ë((sb)->
sb_d©Æí
 - (sb)->
sb_cc
)

	)

14 
	ssbuf
 {

15 
u_öt
 
	msb_cc
;

16 
u_öt
 
	msb_d©Æí
;

17 *
	msb_w±r
;

19 *
	msb_Ωå
;

21 *
	msb_d©a
;

24 
sb‰ì
(
sbuf
 *);

25 
sbdr›
(
sbuf
 *, );

26 
sbª£rve
(
sbuf
 *, );

27 
sb≠≥nd
(
sockë
 *, 
mbuf
 *);

28 
sbc›y
(
sbuf
 *, , , *);

	@slirp/slirp.c

24 
	~"¶úp.h
"

27 
ö_addr
 
	glo›back_addr
;

30 c⁄° 
uöt8_t
 
	g•ecül_ëhaddr
[6] = {

34 c⁄° 
uöt8_t
 
	gzîo_ëhaddr
[6] = { 0, 0, 0, 0, 0, 0 };

37 
fd_£t
 *
	gglobÆ_ªadfds
, *
	gglobÆ_wrôefds
, *
	gglobÆ_xfds
;

39 
u_öt
 
	gcuπime
;

40 
u_öt
 
	gtime_Á°timo
, 
	gœ°_¶owtimo
;

41 
	gdo_¶owtimo
;

43 
ö_addr
 
	gdns_addr
;

44 
u_öt
 
	gdns_addr_time
;

46 #ifde‡
_WIN32


48 
	$gë_dns_addr
(
ö_addr
 *
pdns_addr
)

50 
FIXED_INFO
 *
FixedInfo
=
NULL
;

51 
ULONG
 
BufLí
;

52 
DWORD
 
ªt
;

53 
IP_ADDR_STRING
 *
pIPAddr
;

54 
ö_addr
 
tmp_addr
;

56 i‡(
dns_addr
.
s_addr
 !0 && (
cuπime
 - 
dns_addr_time
) < 1000) {

57 *
pdns_addr
 = 
dns_addr
;

61 
FixedInfo
 = (
FIXED_INFO
 *)
	`GlobÆAŒoc
(
GPTR
, (FIXED_INFO));

62 
BufLí
 = (
FIXED_INFO
);

64 i‡(
ERROR_BUFFER_OVERFLOW
 =
	`GëNëw‹kP¨ams
(
FixedInfo
, &
BufLí
)) {

65 i‡(
FixedInfo
) {

66 
	`GlobÆFªe
(
FixedInfo
);

67 
FixedInfo
 = 
NULL
;

69 
FixedInfo
 = 
	`GlobÆAŒoc
(
GPTR
, 
BufLí
);

72 i‡((
ªt
 = 
	`GëNëw‹kP¨ams
(
FixedInfo
, &
BufLí
)Ë!
ERROR_SUCCESS
) {

73 
	`¥ötf
("GëNëw‹kP¨am†Áûed.Ñë = %08x\n", (
u_öt
)
ªt
 );

74 i‡(
FixedInfo
) {

75 
	`GlobÆFªe
(
FixedInfo
);

76 
FixedInfo
 = 
NULL
;

81 
pIPAddr
 = &(
FixedInfo
->
DnsSîvîLi°
);

82 
	`öë_©⁄
(
pIPAddr
->
IpAddªss
.
Såög
, &
tmp_addr
);

83 *
pdns_addr
 = 
tmp_addr
;

84 
dns_addr
 = 
tmp_addr
;

85 
dns_addr_time
 = 
cuπime
;

86 i‡(
FixedInfo
) {

87 
	`GlobÆFªe
(
FixedInfo
);

88 
FixedInfo
 = 
NULL
;

91 
	}
}

93 
	$wösock_˛ónup
()

95 
	`WSACÀ™up
();

96 
	}
}

100 
°©
 
	gdns_addr_°©
;

102 
	$gë_dns_addr
(
ö_addr
 *
pdns_addr
)

104 
buff
[512];

105 
buff2
[257];

106 
FILE
 *
f
;

107 
found
 = 0;

108 
ö_addr
 
tmp_addr
;

110 i‡(
dns_addr
.
s_addr
 != 0) {

111 
°©
 
ﬁd_°©
;

112 i‡((
cuπime
 - 
dns_addr_time
) < 1000) {

113 *
pdns_addr
 = 
dns_addr
;

116 
ﬁd_°©
 = 
dns_addr_°©
;

117 i‡(
	`°©
("/ëc/ªsﬁv.c⁄f", &
dns_addr_°©
) != 0)

119 i‡((
dns_addr_°©
.
°_dev
 =
ﬁd_°©
.st_dev)

120 && (
dns_addr_°©
.
°_öo
 =
ﬁd_°©
.st_ino)

121 && (
dns_addr_°©
.
°_size
 =
ﬁd_°©
.st_size)

122 && (
dns_addr_°©
.
°_mtime
 =
ﬁd_°©
.st_mtime)) {

123 *
pdns_addr
 = 
dns_addr
;

128 
f
 = 
	`f›í
("/etc/resolv.conf", "r");

129 i‡(!
f
)

132 #ifde‡
DEBUG


133 
	`Õröt
("IPáddress of your DNS(s): ");

135 
	`fgës
(
buff
, 512, 
f
Ë!
NULL
) {

136 i‡(
	`ssˇnf
(
buff
, "«me£rvî%*[ \t]%256s", 
buff2
) == 1) {

137 i‡(!
	`öë_©⁄
(
buff2
, &
tmp_addr
))

140 i‡(!
found
) {

141 *
pdns_addr
 = 
tmp_addr
;

142 
dns_addr
 = 
tmp_addr
;

143 
dns_addr_time
 = 
cuπime
;

145 #ifde‡
DEBUG


147 
	`Õröt
(", ");

149 i‡(++
found
 > 3) {

150 #ifde‡
DEBUG


151 
	`Õröt
("(more)");

155 #ifde‡
DEBUG


157 
	`Õröt
("%s", 
	`öë_¡ﬂ
(
tmp_addr
));

161 
	`f˛o£
(
f
);

162 i‡(!
found
)

165 
	}
}

169 
	$¶úp_öô_⁄˚
()

171 
öôülized
;

172 #ifde‡
_WIN32


173 
WSADATA
 
D©a
;

176 i‡(
öôülized
) {

179 
öôülized
 = 1;

181 #ifde‡
_WIN32


182 
	`WSASèπup
(
	`MAKEWORD
(2,0), &
D©a
);

183 
	`©exô
(
wösock_˛ónup
);

186 
lo›back_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
);

187 
	}
}

189 
Slúp
 *
	$¶úp_öô
(
ª°ri˘ed
, 
ö_addr
 
v√tw‹k
,

190 
ö_addr
 
v√tmask
, ö_add∏
vho°
,

191 c⁄° *
vho°«me
, c⁄° *
t·p_∑th
,

192 c⁄° *
boŸfûe
, 
ö_addr
 
vdh˝_°¨t
,

193 
ö_addr
 
v«me£rvî
, *
›aque
)

195 
Slúp
 *
¶úp
 = 
	`mÆlocz
((Slirp));

197 
	`¶úp_öô_⁄˚
();

199 
¶úp
->
ª°ri˘ed
 =Ñestricted;

201 
	`if_öô
(
¶úp
);

202 
	`ù_öô
(
¶úp
);

205 
	`m_öô
(
¶úp
);

207 
¶úp
->
v√tw‹k_addr
 = 
v√tw‹k
;

208 
¶úp
->
v√tw‹k_mask
 = 
v√tmask
;

209 
¶úp
->
vho°_addr
 = 
vho°
;

210 i‡(
vho°«me
) {

211 
	`p°r˝y
(
¶úp
->
˛õ¡_ho°«me
, (slirp->client_hostname),

212 
vho°«me
);

214 i‡(
t·p_∑th
) {

215 
¶úp
->
t·p_¥efix
 = 
	`°rdup
(
t·p_∑th
);

217 i‡(
boŸfûe
) {

218 
¶úp
->
boŸp_fûíame
 = 
	`°rdup
(
boŸfûe
);

220 
¶úp
->
vdh˝_°¨èddr
 = 
vdh˝_°¨t
;

221 
¶úp
->
v«me£rvî_addr
 = 
v«me£rvî
;

223 
¶úp
->
›aque
 = opaque;

225  
¶úp
;

226 
	}
}

228 
	$¶úp_˛ónup
(
Slúp
 *
¶úp
)

230 
	`‰ì
(
¶úp
->
t·p_¥efix
);

231 
	`‰ì
(
¶úp
->
boŸp_fûíame
);

232 
	`‰ì
(
¶úp
);

233 
	}
}

235 
	#CONN_CANFSEND
(
so
Ë(((so)->
so_°©e
 & (
SS_FCANTSENDMORE
|
SS_ISFCONNECTED
)Ë=SS_ISFCONNECTED)

	)

236 
	#CONN_CANFRCV
(
so
Ë(((so)->
so_°©e
 & (
SS_FCANTRCVMORE
|
SS_ISFCONNECTED
)Ë=SS_ISFCONNECTED)

	)

237 
	#UPD_NFDS
(
x
Ëi‡(
nfds
 < (x)Ënfd†(x)

	)

239 
	$¶úp_£À˘_fûl
(
Slúp
 *
¶úp
, *
≤fds
,

240 
fd_£t
 *
ªadfds
, fd_£à*
wrôefds
, fd_£à*
xfds
)

242 
sockë
 *
so
, *
so_√xt
;

243 
nfds
;

246 
globÆ_ªadfds
 = 
NULL
;

247 
globÆ_wrôefds
 = 
NULL
;

248 
globÆ_xfds
 = 
NULL
;

250 
nfds
 = *
≤fds
;

254 
do_¶owtimo
 = 0;

261 
do_¶owtimo
 |((
¶úp
->
tcb
.
so_√xt
 != &slirp->tcb) ||

262 (&
¶úp
->
ùq
.
ù_lök
 !¶úp->ùq.ù_lök.
√xt
));

264 
so
 = 
¶úp
->
tcb
.
so_√xt
; so != &slirp->tcb;

265 
so
 = 
so_√xt
) {

266 
so_√xt
 = 
so
->so_next;

271 i‡(
time_Á°timo
 =0 && 
so
->
so_t˝cb
->
t_Êags
 & 
TF_DELACK
)

272 
time_Á°timo
 = 
cuπime
;

278 i‡(
so
->
so_°©e
 & 
SS_NOFDREF
 || so->
s
 == -1)

284 i‡(
so
->
so_°©e
 & 
SS_FACCEPTCONN
) {

285 
	`FD_SET
(
so
->
s
, 
ªadfds
);

286 
	`UPD_NFDS
(
so
->
s
);

293 i‡(
so
->
so_°©e
 & 
SS_ISFCONNECTING
) {

294 
	`FD_SET
(
so
->
s
, 
wrôefds
);

295 
	`UPD_NFDS
(
so
->
s
);

303 i‡(
	`CONN_CANFSEND
(
so
Ë&& so->
so_rcv
.
sb_cc
) {

304 
	`FD_SET
(
so
->
s
, 
wrôefds
);

305 
	`UPD_NFDS
(
so
->
s
);

312 i‡(
	`CONN_CANFRCV
(
so
Ë&& (so->
so_¢d
.
sb_cc
 < (so->so_¢d.
sb_d©Æí
/2))) {

313 
	`FD_SET
(
so
->
s
, 
ªadfds
);

314 
	`FD_SET
(
so
->
s
, 
xfds
);

315 
	`UPD_NFDS
(
so
->
s
);

322 
so
 = 
¶úp
->
udb
.
so_√xt
; so != &slirp->udb;

323 
so
 = 
so_√xt
) {

324 
so_√xt
 = 
so
->so_next;

329 i‡(
so
->
so_expúe
) {

330 i‡(
so
->
so_expúe
 <
cuπime
) {

331 
	`udp_dëach
(
so
);

334 
do_¶owtimo
 = 1;

347 i‡((
so
->
so_°©e
 & 
SS_ISFCONNECTED
Ë&& so->
so_queued
 <= 4) {

348 
	`FD_SET
(
so
->
s
, 
ªadfds
);

349 
	`UPD_NFDS
(
so
->
s
);

354 *
≤fds
 = 
nfds
;

355 
	}
}

357 
	$¶úp_£À˘_pﬁl
(
Slúp
 *
¶úp
,

358 
fd_£t
 *
ªadfds
, fd_£à*
wrôefds
, fd_£à*
xfds
,

359 
£À˘_îr‹
)

361 
sockë
 *
so
, *
so_√xt
;

362 
ªt
;

364 
globÆ_ªadfds
 = 
ªadfds
;

365 
globÆ_wrôefds
 = 
wrôefds
;

366 
globÆ_xfds
 = 
xfds
;

368 
cuπime
 = 
	`os_gë_time_ms
();

374 i‡(
time_Á°timo
 && ((
cuπime
 -Åime_fasttimo) >= 2)) {

375 
	`t˝_Á°timo
(
¶úp
);

376 
time_Á°timo
 = 0;

378 i‡(
do_¶owtimo
 && ((
cuπime
 - 
œ°_¶owtimo
) >= 499)) {

379 
	`ù_¶owtimo
(
¶úp
);

380 
	`t˝_¶owtimo
(
¶úp
);

381 
œ°_¶owtimo
 = 
cuπime
;

387 i‡(!
£À˘_îr‹
) {

391 
so
 = 
¶úp
->
tcb
.
so_√xt
; so != &slirp->tcb;

392 
so
 = 
so_√xt
) {

393 
so_√xt
 = 
so
->so_next;

399 i‡(
so
->
so_°©e
 & 
SS_NOFDREF
 || so->
s
 == -1)

407 i‡(
	`FD_ISSET
(
so
->
s
, 
xfds
))

408 
	`s‹ecvoob
(
so
);

412 i‡(
	`FD_ISSET
(
so
->
s
, 
ªadfds
)) {

416 i‡(
so
->
so_°©e
 & 
SS_FACCEPTCONN
) {

417 
	`t˝_c⁄√˘
(
so
);

420 
ªt
 = 
	`s‹ód
(
so
);

423 i‡(
ªt
 > 0)

424 
	`t˝_ouçut
(
	`sŸŸ˝cb
(
so
));

430 i‡(
	`FD_ISSET
(
so
->
s
, 
wrôefds
)) {

434 i‡(
so
->
so_°©e
 & 
SS_ISFCONNECTING
) {

436 
so
->
so_°©e
 &~
SS_ISFCONNECTING
;

438 
ªt
 = 
	`£nd
(
so
->
s
, (const *) &ret, 0, 0);

439 i‡(
ªt
 < 0) {

441 i‡(
î∫o
 =
EAGAIN
 ||Éºnÿ=
EWOULDBLOCK
 ||

442 
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
ENOTCONN
)

446 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

447 
so
->
so_°©e
 |
SS_NOFDREF
;

454 
	`t˝_öput
((
mbuf
 *)
NULL
, (
ù
), 
so
);

457 
ªt
 = 
	`sowrôe
(
so
);

470 #ifde‡
PROBE_CONN


471 i‡(
so
->
so_°©e
 & 
SS_ISFCONNECTING
) {

472 
ªt
 = 
	`ªcv
(
so
->
s
, (*)&ret, 0,0);

474 i‡(
ªt
 < 0) {

476 i‡(
î∫o
 =
EAGAIN
 ||Éºnÿ=
EWOULDBLOCK
 ||

477 
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
ENOTCONN
)

481 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

482 
so
->
so_°©e
 |
SS_NOFDREF
;

486 
ªt
 = 
	`£nd
(
so
->
s
, &ret, 0,0);

487 i‡(
ªt
 < 0) {

489 i‡(
î∫o
 =
EAGAIN
 ||Éºnÿ=
EWOULDBLOCK
 ||

490 
î∫o
 =
EINPROGRESS
 ||Éºnÿ=
ENOTCONN
)

493 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

494 
so
->
so_°©e
 |
SS_NOFDREF
;

496 
so
->
so_°©e
 &~
SS_ISFCONNECTING
;

499 
	`t˝_öput
((
mbuf
 *)
NULL
, (
ù
),
so
);

509 
so
 = 
¶úp
->
udb
.
so_√xt
; so != &slirp->udb;

510 
so
 = 
so_√xt
) {

511 
so_√xt
 = 
so
->so_next;

513 i‡(
so
->
s
 !-1 && 
	`FD_ISSET
(so->s, 
ªadfds
)) {

514 
	`s‹ecv‰om
(
so
);

522 i‡(
¶úp
->
if_queued
) {

523 
	`if_°¨t
(
¶úp
);

532 
globÆ_ªadfds
 = 
NULL
;

533 
globÆ_wrôefds
 = 
NULL
;

534 
globÆ_xfds
 = 
NULL
;

535 
	}
}

537 
	#ETH_ALEN
 6

	)

538 
	#ETH_HLEN
 14

	)

540 
	#ETH_P_IP
 0x0800

	)

541 
	#ETH_P_ARP
 0x0806

	)

543 
	#ARPOP_REQUEST
 1

	)

544 
	#ARPOP_REPLY
 2

	)

546 
	sëhhdr


548 
	mh_de°
[
ETH_ALEN
];

549 
	mh_sour˚
[
ETH_ALEN
];

550 
	mh_¥Ÿo
;

553 
	s¨phdr


555 
	m¨_hrd
;

556 
	m¨_¥o
;

557 
	m¨_h 
;

558 
	m¨_∂n
;

559 
	m¨_›
;

564 
	m¨_sha
[
ETH_ALEN
];

565 
uöt32_t
 
	m¨_sù
;

566 
	m¨_tha
[
ETH_ALEN
];

567 
uöt32_t
 
	m¨_tù
 ;

568 } 
__©åibuã__
((
∑cked
));

570 
	$¨p_öput
(
Slúp
 *
¶úp
, c⁄° 
uöt8_t
 *
pkt
, 
pkt_Àn
)

572 
ëhhdr
 *
eh
 = (ëhhd∏*)
pkt
;

573 
¨phdr
 *
ah
 = (¨phd∏*)(
pkt
 + 
ETH_HLEN
);

574 
uöt8_t
 
¨p_ª∂y
[
	`max
(
ETH_HLEN
 + (
¨phdr
), 64)];

575 
ëhhdr
 *
ªh
 = (ëhhd∏*)
¨p_ª∂y
;

576 
¨phdr
 *
øh
 = (¨phd∏*)(
¨p_ª∂y
 + 
ETH_HLEN
);

577 
¨_›
;

578 
ex_li°
 *
ex_±r
;

580 
¨_›
 = 
	`¡ohs
(
ah
->ar_op);

581 
¨_›
) {

582 
ARPOP_REQUEST
:

583 i‡((
ah
->
¨_tù
 & 
¶úp
->
v√tw‹k_mask
.
s_addr
) ==

584 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

585 i‡(
ah
->
¨_tù
 =
¶úp
->
v«me£rvî_addr
.
s_addr
 ||

586 
ah
->
¨_tù
 =
¶úp
->
vho°_addr
.
s_addr
)

587 
¨p_ok
;

588 
ex_±r
 = 
¶úp
->
exec_li°
;Éx_±r;Éx_±∏ex_±r->
ex_√xt
) {

589 i‡(
ex_±r
->
ex_addr
.
s_addr
 =
ah
->
¨_tù
)

590 
¨p_ok
;

593 
¨p_ok
:

594 
	`mem£t
(
¨p_ª∂y
, 0, (arp_reply));

596 
	`mem˝y
(
¶úp
->
˛õ¡_ëhaddr
, 
eh
->
h_sour˚
, 
ETH_ALEN
);

599 
	`mem˝y
(
ªh
->
h_de°
, 
pkt
 + 
ETH_ALEN
, ETH_ALEN);

600 
	`mem˝y
(
ªh
->
h_sour˚
, 
•ecül_ëhaddr
, 
ETH_ALEN
 - 4);

601 
	`mem˝y
(&
ªh
->
h_sour˚
[2], &
ah
->
¨_tù
, 4);

602 
ªh
->
h_¥Ÿo
 = 
	`ht⁄s
(
ETH_P_ARP
);

604 
øh
->
¨_hrd
 = 
	`ht⁄s
(1);

605 
øh
->
¨_¥o
 = 
	`ht⁄s
(
ETH_P_IP
);

606 
øh
->
¨_h 
 = 
ETH_ALEN
;

607 
øh
->
¨_∂n
 = 4;

608 
øh
->
¨_›
 = 
	`ht⁄s
(
ARPOP_REPLY
);

609 
	`mem˝y
(
øh
->
¨_sha
, 
ªh
->
h_sour˚
, 
ETH_ALEN
);

610 
øh
->
¨_sù
 = 
ah
->
¨_tù
;

611 
	`mem˝y
(
øh
->
¨_tha
, 
ah
->
¨_sha
, 
ETH_ALEN
);

612 
øh
->
¨_tù
 = 
ah
->
¨_sù
;

613 
	`¶úp_ouçut
(
¶úp
->
›aque
, 
¨p_ª∂y
, (arp_reply));

616 
ARPOP_REPLY
:

618 i‡(!
	`memcmp
(
¶úp
->
˛õ¡_ëhaddr
, 
zîo_ëhaddr
, 
ETH_ALEN
) &&

619 
ah
->
¨_sù
 =
¶úp
->
˛õ¡_ùaddr
.
s_addr
) {

620 
	`mem˝y
(
¶úp
->
˛õ¡_ëhaddr
, 
ah
->
¨_sha
, 
ETH_ALEN
);

626 
	}
}

628 
	$¶úp_öput
(
Slúp
 *
¶úp
, c⁄° 
uöt8_t
 *
pkt
, 
pkt_Àn
)

630 
mbuf
 *
m
;

631 
¥Ÿo
;

633 i‡(
pkt_Àn
 < 
ETH_HLEN
)

636 
¥Ÿo
 = 
	`¡ohs
(*(
uöt16_t
 *)(
pkt
 + 12));

637 
¥Ÿo
) {

638 
ETH_P_ARP
:

639 
	`¨p_öput
(
¶úp
, 
pkt
, 
pkt_Àn
);

641 
ETH_P_IP
:

642 
m
 = 
	`m_gë
(
¶úp
);

643 i‡(!
m
)

646 i‡(
	`M_FREEROOM
(
m
Ë< 
pkt_Àn
 + 2) {

647 
	`m_öc
(
m
, 
pkt_Àn
 + 2);

649 
m
->
m_Àn
 = 
pkt_Àn
 + 2;

650 
	`mem˝y
(
m
->
m_d©a
 + 2, 
pkt
, 
pkt_Àn
);

652 
m
->
m_d©a
 +2 + 
ETH_HLEN
;

653 
m
->
m_Àn
 -2 + 
ETH_HLEN
;

655 
	`ù_öput
(
m
);

660 
	}
}

663 
	$if_íˇp
(
Slúp
 *
¶úp
, c⁄° 
uöt8_t
 *
ù_d©a
, 
ù_d©a_Àn
)

665 
uöt8_t
 
buf
[1600];

666 
ëhhdr
 *
eh
 = (ëhhd∏*)
buf
;

668 i‡(
ù_d©a_Àn
 + 
ETH_HLEN
 > (
buf
))

671 i‡(!
	`memcmp
(
¶úp
->
˛õ¡_ëhaddr
, 
zîo_ëhaddr
, 
ETH_ALEN
)) {

672 
uöt8_t
 
¨p_ªq
[
ETH_HLEN
 + (
¨phdr
)];

673 
ëhhdr
 *
ªh
 = (ëhhd∏*)
¨p_ªq
;

674 
¨phdr
 *
øh
 = (¨phd∏*)(
¨p_ªq
 + 
ETH_HLEN
);

675 c⁄° 
ù
 *
ùh
 = (c⁄° ù *)
ù_d©a
;

682 
	`mem£t
(
ªh
->
h_de°
, 0xff, 
ETH_ALEN
);

683 
	`mem˝y
(
ªh
->
h_sour˚
, 
•ecül_ëhaddr
, 
ETH_ALEN
 - 4);

684 
	`mem˝y
(&
ªh
->
h_sour˚
[2], &
¶úp
->
vho°_addr
, 4);

685 
ªh
->
h_¥Ÿo
 = 
	`ht⁄s
(
ETH_P_ARP
);

686 
øh
->
¨_hrd
 = 
	`ht⁄s
(1);

687 
øh
->
¨_¥o
 = 
	`ht⁄s
(
ETH_P_IP
);

688 
øh
->
¨_h 
 = 
ETH_ALEN
;

689 
øh
->
¨_∂n
 = 4;

690 
øh
->
¨_›
 = 
	`ht⁄s
(
ARPOP_REQUEST
);

692 
	`mem˝y
(
øh
->
¨_sha
, 
•ecül_ëhaddr
, 
ETH_ALEN
 - 4);

693 
	`mem˝y
(&
øh
->
¨_sha
[2], &
¶úp
->
vho°_addr
, 4);

695 
øh
->
¨_sù
 = 
¶úp
->
vho°_addr
.
s_addr
;

697 
	`mem£t
(
øh
->
¨_tha
, 0, 
ETH_ALEN
);

699 
øh
->
¨_tù
 = 
ùh
->
ù_d°
.
s_addr
;

700 
¶úp
->
˛õ¡_ùaddr
 = 
ùh
->
ù_d°
;

701 
	`¶úp_ouçut
(
¶úp
->
›aque
, 
¨p_ªq
, (arp_req));

703 
	`mem˝y
(
eh
->
h_de°
, 
¶úp
->
˛õ¡_ëhaddr
, 
ETH_ALEN
);

704 
	`mem˝y
(
eh
->
h_sour˚
, 
•ecül_ëhaddr
, 
ETH_ALEN
 - 4);

706 
	`mem˝y
(&
eh
->
h_sour˚
[2], &
¶úp
->
vho°_addr
, 4);

707 
eh
->
h_¥Ÿo
 = 
	`ht⁄s
(
ETH_P_IP
);

708 
	`mem˝y
(
buf
 + (
ëhhdr
), 
ù_d©a
, 
ù_d©a_Àn
);

709 
	`¶úp_ouçut
(
¶úp
->
›aque
, 
buf
, 
ù_d©a_Àn
 + 
ETH_HLEN
);

711 
	}
}

714 
	$¶úp_ªmove_ho°fwd
(
Slúp
 *
¶úp
, 
is_udp
, 
ö_addr
 
ho°_addr
,

715 
ho°_p‹t
)

717 
sockë
 *
so
;

718 
sockë
 *
hód
 = (
is_udp
 ? &
¶úp
->
udb
 : &¶úp->
tcb
);

719 
sockaddr_ö
 
addr
;

720 
p‹t
 = 
	`ht⁄s
(
ho°_p‹t
);

721 
sockÀn_t
 
addr_Àn
;

723 
so
 = 
hód
->
so_√xt
; so != head; so = so->so_next) {

724 
addr_Àn
 = (
addr
);

725 i‡((
so
->
so_°©e
 & 
SS_HOSTFWD
) &&

726 
	`gësock«me
(
so
->
s
, (
sockaddr
 *)&
addr
, &
addr_Àn
) == 0 &&

727 
addr
.
sö_addr
.
s_addr
 =
ho°_addr
.s_addr &&

728 
addr
.
sö_p‹t
 =
p‹t
) {

729 
	`˛o£
(
so
->
s
);

730 
	`so‰ì
(
so
);

736 
	}
}

738 
	$¶úp_add_ho°fwd
(
Slúp
 *
¶úp
, 
is_udp
, 
ö_addr
 
ho°_addr
,

739 
ho°_p‹t
, 
ö_addr
 
gue°_addr
, 
gue°_p‹t
)

741 i‡(!
gue°_addr
.
s_addr
) {

742 
gue°_addr
 = 
¶úp
->
vdh˝_°¨èddr
;

744 i‡(
is_udp
) {

745 i‡(!
	`udp_li°í
(
¶úp
, 
ho°_addr
.
s_addr
, 
	`ht⁄s
(
ho°_p‹t
),

746 
gue°_addr
.
s_addr
, 
	`ht⁄s
(
gue°_p‹t
), 
SS_HOSTFWD
))

749 i‡(!
	`t˝_li°í
(
¶úp
, 
ho°_addr
.
s_addr
, 
	`ht⁄s
(
ho°_p‹t
),

750 
gue°_addr
.
s_addr
, 
	`ht⁄s
(
gue°_p‹t
), 
SS_HOSTFWD
))

754 
	}
}

756 
	$¶úp_add_exec
(
Slúp
 *
¶úp
, 
do_±y
, c⁄° *
¨gs
,

757 
ö_addr
 *
gue°_addr
, 
gue°_p‹t
)

759 i‡(!
gue°_addr
->
s_addr
) {

760 
gue°_addr
->
s_addr
 = 
¶úp
->
v√tw‹k_addr
.s_addr |

761 (
	`ht⁄l
(0x0204Ë& ~
¶úp
->
v√tw‹k_mask
.
s_addr
);

763 i‡((
gue°_addr
->
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) !=

764 
¶úp
->
v√tw‹k_addr
.
s_addr
 ||

765 
gue°_addr
->
s_addr
 =
¶úp
->
vho°_addr
.s_addr ||

766 
gue°_addr
->
s_addr
 =
¶úp
->
v«me£rvî_addr
.s_addr) {

769  
	`add_exec
(&
¶úp
->
exec_li°
, 
do_±y
, (*)
¨gs
, *
gue°_addr
,

770 
	`ht⁄s
(
gue°_p‹t
));

771 
	}
}

773 
ssize_t
 
	$¶úp_£nd
(
sockë
 *
so
, c⁄° *
buf
, 
size_t
 
Àn
, 
Êags
)

776 i‡(
so
->
s
 =-1 && so->
exåa
) {

777 
	`qemu_chr_wrôe
(
so
->
exåa
, 
buf
, 
Àn
);

778  
Àn
;

781  
	`£nd
(
so
->
s
, 
buf
, 
Àn
, 
Êags
);

782 
	}
}

784 
sockë
 *

785 
	$¶úp_föd_˘l_sockë
(
Slúp
 *
¶úp
, 
ö_addr
 
gue°_addr
, 
gue°_p‹t
)

787 
sockë
 *
so
;

789 
so
 = 
¶úp
->
tcb
.
so_√xt
; so != &slirp->tcb; so = so->so_next) {

790 i‡(
so
->
so_Áddr
.
s_addr
 =
gue°_addr
.s_addr &&

791 
	`ht⁄s
(
so
->
so_Â‹t
Ë=
gue°_p‹t
) {

792  
so
;

795  
NULL
;

796 
	}
}

798 
size_t
 
	$¶úp_sockë_ˇn_ªcv
(
Slúp
 *
¶úp
, 
ö_addr
 
gue°_addr
,

799 
gue°_p‹t
)

801 
iovec
 
iov
[2];

802 
sockë
 *
so
;

804 
so
 = 
	`¶úp_föd_˘l_sockë
(
¶úp
, 
gue°_addr
, 
gue°_p‹t
);

806 i‡(!
so
 || so->
so_°©e
 & 
SS_NOFDREF
)

809 i‡(!
	`CONN_CANFRCV
(
so
Ë|| so->
so_¢d
.
sb_cc
 >(so->so_¢d.
sb_d©Æí
/2))

812  
	`s›ª¥buf
(
so
, 
iov
, 
NULL
);

813 
	}
}

815 
	$¶úp_sockë_ªcv
(
Slúp
 *
¶úp
, 
ö_addr
 
gue°_addr
, 
gue°_p‹t
,

816 c⁄° 
uöt8_t
 *
buf
, 
size
)

818 
ªt
;

819 
sockë
 *
so
 = 
	`¶úp_föd_˘l_sockë
(
¶úp
, 
gue°_addr
, 
gue°_p‹t
);

821 i‡(!
so
)

824 
ªt
 = 
	`s‹ódbuf
(
so
, (c⁄° *)
buf
, 
size
);

826 i‡(
ªt
 > 0)

827 
	`t˝_ouçut
(
	`sŸŸ˝cb
(
so
));

828 
	}
}

	@slirp/slirp.h

1 #i‚de‡
__COMMON_H__


2 
	#__COMMON_H__


	)

4 
	~<°dlib.h
>

5 
	~"../cutûs.h
"

6 
	~"¶úp_c⁄fig.h
"

8 #ifde‡
_WIN32


9 
	~<öây≥s.h
>

11 *
	tˇddr_t
;

13 
	~<wödows.h
>

14 
	~<wösock2.h
>

15 
	~<ws2t˝ù.h
>

16 
	~<sys/timeb.h
>

17 
	~<ùhÕ≠i.h
>

19 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

20 
	#EINPROGRESS
 
WSAEINPROGRESS


	)

21 
	#ENOTCONN
 
WSAENOTCONN


	)

22 
	#EHOSTUNREACH
 
WSAEHOSTUNREACH


	)

23 
	#ENETUNREACH
 
WSAENETUNREACH


	)

24 
	#ECONNREFUSED
 
WSAECONNREFUSED


	)

26 
	#io˘lsockë
 
io˘l


	)

27 
	#˛o£sockë
(
s
Ë
	`˛o£
(s)

	)

28 #i‡!
deföed
(
__HAIKU__
)

29 
	#O_BINARY
 0

	)

33 
	~<sys/ty≥s.h
>

34 #ifde‡
HAVE_SYS_BITYPES_H


35 
	~<sys/bôy≥s.h
>

38 
	~<sys/time.h
>

40 #ifde‡
HAVE_UNISTD_H


41 
	~<uni°d.h
>

44 #ifde‡
HAVE_STDLIB_H


45 
	~<°dlib.h
>

48 
	~<°dio.h
>

49 
	~<î∫o.h
>

51 #i‚de‡
HAVE_MEMMOVE


52 
	#memmove
(
x
, 
y
, 
z
Ë
	`bc›y
(y, x, z)

	)

55 #i‡
TIME_WITH_SYS_TIME


56 
	~<sys/time.h
>

57 
	~<time.h
>

59 #ifde‡
HAVE_SYS_TIME_H


60 
	~<sys/time.h
>

62 
	~<time.h
>

66 #ifde‡
HAVE_STRING_H


67 
	~<°rög.h
>

69 
	~<°rögs.h
>

72 #i‚de‡
_WIN32


73 
	~<sys/uio.h
>

76 #i‚de‡
_WIN32


77 
	~<√töë/ö.h
>

78 
	~<¨∑/öë.h
>

82 #i‡
deföed
(
u…rix
)

83 *
°rdup
(const *);

87 #i‡
deföed
(
u…rix
Ë|| deföed(
hcx
)

88 *
mÆloc
(
size_t
 
¨g
);

89 
‰ì
(*
±r
);

92 #i‚de‡
HAVE_INET_ATON


93 
öë_©⁄
(c⁄° *
˝
, 
ö_addr
 *
ü
);

96 
	~<f˙é.h
>

97 #i‚de‡
NO_UNIX_SOCKETS


98 
	~<sys/un.h
>

100 
	~<sig«l.h
>

101 #ifde‡
HAVE_SYS_SIGNAL_H


102 
	~<sys/sig«l.h
>

104 #i‚de‡
_WIN32


105 
	~<sys/sockë.h
>

108 #i‡
deföed
(
HAVE_SYS_IOCTL_H
)

109 
	~<sys/io˘l.h
>

112 #ifde‡
HAVE_SYS_SELECT_H


113 
	~<sys/£À˘.h
>

116 #ifde‡
HAVE_SYS_WAIT_H


117 
	~<sys/waô.h
>

120 #ifde‡
HAVE_SYS_FILIO_H


121 
	~<sys/fûio.h
>

124 #ifde‡
USE_PPP


125 
	~<µp/¶úµp.h
>

128 #ifde‡
__STDC__


129 
	~<°d¨g.h
>

131 
	~<v¨¨gs.h
>

134 
	~<sys/°©.h
>

138 
	#ösque
 
¶úp_ösque


	)

139 
	#ªmque
 
¶úp_ªmque


	)

141 #ifde‡
HAVE_SYS_STROPTS_H


142 
	~<sys/°r›ts.h
>

145 
	~"debug.h
"

147 
	~"lib¶úp.h
"

148 
	~"ù.h
"

149 
	~"t˝.h
"

150 
	~"t˝_timî.h
"

151 
	~"t˝_v¨.h
"

152 
	~"t˝ù.h
"

153 
	~"udp.h
"

154 
	~"mbuf.h
"

155 
	~"sbuf.h
"

156 
	~"sockë.h
"

157 
	~"if.h
"

158 
	~"maö.h
"

159 
	~"misc.h
"

160 #ifde‡
USE_PPP


161 
	~"µp/µpd.h
"

162 
	~"µp/µp.h
"

165 
	~"boŸp.h
"

166 
	~"t·p.h
"

168 
	sSlúp
 {

170 
ö_addr
 
	mv√tw‹k_addr
;

171 
ö_addr
 
	mv√tw‹k_mask
;

172 
ö_addr
 
	mvho°_addr
;

173 
ö_addr
 
	mvdh˝_°¨èddr
;

174 
ö_addr
 
	mv«me£rvî_addr
;

177 
uöt8_t
 
	m˛õ¡_ëhaddr
[6];

179 
ö_addr
 
	m˛õ¡_ùaddr
;

180 
	m˛õ¡_ho°«me
[33];

182 
	mª°ri˘ed
;

183 
timevÆ
 
	mâ
;

184 
ex_li°
 *
	mexec_li°
;

187 
mbuf
 
	mm_‰ìli°
, 
	mm_u£dli°
;

188 
	mmbuf_Ælo˚d
;

191 
	mif_queued
;

192 
mbuf
 
	mif_Á°q
;

193 
mbuf
 
	mif_b©chq
;

194 
mbuf
 *
	m√xt_m
;

197 
ùq
 
	mùq
;

198 
uöt16_t
 
	mù_id
;

201 
BOOTPClõ¡
 
	mboŸp_˛õ¡s
[
NB_BOOTP_CLIENTS
];

202 *
	mboŸp_fûíame
;

205 
sockë
 
	mtcb
;

206 
sockë
 *
	mt˝_œ°_so
;

207 
t˝_£q
 
	mt˝_iss
;

208 
uöt32_t
 
	mt˝_now
;

211 
sockë
 
	mudb
;

212 
sockë
 *
	mudp_œ°_so
;

215 *
	mt·p_¥efix
;

216 
t·p_£ssi⁄
 
	mt·p_£ssi⁄s
[
TFTP_SESSIONS_MAX
];

218 *
	m›aque
;

221 
Slúp
 *
¶úp_ö°™˚
;

223 #i‚de‡
NULL


224 
	#NULL
 (*)0

	)

227 #i‚de‡
FULL_BOLT


228 
if_°¨t
(
Slúp
 *);

230 
if_°¨t
(
âys
 *);

233 #i‚de‡
HAVE_STRERROR


234 *
°ªº‹
(
îr‹
);

237 #i‚de‡
HAVE_INDEX


238 *
ödex
(const *, );

241 #i‚de‡
HAVE_GETHOSTID


242 
gëho°id
();

245 
	$Õröt
(c⁄° *, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 1, 2)));

247 #i‚de‡
_WIN32


248 
	~<√tdb.h
>

251 
	#DEFAULT_BAUD
 115200

	)

253 
	#SO_OPTIONS
 
DO_KEEPALIVE


	)

254 
	#TCP_MAXIDLE
 (
TCPTV_KEEPCNT
 * 
TCPTV_KEEPINTVL
)

	)

257 
	`cksum
(
mbuf
 *
m
, 
Àn
);

260 
	`if_öô
(
Slúp
 *);

261 
	`if_ouçut
(
sockë
 *, 
mbuf
 *);

264 
	`ù_öô
(
Slúp
 *);

265 
	`ù_öput
(
mbuf
 *);

266 
	`ù_¶owtimo
(
Slúp
 *);

267 
	`ù_°rù›ti⁄s
(
mbuf
 *, mbuf *);

270 
	`ù_ouçut
(
sockë
 *, 
mbuf
 *);

273 
	`t˝_öput
(
mbuf
 *, , 
sockë
 *);

274 
	`t˝_mss
(
t˝cb
 *, 
u_öt
);

277 
	`t˝_ouçut
(
t˝cb
 *);

278 
	`t˝_£çîsi°
(
t˝cb
 *);

281 
	`t˝_öô
(
Slúp
 *);

282 
	`t˝_ãm∂©e
(
t˝cb
 *);

283 
	`t˝_ª•⁄d
(
t˝cb
 *, 
t˝ùhdr
 *, 
mbuf
 *, 
t˝_£q
,Åcp_seq, );

284 
t˝cb
 * 
	`t˝_√wt˝cb
(
sockë
 *);

285 
t˝cb
 * 
	`t˝_˛o£
(tcpcb *);

286 
	`t˝_sock˛o£d
(
t˝cb
 *);

287 
	`t˝_fc⁄√˘
(
sockë
 *);

288 
	`t˝_c⁄√˘
(
sockë
 *);

289 
	`t˝_©èch
(
sockë
 *);

290 
uöt8_t
 
	`t˝_tos
(
sockë
 *);

291 
	`t˝_emu
(
sockë
 *, 
mbuf
 *);

292 
	`t˝_˘l
(
sockë
 *);

293 
t˝cb
 *
	`t˝_dr›
(t˝cb *
ç
, 
îr
);

295 #ifde‡
USE_PPP


296 
	#MIN_MRU
 
MINMRU


	)

297 
	#MAX_MRU
 
MAXMRU


	)

299 
	#MIN_MRU
 128

	)

300 
	#MAX_MRU
 16384

	)

303 #i‚de‡
_WIN32


304 
	#mö
(
x
,
y
Ë((xË< (yË? (xË: (y))

	)

305 
	#max
(
x
,
y
Ë((xË> (yË? (xË: (y))

	)

308 #ifde‡
_WIN32


309 #unde‡
î∫o


310 
	#î∫o
 (
	`WSAGëLa°Eº‹
())

	)

	@slirp/slirp_config.h

7 #unde‡
PROBE_CONN


10 
	#DO_KEEPALIVE
 0

	)

15 
	#MAX_INTERFACES
 1

	)

16 
	#MAX_PPP_INTERFACES
 1

	)

20 #unde‡
USE_TMPSOCKET


23 #unde‡
DO_CFSETSPEED


30 #unde‡
FULL_BOLT


38 #unde‡
USE_LOWCPU


41 #i‚de‡
__STDC__


42 
	#NO_PROTOTYPES


	)

52 #unde‡
DUMMY_PPP


55 
	#HAVE_UNISTD_H


	)

58 
	#HAVE_STDLIB_H


	)

61 #unde‡
HAVE_SYS_IOCTL_H


62 #i‚de‡
_WIN32


63 
	#HAVE_SYS_IOCTL_H


	)

67 #unde‡
HAVE_SYS_FILIO_H


68 #ifde‡
__APPLE__


69 
	#HAVE_SYS_FILIO_H


	)

73 
	#HAVE_STRERROR


	)

76 
	#HAVE_STRDUP


	)

79 
	#TIME_WITH_SYS_TIME
 0

	)

80 #unde‡
HAVE_SYS_TIME_H


83 #unde‡
HAVE_SYS_BITYPES_H


89 #unde‡
HAVE_READV


92 #unde‡
DECLARE_IOVEC


93 #ifde‡
_WIN32


94 
	#DECLARE_IOVEC


	)

98 #unde‡
HAVE_SYS_WAIT_H


101 #unde‡
HAVE_SYS_SELECT_H


102 #i‚de‡
_WIN32


103 
	#HAVE_SYS_SELECT_H


	)

107 
	#HAVE_STRING_H


	)

110 #unde‡
HAVE_ARPA_INET_H


111 #i‚de‡
_WIN32


112 
	#HAVE_ARPA_INET_H


	)

116 #unde‡
HAVE_SYS_SIGNAL_H


119 #unde‡
HAVE_SYS_STROPTS_H


128 #unde‡
NO_PROTOTYPES


131 
	#SIZEOF_CHAR
 1

	)

134 
	#SIZEOF_SHORT
 2

	)

137 
	#SIZEOF_INT
 4

	)

140 
	#SIZEOF_CHAR_P
 (
HOST_LONG_BITS
 / 8)

	)

143 #unde‡
HAVE_RANDOM


146 #unde‡
HAVE_SRANDOM


149 #unde‡
HAVE_INET_ATON


150 #i‚de‡
_WIN32


151 
	#HAVE_INET_ATON


	)

155 #unde‡
HAVE_SETENV


158 
	#HAVE_INDEX


	)

161 #unde‡
HAVE_BCMP


164 #unde‡
HAVE_DRAND48


167 
	#HAVE_MEMMOVE


	)

170 
	#HAVE_GETHOSTID


	)

173 #unde‡
NO_UNIX_SOCKETS


174 #ifde‡
_WIN32


175 
	#NO_UNIX_SOCKETS


	)

179 #unde‡
HAVE_REVOKE


182 #unde‡
HAVE_GRANTPT


185 #unde‡
HAVE_FCHMOD


188 #unde‡
HAVE_SYS_TYPES32_H


	@slirp/socket.c

8 
	~"¶úp.h
"

9 
	~"ù_icmp.h
"

11 
sofˇ¡rcvm‹e
(
sockë
 *
so
);

12 
sofˇ¡£ndm‹e
(
sockë
 *
so
);

14 
sockë
 *

15 
	$sﬁookup
(
sockë
 *
hód
, 
ö_addr
 
œddr
, 
u_öt
 
Õ‹t
,

16 
ö_addr
 
Áddr
, 
u_öt
 
Â‹t
)

18 
sockë
 *
so
;

20 
so
 = 
hód
->
so_√xt
; so != head; so = so->so_next) {

21 i‡(
so
->
so_Õ‹t
 =
Õ‹t
 &&

22 
so
->
so_œddr
.
s_addr
 =
œddr
.s_addr &&

23 
so
->
so_Áddr
.
s_addr
 =
Áddr
.s_addr &&

24 
so
->
so_Â‹t
 =
Â‹t
)

28 i‡(
so
 =
hód
)

29  (
sockë
 *)
NULL
;

30  
so
;

32 
	}
}

39 
sockë
 *

40 
	$so¸óã
(
Slúp
 *
¶úp
)

42 
sockë
 *
so
;

44 
so
 = (
sockë
 *)
	`mÆloc
((socket));

45 if(
so
) {

46 
	`mem£t
(
so
, 0, (
sockë
));

47 
so
->
so_°©e
 = 
SS_NOFDREF
;

48 
so
->
s
 = -1;

49 
so
->
¶úp
 = slirp;

51 (
so
);

52 
	}
}

58 
	$so‰ì
(
sockë
 *
so
)

60 
Slúp
 *
¶úp
 = 
so
->slirp;

62 i‡(
so
->
so_emu
==
EMU_RSH
 && so->
exåa
) {

63 
	`so‰ì
(
so
->
exåa
);

64 
so
->
exåa
=
NULL
;

66 i‡(
so
 =
¶úp
->
t˝_œ°_so
) {

67 
¶úp
->
t˝_œ°_so
 = &¶úp->
tcb
;

68 } i‡(
so
 =
¶úp
->
udp_œ°_so
) {

69 
¶úp
->
udp_œ°_so
 = &¶úp->
udb
;

71 
	`m_‰ì
(
so
->
so_m
);

73 if(
so
->
so_√xt
 && so->
so_¥ev
)

74 
	`ªmque
(
so
);

76 
	`‰ì
(
so
);

77 
	}
}

79 
size_t
 
	$s›ª¥buf
(
sockë
 *
so
, 
iovec
 *
iov
, *
≈
)

81 
n
, 
lss
, 
tŸÆ
;

82 
sbuf
 *
sb
 = &
so
->
so_¢d
;

83 
Àn
 = 
sb
->
sb_d©Æí
 - sb->
sb_cc
;

84 
mss
 = 
so
->
so_t˝cb
->
t_max£g
;

86 
	`DEBUG_CALL
("sopreprbuf");

87 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

89 i‡(
Àn
 <= 0)

92 
iov
[0].
iov_ba£
 = 
sb
->
sb_w±r
;

93 
iov
[1].
iov_ba£
 = 
NULL
;

94 
iov
[1].
iov_Àn
 = 0;

95 i‡(
sb
->
sb_w±r
 < sb->
sb_Ωå
) {

96 
iov
[0].
iov_Àn
 = 
sb
->
sb_Ωå
 - sb->
sb_w±r
;

98 i‡(
iov
[0].
iov_Àn
 > 
Àn
)

99 
iov
[0].
iov_Àn
 = 
Àn
;

100 i‡(
iov
[0].
iov_Àn
 > 
mss
)

101 
iov
[0].
iov_Àn
 -iov[0].iov_Àn%
mss
;

102 
n
 = 1;

104 
iov
[0].
iov_Àn
 = (
sb
->
sb_d©a
 + sb->
sb_d©Æí
Ë- sb->
sb_w±r
;

106 i‡(
iov
[0].
iov_Àn
 > 
Àn
) iov[0].iov_len =Üen;

107 
Àn
 -
iov
[0].
iov_Àn
;

108 i‡(
Àn
) {

109 
iov
[1].
iov_ba£
 = 
sb
->
sb_d©a
;

110 
iov
[1].
iov_Àn
 = 
sb
->
sb_Ωå
 - sb->
sb_d©a
;

111 if(
iov
[1].
iov_Àn
 > 
Àn
)

112 
iov
[1].
iov_Àn
 = 
Àn
;

113 
tŸÆ
 = 
iov
[0].
iov_Àn
 + iov[1].iov_len;

114 i‡(
tŸÆ
 > 
mss
) {

115 
lss
 = 
tŸÆ
%
mss
;

116 i‡(
iov
[1].
iov_Àn
 > 
lss
) {

117 
iov
[1].
iov_Àn
 -
lss
;

118 
n
 = 2;

120 
lss
 -
iov
[1].
iov_Àn
;

121 
iov
[0].
iov_Àn
 -
lss
;

122 
n
 = 1;

125 
n
 = 2;

127 i‡(
iov
[0].
iov_Àn
 > 
mss
)

128 
iov
[0].
iov_Àn
 -iov[0].iov_Àn%
mss
;

129 
n
 = 1;

132 i‡(
≈
)

133 *
≈
 = 
n
;

135  
iov
[0].
iov_Àn
 + (
n
 - 1) * iov[1].iov_len;

136 
	}
}

144 
	$s‹ód
(
sockë
 *
so
)

146 
n
, 
¬
;

147 
sbuf
 *
sb
 = &
so
->
so_¢d
;

148 
iovec
 
iov
[2];

150 
	`DEBUG_CALL
("soread");

151 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

157 
	`s›ª¥buf
(
so
, 
iov
, &
n
);

159 #ifde‡
HAVE_READV


160 
¬
 = 
	`ªadv
(
so
->
s
, (
iovec
 *)
iov
, 
n
);

161 
	`DEBUG_MISC
((
dfd
, " ...ÑódÇ¿%d byãs\n", 
¬
));

163 
¬
 = 
	`ªcv
(
so
->
s
, 
iov
[0].
iov_ba£
, iov[0].
iov_Àn
,0);

165 i‡(
¬
 <= 0) {

166 i‡(
¬
 < 0 && (
î∫o
 =
EINTR
 ||Éºnÿ=
EAGAIN
))

169 
	`DEBUG_MISC
((
dfd
, " --- s‹ód(Ëdisc⁄√˘ed,Ç¿%d,Éºnÿ%d-%s\n", 
¬
, 
î∫o
,
	`°ªº‹
(errno)));

170 
	`sofˇ¡rcvm‹e
(
so
);

171 
	`t˝_sock˛o£d
(
	`sŸŸ˝cb
(
so
));

176 #i‚de‡
HAVE_READV


186 i‡(
n
 =2 && 
¬
 =
iov
[0].
iov_Àn
) {

187 
ªt
;

188 
ªt
 = 
	`ªcv
(
so
->
s
, 
iov
[1].
iov_ba£
, iov[1].
iov_Àn
,0);

189 i‡(
ªt
 > 0)

190 
¬
 +
ªt
;

193 
	`DEBUG_MISC
((
dfd
, " ...ÑódÇ¿%d byãs\n", 
¬
));

197 
sb
->
sb_cc
 +
¬
;

198 
sb
->
sb_w±r
 +
¬
;

199 i‡(
sb
->
sb_w±r
 >(sb->
sb_d©a
 + sb->
sb_d©Æí
))

200 
sb
->
sb_w±r
 -sb->
sb_d©Æí
;

201  
¬
;

202 
	}
}

204 
	$s‹ódbuf
(
sockë
 *
so
, c⁄° *
buf
, 
size
)

206 
n
, 
¬
, 
c›y
 = 
size
;

207 
sbuf
 *
sb
 = &
so
->
so_¢d
;

208 
iovec
 
iov
[2];

210 
	`DEBUG_CALL
("soreadbuf");

211 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

217 i‡(
	`s›ª¥buf
(
so
, 
iov
, &
n
Ë< 
size
)

218 
îr
;

220 
¬
 = 
	`mö
(
iov
[0].
iov_Àn
, 
c›y
);

221 
	`mem˝y
(
iov
[0].
iov_ba£
, 
buf
, 
¬
);

223 
c›y
 -
¬
;

224 
buf
 +
¬
;

226 i‡(
c›y
 == 0)

227 
d⁄e
;

229 
	`mem˝y
(
iov
[1].
iov_ba£
, 
buf
, 
c›y
);

231 
d⁄e
:

233 
sb
->
sb_cc
 +
size
;

234 
sb
->
sb_w±r
 +
size
;

235 i‡(
sb
->
sb_w±r
 >(sb->
sb_d©a
 + sb->
sb_d©Æí
))

236 
sb
->
sb_w±r
 -sb->
sb_d©Æí
;

237  
size
;

238 
îr
:

240 
	`sofˇ¡rcvm‹e
(
so
);

241 
	`t˝_sock˛o£d
(
	`sŸŸ˝cb
(
so
));

242 
	`Ârötf
(
°dîr
, "soreadbuf bufferÅo small");

244 
	}
}

254 
	$s‹ecvoob
(
sockë
 *
so
)

256 
t˝cb
 *
ç
 = 
	`sŸŸ˝cb
(
so
);

258 
	`DEBUG_CALL
("sorecvoob");

259 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

269 
	`s‹ód
(
so
);

270 
ç
->
¢d_up
 =Åp->
¢d_u«
 + 
so
->
so_¢d
.
sb_cc
;

271 
ç
->
t_f‹˚
 = 1;

272 
	`t˝_ouçut
(
ç
);

273 
ç
->
t_f‹˚
 = 0;

274 
	}
}

281 
	$so£ndoob
(
sockë
 *
so
)

283 
sbuf
 *
sb
 = &
so
->
so_rcv
;

284 
buff
[2048];

286 
n
, 
Àn
;

288 
	`DEBUG_CALL
("sosendoob");

289 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

290 
	`DEBUG_ARG
("sb->sb_c¯%d", 
sb
->
sb_cc
);

292 i‡(
so
->
so_urgc
 > 2048)

293 
so
->
so_urgc
 = 2048;

295 i‡(
sb
->
sb_Ωå
 < sb->
sb_w±r
) {

297 
n
 = 
	`¶úp_£nd
(
so
, 
sb
->
sb_Ωå
, so->
so_urgc
, (
MSG_OOB
));

298 
so
->
so_urgc
 -
n
;

300 
	`DEBUG_MISC
((
dfd
, " --- síà%d byã†urgíàd©a, %d urgíàbyã†À·\n", 
n
, 
so
->
so_urgc
));

307 
Àn
 = (
sb
->
sb_d©a
 + sb->
sb_d©Æí
Ë- sb->
sb_Ωå
;

308 i‡(
Àn
 > 
so
->
so_urgc
)Üen = so->so_urgc;

309 
	`mem˝y
(
buff
, 
sb
->
sb_Ωå
, 
Àn
);

310 
so
->
so_urgc
 -
Àn
;

311 i‡(
so
->
so_urgc
) {

312 
n
 = 
sb
->
sb_w±r
 - sb->
sb_d©a
;

313 i‡(
n
 > 
so
->
so_urgc
)Ç = so->so_urgc;

314 
	`mem˝y
((
buff
 + 
Àn
), 
sb
->
sb_d©a
, 
n
);

315 
so
->
so_urgc
 -
n
;

316 
Àn
 +
n
;

318 
n
 = 
	`¶úp_£nd
(
so
, 
buff
, 
Àn
, (
MSG_OOB
));

319 #ifde‡
DEBUG


320 i‡(
n
 !
Àn
)

321 
	`DEBUG_ERROR
((
dfd
, "Didn't sendáll data urgently XXXXX\n"));

323 
	`DEBUG_MISC
((
dfd
, " ---2 síà%d byã†urgíàd©a, %d urgíàbyã†À·\n", 
n
, 
so
->
so_urgc
));

326 
sb
->
sb_cc
 -
n
;

327 
sb
->
sb_Ωå
 +
n
;

328 i‡(
sb
->
sb_Ωå
 >(sb->
sb_d©a
 + sb->
sb_d©Æí
))

329 
sb
->
sb_Ωå
 -sb->
sb_d©Æí
;

331  
n
;

332 
	}
}

339 
	$sowrôe
(
sockë
 *
so
)

341 
n
,
¬
;

342 
sbuf
 *
sb
 = &
so
->
so_rcv
;

343 
Àn
 = 
sb
->
sb_cc
;

344 
iovec
 
iov
[2];

346 
	`DEBUG_CALL
("sowrite");

347 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

349 i‡(
so
->
so_urgc
) {

350 
	`so£ndoob
(
so
);

351 i‡(
sb
->
sb_cc
 == 0)

360 
iov
[0].
iov_ba£
 = 
sb
->
sb_Ωå
;

361 
iov
[1].
iov_ba£
 = 
NULL
;

362 
iov
[1].
iov_Àn
 = 0;

363 i‡(
sb
->
sb_Ωå
 < sb->
sb_w±r
) {

364 
iov
[0].
iov_Àn
 = 
sb
->
sb_w±r
 - sb->
sb_Ωå
;

366 i‡(
iov
[0].
iov_Àn
 > 
Àn
) iov[0].iov_len =Üen;

367 
n
 = 1;

369 
iov
[0].
iov_Àn
 = (
sb
->
sb_d©a
 + sb->
sb_d©Æí
Ë- sb->
sb_Ωå
;

370 i‡(
iov
[0].
iov_Àn
 > 
Àn
) iov[0].iov_len =Üen;

371 
Àn
 -
iov
[0].
iov_Àn
;

372 i‡(
Àn
) {

373 
iov
[1].
iov_ba£
 = 
sb
->
sb_d©a
;

374 
iov
[1].
iov_Àn
 = 
sb
->
sb_w±r
 - sb->
sb_d©a
;

375 i‡(
iov
[1].
iov_Àn
 > 
Àn
) iov[1].iov_len =Üen;

376 
n
 = 2;

378 
n
 = 1;

382 #ifde‡
HAVE_READV


383 
¬
 = 
	`wrôev
(
so
->
s
, (c⁄° 
iovec
 *)
iov
, 
n
);

385 
	`DEBUG_MISC
((
dfd
, " ... wrŸê¬ = %d byãs\n", 
¬
));

387 
¬
 = 
	`¶úp_£nd
(
so
, 
iov
[0].
iov_ba£
, iov[0].
iov_Àn
,0);

390 i‡(
¬
 < 0 && (
î∫o
 =
EAGAIN
 ||Éºnÿ=
EINTR
))

393 i‡(
¬
 <= 0) {

394 
	`DEBUG_MISC
((
dfd
, " --- sowrite disconnected, so->so_state = %x,Érrno = %d\n",

395 
so
->
so_°©e
, 
î∫o
));

396 
	`sofˇ¡£ndm‹e
(
so
);

397 
	`t˝_sock˛o£d
(
	`sŸŸ˝cb
(
so
));

401 #i‚de‡
HAVE_READV


402 i‡(
n
 =2 && 
¬
 =
iov
[0].
iov_Àn
) {

403 
ªt
;

404 
ªt
 = 
	`¶úp_£nd
(
so
, 
iov
[1].
iov_ba£
, iov[1].
iov_Àn
,0);

405 i‡(
ªt
 > 0)

406 
¬
 +
ªt
;

408 
	`DEBUG_MISC
((
dfd
, " ... wrŸê¬ = %d byãs\n", 
¬
));

412 
sb
->
sb_cc
 -
¬
;

413 
sb
->
sb_Ωå
 +
¬
;

414 i‡(
sb
->
sb_Ωå
 >(sb->
sb_d©a
 + sb->
sb_d©Æí
))

415 
sb
->
sb_Ωå
 -sb->
sb_d©Æí
;

421 i‡((
so
->
so_°©e
 & 
SS_FWDRAIN
Ë&& 
sb
->
sb_cc
 == 0)

422 
	`sofˇ¡£ndm‹e
(
so
);

424  
¬
;

425 
	}
}

431 
	$s‹ecv‰om
(
sockë
 *
so
)

433 
sockaddr_ö
 
addr
;

434 
sockÀn_t
 
addæí
 = (
sockaddr_ö
);

436 
	`DEBUG_CALL
("sorecvfrom");

437 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

439 i‡(
so
->
so_ty≥
 =
IPPROTO_ICMP
) {

440 
buff
[256];

441 
Àn
;

443 
Àn
 = 
	`ªcv‰om
(
so
->
s
, 
buff
, 256, 0,

444 (
sockaddr
 *)&
addr
, &
addæí
);

447 if(
Àn
 == -1 ||Üen == 0) {

448 
u_ch¨
 
code
=
ICMP_UNREACH_PORT
;

450 if(
î∫o
 =
EHOSTUNREACH
Ë
code
=
ICMP_UNREACH_HOST
;

451 if(
î∫o
 =
ENETUNREACH
Ë
code
=
ICMP_UNREACH_NET
;

453 
	`DEBUG_MISC
((
dfd
," udp icmpÑxÉrrno = %d-%s\n",

454 
î∫o
,
	`°ªº‹
(errno)));

455 
	`icmp_îr‹
(
so
->
so_m
, 
ICMP_UNREACH
,
code
, 0,
	`°ªº‹
(
î∫o
));

457 
	`icmp_ªÊe˘
(
so
->
so_m
);

458 
so
->
so_m
 = 
NULL
;

461 
	`udp_dëach
(
so
);

463 
mbuf
 *
m
;

464 
Àn
;

465 #ifde‡
_WIN32


466 
n
;

468 
n
;

471 
m
 = 
	`m_gë
(
so
->
¶úp
);

472 i‡(!
m
) {

475 
m
->
m_d©a
 +
IF_MAXLINKHDR
;

481 
Àn
 = 
	`M_FREEROOM
(
m
);

483 
	`io˘lsockë
(
so
->
s
, 
FIONREAD
, &
n
);

485 i‡(
n
 > 
Àn
) {

486 
n
 = (
m
->
m_d©a
 - m->
m_d©
Ë+ m->
m_Àn
 +Ç + 1;

487 
	`m_öc
(
m
, 
n
);

488 
Àn
 = 
	`M_FREEROOM
(
m
);

492 
m
->
m_Àn
 = 
	`ªcv‰om
(
so
->
s
, m->
m_d©a
, 
Àn
, 0,

493 (
sockaddr
 *)&
addr
, &
addæí
);

494 
	`DEBUG_MISC
((
dfd
, " didÑecvfrom %d,Érrno = %d-%s\n",

495 
m
->
m_Àn
, 
î∫o
,
	`°ªº‹
(errno)));

496 if(
m
->
m_Àn
<0) {

497 
u_ch¨
 
code
=
ICMP_UNREACH_PORT
;

499 if(
î∫o
 =
EHOSTUNREACH
Ë
code
=
ICMP_UNREACH_HOST
;

500 if(
î∫o
 =
ENETUNREACH
Ë
code
=
ICMP_UNREACH_NET
;

502 
	`DEBUG_MISC
((
dfd
,"ÑxÉº‹,Åx icm∞ICMP_UNREACH:%i\n", 
code
));

503 
	`icmp_îr‹
(
so
->
so_m
, 
ICMP_UNREACH
,
code
, 0,
	`°ªº‹
(
î∫o
));

504 
	`m_‰ì
(
m
);

512 i‡(
so
->
so_expúe
) {

513 i‡(
so
->
so_Â‹t
 =
	`ht⁄s
(53))

514 
so
->
so_expúe
 = 
cuπime
 + 
SO_EXPIREFAST
;

516 
so
->
so_expúe
 = 
cuπime
 + 
SO_EXPIRE
;

523 
	`udp_ouçut
(
so
, 
m
, &
addr
);

526 
	}
}

532 
	$so£ndto
(
sockë
 *
so
, 
mbuf
 *
m
)

534 
Slúp
 *
¶úp
 = 
so
->slirp;

535 
ªt
;

536 
sockaddr_ö
 
addr
;

538 
	`DEBUG_CALL
("sosendto");

539 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

540 
	`DEBUG_ARG
("m = %lx", ()
m
);

542 
addr
.
sö_Ámûy
 = 
AF_INET
;

543 i‡((
so
->
so_Áddr
.
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) ==

544 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

546 i‡(
so
->
so_Áddr
.
s_addr
 =
¶úp
->
v«me£rvî_addr
.s_addr) {

547 i‡(
	`gë_dns_addr
(&
addr
.
sö_addr
) < 0)

548 
addr
.
sö_addr
 = 
lo›back_addr
;

550 
addr
.
sö_addr
 = 
lo›back_addr
;

553 
addr
.
sö_addr
 = 
so
->
so_Áddr
;

554 
addr
.
sö_p‹t
 = 
so
->
so_Â‹t
;

556 
	`DEBUG_MISC
((
dfd
, " sídto()ög,áddr.sö_p‹t=%d,áddr.sö_addr.s_addr=%.16s\n", 
	`¡ohs
(
addr
.
sö_p‹t
), 
	`öë_¡ﬂ
◊ddr.
sö_addr
)));

559 
ªt
 = 
	`£ndto
(
so
->
s
, 
m
->
m_d©a
, m->
m_Àn
, 0,

560 (
sockaddr
 *)&
addr
,  (sockaddr));

561 i‡(
ªt
 < 0)

568 i‡(
so
->
so_expúe
)

569 
so
->
so_expúe
 = 
cuπime
 + 
SO_EXPIRE
;

570 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

571 
so
->
so_°©e
 |
SS_ISFCONNECTED
;

573 
	}
}

578 
sockë
 *

579 
	$t˝_li°í
(
Slúp
 *
¶úp
, 
uöt32_t
 
haddr
, 
u_öt
 
hp‹t
, uöt32_à
œddr
,

580 
u_öt
 
Õ‹t
, 
Êags
)

582 
sockaddr_ö
 
addr
;

583 
sockë
 *
so
;

584 
s
, 
›t
 = 1;

585 
sockÀn_t
 
addæí
 = (
addr
);

586 
	`mem£t
(&
addr
, 0, 
addæí
);

588 
	`DEBUG_CALL
("tcp_listen");

589 
	`DEBUG_ARG
("hadd∏%x", 
haddr
);

590 
	`DEBUG_ARG
("hp‹à%d", 
hp‹t
);

591 
	`DEBUG_ARG
("œdd∏%x", 
œddr
);

592 
	`DEBUG_ARG
("Õ‹à%d", 
Õ‹t
);

593 
	`DEBUG_ARG
("Êag†%x", 
Êags
);

595 
so
 = 
	`so¸óã
(
¶úp
);

596 i‡(!
so
) {

597  
NULL
;

601 i‡((
so
->
so_t˝cb
 = 
	`t˝_√wt˝cb
(so)Ë=
NULL
) {

602 
	`‰ì
(
so
);

603  
NULL
;

605 
	`ösque
(
so
, &
¶úp
->
tcb
);

610 i‡(
Êags
 & 
SS_FACCEPTONCE
)

611 
so
->
so_t˝cb
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEP_INIT
*2;

613 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

614 
so
->
so_°©e
 |(
SS_FACCEPTCONN
 | 
Êags
);

615 
so
->
so_Õ‹t
 = 
Õ‹t
;

616 
so
->
so_œddr
.
s_addr
 = 
œddr
;

618 
addr
.
sö_Ámûy
 = 
AF_INET
;

619 
addr
.
sö_addr
.
s_addr
 = 
haddr
;

620 
addr
.
sö_p‹t
 = 
hp‹t
;

622 i‡(((
s
 = 
	`os_sockë
(
AF_INET
,
SOCK_STREAM
,0)) < 0) ||

623 (
	`£tsock›t
(
s
,
SOL_SOCKET
,
SO_REUSEADDR
,(*)&
›t
,()) < 0) ||

624 (
	`böd
(
s
,(
sockaddr
 *)&
addr
, (addr)) < 0) ||

625 (
	`li°í
(
s
,1) < 0)) {

626 
tm≥ºno
 = 
î∫o
;

628 
	`˛o£
(
s
);

629 
	`so‰ì
(
so
);

631 #ifde‡
_WIN32


632 
	`WSASëLa°Eº‹
(
tm≥ºno
);

634 
î∫o
 = 
tm≥ºno
;

636  
NULL
;

638 
	`£tsock›t
(
s
,
SOL_SOCKET
,
SO_OOBINLINE
,(*)&
›t
,());

640 
	`gësock«me
(
s
,(
sockaddr
 *)&
addr
,&
addæí
);

641 
so
->
so_Â‹t
 = 
addr
.
sö_p‹t
;

642 i‡(
addr
.
sö_addr
.
s_addr
 =0 ||áddr.sö_addr.s_add∏=
lo›back_addr
.s_addr)

643 
so
->
so_Áddr
 = 
¶úp
->
vho°_addr
;

645 
so
->
so_Áddr
 = 
addr
.
sö_addr
;

647 
so
->
s
 = s;

648  
so
;

649 
	}
}

658 
	$soisfc⁄√˘ög
(
sockë
 *
so
)

660 
so
->
so_°©e
 &~(
SS_NOFDREF
|
SS_ISFCONNECTED
|
SS_FCANTRCVMORE
|

661 
SS_FCANTSENDMORE
|
SS_FWDRAIN
);

662 
so
->
so_°©e
 |
SS_ISFCONNECTING
;

663 
	}
}

666 
	$soisfc⁄√˘ed
(
sockë
 *
so
)

668 
so
->
so_°©e
 &~(
SS_ISFCONNECTING
|
SS_FWDRAIN
|
SS_NOFDREF
);

669 
so
->
so_°©e
 |
SS_ISFCONNECTED
;

670 
	}
}

673 
	$sofˇ¡rcvm‹e
(
sockë
 *
so
)

675 i‡((
so
->
so_°©e
 & 
SS_NOFDREF
) == 0) {

676 
	`shutdown
(
so
->
s
,0);

677 if(
globÆ_wrôefds
) {

678 
	`FD_CLR
(
so
->
s
,
globÆ_wrôefds
);

681 
so
->
so_°©e
 &~(
SS_ISFCONNECTING
);

682 i‡(
so
->
so_°©e
 & 
SS_FCANTSENDMORE
) {

683 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

684 
so
->
so_°©e
 |
SS_NOFDREF
;

686 
so
->
so_°©e
 |
SS_FCANTRCVMORE
;

688 
	}
}

691 
	$sofˇ¡£ndm‹e
(
sockë
 *
so
)

693 i‡((
so
->
so_°©e
 & 
SS_NOFDREF
) == 0) {

694 
	`shutdown
(
so
->
s
,1);

695 i‡(
globÆ_ªadfds
) {

696 
	`FD_CLR
(
so
->
s
,
globÆ_ªadfds
);

698 i‡(
globÆ_xfds
) {

699 
	`FD_CLR
(
so
->
s
,
globÆ_xfds
);

702 
so
->
so_°©e
 &~(
SS_ISFCONNECTING
);

703 i‡(
so
->
so_°©e
 & 
SS_FCANTRCVMORE
) {

704 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

705 
so
->
so_°©e
 |
SS_NOFDREF
;

707 
so
->
so_°©e
 |
SS_FCANTSENDMORE
;

709 
	}
}

716 
	$sofwdøö
(
sockë
 *
so
)

718 i‡(
so
->
so_rcv
.
sb_cc
)

719 
so
->
so_°©e
 |
SS_FWDRAIN
;

721 
	`sofˇ¡£ndm‹e
(
so
);

722 
	}
}

	@slirp/socket.h

8 #i‚de‡
_SLIRP_SOCKET_H_


9 
	#_SLIRP_SOCKET_H_


	)

11 
	#SO_EXPIRE
 240000

	)

12 
	#SO_EXPIREFAST
 10000

	)

18 
	ssockë
 {

19 
sockë
 *
	mso_√xt
,*
	mso_¥ev
;

21 
	ms
;

23 
Slúp
 *
	m¶úp
;

26 
mbuf
 *
	mso_m
;

29 
t˝ùhdr
 *
	mso_ti
;

31 
	mso_urgc
;

32 
ö_addr
 
	mso_Áddr
;

33 
ö_addr
 
	mso_œddr
;

34 
uöt16_t
 
	mso_Â‹t
;

35 
uöt16_t
 
	mso_Õ‹t
;

37 
uöt8_t
 
	mso_ùtos
;

38 
uöt8_t
 
	mso_emu
;

40 
u_ch¨
 
	mso_ty≥
;

41 
	mso_°©e
;

43 
t˝cb
 *
	mso_t˝cb
;

44 
u_öt
 
	mso_expúe
;

46 
	mso_queued
;

47 
	mso_nqueued
;

51 
sbuf
 
	mso_rcv
;

52 
sbuf
 
	mso_¢d
;

53 * 
	mexåa
;

61 
	#SS_NOFDREF
 0x001

	)

63 
	#SS_ISFCONNECTING
 0x002

	)

64 
	#SS_ISFCONNECTED
 0x004

	)

65 
	#SS_FCANTRCVMORE
 0x008

	)

66 
	#SS_FCANTSENDMORE
 0x010

	)

67 
	#SS_FWDRAIN
 0x040

	)

69 
	#SS_CTL
 0x080

	)

70 
	#SS_FACCEPTCONN
 0x100

	)

71 
	#SS_FACCEPTONCE
 0x200

	)

73 
	#SS_PERSISTENT_MASK
 0xf000

	)

74 
	#SS_HOSTFWD
 0x1000

	)

75 
	#SS_INCOMING
 0x2000

	)

77 
sockë
 * 
sﬁookup
(sockë *, 
ö_addr
, 
u_öt
, in_addr, u_int);

78 
sockë
 * 
so¸óã
(
Slúp
 *);

79 
so‰ì
(
sockë
 *);

80 
s‹ód
(
sockë
 *);

81 
s‹ecvoob
(
sockë
 *);

82 
so£ndoob
(
sockë
 *);

83 
sowrôe
(
sockë
 *);

84 
s‹ecv‰om
(
sockë
 *);

85 
so£ndto
(
sockë
 *, 
mbuf
 *);

86 
sockë
 * 
t˝_li°í
(
Slúp
 *, 
uöt32_t
, 
u_öt
, uint32_t, u_int,

88 
soisfc⁄√˘ög
(
sockë
 *);

89 
soisfc⁄√˘ed
(
sockë
 *);

90 
sofwdøö
(
sockë
 *);

91 
	giovec
;

92 
size_t
 
s›ª¥buf
(
sockë
 *
so
, 
iovec
 *
iov
, *
≈
);

93 
s‹ódbuf
(
sockë
 *
so
, c⁄° *
buf
, 
size
);

	@slirp/tcp.h

33 #i‚de‡
_TCP_H_


34 
	#_TCP_H_


	)

36 
uöt32_t
 
	tt˝_£q
;

38 
	#PR_SLOWHZ
 2

	)

39 
	#PR_FASTHZ
 5

	)

41 
	#TCP_SNDSPACE
 8192

	)

42 
	#TCP_RCVSPACE
 8192

	)

48 
	st˝hdr
 {

49 
uöt16_t
 
	mth_•‹t
;

50 
uöt16_t
 
	mth_dp‹t
;

51 
t˝_£q
 
	mth_£q
;

52 
t˝_£q
 
	mth_ack
;

53 #ifde‡
HOST_WORDS_BIGENDIAN


54 
u_öt
 
	mth_off
:4,

55 
	mth_x2
:4;

57 
u_öt
 
	mth_x2
:4,

58 
	mth_off
:4;

60 
uöt8_t
 
	mth_Êags
;

61 
	#TH_FIN
 0x01

	)

62 
	#TH_SYN
 0x02

	)

63 
	#TH_RST
 0x04

	)

64 
	#TH_PUSH
 0x08

	)

65 
	#TH_ACK
 0x10

	)

66 
	#TH_URG
 0x20

	)

67 
uöt16_t
 
	mth_wö
;

68 
uöt16_t
 
	mth_sum
;

69 
uöt16_t
 
	mth_uΩ
;

72 
	~"t˝_v¨.h
"

74 
	#TCPOPT_EOL
 0

	)

75 
	#TCPOPT_NOP
 1

	)

76 
	#TCPOPT_MAXSEG
 2

	)

77 
	#TCPOLEN_MAXSEG
 4

	)

78 
	#TCPOPT_WINDOW
 3

	)

79 
	#TCPOLEN_WINDOW
 3

	)

80 
	#TCPOPT_SACK_PERMITTED
 4

	)

81 
	#TCPOLEN_SACK_PERMITTED
 2

	)

82 
	#TCPOPT_SACK
 5

	)

83 
	#TCPOPT_TIMESTAMP
 8

	)

84 
	#TCPOLEN_TIMESTAMP
 10

	)

85 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2Ë

	)

87 
	#TCPOPT_TSTAMP_HDR
 \

88 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

98 
	#TCP_MSS
 1460

	)

100 
	#TCP_MAXWIN
 65535

	)

102 
	#TCP_MAX_WINSHIFT
 14

	)

111 #unde‡
TCP_NODELAY


112 
	#TCP_NODELAY
 0x01

	)

113 #unde‡
TCP_MAXSEG


120 
	#TCP_NSTATES
 11

	)

122 
	#TCPS_CLOSED
 0

	)

123 
	#TCPS_LISTEN
 1

	)

124 
	#TCPS_SYN_SENT
 2

	)

125 
	#TCPS_SYN_RECEIVED
 3

	)

127 
	#TCPS_ESTABLISHED
 4

	)

128 
	#TCPS_CLOSE_WAIT
 5

	)

130 
	#TCPS_FIN_WAIT_1
 6

	)

131 
	#TCPS_CLOSING
 7

	)

132 
	#TCPS_LAST_ACK
 8

	)

134 
	#TCPS_FIN_WAIT_2
 9

	)

135 
	#TCPS_TIME_WAIT
 10

	)

137 
	#TCPS_HAVERCVDSYN
(
s
Ë((sË>
TCPS_SYN_RECEIVED
)

	)

138 
	#TCPS_HAVEESTABLISHED
(
s
Ë((sË>
TCPS_ESTABLISHED
)

	)

139 
	#TCPS_HAVERCVDFIN
(
s
Ë((sË>
TCPS_TIME_WAIT
)

	)

146 
	#SEQ_LT
(
a
,
b
Ë(()(◊)-(b)Ë< 0)

	)

147 
	#SEQ_LEQ
(
a
,
b
Ë(()(◊)-(b)Ë<0)

	)

148 
	#SEQ_GT
(
a
,
b
Ë(()(◊)-(b)Ë> 0)

	)

149 
	#SEQ_GEQ
(
a
,
b
Ë(()(◊)-(b)Ë>0)

	)

156 
	#t˝_rcv£qöô
(
ç
) \

157 (
ç
)->
rcv_adv
 = (ç)->
rcv_nxt
 = (ç)->
ús
 + 1

	)

159 
	#t˝_£nd£qöô
(
ç
) \

160 (
ç
)->
¢d_u«
 = (ç)->
¢d_nxt
 = (ç)->
¢d_max
 = (ç)->
¢d_up
 = (ç)->
iss


	)

162 
	#TCP_ISSINCR
 (125*1024Ë

	)

	@slirp/tcp_input.c

41 
	~"¶úp.h
"

42 
	~"ù_icmp.h
"

44 
	#TCPREXMTTHRESH
 3

	)

46 
	#TCP_PAWS_IDLE
 (24 * 24 * 60 * 60 * 
PR_SLOWHZ
)

	)

49 
	#TSTMP_LT
(
a
,
b
Ë(()(◊)-(b)Ë< 0)

	)

50 
	#TSTMP_GEQ
(
a
,
b
Ë(()(◊)-(b)Ë>0)

	)

62 #ifde‡
TCP_ACK_HACK


63 
	#TCP_REASS
(
ç
, 
ti
, 
m
, 
so
, 
Êags
) {\

64 i‡((
ti
)->
ti_£q
 =(
ç
)->
rcv_nxt
 && \

65 
	`t˝‰ag_li°_em±y
(
ç
) && \

66 (
ç
)->
t_°©e
 =
TCPS_ESTABLISHED
) {\

67 i‡(
ti
->
ti_Êags
 & 
TH_PUSH
) \

68 
ç
->
t_Êags
 |
TF_ACKNOW
; \

70 
ç
->
t_Êags
 |
TF_DELACK
; \

71 (
ç
)->
rcv_nxt
 +(
ti
)->
ti_Àn
; \

72 
Êags
 = (
ti
)->
ti_Êags
 & 
TH_FIN
; \

73 i‡(
so
->
so_emu
) { \

74 i‡(
	`t˝_emu
((
so
),(
m
))Ë
	`sb≠≥nd
((so), (m)); \

76 
	`sb≠≥nd
((
so
), (
m
)); \

78 (
Êags
Ë
	`t˝_ªass
((
ç
), (
ti
), (
m
)); \

79 
ç
->
t_Êags
 |
TF_ACKNOW
; \

81 }

	)

83 
	#TCP_REASS
(
ç
, 
ti
, 
m
, 
so
, 
Êags
) { \

84 i‡((
ti
)->
ti_£q
 =(
ç
)->
rcv_nxt
 && \

85 
	`t˝‰ag_li°_em±y
(
ç
) && \

86 (
ç
)->
t_°©e
 =
TCPS_ESTABLISHED
) { \

87 
ç
->
t_Êags
 |
TF_DELACK
; \

88 (
ç
)->
rcv_nxt
 +(
ti
)->
ti_Àn
; \

89 
Êags
 = (
ti
)->
ti_Êags
 & 
TH_FIN
; \

90 i‡(
so
->
so_emu
) { \

91 i‡(
	`t˝_emu
((
so
),(
m
))Ë
	`sb≠≥nd
(so, (m)); \

93 
	`sb≠≥nd
((
so
), (
m
)); \

95 (
Êags
Ë
	`t˝_ªass
((
ç
), (
ti
), (
m
)); \

96 
ç
->
t_Êags
 |
TF_ACKNOW
; \

98 }

	)

100 
t˝_do›ti⁄s
(
t˝cb
 *
ç
, 
u_ch¨
 *
˝
, 
˙t
,

101 
t˝ùhdr
 *
ti
);

102 
t˝_xmô_timî
(
t˝cb
 *
ç
, 
πt
);

105 
	$t˝_ªass
(
t˝cb
 *
ç
, 
t˝ùhdr
 *
ti
,

106 
mbuf
 *
m
)

108 
t˝ùhdr
 *
q
;

109 
sockë
 *
so
 = 
ç
->
t_sockë
;

110 
Êags
;

116 i‡(
ti
 =
NULL
)

117 
¥e£¡
;

122 
q
 = 
	`t˝‰ag_li°_fú°
(
ç
); !
	`t˝‰ag_li°_íd
(q,Åp);

123 
q
 = 
	`t˝ùhdr_√xt
(q))

124 i‡(
	`SEQ_GT
(
q
->
ti_£q
, 
ti
->ti_seq))

132 i‡(!
	`t˝‰ag_li°_íd
(
	`t˝ùhdr_¥ev
(
q
), 
ç
)) {

133 
i
;

134 
q
 = 
	`t˝ùhdr_¥ev
(q);

136 
i
 = 
q
->
ti_£q
 + q->
ti_Àn
 - 
ti
->ti_seq;

137 i‡(
i
 > 0) {

138 i‡(
i
 >
ti
->
ti_Àn
) {

139 
	`m_‰ìm
(
m
);

146 
¥e£¡
;

148 
	`m_adj
(
m
, 
i
);

149 
ti
->
ti_Àn
 -
i
;

150 
ti
->
ti_£q
 +
i
;

152 
q
 = 
	`t˝ùhdr_√xt
(q);

154 
ti
->
ti_mbuf
 = 
m
;

160 !
	`t˝‰ag_li°_íd
(
q
, 
ç
)) {

161 
i
 = (
ti
->
ti_£q
 +Åi->
ti_Àn
Ë- 
q
->ti_seq;

162 i‡(
i
 <= 0)

164 i‡(
i
 < 
q
->
ti_Àn
) {

165 
q
->
ti_£q
 +
i
;

166 
q
->
ti_Àn
 -
i
;

167 
	`m_adj
(
q
->
ti_mbuf
, 
i
);

170 
q
 = 
	`t˝ùhdr_√xt
(q);

171 
m
 = 
	`t˝ùhdr_¥ev
(
q
)->
ti_mbuf
;

172 
	`ªmque
(
	`t˝ùhdr2qlök
(
	`t˝ùhdr_¥ev
(
q
)));

173 
	`m_‰ìm
(
m
);

179 
	`ösque
(
	`t˝ùhdr2qlök
(
ti
),Å˝ùhdr2qlök(
	`t˝ùhdr_¥ev
(
q
)));

181 
¥e£¡
:

186 i‡(!
	`TCPS_HAVEESTABLISHED
(
ç
->
t_°©e
))

188 
ti
 = 
	`t˝‰ag_li°_fú°
(
ç
);

189 i‡(
	`t˝‰ag_li°_íd
(
ti
, 
ç
Ë||Åi->
ti_£q
 !ç->
rcv_nxt
)

191 i‡(
ç
->
t_°©e
 =
TCPS_SYN_RECEIVED
 && 
ti
->
ti_Àn
)

194 
ç
->
rcv_nxt
 +
ti
->
ti_Àn
;

195 
Êags
 = 
ti
->
ti_Êags
 & 
TH_FIN
;

196 
	`ªmque
(
	`t˝ùhdr2qlök
(
ti
));

197 
m
 = 
ti
->
ti_mbuf
;

198 
ti
 = 
	`t˝ùhdr_√xt
(ti);

199 i‡(
so
->
so_°©e
 & 
SS_FCANTSENDMORE
)

200 
	`m_‰ìm
(
m
);

202 i‡(
so
->
so_emu
) {

203 i‡(
	`t˝_emu
(
so
,
m
)Ë
	`sb≠≥nd
(so, m);

205 
	`sb≠≥nd
(
so
, 
m
);

207 } 
ti
 !(
t˝ùhdr
 *)
ç
 &&Åi->
ti_£q
 =ç->
rcv_nxt
);

208  (
Êags
);

209 
	}
}

216 
	$t˝_öput
(
mbuf
 *
m
, 
ùhÀn
, 
sockë
 *
öso
)

218 
ù
 
ßve_ù
, *ip;

219 
t˝ùhdr
 *
ti
;

220 
ˇddr_t
 
›ç
 = 
NULL
;

221 
›éí
 = 0;

222 
Àn
, 
éí
, 
off
;

223 
t˝cb
 *
ç
 = 
NULL
;

224 
tiÊags
;

225 
sockë
 *
so
 = 
NULL
;

226 
todr›
, 
acked
, 
ourföißcked
, 
√edouçut
 = 0;

227 
iss
 = 0;

228 
u_l⁄g
 
tiwö
;

229 
ªt
;

230 
ex_li°
 *
ex_±r
;

231 
Slúp
 *
¶úp
;

233 
	`DEBUG_CALL
("tcp_input");

234 
	`DEBUG_ARGS
((
dfd
," m = %8lx iphlen = %2d inso = %lx\n",

235 ()
m
, 
ùhÀn
, ()
öso
 ));

240 i‡(
m
 =
NULL
) {

241 
so
 = 
öso
;

242 
¶úp
 = 
so
->slirp;

245 
ç
 = 
	`sŸŸ˝cb
(
so
);

246 
m
 = 
so
->
so_m
;

247 
so
->
so_m
 = 
NULL
;

248 
ti
 = 
so
->
so_ti
;

249 
tiwö
 = 
ti
->
ti_wö
;

250 
tiÊags
 = 
ti
->
ti_Êags
;

252 
c⁄t_c⁄n
;

254 
¶úp
 = 
m
->slirp;

260 
ti
 = 
	`mtod
(
m
, 
t˝ùhdr
 *);

261 i‡(
ùhÀn
 > (
ù
 )) {

262 
	`ù_°rù›ti⁄s
(
m
, (
mbuf
 *)0);

263 
ùhÀn
=(
ù
 );

272 
ù
=
	`mtod
(
m
, ip *);

273 
ßve_ù
 = *
ù
;

274 
ßve_ù
.
ù_Àn
+
ùhÀn
;

279 
éí
 = ((
ù
 *)
ti
)->
ù_Àn
;

280 
	`t˝ùhdr2qlök
(
ti
)->
√xt
 =Å˝ùhdr2qlök—i)->
¥ev
 = 
NULL
;

281 
	`mem£t
(&
ti
->
ti_i
.
ih_mbuf
, 0 , (
mbuf_±r
));

282 
ti
->
ti_x1
 = 0;

283 
ti
->
ti_Àn
 = 
	`ht⁄s
((
uöt16_t
)
éí
);

284 
Àn
 = (
ù
 ) + 
éí
;

285 if(
	`cksum
(
m
, 
Àn
)) {

286 
dr›
;

293 
off
 = 
ti
->
ti_off
 << 2;

294 i‡(
off
 <  (
t˝hdr
Ë|| of‡> 
éí
) {

295 
dr›
;

297 
éí
 -
off
;

298 
ti
->
ti_Àn
 = 
éí
;

299 i‡(
off
 >  (
t˝hdr
)) {

300 
›éí
 = 
off
 -  (
t˝hdr
);

301 
›ç
 = 
	`mtod
(
m
, 
ˇddr_t
Ë+  (
t˝ùhdr
);

303 
tiÊags
 = 
ti
->
ti_Êags
;

308 
	`NTOHL
(
ti
->
ti_£q
);

309 
	`NTOHL
(
ti
->
ti_ack
);

310 
	`NTOHS
(
ti
->
ti_wö
);

311 
	`NTOHS
(
ti
->
ti_uΩ
);

316 
m
->
m_d©a
 +(
t˝ùhdr
)+
off
-(
t˝hdr
);

317 
m
->
m_Àn
 -(
t˝ùhdr
)+
off
-(
t˝hdr
);

319 i‡(
¶úp
->
ª°ri˘ed
) {

320 
ex_±r
 = 
¶úp
->
exec_li°
;Éx_±r;Éx_±∏ex_±r->
ex_√xt
) {

321 i‡(
ex_±r
->
ex_Â‹t
 =
ti
->
ti_dp‹t
 &&

322 
ti
->
ti_d°
.
s_addr
 =
ex_±r
->
ex_addr
.s_addr) {

326 i‡(!
ex_±r
)

327 
dr›
;

332 
födso
:

333 
so
 = 
¶úp
->
t˝_œ°_so
;

334 i‡(
so
->
so_Â‹t
 !
ti
->
ti_dp‹t
 ||

335 
so
->
so_Õ‹t
 !
ti
->
ti_•‹t
 ||

336 
so
->
so_œddr
.
s_addr
 !
ti
->
ti_§c
.s_addr ||

337 
so
->
so_Áddr
.
s_addr
 !
ti
->
ti_d°
.s_addr) {

338 
so
 = 
	`sﬁookup
(&
¶úp
->
tcb
, 
ti
->
ti_§c
,Åi->
ti_•‹t
,

339 
ti
->
ti_d°
,Åi->
ti_dp‹t
);

340 i‡(
so
)

341 
¶úp
->
t˝_œ°_so
 = 
so
;

357 i‡(
so
 =
NULL
) {

358 i‡((
tiÊags
 & (
TH_SYN
|
TH_FIN
|
TH_RST
|
TH_URG
|
TH_ACK
)) != TH_SYN)

359 
dr›wôhª£t
;

361 i‡((
so
 = 
	`so¸óã
(
¶úp
)Ë=
NULL
)

362 
dr›wôhª£t
;

363 i‡(
	`t˝_©èch
(
so
) < 0) {

364 
	`‰ì
(
so
);

365 
dr›wôhª£t
;

368 
	`sbª£rve
(&
so
->
so_¢d
, 
TCP_SNDSPACE
);

369 
	`sbª£rve
(&
so
->
so_rcv
, 
TCP_RCVSPACE
);

371 
so
->
so_œddr
 = 
ti
->
ti_§c
;

372 
so
->
so_Õ‹t
 = 
ti
->
ti_•‹t
;

373 
so
->
so_Áddr
 = 
ti
->
ti_d°
;

374 
so
->
so_Â‹t
 = 
ti
->
ti_dp‹t
;

376 i‡((
so
->
so_ùtos
 = 
	`t˝_tos
(so)) == 0)

377 
so
->
so_ùtos
 = ((
ù
 *)
ti
)->
ù_tos
;

379 
ç
 = 
	`sŸŸ˝cb
(
so
);

380 
ç
->
t_°©e
 = 
TCPS_LISTEN
;

388 i‡(
so
->
so_°©e
 & 
SS_ISFCONNECTING
)

389 
dr›
;

391 
ç
 = 
	`sŸŸ˝cb
(
so
);

394 i‡(
ç
 =
NULL
)

395 
dr›wôhª£t
;

396 i‡(
ç
->
t_°©e
 =
TCPS_CLOSED
)

397 
dr›
;

399 
tiwö
 = 
ti
->
ti_wö
;

405 
ç
->
t_idÀ
 = 0;

406 i‡(
SO_OPTIONS
)

407 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEPINTVL
;

409 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEP_IDLE
;

415 i‡(
›ç
 && 
ç
->
t_°©e
 !
TCPS_LISTEN
)

416 
	`t˝_do›ti⁄s
(
ç
, (
u_ch¨
 *)
›ç
, 
›éí
, 
ti
);

436 i‡(
ç
->
t_°©e
 =
TCPS_ESTABLISHED
 &&

437 (
tiÊags
 & (
TH_SYN
|
TH_FIN
|
TH_RST
|
TH_URG
|
TH_ACK
)) == TH_ACK &&

438 
ti
->
ti_£q
 =
ç
->
rcv_nxt
 &&

439 
tiwö
 &&Åiwö =
ç
->
¢d_wnd
 &&

440 
ç
->
¢d_nxt
 =ç->
¢d_max
) {

441 i‡(
ti
->
ti_Àn
 == 0) {

442 i‡(
	`SEQ_GT
(
ti
->
ti_ack
, 
ç
->
¢d_u«
) &&

443 
	`SEQ_LEQ
(
ti
->
ti_ack
, 
ç
->
¢d_max
) &&

444 
ç
->
¢d_cwnd
 >ç->
¢d_wnd
) {

448 i‡(
ç
->
t_πt
 &&

449 
	`SEQ_GT
(
ti
->
ti_ack
, 
ç
->
t_π£q
))

450 
	`t˝_xmô_timî
(
ç
,Åp->
t_πt
);

451 
acked
 = 
ti
->
ti_ack
 - 
ç
->
¢d_u«
;

452 
	`sbdr›
(&
so
->
so_¢d
, 
acked
);

453 
ç
->
¢d_u«
 = 
ti
->
ti_ack
;

454 
	`m_‰ìm
(
m
);

465 i‡(
ç
->
¢d_u«
 =ç->
¢d_max
)

466 
ç
->
t_timî
[
TCPT_REXMT
] = 0;

467 i‡(
ç
->
t_timî
[
TCPT_PERSIST
] == 0)

468 
ç
->
t_timî
[
TCPT_REXMT
] =Åp->
t_rxtcur
;

475 i‡(
so
->
so_¢d
.
sb_cc
)

476 (Ë
	`t˝_ouçut
(
ç
);

480 } i‡(
ti
->
ti_ack
 =
ç
->
¢d_u«
 &&

481 
	`t˝‰ag_li°_em±y
(
ç
) &&

482 
ti
->
ti_Àn
 <
	`sb•a˚
(&
so
->
so_rcv
)) {

488 
ç
->
rcv_nxt
 +
ti
->
ti_Àn
;

492 i‡(
so
->
so_emu
) {

493 i‡(
	`t˝_emu
(
so
,
m
)Ë
	`sb≠≥nd
(so, m);

495 
	`sb≠≥nd
(
so
, 
m
);

505 
ç
->
t_Êags
 |
TF_ACKNOW
;

506 
	`t˝_ouçut
(
ç
);

516 { 
wö
;

517 
wö
 = 
	`sb•a˚
(&
so
->
so_rcv
);

518 i‡(
wö
 < 0)

519 
wö
 = 0;

520 
ç
->
rcv_wnd
 = 
	`max
(
wö
, ()—p->
rcv_adv
 -Åp->
rcv_nxt
));

523 
ç
->
t_°©e
) {

538 
TCPS_LISTEN
: {

540 i‡(
tiÊags
 & 
TH_RST
)

541 
dr›
;

542 i‡(
tiÊags
 & 
TH_ACK
)

543 
dr›wôhª£t
;

544 i‡((
tiÊags
 & 
TH_SYN
) == 0)

545 
dr›
;

556 i‡((
so
->
so_Áddr
.
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) ==

557 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

558 i‡(
so
->
so_Áddr
.
s_addr
 !
¶úp
->
vho°_addr
.s_addr &&

559 
so
->
so_Áddr
.
s_addr
 !
¶úp
->
v«me£rvî_addr
.s_addr) {

561 
ex_±r
 = 
¶úp
->
exec_li°
;Éx_ptr;

562 
ex_±r
 =Éx_±r->
ex_√xt
) {

563 if(
ex_±r
->
ex_Â‹t
 =
so
->
so_Â‹t
 &&

564 
so
->
so_Áddr
.
s_addr
 =
ex_±r
->
ex_addr
.s_addr) {

565 
so
->
so_°©e
 |
SS_CTL
;

569 i‡(
so
->
so_°©e
 & 
SS_CTL
) {

570 
c⁄t_öput
;

576 i‡(
so
->
so_emu
 & 
EMU_NOCONNECT
) {

577 
so
->
so_emu
 &~
EMU_NOCONNECT
;

578 
c⁄t_öput
;

581 if((
	`t˝_fc⁄√˘
(
so
Ë=-1Ë&& (
î∫o
 !
EINPROGRESS
Ë&& (î∫ÿ!
EWOULDBLOCK
)) {

582 
u_ch¨
 
code
=
ICMP_UNREACH_NET
;

583 
	`DEBUG_MISC
((
dfd
,"Åcp fconnectÉrrno = %d-%s\n",

584 
î∫o
,
	`°ªº‹
(errno)));

585 if(
î∫o
 =
ECONNREFUSED
) {

587 
	`t˝_ª•⁄d
(
ç
, 
ti
, 
m
,Åi->
ti_£q
+1, (
t˝_£q
)0,

588 
TH_RST
|
TH_ACK
);

590 if(
î∫o
 =
EHOSTUNREACH
Ë
code
=
ICMP_UNREACH_HOST
;

591 
	`HTONL
(
ti
->
ti_£q
);

592 
	`HTONL
(
ti
->
ti_ack
);

593 
	`HTONS
(
ti
->
ti_wö
);

594 
	`HTONS
(
ti
->
ti_uΩ
);

595 
m
->
m_d©a
 -(
t˝ùhdr
)+
off
-(
t˝hdr
);

596 
m
->
m_Àn
 +(
t˝ùhdr
)+
off
-(
t˝hdr
);

597 *
ù
=
ßve_ù
;

598 
	`icmp_îr‹
(
m
, 
ICMP_UNREACH
,
code
, 0,
	`°ªº‹
(
î∫o
));

600 
	`t˝_˛o£
(
ç
);

601 
	`m_‰ì
(
m
);

609 
so
->
so_m
 = 
m
;

610 
so
->
so_ti
 = 
ti
;

611 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEP_INIT
;

612 
ç
->
t_°©e
 = 
TCPS_SYN_RECEIVED
;

616 
c⁄t_c⁄n
:

620 i‡(
so
->
so_°©e
 & 
SS_NOFDREF
) {

621 
ç
 = 
	`t˝_˛o£
(tp);

622 
dr›wôhª£t
;

624 
c⁄t_öput
:

625 
	`t˝_ãm∂©e
(
ç
);

627 i‡(
›ç
)

628 
	`t˝_do›ti⁄s
(
ç
, (
u_ch¨
 *)
›ç
, 
›éí
, 
ti
);

630 i‡(
iss
)

631 
ç
->
iss
 = iss;

633 
ç
->
iss
 = 
¶úp
->
t˝_iss
;

634 
¶úp
->
t˝_iss
 +
TCP_ISSINCR
/2;

635 
ç
->
ús
 = 
ti
->
ti_£q
;

636 
	`t˝_£nd£qöô
(
ç
);

637 
	`t˝_rcv£qöô
(
ç
);

638 
ç
->
t_Êags
 |
TF_ACKNOW
;

639 
ç
->
t_°©e
 = 
TCPS_SYN_RECEIVED
;

640 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEP_INIT
;

641 
åimthí°ï6
;

656 
TCPS_SYN_SENT
:

657 i‡((
tiÊags
 & 
TH_ACK
) &&

658 (
	`SEQ_LEQ
(
ti
->
ti_ack
, 
ç
->
iss
) ||

659 
	`SEQ_GT
(
ti
->
ti_ack
, 
ç
->
¢d_max
)))

660 
dr›wôhª£t
;

662 i‡(
tiÊags
 & 
TH_RST
) {

663 i‡(
tiÊags
 & 
TH_ACK
) {

664 
	`t˝_dr›
(
ç
, 0);

666 
dr›
;

669 i‡((
tiÊags
 & 
TH_SYN
) == 0)

670 
dr›
;

671 i‡(
tiÊags
 & 
TH_ACK
) {

672 
ç
->
¢d_u«
 = 
ti
->
ti_ack
;

673 i‡(
	`SEQ_LT
(
ç
->
¢d_nxt
,Åp->
¢d_u«
))

674 
ç
->
¢d_nxt
 =Åp->
¢d_u«
;

677 
ç
->
t_timî
[
TCPT_REXMT
] = 0;

678 
ç
->
ús
 = 
ti
->
ti_£q
;

679 
	`t˝_rcv£qöô
(
ç
);

680 
ç
->
t_Êags
 |
TF_ACKNOW
;

681 i‡(
tiÊags
 & 
TH_ACK
 && 
	`SEQ_GT
(
ç
->
¢d_u«
,Åp->
iss
)) {

682 
	`soisfc⁄√˘ed
(
so
);

683 
ç
->
t_°©e
 = 
TCPS_ESTABLISHED
;

685 (Ë
	`t˝_ªass
(
ç
, (
t˝ùhdr
 *)0,

686 (
mbuf
 *)0);

691 i‡(
ç
->
t_πt
)

692 
	`t˝_xmô_timî
(
ç
,Åp->
t_πt
);

694 
ç
->
t_°©e
 = 
TCPS_SYN_RECEIVED
;

696 
åimthí°ï6
:

702 
ti
->
ti_£q
++;

703 i‡(
ti
->
ti_Àn
 > 
ç
->
rcv_wnd
) {

704 
todr›
 = 
ti
->
ti_Àn
 - 
ç
->
rcv_wnd
;

705 
	`m_adj
(
m
, -
todr›
);

706 
ti
->
ti_Àn
 = 
ç
->
rcv_wnd
;

707 
tiÊags
 &~
TH_FIN
;

709 
ç
->
¢d_wl1
 = 
ti
->
ti_£q
 - 1;

710 
ç
->
rcv_up
 = 
ti
->
ti_£q
;

711 
°ï6
;

719 
todr›
 = 
ç
->
rcv_nxt
 - 
ti
->
ti_£q
;

720 i‡(
todr›
 > 0) {

721 i‡(
tiÊags
 & 
TH_SYN
) {

722 
tiÊags
 &~
TH_SYN
;

723 
ti
->
ti_£q
++;

724 i‡(
ti
->
ti_uΩ
 > 1)

725 
ti
->
ti_uΩ
--;

727 
tiÊags
 &~
TH_URG
;

728 
todr›
--;

733 i‡(
todr›
 > 
ti
->
ti_Àn


734 || (
todr›
 =
ti
->
ti_Àn
 && (
tiÊags
 & 
TH_FIN
) == 0)) {

740 
tiÊags
 &~
TH_FIN
;

746 
ç
->
t_Êags
 |
TF_ACKNOW
;

747 
todr›
 = 
ti
->
ti_Àn
;

749 
	`m_adj
(
m
, 
todr›
);

750 
ti
->
ti_£q
 +
todr›
;

751 
ti
->
ti_Àn
 -
todr›
;

752 i‡(
ti
->
ti_uΩ
 > 
todr›
)

753 
ti
->
ti_uΩ
 -
todr›
;

755 
tiÊags
 &~
TH_URG
;

756 
ti
->
ti_uΩ
 = 0;

763 i‡((
so
->
so_°©e
 & 
SS_NOFDREF
) &&

764 
ç
->
t_°©e
 > 
TCPS_CLOSE_WAIT
 && 
ti
->
ti_Àn
) {

765 
ç
 = 
	`t˝_˛o£
(tp);

766 
dr›wôhª£t
;

773 
todr›
 = (
ti
->
ti_£q
+ti->
ti_Àn
Ë- (
ç
->
rcv_nxt
+ç->
rcv_wnd
);

774 i‡(
todr›
 > 0) {

775 i‡(
todr›
 >
ti
->
ti_Àn
) {

782 i‡(
tiÊags
 & 
TH_SYN
 &&

783 
ç
->
t_°©e
 =
TCPS_TIME_WAIT
 &&

784 
	`SEQ_GT
(
ti
->
ti_£q
, 
ç
->
rcv_nxt
)) {

785 
iss
 = 
ç
->
rcv_nxt
 + 
TCP_ISSINCR
;

786 
ç
 = 
	`t˝_˛o£
(tp);

787 
födso
;

796 i‡(
ç
->
rcv_wnd
 =0 && 
ti
->
ti_£q
 =ç->
rcv_nxt
) {

797 
ç
->
t_Êags
 |
TF_ACKNOW
;

799 
dr›a·îack
;

802 
	`m_adj
(
m
, -
todr›
);

803 
ti
->
ti_Àn
 -
todr›
;

804 
tiÊags
 &~(
TH_PUSH
|
TH_FIN
);

817 i‡(
tiÊags
&
TH_RST
Ë
ç
->
t_°©e
) {

819 
TCPS_SYN_RECEIVED
:

820 
TCPS_ESTABLISHED
:

821 
TCPS_FIN_WAIT_1
:

822 
TCPS_FIN_WAIT_2
:

823 
TCPS_CLOSE_WAIT
:

824 
ç
->
t_°©e
 = 
TCPS_CLOSED
;

825 
	`t˝_˛o£
(
ç
);

826 
dr›
;

828 
TCPS_CLOSING
:

829 
TCPS_LAST_ACK
:

830 
TCPS_TIME_WAIT
:

831 
	`t˝_˛o£
(
ç
);

832 
dr›
;

839 i‡(
tiÊags
 & 
TH_SYN
) {

840 
ç
 = 
	`t˝_dr›
(tp,0);

841 
dr›wôhª£t
;

847 i‡((
tiÊags
 & 
TH_ACK
Ë=0Ë
dr›
;

852 
ç
->
t_°©e
) {

858 
TCPS_SYN_RECEIVED
:

860 i‡(
	`SEQ_GT
(
ç
->
¢d_u«
, 
ti
->
ti_ack
) ||

861 
	`SEQ_GT
(
ti
->
ti_ack
, 
ç
->
¢d_max
))

862 
dr›wôhª£t
;

863 
ç
->
t_°©e
 = 
TCPS_ESTABLISHED
;

871 
ç
->
¢d_u«
=
ti
->
ti_ack
;

872 i‡(
so
->
so_°©e
 & 
SS_CTL
) {

874 
ªt
 = 
	`t˝_˘l
(
so
);

875 i‡(
ªt
 == 1) {

876 
	`soisfc⁄√˘ed
(
so
);

877 
so
->
so_°©e
 &~
SS_CTL
;

878 } i‡(
ªt
 == 2) {

879 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

880 
so
->
so_°©e
 |
SS_NOFDREF
;

882 
√edouçut
 = 1;

883 
ç
->
t_°©e
 = 
TCPS_FIN_WAIT_1
;

886 
	`soisfc⁄√˘ed
(
so
);

889 (Ë
	`t˝_ªass
(
ç
, (
t˝ùhdr
 *)0, (
mbuf
 *)0);

890 
ç
->
¢d_wl1
 = 
ti
->
ti_£q
 - 1;

892 
syƒx_to_e°
;

903 
TCPS_ESTABLISHED
:

904 
TCPS_FIN_WAIT_1
:

905 
TCPS_FIN_WAIT_2
:

906 
TCPS_CLOSE_WAIT
:

907 
TCPS_CLOSING
:

908 
TCPS_LAST_ACK
:

909 
TCPS_TIME_WAIT
:

911 i‡(
	`SEQ_LEQ
(
ti
->
ti_ack
, 
ç
->
¢d_u«
)) {

912 i‡(
ti
->
ti_Àn
 =0 && 
tiwö
 =
ç
->
¢d_wnd
) {

913 
	`DEBUG_MISC
((
dfd
," dupáck m = %lx so = %lx \n",

914 ()
m
, ()
so
));

939 i‡(
ç
->
t_timî
[
TCPT_REXMT
] == 0 ||

940 
ti
->
ti_ack
 !
ç
->
¢d_u«
)

941 
ç
->
t_du∑cks
 = 0;

942 i‡(++
ç
->
t_du∑cks
 =
TCPREXMTTHRESH
) {

943 
t˝_£q
 
⁄xt
 = 
ç
->
¢d_nxt
;

944 
u_öt
 
wö
 =

945 
	`mö
(
ç
->
¢d_wnd
,Åp->
¢d_cwnd
) / 2 /

946 
ç
->
t_max£g
;

948 i‡(
wö
 < 2)

949 
wö
 = 2;

950 
ç
->
¢d_s°hªsh
 = 
wö
 *Åp->
t_max£g
;

951 
ç
->
t_timî
[
TCPT_REXMT
] = 0;

952 
ç
->
t_πt
 = 0;

953 
ç
->
¢d_nxt
 = 
ti
->
ti_ack
;

954 
ç
->
¢d_cwnd
 =Åp->
t_max£g
;

955 (Ë
	`t˝_ouçut
(
ç
);

956 
ç
->
¢d_cwnd
 =Åp->
¢d_s°hªsh
 +

957 
ç
->
t_max£g
 *Åp->
t_du∑cks
;

958 i‡(
	`SEQ_GT
(
⁄xt
, 
ç
->
¢d_nxt
))

959 
ç
->
¢d_nxt
 = 
⁄xt
;

960 
dr›
;

961 } i‡(
ç
->
t_du∑cks
 > 
TCPREXMTTHRESH
) {

962 
ç
->
¢d_cwnd
 +ç->
t_max£g
;

963 (Ë
	`t˝_ouçut
(
ç
);

964 
dr›
;

967 
ç
->
t_du∑cks
 = 0;

970 
syƒx_to_e°
:

975 i‡(
ç
->
t_du∑cks
 > 
TCPREXMTTHRESH
 &&

976 
ç
->
¢d_cwnd
 >Åp->
¢d_s°hªsh
)

977 
ç
->
¢d_cwnd
 =Åp->
¢d_s°hªsh
;

978 
ç
->
t_du∑cks
 = 0;

979 i‡(
	`SEQ_GT
(
ti
->
ti_ack
, 
ç
->
¢d_max
)) {

980 
dr›a·îack
;

982 
acked
 = 
ti
->
ti_ack
 - 
ç
->
¢d_u«
;

991 i‡(
ç
->
t_πt
 && 
	`SEQ_GT
(
ti
->
ti_ack
,Åp->
t_π£q
))

992 
	`t˝_xmô_timî
(
ç
,ç->
t_πt
);

1000 i‡(
ti
->
ti_ack
 =
ç
->
¢d_max
) {

1001 
ç
->
t_timî
[
TCPT_REXMT
] = 0;

1002 
√edouçut
 = 1;

1003 } i‡(
ç
->
t_timî
[
TCPT_PERSIST
] == 0)

1004 
ç
->
t_timî
[
TCPT_REXMT
] =Åp->
t_rxtcur
;

1013 
u_öt
 
cw
 = 
ç
->
¢d_cwnd
;

1014 
u_öt
 
ö¸
 = 
ç
->
t_max£g
;

1016 i‡(
cw
 > 
ç
->
¢d_s°hªsh
)

1017 
ö¸
 = in¸ * in¸ / 
cw
;

1018 
ç
->
¢d_cwnd
 = 
	`mö
(
cw
 + 
ö¸
, 
TCP_MAXWIN
<<ç->
¢d_sˇÀ
);

1020 i‡(
acked
 > 
so
->
so_¢d
.
sb_cc
) {

1021 
ç
->
¢d_wnd
 -
so
->
so_¢d
.
sb_cc
;

1022 
	`sbdr›
(&
so
->
so_¢d
, ()so->so_¢d.
sb_cc
);

1023 
ourföißcked
 = 1;

1025 
	`sbdr›
(&
so
->
so_¢d
, 
acked
);

1026 
ç
->
¢d_wnd
 -
acked
;

1027 
ourföißcked
 = 0;

1029 
ç
->
¢d_u«
 = 
ti
->
ti_ack
;

1030 i‡(
	`SEQ_LT
(
ç
->
¢d_nxt
,Åp->
¢d_u«
))

1031 
ç
->
¢d_nxt
 =Åp->
¢d_u«
;

1033 
ç
->
t_°©e
) {

1040 
TCPS_FIN_WAIT_1
:

1041 i‡(
ourföißcked
) {

1049 i‡(
so
->
so_°©e
 & 
SS_FCANTRCVMORE
) {

1050 
ç
->
t_timî
[
TCPT_2MSL
] = 
TCP_MAXIDLE
;

1052 
ç
->
t_°©e
 = 
TCPS_FIN_WAIT_2
;

1062 
TCPS_CLOSING
:

1063 i‡(
ourföißcked
) {

1064 
ç
->
t_°©e
 = 
TCPS_TIME_WAIT
;

1065 
	`t˝_ˇn˚…imîs
(
ç
);

1066 
ç
->
t_timî
[
TCPT_2MSL
] = 2 * 
TCPTV_MSL
;

1076 
TCPS_LAST_ACK
:

1077 i‡(
ourföißcked
) {

1078 
	`t˝_˛o£
(
ç
);

1079 
dr›
;

1088 
TCPS_TIME_WAIT
:

1089 
ç
->
t_timî
[
TCPT_2MSL
] = 2 * 
TCPTV_MSL
;

1090 
dr›a·îack
;

1094 
°ï6
:

1099 i‡((
tiÊags
 & 
TH_ACK
) &&

1100 (
	`SEQ_LT
(
ç
->
¢d_wl1
, 
ti
->
ti_£q
) ||

1101 (
ç
->
¢d_wl1
 =
ti
->
ti_£q
 && (
	`SEQ_LT
—p->
¢d_wl2
,Åi->
ti_ack
) ||

1102 (
ç
->
¢d_wl2
 =
ti
->
ti_ack
 && 
tiwö
 >Åp->
¢d_wnd
))))) {

1103 
ç
->
¢d_wnd
 = 
tiwö
;

1104 
ç
->
¢d_wl1
 = 
ti
->
ti_£q
;

1105 
ç
->
¢d_wl2
 = 
ti
->
ti_ack
;

1106 i‡(
ç
->
¢d_wnd
 >Åp->
max_¢dwnd
)

1107 
ç
->
max_¢dwnd
 =Åp->
¢d_wnd
;

1108 
√edouçut
 = 1;

1114 i‡((
tiÊags
 & 
TH_URG
Ë&& 
ti
->
ti_uΩ
 &&

1115 
	`TCPS_HAVERCVDFIN
(
ç
->
t_°©e
) == 0) {

1122 i‡(
ti
->
ti_uΩ
 + 
so
->
so_rcv
.
sb_cc
 > so->so_rcv.
sb_d©Æí
) {

1123 
ti
->
ti_uΩ
 = 0;

1124 
tiÊags
 &~
TH_URG
;

1125 
dod©a
;

1141 i‡(
	`SEQ_GT
(
ti
->
ti_£q
+ti->
ti_uΩ
, 
ç
->
rcv_up
)) {

1142 
ç
->
rcv_up
 = 
ti
->
ti_£q
 +Åi->
ti_uΩ
;

1143 
so
->
so_urgc
 = so->
so_rcv
.
sb_cc
 +

1144 (
ç
->
rcv_up
 -Åp->
rcv_nxt
);

1145 
ç
->
rcv_up
 = 
ti
->
ti_£q
 +Åi->
ti_uΩ
;

1154 i‡(
	`SEQ_GT
(
ç
->
rcv_nxt
,Åp->
rcv_up
))

1155 
ç
->
rcv_up
 =Åp->
rcv_nxt
;

1156 
dod©a
:

1166 i‡((
ti
->
ti_Àn
 || (
tiÊags
&
TH_FIN
)) &&

1167 
	`TCPS_HAVERCVDFIN
(
ç
->
t_°©e
) == 0) {

1168 
	`TCP_REASS
(
ç
, 
ti
, 
m
, 
so
, 
tiÊags
);

1170 
	`m_‰ì
(
m
);

1171 
tiÊags
 &~
TH_FIN
;

1178 i‡(
tiÊags
 & 
TH_FIN
) {

1179 i‡(
	`TCPS_HAVERCVDFIN
(
ç
->
t_°©e
) == 0) {

1189 
	`sofwdøö
(
so
);

1191 
ç
->
t_Êags
 |
TF_ACKNOW
;

1192 
ç
->
rcv_nxt
++;

1194 
ç
->
t_°©e
) {

1200 
TCPS_SYN_RECEIVED
:

1201 
TCPS_ESTABLISHED
:

1202 if(
so
->
so_emu
 =
EMU_CTL
)

1203 
ç
->
t_°©e
 = 
TCPS_LAST_ACK
;

1205 
ç
->
t_°©e
 = 
TCPS_CLOSE_WAIT
;

1212 
TCPS_FIN_WAIT_1
:

1213 
ç
->
t_°©e
 = 
TCPS_CLOSING
;

1221 
TCPS_FIN_WAIT_2
:

1222 
ç
->
t_°©e
 = 
TCPS_TIME_WAIT
;

1223 
	`t˝_ˇn˚…imîs
(
ç
);

1224 
ç
->
t_timî
[
TCPT_2MSL
] = 2 * 
TCPTV_MSL
;

1230 
TCPS_TIME_WAIT
:

1231 
ç
->
t_timî
[
TCPT_2MSL
] = 2 * 
TCPTV_MSL
;

1243 i‡(
ti
->
ti_Àn
 && ()ti->ti_len <= 5 &&

1244 ((
t˝ùhdr_2
 *)
ti
)->
fú°_ch¨
 == ()27) {

1245 
ç
->
t_Êags
 |
TF_ACKNOW
;

1251 i‡(
√edouçut
 || (
ç
->
t_Êags
 & 
TF_ACKNOW
)) {

1252 (Ë
	`t˝_ouçut
(
ç
);

1256 
dr›a·îack
:

1261 i‡(
tiÊags
 & 
TH_RST
)

1262 
dr›
;

1263 
	`m_‰ìm
(
m
);

1264 
ç
->
t_Êags
 |
TF_ACKNOW
;

1265 (Ë
	`t˝_ouçut
(
ç
);

1268 
dr›wôhª£t
:

1270 i‡(
tiÊags
 & 
TH_ACK
)

1271 
	`t˝_ª•⁄d
(
ç
, 
ti
, 
m
, (
t˝_£q
)0,Åi->
ti_ack
, 
TH_RST
);

1273 i‡(
tiÊags
 & 
TH_SYN
Ë
ti
->
ti_Àn
++;

1274 
	`t˝_ª•⁄d
(
ç
, 
ti
, 
m
,Åi->
ti_£q
+ti->
ti_Àn
, (
t˝_£q
)0,

1275 
TH_RST
|
TH_ACK
);

1280 
dr›
:

1284 
	`m_‰ì
(
m
);

1287 
	}
}

1290 
	$t˝_do›ti⁄s
(
t˝cb
 *
ç
, 
u_ch¨
 *
˝
, 
˙t
, 
t˝ùhdr
 *
ti
)

1292 
uöt16_t
 
mss
;

1293 
›t
, 
›éí
;

1295 
	`DEBUG_CALL
("tcp_dooptions");

1296 
	`DEBUG_ARGS
((
dfd
,"Å∞%lx c¡=%ò\n", ()
ç
, 
˙t
));

1298 ; 
˙t
 > 0; c¡ -
›éí
, 
˝
 += optlen) {

1299 
›t
 = 
˝
[0];

1300 i‡(
›t
 =
TCPOPT_EOL
)

1302 i‡(
›t
 =
TCPOPT_NOP
)

1303 
›éí
 = 1;

1305 
›éí
 = 
˝
[1];

1306 i‡(
›éí
 <= 0)

1309 
›t
) {

1314 
TCPOPT_MAXSEG
:

1315 i‡(
›éí
 !
TCPOLEN_MAXSEG
)

1317 i‡(!(
ti
->
ti_Êags
 & 
TH_SYN
))

1319 
	`mem˝y
((*Ë&
mss
, (*Ë
˝
 + 2, (mss));

1320 
	`NTOHS
(
mss
);

1321 (Ë
	`t˝_mss
(
ç
, 
mss
);

1325 
	}
}

1335 #ifde‡
nŸdef


1338 
	$t˝_puŒoutofb™d
(
so
, 
ti
, 
m
)

1339 
sockë
 *
so
;

1340 
t˝ùhdr
 *
ti
;

1341 
mbuf
 *
m
;

1343 
˙t
 = 
ti
->
ti_uΩ
 - 1;

1345 
˙t
 >= 0) {

1346 i‡(
m
->
m_Àn
 > 
˙t
) {

1347 *
˝
 = 
	`mtod
(
m
, 
ˇddr_t
Ë+ 
˙t
;

1348 
t˝cb
 *
ç
 = 
	`sŸŸ˝cb
(
so
);

1350 
ç
->
t_iobc
 = *
˝
;

1351 
ç
->
t_oobÊags
 |
TCPOOB_HAVEDATA
;

1352 
	`mem˝y
(
•
, 
˝
+1, ()(
m
->
m_Àn
 - 
˙t
 - 1));

1353 
m
->
m_Àn
--;

1356 
˙t
 -
m
->
m_Àn
;

1357 
m
 = m->
m_√xt
;

1358 i‡(
m
 == 0)

1361 
	`∑nic
("tcp_pulloutofband");

1362 
	}
}

1372 
	$t˝_xmô_timî
(
t˝cb
 *
ç
, 
πt
)

1374 
dñè
;

1376 
	`DEBUG_CALL
("tcp_xmit_timer");

1377 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

1378 
	`DEBUG_ARG
("πà%d", 
πt
);

1380 i‡(
ç
->
t_§â
 != 0) {

1388 
dñè
 = 
πt
 - 1 - (
ç
->
t_§â
 >> 
TCP_RTT_SHIFT
);

1389 i‡((
ç
->
t_§â
 +
dñè
) <= 0)

1390 
ç
->
t_§â
 = 1;

1401 i‡(
dñè
 < 0)

1402 
dñè
 = -delta;

1403 
dñè
 -(
ç
->
t_πtv¨
 >> 
TCP_RTTVAR_SHIFT
);

1404 i‡((
ç
->
t_πtv¨
 +
dñè
) <= 0)

1405 
ç
->
t_πtv¨
 = 1;

1412 
ç
->
t_§â
 = 
πt
 << 
TCP_RTT_SHIFT
;

1413 
ç
->
t_πtv¨
 = 
πt
 << (
TCP_RTTVAR_SHIFT
 - 1);

1415 
ç
->
t_πt
 = 0;

1416 
ç
->
t_rxtshi·
 = 0;

1429 
	`TCPT_RANGESET
(
ç
->
t_rxtcur
, 
	`TCP_REXMTVAL
(tp),

1430 ()
ç
->
t_πtmö
, 
TCPTV_REXMTMAX
);

1439 
ç
->
t_so·îr‹
 = 0;

1440 
	}
}

1459 
	$t˝_mss
(
t˝cb
 *
ç
, 
u_öt
 
of„r
)

1461 
sockë
 *
so
 = 
ç
->
t_sockë
;

1462 
mss
;

1464 
	`DEBUG_CALL
("tcp_mss");

1465 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

1466 
	`DEBUG_ARG
("of„∏%d", 
of„r
);

1468 
mss
 = 
	`mö
(
IF_MTU
, 
IF_MRU
Ë- (
t˝ùhdr
);

1469 i‡(
of„r
)

1470 
mss
 = 
	`mö
(mss, 
of„r
);

1471 
mss
 = 
	`max
(mss, 32);

1472 i‡(
mss
 < 
ç
->
t_max£g
 || 
of„r
 != 0)

1473 
ç
->
t_max£g
 = 
mss
;

1475 
ç
->
¢d_cwnd
 = 
mss
;

1477 
	`sbª£rve
(&
so
->
so_¢d
, 
TCP_SNDSPACE
 + ((TCP_SNDSPACE % 
mss
) ?

1478 (
mss
 - (
TCP_SNDSPACE
 % mss)) :

1480 
	`sbª£rve
(&
so
->
so_rcv
, 
TCP_RCVSPACE
 + ((TCP_RCVSPACE % 
mss
) ?

1481 (
mss
 - (
TCP_RCVSPACE
 % mss)) :

1484 
	`DEBUG_MISC
((
dfd
, "Ñëu∫ög ms†%d\n", 
mss
));

1486  
mss
;

1487 
	}
}

	@slirp/tcp_output.c

41 
	~"¶úp.h
"

43 c⁄° 
u_ch¨
 
	gt˝_outÊags
[
TCP_NSTATES
] = {

44 
TH_RST
|
TH_ACK
, 0, 
TH_SYN
, TH_SYN|TH_ACK,

45 
TH_ACK
, TH_ACK, 
TH_FIN
|TH_ACK, TH_FIN|TH_ACK,

46 
TH_FIN
|
TH_ACK
, TH_ACK, TH_ACK,

50 
	#MAX_TCPOPTLEN
 32

	)

56 
	$t˝_ouçut
(
t˝cb
 *
ç
)

58 
sockë
 *
so
 = 
ç
->
t_sockë
;

59 
Àn
, 
wö
;

60 
off
, 
Êags
, 
îr‹
;

61 
mbuf
 *
m
;

62 
t˝ùhdr
 *
ti
;

63 
u_ch¨
 
›t
[
MAX_TCPOPTLEN
];

64 
›éí
, 
hdæí
;

65 
idÀ
, 
£ndÆŸ
;

67 
	`DEBUG_CALL
("tcp_output");

68 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

76 
idÀ
 = (
ç
->
¢d_max
 =ç->
¢d_u«
);

77 i‡(
idÀ
 && 
ç
->
t_idÀ
 >ç->
t_rxtcur
)

83 
ç
->
¢d_cwnd
 =Åp->
t_max£g
;

84 
agaö
:

85 
£ndÆŸ
 = 0;

86 
off
 = 
ç
->
¢d_nxt
 -Åp->
¢d_u«
;

87 
wö
 = 
	`mö
(
ç
->
¢d_wnd
,Åp->
¢d_cwnd
);

89 
Êags
 = 
t˝_outÊags
[
ç
->
t_°©e
];

91 
	`DEBUG_MISC
((
dfd
, " ---Å˝_ouçuàÊag†0x%x\n",
Êags
));

99 i‡(
ç
->
t_f‹˚
) {

100 i‡(
wö
 == 0) {

117 i‡(
off
 < 
so
->
so_¢d
.
sb_cc
)

118 
Êags
 &~
TH_FIN
;

119 
wö
 = 1;

121 
ç
->
t_timî
[
TCPT_PERSIST
] = 0;

122 
ç
->
t_rxtshi·
 = 0;

126 
Àn
 = 
	`mö
(
so
->
so_¢d
.
sb_cc
, 
wö
Ë- 
off
;

128 i‡(
Àn
 < 0) {

139 
Àn
 = 0;

140 i‡(
wö
 == 0) {

141 
ç
->
t_timî
[
TCPT_REXMT
] = 0;

142 
ç
->
¢d_nxt
 =Åp->
¢d_u«
;

146 i‡(
Àn
 > 
ç
->
t_max£g
) {

147 
Àn
 = 
ç
->
t_max£g
;

148 
£ndÆŸ
 = 1;

150 i‡(
	`SEQ_LT
(
ç
->
¢d_nxt
 + 
Àn
,Åp->
¢d_u«
 + 
so
->
so_¢d
.
sb_cc
))

151 
Êags
 &~
TH_FIN
;

153 
wö
 = 
	`sb•a˚
(&
so
->
so_rcv
);

165 i‡(
Àn
) {

166 i‡(
Àn
 =
ç
->
t_max£g
)

167 
£nd
;

168 i‡((1 || 
idÀ
 || 
ç
->
t_Êags
 & 
TF_NODELAY
) &&

169 
Àn
 + 
off
 >
so
->
so_¢d
.
sb_cc
)

170 
£nd
;

171 i‡(
ç
->
t_f‹˚
)

172 
£nd
;

173 i‡(
Àn
 >
ç
->
max_¢dwnd
 / 2 &&Åp->max_sndwnd > 0)

174 
£nd
;

175 i‡(
	`SEQ_LT
(
ç
->
¢d_nxt
,Åp->
¢d_max
))

176 
£nd
;

186 i‡(
wö
 > 0) {

192 
adv
 = 
	`mö
(
wö
, ()
TCP_MAXWIN
 << 
ç
->
rcv_sˇÀ
) -

193 (
ç
->
rcv_adv
 -Åp->
rcv_nxt
);

195 i‡(
adv
 >(Ë(2 * 
ç
->
t_max£g
))

196 
£nd
;

197 i‡(2 * 
adv
 >(Ë
so
->
so_rcv
.
sb_d©Æí
)

198 
£nd
;

204 i‡(
ç
->
t_Êags
 & 
TF_ACKNOW
)

205 
£nd
;

206 i‡(
Êags
 & (
TH_SYN
|
TH_RST
))

207 
£nd
;

208 i‡(
	`SEQ_GT
(
ç
->
¢d_up
,Åp->
¢d_u«
))

209 
£nd
;

215 i‡(
Êags
 & 
TH_FIN
 &&

216 ((
ç
->
t_Êags
 & 
TF_SENTFIN
Ë=0 ||Åp->
¢d_nxt
 =ç->
¢d_u«
))

217 
£nd
;

241 i‡(
so
->
so_¢d
.
sb_cc
 && 
ç
->
t_timî
[
TCPT_REXMT
] == 0 &&

242 
ç
->
t_timî
[
TCPT_PERSIST
] == 0) {

243 
ç
->
t_rxtshi·
 = 0;

244 
	`t˝_£çîsi°
(
ç
);

252 
£nd
:

261 
›éí
 = 0;

262 
hdæí
 =  (
t˝ùhdr
);

263 i‡(
Êags
 & 
TH_SYN
) {

264 
ç
->
¢d_nxt
 =Åp->
iss
;

265 i‡((
ç
->
t_Êags
 & 
TF_NOOPT
) == 0) {

266 
uöt16_t
 
mss
;

268 
›t
[0] = 
TCPOPT_MAXSEG
;

269 
›t
[1] = 4;

270 
mss
 = 
	`ht⁄s
((
uöt16_t
Ë
	`t˝_mss
(
ç
, 0));

271 
	`mem˝y
((
ˇddr_t
)(
›t
 + 2), (ˇddr_t)&
mss
, (mss));

272 
›éí
 = 4;

276 
hdæí
 +
›éí
;

282 i‡(
Àn
 > 
ç
->
t_max£g
 - 
›éí
) {

283 
Àn
 = 
ç
->
t_max£g
 - 
›éí
;

284 
£ndÆŸ
 = 1;

292 i‡(
Àn
) {

293 
m
 = 
	`m_gë
(
so
->
¶úp
);

294 i‡(
m
 =
NULL
) {

295 
îr‹
 = 1;

296 
out
;

298 
m
->
m_d©a
 +
IF_MAXLINKHDR
;

299 
m
->
m_Àn
 = 
hdæí
;

301 
	`sbc›y
(&
so
->
so_¢d
, 
off
, (Ë
Àn
, 
	`mtod
(
m
, 
ˇddr_t
Ë+ 
hdæí
);

302 
m
->
m_Àn
 +
Àn
;

310 i‡(
off
 + 
Àn
 =
so
->
so_¢d
.
sb_cc
)

311 
Êags
 |
TH_PUSH
;

313 
m
 = 
	`m_gë
(
so
->
¶úp
);

314 i‡(
m
 =
NULL
) {

315 
îr‹
 = 1;

316 
out
;

318 
m
->
m_d©a
 +
IF_MAXLINKHDR
;

319 
m
->
m_Àn
 = 
hdæí
;

322 
ti
 = 
	`mtod
(
m
, 
t˝ùhdr
 *);

324 
	`mem˝y
((
ˇddr_t
)
ti
, &
ç
->
t_ãm∂©e
,  (
t˝ùhdr
));

331 i‡(
Êags
 & 
TH_FIN
 && 
ç
->
t_Êags
 & 
TF_SENTFIN
 &&

332 
ç
->
¢d_nxt
 =ç->
¢d_max
)

333 
ç
->
¢d_nxt
--;

347 i‡(
Àn
 || (
Êags
 & (
TH_SYN
|
TH_FIN
)Ë|| 
ç
->
t_timî
[
TCPT_PERSIST
])

348 
ti
->
ti_£q
 = 
	`ht⁄l
(
ç
->
¢d_nxt
);

350 
ti
->
ti_£q
 = 
	`ht⁄l
(
ç
->
¢d_max
);

351 
ti
->
ti_ack
 = 
	`ht⁄l
(
ç
->
rcv_nxt
);

352 i‡(
›éí
) {

353 
	`mem˝y
((
ˇddr_t
)(
ti
 + 1), (ˇddr_t)
›t
, 
›éí
);

354 
ti
->
ti_off
 = ( (
t˝hdr
Ë+ 
›éí
) >> 2;

356 
ti
->
ti_Êags
 = 
Êags
;

361 i‡(
wö
 < ()(
so
->
so_rcv
.
sb_d©Æí
 / 4Ë&& wö < ()
ç
->
t_max£g
)

362 
wö
 = 0;

363 i‡(
wö
 > ()
TCP_MAXWIN
 << 
ç
->
rcv_sˇÀ
)

364 
wö
 = ()
TCP_MAXWIN
 << 
ç
->
rcv_sˇÀ
;

365 i‡(
wö
 < ()(
ç
->
rcv_adv
 -Åp->
rcv_nxt
))

366 
wö
 = ()(
ç
->
rcv_adv
 -Åp->
rcv_nxt
);

367 
ti
->
ti_wö
 = 
	`ht⁄s
((
uöt16_t
Ë(
wö
>>
ç
->
rcv_sˇÀ
));

369 i‡(
	`SEQ_GT
(
ç
->
¢d_up
,Åp->
¢d_u«
)) {

370 
ti
->
ti_uΩ
 = 
	`ht⁄s
((
uöt16_t
)(
ç
->
¢d_up
 - 
	`¡ohl
—i->
ti_£q
)));

371 
ti
->
ti_Êags
 |
TH_URG
;

379 
ç
->
¢d_up
 =Åp->
¢d_u«
;

385 i‡(
Àn
 + 
›éí
)

386 
ti
->
ti_Àn
 = 
	`ht⁄s
((
uöt16_t
)( (
t˝hdr
) +

387 
›éí
 + 
Àn
));

388 
ti
->
ti_sum
 = 
	`cksum
(
m
, ()(
hdæí
 + 
Àn
));

394 i‡(
ç
->
t_f‹˚
 =0 ||Åp->
t_timî
[
TCPT_PERSIST
] == 0) {

395 
t˝_£q
 
°¨t£q
 = 
ç
->
¢d_nxt
;

400 i‡(
Êags
 & (
TH_SYN
|
TH_FIN
)) {

401 i‡(
Êags
 & 
TH_SYN
)

402 
ç
->
¢d_nxt
++;

403 i‡(
Êags
 & 
TH_FIN
) {

404 
ç
->
¢d_nxt
++;

405 
ç
->
t_Êags
 |
TF_SENTFIN
;

408 
ç
->
¢d_nxt
 +
Àn
;

409 i‡(
	`SEQ_GT
(
ç
->
¢d_nxt
,Åp->
¢d_max
)) {

410 
ç
->
¢d_max
 =Åp->
¢d_nxt
;

415 i‡(
ç
->
t_πt
 == 0) {

416 
ç
->
t_πt
 = 1;

417 
ç
->
t_π£q
 = 
°¨t£q
;

429 i‡(
ç
->
t_timî
[
TCPT_REXMT
] == 0 &&

430 
ç
->
¢d_nxt
 !ç->
¢d_u«
) {

431 
ç
->
t_timî
[
TCPT_REXMT
] =Åp->
t_rxtcur
;

432 i‡(
ç
->
t_timî
[
TCPT_PERSIST
]) {

433 
ç
->
t_timî
[
TCPT_PERSIST
] = 0;

434 
ç
->
t_rxtshi·
 = 0;

438 i‡(
	`SEQ_GT
(
ç
->
¢d_nxt
 + 
Àn
,Åp->
¢d_max
))

439 
ç
->
¢d_max
 =Åp->
¢d_nxt
 + 
Àn
;

447 
m
->
m_Àn
 = 
hdæí
 + 
Àn
;

451 ((
ù
 *)
ti
)->
ù_Àn
 = 
m
->
m_Àn
;

453 ((
ù
 *)
ti
)->
ù_âl
 = 
IPDEFTTL
;

454 ((
ù
 *)
ti
)->
ù_tos
 = 
so
->
so_ùtos
;

456 
îr‹
 = 
	`ù_ouçut
(
so
, 
m
);

458 i‡(
îr‹
) {

459 
out
:

460  (
îr‹
);

469 i‡(
wö
 > 0 && 
	`SEQ_GT
(
ç
->
rcv_nxt
+wö,Åp->
rcv_adv
))

470 
ç
->
rcv_adv
 =Åp->
rcv_nxt
 + 
wö
;

471 
ç
->
œ°_ack_£¡
 =Åp->
rcv_nxt
;

472 
ç
->
t_Êags
 &~(
TF_ACKNOW
|
TF_DELACK
);

473 i‡(
£ndÆŸ
)

474 
agaö
;

477 
	}
}

480 
	$t˝_£çîsi°
(
t˝cb
 *
ç
)

482 
t
 = ((
ç
->
t_§â
 >> 2Ë+Åp->
t_πtv¨
) >> 1;

487 
	`TCPT_RANGESET
(
ç
->
t_timî
[
TCPT_PERSIST
],

488 
t
 * 
t˝_backoff
[
ç
->
t_rxtshi·
],

489 
TCPTV_PERSMIN
, 
TCPTV_PERSMAX
);

490 i‡(
ç
->
t_rxtshi·
 < 
TCP_MAXRXTSHIFT
)

491 
ç
->
t_rxtshi·
++;

492 
	}
}

	@slirp/tcp_subr.c

41 
	~"¶úp.h
"

45 
	#TCP_DO_RFC1323
 0

	)

51 
	$t˝_öô
(
Slúp
 *
¶úp
)

53 
¶úp
->
t˝_iss
 = 1;

54 
¶úp
->
tcb
.
so_√xt
 = slúp->tcb.
so_¥ev
 = &slirp->tcb;

55 
¶úp
->
t˝_œ°_so
 = &¶úp->
tcb
;

56 
	}
}

65 
	$t˝_ãm∂©e
(
t˝cb
 *
ç
)

67 
sockë
 *
so
 = 
ç
->
t_sockë
;

68 
t˝ùhdr
 *
n
 = &
ç
->
t_ãm∂©e
;

70 
n
->
ti_mbuf
 = 
NULL
;

71 
n
->
ti_x1
 = 0;

72 
n
->
ti_¥
 = 
IPPROTO_TCP
;

73 
n
->
ti_Àn
 = 
	`ht⁄s
( (
t˝ùhdr
Ë-  (
ù
));

74 
n
->
ti_§c
 = 
so
->
so_Áddr
;

75 
n
->
ti_d°
 = 
so
->
so_œddr
;

76 
n
->
ti_•‹t
 = 
so
->
so_Â‹t
;

77 
n
->
ti_dp‹t
 = 
so
->
so_Õ‹t
;

79 
n
->
ti_£q
 = 0;

80 
n
->
ti_ack
 = 0;

81 
n
->
ti_x2
 = 0;

82 
n
->
ti_off
 = 5;

83 
n
->
ti_Êags
 = 0;

84 
n
->
ti_wö
 = 0;

85 
n
->
ti_sum
 = 0;

86 
n
->
ti_uΩ
 = 0;

87 
	}
}

103 
	$t˝_ª•⁄d
(
t˝cb
 *
ç
, 
t˝ùhdr
 *
ti
, 
mbuf
 *
m
,

104 
t˝_£q
 
ack
,Å˝_£q 
£q
, 
Êags
)

106 
éí
;

107 
wö
 = 0;

109 
	`DEBUG_CALL
("tcp_respond");

110 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

111 
	`DEBUG_ARG
("tò%lx", ()
ti
);

112 
	`DEBUG_ARG
("m = %lx", ()
m
);

113 
	`DEBUG_ARG
("ack = %u", 
ack
);

114 
	`DEBUG_ARG
("£q = %u", 
£q
);

115 
	`DEBUG_ARG
("Êag†%x", 
Êags
);

117 i‡(
ç
)

118 
wö
 = 
	`sb•a˚
(&
ç
->
t_sockë
->
so_rcv
);

119 i‡(
m
 =
NULL
) {

120 i‡((
m
 = 
	`m_gë
(
ç
->
t_sockë
->
¶úp
)Ë=
NULL
)

122 
éí
 = 0;

123 
m
->
m_d©a
 +
IF_MAXLINKHDR
;

124 *
	`mtod
(
m
, 
t˝ùhdr
 *Ë*
ti
;

125 
ti
 = 
	`mtod
(
m
, 
t˝ùhdr
 *);

126 
Êags
 = 
TH_ACK
;

132 
m
->
m_d©a
 = (
ˇddr_t
)
ti
;

134 
m
->
m_Àn
 =  (
t˝ùhdr
);

135 
éí
 = 0;

136 
	#xchg
(
a
,
b
,
ty≥
Ë{Åy≥ 
t
;Å˜;á=b; bÒ; }

	)

137 
	`xchg
(
ti
->
ti_d°
.
s_addr
,Åi->
ti_§c
.s_addr, 
uöt32_t
);

138 
	`xchg
(
ti
->
ti_dp‹t
,Åi->
ti_•‹t
, 
uöt16_t
);

139 #unde‡
xchg


141 
ti
->
ti_Àn
 = 
	`ht⁄s
((
u_sh‹t
)( (
t˝hdr
Ë+ 
éí
));

142 
éí
 + (
t˝ùhdr
);

143 
m
->
m_Àn
 = 
éí
;

145 
ti
->
ti_mbuf
 = 
NULL
;

146 
ti
->
ti_x1
 = 0;

147 
ti
->
ti_£q
 = 
	`ht⁄l
(
£q
);

148 
ti
->
ti_ack
 = 
	`ht⁄l
(
ack
);

149 
ti
->
ti_x2
 = 0;

150 
ti
->
ti_off
 =  (
t˝hdr
) >> 2;

151 
ti
->
ti_Êags
 = 
Êags
;

152 i‡(
ç
)

153 
ti
->
ti_wö
 = 
	`ht⁄s
((
uöt16_t
Ë(
wö
 >> 
ç
->
rcv_sˇÀ
));

155 
ti
->
ti_wö
 = 
	`ht⁄s
((
uöt16_t
)
wö
);

156 
ti
->
ti_uΩ
 = 0;

157 
ti
->
ti_sum
 = 0;

158 
ti
->
ti_sum
 = 
	`cksum
(
m
, 
éí
);

159 ((
ù
 *)
ti
)->
ù_Àn
 = 
éí
;

161 if(
Êags
 & 
TH_RST
)

162 ((
ù
 *)
ti
)->
ù_âl
 = 
MAXTTL
;

164 ((
ù
 *)
ti
)->
ù_âl
 = 
IPDEFTTL
;

166 (Ë
	`ù_ouçut
((
sockë
 *)0, 
m
);

167 
	}
}

174 
t˝cb
 *

175 
	$t˝_√wt˝cb
(
sockë
 *
so
)

177 
t˝cb
 *
ç
;

179 
ç
 = (
t˝cb
 *)
	`mÆloc
((*tp));

180 i‡(
ç
 =
NULL
)

181  ((
t˝cb
 *)0);

183 
	`mem£t
((*Ë
ç
, 0, (
t˝cb
));

184 
ç
->
£g_√xt
 =Åp->
£g_¥ev
 = (
t˝ùhdr
*)tp;

185 
ç
->
t_max£g
 = 
TCP_MSS
;

187 
ç
->
t_Êags
 = 
TCP_DO_RFC1323
 ? (
TF_REQ_SCALE
|
TF_REQ_TSTMP
) : 0;

188 
ç
->
t_sockë
 = 
so
;

195 
ç
->
t_§â
 = 
TCPTV_SRTTBASE
;

196 
ç
->
t_πtv¨
 = 
TCPTV_SRTTDFLT
 << 2;

197 
ç
->
t_πtmö
 = 
TCPTV_MIN
;

199 
	`TCPT_RANGESET
(
ç
->
t_rxtcur
,

200 ((
TCPTV_SRTTBASE
 >> 2Ë+ (
TCPTV_SRTTDFLT
 << 2)) >> 1,

201 
TCPTV_MIN
, 
TCPTV_REXMTMAX
);

203 
ç
->
¢d_cwnd
 = 
TCP_MAXWIN
 << 
TCP_MAX_WINSHIFT
;

204 
ç
->
¢d_s°hªsh
 = 
TCP_MAXWIN
 << 
TCP_MAX_WINSHIFT
;

205 
ç
->
t_°©e
 = 
TCPS_CLOSED
;

207 
so
->
so_t˝cb
 = 
ç
;

209  (
ç
);

210 
	}
}

217 
t˝cb
 *
	$t˝_dr›
(
t˝cb
 *
ç
, 
îr
)

219 
	`DEBUG_CALL
("tcp_drop");

220 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

221 
	`DEBUG_ARG
("î∫ÿ%d", 
î∫o
);

223 i‡(
	`TCPS_HAVERCVDSYN
(
ç
->
t_°©e
)) {

224 
ç
->
t_°©e
 = 
TCPS_CLOSED
;

225 (Ë
	`t˝_ouçut
(
ç
);

227  (
	`t˝_˛o£
(
ç
));

228 
	}
}

236 
t˝cb
 *

237 
	$t˝_˛o£
(
t˝cb
 *
ç
)

239 
t˝ùhdr
 *
t
;

240 
sockë
 *
so
 = 
ç
->
t_sockë
;

241 
Slúp
 *
¶úp
 = 
so
->slirp;

242 
mbuf
 *
m
;

244 
	`DEBUG_CALL
("tcp_close");

245 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

248 
t
 = 
	`t˝‰ag_li°_fú°
(
ç
);

249 !
	`t˝‰ag_li°_íd
(
t
, 
ç
)) {

250 
t
 = 
	`t˝ùhdr_√xt
(t);

251 
m
 = 
	`t˝ùhdr_¥ev
(
t
)->
ti_mbuf
;

252 
	`ªmque
(
	`t˝ùhdr2qlök
(
	`t˝ùhdr_¥ev
(
t
)));

253 
	`m_‰ìm
(
m
);

255 
	`‰ì
(
ç
);

256 
so
->
so_t˝cb
 = 
NULL
;

258 i‡(
so
 =
¶úp
->
t˝_œ°_so
)

259 
¶úp
->
t˝_œ°_so
 = &¶úp->
tcb
;

260 
	`˛o£sockë
(
so
->
s
);

261 
	`sb‰ì
(&
so
->
so_rcv
);

262 
	`sb‰ì
(&
so
->
so_¢d
);

263 
	`so‰ì
(
so
);

264  ((
t˝cb
 *)0);

265 
	}
}

282 
	$t˝_sock˛o£d
(
t˝cb
 *
ç
)

285 
	`DEBUG_CALL
("tcp_sockclosed");

286 
	`DEBUG_ARG
("ç = %lx", ()
ç
);

288 
ç
->
t_°©e
) {

290 
TCPS_CLOSED
:

291 
TCPS_LISTEN
:

292 
TCPS_SYN_SENT
:

293 
ç
->
t_°©e
 = 
TCPS_CLOSED
;

294 
ç
 = 
	`t˝_˛o£
(tp);

297 
TCPS_SYN_RECEIVED
:

298 
TCPS_ESTABLISHED
:

299 
ç
->
t_°©e
 = 
TCPS_FIN_WAIT_1
;

302 
TCPS_CLOSE_WAIT
:

303 
ç
->
t_°©e
 = 
TCPS_LAST_ACK
;

306 i‡(
ç
)

307 
	`t˝_ouçut
(
ç
);

308 
	}
}

320 
	$t˝_fc⁄√˘
(
sockë
 *
so
)

322 
Slúp
 *
¶úp
 = 
so
->slirp;

323 
ªt
=0;

325 
	`DEBUG_CALL
("tcp_fconnect");

326 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

328 if–(
ªt
 = 
so
->
s
 = 
	`os_sockë
(
AF_INET
,
SOCK_STREAM
,0)) >= 0) {

329 
›t
, 
s
=
so
->s;

330 
sockaddr_ö
 
addr
;

332 
	`fd_n⁄block
(
s
);

333 
›t
 = 1;

334 
	`£tsock›t
(
s
,
SOL_SOCKET
,
SO_REUSEADDR
,(*)&
›t
,(opt ));

335 
›t
 = 1;

336 
	`£tsock›t
(
s
,
SOL_SOCKET
,
SO_OOBINLINE
,(*)&
›t
,(opt ));

338 
addr
.
sö_Ámûy
 = 
AF_INET
;

339 i‡((
so
->
so_Áddr
.
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) ==

340 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

342 i‡(
so
->
so_Áddr
.
s_addr
 =
¶úp
->
v«me£rvî_addr
.s_addr) {

343 i‡(
	`gë_dns_addr
(&
addr
.
sö_addr
) < 0)

344 
addr
.
sö_addr
 = 
lo›back_addr
;

346 
addr
.
sö_addr
 = 
lo›back_addr
;

349 
addr
.
sö_addr
 = 
so
->
so_Áddr
;

350 
addr
.
sö_p‹t
 = 
so
->
so_Â‹t
;

352 
	`DEBUG_MISC
((
dfd
, " connect()ing,áddr.sin_port=%d, "

354 
	`¡ohs
(
addr
.
sö_p‹t
), 
	`öë_¡ﬂ
◊ddr.
sö_addr
)));

356 
ªt
 = 
	`c⁄√˘
(
s
,(
sockaddr
 *)&
addr
, (addr));

362 
	`soisfc⁄√˘ög
(
so
);

365 (
ªt
);

366 
	}
}

381 
	$t˝_c⁄√˘
(
sockë
 *
öso
)

383 
Slúp
 *
¶úp
 = 
öso
->slirp;

384 
sockë
 *
so
;

385 
sockaddr_ö
 
addr
;

386 
sockÀn_t
 
addæí
 = (
sockaddr_ö
);

387 
t˝cb
 *
ç
;

388 
s
, 
›t
;

390 
	`DEBUG_CALL
("tcp_connect");

391 
	`DEBUG_ARG
("ösÿ%lx", ()
öso
);

397 i‡(
öso
->
so_°©e
 & 
SS_FACCEPTONCE
) {

399 
so
 = 
öso
;

401 i‡((
so
 = 
	`so¸óã
(
¶úp
)Ë=
NULL
) {

403 
	`˛o£sockë
(
	`ac˚±
(
öso
->
s
,(
sockaddr
 *)&
addr
,&
addæí
));

406 i‡(
	`t˝_©èch
(
so
) < 0) {

407 
	`‰ì
(
so
);

410 
so
->
so_œddr
 = 
öso
->so_laddr;

411 
so
->
so_Õ‹t
 = 
öso
->so_lport;

414 (Ë
	`t˝_mss
(
	`sŸŸ˝cb
(
so
), 0);

416 i‡((
s
 = 
	`ac˚±
(
öso
->s,(
sockaddr
 *)&
addr
,&
addæí
)) < 0) {

417 
	`t˝_˛o£
(
	`sŸŸ˝cb
(
so
));

420 
	`fd_n⁄block
(
s
);

421 
›t
 = 1;

422 
	`£tsock›t
(
s
,
SOL_SOCKET
,
SO_REUSEADDR
,(*)&
›t
,());

423 
›t
 = 1;

424 
	`£tsock›t
(
s
,
SOL_SOCKET
,
SO_OOBINLINE
,(*)&
›t
,());

425 
›t
 = 1;

426 
	`£tsock›t
(
s
,
IPPROTO_TCP
,
TCP_NODELAY
,(*)&
›t
,());

428 
so
->
so_Â‹t
 = 
addr
.
sö_p‹t
;

429 
so
->
so_Áddr
 = 
addr
.
sö_addr
;

431 i‡(
so
->
so_Áddr
.
s_addr
 =0 || so->so_Áddr.s_add∏=
lo›back_addr
.s_addr)

432 
so
->
so_Áddr
 = 
¶úp
->
vho°_addr
;

435 i‡(
öso
->
so_°©e
 & 
SS_FACCEPTONCE
) {

436 
	`˛o£sockë
(
so
->
s
);

437 
so
->
so_°©e
 = 
SS_NOFDREF
;

440 
so
->
s
 = s;

441 
so
->
so_°©e
 |
SS_INCOMING
;

443 
so
->
so_ùtos
 = 
	`t˝_tos
(so);

444 
ç
 = 
	`sŸŸ˝cb
(
so
);

446 
	`t˝_ãm∂©e
(
ç
);

448 
ç
->
t_°©e
 = 
TCPS_SYN_SENT
;

449 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEP_INIT
;

450 
ç
->
iss
 = 
¶úp
->
t˝_iss
;

451 
¶úp
->
t˝_iss
 +
TCP_ISSINCR
/2;

452 
	`t˝_£nd£qöô
(
ç
);

453 
	`t˝_ouçut
(
ç
);

454 
	}
}

460 
	$t˝_©èch
(
sockë
 *
so
)

462 i‡((
so
->
so_t˝cb
 = 
	`t˝_√wt˝cb
(so)Ë=
NULL
)

465 
	`ösque
(
so
, &so->
¶úp
->
tcb
);

468 
	}
}

473 c⁄° 
tos_t
 
	gt˝tos
[] = {

474 {0, 20, 
IPTOS_THROUGHPUT
, 0},

475 {21, 21, 
IPTOS_LOWDELAY
, 
EMU_FTP
},

476 {0, 23, 
IPTOS_LOWDELAY
, 0},

477 {0, 80, 
IPTOS_THROUGHPUT
, 0},

478 {0, 513, 
IPTOS_LOWDELAY
, 
EMU_RLOGIN
|
EMU_NOCONNECT
},

479 {0, 514, 
IPTOS_LOWDELAY
, 
EMU_RSH
|
EMU_NOCONNECT
},

480 {0, 544, 
IPTOS_LOWDELAY
, 
EMU_KSH
},

481 {0, 543, 
IPTOS_LOWDELAY
, 0},

482 {0, 6667, 
IPTOS_THROUGHPUT
, 
EMU_IRC
},

483 {0, 6668, 
IPTOS_THROUGHPUT
, 
EMU_IRC
},

484 {0, 7070, 
IPTOS_LOWDELAY
, 
EMU_REALAUDIO
 },

485 {0, 113, 
IPTOS_LOWDELAY
, 
EMU_IDENT
 },

489 
emu_t
 *
	gt˝emu
 = 
NULL
;

494 
uöt8_t


495 
	$t˝_tos
(
sockë
 *
so
)

497 
i
 = 0;

498 
emu_t
 *
emup
;

500 
t˝tos
[
i
].
tos
) {

501 i‡((
t˝tos
[
i
].
Â‹t
 && (
	`¡ohs
(
so
->
so_Â‹t
) ==Åcptos[i].fport)) ||

502 (
t˝tos
[
i
].
Õ‹t
 && (
	`¡ohs
(
so
->
so_Õ‹t
) ==Åcptos[i].lport))) {

503 
so
->
so_emu
 = 
t˝tos
[
i
].
emu
;

504  
t˝tos
[
i
].
tos
;

506 
i
++;

510 
emup
 = 
t˝emu
;Émup;Ému∞emup->
√xt
) {

511 i‡((
emup
->
Â‹t
 && (
	`¡ohs
(
so
->
so_Â‹t
) ==Émup->fport)) ||

512 (
emup
->
Õ‹t
 && (
	`¡ohs
(
so
->
so_Õ‹t
) ==Émup->lport))) {

513 
so
->
so_emu
 = 
emup
->
emu
;

514  
emup
->
tos
;

519 
	}
}

546 
	$t˝_emu
(
sockë
 *
so
, 
mbuf
 *
m
)

548 
Slúp
 *
¶úp
 = 
so
->slirp;

549 
u_öt
 
n1
, 
n2
, 
n3
, 
n4
, 
n5
, 
n6
;

550 
buff
[257];

551 
uöt32_t
 
œddr
;

552 
u_öt
 
Õ‹t
;

553 *
b±r
;

555 
	`DEBUG_CALL
("tcp_emu");

556 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

557 
	`DEBUG_ARG
("m = %lx", ()
m
);

559 
so
->
so_emu
) {

560 
x
, 
i
;

562 
EMU_IDENT
:

568 
sockë
 *
tmpso
;

569 
sockaddr_ö
 
addr
;

570 
sockÀn_t
 
addæí
 = (
sockaddr_ö
);

571 
sbuf
 *
so_rcv
 = &
so
->so_rcv;

573 
	`mem˝y
(
so_rcv
->
sb_w±r
, 
m
->
m_d©a
, m->
m_Àn
);

574 
so_rcv
->
sb_w±r
 +
m
->
m_Àn
;

575 
so_rcv
->
sb_Ωå
 +
m
->
m_Àn
;

576 
m
->
m_d©a
[m->
m_Àn
] = 0;

577 i‡(
	`°rchr
(
m
->
m_d©a
, '\r') || strchr(m->m_data, '\n')) {

578 i‡(
	`ssˇnf
(
so_rcv
->
sb_d©a
, "%u%*[ ,]%u", &
n1
, &
n2
) == 2) {

579 
	`HTONS
(
n1
);

580 
	`HTONS
(
n2
);

582 
tmpso
 = 
¶úp
->
tcb
.
so_√xt
;

583 
tmpso
 !&
¶úp
->
tcb
;

584 
tmpso
 =Åmpso->
so_√xt
) {

585 i‡(
tmpso
->
so_œddr
.
s_addr
 =
so
->so_laddr.s_addr &&

586 
tmpso
->
so_Õ‹t
 =
n2
 &&

587 
tmpso
->
so_Áddr
.
s_addr
 =
so
->so_faddr.s_addr &&

588 
tmpso
->
so_Â‹t
 =
n1
) {

589 i‡(
	`gësock«me
(
tmpso
->
s
,

590 (
sockaddr
 *)&
addr
, &
addæí
) == 0)

591 
n2
 = 
	`¡ohs
(
addr
.
sö_p‹t
);

596 
so_rcv
->
sb_cc
 = 
	`¢¥ötf
(so_rcv->
sb_d©a
,

597 
so_rcv
->
sb_d©Æí
,

598 "%d,%d\r\n", 
n1
, 
n2
);

599 
so_rcv
->
sb_Ωå
 = so_rcv->
sb_d©a
;

600 
so_rcv
->
sb_w±r
 = so_rcv->
sb_d©a
 + so_rcv->
sb_cc
;

602 
	`m_‰ì
(
m
);

606 
EMU_FTP
:

607 *(
m
->
m_d©a
+m->
m_Àn
) = 0;

608 i‡((
b±r
 = (*)
	`°r°r
(
m
->
m_d©a
, "ORT")Ë!
NULL
) {

612 
x
 = 
	`ssˇnf
(
b±r
, "ORT %u,%u,%u,%u,%u,%u\r\n%256[^\177]",

613 &
n1
, &
n2
, &
n3
, &
n4
, &
n5
, &
n6
, 
buff
);

614 i‡(
x
 < 6)

617 
œddr
 = 
	`ht⁄l
((
n1
 << 24Ë| (
n2
 << 16Ë| (
n3
 << 8Ë| (
n4
));

618 
Õ‹t
 = 
	`ht⁄s
((
n5
 << 8Ë| (
n6
));

620 i‡((
so
 = 
	`t˝_li°í
(
¶úp
, 
INADDR_ANY
, 0, 
œddr
,

621 
Õ‹t
, 
SS_FACCEPTONCE
)Ë=
NULL
) {

624 
n6
 = 
	`¡ohs
(
so
->
so_Â‹t
);

626 
n5
 = (
n6
 >> 8) & 0xff;

627 
n6
 &= 0xff;

629 
œddr
 = 
	`¡ohl
(
so
->
so_Áddr
.
s_addr
);

631 
n1
 = ((
œddr
 >> 24) & 0xff);

632 
n2
 = ((
œddr
 >> 16) & 0xff);

633 
n3
 = ((
œddr
 >> 8) & 0xff);

634 
n4
 = (
œddr
 & 0xff);

636 
m
->
m_Àn
 = 
b±r
 - m->
m_d©a
;

637 
m
->
m_Àn
 +
	`¢¥ötf
(
b±r
, m->
m_hdr
.
mh_size
 - m->m_len,

639 
n1
, 
n2
, 
n3
, 
n4
, 
n5
, 
n6
, 
x
==7?
buff
:"");

641 } i‡((
b±r
 = (*)
	`°r°r
(
m
->
m_d©a
, "27 E¡îög")Ë!
NULL
) {

645 
x
 = 
	`ssˇnf
(
b±r
, "27 Entering Passive Mode (%u,%u,%u,%u,%u,%u)\r\n%256[^\177]",

646 &
n1
, &
n2
, &
n3
, &
n4
, &
n5
, &
n6
, 
buff
);

647 i‡(
x
 < 6)

650 
œddr
 = 
	`ht⁄l
((
n1
 << 24Ë| (
n2
 << 16Ë| (
n3
 << 8Ë| (
n4
));

651 
Õ‹t
 = 
	`ht⁄s
((
n5
 << 8Ë| (
n6
));

653 i‡((
so
 = 
	`t˝_li°í
(
¶úp
, 
INADDR_ANY
, 0, 
œddr
,

654 
Õ‹t
, 
SS_FACCEPTONCE
)Ë=
NULL
) {

657 
n6
 = 
	`¡ohs
(
so
->
so_Â‹t
);

659 
n5
 = (
n6
 >> 8) & 0xff;

660 
n6
 &= 0xff;

662 
œddr
 = 
	`¡ohl
(
so
->
so_Áddr
.
s_addr
);

664 
n1
 = ((
œddr
 >> 24) & 0xff);

665 
n2
 = ((
œddr
 >> 16) & 0xff);

666 
n3
 = ((
œddr
 >> 8) & 0xff);

667 
n4
 = (
œddr
 & 0xff);

669 
m
->
m_Àn
 = 
b±r
 - m->
m_d©a
;

670 
m
->
m_Àn
 +
	`¢¥ötf
(
b±r
, m->
m_hdr
.
mh_size
 - m->m_len,

672 
n1
, 
n2
, 
n3
, 
n4
, 
n5
, 
n6
, 
x
==7?
buff
:"");

679 
EMU_KSH
:

686 
so
->
so_emu
 = 0;

687 
Õ‹t
 = 0, 
i
 = 0; i < 
m
->
m_Àn
-1; ++i) {

688 i‡(
m
->
m_d©a
[
i
] < '0' || m->m_data[i] > '9')

690 
Õ‹t
 *= 10;

691 
Õ‹t
 +
m
->
m_d©a
[
i
] - '0';

693 i‡(
m
->
m_d©a
[m->
m_Àn
-1] ='\0' && 
Õ‹t
 != 0 &&

694 (
so
 = 
	`t˝_li°í
(
¶úp
, 
INADDR_ANY
, 0, so->
so_œddr
.
s_addr
,

695 
	`ht⁄s
(
Õ‹t
), 
SS_FACCEPTONCE
)Ë!
NULL
)

696 
m
->
m_Àn
 = 
	`¢¥ötf
(m->
m_d©a
, m->
m_hdr
.
mh_size
, "%d",

697 
	`¡ohs
(
so
->
so_Â‹t
)) + 1;

700 
EMU_IRC
:

704 *(
m
->
m_d©a
+m->
m_Àn
) = 0;

705 i‡((
b±r
 = (*)
	`°r°r
(
m
->
m_d©a
, "DCC")Ë=
NULL
)

709 i‡(
	`ssˇnf
(
b±r
, "DCC CHAT %256†%u %u", 
buff
, &
œddr
, &
Õ‹t
) == 3) {

710 i‡((
so
 = 
	`t˝_li°í
(
¶úp
, 
INADDR_ANY
, 0,

711 
	`ht⁄l
(
œddr
), 
	`ht⁄s
(
Õ‹t
),

712 
SS_FACCEPTONCE
)Ë=
NULL
) {

715 
m
->
m_Àn
 = 
b±r
 - m->
m_d©a
;

716 
m
->
m_Àn
 +
	`¢¥ötf
(
b±r
, m->
m_hdr
.
mh_size
,

718 ()
	`¡ohl
(
so
->
so_Áddr
.
s_addr
),

719 
	`¡ohs
(
so
->
so_Â‹t
), 1);

720 } i‡(
	`ssˇnf
(
b±r
, "DCC SEND %256†%u %u %u", 
buff
, &
œddr
, &
Õ‹t
, &
n1
) == 4) {

721 i‡((
so
 = 
	`t˝_li°í
(
¶úp
, 
INADDR_ANY
, 0,

722 
	`ht⁄l
(
œddr
), 
	`ht⁄s
(
Õ‹t
),

723 
SS_FACCEPTONCE
)Ë=
NULL
) {

726 
m
->
m_Àn
 = 
b±r
 - m->
m_d©a
;

727 
m
->
m_Àn
 +
	`¢¥ötf
(
b±r
, m->
m_hdr
.
mh_size
,

728 "DCC SEND %†%lu %u %u%c\n", 
buff
,

729 ()
	`¡ohl
(
so
->
so_Áddr
.
s_addr
),

730 
	`¡ohs
(
so
->
so_Â‹t
), 
n1
, 1);

731 } i‡(
	`ssˇnf
(
b±r
, "DCC MOVE %256†%u %u %u", 
buff
, &
œddr
, &
Õ‹t
, &
n1
) == 4) {

732 i‡((
so
 = 
	`t˝_li°í
(
¶úp
, 
INADDR_ANY
, 0,

733 
	`ht⁄l
(
œddr
), 
	`ht⁄s
(
Õ‹t
),

734 
SS_FACCEPTONCE
)Ë=
NULL
) {

737 
m
->
m_Àn
 = 
b±r
 - m->
m_d©a
;

738 
m
->
m_Àn
 +
	`¢¥ötf
(
b±r
, m->
m_hdr
.
mh_size
,

739 "DCC MOVE %†%lu %u %u%c\n", 
buff
,

740 ()
	`¡ohl
(
so
->
so_Áddr
.
s_addr
),

741 
	`¡ohs
(
so
->
so_Â‹t
), 
n1
, 1);

745 
EMU_REALAUDIO
:

782 
b±r
 = 
m
->
m_d©a
;

783 
b±r
 < 
m
->
m_d©a
 + m->
m_Àn
) {

784 
u_sh‹t
 
p
;

785 
ø
 = 0;

786 
ø_tbl
[4];

788 
ø_tbl
[0] = 0x50;

789 
ø_tbl
[1] = 0x4e;

790 
ø_tbl
[2] = 0x41;

791 
ø_tbl
[3] = 0;

793 
ø
) {

797 i‡(*
b±r
++ !
ø_tbl
[
ø
]) {

798 
ø
 = 0;

807 i‡(*
b±r
 == 0x50) {

808 
ø
 = 1;

809 
b±r
++;

811 } i‡(*
b±r
++ !
ø_tbl
[
ø
]) {

812 
ø
 = 0;

821 
b±r
++;

830 i‡(*(
b±r
 + 1) == 0x02)

831 
b±r
 += 8;

833 
b±r
 += 4;

840 
Õ‹t
 = (((
u_ch¨
*)
b±r
)[0] << 8)

841 + ((
u_ch¨
 *)
b±r
)[1];

842 i‡(
Õ‹t
 < 6970)

843 
Õ‹t
 += 256;

844 i‡(
Õ‹t
 < 6970 ||Üport > 7170)

848 
p
 = 6970;Ö < 7071;Ö++) {

849 i‡(
	`udp_li°í
(
¶úp
, 
INADDR_ANY
,

850 
	`ht⁄s
(
p
),

851 
so
->
so_œddr
.
s_addr
,

852 
	`ht⁄s
(
Õ‹t
),

853 
SS_FACCEPTONCE
)) {

857 i‡(
p
 == 7071)

858 
p
 = 0;

859 *(
u_ch¨
 *)
b±r
++ = (
p
 >> 8) & 0xff;

860 *(
u_ch¨
 *)
b±r
 = 
p
 & 0xff;

861 
ø
 = 0;

866 
ø
 = 0;

868 
ø
++;

874 
so
->
so_emu
 = 0;

877 
	}
}

884 
	$t˝_˘l
(
sockë
 *
so
)

886 
Slúp
 *
¶úp
 = 
so
->slirp;

887 
sbuf
 *
sb
 = &
so
->
so_¢d
;

888 
ex_li°
 *
ex_±r
;

889 
do_±y
;

891 
	`DEBUG_CALL
("tcp_ctl");

892 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

894 i‡(
so
->
so_Áddr
.
s_addr
 !
¶úp
->
vho°_addr
.s_addr) {

896 
ex_±r
 = 
¶úp
->
exec_li°
;Éx_±r;Éx_±∏ex_±r->
ex_√xt
) {

897 i‡(
ex_±r
->
ex_Â‹t
 =
so
->
so_Â‹t
 &&

898 
so
->
so_Áddr
.
s_addr
 =
ex_±r
->
ex_addr
.s_addr) {

899 i‡(
ex_±r
->
ex_±y
 == 3) {

900 
so
->
s
 = -1;

901 
so
->
exåa
 = (*)
ex_±r
->
ex_exec
;

904 
do_±y
 = 
ex_±r
->
ex_±y
;

905 
	`DEBUG_MISC
((
dfd
, "Éxecutög %†\n",
ex_±r
->
ex_exec
));

906  
	`f‹k_exec
(
so
, 
ex_±r
->
ex_exec
, 
do_±y
);

910 
sb
->
sb_cc
 =

911 
	`¢¥ötf
(
sb
->
sb_w±r
, sb->
sb_d©Æí
 - (sb->sb_w±∏- sb->
sb_d©a
),

913 
sb
->
sb_w±r
 +sb->
sb_cc
;

915 
	}
}

	@slirp/tcp_timer.c

33 
	~"¶úp.h
"

35 
t˝cb
 *
t˝_timîs
(t˝cb *
ç
, 
timî
);

41 
	$t˝_Á°timo
(
Slúp
 *
¶úp
)

43 
sockë
 *
so
;

44 
t˝cb
 *
ç
;

46 
	`DEBUG_CALL
("tcp_fasttimo");

48 
so
 = 
¶úp
->
tcb
.
so_√xt
;

49 i‡(
so
)

50 ; 
so
 !&
¶úp
->
tcb
; sÿso->
so_√xt
)

51 i‡((
ç
 = (
t˝cb
 *)
so
->
so_t˝cb
) &&

52 (
ç
->
t_Êags
 & 
TF_DELACK
)) {

53 
ç
->
t_Êags
 &~
TF_DELACK
;

54 
ç
->
t_Êags
 |
TF_ACKNOW
;

55 (Ë
	`t˝_ouçut
(
ç
);

57 
	}
}

65 
	$t˝_¶owtimo
(
Slúp
 *
¶úp
)

67 
sockë
 *
ù
, *
ùnxt
;

68 
t˝cb
 *
ç
;

69 
i
;

71 
	`DEBUG_CALL
("tcp_slowtimo");

76 
ù
 = 
¶úp
->
tcb
.
so_√xt
;

77 i‡(
ù
 =
NULL
) {

80 ; 
ù
 !&
¶úp
->
tcb
; i∞
ùnxt
) {

81 
ùnxt
 = 
ù
->
so_√xt
;

82 
ç
 = 
	`sŸŸ˝cb
(
ù
);

83 i‡(
ç
 =
NULL
) {

86 
i
 = 0; i < 
TCPT_NTIMERS
; i++) {

87 i‡(
ç
->
t_timî
[
i
] && --tp->t_timer[i] == 0) {

88 
	`t˝_timîs
(
ç
,
i
);

89 i‡(
ùnxt
->
so_¥ev
 !
ù
)

90 
çg⁄e
;

93 
ç
->
t_idÀ
++;

94 i‡(
ç
->
t_πt
)

95 
ç
->
t_πt
++;

96 
çg⁄e
:

99 
¶úp
->
t˝_iss
 +
TCP_ISSINCR
/
PR_SLOWHZ
;

100 
¶úp
->
t˝_now
++;

101 
	}
}

107 
	$t˝_ˇn˚…imîs
(
t˝cb
 *
ç
)

109 
i
;

111 
i
 = 0; i < 
TCPT_NTIMERS
; i++)

112 
ç
->
t_timî
[
i
] = 0;

113 
	}
}

115 c⁄° 
	gt˝_backoff
[
TCP_MAXRXTSHIFT
 + 1] =

121 
t˝cb
 *

122 
	$t˝_timîs
(
t˝cb
 *
ç
, 
timî
)

124 
ªxmt
;

126 
	`DEBUG_CALL
("tcp_timers");

128 
timî
) {

136 
TCPT_2MSL
:

137 i‡(
ç
->
t_°©e
 !
TCPS_TIME_WAIT
 &&

138 
ç
->
t_idÀ
 <
TCP_MAXIDLE
)

139 
ç
->
t_timî
[
TCPT_2MSL
] = 
TCPTV_KEEPINTVL
;

141 
ç
 = 
	`t˝_˛o£
(tp);

149 
TCPT_REXMT
:

156 i‡(++
ç
->
t_rxtshi·
 > 
TCP_MAXRXTSHIFT
) {

172 
ç
->
t_max£g
 >>= 1;

173 i‡(
ç
->
t_max£g
 < 32) {

177 
ç
->
t_rxtshi·
 = 
TCP_MAXRXTSHIFT
;

178 
ç
 = 
	`t˝_dr›
—p,Åp->
t_so·îr‹
);

180  (
ç
);

187 
ç
->
t_rxtshi·
 = 6;

189 
ªxmt
 = 
	`TCP_REXMTVAL
(
ç
Ë* 
t˝_backoff
[ç->
t_rxtshi·
];

190 
	`TCPT_RANGESET
(
ç
->
t_rxtcur
, 
ªxmt
,

191 ()
ç
->
t_πtmö
, 
TCPTV_REXMTMAX
);

192 
ç
->
t_timî
[
TCPT_REXMT
] =Åp->
t_rxtcur
;

201 i‡(
ç
->
t_rxtshi·
 > 
TCP_MAXRXTSHIFT
 / 4) {

202 
ç
->
t_πtv¨
 +—p->
t_§â
 >> 
TCP_RTT_SHIFT
);

203 
ç
->
t_§â
 = 0;

205 
ç
->
¢d_nxt
 =Åp->
¢d_u«
;

209 
ç
->
t_πt
 = 0;

235 
u_öt
 
wö
 = 
	`mö
(
ç
->
¢d_wnd
,Åp->
¢d_cwnd
Ë/ 2 /Åp->
t_max£g
;

236 i‡(
wö
 < 2)

237 
wö
 = 2;

238 
ç
->
¢d_cwnd
 =Åp->
t_max£g
;

239 
ç
->
¢d_s°hªsh
 = 
wö
 *Åp->
t_max£g
;

240 
ç
->
t_du∑cks
 = 0;

242 (Ë
	`t˝_ouçut
(
ç
);

249 
TCPT_PERSIST
:

250 
	`t˝_£çîsi°
(
ç
);

251 
ç
->
t_f‹˚
 = 1;

252 (Ë
	`t˝_ouçut
(
ç
);

253 
ç
->
t_f‹˚
 = 0;

260 
TCPT_KEEP
:

261 i‡(
ç
->
t_°©e
 < 
TCPS_ESTABLISHED
)

262 
dr›ô
;

264 i‡((
SO_OPTIONS
Ë&& 
ç
->
t_°©e
 <
TCPS_CLOSE_WAIT
) {

265 i‡(
ç
->
t_idÀ
 >
TCPTV_KEEP_IDLE
 + 
TCP_MAXIDLE
)

266 
dr›ô
;

279 
	`t˝_ª•⁄d
(
ç
, &ç->
t_ãm∂©e
, (
mbuf
 *)
NULL
,

280 
ç
->
rcv_nxt
,Åp->
¢d_u«
 - 1, 0);

281 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEPINTVL
;

283 
ç
->
t_timî
[
TCPT_KEEP
] = 
TCPTV_KEEP_IDLE
;

286 
dr›ô
:

287 
ç
 = 
	`t˝_dr›
(tp, 0);

291  (
ç
);

292 
	}
}

	@slirp/tcp_timer.h

33 #i‚de‡
_TCP_TIMER_H_


34 
	#_TCP_TIMER_H_


	)

40 
	#TCPT_NTIMERS
 4

	)

42 
	#TCPT_REXMT
 0

	)

43 
	#TCPT_PERSIST
 1

	)

44 
	#TCPT_KEEP
 2

	)

45 
	#TCPT_2MSL
 3

	)

86 
	#TCPTV_MSL
 ( 5*
PR_SLOWHZ
Ë

	)

88 
	#TCPTV_SRTTBASE
 0

	)

90 
	#TCPTV_SRTTDFLT
 ( 3*
PR_SLOWHZ
Ë

	)

92 
	#TCPTV_PERSMIN
 ( 5*
PR_SLOWHZ
Ë

	)

93 
	#TCPTV_PERSMAX
 ( 60*
PR_SLOWHZ
Ë

	)

95 
	#TCPTV_KEEP_INIT
 ( 75*
PR_SLOWHZ
Ë

	)

96 
	#TCPTV_KEEP_IDLE
 (120*60*
PR_SLOWHZ
Ë

	)

97 
	#TCPTV_KEEPINTVL
 ( 75*
PR_SLOWHZ
Ë

	)

98 
	#TCPTV_KEEPCNT
 8

	)

100 
	#TCPTV_MIN
 ( 1*
PR_SLOWHZ
Ë

	)

101 
	#TCPTV_REXMTMAX
 ( 12*
PR_SLOWHZ
Ë

	)

103 
	#TCP_LINGERTIME
 120

	)

105 
	#TCP_MAXRXTSHIFT
 12

	)

111 
	#TCPT_RANGESET
(
tv
, 
vÆue
, 
tvmö
, 
tvmax
) { \

112 (
tv
Ë(
vÆue
); \

113 i‡((
tv
Ë< (
tvmö
)) \

114 (
tv
Ë(
tvmö
); \

115 i‡((
tv
Ë> (
tvmax
)) \

116 (
tv
Ë(
tvmax
); \

117 }

	)

119 c⁄° 
t˝_backoff
[];

121 
	gt˝cb
;

123 
t˝_Á°timo
(
Slúp
 *);

124 
t˝_¶owtimo
(
Slúp
 *);

125 
t˝_ˇn˚…imîs
(
t˝cb
 *);

	@slirp/tcp_var.h

33 #i‚de‡
_TCP_VAR_H_


34 
	#_TCP_VAR_H_


	)

36 
	~"t˝ù.h
"

37 
	~"t˝_timî.h
"

42 
	st˝cb
 {

43 
t˝ùhdr
 *
	m£g_√xt
;

44 
t˝ùhdr
 *
	m£g_¥ev
;

45 
	mt_°©e
;

46 
	mt_timî
[
TCPT_NTIMERS
];

47 
	mt_rxtshi·
;

48 
	mt_rxtcur
;

49 
	mt_du∑cks
;

50 
u_sh‹t
 
	mt_max£g
;

51 
	mt_f‹˚
;

52 
u_sh‹t
 
	mt_Êags
;

53 
	#TF_ACKNOW
 0x0001

	)

54 
	#TF_DELACK
 0x0002

	)

55 
	#TF_NODELAY
 0x0004

	)

56 
	#TF_NOOPT
 0x0008

	)

57 
	#TF_SENTFIN
 0x0010

	)

58 
	#TF_REQ_SCALE
 0x0020

	)

59 
	#TF_RCVD_SCALE
 0x0040

	)

60 
	#TF_REQ_TSTMP
 0x0080

	)

61 
	#TF_RCVD_TSTMP
 0x0100

	)

62 
	#TF_SACK_PERMIT
 0x0200

	)

64 
t˝ùhdr
 
	mt_ãm∂©e
;

66 
sockë
 *
	mt_sockë
;

72 
t˝_£q
 
	m¢d_u«
;

73 
t˝_£q
 
	m¢d_nxt
;

74 
t˝_£q
 
	m¢d_up
;

75 
t˝_£q
 
	m¢d_wl1
;

76 
t˝_£q
 
	m¢d_wl2
;

77 
t˝_£q
 
	miss
;

78 
uöt32_t
 
	m¢d_wnd
;

80 
uöt32_t
 
	mrcv_wnd
;

81 
t˝_£q
 
	mrcv_nxt
;

82 
t˝_£q
 
	mrcv_up
;

83 
t˝_£q
 
	mús
;

88 
t˝_£q
 
	mrcv_adv
;

90 
t˝_£q
 
	m¢d_max
;

94 
uöt32_t
 
	m¢d_cwnd
;

95 
uöt32_t
 
	m¢d_s°hªsh
;

103 
	mt_idÀ
;

104 
	mt_πt
;

105 
t˝_£q
 
	mt_π£q
;

106 
	mt_§â
;

107 
	mt_πtv¨
;

108 
u_sh‹t
 
	mt_πtmö
;

109 
uöt32_t
 
	mmax_¢dwnd
;

112 
	mt_oobÊags
;

113 
	mt_iobc
;

114 
	#TCPOOB_HAVEDATA
 0x01

	)

115 
	#TCPOOB_HADDATA
 0x02

	)

116 
	mt_so·îr‹
;

119 
u_ch¨
 
	m¢d_sˇÀ
;

120 
u_ch¨
 
	mrcv_sˇÀ
;

121 
u_ch¨
 
	mªque°_r_sˇÀ
;

122 
u_ch¨
 
	mªque°ed_s_sˇÀ
;

123 
uöt32_t
 
	mts_ª˚¡
;

124 
uöt32_t
 
	mts_ª˚¡_age
;

125 
t˝_£q
 
	mœ°_ack_£¡
;

129 
	#sŸŸ˝cb
(
so
Ë((so)->
so_t˝cb
)

	)

140 
	#TCP_RTT_SCALE
 8

	)

141 
	#TCP_RTT_SHIFT
 3

	)

142 
	#TCP_RTTVAR_SCALE
 4

	)

143 
	#TCP_RTTVAR_SHIFT
 2

	)

158 
	#TCP_REXMTVAL
(
ç
) \

159 (((
ç
)->
t_§â
 >> 
TCP_RTT_SHIFT
Ë+ (ç)->
t_πtv¨
)

	)

	@slirp/tcpip.h

33 #i‚de‡
_TCPIP_H_


34 
	#_TCPIP_H_


	)

39 
	st˝ùhdr
 {

40 
ùovly
 
	mti_i
;

41 
t˝hdr
 
	mti_t
;

43 
	#ti_mbuf
 
ti_i
.
ih_mbuf
.
m±r


	)

44 
	#ti_x1
 
ti_i
.
ih_x1


	)

45 
	#ti_¥
 
ti_i
.
ih_¥


	)

46 
	#ti_Àn
 
ti_i
.
ih_Àn


	)

47 
	#ti_§c
 
ti_i
.
ih_§c


	)

48 
	#ti_d°
 
ti_i
.
ih_d°


	)

49 
	#ti_•‹t
 
ti_t
.
th_•‹t


	)

50 
	#ti_dp‹t
 
ti_t
.
th_dp‹t


	)

51 
	#ti_£q
 
ti_t
.
th_£q


	)

52 
	#ti_ack
 
ti_t
.
th_ack


	)

53 
	#ti_x2
 
ti_t
.
th_x2


	)

54 
	#ti_off
 
ti_t
.
th_off


	)

55 
	#ti_Êags
 
ti_t
.
th_Êags


	)

56 
	#ti_wö
 
ti_t
.
th_wö


	)

57 
	#ti_sum
 
ti_t
.
th_sum


	)

58 
	#ti_uΩ
 
ti_t
.
th_uΩ


	)

60 
	#t˝ùhdr2qlök
(
T
Ë((
qlök
*)(((*)(T)Ë- (qlök)))

	)

61 
	#qlök2t˝ùhdr
(
Q
Ë((
t˝ùhdr
*)(((*)(Q)Ë+ (
qlök
)))

	)

62 
	#t˝ùhdr_√xt
(
T
Ë
	`qlök2t˝ùhdr
(
	`t˝ùhdr2qlök
(T)->
√xt
)

	)

63 
	#t˝ùhdr_¥ev
(
T
Ë
	`qlök2t˝ùhdr
(
	`t˝ùhdr2qlök
(T)->
¥ev
)

	)

64 
	#t˝‰ag_li°_fú°
(
T
Ë
	`qlök2t˝ùhdr
((T)->
£g_√xt
)

	)

65 
	#t˝‰ag_li°_íd
(
F
, 
T
Ë(
	`t˝ùhdr2qlök
(FË=(
qlök
*)(T))

	)

66 
	#t˝‰ag_li°_em±y
(
T
Ë((T)->
£g_√xt
 =(
t˝ùhdr
*)(T))

	)

72 
	st˝ùhdr_2
 {

73 
t˝ùhdr
 
	mdummy
;

74 
	mfú°_ch¨
;

	@slirp/tftp.h

3 
	#TFTP_SESSIONS_MAX
 3

	)

5 
	#TFTP_SERVER
 69

	)

7 
	#TFTP_RRQ
 1

	)

8 
	#TFTP_WRQ
 2

	)

9 
	#TFTP_DATA
 3

	)

10 
	#TFTP_ACK
 4

	)

11 
	#TFTP_ERROR
 5

	)

12 
	#TFTP_OACK
 6

	)

14 
	#TFTP_FILENAME_MAX
 512

	)

16 
	st·p_t
 {

17 
ù
 
	mù
;

18 
udphdr
 
	mudp
;

19 
uöt16_t
 
	mç_›
;

22 
uöt16_t
 
	mç_block_ƒ
;

23 
uöt8_t
 
	mç_buf
[512];

24 } 
	mç_d©a
;

26 
uöt16_t
 
	mç_îr‹_code
;

27 
uöt8_t
 
	mç_msg
[512];

28 } 
	mç_îr‹
;

29 
uöt8_t
 
	mç_buf
[512 + 2];

30 } 
	mx
;

33 
	st·p_£ssi⁄
 {

34 
Slúp
 *
	m¶úp
;

35 *
	mfûíame
;

37 
ö_addr
 
	m˛õ¡_ù
;

38 
uöt16_t
 
	m˛õ¡_p‹t
;

40 
	mtime°amp
;

43 
t·p_öput
(
mbuf
 *
m
);

	@slirp/udp.c

41 
	~"¶úp.h
"

42 
	~"ù_icmp.h
"

44 
uöt8_t
 
udp_tos
(
sockë
 *
so
);

47 
	$udp_öô
(
Slúp
 *
¶úp
)

49 
¶úp
->
udb
.
so_√xt
 = slúp->udb.
so_¥ev
 = &slirp->udb;

50 
¶úp
->
udp_œ°_so
 = &¶úp->
udb
;

51 
	}
}

57 
	$udp_öput
(
mbuf
 *
m
, 
ùhÀn
)

59 
Slúp
 *
¶úp
 = 
m
->slirp;

60 
ù
 *ip;

61 
udphdr
 *
uh
;

62 
Àn
;

63 
ù
 
ßve_ù
;

64 
sockë
 *
so
;

66 
	`DEBUG_CALL
("udp_input");

67 
	`DEBUG_ARG
("m = %lx", ()
m
);

68 
	`DEBUG_ARG
("ùhÀ¿%d", 
ùhÀn
);

76 if(
ùhÀn
 > (
ù
)) {

77 
	`ù_°rù›ti⁄s
(
m
, (
mbuf
 *)0);

78 
ùhÀn
 = (
ù
);

84 
ù
 = 
	`mtod
(
m
, ip *);

85 
uh
 = (
udphdr
 *)((
ˇddr_t
)
ù
 + 
ùhÀn
);

91 
Àn
 = 
	`¡ohs
((
uöt16_t
)
uh
->
uh_uÀn
);

93 i‡(
ù
->
ù_Àn
 !
Àn
) {

94 i‡(
Àn
 > 
ù
->
ù_Àn
) {

95 
bad
;

97 
	`m_adj
(
m
, 
Àn
 - 
ù
->
ù_Àn
);

98 
ù
->
ù_Àn
 = 
Àn
;

105 
ßve_ù
 = *
ù
;

106 
ßve_ù
.
ù_Àn
+
ùhÀn
;

111 i‡(
uh
->
uh_sum
) {

112 
	`mem£t
(&((
ùovly
 *)
ù
)->
ih_mbuf
, 0, (
mbuf_±r
));

113 ((
ùovly
 *)
ù
)->
ih_x1
 = 0;

114 ((
ùovly
 *)
ù
)->
ih_Àn
 = 
uh
->
uh_uÀn
;

115 if(
	`cksum
(
m
, 
Àn
 + (
ù
))) {

116 
bad
;

123 i‡(
	`¡ohs
(
uh
->
uh_dp‹t
Ë=
BOOTP_SERVER
) {

124 
	`boŸp_öput
(
m
);

125 
bad
;

128 i‡(
¶úp
->
ª°ri˘ed
) {

129 
bad
;

136 i‡(
	`¡ohs
(
uh
->
uh_dp‹t
Ë=
TFTP_SERVER
) {

137 
	`t·p_öput
(
m
);

138 
bad
;

145 
so
 = 
¶úp
->
udp_œ°_so
;

146 i‡(
so
->
so_Õ‹t
 !
uh
->
uh_•‹t
 ||

147 
so
->
so_œddr
.
s_addr
 !
ù
->
ù_§c
.s_addr) {

148 
sockë
 *
tmp
;

150 
tmp
 = 
¶úp
->
udb
.
so_√xt
;Åmp != &slirp->udb;

151 
tmp
 =Åmp->
so_√xt
) {

152 i‡(
tmp
->
so_Õ‹t
 =
uh
->
uh_•‹t
 &&

153 
tmp
->
so_œddr
.
s_addr
 =
ù
->
ù_§c
.s_addr) {

154 
so
 = 
tmp
;

158 i‡(
tmp
 =&
¶úp
->
udb
) {

159 
so
 = 
NULL
;

161 
¶úp
->
udp_œ°_so
 = 
so
;

165 i‡(
so
 =
NULL
) {

170 
so
 = 
	`so¸óã
(
¶úp
);

171 i‡(!
so
) {

172 
bad
;

174 if(
	`udp_©èch
(
so
) == -1) {

175 
	`DEBUG_MISC
((
dfd
," udp_attachÉrrno = %d-%s\n",

176 
î∫o
,
	`°ªº‹
(errno)));

177 
	`so‰ì
(
so
);

178 
bad
;

184 
so
->
so_œddr
 = 
ù
->
ù_§c
;

185 
so
->
so_Õ‹t
 = 
uh
->
uh_•‹t
;

187 i‡((
so
->
so_ùtos
 = 
	`udp_tos
(so)) == 0)

188 
so
->
so_ùtos
 = 
ù
->
ù_tos
;

196 
so
->
so_Áddr
 = 
ù
->
ù_d°
;

197 
so
->
so_Â‹t
 = 
uh
->
uh_dp‹t
;

199 
ùhÀn
 +(
udphdr
);

200 
m
->
m_Àn
 -
ùhÀn
;

201 
m
->
m_d©a
 +
ùhÀn
;

206 if(
	`so£ndto
(
so
,
m
) == -1) {

207 
m
->
m_Àn
 +
ùhÀn
;

208 
m
->
m_d©a
 -
ùhÀn
;

209 *
ù
=
ßve_ù
;

210 
	`DEBUG_MISC
((
dfd
,"ud∞txÉºnÿ%d-%s\n",
î∫o
,
	`°ªº‹
(errno)));

211 
	`icmp_îr‹
(
m
, 
ICMP_UNREACH
,
ICMP_UNREACH_NET
, 0,
	`°ªº‹
(
î∫o
));

214 
	`m_‰ì
(
so
->
so_m
);

217 
m
->
m_Àn
 +
ùhÀn
;

218 
m
->
m_d©a
 -
ùhÀn
;

219 *
ù
=
ßve_ù
;

220 
so
->
so_m
=
m
;

223 
bad
:

224 
	`m_‰ìm
(
m
);

226 
	}
}

228 
	$udp_ouçut2
(
sockë
 *
so
, 
mbuf
 *
m
,

229 
sockaddr_ö
 *
ßddr
, sockaddr_ö *
daddr
,

230 
ùtos
)

232 
udpùhdr
 *
ui
;

233 
îr‹
 = 0;

235 
	`DEBUG_CALL
("udp_output");

236 
	`DEBUG_ARG
("sÿ%lx", ()
so
);

237 
	`DEBUG_ARG
("m = %lx", ()
m
);

238 
	`DEBUG_ARG
("ßdd∏%lx", ()
ßddr
->
sö_addr
.
s_addr
);

239 
	`DEBUG_ARG
("dadd∏%lx", ()
daddr
->
sö_addr
.
s_addr
);

244 
m
->
m_d©a
 -(
udpùhdr
);

245 
m
->
m_Àn
 +(
udpùhdr
);

251 
ui
 = 
	`mtod
(
m
, 
udpùhdr
 *);

252 
	`mem£t
(&
ui
->
ui_i
.
ih_mbuf
, 0 , (
mbuf_±r
));

253 
ui
->
ui_x1
 = 0;

254 
ui
->
ui_¥
 = 
IPPROTO_UDP
;

255 
ui
->
ui_Àn
 = 
	`ht⁄s
(
m
->
m_Àn
 - (
ù
));

257 
ui
->
ui_§c
 = 
ßddr
->
sö_addr
;

258 
ui
->
ui_d°
 = 
daddr
->
sö_addr
;

259 
ui
->
ui_•‹t
 = 
ßddr
->
sö_p‹t
;

260 
ui
->
ui_dp‹t
 = 
daddr
->
sö_p‹t
;

261 
ui
->
ui_uÀn
 = ui->
ui_Àn
;

266 
ui
->
ui_sum
 = 0;

267 i‡((
ui
->
ui_sum
 = 
	`cksum
(
m
, m->
m_Àn
)) == 0)

268 
ui
->
ui_sum
 = 0xffff;

269 ((
ù
 *)
ui
)->
ù_Àn
 = 
m
->
m_Àn
;

271 ((
ù
 *)
ui
)->
ù_âl
 = 
IPDEFTTL
;

272 ((
ù
 *)
ui
)->
ù_tos
 = 
ùtos
;

274 
îr‹
 = 
	`ù_ouçut
(
so
, 
m
);

276  (
îr‹
);

277 
	}
}

279 
	$udp_ouçut
(
sockë
 *
so
, 
mbuf
 *
m
,

280 
sockaddr_ö
 *
addr
)

283 
Slúp
 *
¶úp
 = 
so
->slirp;

284 
sockaddr_ö
 
ßddr
, 
daddr
;

286 
ßddr
 = *
addr
;

287 i‡((
so
->
so_Áddr
.
s_addr
 & 
¶úp
->
v√tw‹k_mask
.s_addr) ==

288 
¶úp
->
v√tw‹k_addr
.
s_addr
) {

289 
uöt32_t
 
öv_mask
 = ~
¶úp
->
v√tw‹k_mask
.
s_addr
;

291 i‡((
so
->
so_Áddr
.
s_addr
 & 
öv_mask
) == inv_mask) {

292 
ßddr
.
sö_addr
 = 
¶úp
->
vho°_addr
;

293 } i‡(
addr
->
sö_addr
.
s_addr
 =
lo›back_addr
.s_addr ||

294 
so
->
so_Áddr
.
s_addr
 !
¶úp
->
vho°_addr
.s_addr) {

295 
ßddr
.
sö_addr
 = 
so
->
so_Áddr
;

298 
daddr
.
sö_addr
 = 
so
->
so_œddr
;

299 
daddr
.
sö_p‹t
 = 
so
->
so_Õ‹t
;

301  
	`udp_ouçut2
(
so
, 
m
, &
ßddr
, &
daddr
, so->
so_ùtos
);

302 
	}
}

305 
	$udp_©èch
(
sockë
 *
so
)

307 if((
so
->
s
 = 
	`os_sockë
(
AF_INET
,
SOCK_DGRAM
,0)) != -1) {

308 
so
->
so_expúe
 = 
cuπime
 + 
SO_EXPIRE
;

309 
	`ösque
(
so
, &so->
¶úp
->
udb
);

311 (
so
->
s
);

312 
	}
}

315 
	$udp_dëach
(
sockë
 *
so
)

317 
	`˛o£sockë
(
so
->
s
);

318 
	`so‰ì
(
so
);

319 
	}
}

321 c⁄° 
tos_t
 
	gud±os
[] = {

322 {0, 53, 
IPTOS_LOWDELAY
, 0},

326 
uöt8_t


327 
	$udp_tos
(
sockë
 *
so
)

329 
i
 = 0;

331 
ud±os
[
i
].
tos
) {

332 i‡((
ud±os
[
i
].
Â‹t
 && 
	`¡ohs
(
so
->
so_Â‹t
) == udptos[i].fport) ||

333 (
ud±os
[
i
].
Õ‹t
 && 
	`¡ohs
(
so
->
so_Õ‹t
) == udptos[i].lport)) {

334 
so
->
so_emu
 = 
ud±os
[
i
].
emu
;

335  
ud±os
[
i
].
tos
;

337 
i
++;

341 
	}
}

343 
sockë
 *

344 
	$udp_li°í
(
Slúp
 *
¶úp
, 
uöt32_t
 
haddr
, 
u_öt
 
hp‹t
, uöt32_à
œddr
,

345 
u_öt
 
Õ‹t
, 
Êags
)

347 
sockaddr_ö
 
addr
;

348 
sockë
 *
so
;

349 
sockÀn_t
 
addæí
 = (
sockaddr_ö
), 
›t
 = 1;

351 
so
 = 
	`so¸óã
(
¶úp
);

352 i‡(!
so
) {

353  
NULL
;

355 
so
->
s
 = 
	`os_sockë
(
AF_INET
,
SOCK_DGRAM
,0);

356 
so
->
so_expúe
 = 
cuπime
 + 
SO_EXPIRE
;

357 
	`ösque
(
so
, &
¶úp
->
udb
);

359 
addr
.
sö_Ámûy
 = 
AF_INET
;

360 
addr
.
sö_addr
.
s_addr
 = 
haddr
;

361 
addr
.
sö_p‹t
 = 
hp‹t
;

363 i‡(
	`böd
(
so
->
s
,(
sockaddr
 *)&
addr
, 
addæí
) < 0) {

364 
	`udp_dëach
(
so
);

365  
NULL
;

367 
	`£tsock›t
(
so
->
s
,
SOL_SOCKET
,
SO_REUSEADDR
,(*)&
›t
,());

369 
	`gësock«me
(
so
->
s
,(
sockaddr
 *)&
addr
,&
addæí
);

370 
so
->
so_Â‹t
 = 
addr
.
sö_p‹t
;

371 i‡(
addr
.
sö_addr
.
s_addr
 == 0 ||

372 
addr
.
sö_addr
.
s_addr
 =
lo›back_addr
.s_addr) {

373 
so
->
so_Áddr
 = 
¶úp
->
vho°_addr
;

375 
so
->
so_Áddr
 = 
addr
.
sö_addr
;

377 
so
->
so_Õ‹t
 = 
Õ‹t
;

378 
so
->
so_œddr
.
s_addr
 = 
œddr
;

379 i‡(
Êags
 !
SS_FACCEPTONCE
)

380 
so
->
so_expúe
 = 0;

382 
so
->
so_°©e
 &
SS_PERSISTENT_MASK
;

383 
so
->
so_°©e
 |
SS_ISFCONNECTED
 | 
Êags
;

385  
so
;

386 
	}
}

	@slirp/udp.h

33 #i‚de‡
_UDP_H_


34 
	#_UDP_H_


	)

36 
	#UDP_TTL
 0x60

	)

37 
	#UDP_UDPDATALEN
 16192

	)

43 
	sudphdr
 {

44 
uöt16_t
 
	muh_•‹t
;

45 
uöt16_t
 
	muh_dp‹t
;

46 
öt16_t
 
	muh_uÀn
;

47 
uöt16_t
 
	muh_sum
;

53 
	sudpùhdr
 {

54 
ùovly
 
	mui_i
;

55 
udphdr
 
	mui_u
;

57 
	#ui_mbuf
 
ui_i
.
ih_mbuf
.
m±r


	)

58 
	#ui_x1
 
ui_i
.
ih_x1


	)

59 
	#ui_¥
 
ui_i
.
ih_¥


	)

60 
	#ui_Àn
 
ui_i
.
ih_Àn


	)

61 
	#ui_§c
 
ui_i
.
ih_§c


	)

62 
	#ui_d°
 
ui_i
.
ih_d°


	)

63 
	#ui_•‹t
 
ui_u
.
uh_•‹t


	)

64 
	#ui_dp‹t
 
ui_u
.
uh_dp‹t


	)

65 
	#ui_uÀn
 
ui_u
.
uh_uÀn


	)

66 
	#ui_sum
 
ui_u
.
uh_sum


	)

71 
	#UDPCTL_CHECKSUM
 1

	)

72 
	#UDPCTL_MAXID
 2

	)

74 
	gmbuf
;

76 
udp_öô
(
Slúp
 *);

77 
udp_öput
(
mbuf
 *, );

78 
udp_ouçut
(
sockë
 *, 
mbuf
 *, 
sockaddr_ö
 *);

79 
udp_©èch
(
sockë
 *);

80 
udp_dëach
(
sockë
 *);

81 
sockë
 * 
udp_li°í
(
Slúp
 *, 
uöt32_t
, 
u_öt
, uint32_t, u_int,

83 
udp_ouçut2
(
sockë
 *
so
, 
mbuf
 *
m
,

84 
sockaddr_ö
 *
ßddr
, sockaddr_ö *
daddr
,

85 
ùtos
);

	@softfp.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<as£π.h
>

27 
	~<°rög.h
>

29 
	~"cutûs.h
"

30 
	~"so·Â.h
"

32 
ölöe
 
	$˛z32
(
uöt32_t
 
a
)

34 
r
;

35 i‡(
a
 == 0) {

36 
r
 = 32;

38 
r
 = 
	`__buûtö_˛z
(
a
);

40  
r
;

41 
	}
}

43 
ölöe
 
	$˛z64
(
uöt64_t
 
a
)

45 
r
;

46 i‡(
a
 == 0) {

47 
r
 = 64;

50 
r
 = 
	`__buûtö_˛zŒ
(
a
);

52  
r
;

53 
	}
}

55 #ifde‡
HAVE_INT128


56 
ölöe
 
	$˛z128
(
uöt128_t
 
a
)

58 
r
;

59 i‡(
a
 == 0) {

60 
r
 = 128;

63 
uöt64_t
 
ah
, 
Æ
;

64 
ah
 = 
a
 >> 64;

65 
Æ
 = 
a
;

66 i‡(
ah
 != 0)

67 
r
 = 
	`__buûtö_˛zŒ
(
ah
);

69 
r
 = 
	`__buûtö_˛zŒ
(
Æ
) + 64;

71  
r
;

72 
	}
}

75 
	#F_SIZE
 32

	)

76 
	~"so·Â_ãm∂©e.h
"

78 
	#F_SIZE
 64

	)

79 
	~"so·Â_ãm∂©e.h
"

81 #ifde‡
HAVE_INT128


83 
	#F_SIZE
 128

	)

84 
	~"so·Â_ãm∂©e.h
"

	@softfp.h

24 #i‚de‡
SOFTFP_H


25 
	#SOFTFP_H


	)

27 
	~<öây≥s.h
>

28 
	~"cutûs.h
"

31 
	mRM_RNE
,

32 
	mRM_RTZ
,

33 
	mRM_RDN
,

34 
	mRM_RUP
,

35 
	mRM_RMM
,

36 } 
	tRoundögModeEnum
;

38 
	#FFLAG_INVALID_OP
 (1 << 4)

	)

39 
	#FFLAG_DIVIDE_ZERO
 (1 << 3)

	)

40 
	#FFLAG_OVERFLOW
 (1 << 2)

	)

41 
	#FFLAG_UNDERFLOW
 (1 << 1)

	)

42 
	#FFLAG_INEXACT
 (1 << 0)

	)

44 
	#FCLASS_NINF
 (1 << 0)

	)

45 
	#FCLASS_NNORMAL
 (1 << 1)

	)

46 
	#FCLASS_NSUBNORMAL
 (1 << 2)

	)

47 
	#FCLASS_NZERO
 (1 << 3)

	)

48 
	#FCLASS_PZERO
 (1 << 4)

	)

49 
	#FCLASS_PSUBNORMAL
 (1 << 5)

	)

50 
	#FCLASS_PNORMAL
 (1 << 6)

	)

51 
	#FCLASS_PINF
 (1 << 7)

	)

52 
	#FCLASS_SNAN
 (1 << 8)

	)

53 
	#FCLASS_QNAN
 (1 << 9)

	)

56 
	mFMINMAX_PROP
,

57 
	mFMINMAX_IEEE754_2008
,

58 
	mFMINMAX_IEEE754_201X
,

59 } 
	tSo·FPMöMaxTy≥Enum
;

61 
uöt32_t
 
	tsÊﬂt32
;

62 
uöt64_t
 
	tsÊﬂt64
;

63 #ifde‡
HAVE_INT128


64 
uöt128_t
 
	tsÊﬂt128
;

69 
	#FSIGN_MASK32
 (1 << 31)

	)

71 
sÊﬂt32
 
add_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

72 
sÊﬂt32
 
sub_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

73 
sÊﬂt32
 
mul_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

74 
sÊﬂt32
 
div_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

75 
sÊﬂt32
 
sqπ_sf32
(sÊﬂt32 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

76 
sÊﬂt32
 
fma_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, sÊﬂt32 
c
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

78 
sÊﬂt32
 
mö_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
);

79 
sÊﬂt32
 
max_sf32
(sÊﬂt32 
a
, sÊﬂt32 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
);

80 
eq_quõt_sf32
(
sÊﬂt32
 
a
, sÊﬂt32 
b
, 
uöt32_t
 *
pfÊags
);

81 
À_sf32
(
sÊﬂt32
 
a
, sÊﬂt32 
b
, 
uöt32_t
 *
pfÊags
);

82 
…_sf32
(
sÊﬂt32
 
a
, sÊﬂt32 
b
, 
uöt32_t
 *
pfÊags
);

83 
uöt32_t
 
f˛ass_sf32
(
sÊﬂt32
 
a
);

85 
sÊﬂt64
 
cvt_sf32_sf64
(
sÊﬂt32
 
a
, 
uöt32_t
 *
pfÊags
);

86 
sÊﬂt32
 
cvt_sf64_sf32
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

87 
öt32_t
 
cvt_sf32_i32
(
sÊﬂt32
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

88 
uöt32_t
 
cvt_sf32_u32
(
sÊﬂt32
 
a
, 
RoundögModeEnum
 
rm
, uöt32_à*
pfÊags
);

89 
öt64_t
 
cvt_sf32_i64
(
sÊﬂt32
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

90 
uöt64_t
 
cvt_sf32_u64
(
sÊﬂt32
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

91 #ifde‡
HAVE_INT128


92 
öt128_t
 
cvt_sf32_i128
(
sÊﬂt32
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

93 
uöt128_t
 
cvt_sf32_u128
(
sÊﬂt32
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

95 
sÊﬂt32
 
cvt_i32_sf32
(
öt32_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

96 
sÊﬂt32
 
cvt_u32_sf32
(
uöt32_t
 
a
, 
RoundögModeEnum
 
rm
, uöt32_à*
pfÊags
);

97 
sÊﬂt32
 
cvt_i64_sf32
(
öt64_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

98 
sÊﬂt32
 
cvt_u64_sf32
(
uöt64_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

99 #ifde‡
HAVE_INT128


100 
sÊﬂt32
 
cvt_i128_sf32
(
öt128_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

101 
sÊﬂt32
 
cvt_u128_sf32
(
uöt128_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

106 
	#FSIGN_MASK64
 ((
uöt64_t
)1 << 63)

	)

108 
sÊﬂt64
 
add_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

109 
sÊﬂt64
 
sub_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

110 
sÊﬂt64
 
mul_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

111 
sÊﬂt64
 
div_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

112 
sÊﬂt64
 
sqπ_sf64
(sÊﬂt64 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

113 
sÊﬂt64
 
fma_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, sÊﬂt64 
c
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

115 
sÊﬂt64
 
mö_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
);

116 
sÊﬂt64
 
max_sf64
(sÊﬂt64 
a
, sÊﬂt64 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
);

117 
eq_quõt_sf64
(
sÊﬂt64
 
a
, sÊﬂt64 
b
, 
uöt32_t
 *
pfÊags
);

118 
À_sf64
(
sÊﬂt64
 
a
, sÊﬂt64 
b
, 
uöt32_t
 *
pfÊags
);

119 
…_sf64
(
sÊﬂt64
 
a
, sÊﬂt64 
b
, 
uöt32_t
 *
pfÊags
);

120 
uöt32_t
 
f˛ass_sf64
(
sÊﬂt64
 
a
);

122 
sÊﬂt64
 
cvt_sf32_sf64
(
sÊﬂt32
 
a
, 
uöt32_t
 *
pfÊags
);

123 
sÊﬂt32
 
cvt_sf64_sf32
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

124 
öt32_t
 
cvt_sf64_i32
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

125 
uöt32_t
 
cvt_sf64_u32
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, uöt32_à*
pfÊags
);

126 
öt64_t
 
cvt_sf64_i64
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

127 
uöt64_t
 
cvt_sf64_u64
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

128 #ifde‡
HAVE_INT128


129 
öt128_t
 
cvt_sf64_i128
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

130 
uöt128_t
 
cvt_sf64_u128
(
sÊﬂt64
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

132 
sÊﬂt64
 
cvt_i32_sf64
(
öt32_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

133 
sÊﬂt64
 
cvt_u32_sf64
(
uöt32_t
 
a
, 
RoundögModeEnum
 
rm
, uöt32_à*
pfÊags
);

134 
sÊﬂt64
 
cvt_i64_sf64
(
öt64_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

135 
sÊﬂt64
 
cvt_u64_sf64
(
uöt64_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

136 #ifde‡
HAVE_INT128


137 
sÊﬂt64
 
cvt_i128_sf64
(
öt128_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

138 
sÊﬂt64
 
cvt_u128_sf64
(
uöt128_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

143 #ifde‡
HAVE_INT128


145 
	#FSIGN_MASK128
 ((
uöt128_t
)1 << 127)

	)

147 
sÊﬂt128
 
add_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

148 
sÊﬂt128
 
sub_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

149 
sÊﬂt128
 
mul_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

150 
sÊﬂt128
 
div_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

151 
sÊﬂt128
 
sqπ_sf128
(sÊﬂt128 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

152 
sÊﬂt128
 
fma_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, sÊﬂt128 
c
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

154 
sÊﬂt128
 
mö_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
);

155 
sÊﬂt128
 
max_sf128
(sÊﬂt128 
a
, sÊﬂt128 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
);

156 
eq_quõt_sf128
(
sÊﬂt128
 
a
, sÊﬂt128 
b
, 
uöt32_t
 *
pfÊags
);

157 
À_sf128
(
sÊﬂt128
 
a
, sÊﬂt128 
b
, 
uöt32_t
 *
pfÊags
);

158 
…_sf128
(
sÊﬂt128
 
a
, sÊﬂt128 
b
, 
uöt32_t
 *
pfÊags
);

159 
uöt32_t
 
f˛ass_sf128
(
sÊﬂt128
 
a
);

161 
sÊﬂt128
 
cvt_sf32_sf128
(
sÊﬂt32
 
a
, 
uöt32_t
 *
pfÊags
);

162 
sÊﬂt32
 
cvt_sf128_sf32
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

163 
sÊﬂt128
 
cvt_sf64_sf128
(
sÊﬂt64
 
a
, 
uöt32_t
 *
pfÊags
);

164 
sÊﬂt64
 
cvt_sf128_sf64
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

166 
öt32_t
 
cvt_sf128_i32
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

167 
uöt32_t
 
cvt_sf128_u32
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, uöt32_à*
pfÊags
);

168 
öt64_t
 
cvt_sf128_i64
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

169 
uöt64_t
 
cvt_sf128_u64
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

170 
öt128_t
 
cvt_sf128_i128
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

171 
uöt128_t
 
cvt_sf128_u128
(
sÊﬂt128
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

172 
sÊﬂt128
 
cvt_i32_sf128
(
öt32_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

173 
sÊﬂt128
 
cvt_u32_sf128
(
uöt32_t
 
a
, 
RoundögModeEnum
 
rm
, uöt32_à*
pfÊags
);

174 
sÊﬂt128
 
cvt_i64_sf128
(
öt64_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

175 
sÊﬂt128
 
cvt_u64_sf128
(
uöt64_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

176 
sÊﬂt128
 
cvt_i128_sf128
(
öt128_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

177 
sÊﬂt128
 
cvt_u128_sf128
(
uöt128_t
 
a
, 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
);

	@softfp_template.h

24 #i‡
F_SIZE
 == 32

25 
	#F_UINT
 
uöt32_t


	)

26 
	#F_ULONG
 
uöt64_t


	)

27 
	#MANT_SIZE
 23

	)

28 
	#EXP_SIZE
 8

	)

29 #ñi‡
F_SIZE
 == 64

30 
	#F_UHALF
 
uöt32_t


	)

31 
	#F_UINT
 
uöt64_t


	)

32 #ifde‡
HAVE_INT128


33 
	#F_ULONG
 
uöt128_t


	)

35 
	#MANT_SIZE
 52

	)

36 
	#EXP_SIZE
 11

	)

37 #ñi‡
F_SIZE
 == 128

38 
	#F_UHALF
 
uöt64_t


	)

39 
	#F_UINT
 
uöt128_t


	)

40 
	#MANT_SIZE
 112

	)

41 
	#EXP_SIZE
 15

	)

43 #îr‹ 
unsuµ‹ãd
 
F_SIZE


46 
	#EXP_MASK
 ((1 << 
EXP_SIZE
Ë- 1)

	)

47 
	#MANT_MASK
 (((
F_UINT
)1 << 
MANT_SIZE
Ë- 1)

	)

48 
	#SIGN_MASK
 ((
F_UINT
)1 << (
F_SIZE
 - 1))

	)

49 
	#IMANT_SIZE
 (
F_SIZE
 - 2Ë

	)

50 
	#RND_SIZE
 (
IMANT_SIZE
 - 
MANT_SIZE
)

	)

51 
	#QNAN_MASK
 ((
F_UINT
)1 << (
MANT_SIZE
 - 1))

	)

54 
	#F_QNAN
 
	`glue
(
F_QNAN
, 
F_SIZE
)

	)

55 
	#˛z
 
	`glue
(
˛z
, 
F_SIZE
)

	)

56 
	#∑ck_sf
 
	`glue
(
∑ck_sf
, 
F_SIZE
)

	)

57 
	#u≈ack_sf
 
	`glue
(
u≈ack_sf
, 
F_SIZE
)

	)

58 
	#rshi·_∫d
 
	`glue
(
rshi·_∫d
, 
F_SIZE
)

	)

59 
	#round_∑ck_sf
 
	`glue
(
round∑ck_sf
, 
F_SIZE
)

	)

60 
	#n‹mÆize_sf
 
	`glue
(
n‹mÆize_sf
, 
F_SIZE
)

	)

61 
	#n‹mÆize2_sf
 
	`glue
(
n‹mÆize2_sf
, 
F_SIZE
)

	)

62 
	#issig«n_sf
 
	`glue
(
issig«n_sf
, 
F_SIZE
)

	)

63 
	#i¢™_sf
 
	`glue
(
i¢™_sf
, 
F_SIZE
)

	)

64 
	#add_sf
 
	`glue
(
add_sf
, 
F_SIZE
)

	)

65 
	#mul_sf
 
	`glue
(
mul_sf
, 
F_SIZE
)

	)

66 
	#fma_sf
 
	`glue
(
fma_sf
, 
F_SIZE
)

	)

67 
	#div_sf
 
	`glue
(
div_sf
, 
F_SIZE
)

	)

68 
	#sqπ_sf
 
	`glue
(
sqπ_sf
, 
F_SIZE
)

	)

69 
	#n‹mÆize_subn‹mÆ_sf
 
	`glue
(
n‹mÆize_subn‹mÆ_sf
, 
F_SIZE
)

	)

70 
	#divªm_u
 
	`glue
(
divªm_u
, 
F_SIZE
)

	)

71 
	#sqπªm_u
 
	`glue
(
sqπªm_u
, 
F_SIZE
)

	)

72 
	#mul_u
 
	`glue
(
mul_u
, 
F_SIZE
)

	)

73 
	#cvt_sf32_sf
 
	`glue
(
cvt_sf32_sf
, 
F_SIZE
)

	)

74 
	#cvt_sf64_sf
 
	`glue
(
cvt_sf64_sf
, 
F_SIZE
)

	)

76 c⁄° 
F_UINT
 
	gF_QNAN
 = (((F_UINT)
EXP_MASK
 << 
MANT_SIZE
) | ((F_UINT)1 << (MANT_SIZE - 1)));

78 
ölöe
 
F_UINT
 
	$∑ck_sf
(
uöt32_t
 
a_sign
, uöt32_à
a_exp
, 
F_UINT
 
a_m™t
)

80  ((
F_UINT
)
a_sign
 << (
F_SIZE
 - 1)) |

81 ((
F_UINT
)
a_exp
 << 
MANT_SIZE
) |

82 (
a_m™t
 & 
MANT_MASK
);

83 
	}
}

85 
ölöe
 
F_UINT
 
	$u≈ack_sf
(
uöt32_t
 *
∑_sign
, 
öt32_t
 *
∑_exp
,

86 
F_UINT
 
a
)

88 *
∑_sign
 = 
a
 >> (
F_SIZE
 - 1);

89 *
∑_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

90  
a
 & 
MANT_MASK
;

91 
	}
}

93 
F_UINT
 
	$rshi·_∫d
(
F_UINT
 
a
, 
d
)

95 
F_UINT
 
mask
;

96 i‡(
d
 != 0) {

97 i‡(
d
 >
F_SIZE
) {

98 
a
 = (a != 0);

100 
mask
 = ((
F_UINT
)1 << 
d
) - 1;

101 
a
 = (®>> 
d
Ë| (◊ & 
mask
) != 0);

104  
a
;

105 
	}
}

108 
F_UINT
 
	$round_∑ck_sf
(
uöt32_t
 
a_sign
, 
a_exp
, 
F_UINT
 
a_m™t
,

109 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
)

111 
diff
;

112 
uöt32_t
 
addíd
, 
∫d_bôs
;

114 
rm
) {

115 
RM_RNE
:

116 
RM_RMM
:

117 
addíd
 = (1 << (
RND_SIZE
 - 1));

119 
RM_RTZ
:

120 
addíd
 = 0;

123 
RM_RDN
:

124 
RM_RUP
:

126 i‡(
a_sign
 ^ (
rm
 & 1))

127 
addíd
 = (1 << 
RND_SIZE
) - 1;

129 
addíd
 = 0;

134 i‡(
a_exp
 <= 0) {

135 
BOOL
 
is_subn‹mÆ
;

138 
is_subn‹mÆ
 = (
a_exp
 < 0 ||

139 (
a_m™t
 + 
addíd
Ë< ((
F_UINT
)1 << (
F_SIZE
 - 1)));

140 
diff
 = 1 - 
a_exp
;

141 
a_m™t
 = 
	`rshi·_∫d
◊_m™t, 
diff
);

142 
∫d_bôs
 = 
a_m™t
 & ((1 << 
RND_SIZE
 ) - 1);

143 i‡(
is_subn‹mÆ
 && 
∫d_bôs
 != 0) {

144 *
pfÊags
 |
FFLAG_UNDERFLOW
;

146 
a_exp
 = 1;

148 
∫d_bôs
 = 
a_m™t
 & ((1 << 
RND_SIZE
 ) - 1);

150 i‡(
∫d_bôs
 != 0)

151 *
pfÊags
 |
FFLAG_INEXACT
;

152 
a_m™t
 = (a_m™à+ 
addíd
Ë>> 
RND_SIZE
;

154 i‡(
rm
 =
RM_RNE
 && 
∫d_bôs
 =(1 << (
RND_SIZE
 - 1)))

155 
a_m™t
 &= ~1;

158 
a_exp
 +
a_m™t
 >> (
MANT_SIZE
 + 1);

159 i‡(
a_m™t
 <
MANT_MASK
) {

161 
a_exp
 = 0;

162 } i‡(
a_exp
 >
EXP_MASK
) {

164 i‡(
addíd
 == 0) {

165 
a_exp
 = 
EXP_MASK
 - 1;

166 
a_m™t
 = 
MANT_MASK
;

169 
a_exp
 = 
EXP_MASK
;

170 
a_m™t
 = 0;

172 *
pfÊags
 |
FFLAG_OVERFLOW
 | 
FFLAG_INEXACT
;

174  
	`∑ck_sf
(
a_sign
, 
a_exp
, 
a_m™t
);

175 
	}
}

178 
F_UINT
 
	$n‹mÆize_sf
(
uöt32_t
 
a_sign
, 
a_exp
, 
F_UINT
 
a_m™t
,

179 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
)

181 
shi·
;

182 
shi·
 = 
	`˛z
(
a_m™t
Ë- (
F_SIZE
 - 1 - 
IMANT_SIZE
);

183 
	`as£π
(
shi·
 >= 0);

184 
a_exp
 -
shi·
;

185 
a_m™t
 <<
shi·
;

186  
	`round_∑ck_sf
(
a_sign
, 
a_exp
, 
a_m™t
, 
rm
, 
pfÊags
);

187 
	}
}

191 
F_UINT
 
	$n‹mÆize2_sf
(
uöt32_t
 
a_sign
, 
a_exp
, 
F_UINT
 
a_m™t1
, F_UINT 
a_m™t0
,

192 
RoundögModeEnum
 
rm
, 
uöt32_t
 *
pfÊags
)

194 
l
, 
shi·
;

195 i‡(
a_m™t1
 == 0) {

196 
l
 = 
F_SIZE
 + 
	`˛z
(
a_m™t0
);

198 
l
 = 
	`˛z
(
a_m™t1
);

200 
shi·
 = 
l
 - (
F_SIZE
 - 1 - 
IMANT_SIZE
);

201 
	`as£π
(
shi·
 >= 0);

202 
a_exp
 -
shi·
;

203 i‡(
shi·
 == 0) {

204 
a_m™t1
 |(
a_m™t0
 != 0);

205 } i‡(
shi·
 < 
F_SIZE
) {

206 
a_m™t1
 = (a_m™t1 << 
shi·
Ë| (
a_m™t0
 >> (
F_SIZE
 - shift));

207 
a_m™t0
 <<
shi·
;

208 
a_m™t1
 |(
a_m™t0
 != 0);

210 
a_m™t1
 = 
a_m™t0
 << (
shi·
 - 
F_SIZE
);

212  
	`round_∑ck_sf
(
a_sign
, 
a_exp
, 
a_m™t1
, 
rm
, 
pfÊags
);

213 
	}
}

215 
BOOL
 
	$issig«n_sf
(
F_UINT
 
a
)

217 
uöt32_t
 
a_exp1
;

218 
F_UINT
 
a_m™t
;

219 
a_exp1
 = (
a
 >> (
MANT_SIZE
 - 1)Ë& ((1 << (
EXP_SIZE
 + 1)) - 1);

220 
a_m™t
 = 
a
 & 
MANT_MASK
;

221  (
a_exp1
 =(2 * 
EXP_MASK
Ë&& 
a_m™t
 != 0);

222 
	}
}

224 
BOOL
 
	$i¢™_sf
(
F_UINT
 
a
)

226 
uöt32_t
 
a_exp
;

227 
F_UINT
 
a_m™t
;

228 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

229 
a_m™t
 = 
a
 & 
MANT_MASK
;

230  (
a_exp
 =
EXP_MASK
 && 
a_m™t
 != 0);

231 
	}
}

234 
F_UINT
 
	$add_sf
(
F_UINT
 
a
, F_UINT 
b
, 
RoundögModeEnum
 
rm
,

235 
uöt32_t
 *
pfÊags
)

237 
uöt32_t
 
a_sign
, 
b_sign
, 
a_exp
, 
b_exp
;

238 
F_UINT
 
tmp
, 
a_m™t
, 
b_m™t
;

241 i‡((
a
 & ~
SIGN_MASK
Ë< (
b
 & ~SIGN_MASK)) {

242 
tmp
 = 
a
;

243 
a
 = 
b
;

244 
b
 = 
tmp
;

246 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

247 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

248 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

249 
b_exp
 = (
b
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

250 
a_m™t
 = (
a
 & 
MANT_MASK
) << 3;

251 
b_m™t
 = (
b
 & 
MANT_MASK
) << 3;

252 i‡(
	`u∆ikñy
(
a_exp
 =
EXP_MASK
)) {

253 i‡(
a_m™t
 != 0) {

255 i‡(!(
a_m™t
 & (
QNAN_MASK
 << 3)Ë|| 
	`issig«n_sf
(
b
))

256 *
pfÊags
 |
FFLAG_INVALID_OP
;

257  
F_QNAN
;

258 } i‡(
b_exp
 =
EXP_MASK
 && 
a_sign
 !
b_sign
) {

259 *
pfÊags
 |
FFLAG_INVALID_OP
;

260  
F_QNAN
;

263  
a
;

266 i‡(
a_exp
 == 0) {

267 
a_exp
 = 1;

269 
a_m™t
 |(
F_UINT
)1 << (
MANT_SIZE
 + 3);

271 i‡(
b_exp
 == 0) {

272 
b_exp
 = 1;

274 
b_m™t
 |(
F_UINT
)1 << (
MANT_SIZE
 + 3);

276 
b_m™t
 = 
	`rshi·_∫d
(b_m™t, 
a_exp
 - 
b_exp
);

277 i‡(
a_sign
 =
b_sign
) {

279 
a_m™t
 +
b_m™t
;

282 
a_m™t
 -
b_m™t
;

283 i‡(
a_m™t
 == 0) {

285 
a_sign
 = (
rm
 =
RM_RDN
);

288 
a_exp
 +(
RND_SIZE
 - 3);

289  
	`n‹mÆize_sf
(
a_sign
, 
a_exp
, 
a_m™t
, 
rm
, 
pfÊags
);

290 
	}
}

292 
F_UINT
 
	$glue
(
sub_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
RoundögModeEnum
 
rm
,

293 
uöt32_t
 *
pfÊags
)

295  
	`add_sf
(
a
, 
b
 ^ 
SIGN_MASK
, 
rm
, 
pfÊags
);

296 
	}
}

298 
ölöe
 
F_UINT
 
	$n‹mÆize_subn‹mÆ_sf
(
öt32_t
 *
∑_exp
, 
F_UINT
 
a_m™t
)

300 
shi·
;

301 
shi·
 = 
MANT_SIZE
 - ((
F_SIZE
 - 1 - 
	`˛z
(
a_m™t
)));

302 *
∑_exp
 = 1 - 
shi·
;

303  
a_m™t
 << 
shi·
;

304 
	}
}

306 #ifde‡
F_ULONG


308 
F_UINT
 
	$mul_u
(
F_UINT
 *
∂ow
, F_UINT 
a
, F_UINT 
b
)

310 
F_ULONG
 
r
;

311 
r
 = (
F_ULONG
)
a
 * (F_ULONG)
b
;

312 *
∂ow
 = 
r
;

313  
r
 >> 
F_SIZE
;

314 
	}
}

318 
	#FH_SIZE
 (
F_SIZE
 / 2)

	)

320 
F_UINT
 
	$mul_u
(
F_UINT
 *
∂ow
, F_UINT 
a
, F_UINT 
b
)

322 
F_UHALF
 
a0
, 
a1
, 
b0
, 
b1
, 
r0
, 
r1
, 
r2
, 
r3
;

323 
F_UINT
 
r00
, 
r01
, 
r10
, 
r11
, 
c
;

324 
a0
 = 
a
;

325 
a1
 = 
a
 >> 
FH_SIZE
;

326 
b0
 = 
b
;

327 
b1
 = 
b
 >> 
FH_SIZE
;

329 
r00
 = (
F_UINT
)
a0
 * (F_UINT)
b0
;

330 
r01
 = (
F_UINT
)
a0
 * (F_UINT)
b1
;

331 
r10
 = (
F_UINT
)
a1
 * (F_UINT)
b0
;

332 
r11
 = (
F_UINT
)
a1
 * (F_UINT)
b1
;

334 
r0
 = 
r00
;

335 
c
 = (
r00
 >> 
FH_SIZE
Ë+ (
F_UHALF
)
r01
 + (F_UHALF)
r10
;

336 
r1
 = 
c
;

337 
c
 = (¯>> 
FH_SIZE
Ë+ (
r01
 >> FH_SIZEË+ (
r10
 >> FH_SIZEË+ (
F_UHALF
)
r11
;

338 
r2
 = 
c
;

339 
r3
 = (
c
 >> 
FH_SIZE
Ë+ (
r11
 >> FH_SIZE);

341 *
∂ow
 = ((
F_UINT
)
r1
 << 
FH_SIZE
Ë| 
r0
;

342  ((
F_UINT
)
r3
 << 
FH_SIZE
Ë| 
r2
;

343 
	}
}

345 #unde‡
FH_SIZE


349 
F_UINT
 
	$mul_sf
(
F_UINT
 
a
, F_UINT 
b
, 
RoundögModeEnum
 
rm
,

350 
uöt32_t
 *
pfÊags
)

352 
uöt32_t
 
a_sign
, 
b_sign
, 
r_sign
;

353 
öt32_t
 
a_exp
, 
b_exp
, 
r_exp
;

354 
F_UINT
 
a_m™t
, 
b_m™t
, 
r_m™t
, 
r_m™t_low
;

356 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

357 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

358 
r_sign
 = 
a_sign
 ^ 
b_sign
;

359 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

360 
b_exp
 = (
b
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

361 
a_m™t
 = 
a
 & 
MANT_MASK
;

362 
b_m™t
 = 
b
 & 
MANT_MASK
;

363 i‡(
a_exp
 =
EXP_MASK
 || 
b_exp
 == EXP_MASK) {

364 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
)) {

365 i‡(
	`issig«n_sf
(
a
Ë|| issig«n_sf(
b
)) {

366 *
pfÊags
 |
FFLAG_INVALID_OP
;

368  
F_QNAN
;

371 i‡((
a_exp
 =
EXP_MASK
 && (
b_exp
 =0 && 
b_m™t
 == 0)) ||

372 (
b_exp
 =
EXP_MASK
 && (
a_exp
 =0 && 
a_m™t
 == 0))) {

373 *
pfÊags
 |
FFLAG_INVALID_OP
;

374  
F_QNAN
;

376  
	`∑ck_sf
(
r_sign
, 
EXP_MASK
, 0);

380 i‡(
a_exp
 == 0) {

381 i‡(
a_m™t
 == 0)

382  
	`∑ck_sf
(
r_sign
, 0, 0);

383 
a_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
a_exp
,á_mant);

385 
a_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

387 i‡(
b_exp
 == 0) {

388 i‡(
b_m™t
 == 0)

389  
	`∑ck_sf
(
r_sign
, 0, 0);

390 
b_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
b_exp
, b_mant);

392 
b_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

394 
r_exp
 = 
a_exp
 + 
b_exp
 - (1 << (
EXP_SIZE
 - 1)) + 2;

396 
r_m™t
 = 
	`mul_u
(&
r_m™t_low
,
a_m™t
 << 
RND_SIZE
, 
b_m™t
 << (RND_SIZE + 1));

397 
r_m™t
 |(
r_m™t_low
 != 0);

398  
	`n‹mÆize_sf
(
r_sign
, 
r_exp
, 
r_m™t
, 
rm
, 
pfÊags
);

399 
	}
}

402 
F_UINT
 
	$fma_sf
(
F_UINT
 
a
, F_UINT 
b
, F_UINT 
c
, 
RoundögModeEnum
 
rm
,

403 
uöt32_t
 *
pfÊags
)

405 
uöt32_t
 
a_sign
, 
b_sign
, 
c_sign
, 
r_sign
;

406 
öt32_t
 
a_exp
, 
b_exp
, 
c_exp
, 
r_exp
, 
shi·
;

407 
F_UINT
 
a_m™t
, 
b_m™t
, 
c_m™t
, 
r_m™t1
, 
r_m™t0
, 
c_m™t1
, 
c_m™t0
, 
mask
;

409 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

410 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

411 
c_sign
 = 
c
 >> (
F_SIZE
 - 1);

412 
r_sign
 = 
a_sign
 ^ 
b_sign
;

413 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

414 
b_exp
 = (
b
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

415 
c_exp
 = (
c
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

416 
a_m™t
 = 
a
 & 
MANT_MASK
;

417 
b_m™t
 = 
b
 & 
MANT_MASK
;

418 
c_m™t
 = 
c
 & 
MANT_MASK
;

419 i‡(
a_exp
 =
EXP_MASK
 || 
b_exp
 =EXP_MASK || 
c_exp
 == EXP_MASK) {

420 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
Ë|| i¢™_sf(
c
)) {

421 i‡(
	`issig«n_sf
(
a
Ë|| issig«n_sf(
b
Ë|| issig«n_sf(
c
)) {

422 *
pfÊags
 |
FFLAG_INVALID_OP
;

424  
F_QNAN
;

427 i‡((
a_exp
 =
EXP_MASK
 && (
b_exp
 =0 && 
b_m™t
 == 0)) ||

428 (
b_exp
 =
EXP_MASK
 && (
a_exp
 =0 && 
a_m™t
 == 0)) ||

429 ((
a_exp
 =
EXP_MASK
 || 
b_exp
 == EXP_MASK) &&

430 (
c_exp
 =
EXP_MASK
 && 
r_sign
 !
c_sign
))) {

431 *
pfÊags
 |
FFLAG_INVALID_OP
;

432  
F_QNAN
;

433 } i‡(
c_exp
 =
EXP_MASK
) {

434  
	`∑ck_sf
(
c_sign
, 
EXP_MASK
, 0);

436  
	`∑ck_sf
(
r_sign
, 
EXP_MASK
, 0);

440 i‡(
a_exp
 == 0) {

441 i‡(
a_m™t
 == 0)

442 
mul_zîo
;

443 
a_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
a_exp
,á_mant);

445 
a_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

447 i‡(
b_exp
 == 0) {

448 i‡(
b_m™t
 == 0) {

449 
mul_zîo
:

450 i‡(
c_exp
 =0 && 
c_m™t
 == 0) {

451 i‡(
c_sign
 !
r_sign
)

452 
r_sign
 = (
rm
 =
RM_RDN
);

453  
	`∑ck_sf
(
r_sign
, 0, 0);

455  
c
;

458 
b_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
b_exp
, b_mant);

460 
b_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

463 
r_exp
 = 
a_exp
 + 
b_exp
 - (1 << (
EXP_SIZE
 - 1)) + 3;

465 
r_m™t1
 = 
	`mul_u
(&
r_m™t0
, 
a_m™t
 << 
RND_SIZE
, 
b_m™t
 << RND_SIZE);

467 i‡(
r_m™t1
 < ((
F_UINT
)1 << (
F_SIZE
 - 3))) {

468 
r_m™t1
 = (r_m™t1 << 1Ë| (
r_m™t0
 >> (
F_SIZE
 - 1));

469 
r_m™t0
 <<= 1;

470 
r_exp
--;

474 i‡(
c_exp
 == 0) {

475 i‡(
c_m™t
 == 0) {

477 
r_m™t1
 |(
r_m™t0
 != 0);

478  
	`n‹mÆize_sf
(
r_sign
, 
r_exp
, 
r_m™t1
, 
rm
, 
pfÊags
);

480 
c_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
c_exp
, c_mant);

482 
c_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

484 
c_exp
++;

485 
c_m™t1
 = 
c_m™t
 << (
RND_SIZE
 - 1);

486 
c_m™t0
 = 0;

492 i‡(!(
r_exp
 > 
c_exp
 || (r_ex∞=c_ex∞&& 
r_m™t1
 >
c_m™t1
))) {

493 
F_UINT
 
tmp
;

494 
öt32_t
 
c_tmp
;

496 
tmp
 = 
r_m™t1
;Ñ_m™t1 = 
c_m™t1
; c_mant1 =Åmp;

497 
tmp
 = 
r_m™t0
;Ñ_m™t0 = 
c_m™t0
; c_mant0 =Åmp;

498 
c_tmp
 = 
r_exp
;Ñ_ex∞
c_exp
; c_exp = c_tmp;

499 
c_tmp
 = 
r_sign
;Ñ_sig¿
c_sign
; c_sign = c_tmp;

502 
shi·
 = 
r_exp
 - 
c_exp
;

503 i‡(
shi·
 >2 * 
F_SIZE
) {

504 
c_m™t0
 = (c_m™t0 | 
c_m™t1
) != 0;

505 
c_m™t1
 = 0;

506 } i‡(
shi·
 >
F_SIZE
 + 1) {

507 
c_m™t0
 = 
	`rshi·_∫d
(
c_m™t1
, 
shi·
 - 
F_SIZE
);

508 
c_m™t1
 = 0;

509 } i‡(
shi·
 =
F_SIZE
) {

510 
c_m™t0
 = 
c_m™t1
 | (c_mant0 != 0);

511 
c_m™t1
 = 0;

512 } i‡(
shi·
 != 0) {

513 
mask
 = ((
F_UINT
)1 << 
shi·
) - 1;

514 
c_m™t0
 = (
c_m™t1
 << (
F_SIZE
 - 
shi·
)Ë| (c_m™t0 >> shi·Ë| ((c_m™t0 & 
mask
) != 0);

515 
c_m™t1
 = c_m™t1 >> 
shi·
;

520 i‡(
r_sign
 =
c_sign
) {

521 
r_m™t0
 +
c_m™t0
;

522 
r_m™t1
 +
c_m™t1
 + (
r_m™t0
 < 
c_m™t0
);

524 
F_UINT
 
tmp
;

525 
tmp
 = 
r_m™t0
;

526 
r_m™t0
 -
c_m™t0
;

527 
r_m™t1
 =Ñ_m™t1 - 
c_m™t1
 - (
r_m™t0
 > 
tmp
);

528 i‡((
r_m™t0
 | 
r_m™t1
) == 0) {

530 
r_sign
 = (
rm
 =
RM_RDN
);

536 i‡(
r_m™t1
 == 0) {

537 
r_m™t1
 = 
r_m™t0
;

538 
r_exp
 -
F_SIZE
;

540 
shi·
 = 
	`˛z
(
r_m™t1
Ë- (
F_SIZE
 - 1 - 
IMANT_SIZE
);

541 i‡(
shi·
 != 0) {

542 
r_m™t1
 = (r_m™t1 << 
shi·
Ë| (
r_m™t0
 >> (
F_SIZE
 - shift));

543 
r_m™t0
 <<
shi·
;

544 
r_exp
 -
shi·
;

546 
r_m™t1
 |(
r_m™t0
 != 0);

548  
	`n‹mÆize_sf
(
r_sign
, 
r_exp
, 
r_m™t1
, 
rm
, 
pfÊags
);

550  
	`n‹mÆize2_sf
(
r_sign
, 
r_exp
, 
r_m™t1
, 
r_m™t0
, 
rm
, 
pfÊags
);

552 
	}
}

554 #ifde‡
F_ULONG


556 
F_UINT
 
	$divªm_u
(
F_UINT
 *
¥
, F_UINT 
ah
, F_UINT 
Æ
, F_UINT 
b
)

558 
F_ULONG
 
a
;

559 
a
 = ((
F_ULONG
)
ah
 << 
F_SIZE
Ë| 
Æ
;

560 *
¥
 = 
a
 % 
b
;

561  
a
 / 
b
;

562 
	}
}

567 
F_UINT
 
	$divªm_u
(
F_UINT
 *
¥
, F_UINT 
a1
, F_UINT 
a0
, F_UINT 
b
)

569 
i
, 
qb
, 
ab
;

571 
	`as£π
(
a1
 < 
b
);

572 
i
 = 0; i < 
F_SIZE
; i++) {

573 
ab
 = 
a1
 >> (
F_SIZE
 - 1);

574 
a1
 = (a1 << 1Ë| (
a0
 >> (
F_SIZE
 - 1));

575 i‡(
ab
 || 
a1
 >
b
) {

576 
a1
 -
b
;

577 
qb
 = 1;

579 
qb
 = 0;

581 
a0
 = (a0 << 1Ë| 
qb
;

583 *
¥
 = 
a1
;

584  
a0
;

585 
	}
}

589 
F_UINT
 
	$div_sf
(
F_UINT
 
a
, F_UINT 
b
, 
RoundögModeEnum
 
rm
,

590 
uöt32_t
 *
pfÊags
)

592 
uöt32_t
 
a_sign
, 
b_sign
, 
r_sign
;

593 
öt32_t
 
a_exp
, 
b_exp
, 
r_exp
;

594 
F_UINT
 
a_m™t
, 
b_m™t
, 
r_m™t
, 
r
;

596 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

597 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

598 
r_sign
 = 
a_sign
 ^ 
b_sign
;

599 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

600 
b_exp
 = (
b
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

601 
a_m™t
 = 
a
 & 
MANT_MASK
;

602 
b_m™t
 = 
b
 & 
MANT_MASK
;

603 i‡(
a_exp
 =
EXP_MASK
) {

604 i‡(
a_m™t
 !0 || 
	`i¢™_sf
(
b
)) {

605 i‡(
	`issig«n_sf
(
a
Ë|| issig«n_sf(
b
)) {

606 *
pfÊags
 |
FFLAG_INVALID_OP
;

608  
F_QNAN
;

609 } i‡(
b_exp
 =
EXP_MASK
) {

610 *
pfÊags
 |
FFLAG_INVALID_OP
;

611  
F_QNAN
;

613  
	`∑ck_sf
(
r_sign
, 
EXP_MASK
, 0);

615 } i‡(
b_exp
 =
EXP_MASK
) {

616 i‡(
b_m™t
 != 0) {

617 i‡(
	`issig«n_sf
(
a
Ë|| issig«n_sf(
b
)) {

618 *
pfÊags
 |
FFLAG_INVALID_OP
;

620  
F_QNAN
;

622  
	`∑ck_sf
(
r_sign
, 0, 0);

626 i‡(
b_exp
 == 0) {

627 i‡(
b_m™t
 == 0) {

629 i‡(
a_exp
 =0 && 
a_m™t
 == 0) {

630 *
pfÊags
 |
FFLAG_INVALID_OP
;

631  
F_QNAN
;

633 *
pfÊags
 |
FFLAG_DIVIDE_ZERO
;

634  
	`∑ck_sf
(
r_sign
, 
EXP_MASK
, 0);

637 
b_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
b_exp
, b_mant);

639 
b_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

641 i‡(
a_exp
 == 0) {

642 i‡(
a_m™t
 == 0)

643  
	`∑ck_sf
(
r_sign
, 0, 0);

644 
a_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
a_exp
,á_mant);

646 
a_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

648 
r_exp
 = 
a_exp
 - 
b_exp
 + (1 << (
EXP_SIZE
 - 1)) - 1;

649 
r_m™t
 = 
	`divªm_u
(&
r
, 
a_m™t
, 0, 
b_m™t
 << 2);

650 i‡(
r
 != 0)

651 
r_m™t
 |= 1;

652  
	`n‹mÆize_sf
(
r_sign
, 
r_exp
, 
r_m™t
, 
rm
, 
pfÊags
);

653 
	}
}

655 #ifde‡
F_ULONG


659 
	$sqπªm_u
(
F_UINT
 *
¥
, F_UINT 
ah
, F_UINT 
Æ
)

661 
F_ULONG
 
a
, 
u
, 
s
;

662 
l
, 
öexa˘
;

665 i‡(
ah
 != 0) {

666 
l
 = 2 * 
F_SIZE
 - 
	`˛z
(
ah
 - 1);

668 i‡(
Æ
 == 0) {

669 *
¥
 = 0;

672 
l
 = 
F_SIZE
 - 
	`˛z
(
Æ
 - 1);

674 
a
 = ((
F_ULONG
)
ah
 << 
F_SIZE
Ë| 
Æ
;

675 
u
 = (
F_ULONG
)1 << ((
l
 + 1) / 2);

677 
s
 = 
u
;

678 
u
 = ((
a
 / 
s
) + s) / 2;

679 i‡(
u
 >
s
)

682 
öexa˘
 = (
a
 - 
s
 * s) != 0;

683 *
¥
 = 
s
;

684  
öexa˘
;

685 
	}
}

689 
	$sqπªm_u
(
F_UINT
 *
¥
, F_UINT 
a1
, F_UINT 
a0
)

691 
l
, 
öexa˘
;

692 
F_UINT
 
u
, 
s
, 
r
, 
q
, 
sq0
, 
sq1
;

695 i‡(
a1
 != 0) {

696 
l
 = 2 * 
F_SIZE
 - 
	`˛z
(
a1
 - 1);

698 i‡(
a0
 == 0) {

699 *
¥
 = 0;

702 
l
 = 
F_SIZE
 - 
	`˛z
(
a0
 - 1);

704 
u
 = (
F_UINT
)1 << ((
l
 + 1) / 2);

706 
s
 = 
u
;

707 
q
 = 
	`divªm_u
(&
r
, 
a1
, 
a0
, 
s
);

708 
u
 = (
q
 + 
s
) / 2;

709 i‡(
u
 >
s
)

712 
sq1
 = 
	`mul_u
(&
sq0
, 
s
, s);

713 
öexa˘
 = (
sq0
 !
a0
 || 
sq1
 !
a1
);

714 *
¥
 = 
s
;

715  
öexa˘
;

716 
	}
}

720 
F_UINT
 
	$sqπ_sf
(
F_UINT
 
a
, 
RoundögModeEnum
 
rm
,

721 
uöt32_t
 *
pfÊags
)

723 
uöt32_t
 
a_sign
;

724 
öt32_t
 
a_exp
;

725 
F_UINT
 
a_m™t
;

727 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

728 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

729 
a_m™t
 = 
a
 & 
MANT_MASK
;

730 i‡(
a_exp
 =
EXP_MASK
) {

731 i‡(
a_m™t
 != 0) {

732 i‡(
	`issig«n_sf
(
a
)) {

733 *
pfÊags
 |
FFLAG_INVALID_OP
;

735  
F_QNAN
;

736 } i‡(
a_sign
) {

737 
√g_îr‹
;

739  
a
;

742 i‡(
a_sign
) {

743 i‡(
a_exp
 =0 && 
a_m™t
 == 0)

744  
a
;

745 
√g_îr‹
:

746 *
pfÊags
 |
FFLAG_INVALID_OP
;

747  
F_QNAN
;

749 i‡(
a_exp
 == 0) {

750 i‡(
a_m™t
 == 0)

751  
	`∑ck_sf
(0, 0, 0);

752 
a_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf
(&
a_exp
,á_mant);

754 
a_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

756 
a_exp
 -
EXP_MASK
 / 2;

758 i‡(
a_exp
 & 1) {

759 
a_exp
--;

760 
a_m™t
 <<= 1;

762 
a_exp
 = (a_ex∞>> 1Ë+ 
EXP_MASK
 / 2;

763 
a_m™t
 <<(
F_SIZE
 - 4 - 
MANT_SIZE
);

764 i‡(
	`sqπªm_u
(&
a_m™t
,á_mant, 0))

765 
a_m™t
 |= 1;

766  
	`n‹mÆize_sf
(
a_sign
, 
a_exp
, 
a_m™t
, 
rm
, 
pfÊags
);

767 
	}
}

771 
F_UINT
 
	$glue
(
mö_max_«n_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
uöt32_t
 *
pfÊags
, 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
)

773 i‡(
	`issig«n_sf
(
a
Ë|| issig«n_sf(
b
)) {

774 *
pfÊags
 |
FFLAG_INVALID_OP
;

775 i‡(
mömax_ty≥
 =
FMINMAX_IEEE754_2008
)

776  
F_QNAN
;

778 i‡(
mömax_ty≥
 =
FMINMAX_PROP
) {

779  
F_QNAN
;

781 i‡(
	`i¢™_sf
(
a
)) {

782 i‡(
	`i¢™_sf
(
b
))

783  
F_QNAN
;

785  
b
;

787  
a
;

790 
	}
}

792 
F_UINT
 
	$glue
(
mö_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
uöt32_t
 *
pfÊags
,

793 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
)

795 
uöt32_t
 
a_sign
, 
b_sign
;

797 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
)) {

798  
	`glue
(
mö_max_«n_sf
, 
F_SIZE
)(
a
, 
b
, 
pfÊags
, 
mömax_ty≥
);

800 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

801 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

803 i‡(
a_sign
 !
b_sign
) {

804 i‡(
a_sign
)

805  
a
;

807  
b
;

809 i‡((
a
 < 
b
Ë^ 
a_sign
)

810  
a
;

812  
b
;

814 
	}
}

816 
F_UINT
 
	$glue
(
max_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
uöt32_t
 *
pfÊags
,

817 
So·FPMöMaxTy≥Enum
 
mömax_ty≥
)

819 
uöt32_t
 
a_sign
, 
b_sign
;

821 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
)) {

822  
	`glue
(
mö_max_«n_sf
, 
F_SIZE
)(
a
, 
b
, 
pfÊags
, 
mömax_ty≥
);

824 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

825 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

827 i‡(
a_sign
 !
b_sign
) {

828 i‡(
a_sign
)

829  
b
;

831  
a
;

833 i‡((
a
 < 
b
Ë^ 
a_sign
)

834  
b
;

836  
a
;

838 
	}
}

840 
	$glue
(
eq_quõt_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
uöt32_t
 *
pfÊags
)

842 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
)) {

843 i‡(
	`issig«n_sf
(
a
Ë|| issig«n_sf(
b
)) {

844 *
pfÊags
 |
FFLAG_INVALID_OP
;

849 i‡((
F_UINT
)((
a
 | 
b
) << 1) == 0)

851  (
a
 =
b
);

852 
	}
}

854 
	$glue
(
À_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
uöt32_t
 *
pfÊags
)

856 
uöt32_t
 
a_sign
, 
b_sign
;

858 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
)) {

859 *
pfÊags
 |
FFLAG_INVALID_OP
;

863 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

864 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

865 i‡(
a_sign
 !
b_sign
) {

866  (
a_sign
 || ((
F_UINT
)((
a
 | 
b
) << 1) == 0));

868 i‡(
a_sign
) {

869  (
a
 >
b
);

871  (
a
 <
b
);

874 
	}
}

876 
	$glue
(
…_sf
, 
F_SIZE
)(
F_UINT
 
a
, F_UINT 
b
, 
uöt32_t
 *
pfÊags
)

878 
uöt32_t
 
a_sign
, 
b_sign
;

880 i‡(
	`i¢™_sf
(
a
Ë|| i¢™_sf(
b
)) {

881 *
pfÊags
 |
FFLAG_INVALID_OP
;

885 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

886 
b_sign
 = 
b
 >> (
F_SIZE
 - 1);

887 i‡(
a_sign
 !
b_sign
) {

888  (
a_sign
 && ((
F_UINT
)((
a
 | 
b
) << 1) != 0));

890 i‡(
a_sign
) {

891  (
a
 > 
b
);

893  (
a
 < 
b
);

896 
	}
}

898 
uöt32_t
 
	$glue
(
f˛ass_sf
, 
F_SIZE
)(
F_UINT
 
a
)

900 
uöt32_t
 
a_sign
;

901 
öt32_t
 
a_exp
;

902 
F_UINT
 
a_m™t
;

903 
uöt32_t
 
ªt
;

905 
a_sign
 = 
a
 >> (
F_SIZE
 - 1);

906 
a_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

907 
a_m™t
 = 
a
 & 
MANT_MASK
;

908 i‡(
a_exp
 =
EXP_MASK
) {

909 i‡(
a_m™t
 != 0) {

910 i‡(
a_m™t
 & 
QNAN_MASK
)

911 
ªt
 = 
FCLASS_QNAN
;

913 
ªt
 = 
FCLASS_SNAN
;

915 i‡(
a_sign
)

916 
ªt
 = 
FCLASS_NINF
;

918 
ªt
 = 
FCLASS_PINF
;

920 } i‡(
a_exp
 == 0) {

921 i‡(
a_m™t
 == 0) {

922 i‡(
a_sign
)

923 
ªt
 = 
FCLASS_NZERO
;

925 
ªt
 = 
FCLASS_PZERO
;

927 i‡(
a_sign
)

928 
ªt
 = 
FCLASS_NSUBNORMAL
;

930 
ªt
 = 
FCLASS_PSUBNORMAL
;

933 i‡(
a_sign
)

934 
ªt
 = 
FCLASS_NNORMAL
;

936 
ªt
 = 
FCLASS_PNORMAL
;

938  
ªt
;

939 
	}
}

943 #i‡
F_SIZE
 >= 64

945 
F_UINT
 
	$cvt_sf32_sf
(
uöt32_t
 
a
, uöt32_à*
pfÊags
)

947 
uöt32_t
 
a_sign
;

948 
öt32_t
 
a_exp
;

949 
F_UINT
 
a_m™t
;

951 
a_m™t
 = 
	`u≈ack_sf32
(&
a_sign
, &
a_exp
, 
a
);

952 i‡(
a_exp
 == 0xff) {

953 i‡(
a_m™t
 != 0) {

955 i‡(
	`issig«n_sf32
(
a
)) {

956 *
pfÊags
 |
FFLAG_INVALID_OP
;

958  
F_QNAN
;

961  
	`∑ck_sf
(
a_sign
, 
EXP_MASK
, 0);

964 i‡(
a_exp
 == 0) {

965 i‡(
a_m™t
 == 0)

966  
	`∑ck_sf
(
a_sign
, 0, 0);

967 
a_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf32
(&
a_exp
,á_mant);

970 
a_exp
 =á_ex∞- 0x7‡+ (
EXP_MASK
 / 2);

972 
a_m™t
 <<(
MANT_SIZE
 - 23);

975  
	`∑ck_sf
(
a_sign
, 
a_exp
, 
a_m™t
);

976 
	}
}

978 
uöt32_t
 
glue
(glue(
cvt_sf
, 
F_SIZE
), 
_sf32
)(
F_UINT
 
	ga
, 
RoundögModeEnum
 
	grm
,

979 
uöt32_t
 *
	gpfÊags
)

981 
uöt32_t
 
	ga_sign
;

982 
öt32_t
 
	ga_exp
;

983 
F_UINT
 
	ga_m™t
;

985 
	ga_m™t
 = 
u≈ack_sf
(&
a_sign
, &
a_exp
, 
a
);

986 i‡(
	ga_exp
 =
EXP_MASK
) {

987 i‡(
a_m™t
 != 0) {

989 i‡(
issig«n_sf
(
a
)) {

990 *
pfÊags
 |
FFLAG_INVALID_OP
;

992  
	gF_QNAN32
;

995  
∑ck_sf32
(
a_sign
, 0xff, 0);

998 i‡(
	ga_exp
 == 0) {

999 i‡(
a_m™t
 == 0)

1000  
∑ck_sf32
(
a_sign
, 0, 0);

1001 
n‹mÆize_subn‹mÆ_sf
(&
a_exp
, 
a_m™t
);

1003 
	ga_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

1006 
	ga_exp
 = 
a_exp
 - (
EXP_MASK
 / 2) + 0x7f;

1008 
	ga_m™t
 = 
rshi·_∫d
(
a_m™t
, 
MANT_SIZE
 - (32 - 2));

1009  
n‹mÆize_sf32
(
a_sign
, 
a_exp
, 
a_m™t
, 
rm
, 
pfÊags
);

1014 #i‡
F_SIZE
 >= 128

1016 
F_UINT
 
	$cvt_sf64_sf
(
uöt64_t
 
a
, 
uöt32_t
 *
pfÊags
)

1018 
uöt32_t
 
a_sign
;

1019 
öt32_t
 
a_exp
;

1020 
F_UINT
 
a_m™t
;

1022 
a_m™t
 = 
	`u≈ack_sf64
(&
a_sign
, &
a_exp
, 
a
);

1024 i‡(
a_exp
 == 0x7ff) {

1025 i‡(
a_m™t
 != 0) {

1027 i‡(
	`issig«n_sf64
(
a
)) {

1028 *
pfÊags
 |
FFLAG_INVALID_OP
;

1030  
F_QNAN
;

1033  
	`∑ck_sf
(
a_sign
, 
EXP_MASK
, 0);

1036 i‡(
a_exp
 == 0) {

1037 i‡(
a_m™t
 == 0)

1038  
	`∑ck_sf
(
a_sign
, 0, 0);

1039 
a_m™t
 = 
	`n‹mÆize_subn‹mÆ_sf64
(&
a_exp
,á_mant);

1042 
a_exp
 =á_ex∞- 0x3f‡+ (
EXP_MASK
 / 2);

1044 
a_m™t
 <<(
MANT_SIZE
 - 52);

1045  
	`∑ck_sf
(
a_sign
, 
a_exp
, 
a_m™t
);

1046 
	}
}

1048 
uöt64_t
 
glue
(glue(
cvt_sf
, 
F_SIZE
), 
_sf64
)(
F_UINT
 
	ga
, 
RoundögModeEnum
 
	grm
,

1049 
uöt32_t
 *
	gpfÊags
)

1051 
uöt32_t
 
	ga_sign
;

1052 
öt32_t
 
	ga_exp
;

1053 
F_UINT
 
	ga_m™t
;

1055 
	ga_m™t
 = 
u≈ack_sf
(&
a_sign
, &
a_exp
, 
a
);

1056 i‡(
	ga_exp
 =
EXP_MASK
) {

1057 i‡(
a_m™t
 != 0) {

1059 i‡(
issig«n_sf
(
a
)) {

1060 *
pfÊags
 |
FFLAG_INVALID_OP
;

1062  
	gF_QNAN64
;

1065  
∑ck_sf64
(
a_sign
, 0x7ff, 0);

1068 i‡(
	ga_exp
 == 0) {

1069 i‡(
a_m™t
 == 0)

1070  
∑ck_sf64
(
a_sign
, 0, 0);

1071 
n‹mÆize_subn‹mÆ_sf
(&
a_exp
, 
a_m™t
);

1073 
	ga_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

1076 
	ga_exp
 = 
a_exp
 - (
EXP_MASK
 / 2) + 0x3ff;

1078 
	ga_m™t
 = 
rshi·_∫d
(
a_m™t
, 
MANT_SIZE
 - (64 - 2));

1079  
n‹mÆize_sf64
(
a_sign
, 
a_exp
, 
a_m™t
, 
rm
, 
pfÊags
);

1084 #unde‡
˛z


1086 
	#ICVT_SIZE
 32

	)

1087 
	~"so·Â_ãm∂©e_icvt.h
"

1089 
	#ICVT_SIZE
 64

	)

1090 
	~"so·Â_ãm∂©e_icvt.h
"

1092 #ifde‡
HAVE_INT128


1093 
	#ICVT_SIZE
 128

	)

1094 
	~"so·Â_ãm∂©e_icvt.h
"

1097 #unde‡
F_SIZE


1098 #unde‡
F_UINT


1099 #unde‡
F_ULONG


1100 #unde‡
F_UHALF


1101 #unde‡
MANT_SIZE


1102 #unde‡
EXP_SIZE


1103 #unde‡
EXP_MASK


1104 #unde‡
MANT_MASK


1105 #unde‡
SIGN_MASK


1106 #unde‡
IMANT_SIZE


1107 #unde‡
RND_SIZE


1108 #unde‡
QNAN_MASK


1109 #unde‡
F_QNAN


1111 #unde‡
∑ck_sf


1112 #unde‡
u≈ack_sf


1113 #unde‡
rshi·_∫d


1114 #unde‡
round_∑ck_sf


1115 #unde‡
n‹mÆize_sf


1116 #unde‡
n‹mÆize2_sf


1117 #unde‡
issig«n_sf


1118 #unde‡
i¢™_sf


1119 #unde‡
add_sf


1120 #unde‡
mul_sf


1121 #unde‡
fma_sf


1122 #unde‡
div_sf


1123 #unde‡
sqπ_sf


1124 #unde‡
n‹mÆize_subn‹mÆ_sf


1125 #unde‡
divªm_u


1126 #unde‡
sqπªm_u


1127 #unde‡
mul_u


1128 #unde‡
cvt_sf32_sf


1129 #unde‡
cvt_sf64_sf


	@softfp_template_icvt.h

24 #i‡
ICVT_SIZE
 == 32

25 
	#ICVT_UINT
 
uöt32_t


	)

26 
	#ICVT_INT
 
öt32_t


	)

27 #ñi‡
ICVT_SIZE
 == 64

28 
	#ICVT_UINT
 
uöt64_t


	)

29 
	#ICVT_INT
 
öt64_t


	)

30 #ñi‡
ICVT_SIZE
 == 128

31 
	#ICVT_UINT
 
uöt128_t


	)

32 
	#ICVT_INT
 
öt128_t


	)

34 #îr‹ 
unsuµ‹ãd
 
icvt


38 
ICVT_INT
 
glue
(glue(glue(
öã∫Æ_cvt_sf
, 
F_SIZE
), 
_i
), 
ICVT_SIZE
)(
F_UINT
 
	ga
, 
RoundögModeEnum
 
	grm
,

39 
uöt32_t
 *
	gpfÊags
, 
BOOL
 
	gis_unsig√d
)

41 
uöt32_t
 
	ga_sign
, 
	gaddíd
, 
	g∫d_bôs
;

42 
öt32_t
 
	ga_exp
;

43 
F_UINT
 
	ga_m™t
;

44 
ICVT_UINT
 
	gr
, 
	gr_max
;

46 
	ga_sign
 = 
a
 >> (
F_SIZE
 - 1);

47 
	ga_exp
 = (
a
 >> 
MANT_SIZE
Ë& 
EXP_MASK
;

48 
	ga_m™t
 = 
a
 & 
MANT_MASK
;

49 i‡(
	ga_exp
 =
EXP_MASK
 && 
a_m™t
 != 0)

50 
a_sign
 = 0;

51 i‡(
	ga_exp
 == 0) {

52 
a_exp
 = 1;

54 
	ga_m™t
 |(
F_UINT
)1 << 
MANT_SIZE
;

56 
	ga_m™t
 <<
RND_SIZE
;

57 
	ga_exp
 = 
a_exp
 - (
EXP_MASK
 / 2Ë- 
MANT_SIZE
;

59 i‡(
	gis_unsig√d
)

60 
	gr_max
 = (
ICVT_UINT
)
a_sign
 - 1;

62 
	gr_max
 = ((
ICVT_UINT
)1 << (
ICVT_SIZE
 - 1)Ë- (ICVT_UINT)(
a_sign
 ^ 1);

63 i‡(
	ga_exp
 >= 0) {

64 i‡(
a_exp
 <(
ICVT_SIZE
 - 1 - 
MANT_SIZE
)) {

65 
r
 = (
ICVT_UINT
)(
a_m™t
 >> 
RND_SIZE
Ë<< 
a_exp
;

66 i‡(
	gr
 > 
	gr_max
)

67 
	govîÊow
;

69 
	govîÊow
:

70 *
pfÊags
 |
FFLAG_INVALID_OP
;

71  
	gr_max
;

74 
	ga_m™t
 = 
rshi·_∫d
(
a_m™t
, -
a_exp
);

76 
	grm
) {

77 
	gRM_RNE
:

78 
RM_RMM
:

79 
addíd
 = (1 << (
RND_SIZE
 - 1));

81 
	gRM_RTZ
:

82 
addíd
 = 0;

85 
RM_RDN
:

86 
RM_RUP
:

87 i‡(
a_sign
 ^ (
rm
 & 1))

88 
addíd
 = (1 << 
RND_SIZE
) - 1;

90 
	gaddíd
 = 0;

94 
	g∫d_bôs
 = 
a_m™t
 & ((1 << 
RND_SIZE
 ) - 1);

95 
	ga_m™t
 = (
a_m™t
 + 
addíd
Ë>> 
RND_SIZE
;

97 i‡(
	grm
 =
RM_RNE
 && 
∫d_bôs
 =(1 << (
RND_SIZE
 - 1)))

98 
a_m™t
 &= ~1;

99 i‡(
	ga_m™t
 > 
	gr_max
)

100 
	govîÊow
;

101 
	gr
 = 
a_m™t
;

102 i‡(
	g∫d_bôs
 != 0)

103 *
pfÊags
 |
FFLAG_INEXACT
;

105 i‡(
	ga_sign
)

106 
	gr
 = -
r
;

107  
	gr
;

110 
ICVT_INT
 
glue
(glue(glue(
cvt_sf
, 
F_SIZE
), 
_i
), 
ICVT_SIZE
)(
F_UINT
 
	ga
, 
RoundögModeEnum
 
	grm
,

111 
uöt32_t
 *
	gpfÊags
)

113  
glue
(glue(glue(
öã∫Æ_cvt_sf
, 
F_SIZE
), 
_i
), 
ICVT_SIZE
)(
	ga
, 
	grm
,

114 
	gpfÊags
, 
	gFALSE
);

117 
ICVT_UINT
 
glue
(glue(glue(
cvt_sf
, 
F_SIZE
), 
_u
), 
ICVT_SIZE
)(
F_UINT
 
	ga
, 
RoundögModeEnum
 
	grm
,

118 
uöt32_t
 *
	gpfÊags
)

120  
glue
(glue(glue(
öã∫Æ_cvt_sf
, 
F_SIZE
), 
_i
), 
ICVT_SIZE
Ë(
	ga
, 
	grm
,

121 
	gpfÊags
, 
	gTRUE
);

125 
F_UINT
 
glue
(glue(glue(
öã∫Æ_cvt_i
, 
ICVT_SIZE
), 
_sf
), 
F_SIZE
)(
ICVT_INT
 
	ga
,

126 
RoundögModeEnum
 
	grm
,

127 
uöt32_t
 *
	gpfÊags
,

128 
BOOL
 
	gis_unsig√d
)

130 
uöt32_t
 
	ga_sign
;

131 
öt32_t
 
	ga_exp
;

132 
F_UINT
 
	ga_m™t
;

133 
ICVT_UINT
 
	gr
, 
	gmask
;

134 
	gl
;

136 i‡(!
	gis_unsig√d
 && 
	ga
 < 0) {

137 
	ga_sign
 = 1;

138 
	gr
 = -(
ICVT_UINT
)
a
;

140 
	ga_sign
 = 0;

141 
	gr
 = 
a
;

143 
	ga_exp
 = (
EXP_MASK
 / 2Ë+ 
F_SIZE
 - 2;

145 
	gl
 = 
ICVT_SIZE
 - 
glue
(
˛z
, ICVT_SIZE)(
	gr
Ë- (
	gF_SIZE
 - 1);

146 i‡(
	gl
 > 0) {

147 
	gmask
 = 
r
 & (((
ICVT_UINT
)1 << 
l
) - 1);

148 
	gr
 = (
r
 >> 
l
Ë| (‘ & 
mask
) != 0);

149 
	ga_exp
 +
l
;

151 
	ga_m™t
 = 
r
;

152  
n‹mÆize_sf
(
a_sign
, 
a_exp
, 
a_m™t
, 
rm
, 
pfÊags
);

155 
F_UINT
 
glue
(glue(glue(
cvt_i
, 
ICVT_SIZE
), 
_sf
), 
F_SIZE
)(
ICVT_INT
 
	ga
,

156 
RoundögModeEnum
 
	grm
,

157 
uöt32_t
 *
	gpfÊags
)

159  
glue
(glue(glue(
öã∫Æ_cvt_i
, 
ICVT_SIZE
), 
_sf
), 
F_SIZE
)(
	ga
, 
	grm
, 
	gpfÊags
, 
	gFALSE
);

162 
F_UINT
 
glue
(glue(glue(
cvt_u
, 
ICVT_SIZE
), 
_sf
), 
F_SIZE
)(
ICVT_UINT
 
	ga
,

163 
RoundögModeEnum
 
	grm
,

164 
uöt32_t
 *
	gpfÊags
)

166  
glue
(glue(glue(
öã∫Æ_cvt_i
, 
ICVT_SIZE
), 
_sf
), 
F_SIZE
)(
	ga
, 
	grm
, 
	gpfÊags
, 
	gTRUE
);

169 #unde‡
ICVT_SIZE


170 #unde‡
ICVT_INT


171 #unde‡
ICVT_UINT


	@splitimg.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<öây≥s.h
>

27 
	~<°rög.h
>

28 
	~<˘y≥.h
>

29 
	~<gë›t.h
>

31 
	$maö
(
¨gc
, **
¨gv
)

33 
blocksize
, 
ªt
, 
i
;

34 c⁄° *
öfûíame
, *
ouç©h
;

35 
FILE
 *
f
, *
fo
;

36 
buf1
[1024];

37 
uöt8_t
 *
buf
;

39 i‡((
›töd
 + 1Ë>
¨gc
) {

40 
	`¥ötf
("•lôimg vîsi⁄ " 
CONFIG_VERSION
 ", Copyright (c) 2011-2016 Fabrice Bellard\n"

46 
	`exô
(1);

49 
öfûíame
 = 
¨gv
[
›töd
++];

50 
ouç©h
 = 
¨gv
[
›töd
++];

51 
blocksize
 = 256;

52 i‡(
›töd
 < 
¨gc
)

53 
blocksize
 = 
	`°πﬁ
(
¨gv
[
›töd
++], 
NULL
, 0);

55 
blocksize
 *= 1024;

57 
buf
 = 
	`mÆloc
(
blocksize
);

59 
f
 = 
	`f›í
(
öfûíame
, "rb");

60 i‡(!
f
) {

61 
	`≥º‹
(
öfûíame
);

62 
	`exô
(1);

64 
i
 = 0;

66 
ªt
 = 
	`‰ód
(
buf
, 1, 
blocksize
, 
f
);

67 i‡(
ªt
 < 0) {

68 
	`≥º‹
("fread");

69 
	`exô
(1);

71 i‡(
ªt
 == 0)

73 i‡(
ªt
 < 
blocksize
) {

74 
	`¥ötf
("warning:Üast block isÇot full\n");

75 
	`mem£t
(
buf
 + 
ªt
, 0, 
blocksize
 -Ñet);

77 
	`¢¥ötf
(
buf1
, (buf1), "%s/blk%09u.bö", 
ouç©h
, 
i
);

78 
fo
 = 
	`f›í
(
buf1
, "wb");

79 i‡(!
fo
) {

80 
	`≥º‹
(
buf1
);

81 
	`exô
(1);

83 
	`fwrôe
(
buf
, 1, 
blocksize
, 
fo
);

84 
	`f˛o£
(
fo
);

85 
i
++;

87 
	`f˛o£
(
f
);

88 
	`¥ötf
("%d blocks\n", 
i
);

90 
	`¢¥ötf
(
buf1
, (buf1), "%s/blk.txt", 
ouç©h
);

91 
fo
 = 
	`f›í
(
buf1
, "wb");

92 i‡(!
fo
) {

93 
	`≥º‹
(
buf1
);

94 
	`exô
(1);

96 
	`Ârötf
(
fo
, "{\n");

97 
	`Ârötf
(
fo
, " block_size: %d,\n", 
blocksize
 / 1024);

98 
	`Ârötf
(
fo
, "Ç_block: %d,\n", 
i
);

99 
	`Ârötf
(
fo
, "}\n");

100 
	`f˛o£
(
fo
);

102 
	}
}

	@stats_display.c

33 
	~<î∫o.h
>

34 
	~<f˙é.h
>

35 
	~<öây≥s.h
>

36 
	~<°dio.h
>

37 
	~<°dlib.h
>

38 
	~<°rög.h
>

39 
	~<sys/mm™.h
>

40 
	~<sys/°©.h
>

41 
	~<time.h
>

42 
	~<uni°d.h
>

44 
	~"riscvsim/sim_∑øms_°©s.h
"

46 
	#GET_TOTAL_STAT
(
©å
Ë(
s
[0].©å + s[1].©å + s[2].©å + s[3].©å)

	)

48 
	g°©s_shm_fd
;

49 
SimSèts
 *
	gs
;

52 
	$£tup_c⁄√˘i⁄
()

54 
n£c_∑s£d
 = 0;

55 
n€¡_¥öt
 = 0;

56 
ªåy
:

57 
°©s_shm_fd
 = 
	`shm_›í
(
MARSS_STATS_SHM_NAME
, 
O_RDWR
, 0);

58 i‡(
°©s_shm_fd
 < 0)

60 i‡(
î∫o
 =
ENOENT
)

62 c⁄° 
n£c
 = 1000000;

63 
time•ec
 
ts
 = {.
tv_£c
 = 0, .
tv_n£c
 = 
n£c
};

64 i‡(
n€¡_¥öt
 == 0)

66 
	`Ârötf
(
°dîr
, "cannot open shm %s,"

68 
MARSS_STATS_SHM_NAME
, 
n£c
);

69 ++
n€¡_¥öt
;

71 i‡(
n£c_∑s£d
 > 1000000000)

73 
	`Ârötf
(
°dîr
, ".");

74 ++
n€¡_¥öt
;

75 
n£c_∑s£d
 = 0;

77 
n£c_∑s£d
 +
n£c
;

78 
	`«no¶ìp
(&
ts
, 
NULL
);

79 
ªåy
;

83 
	`≥º‹
("setup_connection(): "

85 
	`exô
(
î∫o
);

88 i‡(
n€¡_¥öt
)

89 
	`Ârötf
(
°dîr
, "\n");

90 i‡((
s
 = (
SimSèts
 *)
	`mm≠
(
NULL
, 
NUM_MAX_PRV_LEVELS
 * (SimSèts), 
PROT_READ
 | 
PROT_WRITE
,

91 
MAP_SHARED
, 
°©s_shm_fd
, 0))

92 =
MAP_FAILED
)

94 
	`Ârötf
(
°dîr
, "ˇ¬Ÿ mm≠ shm %s:", 
MARSS_STATS_SHM_NAME
);

96 
	`Ârötf
(
°dîr
, "mem‹yáâachedáà%p\n", 
s
);

97 
	}
}

100 
	$¥öt_hódî
()

102 
	`¥ötf
("%s\n",

104 
	`¥ötf
("%s\n\n", "Terminal based Simulation Statistics Viewer");

105 
	}
}

109 
	$¥öt_ös_°©s
()

111 
uöt64_t
 
cy˛es
 = 
	`GET_TOTAL_STAT
(cycles);

112 
uöt64_t
 
commôs
 = 
	`GET_TOTAL_STAT
(
ös_simuœãd
);

113 
uöt64_t
 
„tches
 = 
	`GET_TOTAL_STAT
(
ös_„tch
);

114 
uöt64_t
 
Êushed
 = 
„tches
 - 
commôs
;

116 
	`¥ötf
("%-22†: %0.2lf\n", "ùc", (()
commôs
 / ()
cy˛es
));

117 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "cy˛es", 
cy˛es
);

118 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "tŸÆ-commôs", 
commôs
);

119 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "tŸÆ-„tches", 
„tches
);

120 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2l‡%%)\n", "ö¢-Êushed", 
Êushed
,

121 ((()
Êushed
 / ()
„tches
)) * 100);

122 
	`¥ötf
("\n");

123 
	}
}

126 
	$¥öt_bpu_°©s
()

128 
uöt64_t
 
btb_¥obes
 = 
	`GET_TOTAL_STAT
(btb_probes);

129 
uöt64_t
 
btb_hôs
 = 
	`GET_TOTAL_STAT
(btb_hits);

130 
uöt64_t
 
c‹ª˘_¥ed
 = 
	`GET_TOTAL_STAT
(
bpu_c⁄d_c‹ª˘
Ë+ GET_TOTAL_STAT(
bpu_unc⁄d_c‹ª˘
);

131 
uöt64_t
 
öc‹ª˘_¥ed
 = 
	`GET_TOTAL_STAT
(
bpu_c⁄d_öc‹ª˘
Ë+ GET_TOTAL_STAT(
bpu_unc⁄d_öc‹ª˘
);

132 
uöt64_t
 
tŸÆ_bønches
 = 
	`GET_TOTAL_STAT
(
ös_ty≥
[
INS_TYPE_COND_BRANCH
]Ë+ GET_TOTAL_STAT(ös_ty≥[
INS_TYPE_JAL
]Ë+ GET_TOTAL_STAT(ös_ty≥[
INS_TYPE_JALR
]);

134 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "btb-¥obes", 
btb_¥obes
);

135 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2l‡%%)\n", "btb-hôs", 
btb_hôs
,

136 (()
btb_hôs
 / ()
btb_¥obes
) * 100);

137 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "correct-predictions",

138 
c‹ª˘_¥ed
, (()c‹ª˘_¥ed / ()
tŸÆ_bønches
) * 100);

139 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "miss-predictions",

140 
öc‹ª˘_¥ed
,

141 (()
öc‹ª˘_¥ed
 / ()
tŸÆ_bønches
) * 100);

142 
	`¥ötf
("\n");

143 
	}
}

146 
	$¥öt_éb_°©s
()

148 
uöt64_t
 
code_éb_hôs
 = 
	`GET_TOTAL_STAT
(code_tlb_hits);

149 
uöt64_t
 
lﬂd_éb_hôs
 = 
	`GET_TOTAL_STAT
(load_tlb_hits);

150 
uöt64_t
 
°‹e_éb_hôs
 = 
	`GET_TOTAL_STAT
(store_tlb_hits);

152 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2l‡%%)\n", "ôlb-hôs", 
code_éb_hôs
,

153 (()
code_éb_hôs
 / ()
	`GET_TOTAL_STAT
(
code_éb_lookups
))

156 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "load-tlb-hits",

157 
lﬂd_éb_hôs
,

158 (()
lﬂd_éb_hôs
 / ()
	`GET_TOTAL_STAT
(
lﬂd_éb_lookups
))

161 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "store-tlb-hits",

162 
°‹e_éb_hôs
,

163 (()
°‹e_éb_hôs
 / ()
	`GET_TOTAL_STAT
(
°‹e_éb_lookups
))

166 
	`¥ötf
("\n");

167 
	}
}

170 
	$¥öt_ˇches_°©s
()

172 
uöt64_t
 
iˇche_hô
 = 
	`GET_TOTAL_STAT
(
iˇche_ªad
Ë- GET_TOTAL_STAT(
iˇche_ªad_miss
);

173 
uöt64_t
 
dˇche_ªad_hô
 = 
	`GET_TOTAL_STAT
(
dˇche_ªad
Ë- GET_TOTAL_STAT(
dˇche_ªad_miss
);

174 
uöt64_t
 
dˇche_wrôe_hô
 = 
	`GET_TOTAL_STAT
(
dˇche_wrôe
Ë- GET_TOTAL_STAT(
dˇche_wrôe_miss
);

175 
uöt64_t
 
l2_ˇche_ªad_hô
 = 
	`GET_TOTAL_STAT
(
l2_ˇche_ªad
Ë- GET_TOTAL_STAT(
l2_ˇche_ªad_miss
);

176 
uöt64_t
 
l2_ˇche_wrôe_hô
 = 
	`GET_TOTAL_STAT
(
l2_ˇche_wrôe
Ë- GET_TOTAL_STAT(
l2_ˇche_wrôe_miss
);

178 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2l‡%%)\n", "iˇche-hôs", 
iˇche_hô
,

179 (()
iˇche_hô
 / ()
	`GET_TOTAL_STAT
(
iˇche_ªad
)) * 100);

181 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "dcache-read-hits",

182 
dˇche_ªad_hô
,

183 (()
dˇche_ªad_hô
 / ()
	`GET_TOTAL_STAT
(
dˇche_ªad
))

186 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "dcache-write-hits",

187 
dˇche_wrôe_hô
,

188 (()
dˇche_wrôe_hô
 / ()
	`GET_TOTAL_STAT
(
dˇche_wrôe
))

191 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "l2-shared-read-hits",

192 
l2_ˇche_ªad_hô
,

193 (()
l2_ˇche_ªad_hô
 / ()
	`GET_TOTAL_STAT
(
l2_ˇche_ªad
)) * 100);

195 
	`¥ötf
("%-22†: %-22" 
PRIu64
 " (%0.2lf %%)\n", "l2-shared-write-hits",

196 
l2_ˇche_wrôe_hô
,

197 (()
l2_ˇche_wrôe_hô
 / ()
	`GET_TOTAL_STAT
(
l2_ˇche_wrôe
)) * 100);

199 
	`¥ötf
("\n");

200 
	}
}

203 
	$¥öt_ex˚±i⁄_°©s
()

205 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "ins-page-faults",

206 
	`GET_TOTAL_STAT
(
ös_∑ge_Áu…s
));

207 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "load-page-faults",

208 
	`GET_TOTAL_STAT
(
lﬂd_∑ge_Áu…s
));

209 
	`¥ötf
("%-22†: %-22" 
PRIu64
 "\n", "store-page-faults",

210 
	`GET_TOTAL_STAT
(
°‹e_∑ge_Áu…s
));

211 
	}
}

214 
	$maö
(
¨gc
, c⁄° *
¨gv
[])

216 
	`£tup_c⁄√˘i⁄
();

220 
	`¥ötf
("\033[H"

223 
	`¥öt_hódî
();

224 
	`¥öt_ös_°©s
();

225 
	`¥öt_bpu_°©s
();

226 
	`¥öt_ˇches_°©s
();

227 
	`¥öt_ex˚±i⁄_°©s
();

228 
	`u¶ìp
(100000);

231 
	}
}

	@temu.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

30 
	~<f˙é.h
>

31 
	~<î∫o.h
>

32 
	~<uni°d.h
>

33 
	~<time.h
>

34 
	~<gë›t.h
>

35 #i‚de‡
_WIN32


36 
	~<ãrmios.h
>

37 
	~<sys/io˘l.h
>

38 
	~<√t/if.h
>

39 
	~<löux/if_tun.h
>

41 
	~<sys/°©.h
>

42 
	~<sig«l.h
>

44 
	~"cutûs.h
"

45 
	~"iomem.h
"

46 
	~"vútio.h
"

47 
	~"machöe.h
"

48 #ifde‡
CONFIG_FS_NET


49 
	~"fs_utûs.h
"

50 
	~"fs_wgë.h
"

52 #ifde‡
CONFIG_SLIRP


53 
	~"¶úp/lib¶úp.h
"

56 
	~"riscvsim/sim_∑øms_°©s.h
"

58 #i‚de‡
_WIN32


60 
	m°dö_fd
;

61 
	mc⁄sﬁe_esc_°©e
;

62 
BOOL
 
	mªsize_≥ndög
;

63 } 
	tSTDIODevi˚
;

65 
ãrmios
 
	gﬁdây
;

66 
	gﬁd_fd0_Êags
;

67 
STDIODevi˚
 *
	gglobÆ_°dio_devi˚
;

69 
	$ãrm_exô
()

71 
	`tc£èâr
 (0, 
TCSANOW
, &
ﬁdây
);

72 
	`f˙é
(0, 
F_SETFL
, 
ﬁd_fd0_Êags
);

73 
	}
}

75 
	$ãrm_öô
(
BOOL
 
Ælow_˘æc
)

77 
ãrmios
 
ây
;

79 
	`mem£t
(&
ây
, 0, (tty));

80 
	`tcgë©å
 (0, &
ây
);

81 
ﬁdây
 = 
ây
;

82 
ﬁd_fd0_Êags
 = 
	`f˙é
(0, 
F_GETFL
);

84 
ây
.
c_iÊag
 &~(
IGNBRK
|
BRKINT
|
PARMRK
|
ISTRIP


85 |
INLCR
|
IGNCR
|
ICRNL
|
IXON
);

86 
ây
.
c_oÊag
 |
OPOST
;

87 
ây
.
c_lÊag
 &~(
ECHO
|
ECHONL
|
ICANON
|
IEXTEN
);

88 i‡(!
Ælow_˘æc
)

89 
ây
.
c_lÊag
 &~
ISIG
;

90 
ây
.
c_cÊag
 &~(
CSIZE
|
PARENB
);

91 
ây
.
c_cÊag
 |
CS8
;

92 
ây
.
c_cc
[
VMIN
] = 1;

93 
ây
.
c_cc
[
VTIME
] = 0;

95 
	`tc£èâr
 (0, 
TCSANOW
, &
ây
);

97 
	`©exô
(
ãrm_exô
);

98 
	}
}

100 
	$c⁄sﬁe_wrôe
(*
›aque
, c⁄° 
uöt8_t
 *
buf
, 
Àn
)

102 
	`fwrôe
(
buf
, 1, 
Àn
, 
°dout
);

103 
	`fÊush
(
°dout
);

104 
	}
}

106 
	$c⁄sﬁe_ªad
(*
›aque
, 
uöt8_t
 *
buf
, 
Àn
)

108 
STDIODevi˚
 *
s
 = 
›aque
;

109 
ªt
, 
i
, 
j
;

110 
uöt8_t
 
ch
;

112 i‡(
Àn
 <= 0)

115 
ªt
 = 
	`ªad
(
s
->
°dö_fd
, 
buf
, 
Àn
);

116 i‡(
ªt
 < 0)

118 i‡(
ªt
 == 0) {

120 
	`exô
(1);

123 
j
 = 0;

124 
i
 = 0; i < 
ªt
; i++) {

125 
ch
 = 
buf
[
i
];

126 i‡(
s
->
c⁄sﬁe_esc_°©e
) {

127 
s
->
c⁄sﬁe_esc_°©e
 = 0;

128 
ch
) {

130 
	`¥ötf
("Terminated\n");

131 
	`exô
(0);

133 
	`¥ötf
("\n"

140 
ouçut_ch¨
;

145 i‡(
ch
 == 1) {

146 
s
->
c⁄sﬁe_esc_°©e
 = 1;

148 
ouçut_ch¨
:

149 
buf
[
j
++] = 
ch
;

153  
j
;

154 
	}
}

156 
	$ãrm_ªsize_h™dÀr
(
sig
)

158 i‡(
globÆ_°dio_devi˚
)

159 
globÆ_°dio_devi˚
->
ªsize_≥ndög
 = 
TRUE
;

160 
	}
}

162 
	$c⁄sﬁe_gë_size
(
STDIODevi˚
 *
s
, *
pw
, *
ph
)

164 
wösize
 
ws
;

165 
width
, 
height
;

167 
width
 = 80;

168 
height
 = 25;

169 i‡(
	`io˘l
(
s
->
°dö_fd
, 
TIOCGWINSZ
, &
ws
) == 0 &&

170 
ws
.
ws_cﬁ
 >4 && ws.
ws_row
 >= 4) {

171 
width
 = 
ws
.
ws_cﬁ
;

172 
height
 = 
ws
.
ws_row
;

174 *
pw
 = 
width
;

175 *
ph
 = 
height
;

176 
	}
}

178 
Ch¨a˘îDevi˚
 *
	$c⁄sﬁe_öô
(
BOOL
 
Ælow_˘æc
)

180 
Ch¨a˘îDevi˚
 *
dev
;

181 
STDIODevi˚
 *
s
;

182 
siga˘i⁄
 
sig
;

184 
	`ãrm_öô
(
Ælow_˘æc
);

186 
dev
 = 
	`mÆlocz
((*dev));

187 
s
 = 
	`mÆlocz
((*s));

188 
s
->
°dö_fd
 = 0;

191 
	`f˙é
(
s
->
°dö_fd
, 
F_SETFL
, 
O_NONBLOCK
);

193 
s
->
ªsize_≥ndög
 = 
TRUE
;

194 
globÆ_°dio_devi˚
 = 
s
;

197 
sig
.
ß_h™dÀr
 = 
ãrm_ªsize_h™dÀr
;

198 
	`sigem±y£t
(&
sig
.
ß_mask
);

199 
sig
.
ß_Êags
 = 0;

200 
	`siga˘i⁄
(
SIGWINCH
, &
sig
, 
NULL
);

202 
dev
->
›aque
 = 
s
;

203 
dev
->
wrôe_d©a
 = 
c⁄sﬁe_wrôe
;

204 
dev
->
ªad_d©a
 = 
c⁄sﬁe_ªad
;

205  
dev
;

206 
	}
}

211 
	mBF_MODE_RO
,

212 
	mBF_MODE_RW
,

213 
	mBF_MODE_SNAPSHOT
,

214 } 
	tBlockDevi˚ModeEnum
;

216 
	#SECTOR_SIZE
 512

	)

218 
	sBlockDevi˚Fûe
 {

219 
FILE
 *
	mf
;

220 
öt64_t
 
	mnb_£˘‹s
;

221 
BlockDevi˚ModeEnum
 
	mmode
;

222 
uöt8_t
 **
	m£˘‹_èbÀ
;

223 } 
	tBlockDevi˚Fûe
;

225 
öt64_t
 
	$bf_gë_£˘‹_cou¡
(
BlockDevi˚
 *
bs
)

227 
BlockDevi˚Fûe
 *
bf
 = 
bs
->
›aque
;

228  
bf
->
nb_£˘‹s
;

229 
	}
}

233 
	$bf_ªad_async
(
BlockDevi˚
 *
bs
,

234 
uöt64_t
 
£˘‹_num
, 
uöt8_t
 *
buf
, 
n
,

235 
BlockDevi˚Com∂ëi⁄Func
 *
cb
, *
›aque
)

237 
BlockDevi˚Fûe
 *
bf
 = 
bs
->
›aque
;

239 #ifde‡
DUMP_BLOCK_READ


241 
FILE
 *
f
;

242 i‡(!
f
)

243 
f
 = 
	`f›í
("/tmp/read_sect.txt", "wb");

244 
	`Ârötf
(
f
, "%" 
PRId64
 " %d\n", 
£˘‹_num
, 
n
);

247 i‡(!
bf
->
f
)

249 i‡(
bf
->
mode
 =
BF_MODE_SNAPSHOT
) {

250 
i
;

251 
i
 = 0; i < 
n
; i++) {

252 i‡(!
bf
->
£˘‹_èbÀ
[
£˘‹_num
]) {

253 
	`f£ek
(
bf
->
f
, 
£˘‹_num
 * 
SECTOR_SIZE
, 
SEEK_SET
);

254 
	`‰ód
(
buf
, 1, 
SECTOR_SIZE
, 
bf
->
f
);

256 
	`mem˝y
(
buf
, 
bf
->
£˘‹_èbÀ
[
£˘‹_num
], 
SECTOR_SIZE
);

258 
£˘‹_num
++;

259 
buf
 +
SECTOR_SIZE
;

262 
	`f£ek
(
bf
->
f
, 
£˘‹_num
 * 
SECTOR_SIZE
, 
SEEK_SET
);

263 
	`‰ód
(
buf
, 1, 
n
 * 
SECTOR_SIZE
, 
bf
->
f
);

267 
	}
}

269 
	$bf_wrôe_async
(
BlockDevi˚
 *
bs
,

270 
uöt64_t
 
£˘‹_num
, c⁄° 
uöt8_t
 *
buf
, 
n
,

271 
BlockDevi˚Com∂ëi⁄Func
 *
cb
, *
›aque
)

273 
BlockDevi˚Fûe
 *
bf
 = 
bs
->
›aque
;

274 
ªt
;

276 
bf
->
mode
) {

277 
BF_MODE_RO
:

278 
ªt
 = -1;

280 
BF_MODE_RW
:

281 
	`f£ek
(
bf
->
f
, 
£˘‹_num
 * 
SECTOR_SIZE
, 
SEEK_SET
);

282 
	`fwrôe
(
buf
, 1, 
n
 * 
SECTOR_SIZE
, 
bf
->
f
);

283 
ªt
 = 0;

285 
BF_MODE_SNAPSHOT
:

287 
i
;

288 i‡((
£˘‹_num
 + 
n
Ë> 
bf
->
nb_£˘‹s
)

290 
i
 = 0; i < 
n
; i++) {

291 i‡(!
bf
->
£˘‹_èbÀ
[
£˘‹_num
]) {

292 
bf
->
£˘‹_èbÀ
[
£˘‹_num
] = 
	`mÆloc
(
SECTOR_SIZE
);

294 
	`mem˝y
(
bf
->
£˘‹_èbÀ
[
£˘‹_num
], 
buf
, 
SECTOR_SIZE
);

295 
£˘‹_num
++;

296 
buf
 +
SECTOR_SIZE
;

298 
ªt
 = 0;

302 
	`ab‹t
();

305  
ªt
;

306 
	}
}

308 
BlockDevi˚
 *
	$block_devi˚_öô
(c⁄° *
fûíame
,

309 
BlockDevi˚ModeEnum
 
mode
)

311 
BlockDevi˚
 *
bs
;

312 
BlockDevi˚Fûe
 *
bf
;

313 
öt64_t
 
fûe_size
;

314 
FILE
 *
f
;

315 c⁄° *
mode_°r
;

317 i‡(
mode
 =
BF_MODE_RW
) {

318 
mode_°r
 = "r+b";

320 
mode_°r
 = "rb";

323 
f
 = 
	`f›í
(
fûíame
, 
mode_°r
);

324 i‡(!
f
) {

325 
	`≥º‹
(
fûíame
);

326 
	`exô
(1);

328 
	`f£ek
(
f
, 0, 
SEEK_END
);

329 
fûe_size
 = 
	`·ñlo
(
f
);

331 
bs
 = 
	`mÆlocz
((*bs));

332 
bf
 = 
	`mÆlocz
((*bf));

334 
bf
->
mode
 = mode;

335 
bf
->
nb_£˘‹s
 = 
fûe_size
 / 512;

336 
bf
->
f
 = f;

338 i‡(
mode
 =
BF_MODE_SNAPSHOT
) {

339 
bf
->
£˘‹_èbÀ
 = 
	`mÆlocz
((bf->sector_table[0]) *

340 
bf
->
nb_£˘‹s
);

343 
bs
->
›aque
 = 
bf
;

344 
bs
->
gë_£˘‹_cou¡
 = 
bf_gë_£˘‹_cou¡
;

345 
bs
->
ªad_async
 = 
bf_ªad_async
;

346 
bs
->
wrôe_async
 = 
bf_wrôe_async
;

347  
bs
;

348 
	}
}

350 #i‚de‡
_WIN32


353 
	mfd
;

354 
BOOL
 
	m£À˘_fûÀd
;

355 } 
	tTunSèã
;

357 
	$tun_wrôe_∑ckë
(
Ethî√tDevi˚
 *
√t
,

358 c⁄° 
uöt8_t
 *
buf
, 
Àn
)

360 
TunSèã
 *
s
 = 
√t
->
›aque
;

361 
	`wrôe
(
s
->
fd
, 
buf
, 
Àn
);

362 
	}
}

364 
	$tun_£À˘_fûl
(
Ethî√tDevi˚
 *
√t
, *
pfd_max
,

365 
fd_£t
 *
rfds
, fd_£à*
wfds
, fd_£à*
efds
,

366 *
pdñay
)

368 
TunSèã
 *
s
 = 
√t
->
›aque
;

369 
√t_fd
 = 
s
->
fd
;

371 
s
->
£À˘_fûÀd
 = 
√t
->
	`devi˚_ˇn_wrôe_∑ckë
(net);

372 i‡(
s
->
£À˘_fûÀd
) {

373 
	`FD_SET
(
√t_fd
, 
rfds
);

374 *
pfd_max
 = 
	`max_öt
(*pfd_max, 
√t_fd
);

376 
	}
}

378 
	$tun_£À˘_pﬁl
(
Ethî√tDevi˚
 *
√t
,

379 
fd_£t
 *
rfds
, fd_£à*
wfds
, fd_£à*
efds
,

380 
£À˘_ªt
)

382 
TunSèã
 *
s
 = 
√t
->
›aque
;

383 
√t_fd
 = 
s
->
fd
;

384 
uöt8_t
 
buf
[2048];

385 
ªt
;

387 i‡(
£À˘_ªt
 <= 0)

389 i‡(
s
->
£À˘_fûÀd
 && 
	`FD_ISSET
(
√t_fd
, 
rfds
)) {

390 
ªt
 = 
	`ªad
(
√t_fd
, 
buf
, (buf));

391 i‡(
ªt
 > 0)

392 
√t
->
	`devi˚_wrôe_∑ckë
“ë, 
buf
, 
ªt
);

395 
	}
}

415 
Ethî√tDevi˚
 *
	$tun_›í
(c⁄° *
i‚ame
)

417 
i‰eq
 
i‰
;

418 
fd
, 
ªt
;

419 
Ethî√tDevi˚
 *
√t
;

420 
TunSèã
 *
s
;

422 
fd
 = 
	`›í
("/dev/√t/tun", 
O_RDWR
);

423 i‡(
fd
 < 0) {

424 
	`Ârötf
(
°dîr
, "Error: couldÇot open /dev/net/tun\n");

425  
NULL
;

427 
	`mem£t
(&
i‰
, 0, (ifr));

428 
i‰
.
i‰_Êags
 = 
IFF_TAP
 | 
IFF_NO_PI
;

429 
	`p°r˝y
(
i‰
.
i‰_«me
, (i‰.i‰_«me), 
i‚ame
);

430 
ªt
 = 
	`io˘l
(
fd
, 
TUNSETIFF
, (*Ë&
i‰
);

431 i‡(
ªt
 != 0) {

432 
	`Ârötf
(
°dîr
, "Error: couldÇot configure /dev/net/tun\n");

433 
	`˛o£
(
fd
);

434  
NULL
;

436 
	`f˙é
(
fd
, 
F_SETFL
, 
O_NONBLOCK
);

438 
√t
 = 
	`mÆlocz
((*net));

439 
√t
->
mac_addr
[0] = 0x02;

440 
√t
->
mac_addr
[1] = 0x00;

441 
√t
->
mac_addr
[2] = 0x00;

442 
√t
->
mac_addr
[3] = 0x00;

443 
√t
->
mac_addr
[4] = 0x00;

444 
√t
->
mac_addr
[5] = 0x01;

445 
s
 = 
	`mÆlocz
((*s));

446 
s
->
fd
 = fd;

447 
√t
->
›aque
 = 
s
;

448 
√t
->
wrôe_∑ckë
 = 
tun_wrôe_∑ckë
;

449 
√t
->
£À˘_fûl
 = 
tun_£À˘_fûl
;

450 
√t
->
£À˘_pﬁl
 = 
tun_£À˘_pﬁl
;

451  
√t
;

452 
	}
}

456 #ifde‡
CONFIG_SLIRP


461 
Slúp
 *
	g¶úp_°©e
;

463 
	$¶úp_wrôe_∑ckë
(
Ethî√tDevi˚
 *
√t
,

464 c⁄° 
uöt8_t
 *
buf
, 
Àn
)

466 
Slúp
 *
¶úp_°©e
 = 
√t
->
›aque
;

467 
	`¶úp_öput
(
¶úp_°©e
, 
buf
, 
Àn
);

468 
	}
}

470 
	$¶úp_ˇn_ouçut
(*
›aque
)

472 
Ethî√tDevi˚
 *
√t
 = 
›aque
;

473  
√t
->
	`devi˚_ˇn_wrôe_∑ckë
(net);

474 
	}
}

476 
	$¶úp_ouçut
(*
›aque
, c⁄° 
uöt8_t
 *
pkt
, 
pkt_Àn
)

478 
Ethî√tDevi˚
 *
√t
 = 
›aque
;

479  
√t
->
	`devi˚_wrôe_∑ckë
“ë, 
pkt
, 
pkt_Àn
);

480 
	}
}

482 
	$¶úp_£À˘_fûl1
(
Ethî√tDevi˚
 *
√t
, *
pfd_max
,

483 
fd_£t
 *
rfds
, fd_£à*
wfds
, fd_£à*
efds
,

484 *
pdñay
)

486 
Slúp
 *
¶úp_°©e
 = 
√t
->
›aque
;

487 
	`¶úp_£À˘_fûl
(
¶úp_°©e
, 
pfd_max
, 
rfds
, 
wfds
, 
efds
);

488 
	}
}

490 
	$¶úp_£À˘_pﬁl1
(
Ethî√tDevi˚
 *
√t
,

491 
fd_£t
 *
rfds
, fd_£à*
wfds
, fd_£à*
efds
,

492 
£À˘_ªt
)

494 
Slúp
 *
¶úp_°©e
 = 
√t
->
›aque
;

495 
	`¶úp_£À˘_pﬁl
(
¶úp_°©e
, 
rfds
, 
wfds
, 
efds
, (
£À˘_ªt
 <= 0));

496 
	}
}

498 
Ethî√tDevi˚
 *
	$¶úp_›í
()

500 
Ethî√tDevi˚
 *
√t
;

501 
ö_addr
 
√t_addr
 = { .
s_addr
 = 
	`ht⁄l
(0x0a000200) };

502 
ö_addr
 
mask
 = { .
s_addr
 = 
	`ht⁄l
(0xffffff00) };

503 
ö_addr
 
ho°
 = { .
s_addr
 = 
	`ht⁄l
(0x0a000202) };

504 
ö_addr
 
dh˝
 = { .
s_addr
 = 
	`ht⁄l
(0x0a00020f) };

505 
ö_addr
 
dns
 = { .
s_addr
 = 
	`ht⁄l
(0x0a000203) };

506 c⁄° *
boŸfûe
 = 
NULL
;

507 c⁄° *
vho°«me
 = 
NULL
;

508 
ª°ri˘ed
 = 0;

510 i‡(
¶úp_°©e
) {

511 
	`Ârötf
(
°dîr
, "Onlyá single slirp instance isállowed\n");

512  
NULL
;

514 
√t
 = 
	`mÆlocz
((*net));

516 
¶úp_°©e
 = 
	`¶úp_öô
(
ª°ri˘ed
, 
√t_addr
, 
mask
, 
ho°
, 
vho°«me
,

517 "", 
boŸfûe
, 
dh˝
, 
dns
, 
√t
);

519 
√t
->
mac_addr
[0] = 0x02;

520 
√t
->
mac_addr
[1] = 0x00;

521 
√t
->
mac_addr
[2] = 0x00;

522 
√t
->
mac_addr
[3] = 0x00;

523 
√t
->
mac_addr
[4] = 0x00;

524 
√t
->
mac_addr
[5] = 0x01;

525 
√t
->
›aque
 = 
¶úp_°©e
;

526 
√t
->
wrôe_∑ckë
 = 
¶úp_wrôe_∑ckë
;

527 
√t
->
£À˘_fûl
 = 
¶úp_£À˘_fûl1
;

528 
√t
->
£À˘_pﬁl
 = 
¶úp_£À˘_pﬁl1
;

530  
√t
;

531 
	}
}

535 
	#MAX_EXEC_CYCLE
 500000

	)

536 
	#MAX_SLEEP_TIME
 10

	)

538 
	$vút_machöe_run
(
VútMachöe
 *
m
)

540 
fd_£t
 
rfds
, 
wfds
, 
efds
;

541 
fd_max
, 
ªt
, 
dñay
;

542 
timevÆ
 
tv
;

543 #i‚de‡
_WIN32


544 
°dö_fd
;

547 
dñay
 = 
	`vút_machöe_gë_¶ìp_duøti⁄
(
m
, 
MAX_SLEEP_TIME
);

550 
	`FD_ZERO
(&
rfds
);

551 
	`FD_ZERO
(&
wfds
);

552 
	`FD_ZERO
(&
efds
);

553 
fd_max
 = -1;

554 #i‚de‡
_WIN32


555 i‡(
m
->
c⁄sﬁe_dev
 && (
	`u¨t_ˇn_rx
(mË|| 
	`vútio_c⁄sﬁe_ˇn_wrôe_d©a
(m->console_dev))) {

556 
STDIODevi˚
 *
s
 = 
m
->
c⁄sﬁe
->
›aque
;

557 
°dö_fd
 = 
s
->stdin_fd;

558 
	`FD_SET
(
°dö_fd
, &
rfds
);

559 
fd_max
 = 
°dö_fd
;

561 i‡(
s
->
ªsize_≥ndög
 && 
	`vútio_c⁄sﬁe_ˇn_wrôe_d©a
(
m
->
c⁄sﬁe_dev
)) {

562 
width
, 
height
;

563 
	`c⁄sﬁe_gë_size
(
s
, &
width
, &
height
);

564 
	`vútio_c⁄sﬁe_ªsize_evít
(
m
->
c⁄sﬁe_dev
, 
width
, 
height
);

565 
s
->
ªsize_≥ndög
 = 
FALSE
;

569 i‡(
m
->
√t
) {

570 
m
->
√t
->
	`£À˘_fûl
(m->√t, &
fd_max
, &
rfds
, &
wfds
, &
efds
, &
dñay
);

572 #ifde‡
CONFIG_FS_NET


573 
	`fs_√t_£t_fd£t
(&
fd_max
, &
rfds
, &
wfds
, &
efds
, &
dñay
);

575 
tv
.
tv_£c
 = 
dñay
 / 1000;

576 
tv
.
tv_u£c
 = (
dñay
 % 1000) * 1000;

577 
ªt
 = 
	`£À˘
(
fd_max
 + 1, &
rfds
, &
wfds
, &
efds
, &
tv
);

578 i‡(
m
->
√t
) {

579 
m
->
√t
->
	`£À˘_pﬁl
(m->√t, &
rfds
, &
wfds
, &
efds
, 
ªt
);

581 i‡(
ªt
 > 0) {

582 #i‚de‡
_WIN32


583 i‡(
m
->
c⁄sﬁe_dev
 && 
	`FD_ISSET
(
°dö_fd
, &
rfds
)) {

584 
uöt8_t
 
buf
[128];

585 
ªt
, 
Àn
 = (
buf
), 
uÀn
 = 
	`u¨t_ˇn_rx
(
m
);

586 i‡(
	`vútio_c⁄sﬁe_ˇn_wrôe_d©a
(
m
->
c⁄sﬁe_dev
))

587 
Àn
 = 
	`mö_öt
÷í, 
	`vútio_c⁄sﬁe_gë_wrôe_Àn
(
m
->
c⁄sﬁe_dev
));

588 i‡(
uÀn
)

589 
Àn
 = 
	`mö_öt
÷í, 
uÀn
);

590 
ªt
 = 
m
->
c⁄sﬁe
->
	`ªad_d©a
(m->c⁄sﬁe->
›aque
, 
buf
, 
Àn
);

591 i‡(
ªt
 > 0) {

592 
	`u¨t_rx_d©a
(
m
, 
buf
, 
ªt
);

593 i‡(
	`vútio_c⁄sﬁe_ˇn_wrôe_d©a
(
m
->
c⁄sﬁe_dev
))

594 
	`vútio_c⁄sﬁe_wrôe_d©a
(
m
->
c⁄sﬁe_dev
, 
buf
, 
ªt
);

600 #ifde‡
CONFIG_SDL


601 
	`sdl_ª‰esh
(
m
);

604 
	`vút_machöe_öãΩ
(
m
, 
MAX_EXEC_CYCLE
);

605 
	}
}

609 
›ti⁄
 
	g›ti⁄s
[] = {

610 { "hñp", 
no_¨gumít
, 
NULL
, 'h' },

611 { "˘æc", 
no_¨gumít
 },

612 { "rw", 
no_¨gumít
 },

613 { "ro", 
no_¨gumít
 },

614 { "≠≥nd", 
ªquúed_¨gumít
 },

615 { "no-ac˚l", 
no_¨gumít
 },

616 { "sim°¨t", 
no_¨gumít
 },

617 { "°©s-di•œy", 
no_¨gumít
 },

618 { "mem-modñ", 
ªquúed_¨gumít
 },

619 { "buûd-¥ñﬂd", 
ªquúed_¨gumít
 },

620 { "Êush-sim-mem", 
no_¨gumít
 },

621 { "sim-åa˚", 
no_¨gumít
 },

622 { 
NULL
 },

625 
	$hñp
()

627 
	`¥ötf
("m¨ss-riscv vîsi⁄ " 
CONFIG_VERSION
 ", Copyright (c) 2017-2019 Gaurav Kothari, Parikshit Sarnaik, Gokturk Yuksek\n"

644 
	`exô
(1);

645 
	}
}

647 #ifde‡
CONFIG_FS_NET


648 
BOOL
 
	g√t_com∂ëed
;

650 
	$√t_°¨t_cb
(*
¨g
)

652 
√t_com∂ëed
 = 
TRUE
;

653 
	}
}

655 
BOOL
 
	$√t_pﬁl_cb
(*
¨g
)

657  
√t_com∂ëed
;

658 
	}
}

662 
	$maö
(
¨gc
, **
¨gv
)

664 
VútMachöe
 *
s
;

665 c⁄° *
∑th
, *
cmdlöe
, *
buûd_¥ñﬂd_fûe
;

666 
c
, 
›ti⁄_ödex
, 
i
, 
øm_size
, 
ac˚l_íabÀ
;

667 
BOOL
 
Ælow_˘æc
;

668 
BlockDevi˚ModeEnum
 
drive_mode
;

669 
VútMachöeP¨ams
 
p_s
, *
p
 = &p_s;

670 
m¨ss_°¨t_ö_sim
 = 0;

671 
m¨ss_°©s_di•œy
 = 0;

672 
m¨ss_mem_modñ
 = 
MEM_MODEL_BASE
;

673 
m¨ss_Êush_mem
 = 
FALSE
;

674 
m¨ss_do_sim_åa˚
 = 
FALSE
;

676 
øm_size
 = -1;

677 
Ælow_˘æc
 = 
FALSE
;

678 ()
Ælow_˘æc
;

679 
drive_mode
 = 
BF_MODE_SNAPSHOT
;

680 
ac˚l_íabÀ
 = -1;

681 
cmdlöe
 = 
NULL
;

682 
buûd_¥ñﬂd_fûe
 = 
NULL
;

684 
c
 = 
	`gë›t_l⁄g_⁄ly
(
¨gc
, 
¨gv
, "hm:", 
›ti⁄s
, &
›ti⁄_ödex
);

685 i‡(
c
 == -1)

687 
c
) {

689 
›ti⁄_ödex
) {

691 
Ælow_˘æc
 = 
TRUE
;

694 
drive_mode
 = 
BF_MODE_RW
;

697 
drive_mode
 = 
BF_MODE_RO
;

700 
cmdlöe
 = 
›èrg
;

703 
ac˚l_íabÀ
 = 
FALSE
;

706 
m¨ss_°¨t_ö_sim
 = 1;

709 
m¨ss_°©s_di•œy
 = 1;

712 i‡(
	`°rcmp
(
›èrg
, "base") == 0)

714 
m¨ss_mem_modñ
 = 
MEM_MODEL_BASE
;

716 i‡(
	`°rcmp
(
›èrg
, "dramsim2") == 0)

718 
m¨ss_mem_modñ
 = 
MEM_MODEL_DRAMSIM
;

722 
	`Ârötf
(
°dîr
, "unknown mem-modelÅype, see help\n");

723 
	`exô
(1);

727 
buûd_¥ñﬂd_fûe
 = 
›èrg
;

730 
m¨ss_Êush_mem
 = 
TRUE
;

733 
m¨ss_do_sim_åa˚
 = 
TRUE
;

736 
	`Ârötf
(
°dîr
, "unknow¿›ti⁄ index: %d\n", 
›ti⁄_ödex
);

737 
	`exô
(1);

741 
	`hñp
();

744 
øm_size
 = 
	`°πoul
(
›èrg
, 
NULL
, 0);

747 
	`exô
(1);

751 i‡(
›töd
 >
¨gc
) {

752 
	`hñp
();

755 
∑th
 = 
¨gv
[
›töd
++];

757 
	`vút_machöe_£t_deÁu…s
(
p
);

758 
p
->
sim_∑øms
->
mem_modñ_ty≥
 = 
m¨ss_mem_modñ
;

759 #ifde‡
CONFIG_FS_NET


760 
	`fs_wgë_öô
();

762 
	`vút_machöe_lﬂd_c⁄fig_fûe
(
p
, 
∑th
, 
NULL
, NULL);

763 #ifde‡
CONFIG_FS_NET


764 
	`fs_√t_evít_lo›
(
NULL
, NULL);

769 i‡(
øm_size
 > 0) {

770 
p
->
øm_size
 = (
uöt64_t
)ram_size << 20;

772 i‡(
ac˚l_íabÀ
 != -1)

773 
p
->
ac˚l_íabÀ
 =áccel_enable;

774 i‡(
cmdlöe
) {

775 
	`vm_add_cmdlöe
(
p
, 
cmdlöe
);

778 
p
->
sim_∑øms
->
°¨t_ö_sim
 = 
m¨ss_°¨t_ö_sim
;

779 
p
->
sim_∑øms
->
íabÀ_°©s_di•œy
 = 
m¨ss_°©s_di•œy
;

780 
p
->
sim_∑øms
->
Êush_sim_mem
 = 
m¨ss_Êush_mem
;

781 
p
->
sim_∑øms
->
do_sim_åa˚
 = 
m¨ss_do_sim_åa˚
;

784 
i
 = 0; i < 
p
->
drive_cou¡
; i++) {

785 
BlockDevi˚
 *
drive
;

786 *
‚ame
;

787 
‚ame
 = 
	`gë_fûe_∑th
(
p
->
cfg_fûíame
,Ö->
èb_drive
[
i
].
fûíame
);

788 #ifde‡
CONFIG_FS_NET


789 i‡(
	`is_uæ
(
‚ame
)) {

790 
√t_com∂ëed
 = 
FALSE
;

791 
drive
 = 
	`block_devi˚_öô_hâp
(
‚ame
, 128 * 1024,

792 
√t_°¨t_cb
, 
NULL
);

794 
	`fs_√t_evít_lo›
(
√t_pﬁl_cb
, 
NULL
);

798 
drive
 = 
	`block_devi˚_öô
(
‚ame
, 
drive_mode
);

800 
	`‰ì
(
‚ame
);

801 
p
->
èb_drive
[
i
].
block_dev
 = 
drive
;

804 
i
 = 0; i < 
p
->
fs_cou¡
; i++) {

805 
FSDevi˚
 *
fs
;

806 c⁄° *
∑th
;

807 
∑th
 = 
p
->
èb_fs
[
i
].
fûíame
;

808 #ifde‡
CONFIG_FS_NET


809 i‡(
	`is_uæ
(
∑th
)) {

810 
fs
 = 
	`fs_√t_öô
(
∑th
, 
NULL
, NULL);

811 i‡(!
fs
)

812 
	`exô
(1);

813 i‡(
buûd_¥ñﬂd_fûe
)

814 
	`fs_dump_ˇche_lﬂd
(
fs
, 
buûd_¥ñﬂd_fûe
);

815 
	`fs_√t_evít_lo›
(
NULL
, NULL);

819 #ifde‡
_WIN32


820 
	`Ârötf
(
°dîr
, "FilesystemáccessÇot supported yet\n");

821 
	`exô
(1);

823 *
‚ame
;

824 
‚ame
 = 
	`gë_fûe_∑th
(
p
->
cfg_fûíame
, 
∑th
);

825 
fs
 = 
	`fs_disk_öô
(
‚ame
);

826 i‡(!
fs
) {

827 
	`Ârötf
(
°dîr
, "%s: mu° bê®dúe˘‹y\n", 
‚ame
);

828 
	`exô
(1);

830 
	`‰ì
(
‚ame
);

833 
p
->
èb_fs
[
i
].
fs_dev
 = 
fs
;

836 
i
 = 0; i < 
p
->
ëh_cou¡
; i++) {

837 #ifde‡
CONFIG_SLIRP


838 i‡(!
	`°rcmp
(
p
->
èb_ëh
[
i
].
drivî
, "user")) {

839 
p
->
èb_ëh
[
i
].
√t
 = 
	`¶úp_›í
();

840 i‡(!
p
->
èb_ëh
[
i
].
√t
)

841 
	`exô
(1);

844 #i‚de‡
_WIN32


845 i‡(!
	`°rcmp
(
p
->
èb_ëh
[
i
].
drivî
, "tap")) {

846 
p
->
èb_ëh
[
i
].
√t
 = 
	`tun_›í
’->èb_ëh[i].
i‚ame
);

847 i‡(!
p
->
èb_ëh
[
i
].
√t
)

848 
	`exô
(1);

852 
	`Ârötf
(
°dîr
, "UnsupportedÇetwork driver '%s'\n",

853 
p
->
èb_ëh
[
i
].
drivî
);

854 
	`exô
(1);

858 #ifde‡
CONFIG_SDL


859 i‡(
p
->
di•œy_devi˚
) {

860 
	`sdl_öô
(
p
->
width
,Ö->
height
);

864 #ifde‡
_WIN32


865 
	`Ârötf
(
°dîr
, "ConsoleÇot supported yet\n");

866 
	`exô
(1);

868 
p
->
c⁄sﬁe
 = 
	`c⁄sﬁe_öô
(
Ælow_˘æc
);

871 
p
->
πc_ªÆ_time
 = 
TRUE
;

873 
s
 = 
	`vút_machöe_öô
(
p
);

874 i‡(!
s
)

875 
	`exô
(1);

877 
	`vút_machöe_‰ì_c⁄fig
(
p
);

879 i‡(
s
->
√t
) {

880 
s
->
√t
->
	`devi˚_£t_ˇºõr
(s->√t, 
TRUE
);

884 
	`vút_machöe_run
(
s
);

886 
	`vút_machöe_íd
(
s
);

888 
	}
}

	@vga.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°d¨g.h
>

27 
	~<°rög.h
>

28 
	~<öây≥s.h
>

29 
	~<as£π.h
>

31 
	~"cutûs.h
"

32 
	~"iomem.h
"

33 
	~"vútio.h
"

34 
	~"machöe.h
"

38 
	#MSR_COLOR_EMULATION
 0x01

	)

39 
	#MSR_PAGE_SELECT
 0x20

	)

41 
	#ST01_V_RETRACE
 0x08

	)

42 
	#ST01_DISP_ENABLE
 0x01

	)

44 
	#VBE_DISPI_INDEX_ID
 0x0

	)

45 
	#VBE_DISPI_INDEX_XRES
 0x1

	)

46 
	#VBE_DISPI_INDEX_YRES
 0x2

	)

47 
	#VBE_DISPI_INDEX_BPP
 0x3

	)

48 
	#VBE_DISPI_INDEX_ENABLE
 0x4

	)

49 
	#VBE_DISPI_INDEX_BANK
 0x5

	)

50 
	#VBE_DISPI_INDEX_VIRT_WIDTH
 0x6

	)

51 
	#VBE_DISPI_INDEX_VIRT_HEIGHT
 0x7

	)

52 
	#VBE_DISPI_INDEX_X_OFFSET
 0x8

	)

53 
	#VBE_DISPI_INDEX_Y_OFFSET
 0x9

	)

54 
	#VBE_DISPI_INDEX_VIDEO_MEMORY_64K
 0xa

	)

55 
	#VBE_DISPI_INDEX_NB
 0xb

	)

57 
	#VBE_DISPI_ID0
 0xB0C0

	)

58 
	#VBE_DISPI_ID1
 0xB0C1

	)

59 
	#VBE_DISPI_ID2
 0xB0C2

	)

60 
	#VBE_DISPI_ID3
 0xB0C3

	)

61 
	#VBE_DISPI_ID4
 0xB0C4

	)

62 
	#VBE_DISPI_ID5
 0xB0C5

	)

64 
	#VBE_DISPI_DISABLED
 0x00

	)

65 
	#VBE_DISPI_ENABLED
 0x01

	)

66 
	#VBE_DISPI_GETCAPS
 0x02

	)

67 
	#VBE_DISPI_8BIT_DAC
 0x20

	)

68 
	#VBE_DISPI_LFB_ENABLED
 0x40

	)

69 
	#VBE_DISPI_NOCLEARMEM
 0x80

	)

71 
	#FB_ALLOC_ALIGN
 (1 << 20)

	)

73 
	#MAX_TEXT_WIDTH
 132

	)

74 
	#MAX_TEXT_HEIGHT
 60

	)

76 
	sVGASèã
 {

77 
FBDevi˚
 *
	mfb_dev
;

78 
	mfb_∑ge_cou¡
;

79 
PhysMem‹yR™ge
 *
	mmem_ønge
;

80 
PhysMem‹yR™ge
 *
	mmem_ønge2
;

81 
PCIDevi˚
 *
	mpci_dev
;

82 
PhysMem‹yR™ge
 *
	mrom_ønge
;

84 
uöt8_t
 *
	mvga_øm
;

86 
uöt8_t
 
	m§_ödex
;

87 
uöt8_t
 
	m§
[8];

88 
uöt8_t
 
	mgr_ödex
;

89 
uöt8_t
 
	mgr
[16];

90 
uöt8_t
 
	m¨_ödex
;

91 
uöt8_t
 
	m¨
[21];

92 
	m¨_Êù_Ê›
;

93 
uöt8_t
 
	m¸_ödex
;

94 
uöt8_t
 
	m¸
[256];

95 
uöt8_t
 
	mm§
;

96 
uöt8_t
 
	mf¸
;

97 
uöt8_t
 
	m°00
;

98 
uöt8_t
 
	m°01
;

99 
uöt8_t
 
	mdac_°©e
;

100 
uöt8_t
 
	mdac_sub_ödex
;

101 
uöt8_t
 
	mdac_ªad_ödex
;

102 
uöt8_t
 
	mdac_wrôe_ödex
;

103 
uöt8_t
 
	mdac_ˇche
[3];

104 
uöt8_t
 
	m∑Àâe
[768];

107 
uöt32_t
 
	mœ°_∑Àâe
[16];

108 
uöt16_t
 
	mœ°_ch_©å
[
MAX_TEXT_WIDTH
 * 
MAX_TEXT_HEIGHT
];

109 
uöt32_t
 
	mœ°_width
;

110 
uöt32_t
 
	mœ°_height
;

111 
uöt16_t
 
	mœ°_löe_off£t
;

112 
uöt16_t
 
	mœ°_°¨t_addr
;

113 
uöt16_t
 
	mœ°_curs‹_off£t
;

114 
uöt8_t
 
	mœ°_curs‹_°¨t
;

115 
uöt8_t
 
	mœ°_curs‹_íd
;

118 
uöt16_t
 
	mvbe_ödex
;

119 
uöt16_t
 
	mvbe_ªgs
[
VBE_DISPI_INDEX_NB
];

122 
	$vga_døw_glyph8
(
uöt8_t
 *
d
, 
löesize
,

123 c⁄° 
uöt8_t
 *
f⁄t_±r
, 
h
,

124 
uöt32_t
 
fgcﬁ
, uöt32_à
bgcﬁ
)

126 
uöt32_t
 
f⁄t_d©a
, 
x‹cﬁ
;

128 
x‹cﬁ
 = 
bgcﬁ
 ^ 
fgcﬁ
;

130 
f⁄t_d©a
 = 
f⁄t_±r
[0];

131 ((
uöt32_t
 *)
d
)[0] = (-((
f⁄t_d©a
 >> 7)Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

132 ((
uöt32_t
 *)
d
)[1] = (-((
f⁄t_d©a
 >> 6Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

133 ((
uöt32_t
 *)
d
)[2] = (-((
f⁄t_d©a
 >> 5Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

134 ((
uöt32_t
 *)
d
)[3] = (-((
f⁄t_d©a
 >> 4Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

135 ((
uöt32_t
 *)
d
)[4] = (-((
f⁄t_d©a
 >> 3Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

136 ((
uöt32_t
 *)
d
)[5] = (-((
f⁄t_d©a
 >> 2Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

137 ((
uöt32_t
 *)
d
)[6] = (-((
f⁄t_d©a
 >> 1Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

138 ((
uöt32_t
 *)
d
)[7] = (-((
f⁄t_d©a
 >> 0Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

139 
f⁄t_±r
++;

140 
d
 +
löesize
;

141 } --
h
);

142 
	}
}

144 
	$vga_døw_glyph9
(
uöt8_t
 *
d
, 
löesize
,

145 c⁄° 
uöt8_t
 *
f⁄t_±r
, 
h
,

146 
uöt32_t
 
fgcﬁ
, uöt32_à
bgcﬁ
,

147 
dup9
)

149 
uöt32_t
 
f⁄t_d©a
, 
x‹cﬁ
, 
v
;

151 
x‹cﬁ
 = 
bgcﬁ
 ^ 
fgcﬁ
;

153 
f⁄t_d©a
 = 
f⁄t_±r
[0];

154 ((
uöt32_t
 *)
d
)[0] = (-((
f⁄t_d©a
 >> 7)Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

155 ((
uöt32_t
 *)
d
)[1] = (-((
f⁄t_d©a
 >> 6Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

156 ((
uöt32_t
 *)
d
)[2] = (-((
f⁄t_d©a
 >> 5Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

157 ((
uöt32_t
 *)
d
)[3] = (-((
f⁄t_d©a
 >> 4Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

158 ((
uöt32_t
 *)
d
)[4] = (-((
f⁄t_d©a
 >> 3Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

159 ((
uöt32_t
 *)
d
)[5] = (-((
f⁄t_d©a
 >> 2Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

160 ((
uöt32_t
 *)
d
)[6] = (-((
f⁄t_d©a
 >> 1Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

161 
v
 = (-((
f⁄t_d©a
 >> 0Ë& 1Ë& 
x‹cﬁ
Ë^ 
bgcﬁ
;

162 ((
uöt32_t
 *)
d
)[7] = 
v
;

163 i‡(
dup9
)

164 ((
uöt32_t
 *)
d
)[8] = 
v
;

166 ((
uöt32_t
 *)
d
)[8] = 
bgcﬁ
;

167 
f⁄t_±r
++;

168 
d
 +
löesize
;

169 } --
h
);

170 
	}
}

172 c⁄° 
uöt8_t
 
	gcurs‹_glyph
[32] = {

179 
ölöe
 
	$c6_to_8
(
v
)

181 
b
;

182 
v
 &= 0x3f;

183 
b
 = 
v
 & 1;

184  (
v
 << 2Ë| (
b
 << 1) | b;

185 
	}
}

187 
	$upd©e_∑Àâe16
(
VGASèã
 *
s
, 
uöt32_t
 *
∑Àâe
)

189 
fuŒ_upd©e
, 
i
;

190 
uöt32_t
 
v
, 
cﬁ
;

192 
fuŒ_upd©e
 = 0;

193 
i
 = 0; i < 16; i++) {

194 
v
 = 
s
->
¨
[
i
];

195 i‡(
s
->
¨
[0x10] & 0x80)

196 
v
 = ((
s
->
¨
[0x14] & 0xf) << 4) | (v & 0xf);

198 
v
 = ((
s
->
¨
[0x14] & 0xc) << 4) | (v & 0x3f);

199 
v
 = v * 3;

200 
cﬁ
 = (
	`c6_to_8
(
s
->
∑Àâe
[
v
]) << 16) |

201 (
	`c6_to_8
(
s
->
∑Àâe
[
v
 + 1]) << 8) |

202 
	`c6_to_8
(
s
->
∑Àâe
[
v
 + 2]);

203 i‡(
cﬁ
 !
∑Àâe
[
i
]) {

204 
fuŒ_upd©e
 = 1;

205 
∑Àâe
[
i
] = 
cﬁ
;

208  
fuŒ_upd©e
;

209 
	}
}

213 
	$vga_ãxt_ª‰esh
(
VGASèã
 *
s
,

214 
Sim∂eFBDøwFunc
 *
ªdøw_func
, *
›aque
)

216 
FBDevi˚
 *
fb_dev
 = 
s
->fb_dev;

217 
width
, 
height
, 
cwidth
, 
cheight
, 
cy
, 
cx
, 
x1
, 
y1
, 
width1
, 
height1
;

218 
cx_mö
, 
cx_max
, 
dup9
;

219 
uöt32_t
 
ch_©å
, 
löe_off£t
, 
°¨t_addr
, 
ch_addr
, 
ch_addr1
, 
ch
, 
ˇâr
;

220 
uöt8_t
 *
vga_øm
, *
f⁄t_±r
, *
d°
;

221 
uöt32_t
 
fgcﬁ
, 
bgcﬁ
, 
curs‹_off£t
, 
curs‹_°¨t
, 
curs‹_íd
;

222 
BOOL
 
fuŒ_upd©e
;

224 
fuŒ_upd©e
 = 
	`upd©e_∑Àâe16
(
s
, s->
œ°_∑Àâe
);

226 
vga_øm
 = 
s
->vga_ram;

228 
löe_off£t
 = 
s
->
¸
[0x13];

229 
löe_off£t
 <<= 3;

230 
löe_off£t
 >>= 1;

232 
°¨t_addr
 = 
s
->
¸
[0x0d] | (s->cr[0x0c] << 8);

234 
cheight
 = (
s
->
¸
[9] & 0x1f) + 1;

235 
cwidth
 = 8;

236 i‡(!(
s
->
§
[1] & 0x01))

237 
cwidth
++;

239 
width
 = (
s
->
¸
[0x01] + 1);

240 
height
 = 
s
->
¸
[0x12] |

241 ((
s
->
¸
[0x07] & 0x02) << 7) |

242 ((
s
->
¸
[0x07] & 0x40) << 3);

243 
height
 = (heighà+ 1Ë/ 
cheight
;

245 
width1
 = 
width
 * 
cwidth
;

246 
height1
 = 
height
 * 
cheight
;

247 i‡(
fb_dev
->
width
 < 
width1
 || fb_dev->
height
 < 
height1
 ||

248 
width
 > 
MAX_TEXT_WIDTH
 || 
height
 > 
MAX_TEXT_HEIGHT
)

250 i‡(
s
->
œ°_löe_off£t
 !
löe_off£t
 ||

251 
s
->
œ°_°¨t_addr
 !
°¨t_addr
 ||

252 
s
->
œ°_width
 !
width
 ||

253 
s
->
œ°_height
 !
height
) {

254 
s
->
œ°_löe_off£t
 = 
löe_off£t
;

255 
s
->
œ°_°¨t_addr
 = 
°¨t_addr
;

256 
s
->
œ°_width
 = 
width
;

257 
s
->
œ°_height
 = 
height
;

258 
fuŒ_upd©e
 = 
TRUE
;

262 
curs‹_off£t
 = ((
s
->
¸
[0x0e] << 8Ë| s->¸[0x0f]Ë- 
°¨t_addr
;

263 
curs‹_°¨t
 = 
s
->
¸
[0xa];

264 
curs‹_íd
 = 
s
->
¸
[0xb];

265 i‡(
curs‹_off£t
 !
s
->
œ°_curs‹_off£t
 ||

266 
curs‹_°¨t
 !
s
->
œ°_curs‹_°¨t
 ||

267 
curs‹_íd
 !
s
->
œ°_curs‹_íd
) {

269 i‡(
s
->
œ°_curs‹_off£t
 < 
MAX_TEXT_WIDTH
 * 
MAX_TEXT_HEIGHT
)

270 
s
->
œ°_ch_©å
[s->
œ°_curs‹_off£t
] = -1;

271 i‡(
curs‹_off£t
 < 
MAX_TEXT_WIDTH
 * 
MAX_TEXT_HEIGHT
)

272 
s
->
œ°_ch_©å
[
curs‹_off£t
] = -1;

273 
s
->
œ°_curs‹_off£t
 = 
curs‹_off£t
;

274 
s
->
œ°_curs‹_°¨t
 = 
curs‹_°¨t
;

275 
s
->
œ°_curs‹_íd
 = 
curs‹_íd
;

278 
ch_addr1
 = 0x18000 + (
°¨t_addr
 * 2);

279 
curs‹_off£t
 = 0x18000 + (
°¨t_addr
 + cursor_offset) * 2;

281 
x1
 = (
fb_dev
->
width
 - 
width1
) / 2;

282 
y1
 = (
fb_dev
->
height
 - 
height1
) / 2;

284 
	`¥ötf
("textÑefresh %dx%d font=%dx%d start_addr=0x%xÜine_offset=0x%x\n",

285 
width
, 
height
, 
cwidth
, 
cheight
, 
°¨t_addr
, 
löe_off£t
);

287 
cy
 = 0; cy < 
height
; cy++) {

288 
ch_addr
 = 
ch_addr1
;

289 
d°
 = 
fb_dev
->
fb_d©a
 + (
y1
 + 
cy
 * 
cheight
Ë* fb_dev->
°ride
 + 
x1
 * 4;

290 
cx_mö
 = 
width
;

291 
cx_max
 = -1;

292 
cx
 = 0; cx < 
width
; cx++) {

293 
ch_©å
 = *(
uöt16_t
 *)(
vga_øm
 + (
ch_addr
 & 0x1fffe));

294 i‡(
fuŒ_upd©e
 || 
ch_©å
 !
s
->
œ°_ch_©å
[
cy
 * 
width
 + 
cx
]) {

295 
s
->
œ°_ch_©å
[
cy
 * 
width
 + 
cx
] = 
ch_©å
;

296 
cx_mö
 = 
	`mö_öt
(cx_mö, 
cx
);

297 
cx_max
 = 
	`max_öt
(cx_max, 
cx
);

298 
ch
 = 
ch_©å
 & 0xff;

299 
ˇâr
 = 
ch_©å
 >> 8;

300 
f⁄t_±r
 = 
vga_øm
 + 32 * 
ch
;

301 
bgcﬁ
 = 
s
->
œ°_∑Àâe
[
ˇâr
 >> 4];

302 
fgcﬁ
 = 
s
->
œ°_∑Àâe
[
ˇâr
 & 0x0f];

303 i‡(
cwidth
 == 8) {

304 
	`vga_døw_glyph8
(
d°
, 
fb_dev
->
°ride
, 
f⁄t_±r
, 
cheight
,

305 
fgcﬁ
, 
bgcﬁ
);

307 
dup9
 = 0;

308 i‡(
ch
 >0xb0 && ch <0xd‡&& (
s
->
¨
[0x10] & 0x04))

309 
dup9
 = 1;

310 
	`vga_døw_glyph9
(
d°
, 
fb_dev
->
°ride
, 
f⁄t_±r
, 
cheight
,

311 
fgcﬁ
, 
bgcﬁ
, 
dup9
);

314 i‡(
curs‹_off£t
 =
ch_addr
 && !(
curs‹_°¨t
 & 0x20)) {

315 
löe_°¨t
, 
löe_œ°
, 
h
;

316 
uöt8_t
 *
d°1
;

317 
löe_°¨t
 = 
curs‹_°¨t
 & 0x1f;

318 
löe_œ°
 = 
	`mö_öt
(
curs‹_íd
 & 0x1f, 
cheight
 - 1);

320 i‡(
löe_œ°
 >
löe_°¨t
 &&Üöe_°¨à< 
cheight
) {

321 
h
 = 
löe_œ°
 - 
löe_°¨t
 + 1;

322 
d°1
 = 
d°
 + 
fb_dev
->
°ride
 * 
löe_°¨t
;

323 i‡(
cwidth
 == 8) {

324 
	`vga_døw_glyph8
(
d°1
, 
fb_dev
->
°ride
,

325 
curs‹_glyph
,

326 
h
, 
fgcﬁ
, 
bgcﬁ
);

328 
	`vga_døw_glyph9
(
d°1
, 
fb_dev
->
°ride
,

329 
curs‹_glyph
,

330 
h
, 
fgcﬁ
, 
bgcﬁ
, 1);

335 
ch_addr
 += 2;

336 
d°
 +4 * 
cwidth
;

338 i‡(
cx_max
 >
cx_mö
) {

340 
	`ªdøw_func
(
fb_dev
, 
›aque
,

341 
x1
 + 
cx_mö
 * 
cwidth
, 
y1
 + 
cy
 * 
cheight
,

342 (
cx_max
 - 
cx_mö
 + 1Ë* 
cwidth
, 
cheight
);

344 
ch_addr1
 +
löe_off£t
;

346 
	}
}

348 
	$vga_ª‰esh
(
FBDevi˚
 *
fb_dev
,

349 
Sim∂eFBDøwFunc
 *
ªdøw_func
, *
›aque
)

351 
VGASèã
 *
s
 = 
fb_dev
->
devi˚_›aque
;

353 i‡(!(
s
->
¨_ödex
 & 0x20)) {

355 } i‡(
s
->
gr
[0x06] & 1) {

357 
	`sim∂efb_ª‰esh
(
fb_dev
, 
ªdøw_func
, 
›aque
, 
s
->
mem_ønge
, s->
fb_∑ge_cou¡
);

360 
	`vga_ãxt_ª‰esh
(
s
, 
ªdøw_func
, 
›aque
);

362 
	}
}

365 c⁄° 
uöt8_t
 
	g§_mask
[8] = {

366 (
uöt8_t
)~0xfc,

367 (
uöt8_t
)~0xc2,

368 (
uöt8_t
)~0xf0,

369 (
uöt8_t
)~0xc0,

370 (
uöt8_t
)~0xf1,

371 (
uöt8_t
)~0xff,

372 (
uöt8_t
)~0xff,

373 (
uöt8_t
)~0x00,

376 c⁄° 
uöt8_t
 
	ggr_mask
[16] = {

377 (
uöt8_t
)~0xf0,

378 (
uöt8_t
)~0xf0,

379 (
uöt8_t
)~0xf0,

380 (
uöt8_t
)~0xe0,

381 (
uöt8_t
)~0xfc,

382 (
uöt8_t
)~0x84,

383 (
uöt8_t
)~0xf0,

384 (
uöt8_t
)~0xf0,

385 (
uöt8_t
)~0x00,

386 (
uöt8_t
)~0xff,

387 (
uöt8_t
)~0xff,

388 (
uöt8_t
)~0xff,

389 (
uöt8_t
)~0xff,

390 (
uöt8_t
)~0xff,

391 (
uöt8_t
)~0xff,

392 (
uöt8_t
)~0xff,

395 
uöt32_t
 
	$vga_i›‹t_ªad
(
VGASèã
 *
s
, 
uöt32_t
 
addr
)

397 
vÆ
, 
ödex
;

400 i‡((
addr
 >0x3b0 &&ádd∏<0x3b‡&& (
s
->
m§
 & 
MSR_COLOR_EMULATION
)) ||

401 (
addr
 >0x3d0 &&ádd∏<0x3d‡&& !(
s
->
m§
 & 
MSR_COLOR_EMULATION
))) {

402 
vÆ
 = 0xff;

404 
addr
) {

406 i‡(
s
->
¨_Êù_Ê›
 == 0) {

407 
vÆ
 = 
s
->
¨_ödex
;

409 
vÆ
 = 0;

413 
ödex
 = 
s
->
¨_ödex
 & 0x1f;

414 i‡(
ödex
 < 21)

415 
vÆ
 = 
s
->
¨
[
ödex
];

417 
vÆ
 = 0;

420 
vÆ
 = 
s
->
°00
;

423 
vÆ
 = 
s
->
§_ödex
;

426 
vÆ
 = 
s
->
§
[s->
§_ödex
];

427 #ifde‡
DEBUG_VGA_REG


428 
	`¥ötf
("vga:Ñód SR%x = 0x%02x\n", 
s
->
§_ödex
, 
vÆ
);

432 
vÆ
 = 
s
->
dac_°©e
;

435 
vÆ
 = 
s
->
dac_wrôe_ödex
;

438 
vÆ
 = 
s
->
∑Àâe
[s->
dac_ªad_ödex
 * 3 + s->
dac_sub_ödex
];

439 i‡(++
s
->
dac_sub_ödex
 == 3) {

440 
s
->
dac_sub_ödex
 = 0;

441 
s
->
dac_ªad_ödex
++;

445 
vÆ
 = 
s
->
f¸
;

448 
vÆ
 = 
s
->
m§
;

451 
vÆ
 = 
s
->
gr_ödex
;

454 
vÆ
 = 
s
->
gr
[s->
gr_ödex
];

455 #ifde‡
DEBUG_VGA_REG


456 
	`¥ötf
("vga:Ñód GR%x = 0x%02x\n", 
s
->
gr_ödex
, 
vÆ
);

461 
vÆ
 = 
s
->
¸_ödex
;

465 
vÆ
 = 
s
->
¸
[s->
¸_ödex
];

466 #ifde‡
DEBUG_VGA_REG


467 
	`¥ötf
("vga:Ñód CR%x = 0x%02x\n", 
s
->
¸_ödex
, 
vÆ
);

473 
s
->
°01
 ^
ST01_V_RETRACE
 | 
ST01_DISP_ENABLE
;

474 
vÆ
 = 
s
->
°01
;

475 
s
->
¨_Êù_Ê›
 = 0;

478 
vÆ
 = 0x00;

482 #i‡
	`deföed
(
DEBUG_VGA
)

483 
	`¥ötf
("VGA:Ñódáddr=0x%04x d©a=0x%02x\n", 
addr
, 
vÆ
);

485  
vÆ
;

486 
	}
}

488 
	$vga_i›‹t_wrôe
(
VGASèã
 *
s
, 
uöt32_t
 
addr
, uöt32_à
vÆ
)

490 
ödex
;

493 i‡((
addr
 >0x3b0 &&ádd∏<0x3b‡&& (
s
->
m§
 & 
MSR_COLOR_EMULATION
)) ||

494 (
addr
 >0x3d0 &&ádd∏<0x3d‡&& !(
s
->
m§
 & 
MSR_COLOR_EMULATION
)))

497 #ifde‡
DEBUG_VGA


498 
	`¥ötf
("VGA: wrôêaddr=0x%04x d©a=0x%02x\n", 
addr
, 
vÆ
);

501 
addr
) {

503 i‡(
s
->
¨_Êù_Ê›
 == 0) {

504 
vÆ
 &= 0x3f;

505 
s
->
¨_ödex
 = 
vÆ
;

507 
ödex
 = 
s
->
¨_ödex
 & 0x1f;

508 
ödex
) {

510 
s
->
¨
[
ödex
] = 
vÆ
 & 0x3f;

513 
s
->
¨
[
ödex
] = 
vÆ
 & ~0x10;

516 
s
->
¨
[
ödex
] = 
vÆ
;

519 
s
->
¨
[
ödex
] = 
vÆ
 & ~0xc0;

522 
s
->
¨
[
ödex
] = 
vÆ
 & ~0xf0;

525 
s
->
¨
[
ödex
] = 
vÆ
 & ~0xf0;

531 
s
->
¨_Êù_Ê›
 ^= 1;

534 
s
->
m§
 = 
vÆ
 & ~0x10;

537 
s
->
§_ödex
 = 
vÆ
 & 7;

540 #ifde‡
DEBUG_VGA_REG


541 
	`¥ötf
("vga: wrôêSR%x = 0x%02x\n", 
s
->
§_ödex
, 
vÆ
);

543 
s
->
§
[s->
§_ödex
] = 
vÆ
 & 
§_mask
[s->sr_index];

546 
s
->
dac_ªad_ödex
 = 
vÆ
;

547 
s
->
dac_sub_ödex
 = 0;

548 
s
->
dac_°©e
 = 3;

551 
s
->
dac_wrôe_ödex
 = 
vÆ
;

552 
s
->
dac_sub_ödex
 = 0;

553 
s
->
dac_°©e
 = 0;

556 
s
->
dac_ˇche
[s->
dac_sub_ödex
] = 
vÆ
;

557 i‡(++
s
->
dac_sub_ödex
 == 3) {

558 
	`mem˝y
(&
s
->
∑Àâe
[s->
dac_wrôe_ödex
 * 3], s->
dac_ˇche
, 3);

559 
s
->
dac_sub_ödex
 = 0;

560 
s
->
dac_wrôe_ödex
++;

564 
s
->
gr_ödex
 = 
vÆ
 & 0x0f;

567 #ifde‡
DEBUG_VGA_REG


568 
	`¥ötf
("vga: wrôêGR%x = 0x%02x\n", 
s
->
gr_ödex
, 
vÆ
);

570 
s
->
gr
[s->
gr_ödex
] = 
vÆ
 & 
gr_mask
[s->gr_index];

574 
s
->
¸_ödex
 = 
vÆ
;

578 #ifde‡
DEBUG_VGA_REG


579 
	`¥ötf
("vga: wrôêCR%x = 0x%02x\n", 
s
->
¸_ödex
, 
vÆ
);

582 i‡((
s
->
¸
[0x11] & 0x80Ë&& s->
¸_ödex
 <= 7) {

584 i‡(
s
->
¸_ödex
 == 7)

585 
s
->
¸
[7] = (s->¸[7] & ~0x10Ë| (
vÆ
 & 0x10);

588 
s
->
¸_ödex
) {

595 
s
->
¸
[s->
¸_ödex
] = 
vÆ
;

598 
s
->
¸
[s->
¸_ödex
] = 
vÆ
;

604 
s
->
f¸
 = 
vÆ
 & 0x10;

607 
	}
}

609 
	#VGA_IO
(
ba£
) \

610 
uöt32_t
 
vga_ªad_
 ## 
	`ba£
(*
›aque
, uöt32_à
addr
, 
size_log2
)\

612  
	`vga_i›‹t_ªad
(
›aque
, 
ba£
 + 
addr
);\

614 
vga_wrôe_
 ## 
	`ba£
(*
›aque
, 
uöt32_t
 
addr
, uöt32_à
vÆ
, 
size_log2
)\

616  
	`vga_i›‹t_wrôe
(
›aque
, 
ba£
 + 
addr
, 
vÆ
);\

617 }

	)

619 
	$VGA_IO
(0x3c0)

620 
	$VGA_IO
(0x3b4)

621 
	$VGA_IO
(0x3d4)

622 
	$VGA_IO
(0x3ba)

623 
	$VGA_IO
(0x3da)

625 
	$vbe_wrôe
(*
›aque
, 
uöt32_t
 
off£t
,

626 
uöt32_t
 
vÆ
, 
size_log2
)

628 
VGASèã
 *
s
 = 
›aque
;

629 
FBDevi˚
 *
fb_dev
 = 
s
->fb_dev;

631 i‡(
off£t
 == 0) {

632 
s
->
vbe_ödex
 = 
vÆ
;

634 #ifde‡
DEBUG_VBE


635 
	`¥ötf
("VBE wrôe: index=0x%04x vÆ=0x%04x\n", 
s
->
vbe_ödex
, 
vÆ
);

637 
s
->
vbe_ödex
) {

638 
VBE_DISPI_INDEX_ID
:

639 i‡(
vÆ
 >
VBE_DISPI_ID0
 && vÆ <
VBE_DISPI_ID5
)

640 
s
->
vbe_ªgs
[s->
vbe_ödex
] = 
vÆ
;

642 
VBE_DISPI_INDEX_ENABLE
:

643 i‡((
vÆ
 & 
VBE_DISPI_ENABLED
) &&

644 !(
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_ENABLE
] & 
VBE_DISPI_ENABLED
)) {

647 i‡(
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_XRES
] <= 4096 &&

648 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_YRES
] <= 4096 &&

649 (
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_XRES
] * 4 *

650 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_YRES
]Ë<
fb_dev
->
fb_size
) {

651 
fb_dev
->
width
 = 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_XRES
];

652 
fb_dev
->
height
 = 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_YRES
];

653 
fb_dev
->
°ride
 = fb_dev->
width
 * 4;

655 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_VIRT_WIDTH
] =

656 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_XRES
];

657 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_VIRT_HEIGHT
] =

658 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_YRES
];

659 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_X_OFFSET
] = 0;

660 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_Y_OFFSET
] = 0;

662 
s
->
vbe_ªgs
[s->
vbe_ödex
] = 
vÆ
;

664 
VBE_DISPI_INDEX_XRES
:

665 
VBE_DISPI_INDEX_YRES
:

666 
VBE_DISPI_INDEX_BPP
:

667 
VBE_DISPI_INDEX_BANK
:

668 
VBE_DISPI_INDEX_VIRT_WIDTH
:

669 
VBE_DISPI_INDEX_VIRT_HEIGHT
:

670 
VBE_DISPI_INDEX_X_OFFSET
:

671 
VBE_DISPI_INDEX_Y_OFFSET
:

672 
s
->
vbe_ªgs
[s->
vbe_ödex
] = 
vÆ
;

676 
	}
}

678 
uöt32_t
 
	$vbe_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

680 
VGASèã
 *
s
 = 
›aque
;

681 
uöt32_t
 
vÆ
;

683 i‡(
off£t
 == 0) {

684 
vÆ
 = 
s
->
vbe_ödex
;

686 i‡(
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_ENABLE
] & 
VBE_DISPI_GETCAPS
) {

687 
s
->
vbe_ödex
) {

688 
VBE_DISPI_INDEX_XRES
:

689 
vÆ
 = 
s
->
fb_dev
->
width
;

691 
VBE_DISPI_INDEX_YRES
:

692 
vÆ
 = 
s
->
fb_dev
->
height
;

694 
VBE_DISPI_INDEX_BPP
:

695 
vÆ
 = 32;

698 
ªad_ªg
;

701 
ªad_ªg
:

702 i‡(
s
->
vbe_ödex
 < 
VBE_DISPI_INDEX_NB
)

703 
vÆ
 = 
s
->
vbe_ªgs
[s->
vbe_ödex
];

705 
vÆ
 = 0;

707 #ifde‡
DEBUG_VBE


708 
	`¥ötf
("VBEÑód: index=0x%04x vÆ=0x%04x\n", 
s
->
vbe_ödex
, 
vÆ
);

711  
vÆ
;

712 
	}
}

715 
	$sim∂efb_b¨_£t
(*
›aque
, 
b¨_num
,

716 
uöt32_t
 
addr
, 
BOOL
 
íabÀd
)

718 
VGASèã
 *
s
 = 
›aque
;

719 i‡(
b¨_num
 == 0)

720 
	`phys_mem_£t_addr
(
s
->
mem_ønge
, 
addr
, 
íabÀd
);

722 
	`phys_mem_£t_addr
(
s
->
rom_ønge
, 
addr
, 
íabÀd
);

723 
	}
}

725 
VGASèã
 *
	$pci_vga_öô
(
PCIBus
 *
bus
, 
FBDevi˚
 *
fb_dev
,

726 
width
, 
height
,

727 c⁄° 
uöt8_t
 *
vga_rom_buf
, 
vga_rom_size
)

729 
VGASèã
 *
s
;

730 
PCIDevi˚
 *
d
;

731 
uöt32_t
 
b¨_size
;

732 
PhysMem‹yM≠
 *
mem_m≠
, *
p‹t_m≠
;

734 
d
 = 
	`pci_ªgi°î_devi˚
(
bus
, "VGA", -1, 0x1234, 0x1111, 0x00, 0x0300);

736 
mem_m≠
 = 
	`pci_devi˚_gë_mem_m≠
(
d
);

737 
p‹t_m≠
 = 
	`pci_devi˚_gë_p‹t_m≠
(
d
);

739 
s
 = 
	`mÆlocz
((*s));

740 
s
->
fb_dev
 = fb_dev;

742 
fb_dev
->
width
 = width;

743 
fb_dev
->
height
 = height;

744 
fb_dev
->
°ride
 = 
width
 * 4;

746 
fb_dev
->
fb_size
 = (
height
 * fb_dev->
°ride
 + 
FB_ALLOC_ALIGN
 - 1) & ~(FB_ALLOC_ALIGN - 1);

747 
s
->
fb_∑ge_cou¡
 = 
fb_dev
->
fb_size
 >> 
DEVRAM_PAGE_SIZE_LOG2
;

749 
s
->
mem_ønge
 =

750 
	`˝u_ªgi°î_øm
(
mem_m≠
, 0, 
fb_dev
->
fb_size
,

751 
DEVRAM_FLAG_DIRTY_BITS
 | 
DEVRAM_FLAG_DISABLED
);

753 
fb_dev
->
fb_d©a
 = 
s
->
mem_ønge
->
phys_mem
;

755 
s
->
pci_dev
 = 
d
;

756 
b¨_size
 = 1;

757 
b¨_size
 < 
fb_dev
->
fb_size
)

758 
b¨_size
 <<= 1;

759 
	`pci_ªgi°î_b¨
(
d
, 0, 
b¨_size
, 
PCI_ADDRESS_SPACE_MEM
, 
s
,

760 
sim∂efb_b¨_£t
);

762 i‡(
vga_rom_size
 > 0) {

763 
rom_size
;

765 
rom_size
 = (
vga_rom_size
 + 
DEVRAM_PAGE_SIZE
 - 1) & ~(DEVRAM_PAGE_SIZE - 1);

766 
s
->
rom_ønge
 = 
	`˝u_ªgi°î_øm
(
mem_m≠
, 0, 
rom_size
,

767 
DEVRAM_FLAG_ROM
 | 
DEVRAM_FLAG_DISABLED
);

768 
	`mem˝y
(
s
->
rom_ønge
->
phys_mem
, 
vga_rom_buf
, 
vga_rom_size
);

770 
b¨_size
 = 1;

771 
b¨_size
 < 
rom_size
)

772 
b¨_size
 <<= 1;

773 
	`pci_ªgi°î_b¨
(
d
, 
PCI_ROM_SLOT
, 
b¨_size
, 
PCI_ADDRESS_SPACE_MEM
, 
s
,

774 
sim∂efb_b¨_£t
);

778 
s
->
mem_ønge2
 = 
	`˝u_ªgi°î_øm
(
mem_m≠
, 0xa0000, 0x20000, 0);

779 
s
->
vga_øm
 = s->
mem_ønge2
->
phys_mem
;

783 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0x3c0, 16, 
s
, 
vga_ªad_0x3c0
, 
vga_wrôe_0x3c0
,

784 
DEVIO_SIZE8
);

785 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0x3b4, 2, 
s
, 
vga_ªad_0x3b4
, 
vga_wrôe_0x3b4
,

786 
DEVIO_SIZE8
);

787 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0x3d4, 2, 
s
, 
vga_ªad_0x3d4
, 
vga_wrôe_0x3d4
,

788 
DEVIO_SIZE8
);

789 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0x3ba, 1, 
s
, 
vga_ªad_0x3ba
, 
vga_wrôe_0x3ba
,

790 
DEVIO_SIZE8
);

791 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0x3da, 1, 
s
, 
vga_ªad_0x3da
, 
vga_wrôe_0x3da
,

792 
DEVIO_SIZE8
);

795 
	`˝u_ªgi°î_devi˚
(
p‹t_m≠
, 0x1˚, 2, 
s
, 
vbe_ªad
, 
vbe_wrôe
,

796 
DEVIO_SIZE16
);

798 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_ID
] = 
VBE_DISPI_ID5
;

799 
s
->
vbe_ªgs
[
VBE_DISPI_INDEX_VIDEO_MEMORY_64K
] = 
fb_dev
->
fb_size
 >> 16;

801 
fb_dev
->
devi˚_›aque
 = 
s
;

802 
fb_dev
->
ª‰esh
 = 
vga_ª‰esh
;

803  
s
;

804 
	}
}

	@virtio.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

29 
	~<°d¨g.h
>

31 
	~"cutûs.h
"

32 
	~"li°.h
"

33 
	~"vútio.h
"

38 
	#VIRTIO_MMIO_MAGIC_VALUE
 0x000

	)

39 
	#VIRTIO_MMIO_VERSION
 0x004

	)

40 
	#VIRTIO_MMIO_DEVICE_ID
 0x008

	)

41 
	#VIRTIO_MMIO_VENDOR_ID
 0x00c

	)

42 
	#VIRTIO_MMIO_DEVICE_FEATURES
 0x010

	)

43 
	#VIRTIO_MMIO_DEVICE_FEATURES_SEL
 0x014

	)

44 
	#VIRTIO_MMIO_DRIVER_FEATURES
 0x020

	)

45 
	#VIRTIO_MMIO_DRIVER_FEATURES_SEL
 0x024

	)

46 
	#VIRTIO_MMIO_GUEST_PAGE_SIZE
 0x028

	)

47 
	#VIRTIO_MMIO_QUEUE_SEL
 0x030

	)

48 
	#VIRTIO_MMIO_QUEUE_NUM_MAX
 0x034

	)

49 
	#VIRTIO_MMIO_QUEUE_NUM
 0x038

	)

50 
	#VIRTIO_MMIO_QUEUE_ALIGN
 0x03¯

	)

51 
	#VIRTIO_MMIO_QUEUE_PFN
 0x040

	)

52 
	#VIRTIO_MMIO_QUEUE_READY
 0x044

	)

53 
	#VIRTIO_MMIO_QUEUE_NOTIFY
 0x050

	)

54 
	#VIRTIO_MMIO_INTERRUPT_STATUS
 0x060

	)

55 
	#VIRTIO_MMIO_INTERRUPT_ACK
 0x064

	)

56 
	#VIRTIO_MMIO_STATUS
 0x070

	)

57 
	#VIRTIO_MMIO_QUEUE_DESC_LOW
 0x080

	)

58 
	#VIRTIO_MMIO_QUEUE_DESC_HIGH
 0x084

	)

59 
	#VIRTIO_MMIO_QUEUE_AVAIL_LOW
 0x090

	)

60 
	#VIRTIO_MMIO_QUEUE_AVAIL_HIGH
 0x094

	)

61 
	#VIRTIO_MMIO_QUEUE_USED_LOW
 0x0a0

	)

62 
	#VIRTIO_MMIO_QUEUE_USED_HIGH
 0x0a4

	)

63 
	#VIRTIO_MMIO_CONFIG_GENERATION
 0x0fc

	)

64 
	#VIRTIO_MMIO_CONFIG
 0x100

	)

67 
	#VIRTIO_PCI_DEVICE_FEATURE_SEL
 0x000

	)

68 
	#VIRTIO_PCI_DEVICE_FEATURE
 0x004

	)

69 
	#VIRTIO_PCI_GUEST_FEATURE_SEL
 0x008

	)

70 
	#VIRTIO_PCI_GUEST_FEATURE
 0x00c

	)

71 
	#VIRTIO_PCI_MSIX_CONFIG
 0x010

	)

72 
	#VIRTIO_PCI_NUM_QUEUES
 0x012

	)

73 
	#VIRTIO_PCI_DEVICE_STATUS
 0x014

	)

74 
	#VIRTIO_PCI_CONFIG_GENERATION
 0x015

	)

75 
	#VIRTIO_PCI_QUEUE_SEL
 0x016

	)

76 
	#VIRTIO_PCI_QUEUE_SIZE
 0x018

	)

77 
	#VIRTIO_PCI_QUEUE_MSIX_VECTOR
 0x01a

	)

78 
	#VIRTIO_PCI_QUEUE_ENABLE
 0x01c

	)

79 
	#VIRTIO_PCI_QUEUE_NOTIFY_OFF
 0x01e

	)

80 
	#VIRTIO_PCI_QUEUE_DESC_LOW
 0x020

	)

81 
	#VIRTIO_PCI_QUEUE_DESC_HIGH
 0x024

	)

82 
	#VIRTIO_PCI_QUEUE_AVAIL_LOW
 0x028

	)

83 
	#VIRTIO_PCI_QUEUE_AVAIL_HIGH
 0x02c

	)

84 
	#VIRTIO_PCI_QUEUE_USED_LOW
 0x030

	)

85 
	#VIRTIO_PCI_QUEUE_USED_HIGH
 0x034

	)

87 
	#VIRTIO_PCI_CFG_OFFSET
 0x0000

	)

88 
	#VIRTIO_PCI_ISR_OFFSET
 0x1000

	)

89 
	#VIRTIO_PCI_CONFIG_OFFSET
 0x2000

	)

90 
	#VIRTIO_PCI_NOTIFY_OFFSET
 0x3000

	)

92 
	#VIRTIO_PCI_CAP_LEN
 16

	)

94 
	#MAX_QUEUE
 8

	)

95 
	#MAX_CONFIG_SPACE_SIZE
 256

	)

96 
	#MAX_QUEUE_NUM
 16

	)

99 
uöt32_t
 
	mªady
;

100 
uöt32_t
 
	mnum
;

101 
uöt16_t
 
	mœ°_avaû_idx
;

102 
vútio_phys_addr_t
 
	mdesc_addr
;

103 
vútio_phys_addr_t
 
	mavaû_addr
;

104 
vútio_phys_addr_t
 
	mu£d_addr
;

105 
BOOL
 
	mm™uÆ_ªcv
;

106 } 
	tQueueSèã
;

108 
	#VRING_DESC_F_NEXT
 1

	)

109 
	#VRING_DESC_F_WRITE
 2

	)

110 
	#VRING_DESC_F_INDIRECT
 4

	)

113 
uöt64_t
 
	maddr
;

114 
uöt32_t
 
	mÀn
;

115 
uöt16_t
 
	mÊags
;

116 
uöt16_t
 
	m√xt
;

117 } 
	tVIRTIODesc
;

121 
	tVIRTIODevi˚RecvFunc
(
	tVIRTIODevi˚
 *
	ts1
, 
	tqueue_idx
,

122 
	tdesc_idx
, 
	tªad_size
,

123 
	twrôe_size
);

126 
uöt8_t
 *
	tVIRTIOGëRAMPåFunc
(
	tVIRTIODevi˚
 *
	ts
, 
	tvútio_phys_addr_t
 
	t∑ddr
, 
	tBOOL
 
	tis_rw
);

128 
	sVIRTIODevi˚
 {

129 
PhysMem‹yM≠
 *
	mmem_m≠
;

130 
PhysMem‹yR™ge
 *
	mmem_ønge
;

132 
PCIDevi˚
 *
	mpci_dev
;

134 
IRQSig«l
 *
	múq
;

135 
VIRTIOGëRAMPåFunc
 *
	mgë_øm_±r
;

136 
	mdebug
;

138 
uöt32_t
 
	möt_°©us
;

139 
uöt32_t
 
	m°©us
;

140 
uöt32_t
 
	mdevi˚_„©uªs_£l
;

141 
uöt32_t
 
	mqueue_£l
;

142 
QueueSèã
 
	mqueue
[
MAX_QUEUE
];

145 
uöt32_t
 
	mdevi˚_id
;

146 
uöt32_t
 
	mvíd‹_id
;

147 
uöt32_t
 
	mdevi˚_„©uªs
;

148 
VIRTIODevi˚RecvFunc
 *
	mdevi˚_ªcv
;

149 (*
	mc⁄fig_wrôe
)(
VIRTIODevi˚
 *
	ms
);

151 
uöt32_t
 
	mc⁄fig_•a˚_size
;

152 
uöt8_t
 
	mc⁄fig_•a˚
[
MAX_CONFIG_SPACE_SIZE
];

155 
uöt32_t
 
vútio_mmio_ªad
(*
›aque
, uöt32_à
off£t1
, 
size_log2
);

156 
vútio_mmio_wrôe
(*
›aque
, 
uöt32_t
 
off£t
,

157 
uöt32_t
 
vÆ
, 
size_log2
);

158 
uöt32_t
 
vútio_pci_ªad
(*
›aque
, uöt32_à
off£t
, 
size_log2
);

159 
vútio_pci_wrôe
(*
›aque
, 
uöt32_t
 
off£t
,

160 
uöt32_t
 
vÆ
, 
size_log2
);

162 
	$vútio_ª£t
(
VIRTIODevi˚
 *
s
)

164 
i
;

166 
s
->
°©us
 = 0;

167 
s
->
queue_£l
 = 0;

168 
s
->
devi˚_„©uªs_£l
 = 0;

169 
s
->
öt_°©us
 = 0;

170 
i
 = 0; i < 
MAX_QUEUE
; i++) {

171 
QueueSèã
 *
qs
 = &
s
->
queue
[
i
];

172 
qs
->
ªady
 = 0;

173 
qs
->
num
 = 
MAX_QUEUE_NUM
;

174 
qs
->
desc_addr
 = 0;

175 
qs
->
avaû_addr
 = 0;

176 
qs
->
u£d_addr
 = 0;

177 
qs
->
œ°_avaû_idx
 = 0;

179 
	}
}

181 
uöt8_t
 *
	$vútio_pci_gë_øm_±r
(
VIRTIODevi˚
 *
s
, 
vútio_phys_addr_t
 
∑ddr
, 
BOOL
 
is_rw
)

183  
	`pci_devi˚_gë_dma_±r
(
s
->
pci_dev
, 
∑ddr
, 
is_rw
);

184 
	}
}

186 
uöt8_t
 *
	$vútio_mmio_gë_øm_±r
(
VIRTIODevi˚
 *
s
, 
vútio_phys_addr_t
 
∑ddr
, 
BOOL
 
is_rw
)

188  
	`phys_mem_gë_øm_±r
(
s
->
mem_m≠
, 
∑ddr
, 
is_rw
);

189 
	}
}

191 
	$vútio_add_pci_ˇ∑bûôy
(
VIRTIODevi˚
 *
s
, 
cfg_ty≥
,

192 
b¨
, 
uöt32_t
 
off£t
, uöt32_à
Àn
,

193 
uöt32_t
 
mu…
)

195 
uöt8_t
 
ˇp
[20];

196 
ˇp_Àn
;

197 i‡(
cfg_ty≥
 == 2)

198 
ˇp_Àn
 = 20;

200 
ˇp_Àn
 = 16;

201 
	`mem£t
(
ˇp
, 0, 
ˇp_Àn
);

202 
ˇp
[0] = 0x09;

203 
ˇp
[2] = 
ˇp_Àn
;

204 
ˇp
[3] = 
cfg_ty≥
;

205 
ˇp
[4] = 
b¨
;

206 
	`put_À32
(
ˇp
 + 8, 
off£t
);

207 
	`put_À32
(
ˇp
 + 12, 
Àn
);

208 i‡(
cfg_ty≥
 == 2)

209 
	`put_À32
(
ˇp
 + 16, 
mu…
);

210 
	`pci_add_ˇ∑bûôy
(
s
->
pci_dev
, 
ˇp
, 
ˇp_Àn
);

211 
	}
}

213 
	$vútio_pci_b¨_£t
(*
›aque
, 
b¨_num
,

214 
uöt32_t
 
addr
, 
BOOL
 
íabÀd
)

216 
VIRTIODevi˚
 *
s
 = 
›aque
;

217 
	`phys_mem_£t_addr
(
s
->
mem_ønge
, 
addr
, 
íabÀd
);

218 
	}
}

220 
	$vútio_öô
(
VIRTIODevi˚
 *
s
, 
VIRTIOBusDef
 *
bus
,

221 
uöt32_t
 
devi˚_id
, 
c⁄fig_•a˚_size
,

222 
VIRTIODevi˚RecvFunc
 *
devi˚_ªcv
)

224 
	`mem£t
(
s
, 0, (*s));

226 i‡(
bus
->
pci_bus
) {

227 
uöt16_t
 
pci_devi˚_id
, 
˛ass_id
;

228 
«me
[32];

229 
b¨_num
;

231 
devi˚_id
) {

233 
pci_devi˚_id
 = 0x1000;

234 
˛ass_id
 = 0x0200;

237 
pci_devi˚_id
 = 0x1001;

238 
˛ass_id
 = 0x0100;

241 
pci_devi˚_id
 = 0x1003;

242 
˛ass_id
 = 0x0780;

245 
pci_devi˚_id
 = 0x1040 + 
devi˚_id
;

246 
˛ass_id
 = 0x2;

249 
pci_devi˚_id
 = 0x1040 + 
devi˚_id
;

250 
˛ass_id
 = 0x0980;

253 
	`ab‹t
();

255 
	`¢¥ötf
(
«me
, “ame), "vútio_%04x", 
pci_devi˚_id
);

256 
s
->
pci_dev
 = 
	`pci_ªgi°î_devi˚
(
bus
->
pci_bus
, 
«me
, -1,

257 0x1af4, 
pci_devi˚_id
, 0x00,

258 
˛ass_id
);

259 
	`pci_devi˚_£t_c⁄fig16
(
s
->
pci_dev
, 0x2c, 0x1af4);

260 
	`pci_devi˚_£t_c⁄fig16
(
s
->
pci_dev
, 0x2e, 
devi˚_id
);

261 
	`pci_devi˚_£t_c⁄fig8
(
s
->
pci_dev
, 
PCI_INTERRUPT_PIN
, 1);

263 
b¨_num
 = 4;

264 
	`vútio_add_pci_ˇ∑bûôy
(
s
, 1, 
b¨_num
,

265 
VIRTIO_PCI_CFG_OFFSET
, 0x1000, 0);

266 
	`vútio_add_pci_ˇ∑bûôy
(
s
, 3, 
b¨_num
,

267 
VIRTIO_PCI_ISR_OFFSET
, 0x1000, 0);

268 
	`vútio_add_pci_ˇ∑bûôy
(
s
, 4, 
b¨_num
,

269 
VIRTIO_PCI_CONFIG_OFFSET
, 0x1000, 0);

270 
	`vútio_add_pci_ˇ∑bûôy
(
s
, 2, 
b¨_num
,

271 
VIRTIO_PCI_NOTIFY_OFFSET
, 0x1000, 0);

273 
s
->
gë_øm_±r
 = 
vútio_pci_gë_øm_±r
;

274 
s
->
úq
 = 
	`pci_devi˚_gë_úq
(s->
pci_dev
, 0);

275 
s
->
mem_m≠
 = 
	`pci_devi˚_gë_mem_m≠
(s->
pci_dev
);

276 
s
->
mem_ønge
 = 
	`˝u_ªgi°î_devi˚
(s->
mem_m≠
, 0, 0x4000, s,

277 
vútio_pci_ªad
, 
vútio_pci_wrôe
,

278 
DEVIO_SIZE8
 | 
DEVIO_SIZE16
 | 
DEVIO_SIZE32
 | 
DEVIO_DISABLED
);

279 
	`pci_ªgi°î_b¨
(
s
->
pci_dev
, 
b¨_num
, 0x4000, 
PCI_ADDRESS_SPACE_MEM
,

280 
s
, 
vútio_pci_b¨_£t
);

283 
s
->
mem_m≠
 = 
bus
->mem_map;

284 
s
->
úq
 = 
bus
->irq;

285 
s
->
mem_ønge
 = 
	`˝u_ªgi°î_devi˚
(s->
mem_m≠
, 
bus
->
addr
, 
VIRTIO_PAGE_SIZE
,

286 
s
, 
vútio_mmio_ªad
, 
vútio_mmio_wrôe
,

287 
DEVIO_SIZE8
 | 
DEVIO_SIZE16
 | 
DEVIO_SIZE32
);

288 
s
->
gë_øm_±r
 = 
vútio_mmio_gë_øm_±r
;

291 
s
->
devi˚_id
 = device_id;

292 
s
->
víd‹_id
 = 0xffff;

293 
s
->
c⁄fig_•a˚_size
 = config_space_size;

294 
s
->
devi˚_ªcv
 = device_recv;

295 
	`vútio_ª£t
(
s
);

296 
	}
}

298 
uöt16_t
 
	$vútio_ªad16
(
VIRTIODevi˚
 *
s
, 
vútio_phys_addr_t
 
addr
)

300 
uöt8_t
 *
±r
;

301 i‡(
addr
 & 1)

303 
±r
 = 
s
->
	`gë_øm_±r
(s, 
addr
, 
FALSE
);

304 i‡(!
±r
)

306  *(
uöt16_t
 *)
±r
;

307 
	}
}

309 
	$vútio_wrôe16
(
VIRTIODevi˚
 *
s
, 
vútio_phys_addr_t
 
addr
,

310 
uöt16_t
 
vÆ
)

312 
uöt8_t
 *
±r
;

313 i‡(
addr
 & 1)

315 
±r
 = 
s
->
	`gë_øm_±r
(s, 
addr
, 
TRUE
);

316 i‡(!
±r
)

318 *(
uöt16_t
 *)
±r
 = 
vÆ
;

319 
	}
}

321 
	$vútio_wrôe32
(
VIRTIODevi˚
 *
s
, 
vútio_phys_addr_t
 
addr
,

322 
uöt32_t
 
vÆ
)

324 
uöt8_t
 *
±r
;

325 i‡(
addr
 & 3)

327 
±r
 = 
s
->
	`gë_øm_±r
(s, 
addr
, 
TRUE
);

328 i‡(!
±r
)

330 *(
uöt32_t
 *)
±r
 = 
vÆ
;

331 
	}
}

333 
	$vútio_mem˝y_‰om_øm
(
VIRTIODevi˚
 *
s
, 
uöt8_t
 *
buf
,

334 
vútio_phys_addr_t
 
addr
, 
cou¡
)

336 
uöt8_t
 *
±r
;

337 
l
;

339 
cou¡
 > 0) {

340 
l
 = 
	`mö_öt
(
cou¡
, 
VIRTIO_PAGE_SIZE
 - (
addr
 & (VIRTIO_PAGE_SIZE - 1)));

341 
±r
 = 
s
->
	`gë_øm_±r
(s, 
addr
, 
FALSE
);

342 i‡(!
±r
)

344 
	`mem˝y
(
buf
, 
±r
, 
l
);

345 
addr
 +
l
;

346 
buf
 +
l
;

347 
cou¡
 -
l
;

350 
	}
}

352 
	$vútio_mem˝y_to_øm
(
VIRTIODevi˚
 *
s
, 
vútio_phys_addr_t
 
addr
,

353 c⁄° 
uöt8_t
 *
buf
, 
cou¡
)

355 
uöt8_t
 *
±r
;

356 
l
;

358 
cou¡
 > 0) {

359 
l
 = 
	`mö_öt
(
cou¡
, 
VIRTIO_PAGE_SIZE
 - (
addr
 & (VIRTIO_PAGE_SIZE - 1)));

360 
±r
 = 
s
->
	`gë_øm_±r
(s, 
addr
, 
TRUE
);

361 i‡(!
±r
)

363 
	`mem˝y
(
±r
, 
buf
, 
l
);

364 
addr
 +
l
;

365 
buf
 +
l
;

366 
cou¡
 -
l
;

369 
	}
}

371 
	$gë_desc
(
VIRTIODevi˚
 *
s
, 
VIRTIODesc
 *
desc
,

372 
queue_idx
, 
desc_idx
)

374 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

375  
	`vútio_mem˝y_‰om_øm
(
s
, (*)
desc
, 
qs
->
desc_addr
 +

376 
desc_idx
 * (
VIRTIODesc
),

377 (
VIRTIODesc
));

378 
	}
}

380 
	$mem˝y_to_‰om_queue
(
VIRTIODevi˚
 *
s
, 
uöt8_t
 *
buf
,

381 
queue_idx
, 
desc_idx
,

382 
off£t
, 
cou¡
, 
BOOL
 
to_queue
)

384 
VIRTIODesc
 
desc
;

385 
l
, 
f_wrôe_Êag
;

387 i‡(
cou¡
 == 0)

390 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

392 i‡(
to_queue
) {

393 
f_wrôe_Êag
 = 
VRING_DESC_F_WRITE
;

396 i‡((
desc
.
Êags
 & 
VRING_DESC_F_WRITE
Ë=
f_wrôe_Êag
)

398 i‡(!(
desc
.
Êags
 & 
VRING_DESC_F_NEXT
))

400 
desc_idx
 = 
desc
.
√xt
;

401 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

404 
f_wrôe_Êag
 = 0;

409 i‡((
desc
.
Êags
 & 
VRING_DESC_F_WRITE
Ë!
f_wrôe_Êag
)

411 i‡(
off£t
 < 
desc
.
Àn
)

413 i‡(!(
desc
.
Êags
 & 
VRING_DESC_F_NEXT
))

415 
desc_idx
 = 
desc
.
√xt
;

416 
off£t
 -
desc
.
Àn
;

417 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

421 
l
 = 
	`mö_öt
(
cou¡
, 
desc
.
Àn
 - 
off£t
);

422 i‡(
to_queue
)

423 
	`vútio_mem˝y_to_øm
(
s
, 
desc
.
addr
 + 
off£t
, 
buf
, 
l
);

425 
	`vútio_mem˝y_‰om_øm
(
s
, 
buf
, 
desc
.
addr
 + 
off£t
, 
l
);

426 
cou¡
 -
l
;

427 i‡(
cou¡
 == 0)

429 
off£t
 +
l
;

430 
buf
 +
l
;

431 i‡(
off£t
 =
desc
.
Àn
) {

432 i‡(!(
desc
.
Êags
 & 
VRING_DESC_F_NEXT
))

434 
desc_idx
 = 
desc
.
√xt
;

435 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

436 i‡((
desc
.
Êags
 & 
VRING_DESC_F_WRITE
Ë!
f_wrôe_Êag
)

438 
off£t
 = 0;

442 
	}
}

444 
	$mem˝y_‰om_queue
(
VIRTIODevi˚
 *
s
, *
buf
,

445 
queue_idx
, 
desc_idx
,

446 
off£t
, 
cou¡
)

448  
	`mem˝y_to_‰om_queue
(
s
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 
cou¡
,

449 
FALSE
);

450 
	}
}

452 
	$mem˝y_to_queue
(
VIRTIODevi˚
 *
s
,

453 
queue_idx
, 
desc_idx
,

454 
off£t
, c⁄° *
buf
, 
cou¡
)

456  
	`mem˝y_to_‰om_queue
(
s
, (*)
buf
, 
queue_idx
, 
desc_idx
, 
off£t
,

457 
cou¡
, 
TRUE
);

458 
	}
}

461 
	$vútio_c⁄sume_desc
(
VIRTIODevi˚
 *
s
,

462 
queue_idx
, 
desc_idx
, 
desc_Àn
)

464 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

465 
vútio_phys_addr_t
 
addr
;

466 
uöt32_t
 
ödex
;

468 
addr
 = 
qs
->
u£d_addr
 + 2;

469 
ödex
 = 
	`vútio_ªad16
(
s
, 
addr
);

470 
	`vútio_wrôe16
(
s
, 
addr
, 
ödex
 + 1);

472 
addr
 = 
qs
->
u£d_addr
 + 4 + (
ödex
 & (qs->
num
 - 1)) * 8;

473 
	`vútio_wrôe32
(
s
, 
addr
, 
desc_idx
);

474 
	`vútio_wrôe32
(
s
, 
addr
 + 4, 
desc_Àn
);

476 
s
->
öt_°©us
 |= 1;

477 
	`£t_úq
(
s
->
úq
, 1);

478 
	}
}

480 
	$gë_desc_rw_size
(
VIRTIODevi˚
 *
s
,

481 *
¥ód_size
, *
pwrôe_size
,

482 
queue_idx
, 
desc_idx
)

484 
VIRTIODesc
 
desc
;

485 
ªad_size
, 
wrôe_size
;

487 
ªad_size
 = 0;

488 
wrôe_size
 = 0;

489 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

492 i‡(
desc
.
Êags
 & 
VRING_DESC_F_WRITE
)

494 
ªad_size
 +
desc
.
Àn
;

495 i‡(!(
desc
.
Êags
 & 
VRING_DESC_F_NEXT
))

496 
d⁄e
;

497 
desc_idx
 = 
desc
.
√xt
;

498 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

502 i‡(!(
desc
.
Êags
 & 
VRING_DESC_F_WRITE
))

504 
wrôe_size
 +
desc
.
Àn
;

505 i‡(!(
desc
.
Êags
 & 
VRING_DESC_F_NEXT
))

507 
desc_idx
 = 
desc
.
√xt
;

508 
	`gë_desc
(
s
, &
desc
, 
queue_idx
, 
desc_idx
);

511 
d⁄e
:

512 *
¥ód_size
 = 
ªad_size
;

513 *
pwrôe_size
 = 
wrôe_size
;

515 
	}
}

518 
	$queue_nŸify
(
VIRTIODevi˚
 *
s
, 
queue_idx
)

520 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

521 
uöt16_t
 
avaû_idx
;

522 
desc_idx
, 
ªad_size
, 
wrôe_size
;

524 i‡(
qs
->
m™uÆ_ªcv
)

527 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

528 
qs
->
œ°_avaû_idx
 !
avaû_idx
) {

529 
desc_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 4 +

530 (
qs
->
œ°_avaû_idx
 & (qs->
num
 - 1)) * 2);

531 i‡(!
	`gë_desc_rw_size
(
s
, &
ªad_size
, &
wrôe_size
, 
queue_idx
, 
desc_idx
)) {

532 #ifde‡
DEBUG_VIRTIO


533 i‡(
s
->
debug
 & 
VIRTIO_DEBUG_IO
) {

534 
	`¥ötf
("queue_notify: idx=%dÑead_size=%d write_size=%d\n",

535 
queue_idx
, 
ªad_size
, 
wrôe_size
);

538 i‡(
s
->
	`devi˚_ªcv
(s, 
queue_idx
, 
desc_idx
,

539 
ªad_size
, 
wrôe_size
) < 0)

542 
qs
->
œ°_avaû_idx
++;

544 
	}
}

546 
uöt32_t
 
	$vútio_c⁄fig_ªad
(
VIRTIODevi˚
 *
s
, 
uöt32_t
 
off£t
,

547 
size_log2
)

549 
uöt32_t
 
vÆ
;

550 
size_log2
) {

552 i‡(
off£t
 < 
s
->
c⁄fig_•a˚_size
) {

553 
vÆ
 = 
s
->
c⁄fig_•a˚
[
off£t
];

555 
vÆ
 = 0;

559 i‡(
off£t
 < (
s
->
c⁄fig_•a˚_size
 - 1)) {

560 
vÆ
 = 
	`gë_À16
(&
s
->
c⁄fig_•a˚
[
off£t
]);

562 
vÆ
 = 0;

566 i‡(
off£t
 < (
s
->
c⁄fig_•a˚_size
 - 3)) {

567 
vÆ
 = 
	`gë_À32
(
s
->
c⁄fig_•a˚
 + 
off£t
);

569 
vÆ
 = 0;

573 
	`ab‹t
();

575  
vÆ
;

576 
	}
}

578 
	$vútio_c⁄fig_wrôe
(
VIRTIODevi˚
 *
s
, 
uöt32_t
 
off£t
,

579 
uöt32_t
 
vÆ
, 
size_log2
)

581 
size_log2
) {

583 i‡(
off£t
 < 
s
->
c⁄fig_•a˚_size
) {

584 
s
->
c⁄fig_•a˚
[
off£t
] = 
vÆ
;

585 i‡(
s
->
c⁄fig_wrôe
)

586 
s
->
	`c⁄fig_wrôe
(s);

590 i‡(
off£t
 < 
s
->
c⁄fig_•a˚_size
 - 1) {

591 
	`put_À16
(
s
->
c⁄fig_•a˚
 + 
off£t
, 
vÆ
);

592 i‡(
s
->
c⁄fig_wrôe
)

593 
s
->
	`c⁄fig_wrôe
(s);

597 i‡(
off£t
 < 
s
->
c⁄fig_•a˚_size
 - 3) {

598 
	`put_À32
(
s
->
c⁄fig_•a˚
 + 
off£t
, 
vÆ
);

599 i‡(
s
->
c⁄fig_wrôe
)

600 
s
->
	`c⁄fig_wrôe
(s);

604 
	}
}

606 
uöt32_t
 
	$vútio_mmio_ªad
(*
›aque
, 
uöt32_t
 
off£t
, 
size_log2
)

608 
VIRTIODevi˚
 *
s
 = 
›aque
;

609 
uöt32_t
 
vÆ
;

611 i‡(
off£t
 >
VIRTIO_MMIO_CONFIG
) {

612  
	`vútio_c⁄fig_ªad
(
s
, 
off£t
 - 
VIRTIO_MMIO_CONFIG
, 
size_log2
);

615 i‡(
size_log2
 == 2) {

616 
off£t
) {

617 
VIRTIO_MMIO_MAGIC_VALUE
:

618 
vÆ
 = 0x74726976;

620 
VIRTIO_MMIO_VERSION
:

621 
vÆ
 = 2;

623 
VIRTIO_MMIO_DEVICE_ID
:

624 
vÆ
 = 
s
->
devi˚_id
;

626 
VIRTIO_MMIO_VENDOR_ID
:

627 
vÆ
 = 
s
->
víd‹_id
;

629 
VIRTIO_MMIO_DEVICE_FEATURES
:

630 
s
->
devi˚_„©uªs_£l
) {

632 
vÆ
 = 
s
->
devi˚_„©uªs
;

635 
vÆ
 = 1;

638 
vÆ
 = 0;

642 
VIRTIO_MMIO_DEVICE_FEATURES_SEL
:

643 
vÆ
 = 
s
->
devi˚_„©uªs_£l
;

645 
VIRTIO_MMIO_QUEUE_SEL
:

646 
vÆ
 = 
s
->
queue_£l
;

648 
VIRTIO_MMIO_QUEUE_NUM_MAX
:

649 
vÆ
 = 
MAX_QUEUE_NUM
;

651 
VIRTIO_MMIO_QUEUE_NUM
:

652 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
num
;

654 
VIRTIO_MMIO_QUEUE_DESC_LOW
:

655 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
desc_addr
;

657 
VIRTIO_MMIO_QUEUE_AVAIL_LOW
:

658 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
avaû_addr
;

660 
VIRTIO_MMIO_QUEUE_USED_LOW
:

661 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
u£d_addr
;

663 #i‡
VIRTIO_ADDR_BITS
 == 64

664 
VIRTIO_MMIO_QUEUE_DESC_HIGH
:

665 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
desc_addr
 >> 32;

667 
VIRTIO_MMIO_QUEUE_AVAIL_HIGH
:

668 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
avaû_addr
 >> 32;

670 
VIRTIO_MMIO_QUEUE_USED_HIGH
:

671 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
u£d_addr
 >> 32;

674 
VIRTIO_MMIO_QUEUE_READY
:

675 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
ªady
;

677 
VIRTIO_MMIO_INTERRUPT_STATUS
:

678 
vÆ
 = 
s
->
öt_°©us
;

680 
VIRTIO_MMIO_STATUS
:

681 
vÆ
 = 
s
->
°©us
;

683 
VIRTIO_MMIO_CONFIG_GENERATION
:

684 
vÆ
 = 0;

687 
vÆ
 = 0;

691 
vÆ
 = 0;

693 #ifde‡
DEBUG_VIRTIO


694 i‡(
s
->
debug
 & 
VIRTIO_DEBUG_IO
) {

695 
	`¥ötf
("virto_mmio_read: offset=0x%x val=0x%x size=%d\n",

696 
off£t
, 
vÆ
, 1 << 
size_log2
);

699  
vÆ
;

700 
	}
}

702 #i‡
VIRTIO_ADDR_BITS
 == 64

703 
	$£t_low32
(
vútio_phys_addr_t
 *
∑ddr
, 
uöt32_t
 
vÆ
)

705 *
∑ddr
 = (*∑dd∏& ~(
vútio_phys_addr_t
)0xffffffffË| 
vÆ
;

706 
	}
}

708 
	$£t_high32
(
vútio_phys_addr_t
 *
∑ddr
, 
uöt32_t
 
vÆ
)

710 *
∑ddr
 = (*∑dd∏& 0xffffffffË| ((
vútio_phys_addr_t
)
vÆ
 << 32);

711 
	}
}

713 
	$£t_low32
(
vútio_phys_addr_t
 *
∑ddr
, 
uöt32_t
 
vÆ
)

715 *
∑ddr
 = 
vÆ
;

716 
	}
}

719 
	$vútio_mmio_wrôe
(*
›aque
, 
uöt32_t
 
off£t
,

720 
uöt32_t
 
vÆ
, 
size_log2
)

722 
VIRTIODevi˚
 *
s
 = 
›aque
;

724 #ifde‡
DEBUG_VIRTIO


725 i‡(
s
->
debug
 & 
VIRTIO_DEBUG_IO
) {

726 
	`¥ötf
("virto_mmio_write: offset=0x%x val=0x%x size=%d\n",

727 
off£t
, 
vÆ
, 1 << 
size_log2
);

731 i‡(
off£t
 >
VIRTIO_MMIO_CONFIG
) {

732 
	`vútio_c⁄fig_wrôe
(
s
, 
off£t
 - 
VIRTIO_MMIO_CONFIG
, 
vÆ
, 
size_log2
);

736 i‡(
size_log2
 == 2) {

737 
off£t
) {

738 
VIRTIO_MMIO_DEVICE_FEATURES_SEL
:

739 
s
->
devi˚_„©uªs_£l
 = 
vÆ
;

741 
VIRTIO_MMIO_QUEUE_SEL
:

742 i‡(
vÆ
 < 
MAX_QUEUE
)

743 
s
->
queue_£l
 = 
vÆ
;

745 
VIRTIO_MMIO_QUEUE_NUM
:

746 i‡((
vÆ
 & (val - 1)) == 0 && val > 0) {

747 
s
->
queue
[s->
queue_£l
].
num
 = 
vÆ
;

750 
VIRTIO_MMIO_QUEUE_DESC_LOW
:

751 
	`£t_low32
(&
s
->
queue
[s->
queue_£l
].
desc_addr
, 
vÆ
);

753 
VIRTIO_MMIO_QUEUE_AVAIL_LOW
:

754 
	`£t_low32
(&
s
->
queue
[s->
queue_£l
].
avaû_addr
, 
vÆ
);

756 
VIRTIO_MMIO_QUEUE_USED_LOW
:

757 
	`£t_low32
(&
s
->
queue
[s->
queue_£l
].
u£d_addr
, 
vÆ
);

759 #i‡
VIRTIO_ADDR_BITS
 == 64

760 
VIRTIO_MMIO_QUEUE_DESC_HIGH
:

761 
	`£t_high32
(&
s
->
queue
[s->
queue_£l
].
desc_addr
, 
vÆ
);

763 
VIRTIO_MMIO_QUEUE_AVAIL_HIGH
:

764 
	`£t_high32
(&
s
->
queue
[s->
queue_£l
].
avaû_addr
, 
vÆ
);

766 
VIRTIO_MMIO_QUEUE_USED_HIGH
:

767 
	`£t_high32
(&
s
->
queue
[s->
queue_£l
].
u£d_addr
, 
vÆ
);

770 
VIRTIO_MMIO_STATUS
:

771 
s
->
°©us
 = 
vÆ
;

772 i‡(
vÆ
 == 0) {

774 
	`£t_úq
(
s
->
úq
, 0);

775 
	`vútio_ª£t
(
s
);

778 
VIRTIO_MMIO_QUEUE_READY
:

779 
s
->
queue
[s->
queue_£l
].
ªady
 = 
vÆ
 & 1;

781 
VIRTIO_MMIO_QUEUE_NOTIFY
:

782 i‡(
vÆ
 < 
MAX_QUEUE
)

783 
	`queue_nŸify
(
s
, 
vÆ
);

785 
VIRTIO_MMIO_INTERRUPT_ACK
:

786 
s
->
öt_°©us
 &~
vÆ
;

787 i‡(
s
->
öt_°©us
 == 0) {

788 
	`£t_úq
(
s
->
úq
, 0);

793 
	}
}

795 
uöt32_t
 
	$vútio_pci_ªad
(*
›aque
, 
uöt32_t
 
off£t1
, 
size_log2
)

797 
VIRTIODevi˚
 *
s
 = 
›aque
;

798 
uöt32_t
 
off£t
;

799 
uöt32_t
 
vÆ
 = 0;

801 
off£t
 = 
off£t1
 & 0xfff;

802 
off£t1
 >> 12) {

803 
VIRTIO_PCI_CFG_OFFSET
 >> 12:

804 i‡(
size_log2
 == 2) {

805 
off£t
) {

806 
VIRTIO_PCI_DEVICE_FEATURE
:

807 
s
->
devi˚_„©uªs_£l
) {

809 
vÆ
 = 
s
->
devi˚_„©uªs
;

812 
vÆ
 = 1;

815 
vÆ
 = 0;

819 
VIRTIO_PCI_DEVICE_FEATURE_SEL
:

820 
vÆ
 = 
s
->
devi˚_„©uªs_£l
;

822 
VIRTIO_PCI_QUEUE_DESC_LOW
:

823 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
desc_addr
;

825 
VIRTIO_PCI_QUEUE_AVAIL_LOW
:

826 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
avaû_addr
;

828 
VIRTIO_PCI_QUEUE_USED_LOW
:

829 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
u£d_addr
;

831 #i‡
VIRTIO_ADDR_BITS
 == 64

832 
VIRTIO_PCI_QUEUE_DESC_HIGH
:

833 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
desc_addr
 >> 32;

835 
VIRTIO_PCI_QUEUE_AVAIL_HIGH
:

836 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
avaû_addr
 >> 32;

838 
VIRTIO_PCI_QUEUE_USED_HIGH
:

839 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
u£d_addr
 >> 32;

843 } i‡(
size_log2
 == 1) {

844 
off£t
) {

845 
VIRTIO_PCI_NUM_QUEUES
:

846 
vÆ
 = 
MAX_QUEUE_NUM
;

848 
VIRTIO_PCI_QUEUE_SEL
:

849 
vÆ
 = 
s
->
queue_£l
;

851 
VIRTIO_PCI_QUEUE_SIZE
:

852 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
num
;

854 
VIRTIO_PCI_QUEUE_ENABLE
:

855 
vÆ
 = 
s
->
queue
[s->
queue_£l
].
ªady
;

857 
VIRTIO_PCI_QUEUE_NOTIFY_OFF
:

858 
vÆ
 = 0;

861 } i‡(
size_log2
 == 0) {

862 
off£t
) {

863 
VIRTIO_PCI_DEVICE_STATUS
:

864 
vÆ
 = 
s
->
°©us
;

869 
VIRTIO_PCI_ISR_OFFSET
 >> 12:

870 i‡(
off£t
 =0 && 
size_log2
 == 0) {

871 
vÆ
 = 
s
->
öt_°©us
;

872 
s
->
öt_°©us
 = 0;

873 
	`£t_úq
(
s
->
úq
, 0);

876 
VIRTIO_PCI_CONFIG_OFFSET
 >> 12:

877 
vÆ
 = 
	`vútio_c⁄fig_ªad
(
s
, 
off£t
, 
size_log2
);

880 #ifde‡
DEBUG_VIRTIO


881 i‡(
s
->
debug
 & 
VIRTIO_DEBUG_IO
) {

882 
	`¥ötf
("virto_pci_read: offset=0x%x val=0x%x size=%d\n",

883 
off£t1
, 
vÆ
, 1 << 
size_log2
);

886  
vÆ
;

887 
	}
}

889 
	$vútio_pci_wrôe
(*
›aque
, 
uöt32_t
 
off£t1
,

890 
uöt32_t
 
vÆ
, 
size_log2
)

892 
VIRTIODevi˚
 *
s
 = 
›aque
;

893 
uöt32_t
 
off£t
;

895 #ifde‡
DEBUG_VIRTIO


896 i‡(
s
->
debug
 & 
VIRTIO_DEBUG_IO
) {

897 
	`¥ötf
("virto_pci_write: offset=0x%x val=0x%x size=%d\n",

898 
off£t1
, 
vÆ
, 1 << 
size_log2
);

901 
off£t
 = 
off£t1
 & 0xfff;

902 
off£t1
 >> 12) {

903 
VIRTIO_PCI_CFG_OFFSET
 >> 12:

904 i‡(
size_log2
 == 2) {

905 
off£t
) {

906 
VIRTIO_PCI_DEVICE_FEATURE_SEL
:

907 
s
->
devi˚_„©uªs_£l
 = 
vÆ
;

909 
VIRTIO_PCI_QUEUE_DESC_LOW
:

910 
	`£t_low32
(&
s
->
queue
[s->
queue_£l
].
desc_addr
, 
vÆ
);

912 
VIRTIO_PCI_QUEUE_AVAIL_LOW
:

913 
	`£t_low32
(&
s
->
queue
[s->
queue_£l
].
avaû_addr
, 
vÆ
);

915 
VIRTIO_PCI_QUEUE_USED_LOW
:

916 
	`£t_low32
(&
s
->
queue
[s->
queue_£l
].
u£d_addr
, 
vÆ
);

918 #i‡
VIRTIO_ADDR_BITS
 == 64

919 
VIRTIO_PCI_QUEUE_DESC_HIGH
:

920 
	`£t_high32
(&
s
->
queue
[s->
queue_£l
].
desc_addr
, 
vÆ
);

922 
VIRTIO_PCI_QUEUE_AVAIL_HIGH
:

923 
	`£t_high32
(&
s
->
queue
[s->
queue_£l
].
avaû_addr
, 
vÆ
);

925 
VIRTIO_PCI_QUEUE_USED_HIGH
:

926 
	`£t_high32
(&
s
->
queue
[s->
queue_£l
].
u£d_addr
, 
vÆ
);

930 } i‡(
size_log2
 == 1) {

931 
off£t
) {

932 
VIRTIO_PCI_QUEUE_SEL
:

933 i‡(
vÆ
 < 
MAX_QUEUE
)

934 
s
->
queue_£l
 = 
vÆ
;

936 
VIRTIO_PCI_QUEUE_SIZE
:

937 i‡((
vÆ
 & (val - 1)) == 0 && val > 0) {

938 
s
->
queue
[s->
queue_£l
].
num
 = 
vÆ
;

941 
VIRTIO_PCI_QUEUE_ENABLE
:

942 
s
->
queue
[s->
queue_£l
].
ªady
 = 
vÆ
 & 1;

945 } i‡(
size_log2
 == 0) {

946 
off£t
) {

947 
VIRTIO_PCI_DEVICE_STATUS
:

948 
s
->
°©us
 = 
vÆ
;

949 i‡(
vÆ
 == 0) {

951 
	`£t_úq
(
s
->
úq
, 0);

952 
	`vútio_ª£t
(
s
);

958 
VIRTIO_PCI_CONFIG_OFFSET
 >> 12:

959 
	`vútio_c⁄fig_wrôe
(
s
, 
off£t
, 
vÆ
, 
size_log2
);

961 
VIRTIO_PCI_NOTIFY_OFFSET
 >> 12:

962 i‡(
vÆ
 < 
MAX_QUEUE
)

963 
	`queue_nŸify
(
s
, 
vÆ
);

966 
	}
}

968 
	$vútio_£t_debug
(
VIRTIODevi˚
 *
s
, 
debug
)

970 
s
->
debug
 = debug;

971 
	}
}

973 
	$vútio_c⁄fig_ch™ge_nŸify
(
VIRTIODevi˚
 *
s
)

976 
s
->
öt_°©us
 |= 2;

977 
	`£t_úq
(
s
->
úq
, 1);

978 
	}
}

984 
uöt32_t
 
	mty≥
;

985 
uöt8_t
 *
	mbuf
;

986 
	mwrôe_size
;

987 
	mqueue_idx
;

988 
	mdesc_idx
;

989 } 
	tBlockReque°
;

991 
	sVIRTIOBlockDevi˚
 {

992 
VIRTIODevi˚
 
	mcomm⁄
;

993 
BlockDevi˚
 *
	mbs
;

995 
BOOL
 
	mªq_ö_¥ogªss
;

996 
BlockReque°
 
	mªq
;

997 } 
	tVIRTIOBlockDevi˚
;

1000 
uöt32_t
 
	mty≥
;

1001 
uöt32_t
 
	mi›rio
;

1002 
uöt64_t
 
	m£˘‹_num
;

1003 } 
	tBlockReque°Hódî
;

1005 
	#VIRTIO_BLK_T_IN
 0

	)

1006 
	#VIRTIO_BLK_T_OUT
 1

	)

1007 
	#VIRTIO_BLK_T_FLUSH
 4

	)

1008 
	#VIRTIO_BLK_T_FLUSH_OUT
 5

	)

1010 
	#VIRTIO_BLK_S_OK
 0

	)

1011 
	#VIRTIO_BLK_S_IOERR
 1

	)

1012 
	#VIRTIO_BLK_S_UNSUPP
 2

	)

1014 
	#SECTOR_SIZE
 512

	)

1016 
	$vútio_block_ªq_íd
(
VIRTIODevi˚
 *
s
, 
ªt
)

1018 
VIRTIOBlockDevi˚
 *
s1
 = (VIRTIOBlockDevi˚ *)
s
;

1019 
wrôe_size
;

1020 
queue_idx
 = 
s1
->
ªq
.queue_idx;

1021 
desc_idx
 = 
s1
->
ªq
.desc_idx;

1022 
uöt8_t
 *
buf
, 
buf1
[1];

1024 
s1
->
ªq
.
ty≥
) {

1025 
VIRTIO_BLK_T_IN
:

1026 
wrôe_size
 = 
s1
->
ªq
.write_size;

1027 
buf
 = 
s1
->
ªq
.buf;

1028 i‡(
ªt
 < 0) {

1029 
buf
[
wrôe_size
 - 1] = 
VIRTIO_BLK_S_IOERR
;

1031 
buf
[
wrôe_size
 - 1] = 
VIRTIO_BLK_S_OK
;

1033 
	`mem˝y_to_queue
(
s
, 
queue_idx
, 
desc_idx
, 0, 
buf
, 
wrôe_size
);

1034 
	`‰ì
(
buf
);

1035 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 
wrôe_size
);

1037 
VIRTIO_BLK_T_OUT
:

1038 i‡(
ªt
 < 0)

1039 
buf1
[0] = 
VIRTIO_BLK_S_IOERR
;

1041 
buf1
[0] = 
VIRTIO_BLK_S_OK
;

1042 
	`mem˝y_to_queue
(
s
, 
queue_idx
, 
desc_idx
, 0, 
buf1
, (buf1));

1043 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 1);

1046 
	`ab‹t
();

1048 
	}
}

1050 
	$vútio_block_ªq_cb
(*
›aque
, 
ªt
)

1052 
VIRTIODevi˚
 *
s
 = 
›aque
;

1053 
VIRTIOBlockDevi˚
 *
s1
 = (VIRTIOBlockDevi˚ *)
s
;

1055 
	`vútio_block_ªq_íd
(
s
, 
ªt
);

1057 
s1
->
ªq_ö_¥ogªss
 = 
FALSE
;

1060 
	`queue_nŸify
((
VIRTIODevi˚
 *)
s
, 
s1
->
ªq
.
queue_idx
);

1061 
	}
}

1064 
	$vútio_block_ªcv_ªque°
(
VIRTIODevi˚
 *
s
, 
queue_idx
,

1065 
desc_idx
, 
ªad_size
,

1066 
wrôe_size
)

1068 
VIRTIOBlockDevi˚
 *
s1
 = (VIRTIOBlockDevi˚ *)
s
;

1069 
BlockDevi˚
 *
bs
 = 
s1
->bs;

1070 
BlockReque°Hódî
 
h
;

1071 
uöt8_t
 *
buf
;

1072 
Àn
, 
ªt
;

1074 i‡(
s1
->
ªq_ö_¥ogªss
)

1077 i‡(
	`mem˝y_‰om_queue
(
s
, &
h
, 
queue_idx
, 
desc_idx
, 0, (h)) < 0)

1079 
s1
->
ªq
.
ty≥
 = 
h
.type;

1080 
s1
->
ªq
.
queue_idx
 = queue_idx;

1081 
s1
->
ªq
.
desc_idx
 = desc_idx;

1082 
h
.
ty≥
) {

1083 
VIRTIO_BLK_T_IN
:

1084 
s1
->
ªq
.
buf
 = 
	`mÆloc
(
wrôe_size
);

1085 
s1
->
ªq
.
wrôe_size
 = write_size;

1086 
ªt
 = 
bs
->
	`ªad_async
(bs, 
h
.
£˘‹_num
, 
s1
->
ªq
.
buf
,

1087 (
wrôe_size
 - 1Ë/ 
SECTOR_SIZE
,

1088 
vútio_block_ªq_cb
, 
s
);

1089 i‡(
ªt
 > 0) {

1091 
s1
->
ªq_ö_¥ogªss
 = 
TRUE
;

1093 
	`vútio_block_ªq_íd
(
s
, 
ªt
);

1096 
VIRTIO_BLK_T_OUT
:

1097 
	`as£π
(
wrôe_size
 >= 1);

1098 
Àn
 = 
ªad_size
 - (
h
);

1099 
buf
 = 
	`mÆloc
(
Àn
);

1100 
	`mem˝y_‰om_queue
(
s
, 
buf
, 
queue_idx
, 
desc_idx
, (
h
), 
Àn
);

1101 
ªt
 = 
bs
->
	`wrôe_async
(bs, 
h
.
£˘‹_num
, 
buf
, 
Àn
 / 
SECTOR_SIZE
,

1102 
vútio_block_ªq_cb
, 
s
);

1103 
	`‰ì
(
buf
);

1104 i‡(
ªt
 > 0) {

1106 
s1
->
ªq_ö_¥ogªss
 = 
TRUE
;

1108 
	`vútio_block_ªq_íd
(
s
, 
ªt
);

1115 
	}
}

1117 
VIRTIODevi˚
 *
	$vútio_block_öô
(
VIRTIOBusDef
 *
bus
, 
BlockDevi˚
 *
bs
)

1119 
VIRTIOBlockDevi˚
 *
s
;

1120 
uöt64_t
 
nb_£˘‹s
;

1122 
s
 = 
	`mÆlocz
((*s));

1123 
	`vútio_öô
(&
s
->
comm⁄
, 
bus
,

1124 2, 8, 
vútio_block_ªcv_ªque°
);

1125 
s
->
bs
 = bs;

1127 
nb_£˘‹s
 = 
bs
->
	`gë_£˘‹_cou¡
(bs);

1128 
	`put_À32
(
s
->
comm⁄
.
c⁄fig_•a˚
, 
nb_£˘‹s
);

1129 
	`put_À32
(
s
->
comm⁄
.
c⁄fig_•a˚
 + 4, 
nb_£˘‹s
 >> 32);

1131  (
VIRTIODevi˚
 *)
s
;

1132 
	}
}

1137 
	sVIRTIONëDevi˚
 {

1138 
VIRTIODevi˚
 
	mcomm⁄
;

1139 
Ethî√tDevi˚
 *
	mes
;

1140 
	mhódî_size
;

1141 } 
	tVIRTIONëDevi˚
;

1144 
uöt8_t
 
	mÊags
;

1145 
uöt8_t
 
	mgso_ty≥
;

1146 
uöt16_t
 
	mhdr_Àn
;

1147 
uöt16_t
 
	mgso_size
;

1148 
uöt16_t
 
	mcsum_°¨t
;

1149 
uöt16_t
 
	mcsum_off£t
;

1150 
uöt16_t
 
	mnum_buf„rs
;

1151 } 
	tVIRTIONëHódî
;

1153 
	$vútio_√t_ªcv_ªque°
(
VIRTIODevi˚
 *
s
, 
queue_idx
,

1154 
desc_idx
, 
ªad_size
,

1155 
wrôe_size
)

1157 
VIRTIONëDevi˚
 *
s1
 = (VIRTIONëDevi˚ *)
s
;

1158 
Ethî√tDevi˚
 *
es
 = 
s1
->es;

1159 
VIRTIONëHódî
 
h
;

1160 
uöt8_t
 *
buf
;

1161 
Àn
;

1163 i‡(
queue_idx
 == 1) {

1165 i‡(
	`mem˝y_‰om_queue
(
s
, &
h
, 
queue_idx
, 
desc_idx
, 0, 
s1
->
hódî_size
) < 0)

1167 
Àn
 = 
ªad_size
 - 
s1
->
hódî_size
;

1168 
buf
 = 
	`mÆloc
(
Àn
);

1169 
	`mem˝y_‰om_queue
(
s
, 
buf
, 
queue_idx
, 
desc_idx
, 
s1
->
hódî_size
, 
Àn
);

1170 
es
->
	`wrôe_∑ckë
”s, 
buf
, 
Àn
);

1171 
	`‰ì
(
buf
);

1172 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 0);

1175 
	}
}

1177 
BOOL
 
	$vútio_√t_ˇn_wrôe_∑ckë
(
Ethî√tDevi˚
 *
es
)

1179 
VIRTIODevi˚
 *
s
 = 
es
->
devi˚_›aque
;

1180 
QueueSèã
 *
qs
 = &
s
->
queue
[0];

1181 
uöt16_t
 
avaû_idx
;

1183 i‡(!
qs
->
ªady
)

1184  
FALSE
;

1185 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

1186  
qs
->
œ°_avaû_idx
 !
avaû_idx
;

1187 
	}
}

1189 
	$vútio_√t_wrôe_∑ckë
(
Ethî√tDevi˚
 *
es
, c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
)

1191 
VIRTIODevi˚
 *
s
 = 
es
->
devi˚_›aque
;

1192 
VIRTIONëDevi˚
 *
s1
 = (VIRTIONëDevi˚ *)
s
;

1193 
queue_idx
 = 0;

1194 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

1195 
desc_idx
;

1196 
VIRTIONëHódî
 
h
;

1197 
Àn
, 
ªad_size
, 
wrôe_size
;

1198 
uöt16_t
 
avaû_idx
;

1200 i‡(!
qs
->
ªady
)

1202 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

1203 i‡(
qs
->
œ°_avaû_idx
 =
avaû_idx
)

1205 
desc_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 4 +

1206 (
qs
->
œ°_avaû_idx
 & (qs->
num
 - 1)) * 2);

1207 i‡(
	`gë_desc_rw_size
(
s
, &
ªad_size
, &
wrôe_size
, 
queue_idx
, 
desc_idx
))

1209 
Àn
 = 
s1
->
hódî_size
 + 
buf_Àn
;

1210 i‡(
Àn
 > 
wrôe_size
)

1212 
	`mem£t
(&
h
, 0, 
s1
->
hódî_size
);

1213 
	`mem˝y_to_queue
(
s
, 
queue_idx
, 
desc_idx
, 0, &
h
, 
s1
->
hódî_size
);

1214 
	`mem˝y_to_queue
(
s
, 
queue_idx
, 
desc_idx
, 
s1
->
hódî_size
, 
buf
, 
buf_Àn
);

1215 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 
Àn
);

1216 
qs
->
œ°_avaû_idx
++;

1217 
	}
}

1219 
	$vútio_√t_£t_ˇºõr
(
Ethî√tDevi˚
 *
es
, 
BOOL
 
ˇºõr_°©e
)

1222 
VIRTIODevi˚
 *
s1
 = 
es
->
devi˚_›aque
;

1223 
VIRTIONëDevi˚
 *
s
 = (VIRTIONëDevi˚ *)
s1
;

1224 
cur_ˇºõr_°©e
;

1227 
cur_ˇºõr_°©e
 = 
s
->
comm⁄
.
c⁄fig_•a˚
[6] & 1;

1228 i‡(
cur_ˇºõr_°©e
 !
ˇºõr_°©e
) {

1229 
s
->
comm⁄
.
c⁄fig_•a˚
[6] = (
ˇºõr_°©e
 << 0);

1230 
	`vútio_c⁄fig_ch™ge_nŸify
(
s1
);

1233 
	}
}

1235 
VIRTIODevi˚
 *
	$vútio_√t_öô
(
VIRTIOBusDef
 *
bus
, 
Ethî√tDevi˚
 *
es
)

1237 
VIRTIONëDevi˚
 *
s
;

1239 
s
 = 
	`mÆlocz
((*s));

1240 
	`vútio_öô
(&
s
->
comm⁄
, 
bus
,

1241 1, 6 + 2, 
vútio_√t_ªcv_ªque°
);

1243 
s
->
comm⁄
.
devi˚_„©uªs
 = (1 << 5) ;

1244 
s
->
comm⁄
.
queue
[0].
m™uÆ_ªcv
 = 
TRUE
;

1245 
s
->
es
 =És;

1246 
	`mem˝y
(
s
->
comm⁄
.
c⁄fig_•a˚
, 
es
->
mac_addr
, 6);

1248 
s
->
comm⁄
.
c⁄fig_•a˚
[6] = 0;

1249 
s
->
comm⁄
.
c⁄fig_•a˚
[7] = 0;

1251 
s
->
hódî_size
 = (
VIRTIONëHódî
);

1253 
es
->
devi˚_›aque
 = 
s
;

1254 
es
->
devi˚_ˇn_wrôe_∑ckë
 = 
vútio_√t_ˇn_wrôe_∑ckë
;

1255 
es
->
devi˚_wrôe_∑ckë
 = 
vútio_√t_wrôe_∑ckë
;

1256 
es
->
devi˚_£t_ˇºõr
 = 
vútio_√t_£t_ˇºõr
;

1257  (
VIRTIODevi˚
 *)
s
;

1258 
	}
}

1263 
	sVIRTIOC⁄sﬁeDevi˚
 {

1264 
VIRTIODevi˚
 
	mcomm⁄
;

1265 
Ch¨a˘îDevi˚
 *
	mcs
;

1266 } 
	tVIRTIOC⁄sﬁeDevi˚
;

1268 
	$vútio_c⁄sﬁe_ªcv_ªque°
(
VIRTIODevi˚
 *
s
, 
queue_idx
,

1269 
desc_idx
, 
ªad_size
,

1270 
wrôe_size
)

1272 
VIRTIOC⁄sﬁeDevi˚
 *
s1
 = (VIRTIOC⁄sﬁeDevi˚ *)
s
;

1273 
Ch¨a˘îDevi˚
 *
cs
 = 
s1
->cs;

1274 
uöt8_t
 *
buf
;

1276 i‡(
queue_idx
 == 1) {

1278 
buf
 = 
	`mÆloc
(
ªad_size
);

1279 
	`mem˝y_‰om_queue
(
s
, 
buf
, 
queue_idx
, 
desc_idx
, 0, 
ªad_size
);

1280 
cs
->
	`wrôe_d©a
(cs->
›aque
, 
buf
, 
ªad_size
);

1281 
	`‰ì
(
buf
);

1282 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 0);

1285 
	}
}

1287 
BOOL
 
	$vútio_c⁄sﬁe_ˇn_wrôe_d©a
(
VIRTIODevi˚
 *
s
)

1289 
QueueSèã
 *
qs
 = &
s
->
queue
[0];

1290 
uöt16_t
 
avaû_idx
;

1292 i‡(!
qs
->
ªady
)

1293  
FALSE
;

1294 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

1295  
qs
->
œ°_avaû_idx
 !
avaû_idx
;

1296 
	}
}

1298 
	$vútio_c⁄sﬁe_gë_wrôe_Àn
(
VIRTIODevi˚
 *
s
)

1300 
queue_idx
 = 0;

1301 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

1302 
desc_idx
;

1303 
ªad_size
, 
wrôe_size
;

1304 
uöt16_t
 
avaû_idx
;

1306 i‡(!
qs
->
ªady
)

1308 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

1309 i‡(
qs
->
œ°_avaû_idx
 =
avaû_idx
)

1311 
desc_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 4 +

1312 (
qs
->
œ°_avaû_idx
 & (qs->
num
 - 1)) * 2);

1313 i‡(
	`gë_desc_rw_size
(
s
, &
ªad_size
, &
wrôe_size
, 
queue_idx
, 
desc_idx
))

1315  
wrôe_size
;

1316 
	}
}

1318 
	$vútio_c⁄sﬁe_wrôe_d©a
(
VIRTIODevi˚
 *
s
, c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
)

1320 
queue_idx
 = 0;

1321 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

1322 
desc_idx
;

1323 
uöt16_t
 
avaû_idx
;

1325 i‡(!
qs
->
ªady
)

1327 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

1328 i‡(
qs
->
œ°_avaû_idx
 =
avaû_idx
)

1330 
desc_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 4 +

1331 (
qs
->
œ°_avaû_idx
 & (qs->
num
 - 1)) * 2);

1332 
	`mem˝y_to_queue
(
s
, 
queue_idx
, 
desc_idx
, 0, 
buf
, 
buf_Àn
);

1333 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 
buf_Àn
);

1334 
qs
->
œ°_avaû_idx
++;

1335  
buf_Àn
;

1336 
	}
}

1339 
	$vútio_c⁄sﬁe_ªsize_evít
(
VIRTIODevi˚
 *
s
, 
width
, 
height
)

1342 
	`put_À16
(
s
->
c⁄fig_•a˚
 + 0, 
width
);

1343 
	`put_À16
(
s
->
c⁄fig_•a˚
 + 2, 
height
);

1345 
	`vútio_c⁄fig_ch™ge_nŸify
(
s
);

1346 
	}
}

1348 
VIRTIODevi˚
 *
	$vútio_c⁄sﬁe_öô
(
VIRTIOBusDef
 *
bus
, 
Ch¨a˘îDevi˚
 *
cs
)

1350 
VIRTIOC⁄sﬁeDevi˚
 *
s
;

1352 
s
 = 
	`mÆlocz
((*s));

1353 
	`vútio_öô
(&
s
->
comm⁄
, 
bus
,

1354 3, 4, 
vútio_c⁄sﬁe_ªcv_ªque°
);

1355 
s
->
comm⁄
.
devi˚_„©uªs
 = (1 << 0);

1356 
s
->
comm⁄
.
queue
[0].
m™uÆ_ªcv
 = 
TRUE
;

1358 
s
->
cs
 = cs;

1359  (
VIRTIODevi˚
 *)
s
;

1360 
	}
}

1366 
	mVIRTIO_INPUT_CFG_UNSET
 = 0x00,

1367 
	mVIRTIO_INPUT_CFG_ID_NAME
 = 0x01,

1368 
	mVIRTIO_INPUT_CFG_ID_SERIAL
 = 0x02,

1369 
	mVIRTIO_INPUT_CFG_ID_DEVIDS
 = 0x03,

1370 
	mVIRTIO_INPUT_CFG_PROP_BITS
 = 0x10,

1371 
	mVIRTIO_INPUT_CFG_EV_BITS
 = 0x11,

1372 
	mVIRTIO_INPUT_CFG_ABS_INFO
 = 0x12,

1375 
	#VIRTIO_INPUT_EV_SYN
 0x00

	)

1376 
	#VIRTIO_INPUT_EV_KEY
 0x01

	)

1377 
	#VIRTIO_INPUT_EV_REL
 0x02

	)

1378 
	#VIRTIO_INPUT_EV_ABS
 0x03

	)

1379 
	#VIRTIO_INPUT_EV_REP
 0x14

	)

1381 
	#BTN_LEFT
 0x110

	)

1382 
	#BTN_RIGHT
 0x111

	)

1383 
	#BTN_MIDDLE
 0x112

	)

1384 
	#BTN_GEAR_DOWN
 0x150

	)

1385 
	#BTN_GEAR_UP
 0x151

	)

1387 
	#REL_X
 0x00

	)

1388 
	#REL_Y
 0x01

	)

1389 
	#REL_Z
 0x02

	)

1390 
	#REL_WHEEL
 0x08

	)

1392 
	#ABS_X
 0x00

	)

1393 
	#ABS_Y
 0x01

	)

1394 
	#ABS_Z
 0x02

	)

1396 
	sVIRTIOI≈utDevi˚
 {

1397 
VIRTIODevi˚
 
	mcomm⁄
;

1398 
VútioI≈utTy≥Enum
 
	mty≥
;

1399 
uöt32_t
 
	mbuâ⁄s_°©e
;

1400 } 
	tVIRTIOI≈utDevi˚
;

1402 c⁄° 
uöt16_t
 
	gbuâ⁄s_li°
[] = {

1403 
BTN_LEFT
, 
BTN_RIGHT
, 
BTN_MIDDLE


1406 
	$vútio_öput_ªcv_ªque°
(
VIRTIODevi˚
 *
s
, 
queue_idx
,

1407 
desc_idx
, 
ªad_size
,

1408 
wrôe_size
)

1410 i‡(
queue_idx
 == 1) {

1413 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 0);

1416 
	}
}

1419 
	$vútio_öput_queue_evít
(
VIRTIODevi˚
 *
s
,

1420 
uöt16_t
 
ty≥
, uöt16_à
code
,

1421 
uöt32_t
 
vÆue
)

1423 
queue_idx
 = 0;

1424 
QueueSèã
 *
qs
 = &
s
->
queue
[
queue_idx
];

1425 
desc_idx
, 
buf_Àn
;

1426 
uöt16_t
 
avaû_idx
;

1427 
uöt8_t
 
buf
[8];

1429 i‡(!
qs
->
ªady
)

1432 
	`put_À16
(
buf
, 
ty≥
);

1433 
	`put_À16
(
buf
 + 2, 
code
);

1434 
	`put_À32
(
buf
 + 4, 
vÆue
);

1435 
buf_Àn
 = 8;

1437 
avaû_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 2);

1438 i‡(
qs
->
œ°_avaû_idx
 =
avaû_idx
)

1440 
desc_idx
 = 
	`vútio_ªad16
(
s
, 
qs
->
avaû_addr
 + 4 +

1441 (
qs
->
œ°_avaû_idx
 & (qs->
num
 - 1)) * 2);

1443 
	`mem˝y_to_queue
(
s
, 
queue_idx
, 
desc_idx
, 0, 
buf
, 
buf_Àn
);

1444 
	`vútio_c⁄sume_desc
(
s
, 
queue_idx
, 
desc_idx
, 
buf_Àn
);

1445 
qs
->
œ°_avaû_idx
++;

1447 
	}
}

1449 
	$vútio_öput_£nd_key_evít
(
VIRTIODevi˚
 *
s
, 
BOOL
 
is_down
,

1450 
uöt16_t
 
key_code
)

1452 
VIRTIOI≈utDevi˚
 *
s1
 = (VIRTIOI≈utDevi˚ *)
s
;

1453 
ªt
;

1455 i‡(
s1
->
ty≥
 !
VIRTIO_INPUT_TYPE_KEYBOARD
)

1457 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_KEY
, 
key_code
, 
is_down
);

1458 i‡(
ªt
)

1459  
ªt
;

1460  
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_SYN
, 0, 0);

1461 
	}
}

1464 
	$vútio_öput_£nd_mou£_evít
(
VIRTIODevi˚
 *
s
, 
dx
, 
dy
, 
dz
,

1465 
buâ⁄s
)

1467 
VIRTIOI≈utDevi˚
 *
s1
 = (VIRTIOI≈utDevi˚ *)
s
;

1468 
ªt
, 
i
, 
b
, 
œ°_b
;

1470 i‡(
s1
->
ty≥
 !
VIRTIO_INPUT_TYPE_MOUSE
 &&

1471 
s1
->
ty≥
 !
VIRTIO_INPUT_TYPE_TABLET
)

1473 i‡(
s1
->
ty≥
 =
VIRTIO_INPUT_TYPE_MOUSE
) {

1474 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_REL
, 
REL_X
, 
dx
);

1475 i‡(
ªt
 != 0)

1476  
ªt
;

1477 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_REL
, 
REL_Y
, 
dy
);

1478 i‡(
ªt
 != 0)

1479  
ªt
;

1481 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_ABS
, 
ABS_X
, 
dx
);

1482 i‡(
ªt
 != 0)

1483  
ªt
;

1484 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_ABS
, 
ABS_Y
, 
dy
);

1485 i‡(
ªt
 != 0)

1486  
ªt
;

1488 i‡(
dz
 != 0) {

1489 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_REL
, 
REL_WHEEL
, 
dz
);

1490 i‡(
ªt
 != 0)

1491  
ªt
;

1494 i‡(
buâ⁄s
 !
s1
->
buâ⁄s_°©e
) {

1495 
i
 = 0; i < 
	`cou¡of
(
buâ⁄s_li°
); i++) {

1496 
b
 = (
buâ⁄s
 >> 
i
) & 1;

1497 
œ°_b
 = (
s1
->
buâ⁄s_°©e
 >> 
i
) & 1;

1498 i‡(
b
 !
œ°_b
) {

1499 
ªt
 = 
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_KEY
,

1500 
buâ⁄s_li°
[
i
], 
b
);

1501 i‡(
ªt
 != 0)

1502  
ªt
;

1505 
s1
->
buâ⁄s_°©e
 = 
buâ⁄s
;

1508  
	`vútio_öput_queue_evít
(
s
, 
VIRTIO_INPUT_EV_SYN
, 0, 0);

1509 
	}
}

1511 
	$£t_bô
(
uöt8_t
 *
èb
, 
k
)

1513 
èb
[
k
 >> 3] |= 1 << (k & 7);

1514 
	}
}

1516 
	$vútio_öput_c⁄fig_wrôe
(
VIRTIODevi˚
 *
s
)

1518 
VIRTIOI≈utDevi˚
 *
s1
 = (VIRTIOI≈utDevi˚ *)
s
;

1519 
uöt8_t
 *
c⁄fig
 = 
s
->
c⁄fig_•a˚
;

1520 
i
;

1523 
c⁄fig
[0]) {

1524 
VIRTIO_INPUT_CFG_UNSET
:

1526 
VIRTIO_INPUT_CFG_ID_NAME
:

1528 c⁄° *
«me
;

1529 
Àn
;

1530 
s1
->
ty≥
) {

1531 
VIRTIO_INPUT_TYPE_KEYBOARD
:

1532 
«me
 = "virtio_keyboard";

1534 
VIRTIO_INPUT_TYPE_MOUSE
:

1535 
«me
 = "virtio_mouse";

1537 
VIRTIO_INPUT_TYPE_TABLET
:

1538 
«me
 = "virtio_tablet";

1541 
	`ab‹t
();

1543 
Àn
 = 
	`°æí
(
«me
);

1544 
c⁄fig
[2] = 
Àn
;

1545 
	`mem˝y
(
c⁄fig
 + 8, 
«me
, 
Àn
);

1549 
VIRTIO_INPUT_CFG_ID_SERIAL
:

1550 
VIRTIO_INPUT_CFG_ID_DEVIDS
:

1551 
VIRTIO_INPUT_CFG_PROP_BITS
:

1552 
c⁄fig
[2] = 0;

1554 
VIRTIO_INPUT_CFG_EV_BITS
:

1555 
c⁄fig
[2] = 0;

1556 
s1
->
ty≥
) {

1557 
VIRTIO_INPUT_TYPE_KEYBOARD
:

1558 
c⁄fig
[1]) {

1559 
VIRTIO_INPUT_EV_KEY
:

1560 
c⁄fig
[2] = 128 / 8;

1561 
	`mem£t
(
c⁄fig
 + 8, 0xff, 128 / 8);

1563 
VIRTIO_INPUT_EV_REP
:

1564 
c⁄fig
[2] = 1;

1570 
VIRTIO_INPUT_TYPE_MOUSE
:

1571 
c⁄fig
[1]) {

1572 
VIRTIO_INPUT_EV_KEY
:

1573 
c⁄fig
[2] = 512 / 8;

1574 
	`mem£t
(
c⁄fig
 + 8, 0, 512 / 8);

1575 
i
 = 0; i < 
	`cou¡of
(
buâ⁄s_li°
); i++)

1576 
	`£t_bô
(
c⁄fig
 + 8, 
buâ⁄s_li°
[
i
]);

1578 
VIRTIO_INPUT_EV_REL
:

1579 
c⁄fig
[2] = 2;

1580 
c⁄fig
[8] = 0;

1581 
c⁄fig
[9] = 0;

1582 
	`£t_bô
(
c⁄fig
 + 8, 
REL_X
);

1583 
	`£t_bô
(
c⁄fig
 + 8, 
REL_Y
);

1584 
	`£t_bô
(
c⁄fig
 + 8, 
REL_WHEEL
);

1590 
VIRTIO_INPUT_TYPE_TABLET
:

1591 
c⁄fig
[1]) {

1592 
VIRTIO_INPUT_EV_KEY
:

1593 
c⁄fig
[2] = 512 / 8;

1594 
	`mem£t
(
c⁄fig
 + 8, 0, 512 / 8);

1595 
i
 = 0; i < 
	`cou¡of
(
buâ⁄s_li°
); i++)

1596 
	`£t_bô
(
c⁄fig
 + 8, 
buâ⁄s_li°
[
i
]);

1598 
VIRTIO_INPUT_EV_REL
:

1599 
c⁄fig
[2] = 2;

1600 
c⁄fig
[8] = 0;

1601 
c⁄fig
[9] = 0;

1602 
	`£t_bô
(
c⁄fig
 + 8, 
REL_WHEEL
);

1604 
VIRTIO_INPUT_EV_ABS
:

1605 
c⁄fig
[2] = 1;

1606 
c⁄fig
[8] = 0;

1607 
	`£t_bô
(
c⁄fig
 + 8, 
ABS_X
);

1608 
	`£t_bô
(
c⁄fig
 + 8, 
ABS_Y
);

1615 
	`ab‹t
();

1618 
VIRTIO_INPUT_CFG_ABS_INFO
:

1619 i‡(
s1
->
ty≥
 =
VIRTIO_INPUT_TYPE_TABLET
 && 
c⁄fig
[1] <= 1) {

1621 
c⁄fig
[2] = 5 * 4;

1622 
	`put_À32
(
c⁄fig
 + 8, 0);

1623 
	`put_À32
(
c⁄fig
 + 12, 
VIRTIO_INPUT_ABS_SCALE
 - 1) ;

1624 
	`put_À32
(
c⁄fig
 + 16, 0);

1625 
	`put_À32
(
c⁄fig
 + 20, 0);

1626 
	`put_À32
(
c⁄fig
 + 24, 0);

1630 
	}
}

1632 
VIRTIODevi˚
 *
	$vútio_öput_öô
(
VIRTIOBusDef
 *
bus
, 
VútioI≈utTy≥Enum
 
ty≥
)

1634 
VIRTIOI≈utDevi˚
 *
s
;

1636 
s
 = 
	`mÆlocz
((*s));

1637 
	`vútio_öô
(&
s
->
comm⁄
, 
bus
,

1638 18, 256, 
vútio_öput_ªcv_ªque°
);

1639 
s
->
comm⁄
.
queue
[0].
m™uÆ_ªcv
 = 
TRUE
;

1640 
s
->
comm⁄
.
devi˚_„©uªs
 = 0;

1641 
s
->
comm⁄
.
c⁄fig_wrôe
 = 
vútio_öput_c⁄fig_wrôe
;

1642 
s
->
ty≥
 =Åype;

1643  (
VIRTIODevi˚
 *)
s
;

1644 
	}
}

1650 
li°_hód
 
	mlök
;

1651 
uöt32_t
 
	mfid
;

1652 
FSFûe
 *
	mfd
;

1653 } 
	tFIDDesc
;

1655 
	sVIRTIO9PDevi˚
 {

1656 
VIRTIODevi˚
 
	mcomm⁄
;

1657 
FSDevi˚
 *
	mfs
;

1658 
	mmsize
;

1659 
li°_hód
 
	mfid_li°
;

1660 
BOOL
 
	mªq_ö_¥ogªss
;

1661 } 
	tVIRTIO9PDevi˚
;

1663 
FIDDesc
 *
	$fid_föd1
(
VIRTIO9PDevi˚
 *
s
, 
uöt32_t
 
fid
)

1665 
li°_hód
 *
ñ
;

1666 
FIDDesc
 *
f
;

1668 
	`li°_f‹_óch
(
ñ
, &
s
->
fid_li°
) {

1669 
f
 = 
	`li°_íåy
(
ñ
, 
FIDDesc
, 
lök
);

1670 i‡(
f
->
fid
 == fid)

1671  
f
;

1673  
NULL
;

1674 
	}
}

1676 
FSFûe
 *
	$fid_föd
(
VIRTIO9PDevi˚
 *
s
, 
uöt32_t
 
fid
)

1678 
FIDDesc
 *
f
;

1680 
f
 = 
	`fid_föd1
(
s
, 
fid
);

1681 i‡(!
f
)

1682  
NULL
;

1683  
f
->
fd
;

1684 
	}
}

1686 
	$fid_dñëe
(
VIRTIO9PDevi˚
 *
s
, 
uöt32_t
 
fid
)

1688 
FIDDesc
 *
f
;

1690 
f
 = 
	`fid_föd1
(
s
, 
fid
);

1691 i‡(
f
) {

1692 
s
->
fs
->
	`fs_dñëe
(s->fs, 
f
->
fd
);

1693 
	`li°_dñ
(&
f
->
lök
);

1694 
	`‰ì
(
f
);

1696 
	}
}

1698 
	$fid_£t
(
VIRTIO9PDevi˚
 *
s
, 
uöt32_t
 
fid
, 
FSFûe
 *
fd
)

1700 
FIDDesc
 *
f
;

1702 
f
 = 
	`fid_föd1
(
s
, 
fid
);

1703 i‡(
f
) {

1704 
s
->
fs
->
	`fs_dñëe
(s->fs, 
f
->
fd
);

1705 
f
->
fd
 = fd;

1707 
f
 = 
	`mÆloc
((*f));

1708 
f
->
fid
 = fid;

1709 
f
->
fd
 = fd;

1710 
	`li°_add
(&
f
->
lök
, &
s
->
fid_li°
);

1712 
	}
}

1714 #ifde‡
DEBUG_VIRTIO


1717 
uöt8_t
 
	mèg
;

1718 c⁄° *
	m«me
;

1719 } 
	tVútio9POPName
;

1721 c⁄° 
Vútio9POPName
 
	gvútio_9p_›_«mes
[] = {

1746 { 0, 
NULL
 },

1749 c⁄° *
	$gë_9p_›_«me
(
èg
)

1751 c⁄° 
Vútio9POPName
 *
p
;

1752 
p
 = 
vútio_9p_›_«mes
;Ö->
«me
 !
NULL
;Ö++) {

1753 i‡(
p
->
èg
 ==Åag)

1754  
p
->
«me
;

1756  
NULL
;

1757 
	}
}

1761 
	$m¨shÆl
(
VIRTIO9PDevi˚
 *
s
,

1762 
uöt8_t
 *
buf1
, 
max_Àn
, c⁄° *
fmt
, ...)

1764 
va_li°
 
≠
;

1765 
c
;

1766 
uöt32_t
 
vÆ
;

1767 
uöt64_t
 
vÆ64
;

1768 
uöt8_t
 *
buf
, *
buf_íd
;

1770 #ifde‡
DEBUG_VIRTIO


1771 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1772 
	`¥ötf
(" ->");

1774 
	`va_°¨t
(
≠
, 
fmt
);

1775 
buf
 = 
buf1
;

1776 
buf_íd
 = 
buf1
 + 
max_Àn
;

1778 
c
 = *
fmt
++;

1779 i‡(
c
 == '\0')

1781 
c
) {

1783 
	`as£π
(
buf
 + 1 <
buf_íd
);

1784 
vÆ
 = 
	`va_¨g
(
≠
, );

1785 #ifde‡
DEBUG_VIRTIO


1786 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1787 
	`¥ötf
(" b=%d", 
vÆ
);

1789 
buf
[0] = 
vÆ
;

1790 
buf
 += 1;

1793 
	`as£π
(
buf
 + 2 <
buf_íd
);

1794 
vÆ
 = 
	`va_¨g
(
≠
, );

1795 #ifde‡
DEBUG_VIRTIO


1796 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1797 
	`¥ötf
(" h=%d", 
vÆ
);

1799 
	`put_À16
(
buf
, 
vÆ
);

1800 
buf
 += 2;

1803 
	`as£π
(
buf
 + 4 <
buf_íd
);

1804 
vÆ
 = 
	`va_¨g
(
≠
, );

1805 #ifde‡
DEBUG_VIRTIO


1806 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1807 
	`¥ötf
(" w=%d", 
vÆ
);

1809 
	`put_À32
(
buf
, 
vÆ
);

1810 
buf
 += 4;

1813 
	`as£π
(
buf
 + 8 <
buf_íd
);

1814 
vÆ64
 = 
	`va_¨g
(
≠
, 
uöt64_t
);

1815 #ifde‡
DEBUG_VIRTIO


1816 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1817 
	`¥ötf
(" d=%" 
PRId64
, 
vÆ64
);

1819 
	`put_À64
(
buf
, 
vÆ64
);

1820 
buf
 += 8;

1824 *
°r
;

1825 
Àn
;

1826 
°r
 = 
	`va_¨g
(
≠
, *);

1827 #ifde‡
DEBUG_VIRTIO


1828 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1829 
	`¥ötf
(" s=\"%s\"", 
°r
);

1831 
Àn
 = 
	`°æí
(
°r
);

1832 
	`as£π
(
Àn
 <= 65535);

1833 
	`as£π
(
buf
 + 2 + 
Àn
 <
buf_íd
);

1834 
	`put_À16
(
buf
, 
Àn
);

1835 
buf
 += 2;

1836 
	`mem˝y
(
buf
, 
°r
, 
Àn
);

1837 
buf
 +
Àn
;

1842 
FSQID
 *
qid
;

1843 
	`as£π
(
buf
 + 13 <
buf_íd
);

1844 
qid
 = 
	`va_¨g
(
≠
, 
FSQID
 *);

1845 #ifde‡
DEBUG_VIRTIO


1846 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1847 
	`¥ötf
(" Q=%d:%d:%" 
PRIu64
, 
qid
->
ty≥
, qid->
vîsi⁄
, qid->
∑th
);

1849 
buf
[0] = 
qid
->
ty≥
;

1850 
	`put_À32
(
buf
 + 1, 
qid
->
vîsi⁄
);

1851 
	`put_À64
(
buf
 + 5, 
qid
->
∑th
);

1852 
buf
 += 13;

1856 
	`ab‹t
();

1859 
	`va_íd
(
≠
);

1860  
buf
 - 
buf1
;

1861 
	}
}

1865 
	$unm¨shÆl
(
VIRTIO9PDevi˚
 *
s
, 
queue_idx
,

1866 
desc_idx
, *
poff£t
, c⁄° *
fmt
, ...)

1868 
VIRTIODevi˚
 *
s1
 = (VIRTIODevi˚ *)
s
;

1869 
va_li°
 
≠
;

1870 
off£t
, 
c
;

1871 
uöt8_t
 
buf
[16];

1873 
off£t
 = *
poff£t
;

1874 
	`va_°¨t
(
≠
, 
fmt
);

1876 
c
 = *
fmt
++;

1877 i‡(
c
 == '\0')

1879 
c
) {

1882 
uöt8_t
 *
±r
;

1883 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 1))

1885 
±r
 = 
	`va_¨g
(
≠
, 
uöt8_t
 *);

1886 *
±r
 = 
buf
[0];

1887 
off£t
 += 1;

1888 #ifde‡
DEBUG_VIRTIO


1889 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1890 
	`¥ötf
(" b=%d", *
±r
);

1896 
uöt16_t
 *
±r
;

1897 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 2))

1899 
±r
 = 
	`va_¨g
(
≠
, 
uöt16_t
 *);

1900 *
±r
 = 
	`gë_À16
(
buf
);

1901 
off£t
 += 2;

1902 #ifde‡
DEBUG_VIRTIO


1903 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1904 
	`¥ötf
(" h=%d", *
±r
);

1910 
uöt32_t
 *
±r
;

1911 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 4))

1913 
±r
 = 
	`va_¨g
(
≠
, 
uöt32_t
 *);

1914 *
±r
 = 
	`gë_À32
(
buf
);

1915 
off£t
 += 4;

1916 #ifde‡
DEBUG_VIRTIO


1917 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1918 
	`¥ötf
(" w=%d", *
±r
);

1924 
uöt64_t
 *
±r
;

1925 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 8))

1927 
±r
 = 
	`va_¨g
(
≠
, 
uöt64_t
 *);

1928 *
±r
 = 
	`gë_À64
(
buf
);

1929 
off£t
 += 8;

1930 #ifde‡
DEBUG_VIRTIO


1931 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1932 
	`¥ötf
(" d=%" 
PRId64
, *
±r
);

1938 *
°r
, **
±r
;

1939 
Àn
;

1941 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 2))

1943 
Àn
 = 
	`gë_À16
(
buf
);

1944 
off£t
 += 2;

1945 
°r
 = 
	`mÆloc
(
Àn
 + 1);

1946 i‡(
	`mem˝y_‰om_queue
(
s1
, 
°r
, 
queue_idx
, 
desc_idx
, 
off£t
, 
Àn
))

1948 
°r
[
Àn
] = '\0';

1949 
off£t
 +
Àn
;

1950 
±r
 = 
	`va_¨g
(
≠
, **);

1951 *
±r
 = 
°r
;

1952 #ifde‡
DEBUG_VIRTIO


1953 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
)

1954 
	`¥ötf
(" s=\"%s\"", *
±r
);

1959 
	`ab‹t
();

1962 
	`va_íd
(
≠
);

1963 *
poff£t
 = 
off£t
;

1965 
	}
}

1967 
	$vútio_9p_£nd_ª∂y
(
VIRTIO9PDevi˚
 *
s
, 
queue_idx
,

1968 
desc_idx
, 
uöt8_t
 
id
, 
uöt16_t
 
èg
,

1969 
uöt8_t
 *
buf
, 
buf_Àn
)

1971 
uöt8_t
 *
buf1
;

1972 
Àn
;

1974 #ifde‡
DEBUG_VIRTIO


1975 i‡(
s
->
comm⁄
.
debug
 & 
VIRTIO_DEBUG_9P
) {

1976 i‡(
id
 == 6)

1977 
	`¥ötf
(" (error)");

1978 
	`¥ötf
("\n");

1981 
Àn
 = 
buf_Àn
 + 7;

1982 
buf1
 = 
	`mÆloc
(
Àn
);

1983 
	`put_À32
(
buf1
, 
Àn
);

1984 
buf1
[4] = 
id
 + 1;

1985 
	`put_À16
(
buf1
 + 5, 
èg
);

1986 
	`mem˝y
(
buf1
 + 7, 
buf
, 
buf_Àn
);

1987 
	`mem˝y_to_queue
((
VIRTIODevi˚
 *)
s
, 
queue_idx
, 
desc_idx
, 0, 
buf1
, 
Àn
);

1988 
	`vútio_c⁄sume_desc
((
VIRTIODevi˚
 *)
s
, 
queue_idx
, 
desc_idx
, 
Àn
);

1989 
	`‰ì
(
buf1
);

1990 
	}
}

1992 
	$vútio_9p_£nd_îr‹
(
VIRTIO9PDevi˚
 *
s
, 
queue_idx
,

1993 
desc_idx
, 
uöt16_t
 
èg
, 
uöt32_t
 
îr‹
)

1995 
uöt8_t
 
buf
[4];

1996 
buf_Àn
;

1998 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "w", -
îr‹
);

1999 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 6, 
èg
, 
buf
, 
buf_Àn
);

2000 
	}
}

2003 
VIRTIO9PDevi˚
 *
	mdev
;

2004 
	mqueue_idx
;

2005 
	mdesc_idx
;

2006 
uöt16_t
 
	mèg
;

2007 } 
	tP9O≥nInfo
;

2009 
	$vútio_9p_›í_ª∂y
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
îr
,

2010 
P9O≥nInfo
 *
oi
)

2012 
VIRTIO9PDevi˚
 *
s
 = 
oi
->
dev
;

2013 
uöt8_t
 
buf
[32];

2014 
buf_Àn
;

2016 i‡(
îr
 < 0) {

2017 
	`vútio_9p_£nd_îr‹
(
s
, 
oi
->
queue_idx
, oi->
desc_idx
, oi->
èg
, 
îr
);

2019 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf),

2020 "Qw", 
qid
, 
s
->
msize
 - 24);

2021 
	`vútio_9p_£nd_ª∂y
(
s
, 
oi
->
queue_idx
, oi->
desc_idx
, 12, oi->
èg
,

2022 
buf
, 
buf_Àn
);

2024 
	`‰ì
(
oi
);

2025 
	}
}

2027 
	$vútio_9p_›í_cb
(
FSDevi˚
 *
fs
, 
FSQID
 *
qid
, 
îr
,

2028 *
›aque
)

2030 
P9O≥nInfo
 *
oi
 = 
›aque
;

2031 
VIRTIO9PDevi˚
 *
s
 = 
oi
->
dev
;

2032 
queue_idx
 = 
oi
->queue_idx;

2034 
	`vútio_9p_›í_ª∂y
(
fs
, 
qid
, 
îr
, 
oi
);

2036 
s
->
ªq_ö_¥ogªss
 = 
FALSE
;

2039 
	`queue_nŸify
((
VIRTIODevi˚
 *)
s
, 
queue_idx
);

2040 
	}
}

2042 
	$vútio_9p_ªcv_ªque°
(
VIRTIODevi˚
 *
s1
, 
queue_idx
,

2043 
desc_idx
, 
ªad_size
,

2044 
wrôe_size
)

2046 
VIRTIO9PDevi˚
 *
s
 = (VIRTIO9PDevi˚ *)
s1
;

2047 
off£t
, 
hódî_Àn
;

2048 
uöt8_t
 
id
;

2049 
uöt16_t
 
èg
;

2050 
uöt8_t
 
buf
[1024];

2051 
buf_Àn
, 
îr
;

2052 
FSDevi˚
 *
fs
 = 
s
->fs;

2054 i‡(
queue_idx
 != 0)

2057 i‡(
s
->
ªq_ö_¥ogªss
)

2060 
off£t
 = 0;

2061 
hódî_Àn
 = 4 + 1 + 2;

2062 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf
, 
queue_idx
, 
desc_idx
, 
off£t
, 
hódî_Àn
)) {

2063 
èg
 = 0;

2064 
¥Ÿocﬁ_îr‹
;

2067 
id
 = 
buf
[4];

2068 
èg
 = 
	`gë_À16
(
buf
 + 5);

2069 
off£t
 +
hódî_Àn
;

2071 #ifde‡
DEBUG_VIRTIO


2072 i‡(
s1
->
debug
 & 
VIRTIO_DEBUG_9P
) {

2073 c⁄° *
«me
;

2074 
«me
 = 
	`gë_9p_›_«me
(
id
);

2075 
	`¥ötf
("9p: op=");

2076 i‡(
«me
)

2077 
	`¥ötf
("%s", 
«me
);

2079 
	`¥ötf
("%d", 
id
);

2083 
id
) {

2086 
FSSètFS
 
°
;

2088 
fs
->
	`fs_°©fs
(fs, &
°
);

2089 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf),

2092 
°
.
f_bsize
,

2093 
°
.
f_blocks
,

2094 
°
.
f_b‰ì
,

2095 
°
.
f_bavaû
,

2096 
°
.
f_fûes
,

2097 
°
.
f_f‰ì
,

2101 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2106 
uöt32_t
 
fid
, 
Êags
;

2107 
FSFûe
 *
f
;

2108 
FSQID
 
qid
;

2109 
P9O≥nInfo
 *
oi
;

2111 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2112 "ww", &
fid
, &
Êags
))

2113 
¥Ÿocﬁ_îr‹
;

2114 
f
 = 
	`fid_föd
(
s
, 
fid
);

2115 i‡(!
f
)

2116 
fid_nŸ_found
;

2117 
oi
 = 
	`mÆloc
((*oi));

2118 
oi
->
dev
 = 
s
;

2119 
oi
->
queue_idx
 = queue_idx;

2120 
oi
->
desc_idx
 = desc_idx;

2121 
oi
->
èg
 =Åag;

2122 
îr
 = 
fs
->
	`fs_›í
(fs, &
qid
, 
f
, 
Êags
, 
vútio_9p_›í_cb
, 
oi
);

2123 i‡(
îr
 <= 0) {

2124 
	`vútio_9p_›í_ª∂y
(
fs
, &
qid
, 
îr
, 
oi
);

2126 
s
->
ªq_ö_¥ogªss
 = 
TRUE
;

2132 
uöt32_t
 
fid
, 
Êags
, 
mode
, 
gid
;

2133 *
«me
;

2134 
FSFûe
 *
f
;

2135 
FSQID
 
qid
;

2137 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2138 "wswww", &
fid
, &
«me
, &
Êags
, &
mode
, &
gid
))

2139 
¥Ÿocﬁ_îr‹
;

2140 
f
 = 
	`fid_föd
(
s
, 
fid
);

2141 i‡(!
f
) {

2142 
îr
 = -
P9_EPROTO
;

2144 
îr
 = 
fs
->
	`fs_¸óã
(fs, &
qid
, 
f
, 
«me
, 
Êags
, 
mode
, 
gid
);

2146 
	`‰ì
(
«me
);

2147 i‡(
îr
)

2148 
îr‹
;

2149 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf),

2150 "Qw", &
qid
, 
s
->
msize
 - 24);

2151 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2156 
uöt32_t
 
fid
, 
gid
;

2157 *
«me
, *
symgt
;

2158 
FSFûe
 *
f
;

2159 
FSQID
 
qid
;

2161 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2162 "wssw", &
fid
, &
«me
, &
symgt
, &
gid
))

2163 
¥Ÿocﬁ_îr‹
;

2164 
f
 = 
	`fid_föd
(
s
, 
fid
);

2165 i‡(!
f
) {

2166 
îr
 = -
P9_EPROTO
;

2168 
îr
 = 
fs
->
	`fs_symlök
(fs, &
qid
, 
f
, 
«me
, 
symgt
, 
gid
);

2170 
	`‰ì
(
«me
);

2171 
	`‰ì
(
symgt
);

2172 i‡(
îr
)

2173 
îr‹
;

2174 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf),

2175 "Q", &
qid
);

2176 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2181 
uöt32_t
 
fid
, 
mode
, 
maj‹
, 
mö‹
, 
gid
;

2182 *
«me
;

2183 
FSFûe
 *
f
;

2184 
FSQID
 
qid
;

2186 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2187 "wswwww", &
fid
, &
«me
, &
mode
, &
maj‹
, &
mö‹
, &
gid
))

2188 
¥Ÿocﬁ_îr‹
;

2189 
f
 = 
	`fid_föd
(
s
, 
fid
);

2190 i‡(!
f
) {

2191 
îr
 = -
P9_EPROTO
;

2193 
îr
 = 
fs
->
	`fs_mknod
(fs, &
qid
, 
f
, 
«me
, 
mode
, 
maj‹
, 
mö‹
, 
gid
);

2195 
	`‰ì
(
«me
);

2196 i‡(
îr
)

2197 
îr‹
;

2198 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf),

2199 "Q", &
qid
);

2200 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2205 
uöt32_t
 
fid
;

2206 
buf1
[1024];

2207 
FSFûe
 *
f
;

2209 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2210 "w", &
fid
))

2211 
¥Ÿocﬁ_îr‹
;

2212 
f
 = 
	`fid_föd
(
s
, 
fid
);

2213 i‡(!
f
) {

2214 
îr
 = -
P9_EPROTO
;

2216 
îr
 = 
fs
->
	`fs_ªadlök
(fs, 
buf1
, (buf1), 
f
);

2218 i‡(
îr
)

2219 
îr‹
;

2220 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "s", 
buf1
);

2221 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2226 
uöt32_t
 
fid
;

2227 
uöt64_t
 
mask
;

2228 
FSFûe
 *
f
;

2229 
FSSèt
 
°
;

2231 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2232 "wd", &
fid
, &
mask
))

2233 
¥Ÿocﬁ_îr‹
;

2234 
f
 = 
	`fid_föd
(
s
, 
fid
);

2235 i‡(!
f
)

2236 
fid_nŸ_found
;

2237 
îr
 = 
fs
->
	`fs_°©
(fs, 
f
, &
°
);

2238 i‡(
îr
)

2239 
îr‹
;

2241 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf),

2243 
mask
, &
°
.
qid
,

2244 
°
.
°_mode
, st.
°_uid
, st.
°_gid
,

2245 
°
.
°_∆ök
, st.
°_rdev
, st.
°_size
,

2246 
°
.
°_blksize
, st.
°_blocks
,

2247 
°
.
°_©ime_£c
, (
uöt64_t
)°.
°_©ime_n£c
,

2248 
°
.
°_mtime_£c
, (
uöt64_t
)°.
°_mtime_n£c
,

2249 
°
.
°_˘ime_£c
, (
uöt64_t
)°.
°_˘ime_n£c
,

2250 (
uöt64_t
)0, (uint64_t)0,

2251 (
uöt64_t
)0, (uint64_t)0);

2252 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2257 
uöt32_t
 
fid
, 
mask
, 
mode
, 
uid
, 
gid
;

2258 
uöt64_t
 
size
, 
©ime_£c
, 
©ime_n£c
, 
mtime_£c
, 
mtime_n£c
;

2259 
FSFûe
 *
f
;

2261 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2262 "wwwwwddddd", &
fid
, &
mask
, &
mode
, &
uid
, &
gid
,

2263 &
size
, &
©ime_£c
, &
©ime_n£c
,

2264 &
mtime_£c
, &
mtime_n£c
))

2265 
¥Ÿocﬁ_îr‹
;

2266 
f
 = 
	`fid_föd
(
s
, 
fid
);

2267 i‡(!
f
)

2268 
fid_nŸ_found
;

2269 
îr
 = 
fs
->
	`fs_£èâr
(fs, 
f
, 
mask
, 
mode
, 
uid
, 
gid
, 
size
, 
©ime_£c
,

2270 
©ime_n£c
, 
mtime_£c
, 
mtime_n£c
);

2271 i‡(
îr
)

2272 
îr‹
;

2273 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2279 
îr
 = -
P9_ENOTSUP
;

2280 
îr‹
;

2285 
uöt32_t
 
fid
, 
cou¡
;

2286 
uöt64_t
 
offs
;

2287 
uöt8_t
 *
buf
;

2288 
n
;

2289 
FSFûe
 *
f
;

2291 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2292 "wdw", &
fid
, &
offs
, &
cou¡
))

2293 
¥Ÿocﬁ_îr‹
;

2294 
f
 = 
	`fid_föd
(
s
, 
fid
);

2295 i‡(!
f
)

2296 
fid_nŸ_found
;

2297 
buf
 = 
	`mÆloc
(
cou¡
 + 4);

2298 
n
 = 
fs
->
	`fs_ªaddú
(fs, 
f
, 
offs
, 
buf
 + 4, 
cou¡
);

2299 i‡(
n
 < 0) {

2300 
îr
 = 
n
;

2301 
îr‹
;

2303 
	`put_À32
(
buf
, 
n
);

2304 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
n
 + 4);

2305 
	`‰ì
(
buf
);

2310 
uöt32_t
 
fid
;

2311 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2312 "w", &
fid
))

2313 
¥Ÿocﬁ_îr‹
;

2315 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2320 
uöt32_t
 
fid
;

2321 
FSFûe
 *
f
;

2322 
FSLock
 
lock
;

2324 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2325 "wbwddws", &
fid
, &
lock
.
ty≥
, &lock.
Êags
,

2326 &
lock
.
°¨t
, &lock.
Àngth
,

2327 &
lock
.
¥oc_id
, &lock.
˛õ¡_id
))

2328 
¥Ÿocﬁ_îr‹
;

2329 
f
 = 
	`fid_föd
(
s
, 
fid
);

2330 i‡(!
f
)

2331 
îr
 = -
P9_EPROTO
;

2333 
îr
 = 
fs
->
	`fs_lock
(fs, 
f
, &
lock
);

2334 
	`‰ì
(
lock
.
˛õ¡_id
);

2335 i‡(
îr
 < 0)

2336 
îr‹
;

2337 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "b", 
îr
);

2338 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2343 
uöt32_t
 
fid
;

2344 
FSFûe
 *
f
;

2345 
FSLock
 
lock
;

2347 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2348 "wbddws", &
fid
, &
lock
.
ty≥
,

2349 &
lock
.
°¨t
, &lock.
Àngth
,

2350 &
lock
.
¥oc_id
, &lock.
˛õ¡_id
))

2351 
¥Ÿocﬁ_îr‹
;

2352 
f
 = 
	`fid_föd
(
s
, 
fid
);

2353 i‡(!
f
)

2354 
îr
 = -
P9_EPROTO
;

2356 
îr
 = 
fs
->
	`fs_gëlock
(fs, 
f
, &
lock
);

2357 i‡(
îr
 < 0) {

2358 
	`‰ì
(
lock
.
˛õ¡_id
);

2359 
îr‹
;

2361 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "bddws",

2362 &
lock
.
ty≥
,

2363 &
lock
.
°¨t
, &lock.
Àngth
,

2364 &
lock
.
¥oc_id
, &lock.
˛õ¡_id
);

2365 
	`‰ì
(
lock
.
˛õ¡_id
);

2366 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2371 
uöt32_t
 
dfid
, 
fid
;

2372 *
«me
;

2373 
FSFûe
 *
f
, *
df
;

2375 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2376 "wws", &
dfid
, &
fid
, &
«me
))

2377 
¥Ÿocﬁ_îr‹
;

2378 
df
 = 
	`fid_föd
(
s
, 
dfid
);

2379 
f
 = 
	`fid_föd
(
s
, 
fid
);

2380 i‡(!
df
 || !
f
) {

2381 
îr
 = -
P9_EPROTO
;

2383 
îr
 = 
fs
->
	`fs_lök
(fs, 
df
, 
f
, 
«me
);

2385 
	`‰ì
(
«me
);

2386 i‡(
îr
)

2387 
îr‹
;

2388 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2393 
uöt32_t
 
fid
, 
mode
, 
gid
;

2394 *
«me
;

2395 
FSFûe
 *
f
;

2396 
FSQID
 
qid
;

2398 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2399 "wsww", &
fid
, &
«me
, &
mode
, &
gid
))

2400 
¥Ÿocﬁ_îr‹
;

2401 
f
 = 
	`fid_föd
(
s
, 
fid
);

2402 i‡(!
f
)

2403 
fid_nŸ_found
;

2404 
îr
 = 
fs
->
	`fs_mkdú
(fs, &
qid
, 
f
, 
«me
, 
mode
, 
gid
);

2405 i‡(
îr
 != 0)

2406 
îr‹
;

2407 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "Q", &
qid
);

2408 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2413 
uöt32_t
 
fid
, 
√w_fid
;

2414 *
«me
, *
√w_«me
;

2415 
FSFûe
 *
f
, *
√w_f
;

2417 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2418 "wsws", &
fid
, &
«me
, &
√w_fid
, &
√w_«me
))

2419 
¥Ÿocﬁ_îr‹
;

2420 
f
 = 
	`fid_föd
(
s
, 
fid
);

2421 
√w_f
 = 
	`fid_föd
(
s
, 
√w_fid
);

2422 i‡(!
f
 || !
√w_f
) {

2423 
îr
 = -
P9_EPROTO
;

2425 
îr
 = 
fs
->
	`fs_ª«mót
(fs, 
f
, 
«me
, 
√w_f
, 
√w_«me
);

2427 
	`‰ì
(
«me
);

2428 
	`‰ì
(
√w_«me
);

2429 i‡(
îr
 != 0)

2430 
îr‹
;

2431 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2436 
uöt32_t
 
fid
, 
Êags
;

2437 *
«me
;

2438 
FSFûe
 *
f
;

2440 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2441 "wsw", &
fid
, &
«me
, &
Êags
))

2442 
¥Ÿocﬁ_îr‹
;

2443 
f
 = 
	`fid_föd
(
s
, 
fid
);

2444 i‡(!
f
) {

2445 
îr
 = -
P9_EPROTO
;

2447 
îr
 = 
fs
->
	`fs_u∆ök©
(fs, 
f
, 
«me
);

2449 
	`‰ì
(
«me
);

2450 i‡(
îr
 != 0)

2451 
îr‹
;

2452 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2457 
uöt32_t
 
msize
;

2458 *
vîsi⁄
;

2459 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2460 "ws", &
msize
, &
vîsi⁄
))

2461 
¥Ÿocﬁ_îr‹
;

2462 
s
->
msize
 = msize;

2464 
	`‰ì
(
vîsi⁄
);

2465 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "ws", s->
msize
, "9P2000.L");

2466 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2471 
uöt32_t
 
fid
, 
afid
, 
uid
;

2472 *
u«me
, *
™ame
;

2473 
FSQID
 
qid
;

2474 
FSFûe
 *
f
;

2476 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2477 "wwssw", &
fid
, &
afid
, &
u«me
, &
™ame
, &
uid
))

2478 
¥Ÿocﬁ_îr‹
;

2479 
îr
 = 
fs
->
	`fs_©èch
(fs, &
f
, &
qid
, 
uid
, 
u«me
, 
™ame
);

2480 i‡(
îr
 != 0)

2481 
îr‹
;

2482 
	`fid_£t
(
s
, 
fid
, 
f
);

2483 
	`‰ì
(
u«me
);

2484 
	`‰ì
(
™ame
);

2485 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "Q", &
qid
);

2486 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2491 
uöt16_t
 
ﬁdèg
;

2492 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2493 "h", &
ﬁdèg
))

2494 
¥Ÿocﬁ_îr‹
;

2496 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2501 
uöt32_t
 
fid
, 
√wfid
;

2502 
uöt16_t
 
nw«me
;

2503 
FSQID
 *
qids
;

2504 **
«mes
;

2505 
FSFûe
 *
f
;

2506 
i
;

2508 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2509 "wwh", &
fid
, &
√wfid
, &
nw«me
))

2510 
¥Ÿocﬁ_îr‹
;

2511 
f
 = 
	`fid_föd
(
s
, 
fid
);

2512 i‡(!
f
)

2513 
fid_nŸ_found
;

2514 
«mes
 = 
	`mÆlocz
(“ames[0]Ë* 
nw«me
);

2515 
qids
 = 
	`mÆloc
((qids[0]Ë* 
nw«me
);

2516 
i
 = 0; i < 
nw«me
; i++) {

2517 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2518 "s", &
«mes
[
i
])) {

2519 
îr
 = -
P9_EPROTO
;

2520 
wÆk_d⁄e
;

2523 
îr
 = 
fs
->
	`fs_wÆk
(fs, &
f
, 
qids
, f, 
nw«me
, 
«mes
);

2524 
wÆk_d⁄e
:

2525 
i
 = 0; i < 
nw«me
; i++) {

2526 
	`‰ì
(
«mes
[
i
]);

2528 
	`‰ì
(
«mes
);

2529 i‡(
îr
 < 0) {

2530 
	`‰ì
(
qids
);

2531 
îr‹
;

2533 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "h", 
îr
);

2534 
i
 = 0; i < 
îr
; i++) {

2535 
buf_Àn
 +
	`m¨shÆl
(
s
, 
buf
 + buf_len, (buf) - buf_len,

2536 "Q", &
qids
[
i
]);

2538 
	`‰ì
(
qids
);

2539 
	`fid_£t
(
s
, 
√wfid
, 
f
);

2540 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2545 
uöt32_t
 
fid
, 
cou¡
;

2546 
uöt64_t
 
offs
;

2547 
uöt8_t
 *
buf
;

2548 
n
;

2549 
FSFûe
 *
f
;

2551 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2552 "wdw", &
fid
, &
offs
, &
cou¡
))

2553 
¥Ÿocﬁ_îr‹
;

2554 
f
 = 
	`fid_föd
(
s
, 
fid
);

2555 i‡(!
f
)

2556 
fid_nŸ_found
;

2557 
buf
 = 
	`mÆloc
(
cou¡
 + 4);

2558 
n
 = 
fs
->
	`fs_ªad
(fs, 
f
, 
offs
, 
buf
 + 4, 
cou¡
);

2559 i‡(
n
 < 0) {

2560 
îr
 = 
n
;

2561 
	`‰ì
(
buf
);

2562 
îr‹
;

2564 
	`put_À32
(
buf
, 
n
);

2565 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
n
 + 4);

2566 
	`‰ì
(
buf
);

2571 
uöt32_t
 
fid
, 
cou¡
;

2572 
uöt64_t
 
offs
;

2573 
uöt8_t
 *
buf1
;

2574 
n
;

2575 
FSFûe
 *
f
;

2577 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2578 "wdw", &
fid
, &
offs
, &
cou¡
))

2579 
¥Ÿocﬁ_îr‹
;

2580 
f
 = 
	`fid_föd
(
s
, 
fid
);

2581 i‡(!
f
)

2582 
fid_nŸ_found
;

2583 
buf1
 = 
	`mÆloc
(
cou¡
);

2584 i‡(
	`mem˝y_‰om_queue
(
s1
, 
buf1
, 
queue_idx
, 
desc_idx
, 
off£t
,

2585 
cou¡
)) {

2586 
	`‰ì
(
buf1
);

2587 
¥Ÿocﬁ_îr‹
;

2589 
n
 = 
fs
->
	`fs_wrôe
(fs, 
f
, 
offs
, 
buf1
, 
cou¡
);

2590 
	`‰ì
(
buf1
);

2591 i‡(
n
 < 0) {

2592 
îr
 = 
n
;

2593 
îr‹
;

2595 
buf_Àn
 = 
	`m¨shÆl
(
s
, 
buf
, (buf), "w", 
n
);

2596 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
buf
, 
buf_Àn
);

2601 
uöt32_t
 
fid
;

2603 i‡(
	`unm¨shÆl
(
s
, 
queue_idx
, 
desc_idx
, &
off£t
,

2604 "w", &
fid
))

2605 
¥Ÿocﬁ_îr‹
;

2606 
	`fid_dñëe
(
s
, 
fid
);

2607 
	`vútio_9p_£nd_ª∂y
(
s
, 
queue_idx
, 
desc_idx
, 
id
, 
èg
, 
NULL
, 0);

2611 
	`¥ötf
("9p: unsuµ‹ãd o≥øti⁄ id=%d\n", 
id
);

2612 
¥Ÿocﬁ_îr‹
;

2615 
îr‹
:

2616 
	`vútio_9p_£nd_îr‹
(
s
, 
queue_idx
, 
desc_idx
, 
èg
, 
îr
);

2618 
¥Ÿocﬁ_îr‹
:

2619 
fid_nŸ_found
:

2620 
îr
 = -
P9_EPROTO
;

2621 
îr‹
;

2622 
	}
}

2624 
VIRTIODevi˚
 *
	$vútio_9p_öô
(
VIRTIOBusDef
 *
bus
, 
FSDevi˚
 *
fs
,

2625 c⁄° *
mou¡_èg
)

2628 
VIRTIO9PDevi˚
 *
s
;

2629 
Àn
;

2630 
uöt8_t
 *
cfg
;

2632 
Àn
 = 
	`°æí
(
mou¡_èg
);

2633 
s
 = 
	`mÆlocz
((*s));

2634 
	`vútio_öô
(&
s
->
comm⁄
, 
bus
,

2635 9, 2 + 
Àn
, 
vútio_9p_ªcv_ªque°
);

2636 
s
->
comm⁄
.
devi˚_„©uªs
 = 1 << 0;

2639 
cfg
 = 
s
->
comm⁄
.
c⁄fig_•a˚
;

2640 
cfg
[0] = 
Àn
;

2641 
cfg
[1] = 
Àn
 >> 8;

2642 
	`mem˝y
(
cfg
 + 2, 
mou¡_èg
, 
Àn
);

2644 
s
->
fs
 = fs;

2645 
s
->
msize
 = 8192;

2646 
	`öô_li°_hód
(&
s
->
fid_li°
);

2648  (
VIRTIODevi˚
 *)
s
;

2649 
	}
}

	@virtio.h

24 #i‚de‡
VIRTIO_H


25 
	#VIRTIO_H


	)

27 
	~<sys/£À˘.h
>

29 
	~"iomem.h
"

30 
	~"pci.h
"

32 
	#VIRTIO_PAGE_SIZE
 4096

	)

34 #i‡
deföed
(
EMSCRIPTEN
)

35 
	#VIRTIO_ADDR_BITS
 32

	)

37 
	#VIRTIO_ADDR_BITS
 64

	)

40 #i‡
VIRTIO_ADDR_BITS
 == 64

41 
uöt64_t
 
	tvútio_phys_addr_t
;

43 
uöt32_t
 
	tvútio_phys_addr_t
;

48 
PCIBus
 *
	mpci_bus
;

50 
PhysMem‹yM≠
 *
	mmem_m≠
;

51 
uöt64_t
 
	maddr
;

52 
IRQSig«l
 *
	múq
;

53 } 
	tVIRTIOBusDef
;

55 
VIRTIODevi˚
 
	tVIRTIODevi˚
;

57 
	#VIRTIO_DEBUG_IO
 (1 << 0)

	)

58 
	#VIRTIO_DEBUG_9P
 (1 << 1)

	)

60 
vútio_£t_debug
(
VIRTIODevi˚
 *
s
, 
debug_Êags
);

64 
	tBlockDevi˚Com∂ëi⁄Func
(*
	t›aque
, 
	tªt
);

66 
BlockDevi˚
 
	tBlockDevi˚
;

68 
	sBlockDevi˚
 {

69 
öt64_t
 (*
gë_£˘‹_cou¡
)(
BlockDevi˚
 *
	mbs
);

70 (*
	mªad_async
)(
BlockDevi˚
 *
	mbs
,

71 
uöt64_t
 
	m£˘‹_num
, 
uöt8_t
 *
	mbuf
, 
	mn
,

72 
BlockDevi˚Com∂ëi⁄Func
 *
	mcb
, *
	m›aque
);

73 (*
	mwrôe_async
)(
BlockDevi˚
 *
	mbs
,

74 
uöt64_t
 
	m£˘‹_num
, c⁄° 
uöt8_t
 *
	mbuf
, 
	mn
,

75 
BlockDevi˚Com∂ëi⁄Func
 *
	mcb
, *
	m›aque
);

76 *
	m›aque
;

79 
VIRTIODevi˚
 *
vútio_block_öô
(
VIRTIOBusDef
 *
bus
, 
BlockDevi˚
 *
bs
);

83 
Ethî√tDevi˚
 
	tEthî√tDevi˚
;

85 
	sEthî√tDevi˚
 {

86 
uöt8_t
 
	mmac_addr
[6];

87 (*
	mwrôe_∑ckë
)(
Ethî√tDevi˚
 *
	m√t
,

88 c⁄° 
uöt8_t
 *
	mbuf
, 
	mÀn
);

89 *
	m›aque
;

90 #i‡!
deföed
(
EMSCRIPTEN
)

91 (*
	m£À˘_fûl
)(
Ethî√tDevi˚
 *
	m√t
, *
	mpfd_max
,

92 
fd_£t
 *
	mrfds
, fd_£à*
	mwfds
, fd_£à*
	mefds
,

93 *
	mpdñay
);

94 (*
	m£À˘_pﬁl
)(
Ethî√tDevi˚
 *
	m√t
,

95 
fd_£t
 *
	mrfds
, fd_£à*
	mwfds
, fd_£à*
	mefds
,

96 
	m£À˘_ªt
);

99 *
	mdevi˚_›aque
;

100 
BOOL
 (*
devi˚_ˇn_wrôe_∑ckë
)(
Ethî√tDevi˚
 *
	m√t
);

101 (*
	mdevi˚_wrôe_∑ckë
)(
Ethî√tDevi˚
 *
	m√t
,

102 c⁄° 
uöt8_t
 *
	mbuf
, 
	mÀn
);

103 (*
	mdevi˚_£t_ˇºõr
)(
Ethî√tDevi˚
 *
	m√t
, 
BOOL
 
	mˇºõr_°©e
);

106 
VIRTIODevi˚
 *
vútio_√t_öô
(
VIRTIOBusDef
 *
bus
, 
Ethî√tDevi˚
 *
es
);

111 *
	m›aque
;

112 (*
	mwrôe_d©a
)(*
	m›aque
, c⁄° 
uöt8_t
 *
	mbuf
, 
	mÀn
);

113 (*
	mªad_d©a
)(*
	m›aque
, 
uöt8_t
 *
	mbuf
, 
	mÀn
);

114 } 
	tCh¨a˘îDevi˚
;

116 
VIRTIODevi˚
 *
vútio_c⁄sﬁe_öô
(
VIRTIOBusDef
 *
bus
, 
Ch¨a˘îDevi˚
 *
cs
);

117 
BOOL
 
vútio_c⁄sﬁe_ˇn_wrôe_d©a
(
VIRTIODevi˚
 *
s
);

118 
vútio_c⁄sﬁe_gë_wrôe_Àn
(
VIRTIODevi˚
 *
s
);

119 
vútio_c⁄sﬁe_wrôe_d©a
(
VIRTIODevi˚
 *
s
, c⁄° 
uöt8_t
 *
buf
, 
buf_Àn
);

120 
vútio_c⁄sﬁe_ªsize_evít
(
VIRTIODevi˚
 *
s
, 
width
, 
height
);

125 
	mVIRTIO_INPUT_TYPE_KEYBOARD
,

126 
	mVIRTIO_INPUT_TYPE_MOUSE
,

127 
	mVIRTIO_INPUT_TYPE_TABLET
,

128 } 
	tVútioI≈utTy≥Enum
;

130 
	#VIRTIO_INPUT_ABS_SCALE
 32768

	)

132 
vútio_öput_£nd_key_evít
(
VIRTIODevi˚
 *
s
, 
BOOL
 
is_down
,

133 
uöt16_t
 
key_code
);

134 
vútio_öput_£nd_mou£_evít
(
VIRTIODevi˚
 *
s
, 
dx
, 
dy
, 
dz
,

135 
buâ⁄s
);

137 
VIRTIODevi˚
 *
vútio_öput_öô
(
VIRTIOBusDef
 *
bus
, 
VútioI≈utTy≥Enum
 
ty≥
);

141 
	~"fs.h
"

143 
VIRTIODevi˚
 *
vútio_9p_öô
(
VIRTIOBusDef
 *
bus
, 
FSDevi˚
 *
fs
,

144 c⁄° *
mou¡_èg
);

	@vmmouse.c

24 
	~<°dlib.h
>

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<öây≥s.h
>

28 
	~<as£π.h
>

30 
	~"cutûs.h
"

31 
	~"iomem.h
"

32 
	~"ps2.h
"

34 
	#VMPORT_MAGIC
 0x564D5868

	)

36 
	#REG_EAX
 0

	)

37 
	#REG_EBX
 1

	)

38 
	#REG_ECX
 2

	)

39 
	#REG_EDX
 3

	)

40 
	#REG_ESI
 4

	)

41 
	#REG_EDI
 5

	)

43 
	#FIFO_SIZE
 (4 * 16)

	)

45 
	sVMMou£Sèã
 {

46 
PS2Mou£Sèã
 *
	mps2_mou£
;

47 
	mfifo_cou¡
, 
	mfifo_rödex
, 
	mfifo_wödex
;

48 
BOOL
 
	míabÀd
;

49 
BOOL
 
	mabsﬁuã
;

50 
uöt32_t
 
	mfifo_buf
[
FIFO_SIZE
];

53 
	$put_queue
(
VMMou£Sèã
 *
s
, 
uöt32_t
 
vÆ
)

55 i‡(
s
->
fifo_cou¡
 >
FIFO_SIZE
)

57 
s
->
fifo_buf
[s->
fifo_wödex
] = 
vÆ
;

58 i‡(++
s
->
fifo_wödex
 =
FIFO_SIZE
)

59 
s
->
fifo_wödex
 = 0;

60 
s
->
fifo_cou¡
++;

61 
	}
}

63 
	$ªad_d©a
(
VMMou£Sèã
 *
s
, 
uöt32_t
 *
ªgs
, 
size
)

65 
i
;

66 i‡(
size
 > 6 || sizê> 
s
->
fifo_cou¡
) {

68 
s
->
íabÀd
 = 
FALSE
;

71 
i
 = 0; i < 
size
; i++) {

72 
ªgs
[
i
] = 
s
->
fifo_buf
[s->
fifo_rödex
];

73 i‡(++
s
->
fifo_rödex
 =
FIFO_SIZE
)

74 
s
->
fifo_rödex
 = 0;

76 
s
->
fifo_cou¡
 -
size
;

77 
	}
}

79 
	$vmmou£_£nd_mou£_evít
(
VMMou£Sèã
 *
s
, 
x
, 
y
, 
dz
,

80 
buâ⁄s
)

82 
°©e
;

84 i‡(!
s
->
íabÀd
) {

85 
	`ps2_mou£_evít
(
s
->
ps2_mou£
, 
x
, 
y
, 
dz
, 
buâ⁄s
);

89 i‡((
s
->
fifo_cou¡
 + 4Ë> 
FIFO_SIZE
)

92 
°©e
 = 0;

93 i‡(
buâ⁄s
 & 1)

94 
°©e
 |= 0x20;

95 i‡(
buâ⁄s
 & 2)

96 
°©e
 |= 0x10;

97 i‡(
buâ⁄s
 & 4)

98 
°©e
 |= 0x08;

99 i‡(
s
->
absﬁuã
) {

101 
x
 *= 2;

102 
y
 *= 2;

105 
	`put_queue
(
s
, 
°©e
);

106 
	`put_queue
(
s
, 
x
);

107 
	`put_queue
(
s
, 
y
);

108 
	`put_queue
(
s
, -
dz
);

111 
	`ps2_mou£_evít
(
s
->
ps2_mou£
, 1, 0, 0, 0);

112 
	}
}

114 
	$vmmou£_h™dÀr
(
VMMou£Sèã
 *
s
, 
uöt32_t
 *
ªgs
)

116 
uöt32_t
 
cmd
;

118 
cmd
 = 
ªgs
[
REG_ECX
] & 0xff;

119 
cmd
) {

121 
ªgs
[
REG_EBX
] = 
VMPORT_MAGIC
;

124 
	`ªad_d©a
(
s
, 
ªgs
,Ñegs[
REG_EBX
]);

127 
ªgs
[
REG_EAX
] = ((
s
->
íabÀd
 ? 0 : 0xffffË<< 16Ë| s->
fifo_cou¡
;

130 
ªgs
[
REG_EBX
]) {

132 i‡(
s
->
fifo_cou¡
 < 
FIFO_SIZE
) {

133 
	`put_queue
(
s
, 0x3442554a);

134 
s
->
íabÀd
 = 
TRUE
;

138 
s
->
íabÀd
 = 
FALSE
;

141 
s
->
absﬁuã
 = 0;

144 
s
->
absﬁuã
 = 1;

149 
	}
}

151 
BOOL
 
	$vmmou£_is_absﬁuã
(
VMMou£Sèã
 *
s
)

153  
s
->
absﬁuã
;

154 
	}
}

156 
VMMou£Sèã
 *
	$vmmou£_öô
(
PS2Mou£Sèã
 *
ps2_mou£
)

158 
VMMou£Sèã
 *
s
;

159 
s
 = 
	`mÆlocz
((*s));

160 
s
->
ps2_mou£
 =Ös2_mouse;

161  
s
;

162 
	}
}

	@
1
.
0
138
2329
aes.c
aes.h
block_net.c
build_filelist.c
cutils.c
cutils.h
fbuf.h
fs.c
fs.h
fs_disk.c
fs_net.c
fs_utils.c
fs_utils.h
fs_wget.c
fs_wget.h
ide.c
ide.h
iomem.c
iomem.h
json.c
json.h
list.h
machine.c
machine.h
pci.c
pci.h
pckbd.c
ps2.c
ps2.h
riscv_cpu.c
riscv_cpu.h
riscv_cpu_fp_template.h
riscv_cpu_priv.h
riscv_cpu_template.h
riscv_cpu_xlen_typedefs.h
riscv_machine.c
riscvsim/adaptive_predictor.c
riscvsim/adaptive_predictor.h
riscvsim/bht.c
riscvsim/bht.h
riscvsim/bpu.c
riscvsim/bpu.h
riscvsim/btb.c
riscvsim/btb.h
riscvsim/cache.c
riscvsim/cache.h
riscvsim/circular_queue.c
riscvsim/circular_queue.h
riscvsim/common_core_utils.c
riscvsim/common_core_utils.h
riscvsim/decode_fpa_template.h
riscvsim/dramsim_wrapper.cpp
riscvsim/dramsim_wrapper.h
riscvsim/dramsim_wrapper_c_connector.cpp
riscvsim/dramsim_wrapper_c_connector.h
riscvsim/execute_fpa_template.h
riscvsim/fpa_str_creator_template.h
riscvsim/inorder.c
riscvsim/inorder.h
riscvsim/inorder_backend.c
riscvsim/inorder_frontend.c
riscvsim/memory_controller.c
riscvsim/memory_controller.h
riscvsim/memory_controller_utils.h
riscvsim/mmu.c
riscvsim/mmu.h
riscvsim/ooo.c
riscvsim/ooo.h
riscvsim/ooo_backend.c
riscvsim/ooo_branch.c
riscvsim/ooo_frontend.c
riscvsim/ooo_lsu.c
riscvsim/ras.c
riscvsim/ras.h
riscvsim/riscv_ins_execute.c
riscvsim/riscv_ins_execute_lib.h
riscvsim/riscv_ins_str_creator.c
riscvsim/riscv_ins_str_creator.h
riscvsim/riscv_instruction.h
riscvsim/riscv_isa_decoder.c
riscvsim/riscv_isa_decoder_lib.h
riscvsim/riscv_sim_cpu.c
riscvsim/riscv_sim_cpu.h
riscvsim/riscv_sim_macros.h
riscvsim/riscv_sim_typedefs.h
riscvsim/sim_params_stats.c
riscvsim/sim_params_stats.h
sdl.c
sha256.c
sha256.h
share/test.c
simplefb.c
slirp/bootp.c
slirp/bootp.h
slirp/cksum.c
slirp/debug.h
slirp/if.c
slirp/if.h
slirp/ip.h
slirp/ip_icmp.c
slirp/ip_icmp.h
slirp/ip_input.c
slirp/ip_output.c
slirp/libslirp.h
slirp/main.h
slirp/mbuf.c
slirp/mbuf.h
slirp/misc.c
slirp/misc.h
slirp/sbuf.c
slirp/sbuf.h
slirp/slirp.c
slirp/slirp.h
slirp/slirp_config.h
slirp/socket.c
slirp/socket.h
slirp/tcp.h
slirp/tcp_input.c
slirp/tcp_output.c
slirp/tcp_subr.c
slirp/tcp_timer.c
slirp/tcp_timer.h
slirp/tcp_var.h
slirp/tcpip.h
slirp/tftp.h
slirp/udp.c
slirp/udp.h
softfp.c
softfp.h
softfp_template.h
softfp_template_icvt.h
splitimg.c
stats_display.c
temu.c
vga.c
virtio.c
virtio.h
vmmouse.c
